<div>
Posted on <a href="https://asec.ahnlab.com/en/34461/" rel="bookmark" title="1:00 pm">May 19, 2022</a>
<h1 class="title">Lazarus Group Exploiting Log4Shell Vulnerability (NukeSped)</h1>
<p>In December last year, the vulnerability (CVE-2021-44228) of Java-based logging utility Log4j became a worldwide issue. It is a remote code execution vulnerability that can include the remote Java object address in the log message and send it to the server using Log4j to run the Java object in the server.</p>
<figure class="wp-block-embed is-type-wp-embed is-provider-asec-blog wp-block-embed-asec-blog">
<a href="https://asec.ahnlab.com/en/29575/">[Alert] Apache Log4j 2 Vulnerability, Update Recommended</a>
</figure>
<p>The ASEC analysis team is monitoring the Lazarus group’s attacks on targets in Korea. In April, the team discovered an attack group suspected of being Lazarus distributing NukeSped by exploiting the vulnerability. The attacker used the log4j vulnerability on <a href="https://www.vmware.com/security/advisories/VMSA-2021-0028.html">VMware Horizon products that were not applied with the security patch</a>. The products are virtual desktop solutions, used mainly by companies for remote working solutions and cloud infrastructure operations. With the recent spread of Covid-19, it is likely that many companies are using the products for remote working.</p>
<p>
NukeSped</p>
<p>The following is AhnLab’s ASD (AhnLab Smart Defense) log for NukeSped being installed by the powershell command executed on VMware Horizon’s process ‘ws_tomcatservice.exe’.</p>
<figure class="aligncenter"><img alt="" class="wp-image-34123 jetpack-lazy-image jetpack-lazy-image--handled" height="365" src="https://i0.wp.com/asec.ahnlab.com/wp-content/uploads/2022/05/image-15.png?resize=938%2C365&amp;ssl=1" style="max-width:800px;height:auto;width:auto;" width="938"/><img alt="" class="wp-image-34123" height="365" src="https://i0.wp.com/asec.ahnlab.com/wp-content/uploads/2022/05/image-15.png?resize=938%2C365&amp;ssl=1" style="max-width:800px;height:auto;width:auto;" width="938"/><figcaption>Figure 1. ASD log for NukeSped installation</figcaption></figure>
<p></p>
<p>
Analysis of NukeSped</p>
<p>NukeSped is a backdoor malware that can receive attacker commands from the C&amp;C server and perform the received commands. The malware type mentioned in this post is one of the variants of NukeSped, that have been used by the Lazarus group since 2020. The variant was discussed in detail in the ASEC blog post shown below. This post will briefly introduce the NukeSped type used in the attack and compare it with the previous version.</p>
<figure class="wp-block-embed is-type-wp-embed is-provider-asec-blog wp-block-embed-asec-blog">
<a href="https://asec.ahnlab.com/en/28597/">Analysis Report of Lazarus Group’s NukeSped Malware</a>
</figure>
<p>The variant is developed with C++. As it uses virtual functions, class names are included in the binary (see Figure 2).</p>
<figure class="aligncenter"><img alt="" class="wp-image-34112 jetpack-lazy-image" height="290" src="https://i0.wp.com/asec.ahnlab.com/wp-content/uploads/2022/05/image-12.png?resize=532%2C290&amp;ssl=1" width="532"/><img alt="" class="wp-image-34112" height="290" src="https://i0.wp.com/asec.ahnlab.com/wp-content/uploads/2022/05/image-12.png?resize=532%2C290&amp;ssl=1" width="532"/><figcaption>Figure 2. Class names of NukeSped</figcaption></figure>
<p></p>
<p>It normally uses DES algorithm to decrypt internal strings including API names and the list of C&amp;C servers. To communicate with the C&amp;C server, it uses the RC4 algorithm. But there are some changes as well: the previous blog post had types that used the Xor encryption (CryptorXor class) instead of the RC4 algorithm to communicate with the C&amp;C server. But for this attack, there was a type using the RC4 algorithm for internal strings, a list of C&amp;C servers, and C&amp;C server communication. Each process uses a different value for the RC4 key.</p>
<ul><li>RC4 Key 1 (decrypting strings): 7B CA D5 7E 1B AE 26 D8 60 1B 61 DA 83 80 11 72 01 6C 54 D8 8A E8 DE 7B 1A 0A</li><li>RC4 Key 2 (C&amp;C communications): CD 80 5D D6 6C 1C 63 78 AF 13 7F 67 5B E9 B1 F4 87 27 EE 91 F3 5F 17 EE 9B 6A 28 61 8C F4</li></ul>
<figure class="aligncenter"><img alt="" class="wp-image-34116 jetpack-lazy-image" height="414" src="https://i0.wp.com/asec.ahnlab.com/wp-content/uploads/2022/05/image-13.png?resize=460%2C414&amp;ssl=1" width="460"/><img alt="" class="wp-image-34116" height="414" src="https://i0.wp.com/asec.ahnlab.com/wp-content/uploads/2022/05/image-13.png?resize=460%2C414&amp;ssl=1" width="460"/><figcaption>Figure 3. RC4 key used for decrypting strings</figcaption></figure>
<p></p>
<p>After the process for decrypting strings and API Resolving is complete, the malware starts communicating with the C&amp;C server. NukeSped goes through an additional verification process after accessing the C&amp;C server by sending a string disguised as SSL communication. When the malware receives certain strings, it will recognize the server as a normal C&amp;C server and proceeds with the routine. As shown in the previous analysis report, there are two types of strings used for the process.</p>
<figure class="wp-block-table"><table><thead><tr><td></td><td>C&amp;C Requests</td><td>C&amp;C Responses</td></tr></thead><tbody><tr><td>Type 1</td><td>HTTP 1.1 /index.php?member=sbi2009 SSL3.3.7</td><td>HTTP 1.1 200 OK SSL2.1</td></tr><tr><td>Type 2</td><td>HTTP 1.1 /member.php SSL3.4</td><td>HTTP 1.1 200 OK SSL2.1</td></tr></tbody></table><figcaption>Table 1. C&amp;C request and response values for each type</figcaption></figure>
<p></p>
<p>The malware then finds the MAC address of the user environment and sends it to the C&amp;C server after encrypting it with the RC4 algorithm. It will also encrypt packets with the algorithm in the subsequent communications.</p>
<figure class="aligncenter"><img alt="" class="wp-image-34120 jetpack-lazy-image" height="220" src="https://i0.wp.com/asec.ahnlab.com/wp-content/uploads/2022/05/image-14.png?resize=667%2C220&amp;ssl=1" style="max-width:800px;height:auto;width:auto;" width="667"/><img alt="" class="wp-image-34120" height="220" src="https://i0.wp.com/asec.ahnlab.com/wp-content/uploads/2022/05/image-14.png?resize=667%2C220&amp;ssl=1" style="max-width:800px;height:auto;width:auto;" width="667"/><figcaption>Figure 4. Communication process with the C&amp;C server</figcaption></figure>
<p>NukeSped can perform keylogging, taking screenshots, and file and shell tasks depending on the command it receives. The features exist in the classes shown below. Note that ModuleUsbDump and ModuleWebCamera are new features discovered in this attack.</p>
<ul><li>ModuleUpdate</li><li>ModuleShell</li><li>ModuleFileManager</li><li>ModuleKeyLogger</li><li>ModuleSocksTunnel</li><li>ModuleScreenCapture</li><li>ModuleInformation</li><li>ModulePortForwarder</li><li>ModuleUsbDump</li><li>ModuleWebCamera</li></ul>
<p>
Attacks using NukeSped</p>
<p>Installing INFOSTEALER</p>
<p>The attacker used NukeSped to additionally install infostealer. The 2 malware types discovered are both console types, not saving the leak result in separate files. As such, it is assumed that the attacker remotely controlled the GUI screen of the user PC or leaked data in the pipeline form. One of the 2 malwares is the same file used in the previous attack.</p>
<figure class="aligncenter"><img alt="" class="wp-image-34125 jetpack-lazy-image" height="247" src="https://i0.wp.com/asec.ahnlab.com/wp-content/uploads/2022/05/image-16.png?resize=774%2C247&amp;ssl=1" style="max-width:800px;height:auto;width:auto;" width="774"/><img alt="" class="wp-image-34125" height="247" src="https://i0.wp.com/asec.ahnlab.com/wp-content/uploads/2022/05/image-16.png?resize=774%2C247&amp;ssl=1" style="max-width:800px;height:auto;width:auto;" width="774"/><figcaption>Figure 5. List of collected information</figcaption></figure>
<p></p>
<p>The list of softwares and data for info-leakage is as follows:</p>
<ul><li>Collected Data: accounts and passwords saved in browsers, browser history
Targeted Software: Google Chrome, Mozilla Firefox, Internet Explorer, Opera, and Naver Whale</li><li>Collected Data: email account information
Targeted Software: Outlook Express, MS Office Outlook, and Windows Live Mail</li><li>Collected Data: Names of recently used files
Targeted Software: MS Office (PowerPoint, Excel, and Word) and Hancom 2010</li></ul>
<p>NukeSped Use Commands</p>
<p>The attacker collected additional information by using backdoor malware NukeSped to send command line commands. The following commands show the basic network and domain information of the environment that has the infected system. The collected information can be used later in lateral movement attacks. If the attack succeeds, the attacker can dominate the systems within the domain.</p>
<ul><li>cmd.exe /c “ping 11.11.11.1”</li><li>cmd.exe /c “ipconfig /all”</li><li>cmd.exe /c “query user”</li><li>cmd.exe “net group “domain admins” /domain”</li><li>net user _smuser white1234!@#$</li><li>cmd.exe “net localgroup administrators /add smi140199”</li></ul>
<p>
Jin Miner</p>
<p>Analyzing the ASD log for the infected system shows that before the Lazarus group installed NukeSped, other attackers had already exploited the vulnerability to install Jin Miner. Jin Miner is known as a malware strain distributed through the Log4Shell vulnerability, as shown in the <a href="https://news.sophos.com/en-us/2022/03/29/horde-of-miner-bots-and-backdoors-leveraged-log4j-to-attack-vmware-horizon-servers/">previous Sophos report</a>.</p>
<figure class="aligncenter"><img alt="" class="wp-image-34131 jetpack-lazy-image" height="291" src="https://i0.wp.com/asec.ahnlab.com/wp-content/uploads/2022/05/image-17.png?resize=945%2C291&amp;ssl=1" style="max-width:800px;height:auto;width:auto;" width="945"/><img alt="" class="wp-image-34131" height="291" src="https://i0.wp.com/asec.ahnlab.com/wp-content/uploads/2022/05/image-17.png?resize=945%2C291&amp;ssl=1" style="max-width:800px;height:auto;width:auto;" width="945"/><figcaption>Figure 6. ASD log for installing Jin Miner</figcaption></figure>
<p></p>
<p>Installed in the path shown above through the powershell command, Jin Miner is a CoinMiner that ultimately mines the Monero coin.</p>
<figure class="aligncenter"><img alt="" class="wp-image-34132 jetpack-lazy-image" height="288" src="https://i0.wp.com/asec.ahnlab.com/wp-content/uploads/2022/05/image-18.png?resize=738%2C288&amp;ssl=1" style="max-width:800px;height:auto;width:auto;" width="738"/><img alt="" class="wp-image-34132" height="288" src="https://i0.wp.com/asec.ahnlab.com/wp-content/uploads/2022/05/image-18.png?resize=738%2C288&amp;ssl=1" style="max-width:800px;height:auto;width:auto;" width="738"/><figcaption>Figure 7. Jin Miner install script add.bat file</figcaption></figure>
<p></p>
<figure class="aligncenter"><img alt="" class="wp-image-34134 jetpack-lazy-image" height="479" src="https://i0.wp.com/asec.ahnlab.com/wp-content/uploads/2022/05/image-19.png?resize=837%2C479&amp;ssl=1" style="max-width:800px;height:auto;width:auto;" width="837"/><img alt="" class="wp-image-34134" height="479" src="https://i0.wp.com/asec.ahnlab.com/wp-content/uploads/2022/05/image-19.png?resize=837%2C479&amp;ssl=1" style="max-width:800px;height:auto;width:auto;" width="837"/><figcaption>Figure 8. Settings routine of Jin Miner</figcaption></figure>
<p></p>
<p>[IOC]
NukeSped (MD5, alias, and engine version)
– 87a6bda486554ab16c82bdfb12452e8b (Backdoor/Win.NukeSped.R487407) (2022.04.23.02)
– 830bc975a04ab0f62bfedf27f7aca673 (Trojan/Win.Andardoor.C5094639) (2022.04.21.01)
– 131fc4375971af391b459de33f81c253 (Backdoor/Win.NukeSped.R486619) (2022.04.21.00)
– 827103a6b6185191fd5618b7e82da292 (Backdoor/Win.NukeSped.R486595) (2022.04.20.03)
– 1875f6a68f70bee316c8a6eda9ebf8de (Backdoor/Win.NukeSped.R486595) (2022.04.20.03)</p>
<p>InfoStealer (MD5, alias, and engine version)
– 85995257ac07ae5a6b4a86758a2283d7 (Infostealer/Win.Pwstealer.C4510631) (2021.06.04.03)
– 47791bf9e017e3001ddc68a7351ca2d6 (Backdoor/Win.NukeSped.C4631988) (2021.09.15.01)</p>
<p>NukeSped Download URL
– hxxp://185.29.8[.]18/htroy.exe</p>
<p>NukeSped C&amp;C URL
– 185.29.8[.]18:8888
– 84.38.133[.]145:443
– 84.38.133[.]16:8443
– mail.usengineergroup[.]com:8443</p>
<p>NukeSped Filename
– svc.exe
– srvCredit.exe
– runhostw.exe
– javarw.exe</p>
<p>
Jin Miner (MD5, alias, and engine version)
– 7a19c59c4373cadb4556f7e30ddd91ac (CoinMiner/BAT.Generic) (2022.05.11.03)
– c2412d00eb3b4bccae0d98e9be4d92bb (CoinMiner/BAT.Generic) (2022.05.11.03)
– 8c8a38f5af62986a45f2ab4f44a0b983 (Win-Trojan/Miner3.Exp) (2020.01.29.00)
– 7ef97450e84211f9f35d45e1e6ae1481 (Win-Trojan/Miner3.Exp) (2020.01.29.00)
– dd4b8a2dc73a29bc7a598148eb8606bb (Unwanted/Win32.NSSM.R353938) (2020.10.27.00)</p>
<p>Jin Miner Download URL
– hxxp://iosk[.]org/pms/add.bat
– hxxp://iosk[.]org/pms/mad.bat
– hxxp://iosk[.]org/pms/jin.zip
– hxxp://iosk[.]org/pms/jin-6.zip</p>
<p>
Categories:<a href="https://asec.ahnlab.com/en/category/malware-information/" rel="category tag">Malware Information</a> </p>
<p>Tagged as:<a href="https://asec.ahnlab.com/tag/jinminer/" rel="tag">JinMiner</a>, <a href="https://asec.ahnlab.com/en/tag/lazarus-en/" rel="tag">Lazarus</a>, <a href="https://asec.ahnlab.com/tag/log4j/" rel="tag">Log4j</a>, <a href="https://asec.ahnlab.com/tag/log4shell/" rel="tag">Log4Shell</a>, <a href="https://asec.ahnlab.com/tag/nukesped/" rel="tag">NukeSped</a>, <a href="https://asec.ahnlab.com/tag/vmware/" rel="tag">VMware</a>, <a href="https://asec.ahnlab.com/en/tag/vulnerability-en/" rel="tag">Vulnerability</a>, <a href="https://asec.ahnlab.com/tag/xmrig/" rel="tag">XMRig</a></p>
</div>