<div> <a href="https://www.netskope.com/blog">Blog</a> <a href="https://www.netskope.com/blog/category/netskope-threat-labs">Threat Labs</a> CVE-2022-30190: New Zero-Day Vulnerability (Follina) in Microsoft Support Diagnostic Tool By <a href="https://www.netskope.com/blog/author/gpalazolo" rel="author" title="Posts by Gustavo Palazolo">Gustavo Palazolo</a> Jun 01 2022 <a href="https://www.facebook.com/sharer/sharer.php?u=https://www.netskope.com/blog/cve-2022-30190-new-zero-day-vulnerability-follina-in-microsoft-support-diagnostic-tool'"> <img alt="facebook icon" class="no_hover" src="https://www.netskope.com/wp-content/themes/netskope/images/blogs/icons/Netskope_Blog_SocialIcons_Facebook_Default_40x40.svg?_r=1123" style="max-width:80%;height:auto;width:auto;"/> <img alt="facebook icon" class="hover" src="https://www.netskope.com/wp-content/themes/netskope/images/blogs/icons/Netskope_Blog_SocialIcons_Facebook_Hover_40x40.svg?_r=1123" style="max-width:80%;height:auto;width:auto;"/> </a> <a href="https://twitter.com/share?text=%20CVE-2022-30190:%20New%20Zero-Day%20Vulnerability%20(Follina)%20in%20Microsoft%20Support%20Diagnostic%20Tool%20@Netskope&amp;url=https%3A%2F%2Fwww.netskope.com%2Fblog%2Fcve-2022-30190-new-zero-day-vulnerability-follina-in-microsoft-support-diagnostic-tool"> <img alt="twitter icon" class="no_hover" src="https://www.netskope.com/wp-content/themes/netskope/images/blogs/icons/Netskope_Blog_SocialIcons_Twitter_Default_40x40.svg?_r=1123" style="max-width:80%;height:auto;width:auto;"/> <img alt="twitter icon" class="hover" src="https://www.netskope.com/wp-content/themes/netskope/images/blogs/icons/Netskope_Blog_SocialIcons_Twitter_Hover_40x40.svg?_r=1123" style="max-width:80%;height:auto;width:auto;"/> </a> <a href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://www.netskope.com/blog/cve-2022-30190-new-zero-day-vulnerability-follina-in-microsoft-support-diagnostic-tool'"> <img alt="linkedin icon" class="no_hover" src="https://www.netskope.com/wp-content/themes/netskope/images/blogs/icons/Netskope_Blog_SocialIcons_Linkedin_Default_40x40.svg?_r=1123" style="max-width:80%;height:auto;width:auto;"/> <img alt="linkedin icon" class="hover" src="https://www.netskope.com/wp-content/themes/netskope/images/blogs/icons/Netskope_Blog_SocialIcons_Linkedin_Hover_40x40.svg?_r=1123" style="max-width:80%;height:auto;width:auto;"/> </a> Share <h1 class="blog-page__content-title">CVE-2022-30190: New Zero-Day Vulnerability (Follina) in Microsoft Support Diagnostic Tool</h1> <p><a href="https://www.netskope.com/blog/author/gpalazolo">Gustavo Palazolo</a> and <a href="https://www.netskope.com/blog/author/gsatpathy">Ghanashyam Satpathy</a></p><h2 id="h-summary">Summary</h2><p>On May 27, 2022, a Microsoft Office document was <a href="https://www.virustotal.com/gui/file/4a24048f81afbe9fb62e7a6a49adbd1faf41f266b5f9feecdceb567aec096784/detection" rel="noreferrer noopener" target="_blank">submitted</a> from Belarus to VirusTotal, using a <a href="https://twitter.com/nao_sec/status/1530196847679401984" rel="noreferrer noopener" target="_blank">novel method</a> to deliver its payload. This new technique was identified as a Zero-Day RCE (Remote Code Execution) vulnerability in Microsoft Support Diagnostic Tool (<a href="https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/msdt" rel="noreferrer noopener" target="_blank">MSDT</a>), which is now being tracked as <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2022-30190" rel="noreferrer noopener" target="_blank">CVE-2022-30190</a>. As of this writing, it affects only Windows computers running with MSDT URI protocol enabled. </p><p>The methods of execution and net result of this vulnerability continue to expand as it gains more attention, similar to what we observed with Log4j. CVE-2022-30190 is also being <a href="https://doublepulsar.com/follina-a-microsoft-office-code-execution-vulnerability-1a47fce5629e" rel="noreferrer noopener" target="_blank">called Follina</a>, because the sample uploaded to VirusTotal references 0438, which is the area code for Follina in Italy.</p><p>This vulnerability does not require any macros, which are now <a href="https://www.netskope.com/blog/microsoft-office-vba-blocked-by-default-in-files-from-the-internet">disabled by default</a> on files downloaded from the internet. The exploit can be achieved through crafted URLs that use the ms-msdt URL protocol, which will eventually load and execute code. The attack surface for MSDT Protocol in Office is <a href="https://blog.syss.com/posts/abusing-ms-office-protos/" rel="noreferrer noopener" target="_blank">also quite large</a>. Furthermore, the document spotted on May 27 is using <a href="https://www.netskope.com/blog/not-laughing-malicious-office-documents-using-lolbins" rel="noreferrer noopener" target="_blank">Living-off-the-Land</a> techniques by abusing “<a href="https://lolbas-project.github.io/lolbas/Binaries/Msdt/" rel="noreferrer noopener" target="_blank">msdt.exe</a>” and “<a href="https://lolbas-project.github.io/lolbas/Binaries/Certutil/" rel="noreferrer noopener" target="_blank">certutil.exe</a>” binaries. At this point, there are a few public PoCs created by security researchers available on GitHub.</p><p>Microsoft has <a href="https://msrc-blog.microsoft.com/2022/05/30/guidance-for-cve-2022-30190-microsoft-support-diagnostic-tool-vulnerability/" rel="noreferrer noopener" target="_blank">released</a> a few workarounds users can implement to be protected against this vulnerability. The official fix has not yet been released.</p><h2>CVE-2022-30190</h2><p>In this analysis, we created a non-weaponized sample using one of the public PoCs available on GitHub, to demonstrate how it works.</p><p>Like <a href="https://www.netskope.com/blog/microsoft-office-document-triggering-new-zero-day">CVE-2021-40444</a>, the document may trigger the vulnerability by abusing the OOXML <a href="http://officeopenxml.com/anatomyofOOXML.php" rel="noreferrer noopener" target="_blank">relationships</a> to automatically download the content from an external URL. In this case, the URL is pointing to localhost as we are using the PoC code.</p><figure class="aligncenter size-full"><img alt="" class="wp-image-40464 lazyloaded" height="58" src="https://www.netskope.com/wp-content/uploads/2022/06/CVE-2022-30190-1.jpg" style="max-width:800px;height:auto;width:auto;" width="859"/><img alt="" class="wp-image-40464" height="58" src="https://www.netskope.com/wp-content/uploads/2022/06/CVE-2022-30190-1.jpg" style="max-width:800px;height:auto;width:auto;" width="859"/><figcaption>Malicious URL embedded in the document.</figcaption></figure><p>When the document is opened, the URL content is automatically downloaded.</p><figure class="aligncenter size-full"><img alt="" class="wp-image-40465 lazyload" height="334" src="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" width="590"/><img alt="" class="wp-image-40465" height="334" src="https://www.netskope.com/wp-content/uploads/2022/06/word-document-loading-the-external-html-page-1.jpg" width="590"/><figcaption>Word document loading the external HTML page.
</figcaption></figure><p>If the file was downloaded from the internet, the code is not executed because of the <a href="https://msrc-blog.microsoft.com/2022/05/30/guidance-for-cve-2022-30190-microsoft-support-diagnostic-tool-vulnerability/" rel="noreferrer noopener" target="_blank">Protected View</a>. The exploit will only be triggered if the user clicks the “Enable Editing” button. However, it seems that this vulnerability can be <a href="https://doublepulsar.com/follina-a-microsoft-office-code-execution-vulnerability-1a47fce5629e" rel="noreferrer noopener" target="_blank">exploited via RTF files</a>, where the Protected View does not apply, making this a zero-click vulnerability. Also, the vulnerability <a href="https://blog.malwarebytes.com/exploits-and-vulnerabilities/2022/05/microsoft-office-zero-day-follina-its-not-a-bug-its-a-feature-its-a-bug/" rel="noreferrer noopener" target="_blank">can be exploited</a> if the user previews the document inside the Windows Explorer, where the Protected View concept does not apply.</p><figure class="aligncenter size-full"><img alt="" class="wp-image-40466 lazyload" height="152" src="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" style="max-width:800px;height:auto;width:auto;" width="848"/><img alt="" class="wp-image-40466" height="152" src="https://www.netskope.com/wp-content/uploads/2022/06/Microsoft-protected-view-1.jpg" style="max-width:800px;height:auto;width:auto;" width="848"/><figcaption>Microsoft Protected View.</figcaption></figure><p>The HTML page contains a script that just redirects the user to the URL that will trigger the exploit.</p><figure class="aligncenter size-full"><img alt="" class="wp-image-40467 lazyload" height="175" src="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" style="max-width:800px;height:auto;width:auto;" width="852"/><img alt="" class="wp-image-40467" height="175" src="https://www.netskope.com/wp-content/uploads/2022/06/html-payload-1.jpg" style="max-width:800px;height:auto;width:auto;" width="852"/><figcaption>HTML payload that triggers CVE-2022-30190.</figcaption></figure><p>In this example, the “msdt.exe” will spawn the Windows calculator through the following PowerShell command, which is encoded with base64:</p><p>Start-Process c:\windows\system32\calc.exe -WindowStyle hidden</p><h2>Conclusion</h2><p>This vulnerability shows that attackers are constantly trying to abuse Microsoft Office documents to execute code, especially after Microsoft <a href="https://www.netskope.com/pt/blog/microsoft-office-vba-blocked-by-default-in-files-from-the-internet">disabled the VBA macros</a> by default on files downloaded from the internet. This new vulnerability (CVE-2022-30190) does not require any VBA macros to exploit devices, and it’s currently being used in the wild by attackers. Furthermore, we also see other attackers, like <a href="https://www.netskope.com/blog/emotet-new-delivery-mechanism-to-bypass-vba-protection">Emotet</a>, changing their TTPs to circumvent the latest Microsoft protections.</p><h2>Protection</h2><p>Netskope Threat Labs is actively monitoring this campaign and will ensure coverage for all known threat indicators and payloads.</p><figure class="wp-block-image size-full"><img alt="" class="wp-image-40468 lazyload" height="412" src="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" style="max-width:800px;height:auto;width:auto;" width="830"/><img alt="" class="wp-image-40468" height="412" src="https://www.netskope.com/wp-content/uploads/2022/06/ntl-monitoring-1.jpg" style="max-width:800px;height:auto;width:auto;" width="830"/></figure><ul><li>Netskope Threat Protection<ul><li>Document-Word.Exploit.CVE-2022-30190</li><li>Document-Word.Downloader.Heuristic</li></ul></li><li>Netskope Advanced Threat Protection provides proactive coverage against this threat.<ul><li>Gen.Malware.Detect.By.StHeur indicates a sample that was detected using static analysis</li><li>Gen.Malware.Detect.By.Sandbox indicates a sample that was detected by our cloud sandbox</li></ul></li></ul><p>Update / Patch</p><p>Microsoft has <a href="https://msrc-blog.microsoft.com/2022/05/30/guidance-for-cve-2022-30190-microsoft-support-diagnostic-tool-vulnerability/" rel="noreferrer noopener" target="_blank">released</a> a few workarounds that can be implemented against CVE-2022-30190, such as disabling MSDT URL protocol. This can be achieved in multiple ways, such as:</p><p>1. By deleting its Windows registry key. </p><p>This can be done by running the following command in an administrator command prompt:</p><p>“reg delete HKEY_CLASSES_ROOT\ms-msdt /f”</p><p>2. By disabling “Troubleshooting wizards”</p><p>Either through Registry:</p><p>HKLM\SOFTWARE\Policies\Microsoft\Windows\ScriptedDiagnostics – EnableDiagnostics – 0</p><p>Or in the user interface:</p><p>Group Policy Editor -&gt; Computer Configuration -&gt; Administrative Templates -&gt; System -&gt; Troubleshooting and Diagnostics -&gt; Scripted Diagnostics. </p><p>Set “Troubleshooting: 
Allow users to access and run Troubleshooting Wizards” to “disabled”.</p><p>3. Disabling Preview in Windows Explorer.</p><p>This can be done by opening file explorer and selecting the view followed by selecting “preview pane” to hide it. </p><h2>IOCs</h2><p>MD5 Hashes</p><p>f531a7c270d43656e34d578c8e71bc39
6bcee92ab337c9130f27143cc7be5a55
529c8f3d6d02ba996357aba535f688fc</p><p>SHA256 Hashes</p><p>710370f6142d945e142890eb427a368bfc6c5fe13a963f952fb884c38ef06bfa
fe300467c2714f4962d814a34f8ee631a51e8255b9c07106d44c6a1f1eda7a45
d61d70a4d4c417560652542e54486beb37edce014e34a94b8fd0020796ff1ef7</p><p>URLs</p><p>hxxps://www.sputnikradio[.]net/radio/news/3134.html
hxxps://exchange.oufca[.]com.au/owa/auth/15.1.2375/themes/p3azx.html</p> &lt; <a href="https://www.netskope.com/blog/category/netskope-threat-labs">Threat Labs</a> <a href="https://www.netskope.com/blog/cve-2022-30190-new-zero-day-vulnerability-follina-in-microsoft-support-diagnostic-tool">Next Story</a> &gt; &lt; <a href="https://www.netskope.com/blog/category/netskope-threat-labs">Back</a> <a href="https://www.netskope.com/blog/cve-2022-30190-new-zero-day-vulnerability-follina-in-microsoft-support-diagnostic-tool">Next</a> &gt; <a href="https://www.netskope.com/blog/author/gpalazolo"><img alt="author image" class="lazyload" src="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==" style="max-width:80%;height:auto;width:auto;"/><img alt="author image" src="https://www.netskope.com/wp-content/uploads/2021/07/gustavo-palazolo-netskope-150x150.jpg" style="max-width:80%;height:auto;width:auto;"/></a> About the author Gustavo Palazolo is an expert in malware analysis, reverse engineering and security research, working many years in projects related to electronic fraud protection. He is currently working on the Netskope Research Team, discovering and analyzing new malware threats. Gustavo Palazolo is an expert in malware analysis, reverse engineering and security research, working many years in projects related to electronic fraud protection. He is currently working on the Netskope Research Team, discovering and analyzing new malware threats. <a href="https://www.netskope.com/blog/author/gpalazolo">Read Gustavo Palazolo's full
 Bio &gt;</a> <a href="https://www.netskope.com/blog/author/gpalazolo#author_articles">More Articles
 by Gustavo Palazolo &gt;</a> <a href="https://www.netskope.com/blog/author/gpalazolo">Read full
 Bio &gt;</a> <a href="https://www.netskope.com/blog/author/gpalazolo#author_articles">More articles
 &gt;</a> Related ArticlesThreat Labs By Paolo Passeri <a href="https://www.netskope.com/blog/cloud-threats-memo-analyzing-the-top-10-initial-access-vectors"> Cloud Threats Memo: Analyzing the Top 10 Initial Access Vectors </a> <img alt="Icon_NewsAndAnnouncements" src="https://www.netskope.com/wp-content/uploads/2020/08/Icon_ThreatResearchLabs.svg" style="max-width:80%;height:auto;width:auto;"/><a class="text-link" href="https://www.netskope.com/blog/cloud-threats-memo-analyzing-the-top-10-initial-access-vectors"> Read article</a>Threat Labs By Gustavo Palazolo <a href="https://www.netskope.com/blog/redline-stealer-campaign-using-binance-mystery-box-videos-to-spread-github-hosted-payload"> RedLine Stealer Campaign Using Binance Mystery Box Videos to Spread GitHub-Hosted Payload </a> <img alt="Icon_NewsAndAnnouncements" src="https://www.netskope.com/wp-content/uploads/2020/08/Icon_ThreatResearchLabs.svg" style="max-width:80%;height:auto;width:auto;"/><a class="text-link" href="https://www.netskope.com/blog/redline-stealer-campaign-using-binance-mystery-box-videos-to-spread-github-hosted-payload"> Read article</a>Threat Labs By Gustavo Palazolo <a href="https://www.netskope.com/blog/emotet-new-delivery-mechanism-to-bypass-vba-protection"> Emotet: New Delivery Mechanism to Bypass VBA Protection </a> <img alt="Icon_NewsAndAnnouncements" src="https://www.netskope.com/wp-content/uploads/2020/08/Icon_ThreatResearchLabs.svg" style="max-width:80%;height:auto;width:auto;"/><a class="text-link" href="https://www.netskope.com/blog/emotet-new-delivery-mechanism-to-bypass-vba-protection"> Read article</a> <a class="blogs__load-more-link" href="#">Load More Articles</a> Contact UsContact Us<p>We'd love to hear from you!</p> Loading... </div>