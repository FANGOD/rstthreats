<div><h1 class="entry-title">Complete dissection of an APK with a suspicious C2 Server</h1>
<p>April 01, 2022</p>
<p>During <a href="https://lab52.io/blog/looking-for-penquins-in-the-wild/">our analysis of the Penquin-related infrastructure</a> we reported in our previous post, we paid special attention to the malicious binaries contacting these IP addresses, since as we showed in the analysis, they had been used as C2 of other threats used by Turla.</p>
<p>One threat that makes contact with the 82.146.35[.]240 address in particular caught our attention, as it was the only one that contacts against that IP and it was an Spyware for Android devices. </p>
<figure class="aligncenter size-large"><img alt="" class="wp-image-1544" height="145" src="https://lab52.io/blog/wp-content/uploads/2022/04/Captura-de-pantalla-de-2022-04-01-14-14-21.png" style="max-width:800px;height:auto;width:auto;" width="732"/></figure>
<p>So in this report, we want to share our analysis on the capabilities of this piece of malware, although the attribution to Turla does not seem possible given its threat capabilities.</p>
<p>Name: Process Manager</p>
<p>Package: com.remote.app</p>
<p>Hash: e0eacd72afe39de3b327a164f9c69a78c9c0f672d3ad202271772d816db4fad8 (sha-256)</p>
<p>Size: 0.37 MB</p>
<p>Target SDK: Android 14 – Android 21</p>
<figure class="aligncenter size-large is-resized"><img alt="" class="wp-image-1416" height="104" src="https://lab52.io/blog/wp-content/uploads/2022/03/1-1024x146.png" style="max-width:800px;height:auto;width:auto;" width="732"/></figure>
<p>On the Android device, the application is displayed with a gear-shaped icon.</p>
<figure class="aligncenter size-large is-resized"><img alt="" class="wp-image-1418" height="508" src="https://lab52.io/blog/wp-content/uploads/2022/03/2.png" width="281"/></figure>
<p>When the application is run, a warning appears about the permissions granted to the application. These include screen unlock attemps, lock the screen, set the device global proxy, set screen lock password expiration, set storage encryption and disable cameras.</p>
<figure class="aligncenter size-large is-resized"><img alt="" class="wp-image-1422" height="477" src="https://lab52.io/blog/wp-content/uploads/2022/03/3.png" width="517"/></figure>
<p>The icon is then removed and the application runs in the background, showing in the notification bar.</p>
<figure class="aligncenter size-large is-resized"><img alt="" class="wp-image-1425" height="225" src="https://lab52.io/blog/wp-content/uploads/2022/03/4.png" width="407"/></figure>
<p>As mentioned in the previous section, the malware requests different permissions from the user. However, the number of permissions requested by the application amounts to 18:</p>
<figure class="wp-block-table aligncenter is-style-regular"><table><thead><tr><th class="has-text-align-center">PERMISSIONS</th><th class="has-text-align-right">DESCRIPTION</th></tr></thead><tbody><tr><td class="has-text-align-center">ACCESS_COARSE_LOCATION</td><td class="has-text-align-right">Access to the phone location.</td></tr><tr><td class="has-text-align-center">ACCESS_FINE_LOCATION</td><td class="has-text-align-right">Access to the location based on GPS.</td></tr><tr><td class="has-text-align-center">ACCESS_NETWORK_STATE</td><td class="has-text-align-right">View the status of all networks.</td></tr><tr><td class="has-text-align-center">ACCESS_WIFI_STATE</td><td class="has-text-align-right">View WIFI information.</td></tr><tr><td class="has-text-align-center">CAMERA</td><td class="has-text-align-right">Take pictures and videos from the camera</td></tr><tr><td class="has-text-align-center">FOREGROUND_SERVICE</td><td class="has-text-align-right">Allows to put in foreground</td></tr><tr><td class="has-text-align-center">INTERNET</td><td class="has-text-align-right">Allows to create internet sockets</td></tr><tr><td class="has-text-align-center">MODIFY_AUDIO_SETTINGS</td><td class="has-text-align-right">Allows to modify audio settings</td></tr><tr><td class="has-text-align-center">REAL_CALL_LOG</td><td class="has-text-align-right">Allows to read a telephone call</td></tr><tr><td class="has-text-align-center">READ_CONTACTS</td><td class="has-text-align-right">Allows to read contacts information</td></tr><tr><td class="has-text-align-center">READ_EXTERNAL_STORAGE</td><td class="has-text-align-right">Allows to read external storage devices</td></tr><tr><td class="has-text-align-center">WRITE_EXTERNAL_STORAGE</td><td class="has-text-align-right">Allows to write to the Memory Card</td></tr><tr><td class="has-text-align-center">READ_PHONE_STATE</td><td class="has-text-align-right">Allows to read phone status and its id</td></tr><tr><td class="has-text-align-center">READ_SMS</td><td class="has-text-align-right">Allows to read SMS stored on the SIM card</td></tr><tr><td class="has-text-align-center">RECEIVE_BOOT_COMPLETED</td><td class="has-text-align-right"> Allows to start the app when the device is turned on</td></tr><tr><td class="has-text-align-center">RECORD_AUDIO</td><td class="has-text-align-right">Access to the audio recorder</td></tr><tr><td class="has-text-align-center">SEND_SMS</td><td class="has-text-align-right">Allows to send sms</td></tr><tr><td class="has-text-align-center">WAKE_LOG</td><td class="has-text-align-right">Prevents the device from locking/hibernating</td></tr></tbody></table></figure>
<p>In addition, the manifest displays additional information about the application configuration.</p>
<ul><li>android:allowBackup=true: Allows the application data to be added to the backup.</li><li>android:exported=true: Can share info with other apps and be accessed by the device.</li><li>android_secret_code: In the manifest is the secret code that can allow access to hidden content.</li></ul>
<p>As you can see in the image, the com.remote.app package contains 21 classes.15 of them are named after the first letters of the alphabet and then there are the DeviceAdmin, MainActivity, MainService, MyReceiver, NotificationListener and ServiceReceiver classes (the R class is generated by the JADX software).</p>
<figure class="aligncenter size-large is-resized"><img alt="" class="wp-image-1436" height="420" src="https://lab52.io/blog/wp-content/uploads/2022/03/5.png" width="264"/></figure>
<p>The MainService class is the main class and therefore it is the first one to be executed in the application. This class has a main function OnCreate, it creates a notification channel called “Battery Level Service” where it will be executed.</p>
<figure class="aligncenter size-large is-resized"><img alt="" class="wp-image-1437" height="175" src="https://lab52.io/blog/wp-content/uploads/2022/03/6.png" style="max-width:800px;height:auto;width:auto;" width="680"/></figure>
<p>Next, the MainActiviy class is invoked, which using DeviceAdmin configures the device with administration permissions.</p>
<figure class="aligncenter size-large is-resized"><img alt="" class="wp-image-1439" height="148" src="https://lab52.io/blog/wp-content/uploads/2022/03/6-2.png" width="485"/></figure>
<figure class="aligncenter size-large is-resized"><img alt="" class="wp-image-1440" height="133" src="https://lab52.io/blog/wp-content/uploads/2022/03/6-3.png" style="max-width:800px;height:auto;width:auto;" width="661"/></figure>
<p>Once the application is configured, each of the tasks that steal information from the device are executed. Classes a, b, f, g, i, j, k, l, m, n, o and NotificationListener implement functions that steal information from the device and add it to a JSON.</p>
<p>In the Class a, the malware adds information about the installed packages to the JSON. For each of them it provides the package name, the application name, the version and its number.</p>
<figure class="aligncenter size-large"><img alt="" class="wp-image-1441" height="162" src="https://lab52.io/blog/wp-content/uploads/2022/03/6-4.png" width="346"/></figure>
<p>In the Class b, the malware adds information about the calls made from the device to the JSON. For each call it shows the number, name (contact), duration, date and type. The type is a number corresponding to the following table:</p>
<figure class="wp-block-table aligncenter is-style-regular"><table><thead><tr><th class="has-text-align-center">NUMBER</th><th class="has-text-align-center"> TYPE</th></tr></thead><tbody><tr><td class="has-text-align-center">1</td><td class="has-text-align-center">Incoming</td></tr><tr><td class="has-text-align-center">2</td><td class="has-text-align-center">Outgoing</td></tr><tr><td class="has-text-align-center">3</td><td class="has-text-align-center">Missed</td></tr><tr><td class="has-text-align-center">4</td><td class="has-text-align-center">Voice Message</td></tr><tr><td class="has-text-align-center">5</td><td class="has-text-align-center">Refused</td></tr><tr><td class="has-text-align-center">6</td><td class="has-text-align-center">Blacklist</td></tr></tbody></table></figure>
<figure class="aligncenter size-large is-resized"><img alt="" class="wp-image-1448" height="166" src="https://lab52.io/blog/wp-content/uploads/2022/03/6-7.png" width="531"/></figure>
<p>Similarly, the Class f adds to the JSON information about the contact list. Indicating the number and name of each one.</p>
<figure class="aligncenter size-large is-resized"><img alt="" class="wp-image-1447" height="138" src="https://lab52.io/blog/wp-content/uploads/2022/03/6-6.png" width="549"/></figure>
<p>We continue with the Class g that collects all the files in the device, saving in the JSON the name and the buffer of each one of them. In case a file cannot be accessed it also indicates it with “Access Denied”.</p>
<figure class="aligncenter size-large is-resized"><img alt="" class="wp-image-1451" height="152" src="https://lab52.io/blog/wp-content/uploads/2022/03/6-8.png" style="max-width:800px;height:auto;width:auto;" width="641"/></figure>
<figure class="aligncenter size-large is-resized"><img alt="" class="wp-image-1452" height="128" src="https://lab52.io/blog/wp-content/uploads/2022/03/6-9.png" width="385"/></figure>
<p>In addition, it also lists the directories, indicating the name and path.</p>
<figure class="aligncenter size-large is-resized"><img alt="" class="wp-image-1454" height="112" src="https://lab52.io/blog/wp-content/uploads/2022/03/6-10.png" width="433"/></figure>
<p>This Class i implements functions related to a location listener (When the location is changed, it is enabled or disabled), then adds in the JSON the location information with each change: The altitude, latitude, longitude, precision and even the speed at which the device is moving.</p>
<figure class="aligncenter size-large is-resized"><img alt="" class="wp-image-1455" height="223" src="https://lab52.io/blog/wp-content/uploads/2022/03/6-11.png" width="464"/></figure>
<p>The Class j returns adds to the JSON the clipboard information each time the clipboard is updated. To do so, it uses a listener that is configured in the MainService Class.</p>
<figure class="aligncenter size-large is-resized"><img alt="" class="wp-image-1457" height="180" src="https://lab52.io/blog/wp-content/uploads/2022/03/6-12.png" width="583"/></figure>
<p>The Class k implements a timer that launches task l and deletes the generated temporary file every x seconds. Afterwards, Class l records the audio from the device, extracts it in an .mp3 format in cacheDir and then adds a buffer of the file and the name to the JSON.</p>
<figure class="aligncenter size-large is-resized"><img alt="" class="wp-image-1459" height="263" src="https://lab52.io/blog/wp-content/uploads/2022/03/6-13.png" width="437"/></figure>
<figure class="aligncenter size-large is-resized"><img alt="" class="wp-image-1460" height="152" src="https://lab52.io/blog/wp-content/uploads/2022/03/6-14.png" width="392"/></figure>
<p>The Class m adds information about the permissions a user has on each package to the JSON. It goes through the entire list of packages on the device and checks what permissions each package is requesting.</p>
<figure class="aligncenter size-large is-resized"><img alt="" class="wp-image-1461" height="151" src="https://lab52.io/blog/wp-content/uploads/2022/03/6-15.png" style="max-width:800px;height:auto;width:auto;" width="673"/></figure>
<p>The Class n adds to the JSON conversations of all contacts thanks to (content://mms-sms/conversations?simple=true) and of addresses of all contacts (content://mms-sms/canonical-addresses). It also has a function that sends a text message in case the contact is not found.</p>
<figure class="aligncenter size-large is-resized"><img alt="" class="wp-image-1463" height="224" src="https://lab52.io/blog/wp-content/uploads/2022/03/6-16.png" width="565"/></figure>
<p>The Class o collects information from Wifis scanned by the device. For each of them it adds to the JSON its SSID and BSSID number.</p>
<figure class="aligncenter size-large is-resized"><img alt="" class="wp-image-1464" height="134" src="https://lab52.io/blog/wp-content/uploads/2022/03/6-17.png" width="575"/></figure>
<p>Finally, NotificationListener Class collects information about notifications. When a notification is opened, it stores in the JSON the name of the app, the content and the time it has been open.</p>
<figure class="aligncenter size-large is-resized"><img alt="" class="wp-image-1466" height="154" src="https://lab52.io/blog/wp-content/uploads/2022/03/6-18.png" width="315"/></figure>
<p>Once all the information has been collected in JSON format, the application contacts the C2 (82.146.35[.]240) and identifies the device by its model, version, id and manufacturer.</p>
<figure class="aligncenter size-large is-resized"><img alt="" class="wp-image-1469" height="170" src="https://lab52.io/blog/wp-content/uploads/2022/03/6-20.png" width="560"/></figure>
<figure class="aligncenter size-large"><img alt="" class="wp-image-1468" height="30" src="https://lab52.io/blog/wp-content/uploads/2022/03/6-19.png" width="584"/></figure>
<p>Later, it will send the information it has stolen to the same server.</p>
<figure class="aligncenter size-large is-resized"><img alt="" class="wp-image-1470" height="60" src="https://lab52.io/blog/wp-content/uploads/2022/03/Imagen1.png" style="max-width:800px;height:auto;width:auto;" width="805"/></figure>
<p>To launch each of the tasks the malware has its own commands that are defined in Class e and are launched (in their entirety) with Class d. In the following table you can see the relationship of these commands with each task.</p>
<figure class="wp-block-table aligncenter is-style-regular"><table><thead><tr><th class="has-text-align-center">COMMAND</th><th class="has-text-align-center">FUNCTION</th><th class="has-text-align-center">RELATED CLASS</th></tr></thead><tbody><tr><td class="has-text-align-center">0xLO</td><td class="has-text-align-center">Location</td><td class="has-text-align-center">i</td></tr><tr><td class="has-text-align-center">0xCL</td><td class="has-text-align-center">Call List</td><td class="has-text-align-center">b</td></tr><tr><td class="has-text-align-center">0xMI</td><td class="has-text-align-center">Audio Recorder</td><td class="has-text-align-center">l</td></tr><tr><td class="has-text-align-center">0xFI</td><td class="has-text-align-center">File Information</td><td class="has-text-align-center">g</td></tr><tr><td class="has-text-align-center">0xSM</td><td class="has-text-align-center">SMS Information</td><td class="has-text-align-center">n</td></tr><tr><td class="has-text-align-center">0xPM/0xGP</td><td class="has-text-align-center">Package Permissions</td><td class="has-text-align-center">m</td></tr><tr><td class="has-text-align-center">0xCO</td><td class="has-text-align-center">Contact List</td><td class="has-text-align-center">f</td></tr><tr><td class="has-text-align-center">0xIN</td><td class="has-text-align-center">Package Information</td><td class="has-text-align-center">a</td></tr><tr><td class="has-text-align-center">0xWI</td><td class="has-text-align-center">Wifi Information</td><td class="has-text-align-center">o</td></tr><tr><td class="has-text-align-center">0xNO</td><td class="has-text-align-center">Notifications</td><td class="has-text-align-center">NotificationListener</td></tr></tbody></table></figure>
<p>Finally, among one of the communications made by the malware, we noticed that it tried to download an application called Rozdhan using a goo.gl shorter.</p>
<figure class="aligncenter size-large is-resized"><img alt="" class="wp-image-1472" height="191" src="https://lab52.io/blog/wp-content/uploads/2022/03/Imagen1-1.png" width="387"/></figure>
<figure class="aligncenter size-large is-resized"><img alt="" class="wp-image-1473" height="54" src="https://lab52.io/blog/wp-content/uploads/2022/03/2-1.png" style="max-width:800px;height:auto;width:auto;" width="778"/></figure>
<p>The application is on Google Play and is used to earn money, has a referral system that is abused by the malware. The attacker installs it on the device and makes a profit.</p>
<figure class="aligncenter size-large is-resized"><img alt="" class="wp-image-1475" height="181" src="https://lab52.io/blog/wp-content/uploads/2022/03/2-2.png" width="542"/></figure>
<figure class="wp-block-table aligncenter is-style-regular"><table><thead><tr><th class="has-text-align-left">IOCs</th><th></th></tr></thead><tbody><tr><td class="has-text-align-left">82[.]146.35.240</td><td>C2</td></tr><tr><td class="has-text-align-left">e0eacd72afe39de3b327a164f9c69a78c9c0f672d3ad202271772d816db4fad8</td><td>SHA256</td></tr><tr><td class="has-text-align-left">51ab555404b7215af887df3146ead5e44603be9765d39c533c21b5737a88f176</td><td>SHA256</td></tr><tr><td class="has-text-align-left">hxxps://videos-share-rozdhan[.]firebaseio.com</td><td>URL</td></tr><tr><td class="has-text-align-left">hxxp://ylink[.]cc/fqCV3</td><td>URL</td></tr><tr><td class="has-text-align-left">hxxp://d3hdbjtb1686tn.cloudfront[.]net/gpsdk.html</td><td>URL</td></tr><tr><td class="has-text-align-left">hxxp://da.anythinktech[.]com</td><td>URL</td></tr><tr><td class="has-text-align-left">akankdev2017@gmail[.]com</td><td>EMAIL SRC</td></tr></tbody></table></figure>
<p>Customers with Lab52’s APT intelligence private feed service already have more tools and means of detection for this campaign.
In case of having threat hunting service or being client of S2Grupo CERT, this intelligence has already been applied.</p>
<p>If you need more information about Lab52’s private APT intelligence feed service, you can contact us through the<a href="https://lab52.io/contact"> following link</a></p>
</div>