<div>
<p><img alt="How the Saitama backdoor uses DNS tunnelling" src="https://blog.malwarebytes.com/wp-content/uploads/2022/05/tunnel-900x506.jpg" style="max-width:80%;height:auto;width:auto;"/></p>
<p><a href="https://blog.malwarebytes.com/category/explained/" rel="category tag">Explained</a> | <a href="https://blog.malwarebytes.com/category/threat-intelligence/" rel="category tag">Threat Intelligence</a></p>
<h1 class="entry-title p-name">
					How the Saitama backdoor uses DNS tunnelling				</h1>
<p>Posted: May 25, 2022 by <a href="https://blog.malwarebytes.com/author/mstockley/" rel="author" title="Posts by Mark Stockley">Mark Stockley</a>
</p>
A walkthrough of one of the stealthy communication techniques employed in a recent attack using APT34's Saitama backdoor. 
<p>Thanks to the Malwarebytes Threat Intelligence Team for the information they provided for this article.</p>
<p>Understandably, a lot of cybersecurity research and commentary focuses on the act of breaking into computers undetected. But threat actors are often just as concerned with the act of breaking out of computers undetected too. </p>
<p>Malware with the intent of surveillance or espionage needs to operate undetected, but the chances are it also needs to exfiltrate data or exchange messages with its command and control infrastructure, both of which could reveal its presence to threat hunters.</p>
<p>One of the stealthy communication techniques employed by malware trying to avoid detection is DNS Tunnelling, which hides messages inside ordinary-looking DNS requests.</p>
<p>The Malwarebytes Threat Intelligence team recently published research about an <a href="https://blog.malwarebytes.com/threat-intelligence/2022/05/apt34-targets-jordan-government-using-new-saitama-backdoor/">attack on the Jordanian government</a> by the Iranian Advanced Persistent Threat (APT) group APT34 that used its own innovative version of this method. </p>
<p>The payload in the attack was a backdoor called Saitama, a <a href="https://en.wikipedia.org/wiki/Finite-state_machine" rel="noreferrer noopener nofollow" target="_blank">finite state machine</a> that used DNS to communicate. Our original article provides an educational deep dive into the operation of Saitama and is well worth a read.</p>
<p>Here we will expand on the tricks that Saitama used to keep its DNS tunelling hidden.</p>
<h2>Saitama’s DNS tunnelling</h2>
<p>DNS is the Internet’s “address book” that allows computers to lookup human-readable domain names, like <code>malwarebytes.com</code>, and find their IP addresses, like <code>54.192.137.126</code>.</p>
<p>DNS information isn’t held in a single database. Instead it’s distributed, and each domain has name servers that are responsible for answering questions about them. Threat actors can use DNS to communicate by having their malware make DNS lookups that are answered by name servers they control. </p>
<p>DNS is so important it’s almost never blocked by corporate firewalls, and the enormous volume of DNS traffic on corporate networks provides plenty of cover for malicious communication.</p>
<p>Saitama’s messages are shaped by two important concerns: DNS traffic is still largely unencrypted, so messages have to be obscured so their purpose isn’t obvious; and DNS records are often cached heavily, so identical messages have to look different to reach the APT-controlled name servers.</p>
<h2>Saitama’s messages</h2>
<p>In the attack on the Jordanian foreign ministry, Saitama’s domain lookups used the following syntax:</p>
<p><code>domain = message, counter </code><code>'.'</code> root domain</p>
<p>The root domain is always one of <code>uber-asia.com</code>, <code>asiaworldremit.com</code> or <code>joexpediagroup.com</code>, which are used interchangeably.</p>
<p>The sub-domain portion of each lookup consists of a message followed by a counter. The counter is used to encode the message, and is sent to the command and control (C2) server with each lookup so the C2 can decode the message.</p>
<p>Four types of message can be sent:</p>
<h3>1. Make contact</h3>
<p>The first time it is executed, Saitama starts its counter by choosing a random number between <code>0</code> and <code>46655</code>. In this example our randomly-generated counter is <code>7805</code>.</p>
<p>The DNS lookup derived from that counter is:</p>
<p><code>nbn4vxanrj.joexpediagroup.com</code></p>
<p>The counter itself is encoded using a hard-coded base36 alphabet that is shared by the name server. In base36 each digit is represented by one of the 36 characters 0-9 and A-Z. In the standard base36, alphabet <code>7805</code> is written <code>60t</code> (<code>6</code> x <code>1296</code> + <code>0</code> x <code>36</code> + 30 x <code>1</code>). However, in Saitama’s custom alphabet <code>7805</code> is <code>nrj</code>.</p>
<p>The counter is also used to generate a custom alphabet that will be used to encode the message using a simple substitution. The first message sent home is the command <code>0</code>, base36-encoded to <code>a</code>, which tells the server it has a new victim, prepended to the string <code>haruto</code>, making <code>aharuto</code>.</p>
<p>A simple substitution using the alphabet generated by the counter yields the message <code>nbn4vxa</code>.</p>
a b c d e f g h i j k l m n o p q r s t u v w x y z 0 1 2 3 4 5 6 7 8 9
↓ ↓ ↓ ↓ ↓ ↓ 
n j 1 6 9 k p b h d 0 7 y i a 2 g 4 u x v 3 e s w f 5 8 r o c q t l z m
<p>The C2 name server decodes the counter using the shared, hard-coded alphabet, and then uses the counter to derive the alphabet used to encode <code>aharuto</code>. </p>
<p>It responds to the contact request with an IP address that contains an ID for Saitama to use in future communications. The first three octets can be anything, and Saitama ignores them. The final octet contains the ID. In our example we will use the ID <code>203</code>:</p>
<p><code>75.99.87.203</code></p>
<h3>2. Ask for a command</h3>
<p>Now that it has an ID from the C2 server, Saitama increments its counter to <code>7806</code> and signals its readiness to receive a command as follows: The counter is used to generate a new custom alaphabet, which encodes the ID, <code>203</code>, as <code>ao</code>. The counter itself is encoded using the malware’s hard-coded base36 alphabet, to <code>nrc</code>, and one of Saitama’s three root domains is chosen at random, resulting in:</p>
<p><code>aonrc.uber-asia.com</code></p>
<p>The C2 server responds to the request with the size of the payload Saitama should expect. Saitama will use this to determine how many requests it will need to make to retrieve the full payload.</p>
<p>The first octet of the IP address the C2 responds with is any number between 129 and 255, while the second, third and fourth octets signify the first, second, and third bytes of the size of the payload. In this case the payload will be four bytes.</p>
<p><code>129.0.0.4</code></p>
<h3>3. Get a command</h3>
<p>Now that it knows the size of the payload it will receive, Saitama makes one or more RECEIVE requests to the server to get its instructions. It increments its counter by one each time, starting at <code>7807</code>. Multiple requests may be necessary in this step because some command names require more than the four bytes of information an IP address can carry. In this case it has been told to retrieve four bytes of information so it will only need to make one request.</p>
<p>The message from Saitama consists of three parts: The digit 2, indicating the <code>RECEIVE</code> command; the ID <code>203</code>; and an offset indicating which part of the payload is required. These are individually base36-encoded and concatenated together. The resulting string is encoded using a custom base36 alphabet derived from the counter <code>7807</code>, giving us the message <code>k7myyy</code>.</p>
<p>The counter is encoded using the hard-coded alphabet to <code>nr6,</code> and one of Saitama’s three root domains is chosen at random, giving us:</p>
<p><code>k7myyynr6.asiaworldremit.com</code></p>
<p>The C2 indicates which function it wants to run using two-digit integers. It can ask Saitama to run any of five different functions:</p>
<figure class="wp-block-table is-style-stripes"><table><thead><tr><th>C2</th><th>Saitama</th></tr></thead><tbody><tr><td><code>43</code></td><td><code>Static</code></td></tr><tr><td><code>70</code></td><td><code>Cmd</code></td></tr><tr><td><code>71</code></td><td><code>CompressedCmd</code></td></tr><tr><td><code>95</code></td><td><code>File</code></td></tr><tr><td><code>96</code></td><td><code>CompressedFile</code></td></tr></tbody></table><figcaption>Saitama functions</figcaption></figure>
<p>In this case the C2 wants to run the command <code>ver</code> using Saitama’s <code>Cmd</code> function. (In the previous request the C2 indicated that it would be sending Saitama a four byte payload: One byte for <code>70</code>, and three bytes for <code>ver</code>.)</p>
<p>In its response, the C2 uses the first octet of the IP address to indicate the function it wants to run, <code>70</code>, and then the remaining three octets to spell out the command name <code><a href="https://en.wikipedia.org/wiki/Ver_(command)">ver</a></code> using the <a href="https://en.wikipedia.org/wiki/ASCII" rel="noreferrer noopener nofollow" target="_blank">ASCII</a> codepoints for the lowercase characters “v”, “e”, and “r”:</p>
<p><code>70.118.101.114</code></p>
<h3>4. Run the command</h3>
<p>Saitama runs the command it has been given and sends the resulting output to the C2 server in one or more DNS requests. The counter is incremented by one each time, starting at <code>7808</code> in our example. Multiple requests may be necessary in this step because some command names require more than the four bytes an IP address can carry.</p>
<p><code>p6yqqqqp0b67gcj5c2r3gn3l9epztnrb.asiaworldremit.com</code></p>
<p>The counter is encoded using the hard-coded alphabet to <code>nrb,</code> and one of Saitama’s three root domains is chosen at random.</p>
<p>In this case the message consists of five parts: The digit 2, indicating the RECEIVE command; the ID <code>203</code>; and an offset indicating which part of the response is being sent; the size of the buffer; and a twelve-byte chunk of the output. These are individually base36-encoded and concatenated together. The resulting string is encoded using a custom base36 alphabet derived from the counter <code>7808</code>, giving us the message <code><code>p6yqqqqp0b67gcj5c2r3gn3l9epzt</code></code>.</p>
<h2>Detection</h2>
<p>Malwarebytes customers are protected from this attack via our Anti-Exploit layer. To learn more about the recent attack involving Saitama, read <a href="https://blog.malwarebytes.com/threat-intelligence/2022/05/apt34-targets-jordan-government-using-new-saitama-backdoor/">APT34 targets Jordan Government using new Saitama backdoor</a>.</p>
<h3>IOCs</h3>
<h4>Maldoc</h4>
<p>Confirmation Receive Document.xls
26884f872f4fae13da21fa2a24c24e963ee1eb66da47e270246d6d9dc7204c2b</p>
<h4>Saitama backdoor</h4>
<p>update.exe
e0872958b8d3824089e5e1cfab03d9d98d22b9bcb294463818d721380075a52d</p>
<h4>C2s</h4>
<p>uber-asia.com
asiaworldremit.com
joexpediagroup.com</p>
<p></p>
<p>SHARE THIS ARTICLE</p>
<a class="socicon-facebook" href="http://www.facebook.com/sharer.php?u=https%3A%2F%2Fblog.malwarebytes.com%2F%3Fp%3D56676&amp;t=How+the+Saitama+backdoor+uses+DNS+tunnelling" id="social-share-facebook" target="_blank"></a>
<a class="socicon-twitter" href="https://twitter.com/intent/tweet?text=How+the+Saitama+backdoor+uses+DNS+tunnelling+https%3A%2F%2Fblog.malwarebytes.com%2F%3Fp%3D56676&amp;via=Malwarebytes" id="social-share-twitter" target="_blank"></a>
<a class="socicon-linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3A%2F%2Fblog.malwarebytes.com%2F%3Fp%3D56676&amp;title=How+the+Saitama+backdoor+uses+DNS+tunnelling&amp;summary=&amp;source=" id="social-share-linkedin" target="_blank"></a>
<p>ABOUT THE AUTHOR</p>
<img alt="" class="avatar avatar-96 photo grav-hashed grav-hijack" height="96" id="grav-a8ee41690458a4b98dd1d11ce4213912-0" src="https://secure.gravatar.com/avatar/a8ee41690458a4b98dd1d11ce4213912?s=96&amp;d=identicon&amp;r=g" width="96"/>
<p>
<a href="https://blog.malwarebytes.com/author/mstockley/" rel="author" title="Posts by Mark Stockley">Mark Stockley</a>
</p>
<p></p>
</div>