<div>
<p>Microsoft successfully detected and disabled attack activity abusing OneDrive by a previously undocumented Lebanon-based activity group Microsoft Threat Intelligence Center (MSTIC) tracks as POLONIUM. The associated indicators and tactics were used by the OneDrive team to improve detection of attack activity and disable offending actor accounts. To further address this abuse, Microsoft has suspended more than 20 malicious OneDrive applications created by POLONIUM actors, notified affected organizations, and deployed a series of security intelligence updates that will quarantine tools developed by POLONIUM operators. Our goal with this blog is to help deter future activity by exposing and sharing the POLONIUM tactics with the community at large.</p>
<p>MSTIC assesses with high confidence that POLONIUM represents an operational group based in Lebanon. We also assess with moderate confidence that the observed activity was coordinated with other actors affiliated with Iran’s Ministry of Intelligence and Security (MOIS), based primarily on victim overlap and commonality of tools and techniques. Such collaboration or direction from Tehran would align with a string of revelations since late 2020 that the Government of Iran is using third parties to carry out cyber operations on their behalf, likely to enhance Iran’s plausible deniability.</p>
<p>POLONIUM has targeted or compromised more than 20 organizations based in Israel and one intergovernmental organization with operations in Lebanon over the past three months. This actor has deployed unique tools that abuse legitimate cloud services for command and control (C2) across most of their victims. POLONIUM was observed creating and using legitimate OneDrive accounts, then utilizing those accounts as C2 to execute part of their attack operation. This activity does not represent any security issues or vulnerabilities on the OneDrive platform. In addition, MSTIC does not, at present, see any links between this activity and other publicly documented groups linked to Lebanon like Volatile Cedar. This blog will also expose further details that show Iranian threat actors may be collaborating with proxies to operationalize their attacks. Microsoft continues to work across its platforms to identify abuse, take down malicious activity, and implement new proactive protections to discourage malicious actors from using our services.</p>
<p>As with any observed nation-state actor activity, Microsoft directly notifies customers that have been targeted or compromised, providing them with the information they need to secure their accounts.</p>
<h2>Observed actor activity</h2>
<p>Since February 2022, POLONIUM has been observed primarily targeting organizations in Israel with a focus on critical manufacturing, IT, and Israel’s defense industry. In at least one case, POLONIUM’s compromise of an IT company was used to target a downstream aviation company and law firm in a supply chain attack that relied on service provider credentials to gain access to the targeted networks. Multiple manufacturing companies they targeted also serve Israel’s defense industry, indicating a POLONIUM tactic that follows an increasing trend by many actors, including among several Iranian groups, of targeting service provider access to gain downstream access. Observed victim organizations were in the following sectors: critical manufacturing, information technology, transportation systems, defense industrial base, government agencies and services, food and agriculture, financial services, healthcare and public health, and other business types.</p>
<h3>POLONIUM TTPs shared with Iran-based nation-state actors</h3>
<p>MSTIC assesses with moderate confidence that POLONIUM is coordinating its operations with multiple tracked actor groups affiliated with Iran’s Ministry of Intelligence and Security (MOIS), based on victim overlap and the following common techniques and tooling:</p>
<ul><li>Common unique victim targeting: MSTIC has observed POLONIUM active on or targeting multiple victims that MERCURY previously compromised. According to the <a href="https://www.cybercom.mil/Media/News/Article/2897570/iranian-intel-cyber-suite-of-malware-uses-open-source-tools/" rel="noreferrer noopener" target="_blank">US Cyber Command</a>, MuddyWater, a group we track as MERCURY, “is a subordinate element within the Iranian Ministry of Intelligence and Security.”</li><li>Evidence of possible “hand-off” operations: The uniqueness of the victim organizations suggests a convergence of mission requirements with MOIS. It may also be evidence of a ‘hand-off’ operational model where MOIS provides POLONIUM with access to previously compromised victim environments to execute new activity. MSTIC continues to monitor both actors to further verify this ‘hand-off’ hypothesis.</li><li>Use of OneDrive for C2: MSTIC has observed both POLONIUM and DEV-0133 (aka <a href="https://www.secureworks.com/blog/lyceum-takes-center-stage-in-middle-east-campaign" rel="noreferrer noopener" target="_blank">Lyceum</a>) using cloud services, including OneDrive, for data exfiltration and command and control. </li><li>Use of AirVPN: Both POLONIUM and DEV-0588 (aka CopyKittens) commonly use AirVPN for operational activity. While use of public VPN services is common across many actor sets, these actors’ specific choice to use AirVPN, combined with the additional overlaps documented above, further supports the moderate confidence assessment that POLONIUM collaborates with MOIS.</li></ul>
<h3>Abuse of cloud services</h3>
<p>POLONIUM has been observed deploying a series of custom implants that utilize cloud services for command and control as well as data exfiltration. MSTIC has observed implants connecting to POLONIUM-owned accounts in OneDrive and Dropbox. These tools are detected as the following malware:</p>
<ul><li>Trojan:PowerShell/CreepyDrive.A!dha</li><li>Trojan:PowerShell/CreepyDrive.B!dha</li><li>Trojan:PowerShell/CreepyDrive.C!dha</li><li>Trojan:PowerShell/CreepyDrive.D!dha</li><li>Trojan:PowerShell/CreepyDrive.E!dha</li><li>Trojan:MSIL/CreepyBox.A!dha</li><li>Trojan:MSIL/CreepyBox.B!dha</li><li>Trojan:MSIL/CreepyBox.C!dha</li></ul>
<p>While OneDrive performs antivirus scanning on all uploaded content, POLONIUM is not using the cloud service to host their malware. If malware was hosted in the OneDrive account, Microsoft Defender Antivirus detections would block it. Instead, they are interacting with the cloud service in the same way that a legitimate customer would. OneDrive is partnering with MSTIC to identify and disable accounts that are linked to known adversary behavior.</p>
<h3>CreepyDrive analysis</h3>
<p>The CreepyDrive implant utilizes a POLONIUM-owned OneDrive storage account for command and control. The implant provides basic functionality of allowing the threat actor to upload stolen files and download files to run.</p>
<p>All web requests by the CreepyDrive implant use the Invoke-WebRequest cmdlet. The implant’s logic is wrapped in a while true loop, ensuring continuous execution of the implant once running. The implant contains no native persistence mechanism; if terminated it would need to be re-executed by the threat actor.</p>
<p>Due to the lack of victim identifiers in the CreepyDrive implant, using the same OneDrive account for multiple victims, while possible, may be challenging. It’s likely that a different threat actor-controlled OneDrive account is used per implant.</p>
<h5>Getting an OAuth token</h5>
<p>When run, the implant first needs to authenticate with OneDrive. The threat actor incorporated a refresh token within the implant. Refresh tokens are part of the Open Authorization 2 (OAuth) specification, allowing a new OAuth token to be issued when it expires. There are several mechanisms that make token theft difficult, including the use of the trusted platform module (TPM) to protect secrets. More information on these mechanisms can be found <a href="https://docs.microsoft.com/en-us/azure/active-directory/devices/concept-primary-refresh-token" rel="noreferrer noopener" target="_blank">here</a>.</p>
<p>In this instance, the protection settings tied to the OneDrive account are fully controlled by the threat actor, allowing them to disable protections that prevent the theft of the token and client secrets. As the threat actor is in full control of all secrets and key material associated with the account, their sign-in activity looks like legitimate customer behavior and is thus challenging to detect.</p>
<p>This token and client secret are transmitted in the body of request to a legitimate Microsoft endpoint to generate an OAuth token:</p>
https[://]login.microsoftonline.com/consumers/oauth2/v2.0/token
<p>This request provides the requisite OAuth token for the implant to interact with the threat actor-owned OneDrive account. Using this OAuth token, the implant makes a request to the following Microsoft Graph API endpoint to access the file data.txt:</p>
https[://]graph.microsoft.com/v1.0/me/drive/root:/Documents/data.txt:/content
<p>The file data.txt acts as the primary tasking mechanism for the implant, providing three branches of execution.</p>
<p>Upload</p>
<p>The first branch is triggered when the word “upload” is provided in the response. This response payload also contains two additional elements: a local file path to upload, and what is likely a threat actor-defined remote file name to upload the local file into. The request is structured as follows:</p>
https[://]graph.microsoft.com/v1.0/me/drive/root:/Uploaded/???:/content
<p>Download</p>
<p>The second branch is triggered when the word “download” is provided in the response. This response payload contains a file name to download from the threat actor-owned OneDrive account. The request is structured as follows:</p>
https[://]graph.microsoft.com/v1.0/me/drive/root:/Downloaded/???:/content
<p>Execute</p>
<p>This branch is triggered when no command is provided in the response. The response payload can contain either an array of commands to execute or file paths to files previously downloaded by the implant. The threat actor can also provide a mixture of individual commands and file paths.</p>
<p>Each value from the array is passed individually into the below custom function, which uses the Invoke-Expression cmdlet to run commands:</p>
<figure class="wp-block-image size-large"><img alt="" class="wp-image-115533" height="291" src="https://www.microsoft.com/security/blog/uploads/securityprod/2022/06/code-1-1024x291.png" style="max-width:800px;height:auto;width:auto;" width="1024"/></figure>
<p>The output of each executed command is aggregated and then written back to the following location in the threat actor-owned OneDrive account:</p>
https[://]graph.microsoft.com/v1.0/me/drive/root:/Documents/response.json:/content
<p>During the execution of this mechanism, the threat actor resets the content of the original tasking file data.txt with the following request:</p>
https[://]graph.microsoft.com/v1.0/me/drive/root:/Documents/data.txt:/content
<p>Finally, the CreepyDrive implant sleeps, re-executing in a loop until the process is terminated.</p>
<h3>Use of custom implant</h3>
<p>POLONIUM has also been observed deploying a custom PowerShell implant detected as Backdoor:PowerShell/CreepySnail.B!dha. The C2s for observed CreepySnail implants include:</p>
<ul><li>135[.]125[.]147[.]170:80</li><li>185[.]244[.]129[.]79:63047</li><li>185[.]244[.]129[.]79:80</li><li>45[.]80[.]149[.]108:63047</li><li>45[.]80[.]149[.]108:80</li><li>45[.]80[.]149[.]57:63047</li><li>45[.]80[.]149[.]68:63047</li><li>45[.]80[.]149[.]71:80</li></ul>
<p>The code below demonstrates how the CreepySnail PowerShell implant, once deployed on a target network, attempts to authenticate using stolen credentials and connect to POLONIUM C2 for further actions on objectives, such as data exfiltration or further abuse as C2.</p>
<figure class="wp-block-image size-large"><img alt="" class="wp-image-115536" height="643" src="https://www.microsoft.com/security/blog/uploads/securityprod/2022/06/code-2-1024x643.png" style="max-width:800px;height:auto;width:auto;" width="1024"/></figure>
<figure class="wp-block-image size-large"><img alt="" class="wp-image-115539" height="643" src="https://www.microsoft.com/security/blog/uploads/securityprod/2022/06/code-3-1024x643.png" style="max-width:800px;height:auto;width:auto;" width="1024"/></figure>
<figure class="wp-block-image size-large"><img alt="" class="wp-image-115542" height="1024" src="https://www.microsoft.com/security/blog/uploads/securityprod/2022/06/code-4-982x1024.png" style="max-width:800px;height:auto;width:auto;" width="982"/></figure>
<h3>Use of commodity tools</h3>
<p>POLONIUM has also been observed dropping a secondary payload via their OneDrive implant. POLONIUM used a common SSH tool for automating interactive sign-ins called plink to set up a redundant tunnel from the victim environment to the attacker-controlled infrastructure.</p>
<p>The observed C2 IP addresses for POLONIUM plink tunnels include:</p>
<ul><li>185[.]244[.]129 [.]109</li><li>172[.]96[.]188[.]51</li><li>51[.]83 [.]246 [.]73</li></ul>
<h3>Exploitation</h3>
<p>While we continue to pursue confirmation of how POLONIUM gained initial access to many of their victims, MSTIC notes that approximately 80% of the observed victims beaconing to graph.microsoft.com were running Fortinet appliances. This suggests, but does not definitively prove, that POLONIUM compromised these Fortinet devices by exploiting the <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2018-13379">CVE-2018-13379</a> vulnerability to gain access to the compromised organizations.</p>
<h3>IT supply chain attacks</h3>
<p>In one case, POLONIUM compromised a cloud service provider based in Israel and likely used this access to compromise downstream customers of the service provider. Specifically, MSTIC observed that POLONIUM pivoted through the service provider and gained access to a law firm and an aviation company in Israel. The tactic of leveraging IT products and service providers to gain access to downstream customers remains a favorite of Iranian actors and their proxies.</p>
<p>Microsoft will continue to monitor ongoing activity from POLONIUM and the other Iranian MOIS-affiliated actors discussed in this blog and implement protections for our customers. The current detections, advanced detections, and IOCs in place across our security products are detailed below.</p>
<h2>Recommended customer actions</h2>
<p>The techniques used by the actor described in the “Observed actor activity” section can be mitigated by adopting the security considerations provided below:</p>
<ul><li>Use the included indicators of compromise to investigate whether they exist in your environment and assess for potential intrusion. <a href="https://azure.microsoft.com/services/microsoft-sentinel/#overview" rel="noreferrer noopener" target="_blank">Microsoft Sentinel</a> queries are provided in the advanced hunting section below.</li><li>Confirm that Microsoft Defender Antivirus is updated to <a href="https://docs.microsoft.com/microsoft-365/security/defender-endpoint/manage-updates-baselines-microsoft-defender-antivirus">security intelligence update 1.365.40.0 or later</a>, or ensure that <a href="https://docs.microsoft.com/microsoft-365/security/defender-endpoint/cloud-protection-microsoft-defender-antivirus">cloud protection</a> is turned on, to detect the related indicators.</li><li>Block in-bound traffic from IPs specified in the “Indicators of compromise” table.</li><li>Review all authentication activity for remote access infrastructure (VPNs), with a particular focus on accounts configured with single factor authentication, to confirm authenticity and investigate any anomalous activity.</li><li>Enable multifactor authentication (MFA) to mitigate potentially compromised credentials and ensure that MFA is enforced for all remote connectivity. NOTE: Microsoft strongly encourages all customers download and use passwordless solutions like <a href="https://www.microsoft.com/account/authenticator/">Microsoft Authenticator</a> to secure your accounts.</li><li>For customers that have relationships with service providers, <a href="https://docs.microsoft.com/microsoft-365/commerce/manage-partners?view=o365-worldwide" rel="noreferrer noopener" target="_blank">review and audit partner relationships</a> to minimize any unnecessary permissions between your organization and upstream providers. Microsoft recommends immediately removing access for any partner relationships that look unfamiliar or have not yet been audited.</li></ul>
<h2>Indicators of compromise (IOCs)</h2>
<p>The below list provides IOCs observed during our investigation. We encourage our customers to investigate these indicators in their environments and implement detections and protections to identify past related activity and prevent future attacks against their systems.</p>
<figure class="wp-block-table"><table><tbody><tr><td>Indicator</td><td>Type</td><td>Description</td></tr><tr><td>135[.]125[.]147[.]170:80</td><td>IPv4 address</td><td>C2 for POLONIUM CreepySnail implant</td></tr><tr><td>185[.]244[.]129[.]79:63047</td><td>IPv4 address</td><td>C2 for POLONIUM CreepySnail implant</td></tr><tr><td>185[.]244[.]129[.]79:80</td><td>IPv4 address</td><td>C2 for POLONIUM CreepySnail implant</td></tr><tr><td>45[.]80[.]149[.]108:63047</td><td>IPv4 address</td><td>C2 for POLONIUM CreepySnail implant</td></tr><tr><td>45[.]80[.]149[.]108:80</td><td>IPv4 address</td><td>C2 for POLONIUM CreepySnail implant</td></tr><tr><td>45[.]80[.]149[.]57:63047</td><td>IPv4 address</td><td>C2 for POLONIUM CreepySnail implant</td></tr><tr><td>45[.]80[.]149[.]68:63047</td><td>IPv4 address</td><td>C2 for POLONIUM CreepySnail implant</td></tr><tr><td>45[.]80[.]149[.]71:80</td><td>IPv4 address</td><td>C2 for POLONIUM CreepySnail implant</td></tr><tr><td>185[.]244[.]129[.]109</td><td>IPv4 address</td><td>C2 for POLONIUM plink tunnels</td></tr><tr><td>172[.]96[.]188[.]51</td><td>IPv4 address</td><td>C2 for POLONIUM plink tunnels</td></tr><tr><td>51[.]83[.]246[.]73</td><td>IPv4 address</td><td>C2 for POLONIUM plink tunnels</td></tr><tr><td>Trojan:PowerShell/CreepyDrive.A!dha</td><td>Tool</td><td>Custom implant signature</td></tr><tr><td>Trojan:PowerShell/CreepyDrive.B!dha</td><td>Tool</td><td>Custom implant signature</td></tr><tr><td>Trojan:PowerShell/CreepyDrive.C!dha</td><td>Tool</td><td>Custom implant signature</td></tr><tr><td>Trojan:PowerShell/CreepyDrive.D!dha</td><td>Tool</td><td>Custom implant signature</td></tr><tr><td>Trojan:PowerShell/CreepyDrive.E!dha</td><td>Tool</td><td>Custom implant signature</td></tr><tr><td>Trojan:MSIL/CreepyBox.A!dha</td><td>Tool</td><td>Custom implant signature</td></tr><tr><td>Trojan:MSIL/CreepyBox.B!dha</td><td>Tool</td><td>Custom implant signature</td></tr><tr><td>Trojan:MSIL/CreepyBox.C!dha</td><td>Tool</td><td>Custom implant signature</td></tr><tr><td>Trojan:MSIL/CreepyRing.A!dha</td><td>Tool</td><td>Custom implant signature</td></tr><tr><td>Trojan:MSIL/CreepyWink.B!dha</td><td>Tool</td><td>Custom implant signature</td></tr><tr><td>Backdoor:PowerShell/CreepySnail.B!dha</td><td>Tool</td><td>Custom implant signature</td></tr></tbody></table></figure>
<p>NOTE: These indicators should not be considered exhaustive for this observed activity.</p>
<h2>Detections</h2>
<h3>Microsoft 365 Defender</h3>
<p>Microsoft Defender Antivirus</p>
<p>Microsoft Defender Antivirus detects the malware tools and implants used by POLONIUM starting from signature build 1.365.40.0 as the following:</p>
<ul><li>Trojan:PowerShell/CreepyDrive.A!dha</li><li>Trojan:PowerShell/CreepyDrive.B!dha</li><li>Trojan:PowerShell/CreepyDrive.C!dha</li><li>Trojan:PowerShell/CreepyDrive.D!dha</li><li>Trojan:PowerShell/CreepyDrive.E!dha</li><li>Trojan:MSIL/CreepyBox.A!dha</li><li>Trojan:MSIL/CreepyBox.B!dha</li><li>Trojan:MSIL/CreepyBox.C!dha</li><li>Trojan:MSIL/CreepyRing.A!dha</li><li>Trojan:MSIL/CreepyWink.B!dha</li><li>Backdoor:PowerShell/CreepySnail.B!dha</li></ul>
<p>Microsoft Defender for Endpoint</p>
<p>Microsoft Defender for Endpoint customers may see any or a combination of the following alerts as an indication of possible attack. These alerts are not necessarily an indication of POLONIUM compromise:</p>
<ul><li>POLONIUM Actor Activity Detected</li><li>PowerShell made a suspicious network connection</li><li>Suspicious behavior by powershell.exe was observed</li><li>Hidden dual-use tool launch attempt</li><li>Outbound connection to non-standard port</li></ul>
<p>Microsoft Defender for Cloud Apps</p>
<p>The OAuth apps that were created in the victim tenants were created with only two specific scope of permissions: offline_access and Files.ReadWrite.All. These applications were set to serve multi-tenant and performed only OneDrive operations. Applications accessed OneDrive workload via the Graph API, where most calls to the API from the application were made as search activities, with a few edit operations also observed.</p>
<p>App made numerous searches and edits in OneDrive</p>
<p>App governance, an add-on to Microsoft Defender for Cloud Apps, detects malicious OAuth applications that make numerous searches and edits in OneDrive. <a href="https://docs.microsoft.com/en-us/defender-cloud-apps/app-governance-anomaly-detection-alerts#app-made-numerous-searches-and-edits-in-onedrive">Learn how to investigate anomaly detection alerts</a> in Microsoft Defender for Cloud Apps.</p>
<figure class="wp-block-image size-full"><img alt="" class="wp-image-115560" height="274" src="https://www.microsoft.com/security/blog/uploads/securityprod/2022/06/MDCA-alert.png" width="429"/><figcaption>Microsoft Defender for Cloud Apps alert for malicious OAuth apps</figcaption></figure>
<h2>Advanced hunting queries</h2>
<h3>Microsoft Sentinel</h3>
<h4>Identify POLONIUM IOCs</h4>
<p>This query identifies POLONIUM network IOCs within available Azure Sentinel network logging:</p>
<p><a href="https://github.com/Azure/Azure-Sentinel/tree/master/Detections/MultipleDataSources/POLONIUMIPIoC.yaml">https://github.com/Azure/Azure-Sentinel/tree/master/Detections/MultipleDataSources/POLONIUMIPIoC.yaml</a></p>
<h4>Detect CreepySnail static URI parameters</h4>
<p>The CreepySnail tool utilizes static URI parameters that can be detected using the following query:</p>
<p><a href="https://github.com/Azure/Azure-Sentinel/blob/master/Detections/CommonSecurityLog/CreepySnailURLParameters.yaml">https://github.com/Azure/Azure-Sentinel/blob/master/Detections/CommonSecurityLog/CreepySnailURLParameters.yaml</a></p>
<h4>Detect Base64-encoded/transmitted machine usernames or IP addresses </h4>
<p>CreepySnail also utilizes Base64-encoded parameters to transmit information from the victim to threat actor. The following queries detect machine usernames or IP addresses (based on Microsoft Defender for Endpoint logging) being transmitted under Base64 encoding in a web request:</p>
<p><a href="https://github.com/Azure/Azure-Sentinel/tree/master/Detections/MultipleDataSources/B64UserInWebURIFromMDE.yaml">https://github.com/Azure/Azure-Sentinel/tree/master/Detections/MultipleDataSources/B64UserInWebURIFromMDE.yaml</a></p>
<p><a href="https://github.com/Azure/Azure-Sentinel/tree/master/Detections/MultipleDataSources/B64IPInURLFromMDE.yaml">https://github.com/Azure/Azure-Sentinel/tree/master/Detections/MultipleDataSources/B64IPInURLFromMDE.yaml</a></p>
<h4>Detect POLONIUM requests to predictable OneDrive file paths</h4>
<p>The OneDrive capability that POLONIUM utilizes makes requests to predictable OneDrive file paths to access various folders and files. The following queries detect these paths in use:</p>
<p><a href="https://github.com/Azure/Azure-Sentinel/blob/master/Detections/CommonSecurityLog/CreepyDriveURLs.yaml">https://github.com/Azure/Azure-Sentinel/blob/master/Detections/CommonSecurityLog/CreepyDriveURLs.yaml</a></p>
<h4>Detect sequence of request events related to unique CreepyDrive re-authentication attempts</h4>
<p>The CreepyDrive implant makes a predictable sequence of requests to Microsoft authentication servers and OneDrive that can be detected using the following query:</p>
<p><a href="https://github.com/Azure/Azure-Sentinel/blob/master/Detections/CommonSecurityLog/CreepyDriveRequestSequence.yaml">https://github.com/Azure/Azure-Sentinel/blob/master/Detections/CommonSecurityLog/CreepyDriveRequestSequence.yaml</a></p>
<h4>Hunt for other suspicious encoded request parameters</h4>
<p>The following hunting queries can be used to hunt for further suspicious encoded request parameters:</p>
<p><a href="https://github.com/Azure/Azure-Sentinel/tree/master/Hunting%20Queries/CommonSecurityLog/B64IPInURL.yaml">https://github.com/Azure/Azure-Sentinel/tree/master/Hunting%20Queries/CommonSecurityLog/B64IPInURL.yaml</a></p>
<p><a href="https://github.com/Azure/Azure-Sentinel/tree/master/Hunting%20Queries/CommonSecurityLog/RiskyCommandB64EncodedInUrl.yaml">https://github.com/Azure/Azure-Sentinel/tree/master/Hunting%20Queries/CommonSecurityLog/RiskyCommandB64EncodedInUrl.yaml</a></p>
</div>