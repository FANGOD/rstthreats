<div>
<p>Fortinet’s FortiGuard Labs captured a phishing campaign that delivers three fileless malware onto a victim’s device. Once executed, they are able to control and steal sensitive information from that device to perform other actions according to the control commands from their server.</p>
<p>In <a href="https://www.fortinet.com/blog/threat-research/phishing-campaign-delivering-fileless-malware">Part I of this analysis</a>, I introduced how these three fileless malware are delivered to the victim’s device via a phishing campaign, and what mechanism it uses to load, deploy, and execute these fileless malware in the target process.</p>
<p>In Part II, I will focus on the three malware payloads and elaborate on how they steal sensitive information from the victim’s device, how they submit data to their C2 server, details about the control commands, as well as what they can perform with those control commands.
</p>
<p>Affected platforms: Microsoft Windows
Impacted parties: Microsoft Windows Users
Impact: Controls victim’s device and collects sensitive information
Severity level: Critical
</p>
<h2>Fileless Malware 1 - AveMariaRAT</h2>
<p>“Ave Maria” is a RAT (Remote Access Trojan), also known as WARZONE RAT. It offers a wide range of features, such as stealing victim’s sensitive information and remote controlling an infected device, including privilege escalation, remote desktop control, camera capturing, and more.</p>
<p>It is the first of the three malware (refer to Figure 3.3 of <a href="https://www.fortinet.com/blog/threat-research/phishing-campaign-delivering-fileless-malware">the previous analysis</a>) to be injected into a newly-created “aspnet_compiler.exe” process on the victim’s device and then run.</p>
<h3>Step One:</h3>
<p>Ave Maria has a configuration block that is RC4 encrypted within its PE structure’s “.bss” section. The decryption key and encrypted data are together within the “.bss”. When the malware starts, it first decrypts the configuration block. Figure 1.1 shows the decrypted data in memory.</p>
<img alt="Figure 1.1 – RC4-decrypted configuration block" class="loading" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" style="max-width:80%;height:auto;width:auto;"/>
Figure 1.1 – RC4-decrypted configuration block
<p>It not only contains the C2 server (“mubbibun.duckdns.org”) and port (0x3E7), but also a number of switch flags, such as whether to add itself into the auto-run group, bypass UAC (User Account Control), or bypass Windows Defender.</p>
<h3>Stage Two:</h3>
<p>Once Ave Maria establishes its connection to the C2 server it starts to control the victim’s device. According to my research, the traffic between its client and the C2 server is RC4 encrypted with a constant encryption key "warzone160".</p>
<p>I’ll explain what the plaintext packet consists of through an instance packet as below.</p>
<p>29 BB 66 E4 70 EA 00 00 1E 00 00 00 00 00 00 00</p>
<p>00 FA 07 00 00 00 00 00 60 EA 00 00 4D 5A 90 00</p>
<p>…</p>
<ul>
<li>The first dword 0xE466BB29 is a magic value; each packet must start with this value.</li>
<li>The 0xEA70 is the size of the command data. It is 0x0 if no command data.</li>
<li>The 0x1E is the command number of this packet.</li>
<li>The subsequence data is the command data, which is an executable file in this example packet. It doesn’t appear if there is no command data for the command.</li>
</ul>
<p>Ave Maria provides these features:</p>
<p>Remote VNC (Virtual Network Computing), Remote Shell, File Explorer, Process Manager, Remote Webcam, Password Manager, Reverse Socks, Download &amp; Execute a file, Remote Keylogger, HRDP Manager as well as Privilege Escalation.</p>
<img alt="Figure 1.2 – Display of Remote Keylogger feature" class="loading" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" style="max-width:80%;height:auto;width:auto;"/>
Figure 1.2 – Display of Remote Keylogger feature
<p>Figure 1.2 shows the feature (on the C2 server side) of the online Remote Keylogger (command 24H). You can see here what is recorded when I open a Chrome browser and type in “www.fortinet.com” and press Enter on a victim’s device.</p>
<p>Its Password Manager feature aims to steal credentials from a group of apps, listed below, including internet browsers and email clients.</p>
<p>Google Chrome, Epic Privacy browser, Microsoft Edge, UCBrowser, Tencent QQBrowser, Opera, Blisk, Chromium, Brave-Browser, Vivaldi, Comodo Dragon, Torch, Slim, CentBrowser, Microsoft Internet Explorer, Mozilla Firefox, Microsoft Outlook, Microsoft Messaging, Mozilla Thunderbird, Tencent Foxmail, and more.</p>
<img alt="Figure 1.3 – The pseudo code of stealing credentials" class="loading" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" style="max-width:80%;height:auto;width:auto;"/>
Figure 1.3 – The pseudo code of stealing credentials
<p>Figure 1.3 is a screenshot of the pseudo code where Ave Maria steals the credentials (command 20H) from the defined files for several internet browsers. It calls a function to RC4-encrypt the credentials and send them to the C2 server.</p>
<p>Table 1.1 presents most of the control commands that Ave Maria supports.</p>
<table align="left" cellspacing="0" class="MsoTableGrid">
<tbody><tr><td><p>Cmd Num</p>
</td>
<td><p>Description</p>
</td>
</tr><tr><td><p>00H</p>
</td>
<td><p>Ask for basic information of the victim’s device.</p>
</td>
</tr><tr><td><p>02H</p>
</td>
<td><p>List running processes.</p>
</td>
</tr><tr><td><p>04H</p>
</td>
<td><p>Start File Explorer.</p>
</td>
</tr><tr><td><p>06H</p>
</td>
<td><p>Navigate file.</p>
</td>
</tr><tr><td><p>08H</p>
</td>
<td><p>Retrieve a file from Ave Maria home folder (%LocalAppData%\Microsoft Vision\) on the victim device.</p>
</td>
</tr><tr><td><p>0AH</p>
</td>
<td><p>Delete a file.</p>
</td>
</tr><tr><td><p>0Ch</p>
</td>
<td><p>Kill a process.</p>
</td>
</tr><tr><td><p>0EH</p>
</td>
<td><p>Execute a shell command.</p>
</td>
</tr><tr><td><p>12H</p>
</td>
<td><p>List victim’s camera device information.</p>
</td>
</tr><tr><td><p>14H</p>
</td>
<td><p>Start victim’s camera.</p>
</td>
</tr><tr><td><p>16H</p>
</td>
<td><p>Stop the camera.</p>
</td>
</tr><tr><td><p>18H</p>
</td>
<td><p>Obtain the title of the active program.</p>
</td>
</tr><tr><td><p>1Ah</p>
</td>
<td><p>Uninstall Ave Maria client from the victim’s device.</p>
</td>
</tr><tr><td><p>1Ch</p>
</td>
<td><p>Transfer a file from C2 server to the victim's device.</p>
</td>
</tr><tr><td><p>1EH</p>
</td>
<td><p>Transfer an executable file to the victim’s device and run.</p>
</td>
</tr><tr><td><p>20H</p>
</td>
<td><p>Obtain the credentials of the apps from the victim’s device.</p>
</td>
</tr><tr><td><p>22H</p>
</td>
<td><p>Download a file from a given URL and execute.</p>
</td>
</tr><tr><td><p>24H</p>
</td>
<td><p>Start the online keylogger.</p>
</td>
</tr><tr><td><p>26H</p>
</td>
<td><p>Stop the online keylogger.</p>
</td>
</tr><tr><td><p>28H</p>
</td>
<td><p>Install HRDP Manager on the victim's device.</p>
</td>
</tr><tr><td><p>2AH</p>
</td>
<td><p>Reverse connect to C2 server for HRDP.</p>
</td>
</tr><tr><td><p>30H</p>
</td>
<td><p>Start the Remote VNC.</p>
</td>
</tr><tr><td><p>32H</p>
</td>
<td><p>Stop the Remote VNC</p>
</td>
</tr><tr><td><p>38H</p>
</td>
<td><p>Start reverse sock.</p>
</td>
</tr><tr><td><p>3AH</p>
</td>
<td><p>Execute a specified file on the victim's device.</p>
</td>
</tr><tr><td><p>3CH</p>
</td>
<td><p>Start the offline keylogger.</p>
</td>
</tr><tr><td><p>3EH,40H</p>
</td>
<td><p>Privilege Escalation. </p>
</td>
</tr><tr><td><p>48H</p>
</td>
<td><p>Transfer a file to the victim.</p>
</td>
</tr><tr><td><p>4AH</p>
</td>
<td><p>Retrieve a folder from the victim device. </p>
</td>
</tr></tbody></table>
<p>Table 1.1 – Ave Maria’s Control Commands</p>
<h2>Fileless Malware 2 – PandorahVNC RAT</h2>
<p>The second fileless malware injected into “RegAsm.exe” is “PandorahVNC Rat,” which is a commercial software. It was developed using C#, a Microsoft .Net framework. It supports features to steal credentials from some popular applications, like Chrome, Microsoft Edge, Firefox, Outlook, Foxmail, and so on. It also supports control commands to control the victim’s device, such as starting a process, capturing the screenshot, manipulating the victim’s mouse and keyboard, and more.</p>
<h3>Stage One:</h3>
<p>When it starts, it defines the following variables. They are the C2 server address, port, and the group id that will be used when sending data to the C2 server.</p>
<p>string str = "vncgoga.duckdns.org"; //C2 server
string str2 = "1338"; // TCP port
string identifier = "3H4RHL"; // Group id</p>
<p>Next, it proceeds to extract a core module from a base64-encoded string, which performs all features of PandoraHVNC RAT. It then deploys the core module into a newly-created process, “cvtres.exe” (a file from Microsoft .Net framework), using process hollowing. It tries to find the file from one of the following:</p>
<p>“C:\Windows\Microsoft.NET\Framework\v4.0.30319\"
"C:\Windows\Microsoft.NET\Framework\v2.0.50727\”
</p>
<p>If it fails to locate the file, it quits without running PandoraHVNC RAT’s core module. The C2 server address, port, and group id will be passed to the new process during the process hollowing. Figure 2.1 shows the code segment to perform the process hollowing.</p>
<img alt="Figure 2.1 – Code to perform the process hollowing" class="loading" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" style="max-width:80%;height:auto;width:auto;"/>
Figure 2.1 – Code to perform the process hollowing
<h3>Stage Two:</h3>
<p>It collects basic information from the victim’s device and sends it to the C2 server to register the client in the server. Below is the data of such packet.</p>
<img alt="Figure 2.2 – The registration packet to the C2 server" class="loading" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" style="max-width:80%;height:auto;width:auto;"/>
Figure 2.2 – The registration packet to the C2 server
<p>The first 64-bit integer 0x62 is the entire packet size. The subsequent data is sealed in a serialized binary object. The 16H data (“00 01 … 0000”) is kind of header. The next 0x4a is the size of the following strings, which is a variable length integer. The last 0x0b is a close flag.</p>
<p>Let’s take a look the sealed string, which consists of a packet number (“654321”), client group id (“3H4RHL”), the victim’s username and pc name (“Bobs@BOBS-PC”), the victim’s location code (“US”), the system information (“Windows 7 Pro”), date (“05/09/2022”), client version (“3.1”), and whether any antivirus product is being used (“False”).</p>
<p>Once the C2 server receives this packet, it shows the victim’s information in a list, as shown in Figure 2.3, “Connected client”.</p>
<img alt="Figure 2.3 - PandoraHVNC RAT C2 server interface and features" class="loading" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" style="max-width:80%;height:auto;width:auto;"/>
Figure 2.3 - PandoraHVNC RAT C2 server interface and features
<p>The hacker is then able to control the victim’s machine by right-clicking the client and clicking the items on the menu. Figure 2.3 also demonstrates the right-click menu and features.</p>
<img alt="Figure 2.4 – The credentials packet to C2 server" class="loading" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" style="max-width:80%;height:auto;width:auto;"/>
Figure 2.4 – The credentials packet to C2 server
<p>Figure 2.4 is a screenshot of two packets, the first line is the received command control packet with command number “3308”. The rest is the packet sent to the C2 server with packet number “3308”. This is followed by the stolen credentials from the victim when “Pandora Recovery” is clicked by the hacker. As mentioned before, the two packets are sealed in the serialized binary object.</p>
<p>Table 2.1 demonstrates the details of all the control commands and features that PandoraHVNC RAT provides.</p>
<table cellspacing="0" class="MsoTableGrid">
<tbody><tr><td><p>Cmd Num</p>
</td>
<td><p>Description</p>
</td>
</tr><tr><td><p>0</p>
</td>
<td><p>Start to capture the screenshot.</p>
</td>
</tr><tr><td><p>1</p>
</td>
<td><p>Abort the screenshot.</p>
</td>
</tr><tr><td><p>2</p>
</td>
<td><p>Simulate mouse left button DOWN.</p>
</td>
</tr><tr><td><p>3</p>
</td>
<td><p>Simulate mouse right button DOWN.</p>
</td>
</tr><tr><td><p>4</p>
</td>
<td><p>Simulate mouse left button UP.</p>
</td>
</tr><tr><td><p>5</p>
</td>
<td><p>Simulate mouse right button UP.</p>
</td>
</tr><tr><td><p>6</p>
</td>
<td><p>Perform mouse double click.</p>
</td>
</tr><tr><td><p>7</p>
</td>
<td><p>Simulate to press a Key.</p>
</td>
</tr><tr><td><p>8</p>
</td>
<td><p>Move the mouse to a given point.</p>
</td>
</tr><tr><td><p>9</p>
</td>
<td><p>Send the data of the system clipboard to its C2 server.</p>
</td>
</tr><tr><td><p>10</p>
</td>
<td><p>Set given data to system clipboard.</p>
</td>
</tr><tr><td><p>11</p>
</td>
<td><p>Start a Chrome browser with specified parameters.</p>
</td>
</tr><tr><td><p>12</p>
</td>
<td><p>Start Mozilla Firefox with specified parameters.</p>
</td>
</tr><tr><td><p>13</p>
</td>
<td><p>Show the StartMenu.</p>
</td>
</tr><tr><td><p>14</p>
</td>
<td><p>Minimize Pandora HVNC Rat.</p>
</td>
</tr><tr><td><p>15</p>
</td>
<td><p>Show Pandora HVNC Rat to the victim.</p>
</td>
</tr><tr><td><p>16</p>
</td>
<td><p>Show a pop-up message to the victim.</p>
</td>
</tr><tr><td><p>17</p>
</td>
<td><p>Set screenshot interval.</p>
</td>
</tr><tr><td><p>18</p>
</td>
<td><p>Set screenshot quality.</p>
</td>
</tr><tr><td><p>19</p>
</td>
<td><p>Set screenshot size.</p>
</td>
</tr><tr><td><p>21</p>
</td>
<td><p>Start Explorer program.</p>
</td>
</tr><tr><td><p>24</p>
</td>
<td><p>Kill the current process.</p>
</td>
</tr><tr><td><p>30</p>
</td>
<td><p>Start Microsoft Edge browser with specified parameters</p>
</td>
</tr><tr><td><p>32</p>
</td>
<td><p>Start Brave browser with specified parameters</p>
</td>
</tr><tr><td><p>50</p>
</td>
<td><p>Call KillMiner() to kill a process.</p>
</td>
</tr><tr><td><p>55</p>
</td>
<td><p>Download a file into %temp% folder as a Miner. </p>
</td>
</tr><tr><td><p>56</p>
</td>
<td><p>Download a file and execute.</p>
</td>
</tr><tr><td><p>444</p>
</td>
<td><p>Start an Opera browser with specified parameters.</p>
</td>
</tr><tr><td><p>555</p>
</td>
<td><p>Restart Outlook.</p>
</td>
</tr><tr><td><p>556</p>
</td>
<td><p>Restart FoxMail.</p>
</td>
</tr><tr><td><p>557</p>
</td>
<td><p>Restart Thunderbird.</p>
</td>
</tr><tr><td><p>666</p>
</td>
<td><p>Kill current Pandora HVNC Rat.</p>
</td>
</tr><tr><td><p>1337</p>
</td>
<td><p>Send Pong packet.</p>
</td>
</tr><tr><td><p>3306</p>
</td>
<td><p>Push data to override the system clipboard.</p>
</td>
</tr><tr><td><p>3307</p>
</td>
<td><p>Obtain the data from the system clipboard.</p>
</td>
</tr><tr><td><p>3308</p>
</td>
<td><p>Obtain credentials and cookies from the victim’s browsers.</p>
</td>
</tr><tr><td><p>4875</p>
</td>
<td><p>Start a CMD program.</p>
</td>
</tr><tr><td><p>4876</p>
</td>
<td><p>Start a PowerShell program.</p>
</td>
</tr><tr><td><p>8585</p>
</td>
<td><p>Start a Chrome browser with a default URL.</p>
</td>
</tr><tr><td><p>8586</p>
</td>
<td><p>Kill all Chrome browsers.</p>
</td>
</tr><tr><td><p>8587</p>
</td>
<td><p>Reset Scale.</p>
</td>
</tr><tr><td><p>8589</p>
</td>
<td><p>Same as 56. Download a file and execute.</p>
</td>
</tr></tbody></table>
<p>Table 2.1 - List of control commands of PandoraHVNC RAT</p>
<h2>Fileless Malware 3 – BitRAT</h2>
<p>The third fileless malware injected into “aspnet_compiler.exe” is “BitRat”, which is said to be a high quality and efficient RAT. It provides information collection like clipboard logger, keylogger, application credentials, Webcam logging, and Voice Recording. It has wide control commands for controlling the victim’s device, including downloading and executing a file, performing remote desktop control, controlling processes and services, reverse socks, and more.</p>
<h3>Stage One:</h3>
<p>BitRat has a configuration block encrypted similar to the Ave Maria Rat. Figure 3.1 shows the just decrypted configuration block in memory, where it contains C2 server (“maraipasoo[.]duckdns[.]org”) &amp; port (890), client ID (“f2b8b66873ca913a”), and more.</p>
<img alt="Figure 3.1 – Decrypted configuration block" class="loading" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" style="max-width:80%;height:auto;width:auto;"/>
Figure 3.1 – Decrypted configuration block
<p>It proceeds to connect to the C2 server. It then uses TLS 1.2 protocol plus a cipher suite of RAS+AES 256 to transfer and encrypt its packet. Figure 3.2 shows the model that it uses to encode the plain text data with Base64 and encrypt with AES-256. And finally, it sends the encrypted data to the C2 server over TLS 1.2 protocol.</p>
<img alt="Figure 3.2 – The outline of how a packet is transformed and sent to the C2 server" class="loading" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" style="max-width:80%;height:auto;width:auto;"/>
Figure 3.2 – The outline of how a packet is transformed and sent to the C2 server
<p>I’ll take a moment here to explain what the plaintext packet looks like. Figure 3.3, below, is a screenshot of the debugger when BitRat was about to Base64-encode the plaintext packet with the basic information of the victim’s device.</p>
<img alt="Figure 3.3 – Basic information packet before Base64 encoding" class="loading" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" style="max-width:80%;height:auto;width:auto;"/>
Figure 3.3 – Basic information packet before Base64 encoding
<p>The packet consists of many parts separated by “|”, including a client ID (“f2b8b66873ca913a”), user name, computer name, CPU information, GPU card, system name (“Win 7”), system’s uptime, system idle time, RAM amount, IP address, whether or not the login user is an administrator, BitRat client version (“1.38”), and so on. Next, the packet goes through Base64-encoding and AES-256 encryption, which is eventually sent to the C2 server.</p>
<p>Once the C2 server receives this packet, the victim’s device shows up in its control interface, where the hacker is able to control the infected device.</p>
<h3>Stage Two:</h3>
<p>BitRat is more powerful than AveMariaRAT and PandoraHVNC because it provides a great number of control commands (172 commands) to control the victim’s device. </p>
<p>Figure 3.4 shows the dashboard to a connected victim on the C2 server side. On the left is the basic information of the victim’s device, while there are some features listed on the right. </p>
<img alt="Figure 3.4 – Dashboard and features that BitRat supports" class="loading" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" style="max-width:80%;height:auto;width:auto;"/>
Figure 3.4 – Dashboard and features that BitRat supports
<p>Other than the features from the dashboard, it also supports the following features from the main context menu:</p>
<ul>
<li>Chat</li>
<li>Clear browsers</li>
<li>Clipboard management</li>
<li>DLL injection</li>
<li>Change desktop background</li>
<li>Open website</li>
<li>Notes</li>
<li>UAC bypass</li>
<li>Kill Windows Defender</li>
<li>Show preview of screen or webcam</li>
<li>Keylog download &amp; search</li>
<li>Reverse socks</li>
<li>System management (reboot, shutdown, sleep, etc.)</li>
<li>BitRat client’s update and uninstall</li>
<li>DDoS attack (plugin)</li>
<li>Mining (plugin)</li>
<li>Telegram bot (plugin)</li>
<li>Passwords Logins (plugin)</li>
<li>And more</li>
</ul>
<h3>Stage Three:</h3>
<p>While BitRat receives the control command packet, it only needs a AES-256 decryption to restore the plaintext packet. I will explain the structure of a plaintext command packet using the following example:</p>
<p>"ddos_start|MTkyLjE2OC4yMi4xNQ==|3333|1|tcp|tcp|1|0|L3NpdGUucGhwP3g9dmFsMSZ5PXZhbDI="</p>
<p>Every command packet starts with a command name string and subsequent parameters, which are separated by “|”.</p>
<p>The above example command asks the infected device to start a DDoS attack, where “ddos_start” is the command name, “MTkyLjE2OC4yMi4xNQ==” is the Base64-encoded target IP, “3333” is the target port, flood method is “tcp”, protocol is “tcp”, thread number is “1”, size is “0”, and the last field is the data.</p>
<p>On the very first time, BitRat initializes a linked list with nodes containing a command name and a command number (like “ddos_start” for 85H) as well as some flags. BitRat has a method to go through these nodes looking for a node that matches the command name from the packet by string comparison. The command name starts at offset +10H of the node and the corresponding command number is saved in a dword at offset +28H. Below is a dumped node of “ddos_start”.
</p>
<p>Offset+00 A0 2E 30 00 00 71 3E 00 A0 2E 30 00 00 00 00 00 .0..q&gt;. .0.....</p>
<p>Offset+10 64 64 6F 73 5F 73 74 61 72 74 00 00 00 00 00 00 ddos_start......</p>
<p>Offset+20 0A 00 00 00 0F 00 00 00 85 00 00 00 .......…...</p>
<p>BitRat performs the action according to the command number. Table 3.1 lists the most control commands, with brief command descriptions that BitRat supports.</p>
<table cellspacing="0" class="MsoTableGrid">
<tbody><tr><td><p>Cmd Name</p>
</td>
<td><p>Num</p>
</td>
<td><p>Description</p>
</td>
</tr><tr><td><p>"cli_up"</p>
</td>
<td><p>00H</p>
</td>
<td><p>Update BitRat client.</p>
</td>
</tr><tr><td><p>"rc"</p>
</td>
<td><p>01H</p>
</td>
<td><p>Reconnect to the C2 server.</p>
</td>
</tr><tr><td><p>"cli_dc"</p>
</td>
<td><p>02H</p>
</td>
<td><p>Disconnect to the C2 server.</p>
</td>
</tr><tr><td><p>"cli_un"</p>
</td>
<td><p>03H</p>
</td>
<td><p>Uninstall BitRat client from the victim's device.</p>
</td>
</tr><tr><td><p>"cli_sleep"</p>
</td>
<td><p>04H</p>
</td>
<td><p>Put the victim's system into sleep.</p>
</td>
</tr><tr><td><p>"cli_hib"</p>
</td>
<td><p>05H</p>
</td>
<td><p>Put the victim's system into hibernation.</p>
</td>
</tr><tr><td><p>"cli_log"</p>
</td>
<td><p>06H</p>
</td>
<td><p>Have the victim's system to log out the current user.</p>
</td>
</tr><tr><td><p>"cli_rs"</p>
</td>
<td><p>07H</p>
</td>
<td><p>Restart the victim's device.</p>
</td>
</tr><tr><td><p>"cli_off"</p>
</td>
<td><p>08H</p>
</td>
<td><p>Shutdown the victim's device.</p>
</td>
</tr><tr><td><p>"cli_bsod"</p>
</td>
<td><p>09H</p>
</td>
<td><p>Make the victim's system crash with a blue screen.</p>
</td>
</tr><tr><td><p>"info"</p>
</td>
<td><p>0AH</p>
</td>
<td><p>Request for the basic information of the victim's device.</p>
</td>
</tr><tr><td><p>"drives_get"</p>
</td>
<td><p>0BH</p>
</td>
<td><p>List drivers, like "C:\", "D:\" and etc.</p>
</td>
</tr><tr><td><p>"files_exec"</p>
</td>
<td><p>0CH</p>
</td>
<td><p>Execute a file on the victim's disk with given parameters.</p>
</td>
</tr><tr><td><p>"files_delete_normal"</p>
</td>
<td><p>0FH</p>
</td>
<td><p>Delete a specified file.</p>
</td>
</tr><tr><td><p>"files_delete_secure"</p>
</td>
<td><p>10H</p>
</td>
<td><p>Delete a specified file with a security way.</p>
</td>
</tr><tr><td><p>"files_rename"</p>
</td>
<td><p>11H</p>
</td>
<td><p>Rename a file.</p>
</td>
</tr><tr><td><p>"files_new_dir"</p>
</td>
<td><p>12H</p>
</td>
<td><p>Create a folder.</p>
</td>
</tr><tr><td><p>"files_zip"</p>
</td>
<td><p>13H</p>
</td>
<td><p>Make a zip archive of a file.</p>
</td>
</tr><tr><td><p>"files_zip_dir"</p>
</td>
<td><p>14H</p>
</td>
<td><p>Make a zip archive of a folder.</p>
</td>
</tr><tr><td><p>"files_get"</p>
</td>
<td><p>15H</p>
</td>
<td><p>List files under a specified path.</p>
</td>
</tr><tr><td><p>"files_search"</p>
</td>
<td><p>16H</p>
</td>
<td><p>Search files by filter string.</p>
</td>
</tr><tr><td><p>"files_search_stop"</p>
</td>
<td><p>17H</p>
</td>
<td><p>Stop file searching.</p>
</td>
</tr><tr><td><p>"files_download"</p>
</td>
<td><p>18H</p>
</td>
<td><p>Transfer a file from the victim's device to the C2 server.</p>
</td>
</tr><tr><td><p>"files_upload"</p>
</td>
<td><p>1AH</p>
</td>
<td><p>Transfer a file from the C2 server onto the victim's device.</p>
</td>
</tr><tr><td><p>"prc_list"</p>
</td>
<td><p>1DH</p>
</td>
<td><p>List running processes.</p>
</td>
</tr><tr><td><p>"prc_suspend"</p>
</td>
<td><p>1EH</p>
</td>
<td><p>Suspend a process with its PID.</p>
</td>
</tr><tr><td><p>"prc_resume"</p>
</td>
<td><p>1FH</p>
</td>
<td><p>Resume a suspended process with its PID.</p>
</td>
</tr><tr><td><p>"prc_priority"</p>
</td>
<td><p>20H</p>
</td>
<td><p>Set a process's priority with a given PID.</p>
</td>
</tr><tr><td><p>"prc_kill"</p>
</td>
<td><p>21H</p>
</td>
<td><p>Kill a process with its PID.</p>
</td>
</tr><tr><td><p>"prc_restart"</p>
</td>
<td><p>22H</p>
</td>
<td><p>Restart a process.</p>
</td>
</tr><tr><td><p>"srv_list"</p>
</td>
<td><p>23H</p>
</td>
<td><p>List system services on the victim's device.</p>
</td>
</tr><tr><td><p>"srv_start"</p>
</td>
<td><p>24H</p>
</td>
<td><p>Start a service.</p>
</td>
</tr><tr><td><p>"srv_control"</p>
</td>
<td><p>25H</p>
</td>
<td><p>Pause, stop, continue a service.</p>
</td>
</tr><tr><td><p>"wnd_list"</p>
</td>
<td><p>27H</p>
</td>
<td><p>List all windows being opened on the victim's device.</p>
</td>
</tr><tr><td><p>"wnd_cmd"</p>
</td>
<td><p>28H</p>
</td>
<td><p>Control a window. such as hide, show, maximize, minimize, etc.</p>
</td>
</tr><tr><td><p>"dlexec"</p>
</td>
<td><p>2AH</p>
</td>
<td><p>Download and execute an executable file.</p>
</td>
</tr><tr><td><p>"screenlive"</p>
</td>
<td><p>2CH</p>
</td>
<td><p>Start screen capture.</p>
</td>
</tr><tr><td><p>"screenlive_stop"</p>
</td>
<td><p>2DH</p>
</td>
<td><p>Stop screen capture.</p>
</td>
</tr><tr><td><p>"screenlive_monitor"</p>
</td>
<td><p>2EH</p>
</td>
<td><p>Start screenlive monitor.</p>
</td>
</tr><tr><td><p>"screenlive_size"</p>
</td>
<td><p>2FH</p>
</td>
<td><p>Set screenlive size.</p>
</td>
</tr><tr><td><p>"screenlive_quality"</p>
</td>
<td><p>30H</p>
</td>
<td><p>Set screenlive quality"</p>
</td>
</tr><tr><td><p>"screenlive_cursor"</p>
</td>
<td><p>31H</p>
</td>
<td><p>Set screenlive cursor to show or hide.</p>
</td>
</tr><tr><td><p>"screenlive_color"</p>
</td>
<td><p>32H</p>
</td>
<td><p>Set screenlive color to gray or color.</p>
</td>
</tr><tr><td><p>"screenlive_click"</p>
</td>
<td><p>35H</p>
</td>
<td><p>Simulate to perform mouse click on screenlive windows.</p>
</td>
</tr><tr><td><p>"screenlive_move"</p>
</td>
<td><p>36h</p>
</td>
<td><p>Move screenlive to a given position.</p>
</td>
</tr><tr><td><p>"screen_preview_start"</p>
</td>
<td><p>38H</p>
</td>
<td><p>Start screen preview.</p>
</td>
</tr><tr><td><p>"screen_preview_stop"</p>
</td>
<td><p>39H</p>
</td>
<td><p>Stop screen preview.</p>
</td>
</tr><tr><td><p>"monitors_refresh"</p>
</td>
<td><p>3BH</p>
</td>
<td><p>Refresh monitors.</p>
</td>
</tr><tr><td><p>"webcam_devices"</p>
</td>
<td><p>3CH</p>
</td>
<td><p>List webcam interfaces.</p>
</td>
</tr><tr><td><p>"webcam_quality"</p>
</td>
<td><p>3DH</p>
</td>
<td><p>Set webcam quality.</p>
</td>
</tr><tr><td><p>"webcam_start"</p>
</td>
<td><p>3EH</p>
</td>
<td><p>Start webcam capture.</p>
</td>
</tr><tr><td><p>"webcam_stop"</p>
</td>
<td><p>3FH</p>
</td>
<td><p>Stop webcam.</p>
</td>
</tr><tr><td><p>"klgoff_list"</p>
</td>
<td><p>43H</p>
</td>
<td><p>List offline keylogger files.</p>
</td>
</tr><tr><td><p>"klgoff_get"</p>
</td>
<td><p>44H</p>
</td>
<td><p>Transfer an offline keylogger file.</p>
</td>
</tr><tr><td><p>"klgoff_dl_all"</p>
</td>
<td><p>45H</p>
</td>
<td><p>Transfer all keylogger files.</p>
</td>
</tr><tr><td><p>"klgoff_del"</p>
</td>
<td><p>46H</p>
</td>
<td><p>Delete an offline keylogger file.</p>
</td>
</tr><tr><td><p>"klgonlinestart"</p>
</td>
<td><p>48H</p>
</td>
<td><p>Start the online keylogger.</p>
</td>
</tr><tr><td><p>"klgonlinestop"</p>
</td>
<td><p>49H</p>
</td>
<td><p>Stop the online keylogger.</p>
</td>
</tr><tr><td><p>"klg_search"</p>
</td>
<td><p>4AH</p>
</td>
<td><p>Search keywords in keylogger data.</p>
</td>
</tr><tr><td><p>"aud_rec_list"</p>
</td>
<td><p>4DH</p>
</td>
<td><p>List audio devices.</p>
</td>
</tr><tr><td><p>"shell_start"</p>
</td>
<td><p>4EH</p>
</td>
<td><p>Start a remote shell on the victim's device.</p>
</td>
</tr><tr><td><p>"shell_stop"</p>
</td>
<td><p>4FH</p>
</td>
<td><p>Stop the remote shell.</p>
</td>
</tr><tr><td><p>"shell_exec"</p>
</td>
<td><p>50H</p>
</td>
<td><p>Exeucte a command trhough the remote shell.</p>
</td>
</tr><tr><td><p>"con_list"</p>
</td>
<td><p>51H</p>
</td>
<td><p>List all processes with network connections.</p>
</td>
</tr><tr><td><p>"crd_logins_data"</p>
</td>
<td><p>64H</p>
</td>
<td><p>Collect the credentials from apps on the victim's device.</p>
</td>
</tr><tr><td><p>"crd_logins_req"</p>
</td>
<td><p>65H</p>
</td>
<td><p>Transfer the collected credentials.</p>
</td>
</tr><tr><td><p>"remotebrowser"</p>
</td>
<td><p>6DH</p>
</td>
<td><p>Remotely start the victim's default browser invisible.</p>
</td>
</tr><tr><td><p>"remotebrowser_stop"</p>
</td>
<td><p>6EH</p>
</td>
<td><p>Stop the remote browsers.</p>
</td>
</tr><tr><td><p>"remotebrowser_key"</p>
</td>
<td><p>6FH</p>
</td>
<td><p>Press a keyboard key on the remote browser.</p>
</td>
</tr><tr><td><p>"remotebrowser_click"</p>
</td>
<td><p>70H</p>
</td>
<td><p>Click on the remote browser.</p>
</td>
</tr><tr><td><p>"remotebrowser_quality"</p>
</td>
<td><p>72H</p>
</td>
<td><p>Set the remote browser quality.</p>
</td>
</tr><tr><td><p>"settings"</p>
</td>
<td><p>78H</p>
</td>
<td><p>Configure the BitRat client.</p>
</td>
</tr><tr><td><p>"soft_list"</p>
</td>
<td><p>79H</p>
</td>
<td><p>List the installed software on the victim's device.</p>
</td>
</tr><tr><td><p>"soft_uninstall"</p>
</td>
<td><p>7AH</p>
</td>
<td><p>Uninstall software from the victim's device.</p>
</td>
</tr><tr><td><p>"reg_hkeys_get"</p>
</td>
<td><p>7EH</p>
</td>
<td><p>Obtain a list of HKEYs (Handles to the Keys) of the victim's system registry.</p>
</td>
</tr><tr><td><p>"reg_keys_root_get"</p>
</td>
<td><p>7FH</p>
</td>
<td><p>List the root keys under a HKEY of the system registry.</p>
</td>
</tr><tr><td><p>"reg_keys_get"</p>
</td>
<td><p>80H</p>
</td>
<td><p>Navigate a sub-key of the system registry.</p>
</td>
</tr><tr><td><p>"reg_val_edit"</p>
</td>
<td><p>81H</p>
</td>
<td><p>Add a value into the system registry.</p>
</td>
</tr><tr><td><p>"reg_val_del"</p>
</td>
<td><p>82H</p>
</td>
<td><p>Delete a value from the system registry.</p>
</td>
</tr><tr><td><p>"reg_key_add"</p>
</td>
<td><p>83H</p>
</td>
<td><p>Add a sub-key into the system registry.</p>
</td>
</tr><tr><td><p>"reg_key_del"</p>
</td>
<td><p>84H</p>
</td>
<td><p>Delete a sub-key from the system registry.</p>
</td>
</tr><tr><td><p>"ddos_start"</p>
</td>
<td><p>85H</p>
</td>
<td><p>Start a DDOS attack from the victim's device.</p>
</td>
</tr><tr><td><p>"ddos_stop"</p>
</td>
<td><p>86H</p>
</td>
<td><p>Stop the DDOS attack.</p>
</td>
</tr><tr><td><p>"bypass"</p>
</td>
<td><p>87H</p>
</td>
<td><p>Attempt the UAC bypass using exploit.</p>
</td>
</tr><tr><td><p>"prc_protect"</p>
</td>
<td><p>88H</p>
</td>
<td><p>Protect a process.</p>
</td>
</tr><tr><td><p>"wd_kill"</p>
</td>
<td><p>89H</p>
</td>
<td><p>Kill the Windows defender service.</p>
</td>
</tr><tr><td><p>"autoruns_req"</p>
</td>
<td><p>92H</p>
</td>
<td><p>Collect a list of auto run progress from the system registry.</p>
</td>
</tr><tr><td><p>"autoruns_data"</p>
</td>
<td><p>93H</p>
</td>
<td><p>Request the auto run data.</p>
</td>
</tr><tr><td><p>"autoruns_del"</p>
</td>
<td><p>94H</p>
</td>
<td><p>Delete an auto-run item.</p>
</td>
</tr><tr><td><p>"s_list"</p>
</td>
<td><p>95H</p>
</td>
<td><p>List the tasks from the system Task Scheduler of the infected system.</p>
</td>
</tr><tr><td><p>"task_del"</p>
</td>
<td><p>96H</p>
</td>
<td><p>Delete a task from the system Task Scheduler.</p>
</td>
</tr><tr><td><p>"spread"</p>
</td>
<td><p>97H</p>
</td>
<td><p>Spread usb.</p>
</td>
</tr><tr><td><p>"bg_change"</p>
</td>
<td><p>98H</p>
</td>
<td><p>Change the desktop background of the victim's desktop.</p>
</td>
</tr><tr><td><p>"scr_off"</p>
</td>
<td><p>99H</p>
</td>
<td><p>Turn off screen.</p>
</td>
</tr><tr><td><p>"browsers_clear"</p>
</td>
<td><p>9BH</p>
</td>
<td><p>Close the browsers such as Chrome, Firefox, Edge, Opera, IE, Vivaldi, Brave, Chromium, Torch, UCBrowser and clean its data.</p>
</td>
</tr><tr><td><p>"notes_get"</p>
</td>
<td><p>9CH</p>
</td>
<td><p>Obtain notes that were set to the victim’s device.</p>
</td>
</tr><tr><td><p>"notes_set"</p>
</td>
<td><p>9DH</p>
</td>
<td><p>Set notes to the victim device.</p>
</td>
</tr><tr><td><p>"website_open"</p>
</td>
<td><p>9FH</p>
</td>
<td><p>Open a website with the default web browser on the victim's device.</p>
</td>
</tr><tr><td><p>"vol_edit"</p>
</td>
<td><p>A0H</p>
</td>
<td><p>Change master volume.</p>
</td>
</tr><tr><td><p>"msgbox"</p>
</td>
<td><p>A3H</p>
</td>
<td><p>Display the victim a message box with a message.</p>
</td>
</tr><tr><td><p>"clipboard_get"</p>
</td>
<td><p>A2H</p>
</td>
<td><p>Obtain the system clipboard data from the victim's system.</p>
</td>
</tr><tr><td><p>"injdll"</p>
</td>
<td><p>A4H</p>
</td>
<td><p>Inject a dll into a specified process or all processes.</p>
</td>
</tr><tr><td><p>"chat_start"</p>
</td>
<td><p>A9H</p>
</td>
<td><p>Pop up a chatting box to the victim.</p>
</td>
</tr><tr><td><p>"chat_msg"</p>
</td>
<td><p>AAH</p>
</td>
<td><p>Chat with the victim using the chatting box.</p>
</td>
</tr><tr><td><p>"chat_stop"</p>
</td>
<td><p>ABH</p>
</td>
<td><p>Stop chatting.</p>
</td>
</tr></tbody></table>
<p>Table 3.1 – The most control commands of BitRat</p>
<h2>Conclusion</h2>
<p>In this second part the series, I examined the three fileless malware payloads included in the phishing campaign. I also explained what processes they inject into and execute.</p>
<p>Next, I introduced how these three malware connect to their C2 server and described the structure of the packets sending to the C2 server. I also presented the values in the control command packets sent to the malware clients to control the victim’s device to perform further malicious tasks.</p>
<p>I elaborated the features that the three malware provide and used several examples to prove how the attacker uses them. From my research, you also learned the differences between their features.</p>
<p>I also made three tables to list the control commands with brief descriptions.</p>
<h2>Fortinet Protections</h2>
<p>Fortinet customers are already protected from this malware by FortiGuard’s Web Filtering, AntiVirus, FortiMail, FortiClient, FortiEDR services and CDR (content disarm and reconstruction) feature, as follows:</p>
<p>All relevant URLs have been rated as "Malicious Websites" by the FortiGuard Web Filtering service.</p>
<p>The phishing email attached Excel document can be disarmed by the FortiGuard CDR (content disarm and reconstruction) feature.</p>
<p>The captured Excel sample at the beginning and the downloaded html file as well as the Powershell file with three fileless malware payload files are detected as "VBA/Agent.DDON!tr", "JS/Agent.DDON!tr.dldr" and "PowerShell/Agent.e535!tr" and are blocked by the FortiGuard Antivirus service.</p>
<p>FortiEDR detects both the Excel file and the huge Powershell file as malicious based on its behavior.</p>
<p>In addition to these protections, we suggest that organizations have their end users also go through the FREE <a href="https://training.fortinet.com/?utm_source=blog&amp;utm_campaign=nse-institute">NSE training</a>: <a href="https://training.fortinet.com/local/staticpage/view.php?page=nse_1&amp;utm_source=blog&amp;utm_campaign=nse-1">NSE 1 – Information Security Awareness</a>. It includes a module on Internet threats that is designed to help end users learn how to identify and protect themselves from phishing attacks.</p>
<h2>IOCs</h2>
<h3>URLs:</h3>
<p>vncgoga[.]duckdns[.]org:1338
mubbibun[.]duckdns[.]org:999
danseeeee[.]duckdns[.]org:2022
maraipasoo[.]duckdns[.]org:890
</p>
<p>Visit part one of this series <a href="https://www.fortinet.com/blog/threat-research/phishing-campaign-delivering-fileless-malware">here</a>. </p>
<p>Learn more about Fortinet’s <a href="https://www.fortinet.com/fortiguard/labs?utm_source=blog&amp;utm_campaign=fortiguard-labs">FortiGuard Labs</a> threat research and intelligence organization and the FortiGuard Security Subscriptions and Services <a href="https://www.fortinet.com/fortiguard/labs?tab=security-bundles&amp;utm_source=blog&amp;utm_campaign=security-bundles">portfolio</a>.</p>
</div>