<div>
<p>Dealing with a great amount of data can be time consuming, thus using Python can be very powerful to help analysts sort information and extract the most relevant data for their investigation. The open-source tools library, <a href="https://github.com/microsoft/msticpy">MSTICPy</a>, for example, is a Python tool dedicated to threat intelligence. It aims to help threat analysts acquire, enrich, analyze, and visualize data.</p>
<p>This blog provides a workflow for deeper data analysis and visualization using Python, as well as for extraction and analysis of indicators of compromise (IOCs) using MSTICPy. Data sets from the February 2022 leak of data from the <a href="https://www.microsoft.com/security/blog/2022/05/09/ransomware-as-a-service-understanding-the-cybercrime-gig-economy-and-how-to-protect-yourself/">ransomware-as-a-service (RaaS)</a> coordinated operation called “Conti” is used as case study.</p>
<ul><li><a href="#python">Using Python to analyze the Conti network</a></li><li><a href="#msticpy">Using MSTICPy to extract and analyze IOCs</a></li></ul>
<p>An <a href="https://github.com/microsoft/msticpy/blob/main/docs/notebooks/ContiLeaksAnalysis.ipynb" rel="noreferrer noopener" target="_blank">interactive Jupyter notebook</a> with related data is also available for analysts interested to do further data exploration.</p>
<p>This research aims to provide a view into research methodology that may help other analysts apply Python to threat intelligence. Analysts can reuse the code and continue to explore the extracted information. Additionally, it offers an out-of-the-box methodology for analyzing chat logs, extracting IOCs, and improving threat intelligence and defense process using Python.</p>
<h2 id="python">Using Python to analyze the Conti network</h2>
<p>On February 28, 2022, a Twitter account named @ContiLeaks (allegedly a Ukrainian researcher) began posting leaked Conti data on Twitter. The leaked data sets, which were posted in a span of several months, consisted of chat logs, source codes, and backend applications.</p>
<p>For this research, we focused our analysis on the chat logs, which revealed crucial information about the Conti group’s operating methods, infrastructure, and organizational structure.</p>
<h3>Compiling and translating chat logs</h3>
<p>The leaked chat logs are written in the Russian language. To make the analysis more accessible, we adopted the methodology <a href="https://medium.com/@arnozobec/analyzing-conti-leaks-without-speaking-russian-only-methodology-f5aecc594d1b">published here</a> and translated the logs to English.</p>
<p>The chat logs revealed that the Conti group uses the messaging application Jabber to communicate among members. Since raw Jabber logs are saved using a file per day, they can be compiled in one JSON file so they can easily be manipulated with Python. Once the data is merged, they can be translated using the deep translator library. After the logs are translated and loaded into a new file, it’s then possible to load the data into a dataframe for manipulation and exploration:</p>
df = pd.read_json(codecs.open('translated_Log2.json', 'r', 'utf-8'))
<figure class="wp-block-image size-full"><img alt="A screenshot of a table of chat messages translated from Russian to English. The table includes details when the message was sent, who it was from, to whom it was sent, the original text in Russian, and the translated English version." class="wp-image-115356" height="265" src="https://www.microsoft.com/security/blog/uploads/securityprod/2022/05/fig-1-translated-logs.png" style="max-width:800px;height:auto;width:auto;" width="800"/><figcaption>Figure 1. Translated logs</figcaption></figure>
<p>Russian slang words not properly translated by the automated process can be translated by creating a dictionary. A dictionary off a list proposed <a href="https://twitter.com/seadev3/status/1498783071969099777?s=20&amp;t=Z2KJgYrjiUMCQ5Phif3ZbA">here</a> was used in this case to correctly translate the slang:</p>
<figure class="wp-block-image size-full"><img alt="A screenshot of Python code that creates a dictionary which can be used to translate Russian slang words. It features a list of Russian slang words and their English translation." class="wp-image-115494" height="320" src="https://www.microsoft.com/security/blog/uploads/securityprod/2022/06/fig-2-translating-slang.png" style="max-width:800px;height:auto;width:auto;" width="800"/><figcaption>Figure 2. Translating slang</figcaption></figure>
<h3>Analyzing the chat activity timeline</h3>
<p>One way to get insights from chat logs is to see its timeline and check the number of discussions per day. The <a href="https://bokeh.org/">Bokeh</a> library can be used to build an interactive diagram and explore the loaded dataframe.</p>
<figure class="wp-block-image size-full"><img alt="A screenshot of Python code for exploring data using the Bokeh library. It shows code for filtering results, creating diagrams, and adding hover tools." class="wp-image-115362" height="731" src="https://www.microsoft.com/security/blog/uploads/securityprod/2022/05/fig-3-python-code-for-exploring-discussions.png" style="max-width:800px;height:auto;width:auto;" width="662"/><figcaption>Figure 3. Python code for exploring discussions</figcaption></figure>
<p>Using the data from Conti chat logs generates the following diagram, which shows the volume of Jabber discussions over time:</p>
<figure class="wp-block-image size-full"><img alt="A line graph that shows a volume of discussions within the Conti group from March 2021 to March 2022. The data shows several peaks in activity, mostly concentrated from September to December 2021." class="wp-image-115365" height="437" src="https://www.microsoft.com/security/blog/uploads/securityprod/2022/05/fig-4-volume-of-discussions-over-time.png" style="max-width:800px;height:auto;width:auto;" width="800"/><figcaption>Figure 4. Volume of discussions over time</figcaption></figure>
<p>Visualizing the data as a timeline shows some peaks of activity that align to certain events. In the case of the Conti leaks, for example:</p>
<ul><li>July 7, 2021 (615 discussions): Ransomware attack by REvil against software company Kaseya</li><li>August 27, 2021 (1,289 discussions): The playbook of a specific Conti affiliate was leaked</li><li>August 32, 2021 (1,156 discussions): FBI CISA advisory on <a href="https://www.cisa.gov/uscert/ncas/current-activity/2021/08/31/fbi-cisa-advisory-ransomware-awareness-holidays-and-weekends">ransomware and labor day</a></li><li>August 10, 2021 (853 discussions): Ransomware attack by <a href="https://www.bleepingcomputer.com/news/security/cookware-giant-meyer-discloses-cyberattack-that-impacted-employees/">Conti against Meyer Corporation</a></li></ul>
<p>It’s interesting that no peak in chat activity was observed within the Conti group after the first leak, which could indicate that the breach was ignored or not known by the group at that time.</p>
<h3>Analyzing the level of user activity</h3>
<p>When analyzing chat logs, identifying the number of users and analyzing the most active ones can provide insight into the size of the group and roles of users within it. Using Python, the list of users can be extracted and saved in a text file:</p>
<figure class="wp-block-image size-full"><img alt="A screenshot of Python code that extracts the list of users from the Conti chat logs. It also shows code to remove duplicates from the list, concatenate the dataframe, and save the list to a text file. " class="wp-image-115368" height="228" src="https://www.microsoft.com/security/blog/uploads/securityprod/2022/05/fig-5-extracting-list-of-users.png" style="max-width:800px;height:auto;width:auto;" width="660"/><figcaption>Figure 5. Extracting list of users</figcaption></figure>
<p>Running the script above using the Conti chat logs yielded a list of 346 unique accounts. This list can then be used to create a graph and show which users sent the most messages.</p>
<figure class="wp-block-image size-full"><img alt="A screenshot of Python code that creates a graph to show the list of users from the Conti chat logs with the most messages." class="wp-image-115371" height="60" src="https://www.microsoft.com/security/blog/uploads/securityprod/2022/05/fig-6-creating-a-graph-for-users-with-most-messages.png" style="max-width:800px;height:auto;width:auto;" width="661"/><figcaption>Figure 6. Creating a graph for users with most messages</figcaption></figure>
<figure class="wp-block-image size-full"><img alt="A bar chart that compares the users from the Conti chat logs based on the number of messages they sent. The bar shows that the most active user sent as many as more than eight thousand messages. " class="wp-image-115374" height="433" src="https://www.microsoft.com/security/blog/uploads/securityprod/2022/05/fig-7-most-active-users-in-the-Conti-chat-logs.png" style="max-width:800px;height:auto;width:auto;" width="800"/><figcaption>Figure 7. Most active users in the Conti chat logs</figcaption></figure>
<p>Based on the graph, the users named defender, stern, driver, bio, and mango have the largest number of discussions. <a href="https://research.checkpoint.com/2022/leaks-of-conti-ransomware-group-paint-picture-of-a-surprisingly-normal-tech-start-up-sort-of/">Checkpoint</a> published extensive research on the structure of the organization and correlated the user discussions with several roles and services like human resources, coders, crypters, offensive team, SysAdmins, and more.</p>
<h3>Mapping the users’ connections</h3>
<p>Another way to analyze chat log data is to visualize the users’ connection. This can be done by creating a dynamic network graph that can highlight the connections between users. The <a href="https://en.wikipedia.org/wiki/Barnes%E2%80%93Hut_simulation">Barnes Hut algorithm</a> and the Pyvis library can be used to visualize this data.</p>
<figure class="wp-block-image size-full"><img alt="A screenshot of Python code that creates a dynamic network graph of the Conti chat log data using the Barnes Hut algorithm and Pyvis library." class="wp-image-115377" height="788" src="https://www.microsoft.com/security/blog/uploads/securityprod/2022/05/fig-8-creation-of-a-dynamic-graph.png" width="568"/><figcaption>Figure 8. Creation a dynamic graph</figcaption></figure>
<p>Dynamic visualization shows a graphical overview of the network and allows zooming into the network to closely analyze the connections within. Bigger points represent the most active users, and it’s possible to highlight a user to analyze their connections. Additionally, the hovering tool shows which other users a specific user had conversations with.</p>
<figure class="wp-block-image size-full"><img alt="A screenshot of a dynamic visualization showing a graphical overview of the Conti network. It shows users as points in the graph, all connected by lines that represent conversations between them." class="wp-image-115380" height="621" src="https://www.microsoft.com/security/blog/uploads/securityprod/2022/05/fig-9-Conti-user-network-overview.png" style="max-width:800px;height:auto;width:auto;" width="800"/><figcaption>Figure 9. Conti user network overview</figcaption></figure>
<figure class="wp-block-image size-full"><img alt='A screenshot of a list of connections to the user named "Stern" from the Conti network. The graphical overview of the entire Conti network is shown on the background of the list. ' class="wp-image-115383" height="269" src="https://www.microsoft.com/security/blog/uploads/securityprod/2022/05/fig-10-connections-to-user-Stern.png" style="max-width:800px;height:auto;width:auto;" width="800"/><figcaption>Figure 10. Connections to user ‘Stern’</figcaption></figure>
<h3>Searching for other topics of interest</h3>
<p>Since reading data sets can be time-consuming, a simple search engine can be built to search for specific strings in the chat logs or to filter for topics of interest. For the Conti leak data, examples of these include Bitcoin, usernames, malware names, exploits, and CVEs, to name a few.</p>
<p>The following code snippet provides a simple search engine using the <a href="https://github.com/kootenpv/textsearch">TextSearch library</a>:</p>
<figure class="wp-block-image size-full"><img alt="A screenshot of Python code that creates a search engine using the TextSearch library from Github. The code presents configuration options for the search engine widget and filters for search results." class="wp-image-115386" height="789" src="https://www.microsoft.com/security/blog/uploads/securityprod/2022/05/fig-11-search-engine-using-Python.png" width="532"/><figcaption>Figure 11. Search engine using Python</figcaption></figure>
<h2 id="msticpy">Using MSTICPy to extract and analyze IOCs</h2>
<p>Besides processing chat logs to analyze user activity and connections, Python can also be used to extract and analyze threat intelligence. This section shows how the MSTICPy library can be used to extract IOCs and how it can be used for additional threat hunting and intelligence.</p>
<h3>Extracting IOCs</h3>
<p>MSTICPy is a Python library used for threat investigation and threat hunting. The library can connect to several threat intelligence providers, as well as Microsoft tools like Microsoft Sentinel. It can be used to query logs and to enrich data. It’s particularly convenient for analyzing IOCs and adding more threat contextualization.</p>
<p>After installing MSTICPy, the first thing to do is to initialize the notebook. This allows the loading of several modules that can be used to extract and enrich the data. External resources like VirusTotal or OTX can also be added by configuring msticpyconfig.yaml and adding the API keys. <a></a></p>
<p>The IoCExtract module from MSTICPy offers a convenient way to extract IOCs using predefined regex. The code automatically extracts IOCs such as DNS, URLs, IP addresses, and hashes and then reports them in a new dataframe.</p>
<figure class="wp-block-image size-full"><img alt='A screenshot of Python code that prepares the dataframe for IOC extraction. It presents code to remove "None" value from the dataframe, as well as to initiate the IOC extractor.' class="wp-image-115389" height="168" src="https://www.microsoft.com/security/blog/uploads/securityprod/2022/05/fig-12-Passing-the-dataframe-to-the-module-for-extraction.png" width="598"/><figcaption>Figure 12. Passing the dataframe to the module for extraction</figcaption></figure>
<figure class="wp-block-image size-full"><img alt="A screenshot of a sample table listing down IOC patterns found in the Conti chat logs. It includes the following data fields: IOC type, observable, source index, and input." class="wp-image-115392" height="340" src="https://www.microsoft.com/security/blog/uploads/securityprod/2022/05/fig-13-sample-of-extracted-IOCs.png" style="max-width:800px;height:auto;width:auto;" width="800"/><figcaption>Figure 13. Sample of extracted IOCs</figcaption></figure>
<p>A regex can be added to filter specific IOCs from those extracted by the IOC extraction module by default. For example, the regex below extracts Bitcoin addresses from the Conti chat logs:</p>
<figure class="wp-block-image size-full"><img alt="A screenshot of Python code that adds a regex in the IOCExtract module of MSTICPy. This specific regex extracts Bitcoin addresses from the Conti chat logs." class="wp-image-115395" height="282" src="https://www.microsoft.com/security/blog/uploads/securityprod/2022/05/fig-14-extracting-bitcoin-addresses-and-adding-regex.png" width="598"/><figcaption>Figure 14. Extracting Bitcoin addresses and adding regex</figcaption></figure>
<figure class="wp-block-image size-full"><img alt="A screenshot of a table showing the Bitcoin addresses extracted from the Conti chat logs. The table includes the following data fields: IOCtype, observable, source index, and input." class="wp-image-115398" height="368" src="https://www.microsoft.com/security/blog/uploads/securityprod/2022/05/fig-15-sample-of-extracted-Bitcoin-addresses.png" style="max-width:800px;height:auto;width:auto;" width="800"/><figcaption>Figure 15. Sample of extracted Bitcoin addresses</figcaption></figure>
<p>After extracting IOCs, the dataframe can be cleaned to remove false positives as well as duplicate data. The final dataframe from the processed Conti chat logs contains the following unique IOC count, (these IOCs require additional analysis as not all of them are considered malicious):</p>
<p></p>
<figure class="wp-block-table"><table><tbody><tr><td>URL</td><td>DNS</td><td>IPV4</td><td>Bitcoin</td><td>MD5</td><td>SHA-256</td></tr><tr><td>1,137</td><td>474</td><td>317</td><td>175</td><td>106</td><td>16</td></tr></tbody></table></figure>
<h3>Investigating UP addresses</h3>
<p> The threat intel lookup module TILookup in MSTICPy can be used to get more information on IOCs such as IP addresses. In the case of the Conti leak, 317 unique IP addresses were identified. Not all these IOCs are malicious but can reveal more relevant information.</p>
<p>The configuration file can be specified to <a href="https://msticpy.readthedocs.io/en/latest/data_acquisition/TIProviders.html">load the TILookup module</a>, along with other threat intelligence providers such as VirusTotal, GreyNoise, and OTX.</p>
<figure class="wp-block-image size-full"><img alt="A screenshot of Python code that loads the threat intel lookup module in MSTICPy. It also presents code that loads other threat intelligence providers such as VirusTotal, GreyNoise, and OTX, and filters the IOCs by type." class="wp-image-115401" height="282" src="https://www.microsoft.com/security/blog/uploads/securityprod/2022/05/fig-16-threat-intel-provider-within-msticpy.png" width="598"/><figcaption>Figure 16. Threat intel provider within MSTICPy</figcaption></figure>
<p>Running the module generates a new dataframe with more context for every IP address provided.</p>
<figure class="wp-block-image size-full"><img alt="A screenshot of a table generated from running the threat intel lookup module. The table presents a list of IP addresses extracted from the Conti chat logs with related threat intelligence data." class="wp-image-115404" height="221" src="https://www.microsoft.com/security/blog/uploads/securityprod/2022/05/fig-17-sample-of-ip-addresses-enriched-with-additional-info.png" style="max-width:800px;height:auto;width:auto;" width="800"/><figcaption>Figure 17. Sample of IP addresses enriched with additional info</figcaption></figure>
<p>The module also allows to request information for a single observable.</p>
<figure class="wp-block-image size-full"><img alt="A screenshot of Python code that extracts threat intelligence data on a single observable through the threat intel lookup module of MSTICPy." class="wp-image-115407" height="54" src="https://www.microsoft.com/security/blog/uploads/securityprod/2022/05/fig-18-extracting-information-for-a-single-observable.png" width="598"/><figcaption>Figure 18. Extracting information for a single observable</figcaption></figure>
<figure class="wp-block-image size-full"><img alt="A screenshot of the table generated from running the threat intel lookup module. It shows threat intelligence data from GreyNoise, OTX, and VirusTotal on a particular IP address." class="wp-image-115410" height="170" src="https://www.microsoft.com/security/blog/uploads/securityprod/2022/05/fig-19-additional-threat-context-for-one-ip-address.png" style="max-width:800px;height:auto;width:auto;" width="800"/><figcaption>Figure 19. Additional threat context for one IP address</figcaption></figure>
<p>The browser provided by MSTICPy can also be used to explore the IOCs previously enriched. The <a href="https://github.com/microsoft/msticpy/blob/main/docs/notebooks/ContiLeaksAnalysis.ipynb" rel="noreferrer noopener" target="_blank">interactive Jupyter notebook</a> includes this view of the IOCs.</p>
<figure class="wp-block-image size-full"><img alt="A screenshot of the browser provided by MSTICPy that can be used to explore IOCs extracted from the Conti chat logs. The browser shows threat intelligence details related to a selected IP address." class="wp-image-115413" height="701" src="https://www.microsoft.com/security/blog/uploads/securityprod/2022/05/fig-20-ioc-browser-provided-by-msticpy.png" style="max-width:800px;height:auto;width:auto;" width="800"/><figcaption>Figure 20. IOC browser provided by MSTICPy</figcaption></figure>
<p>In addition, MSTICPy has an embedded <a href="https://msticpy.readthedocs.io/en/latest/data_acquisition/GeoIPLookups.html">module that looks up the geolocation of IP addresses</a> using <a href="https://www.maxmind.com/en/home">Maxmind</a>, which can be used to create a map of the IP addresses previously extracted.</p>
<figure class="wp-block-image size-full"><img alt="A screenshot of Python code that looks up the geolocation of IP addresses. It also presents code that creates a map using the generated geolocation data. " class="wp-image-115416" height="311" src="https://www.microsoft.com/security/blog/uploads/securityprod/2022/05/fig-21-generating-the-ip-geolocation-map.png" style="max-width:800px;height:auto;width:auto;" width="660"/><figcaption>Figure 21. Generating the IP geolocation map</figcaption></figure>
<figure class="wp-block-image size-full"><img alt="A world map with the geolocation of all IPs extracted from the Conti leaks marked with red pins. The image shows that the location of IPs are concentrated in Europe and the US." class="wp-image-115419" height="477" src="https://www.microsoft.com/security/blog/uploads/securityprod/2022/05/fig-22-geolocation-of-ips-extracted-from-the-conti-leaks.png" style="max-width:800px;height:auto;width:auto;" width="800"/><figcaption>Figure 22. Geolocation of IPs extracted from the Conti leaks</figcaption></figure>
<h3>Investigating URLs</h3>
<p>Extracted URLs from IOC lists can provide details about targets, tools used to exchange information, and the infrastructure used to deploy attacks. A total of 1,137 unique URLs were extracted from the Conti leak dataset, but not all of them are usable for threat intelligence. The following code snippet shows how to filter for URLs.</p>
<figure class="wp-block-image size-full"><img alt="A screenshot of Python code that filters for URLs among the IOC list." class="wp-image-115422" height="102" src="https://www.microsoft.com/security/blog/uploads/securityprod/2022/05/fig-23-filtering-the-iocs-for-urls.png" style="max-width:800px;height:auto;width:auto;" width="660"/><figcaption>Figure 23. Filtering the IOCs for URLs</figcaption></figure>
<figure class="wp-block-image size-full"><img alt="A screenshot of the table generated by filtering URLs from the IOC list. The table includes the following data fields: IOC type, observable, source index, and input." class="wp-image-115425" height="306" src="https://www.microsoft.com/security/blog/uploads/securityprod/2022/05/fig-24-sample-of-urls-extracted.png" style="max-width:800px;height:auto;width:auto;" width="800"/><figcaption>Figure 24. Sample of URLs extracted</figcaption></figure>
<p><a></a>A filter can be created to get details on executables, DLLs, ZIP files, and other files related to the extracted URLs. This can provide interesting insights and can be extracted for further research.</p>
<figure class="wp-block-image size-full"><img alt="A screenshot of Python code that filters for specific file types related to extracted URLs. The code searches for URLs with .exe, .dll, .jpg, .zip, .7z, .rar, and .png files." class="wp-image-115428" height="60" src="https://www.microsoft.com/security/blog/uploads/securityprod/2022/05/fig-25-filtering-URLs-for-specific-file-formats.png" style="max-width:800px;height:auto;width:auto;" width="660"/><figcaption>Figure 25. Filtering URLs for specific file formats</figcaption></figure>
<figure class="wp-block-image size-large"><img alt="A screenshot of a table generated from filtering for URLs related to specific file formats. The table features the following data fields: IOC type, observable, source index, and input." class="wp-image-115431" height="423" src="https://www.microsoft.com/security/blog/uploads/securityprod/2022/05/fig-26-sample-of-urls-delivering-extracted-file-1024x423.png" style="max-width:800px;height:auto;width:auto;" width="1024"/><figcaption>Figure 26. Sample of URLs delivering extracted file</figcaption></figure>
<p>Using the same technique for filtering, .onion URLs can also be identified from the URL list. This proved particularly useful in this case, since the Conti group used the Tor network for some of their infrastructure.</p>
<figure class="wp-block-image size-full"><img alt="A screenshot of a table generated by filtering for .onion URLs from the Conti chat log IOCs. The table presents the following data fields: IOC type, observable, source index, and input." class="wp-image-115434" height="381" src="https://www.microsoft.com/security/blog/uploads/securityprod/2022/05/fig-27-sample-of-extracted-onion-urls.png" style="max-width:800px;height:auto;width:auto;" width="800"/><figcaption>Figure 27. Sample of extracted .onion URLs</figcaption></figure>
<h3>Pivoting extracted IOCs using VirusTotal</h3>
<p>The use of the pivot function within the MSTICPy library allows enrichment of data and discovery of additional infrastructure and IOC. This is particularly useful for threat intelligence and threat actor tracking. The next sections demonstrate the use of the VirusTotal module VTlookupV3 in MSTICPy to obtain intelligence about an IP address extracted from the Conti leak dataset that was used to deliver additional malware.</p>
<p>The following code initiates the VTlookupV3 in MSTICPy:</p>
<figure class="wp-block-image size-full"><img alt="A screenshot of Python code that initiates the VirusTotal module in MSTICPy." class="wp-image-115437" height="186" src="https://www.microsoft.com/security/blog/uploads/securityprod/2022/05/fig-28-configuring-the-virustotal-module-in-msticpy.png" style="max-width:800px;height:auto;width:auto;" width="660"/><figcaption>Figure 28. Configuring the VirusTotal module in MSTICPy</figcaption></figure>
<p>The VirusTotal module can be used to get data related to a particular IOC. The code below searches for files downloaded from a particular IP address from the Conti leak dataset:</p>
<figure class="wp-block-image size-full"><img alt="A screenshot of Python code that uses the VirusTotal module in MSTICPy to look up files downloaded from a specific IP address." class="wp-image-115440" height="102" src="https://www.microsoft.com/security/blog/uploads/securityprod/2022/05/fig-29-getting-files-downloaded-from-one-ip-address.png" style="max-width:800px;height:auto;width:auto;" width="660"/><figcaption>Figure 29. Getting files downloaded from one IP address</figcaption></figure>
<p>The results show that the IP address 109[.]230[.]199[.]73 delivers several strains of malware.</p>
<figure class="wp-block-image size-large"><img alt="A screenshot of a table generated from extracting the hashes of files downloaded from a specific IP address." class="wp-image-115443" height="469" src="https://www.microsoft.com/security/blog/uploads/securityprod/2022/05/fig-30-hashes-related-to-ip-109-230-199-73-1024x469.png" style="max-width:800px;height:auto;width:auto;" width="1024"/><figcaption>Figure 30. Hashes related to IP 109[.]230[.]199[.]73</figcaption></figure>
<p>The VirusTotal module can then be used to pivot and extract more information about these hashes. The table below shows information about the first hash on the list:</p>
<figure class="wp-block-table"><table><tbody><tr><td> </td><td>Attributes</td></tr><tr><td>authentihash</td><td>0d10a35c1bed8d5a4516a2e704d43f10d47ffd2aabd9ce9e04fb3446f62168bf</td></tr><tr><td>creation_date</td><td>1624910154</td></tr><tr><td>crowdsourced_ids_results</td><td>[{[TRUNCATED]’alert_context’: [{‘dest_ip’: ‘8.8.8.8’, ‘dest_port’: 53}, {‘dest_ip’: ‘193.204.114.232’, ‘dest_port’: 123}], ‘rule_url’: ‘https://www.snort.org/downloads/#rule-downloads’, ‘rule_source’: ‘Snort registered user ruleset’, ‘rule_id’: ‘1:527’}, {‘rule_category’: ‘not-suspicious’, ‘alert_severity’: ‘low’, ‘rule_msg’: ‘TAG_LOG_PKT’, ‘rule_raw’: ‘alert ( gid:2; sid:1; rev:1; msg:”TAG_LOG_PKT”; metadata:rule-type preproc; classtype:not-suspicious; )’, ‘alert_context’: [{‘dest_ip’: ‘107.181.161.197’, ‘dest_port’: 443}], ‘rule_url’: ‘https://www.snort.org/downloads/#rule-downloads’, ‘rule_source’: ‘Snort registered user ruleset’, ‘rule_id’: ‘2:1’}]</td></tr><tr><td>crowdsourced_ids_stats</td><td>{‘info’: 0, ‘high’: 0, ‘medium’: 2, ‘low’: 1}</td></tr><tr><td>downloadable</td><td>TRUE</td></tr><tr><td>exiftool</td><td>{‘MIMEType’: ‘application/octet-stream’, ‘Subsystem’: ‘Windows GUI’, ‘MachineType’: ‘AMD AMD64’, ‘TimeStamp’: ‘2021:06:28 19:55:54+00:00’, ‘FileType’: ‘Win64 DLL’, ‘PEType’: ‘PE32+’, ‘CodeSize’: ‘115712’, ‘LinkerVersion’: ‘14.16’, ‘ImageFileCharacteristics’: ‘Executable, Large address aware, DLL’, ‘FileTypeExtension’: ‘dll’, ‘InitializedDataSize’: ‘69632’, ‘SubsystemVersion’: ‘6.0’, ‘ImageVersion’: ‘0.0’, ‘OSVersion’: ‘6.0’, ‘EntryPoint’: ‘0x139c4’, ‘UninitializedDataSize’: ‘0’}</td></tr><tr><td>first_submission_date</td><td>1624917754</td></tr><tr><td>last_analysis_date</td><td>16365918529</td></tr><tr><td>last_analysis_results</td><td>{ [TRUNCATED] ‘20211110’}, ‘Tencent’: {‘category’: ‘undetected’, ‘engine_name’: ‘Tencent’, ‘engine_version’: ‘1.0.0.1’, ‘result’: None, ‘method’: ‘blacklist’, ‘engine_update’: ‘20211111’}, ‘Ad-Aware’: {‘category’: ‘malicious’, Edition’: {‘category’: ‘malicious’, ‘engine_name’: ‘McAfee-GW-Edition’, ‘engine_version’: ‘v2019.1.2+3728’, ‘result’: ‘RDN/CobaltStrike’, ‘method’: ‘blacklist’, ‘engine_update’: ‘20211110’}, ‘Trapmine’: {‘category’: ‘type-unsupported’, ‘engine_name’: ‘Trapmine’, ‘engine_version’: ‘3.5.0.1023’, ‘result’: None, ‘method’: ‘blacklist’, ‘engine_update’: ‘20200727’}, ‘CMC’: {‘category’: ‘undetected’, ‘engine_name’: ‘CMC’, ‘engine_version’: ‘2.10.2019.1’, ‘result’: None, ‘method’: ‘blacklist’, ‘engine_update’: ‘20211026’}, ‘Sophos’: {‘category’: ‘malicious’, ‘engine_name’: ‘Sophos’, ‘engine_version’: ‘1.4.1.0’, ‘result’:</td></tr><tr><td>last_analysis_stats</td><td>{‘harmless’: 0, ‘type-unsupported’: 6, ‘suspicious’: 0, ‘confirmed-timeout’: 1, ‘timeout’: 0, ‘failure’: 0, ‘malicious’: 47, ‘undetected’: 19}</td></tr><tr><td>last_modification_date</td><td>1646895757</td></tr><tr><td>last_submission_date</td><td>1624917754</td></tr><tr><td>magic</td><td>PE32+ executable for MS Windows (DLL) (GUI) Mono/.Net assembly</td></tr><tr><td>md5</td><td>55646b7df1d306b0414d4c8b3043c283</td></tr><tr><td>meaningful_name</td><td>197.dll</td></tr><tr><td>names</td><td>[197.dll, iduD2A1.tmp]</td></tr><tr><td>pe_info</td><td>[TRUNCATED] {‘exports’: [‘StartW’, ‘7c908697e85da103e304d57e0193d4cf’}, {‘name’: ‘.rsrc’, ‘chi2’: 51663.55, ‘virtual_address’: 196608, ‘entropy’: 5.81, ‘raw_size’: 1536, ‘flags’: ‘r’, ‘virtual_size’: 1128, ‘md5’:, ‘GetStringTypeW’, ‘RtlUnwindEx’, ‘GetOEMCP’, ‘TerminateProcess’, ‘GetModuleHandleExW’, ‘IsValidCodePage’, ‘WriteFile’, ‘CreateFileW’, ‘FindClose’, ‘TlsGetValue’, ‘GetFileType’, ‘TlsSetValue’, ‘HeapAlloc’, ‘GetCurrentThreadId’, ‘SetLastError’, ‘LeaveCriticalSection’]}], ‘entry_point’: 80324}</td></tr><tr><td>popular_threat_classification</td><td>{‘suggested_threat_label’: ‘trojan.bulz/shelma’, ‘popular_threat_category’: [{‘count’: 22, ‘value’: ‘trojan’}, {‘count’: 6, ‘value’: ‘downloader’}, {‘count’: 2, ‘value’: ‘dropper’}], ‘popular_threat_name’: [{‘count’: 6, ‘value’: ‘bulz’}, {‘count’: 6, ‘value’: ‘shelma’}, {‘count’: 3, ‘value’: ‘cobaltstrike’}]}</td></tr><tr><td>reputation</td><td>0</td></tr><tr><td>sandbox_verdicts</td><td>{‘Zenbox’: {‘category’: ‘malicious’, ‘sandbox_name’: ‘Zenbox’, ‘malware_classification’: [‘MALWARE’, ‘TROJAN’, ‘EVADER’]}, ‘C2AE’: {‘category’: ‘undetected’, ‘sandbox_name’: ‘C2AE’, ‘malware_classification’: [‘UNKNOWN_VERDICT’]}, ‘Yomi Hunter’: {‘category’: ‘malicious’, ‘sandbox_name’: ‘Yomi Hunter’, ‘malware_classification’: [‘MALWARE’]}, ‘Lastline’: {‘category’: ‘malicious’, ‘sandbox_name’: ‘Lastline’, ‘malware_classification’: [‘MALWARE’]}}</td></tr><tr><td>sha1</td><td>ddf0214fbf92240bc60480a37c9c803e3ad06321</td></tr><tr><td>sha256</td><td>cf0a85f491146002a26b01c8aff864a39a18a70c7b5c579e96deda212bfeec58</td></tr><tr><td>sigma_analysis_stats</td><td>{‘high’: 0, ‘medium’: 1, ‘critical’: 1, ‘low’: 0}</td></tr><tr><td>sigma_analysis_summary</td><td>{‘Sigma Integrated Rule Set (GitHub)’: {‘high’: 0, ‘medium’: 0, ‘critical’: 1, ‘low’: 0}, ‘SOC Prime Threat Detection Marketplace’: {‘high’: 0, ‘medium’: 1, ‘critical’: 0, ‘low’: 0}}</td></tr><tr><td>size</td><td>181248</td></tr><tr><td>ssdeep</td><td>3072:fck3rwbtOsN4X1JmKSol6LZVZgBPruYgr3Ig/XZO9:fck3rwblqPgokNgBPr9gA</td></tr><tr><td>tags</td><td>[assembly, invalid-rich-pe-linker-version, detect-debug-environment, long-sleeps, 64bits, pedll]</td></tr><tr><td>times_submitted</td><td>1</td></tr><tr><td>tlsh</td><td>T110049E14B2A914FBEE6A82B984935611B07174624338DFEF03A4C375DE0E7E15A3EF25</td></tr><tr><td>total_votes</td><td>{‘harmless’: 0, ‘malicious’: 0}</td></tr><tr><td>trid</td><td>[{‘file_type’: ‘Win64 Executable (generic)’, ‘probability’: 48.7}, {‘file_type’: ‘Win16 NE executable (generic)’, ‘probability’: 23.3}, {‘file_type’: ‘OS/2 Executable (generic)’, ‘probability’: 9.3}, {‘file_type’: ‘Generic Win/DOS Executable’, ‘probability’: 9.2}, {‘file_type’: ‘DOS Executable Generic’, ‘probability’: 9.2}]</td></tr><tr><td>type_description</td><td>Win32 DLL</td></tr><tr><td>type_extension</td><td>dll</td></tr><tr><td>type_tag</td><td>pedll</td></tr><tr><td>unique_sources</td><td>1</td></tr><tr><td>Vhash</td><td>115076651d155d15555az43=z55</td></tr></tbody></table></figure>
<p>The results indicate that the hash is a Cobalt Strike loader, which means that Conti affiliates also use the penetration testing tool as part of their infrastructure during their operation.</p>
<p>In addition, <a></a>the VirusTotal module can also provide details such as detection rate, type, description, and other information related to the hashes. The code snippet below generates the list of domains to which the hashes connect to.</p>
<figure class="wp-block-image size-full"><img alt="A screenshot of Python code that generates the list of domains specific hashes connect to using the VirusTotal module. " class="wp-image-115446" height="38" src="https://www.microsoft.com/security/blog/uploads/securityprod/2022/05/fig-31-getting-contacted-domains.png" style="max-width:800px;height:auto;width:auto;" width="660"/><figcaption>Figure 31. Getting contacted domains</figcaption></figure>
<figure class="wp-block-image size-large"><img alt="A screenshot of a table generated from extracting domains to which certain hashes connected to using the VirusTotal module. " class="wp-image-115449" height="645" src="https://www.microsoft.com/security/blog/uploads/securityprod/2022/05/fig-32-additional-domains-retrieved-from-previously-extracted-hashes-1024x645.png" style="max-width:800px;height:auto;width:auto;" width="1024"/><figcaption>Figure 32. Additional domains retrieved from previously extracted hashes</figcaption></figure>
<p>Doing this kind of analysis on the Conti leak data or similar data sets can lead to the discovery of possibly related domains that were not in the initial data sets.</p>
<h2>Conclusion</h2>
<p>This blog outlines how Python can be used to find valuable threat intelligence from data sets such as chat logs. It also presents details on how processing data using the MSTICPy library can be useful for enriching and hunting within environments, as well as collecting additional threat context. The <a href="https://github.com/microsoft/msticpy/blob/main/docs/notebooks/ContiLeaksAnalysis.ipynb" rel="noreferrer noopener" target="_blank">interactive notebook </a>provides additional code snippets that can also be used to continue log exploration.</p>
<p>The types of information extracted in this blog provides insights into the various elements of the criminal ecosystem that were coordinating their activities. Threat intelligence from research like this informs products and services like <a href="https://www.microsoft.com/microsoft-365/security/microsoft-365-defender">Microsoft 365 Defender</a>, translating knowledge into real-world protection for customers. More importantly, the methodology described in this blog can be adapted to specific threat intelligence services, and the broader community is invited to use it for further analysis, enrichment of data, and intelligence sharing for the benefit of all.</p>
<p></p>
<p>Thomas Roccia
Microsoft 365 Defender Research Team</p>
<p></p>
<h2>References</h2>
<ul><li>https://krebsonsecurity.com/2022/03/conti-ransomware-group-diaries-part-i-evasion/</li><li>https://research.checkpoint.com/2022/leaks-of-conti-ransomware-group-paint-picture-of-a-surprisingly-normal-tech-start-up-sort-of/</li><li>https://therecord.media/conti-leaks-the-panama-papers-of-ransomware/</li><li>https://www.breachquest.com/conti-leaks-insight-into-a-ransomware-unicorn/</li><li>https://www.forescout.com/resources/analysis-of-conti-leaks/</li><li>https://github.com/Res260/conti_202202_leak_procedures</li><li>https://readme.security/the-conti-leaks-first-rumble-of-the-ukraine-earthquake-thats-rattling-the-cybercrime-underground-7abb23b0fb04</li><li>https://medium.com/@arnozobec/analyzing-conti-leaks-without-speaking-russian-only-methodology-f5aecc594d1b</li><li>https://github.com/soufianetahiri/ContiLeaks/blob/main/cobaltsrike_lolbins</li><li>https://twitter.com/TheDFIRReport/status/1498656118746365952</li><li>https://www.clearskysec.com/wp-content/uploads/2021/02/Conti-Ransomware.pdf</li><li>https://blog.bushidotoken.net/2022/04/lessons-from-conti-leaks.html</li><li>https://www.trellix.com/en-au/about/newsroom/stories/threat-labs/conti-leaks-examining-the-panama-papers-of-ransomware.html</li><li>https://msticpy.readthedocs.io/en/latest/getting_started/Introduction.html</li></ul>
</div>