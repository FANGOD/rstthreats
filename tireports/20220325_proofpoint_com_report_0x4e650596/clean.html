<div>
<h1 class="c-article__title">Serpent Backdoor Slithers into Orgs Using Chocolatey Installer</h1>
<figure>
<img alt="" src="https://media.threatpost.com/wp-content/uploads/sites/103/2020/06/10154152/snake-e1591818143608.jpg" style="max-width:80%;height:auto;width:auto;"/>
</figure>
<a href="https://threatpost.com/author/elizabethmontalbano/"><img alt="" class="avatar avatar-60 photo" height="60" src="https://media.threatpost.com/wp-content/uploads/sites/103/2021/05/05095657/Liz-Montalbano-headshot.jpg" width="60"/></a>
Author: 
<a class="c-article__author-name" href="https://threatpost.com/author/elizabethmontalbano/">Elizabeth Montalbano</a>
March 22, 2022 10:21 am
3:30 minute read
											
<a class="c-label c-label--secondary-transparent" href="#discussion"> Write a comment</a>
<p>Share this article:</p>
<p>An unusual attack using an open-source package installer called Chocolatey, steganography and Scheduled Tasks is stealthily delivering spyware to companies.</p>
<p>Researchers have discovered a cyberattack that uses unusual evasion tactics to <a href="https://threatpost.com/fin8-bank-sardonic-backdoor/168982/" rel="noopener" target="_blank">backdoor</a> French organizations with a novel malware dubbed Serpent, they said.</p>
<p>A team from Proofpoint observed what they call an “advanced, targeted threat” that uses email-based lures and malicious files typical of many malware campaigns to deliver its ultimate payload to targets in the French construction, real-estate and government industries.</p>
<p>However, between initial contact and payload, the attack uses methods to avoid detection that haven’t been seen before, researchers revealed <a href="https://www.proofpoint.com/us/blog/threat-insight/serpent-no-swiping-new-backdoor-targets-french-entities-unique-attack-chain" rel="noopener" target="_blank">in a blog post</a> Monday.</p>
<p><a href="https://threatpost.com/infosec-insider-subscription-page/?utm_source=ART&amp;utm_medium=ART&amp;utm_campaign=InfosecInsiders_Newsletter_Promo/" rel="noopener" target="_blank"><img alt="Infosec Insiders Newsletter" class="aligncenter wp-image-168544 size-full" height="50" src="https://media.threatpost.com/wp-content/uploads/sites/103/2021/07/10165815/infosec_insiders_in_article_promo.png" style="max-width:800px;height:auto;width:auto;" width="700"/></a></p>
<p>These include the use of a legitimate software package installer called Chocolatey as an initial payload, equally legitimate Python tools that wouldn’t be flagged in network traffic, and a novel detection-bypass technique using a Scheduled Task, they said.</p>
<p>“The ultimate objectives of the threat actor are presently unknown,” Proofpoint researchers Bryan Campbell, Zachary Abzug, Andrew Northern and Selena Larson acknowledged in the post. “Successful compromise would enable a threat actor to conduct a variety of activities, including stealing information, obtaining control of an infected host or installing additional payloads.”</p>
<h2>Serpent: A Slippery Attack Chain</h2>
<p>The attack chain begins as many <a href="https://threatpost.com/ransomware-phishing-emails-segs/176470/" rel="noopener" target="_blank">email-based attacks</a> do—with an email that appears to be coming from a legitimate source that includes a Microsoft Word document containing malicious macros. Various parts of the macro include ASCII art that depicts a snake, giving the <a href="https://threatpost.com/tomiris-backdoor-solarwinds-malware/175091/" rel="noopener" target="_blank">backdoor</a> its name, researchers said.</p>
<p>The macro-laden document purports to have important information related to the “règlement général sur la protection des données (RGPD),” aka the European Union’s General Data Protection Regulations (GDPR), a law which mandates how companies must report data leaks to the government.</p>
<p>If macros are enabled, the document executes the document’s macro, which reaches out to an image URL–e.g., https://www.fhccu[.]com/images/ship3[.]jpg–that contains a base64 encoded PowerShell script hidden <a href="https://threatpost.com/steganography-combat/143096/" rel="noopener" target="_blank">using steganography</a>.</p>
<p>The PowerShell script first downloads, installs and updates the installer package and repository <a href="https://chocolatey.org/install.ps1" rel="noopener" target="_blank">script</a> for Chocolatey, a software management automation tool for Windows that wraps installers, executables, .ZIP files and scripts into compiled packages, researchers said.</p>
<p>“Leveraging Chocolatey as an initial payload may allow the threat actor to bypass threat-detection mechanisms because it is a legitimate software package and would not immediately be identified as malicious,” researchers noted.</p>
<p>The script then uses Chocolatey to install Python, including the <a href="https://pypi.org/project/pip/" rel="noopener" target="_blank">pip</a> Python package installer. This component then installs various dependencies including <a href="https://pypi.org/project/PySocks/" rel="noopener" target="_blank">PySocks</a>, a Python-based reverse proxy client that enables users to send traffic through SOCKS and HTTP proxy servers, researchers said.</p>
<p>Next, the PowerShell script fetches another image file–e.g. https://www.fhccu[.]com/images/7[.]jpg,–which contains a base64 encoded Python script that also is obscured using steganography, they said. The PowerShell script saves the Python script as “MicrosoftSecurityUpdate.py” and then creates and executes a .bat file that in turn executes the Python script.</p>
<p>The attack chain ends with a command to a shortened URL which redirects to the Microsoft Office help website, researchers said. The steganographic images used to hide the scripts are hosted on what appears to be a Jamaican credit-union website, they added.</p>
<h2>Serpent Backdoor</h2>
<p>Once successfully installed on a targeted system, the Serpent backdoor periodically pings the “order” server, or the first onion[.]pet URL), and expects responses of the form &lt;random integer&gt;–&lt;hostname&gt;–&lt;command&gt;.</p>
<p>If &lt;hostname&gt; matches the hostname of the infected computer, the infected host runs the command provided by the order server (&lt;command&gt;), researchers said. This could be any Windows command as designated by the attacker, the output of which is then recorded.</p>
<p>Next, Serpent uses PySocks to connect to the command-line Pastebin tool called Termbin, pastes the output to a bin, and receives the bin’s unique URL.</p>
<p>As its final act, the backdoor sends a request to the “answer” server (a second onion[.]pet URL), including the hostname and bin URL in the header. This allows the attacker to monitor the bin outputs via the “answer” URL and see what the infected host’s response was, researchers observed. Once this entire process is complete, Serpent cycles through it indefinitely, they added.</p>
<h2>Task-Scheduler Evasion Tactic</h2>
<p>In addition to using steganographic images and the Chocolatey package installer to hide its nefarious activities, the attack also uses what Proofpoint researchers said is a never-before-seen application of signed binary proxy execution using a Scheduled Tasks executable, as “an attempt to bypass detection by defensive measures.”</p>
<p>A command that leverages schtasks.exe to create a one-time task to call a portable executable is contained within a Swiper image called ship.jpg after the end of file marker, researchers said.</p>
<p>“In this case the executable is called calc.exe,” researchers wrote in the post. The trigger for this task is contingent on the creation of a Windows event with EventID of 777, after which the command then creates a dummy event to trigger the task ,and deletes the task from the task scheduler as if it never occurred, they said.</p>
<p>“This peculiar application of tasking logic results in the portable executable being executed as a child process of taskhostsw.exe, which is a signed Windows binary,” researchers said.</p>
<p>Moving to the cloud? Discover emerging cloud-security threats along with solid advice for how to defend your assets with our <a href="https://bit.ly/3Jy6Bfs" rel="noopener" target="_blank">FREE downloadable eBook</a>, “Cloud Security: The Forecast for 2022.” We explore organizations’ top risks and challenges, best practices for defense, and advice for security success in such a dynamic computing environment, including handy checklists.</p>
</div>