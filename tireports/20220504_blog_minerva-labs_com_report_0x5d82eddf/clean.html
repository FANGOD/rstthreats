<div>
<h1>Minerva Labs Blog</h1>
<p>News &amp; Reports</p>
<a class="hs-featured-image-link" href="https://blog.minerva-labs.com/a-new-blustealer-loader-uses-direct-syscalls-to-evade-edrs" title="">
<img class="hs-featured-image" src="https://blog.minerva-labs.com/hubfs/blustealer%20feature-1.jpg" style="max-width:80%;height:auto;width:auto;"/>
</a>
<h2>A new BluStealer Loader Uses Direct Syscalls to Evade EDRs</h2>
						 May 03, 2022
					 | 
					 
						
							Natalie Zargarov
						
					 
<ul class="hs-blog-social-share-list">
<li class="hs-blog-social-share-item hs-blog-social-share-item-twitter">
</li>
<li class="hs-blog-social-share-item hs-blog-social-share-item-linkedin">
</li>
<li class="hs-blog-social-share-item hs-blog-social-share-item-facebook">
</li>
</ul>
<p>BluStealer malware was first detected in May 2021 by <a href="https://twitter.com/James_inthe_box/status/1395824249605025792" rel="noopener nofollow" target="_blank">James_inthe_box</a>. Back then, it was delivered through a phishing mail, either as an attachment or a Discord link leading to the malware download URL. According to <a href="https://decoded.avast.io/anhho/blustealer/" rel="noopener nofollow" target="_blank">Avast 2021 analysis</a>, it “consists of a core written in Visual Basic and the C# .NET inner payload(s). The VB core reuses a large amount of code from a 2004 <a href="http://www.a1vbcode.com/app-2530.asp" rel="noopener nofollow" target="_blank">SpyEx</a> project. Its capabilities to steal crypto wallet data, swap crypto addresses present in the clipboard, find and upload document files, exfiltrate data through SMTP and the Telegram Bot API, as well as anti-analysis/anti-VM tactics” </p>
<p>BluStealer authors are not staying behind, and in their latest version, they implement what was one of 2021’s biggest trends - the use of direct syscalls to bypass EDRs. </p>
<p> </p>
<p>The latest version seems to have a pdf icon inserted to it, which would indicate that the delivery is via email, with the intention of tricking the user into executing the .exe loader while thinking it's a pdf. <img alt="pdf icon" src="https://blog.minerva-labs.com/hs-fs/hubfs/pdf%20icon.png?width=76&amp;name=pdf%20icon.png" width="76"/></p>
<p>Figure 1 - First Stage Icon </p>
<p>The first stage loader is created with NSIS (Nullsoft Scriptable Install System), a professional open-source system used to create Windows installers, which drops three files to the user’s temp folder: </p>
<ol>
<li>rwzhmby.exe - second stage loader file </li>
</ol>
<ol>
<li>mhxbnyunxz – third stage loader file </li>
</ol>
<ol>
<li>3amz20m5vs – BluStealer malware </li>
</ol>
<p>It then executes the rwzhmby.exe with C:\Users\username\AppData\Local\Temp\mhxbnyunxz. </p>
<p> <img alt="the execution" src="https://blog.minerva-labs.com/hs-fs/hubfs/the%20execution.png?width=683&amp;name=the%20execution.png" style="max-width:800px;height:auto;width:auto;" width="683"/></p>
<p>Figure 2 – Second Stage execution Command Line </p>
<p>The second stage loader reads the mhxbnyunxz and then allocates new memory, decrypts every byte read from mhxbnyunxz and continues to the decrypted code. </p>
<p> <img alt="read file" src="https://blog.minerva-labs.com/hs-fs/hubfs/read%20file.png?width=458&amp;name=read%20file.png" width="458"/></p>
<p>Figure 3 - Read and Allocate Memory for Third Stage </p>
<p>The decrypted code (third stage) from mhxbnyunxz is the most interesting part. It is the main BluStealer loader and is responsible for gaining persistency, creating the necessary environment, and finally executing the malware itself. </p>
<p>BluStealer Environment: </p>
<p>The loader checks if the C:\Users\username\AppData\Roaming\rmfyvviyify folder exists. If it doesn’t, it creates it and then creates a copy of the second stage rwzhmby.exe file to the folder under the name juvhkpig.exe. </p>
<p><img alt="copied file" src="https://blog.minerva-labs.com/hs-fs/hubfs/copied%20file.png?width=682&amp;name=copied%20file.png" style="max-width:800px;height:auto;width:auto;" width="682"/></p>
<p>Figure 4 - Copied file to newly created folder </p>
<p>Persistency: </p>
<p>After creating a folder and copying rwzhmby.exe to it, the loader creates a new HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Run\wnyutmbcgovbty registry key, which will run the malware every time the user logs on. </p>
<p> <img alt="new persistency" src="https://blog.minerva-labs.com/hs-fs/hubfs/new%20persistency.png?width=925&amp;name=new%20persistency.png" style="max-width:800px;height:auto;width:auto;" width="925"/></p>
<p>Figure 5 – Registry Persistency </p>
<p>Main Payload Execution: </p>
<p>The main payload seems to arrive in the 3amz20m5vs file. The loader first reads the file into allocated memory and then decrypts it. The only thing left is then to execute it. The malware uses a Process Hallowing Technique with a twist to execute the main payload a malware . Some of the API calls used for Process Hollowing were switched to direct syscalls. </p>
<p> <img alt="direct syscall" src="https://blog.minerva-labs.com/hs-fs/hubfs/direct%20syscall.png?width=271&amp;name=direct%20syscall.png" width="271"/></p>
<p>Figure 6 - Direct Syscall Function </p>
<p>The List of Standard API calls used in the Process Hollowing technique: </p>
<ol>
<li>CreateProcessA – the loader runs ---first file ---- in suspended mode. </li>
<li>NtQueryInformationProcess </li>
<li>ReadProcessMemory </li>
<li>NtUnmapViewOfSection – called by direct syscall (0x002a) </li>
<li>VirtualAllocEx </li>
<li>WriteProcessMemory - called by direct syscall (0x003a) </li>
<li>GetThreadContext </li>
<li>SetThreadContext </li>
<li>ResumeThread - - called by direct syscall (0x0052) </li>
</ol>
<p> </p>
<p>Implementing an evasion technique like Process Hollowing while partly changing API calls to direct syscall is likely to confuse and bypass security products that rely on a specific set of API calls for detection. </p>
<p>The injected file is the final stage. Its original file name is firebed.exe and it is BluStealer itself. It seems to have been compiled on Apr 7th 2022, which might indicate that the author is constantly working on the stealer’s capabilities. As a first step it creates a C:\Users\Public\3046414246424646303030333036463242464246463030303330 folder which will contain the stolen data before the exfiltration. The injected file, firebed.exe, is also copied to this folder under the name misguise.exe. </p>
<p>Persistence capabilities have been changed since the previous version was released in September 2021. Our sample creates a HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\RunOnce\boos registry key which executes C:\Users\Public\3046414246424646303030333036463242464246463030303330\misguise.exe </p>
<p>The new version of BluStealer is able to steal credentials from the following browsers: </p>
<ul>
<li>Iridium </li>
<li>7Star </li>
<li>Cent Browser </li>
<li>Chedot </li>
<li>Vivaldi </li>
</ul>
<ul>
<li>Kometa </li>
<li>Elements Browser </li>
<li>Epic Privacy Browser </li>
<li>Sleipnir5 </li>
<li>Citrio </li>
</ul>
<ul>
<li>Coowon </li>
<li>liebao </li>
<li>QIP Surf </li>
<li>Orbitum </li>
<li>Amigo </li>
</ul>
<ul>
<li>Torch </li>
<li>Yandex Browser </li>
<li>Comodo Dragon </li>
<li>360Browser </li>
<li>Maxthon3 </li>
</ul>
<ul>
<li>K-Melon </li>
<li>Sputnik </li>
<li>Nichrome </li>
<li>CocCoc </li>
<li>Uran </li>
</ul>
<ul>
<li>Chromodo </li>
<li>Atom </li>
<li>Brave Browser </li>
<li>Microsoft Edge </li>
<li>Chromium </li>
</ul>
<ul>
<li>Google Chrome </li>
<li>Opera </li>
<li>Mozilla Firefox </li>
</ul>
<p> </p>
<p>Many people store different credentials in their browsers so stealing this type of data might endanger both private and corporate users. </p>
<p>It also steals doc files (.txt, .xls, .xlsx,.doc, .docx, .pdf, .utc, .rtf) and personal data from email applications such as “MailMaster” and “ThunderBird” . </p>
<p>Zcash crypto wallet was added to last year's list and the current list of wallet keys that can be stolen is: </p>
<ol>
<li>Zcash </li>
<li>Armory </li>
<li>Bytecoin </li>
<li>Jaxx Liberty </li>
<li>Exodus </li>
<li>Electrum </li>
<li>Atomic </li>
<li>Guarda </li>
<li>Coinomi </li>
</ol>
<p> </p>
<p> </p>
<p>The last step is exfiltrating the collected data through SMTP. </p>
<p>It is worth mentioning, that Loader implementing such evasive injection technique can allow it to will bypass most security products, Including AVs &amp;EDRs. By changing the main payload file, the loader can potentially one might execute different types of malwares, including ransomware. </p>
<p> </p>
<p> </p>
<p> <img alt="flow" src="https://blog.minerva-labs.com/hs-fs/hubfs/flow.png?width=964&amp;name=flow.png" style="max-width:800px;height:auto;width:auto;" width="964"/></p>
<p>Figure 7 - BluStealer Execution Flow </p>
<p>Minerva Labs prevents the main payload from being executed by preventing the use of direct syscalls execution: </p>
<p> <img alt="minerva prevention" src="https://blog.minerva-labs.com/hs-fs/hubfs/minerva%20prevention.png?width=685&amp;name=minerva%20prevention.png" style="max-width:800px;height:auto;width:auto;" width="685"/></p>
<p> Figure 8 - Minerva Labs Prevention </p>
<p> </p>
<p>IOC’s </p>
<ol>
<li>790F4DA318B3A9592F4B35B73528DE2C - rwzhmby.exe </li>
</ol>
<ol>
<li>122C0AA6F0362E3F6F11FF83E3A608C4 - mhxbnyunxz </li>
</ol>
<ol>
<li>43E7B7F7D9E59C3256CF7E5CE114FC53 - 3amz20m5vs </li>
</ol>
<ol>
<li>953B2013A8B0D4BE5368A65FC74C93F4 - firebed.exe/ misguise.exe </li>
</ol>
<p> </p>
<p> </p>
<p> </p>
<p> </p>
<p> </p>
<a href="new-black-basta-ransomware-hijacks-windows-fax-service?hsLang=en-us">
« Previous Post
 </a>
</div>