<div>
<figure>
<a href="https://blogs.jpcert.or.jp/en/shu_tom/">
<img alt="朝長 秀誠 (Shusei Tomonaga)" height="50" src="https://movabletype.net/users/shu_tom/ENCORE_400x400.jpg" width="50"/>
</a>
</figure>
<p><a href="https://blogs.jpcert.or.jp/en/shu_tom/">朝長 秀誠 (Shusei Tomonaga)</a></p>
May 19, 2022
<h2 class="entry-title">Analysis of HUI Loader</h2>
<ul>
</ul>
<ul>
<li class="entry-social-twitter">
</li>
<li class="entry-social-mail">
<a href="mailto:?subject=Analysis%20of%20HUI%20Loader&amp;body=https%3A%2F%2Fblogs.jpcert.or.jp%2Fen%2F2022%2F05%2FHUILoader.html">Email</a>
</li>
</ul>
<p>To conceal malware’s features, attackers sometimes encode the malware and decode it only when they execute it. In such cases, the encoded malware is loaded and executed by a program called loader. In this way, an attacker can split the malware into a loader and encoded malware. Minimizing the loader’s features and hiding important features of the malware make detection on infected hosts more difficult. Among such loaders, this article discusses HUI Loader, which has been used since around 2015.</p>
<h3>Overview of HUI Loader</h3>
<p>At JSAC2022, it was pointed out that several attack groups use HUI Loader <a href="#1">[1]</a>, and JPCERT/CC has also confirmed attacks using this loader since around 2015. Figure 1 shows the changes in HUI Loader as well as the attack groups using it.</p>
<p></p><figure class="mt-figure mt-figure-center"><a class="mt-asset-link" href="https://blogs.jpcert.or.jp/en/.assets/hui_loader-fig1-540f65d5.png"><img alt="Changes in HUI Loader" class="asset asset-image at-xid-2302507 mt-image-center" height="286" src="https://blogs.jpcert.or.jp/en/.assets/thumbnail/hui_loader-fig1-540f65d5-640wri.png" width="640"/></a><figcaption>Figure 1. Changes in HUI Loader</figcaption></figure><p></p>
<p>HUI Loader was first identified around January 2015. It was confirmed that APT10 attack group had been using it. Around April 2015, Blue Termite also started using it. These attack groups used the following 3 types of encoded malware loaded into the HUI Loader. Note that Poison Ivy and Quasar were customized by the attackers from the original.</p>
<ul>
<li>PlugX</li>
<li>Poison Ivy <a href="#2">[2]</a></li>
<li>Quasar <a href="#3">[3]</a></li>
</ul>
<p>Since 2016, we have seen continuous use by the APT10 attack group; since June 2020, attack group A41APT has also started using it <a href="#1">[1]</a>. Additionally, since August 2021, the DEV-0401 attack group has also started using it <a href="#4">[4]</a>. The method of encoding the malware body has not changed since the beginning and can be decoded as follows.</p>
for i in range(len(enc_data)):
 data = ord(enc_data[i]) ^ 0x20 ^ ord(key[i % len(key)])
 dec_data.append(data) 
<p>In the following sections, we will describe the following HUI Loader feature changes that have been made so far.</p>
<ul>
<li>Persistence</li>
<li>Password randomization</li>
<li>Disabling security features</li>
<li>Removal of characteristic strings</li>
</ul>
<h3>Persistence</h3>
<p>There are two types of HUI Loader: those with persistence functionality and those without it. 3 patterns of persistence functionality have been identified:</p>
<ul>
<li>Service</li>
<li>Registry (Run key)</li>
<li>Startup folder</li>
</ul>
<p>Many HUI Loader samples register a service and start it upon restart. The service name and other details vary from sample to sample. The type that starts from the registry was identified around 2015, but it has not been seen in recent samples. The type that starts from the startup folder creates an LNK file in the startup folder and starts via a shortcut file, as shown in Figure 2.</p>
<p></p><figure class="mt-figure mt-figure-center"><a class="mt-asset-link" href="https://blogs.jpcert.or.jp/en/.assets/hui_loader-fig2.png"><img alt="Code to create LNK file in the startup folder" class="asset asset-image at-xid-2300472 mt-image-center" height="361" src="https://blogs.jpcert.or.jp/en/.assets/thumbnail/hui_loader-fig2-640wri.png" width="640"/></a><figcaption>Figure 2. Code to create LNK file in the startup folder</figcaption></figure><p></p>
<h3>Password randomization</h3>
<p>HUI Loader which was identified around 2015 decoded the malware body using a regular string of characters as a password. As a result, the same password was often used in multiple samples. Since 2016, passwords have been randomized to use different values for each sample.</p>
<table>
<tbody>
</tbody>Table 1. Examples of passwords used by HUI Loader
<tbody><tr>
<td>sha256</td>
<td>creation time</td>
<td>password</td>
</tr>
<tr>
<td>8efcecc00763ce9269a01d2b5918873144746c4b203be28c92459f5301927961</td>
<td>2015-05-21 08:54:24</td>
<td>qwe123#@!4567890</td>
</tr>
<tr>
<td>421e11a96e810c834dd6b14b515ad7a5401813caa0555ddfb3490c3d82336e3d</td>
<td>2015-07-14 02:07:10</td>
<td>qwe123#@!4567890</td>
</tr>
<tr>
<td>beb77e277510c4ff2797a314494606335f158a722cf6533fad62ba5d5789e2d3</td>
<td>2015-07-16 11:17:04</td>
<td>qwe123#@!4567890</td>
</tr>
<tr>
<td>074075eda7dde4396fb8aa441031cf88873b969273a9541f25b15fc35ec5ee49</td>
<td>2017-05-24 11:50:56</td>
<td>etweq0sH8zV6ggqRaBe</td>
</tr>
<tr>
<td>af223370ff0da3c9a9314dc6bf9cb9d9c3a12e2e3c835643edeedad4b4f908fa</td>
<td>2017-09-07 09:51:04</td>
<td>sdh7h327ogd28632fgd3f7fhn</td>
</tr>
<tr>
<td>c3cb9d0650fcca22a61760fa072336a036a8a5e8eaa61cb72bc4b553a84aedd1</td>
<td>2017-09-19 05:03:45</td>
<td>gef798w6g6f523fif5d3sdad</td>
</tr>
</tbody>
</table>
<h3>Disabling security features</h3>
<p>Some HUI Loader samples have code that aims to bypass the Windows OS security features, Event Tracing for Windows (ETW) and Antimalware Scan Interface (AMSI). Figures 3 and 4 show a part of the code that bypasses those features.</p>
<p></p><figure class="mt-figure mt-figure-center"><a class="mt-asset-link" href="https://blogs.jpcert.or.jp/en/.assets/hui_loader-fig3.png"><img alt="Example of code to bypass ETW" class="asset asset-image at-xid-2300473 mt-image-center" height="285" src="https://blogs.jpcert.or.jp/en/.assets/thumbnail/hui_loader-fig3-640wri.png" width="640"/></a><figcaption>Figure 3: Example of code to bypass ETW</figcaption></figure><p></p>
<p></p><figure class="mt-figure mt-figure-center"><a class="mt-asset-link" href="https://blogs.jpcert.or.jp/en/.assets/hui_loader-fig4.png"><img alt="Example of code to bypass AMSI" class="asset asset-image at-xid-2300474 mt-image-center" height="170" src="https://blogs.jpcert.or.jp/en/.assets/thumbnail/hui_loader-fig4-640wri.png" width="640"/></a><figcaption>Figure 4. Example of code to bypass AMSI</figcaption></figure><p></p>
<p>The beginning of AmsiScanBuffer function and ETWEventWrite function are changed to RETN command.</p>
<h3>Delete characteristic strings</h3>
<p>HUI Loader samples used to contain a characteristic string (HUIHWASDIHWEIUDHDSFSFFEFWEFEWFDSGEFERWGWEEFWFWEWD). However, since December 2021, samples without this string have also been identified. Figure 5 compares samples with and without the characteristic string.</p>
<p></p><figure class="mt-figure mt-figure-center"><a class="mt-asset-link" href="https://blogs.jpcert.or.jp/en/.assets/hui_loader-fig5.png"><img alt="left: Sample without characteristic string, right: Sample with characteristic string" class="asset asset-image at-xid-2300475 mt-image-center" height="248" src="https://blogs.jpcert.or.jp/en/.assets/thumbnail/hui_loader-fig5-640wri.png" width="640"/></a><figcaption>Figure 5. left: Sample without characteristic string, right: Sample with characteristic string</figcaption></figure><p></p>
<h3>In closing</h3>
<p>HUI Loader has been used for a long time being updated little by little since about 2015. It is expected that attack groups continue to use it in the future. The IoC of HUI Loader introduced in this article is available on Github. Please use it as needed.</p>
<p><a href="https://github.com/JPCERTCC/HUILoader-research" target="_blank" title="HUILoader-research">https://github.com/JPCERTCC/HUILoader-research</a></p>
<p>Shusei Tomonaga 
(Translated by Takumi Nakano)</p>
<h4>References</h4>
<p><a name="1"></a>[1] JSAC2022: What we can do to the chaotic A41APT campaign 
　 <a href="https://jsac.jpcert.or.jp/archive/2022/pdf/JSAC2022_9_yanagishita-tamada-nakatsuru-ishimaru_en.pdf" target="_blank" title="">https://jsac.jpcert.or.jp/archive/2022/pdf/JSAC2022_9_yanagishita-tamada-nakatsuru-ishimaru_en.pdf</a></p>
<p><a name="2"></a>[2] JPCERT/CC Eyes: PoisonIvy adapts to communicate through Authentication Proxies 
　 <a href="https://blogs.jpcert.or.jp/en/2015/07/poisonivy-adapts-to-communicate-through-authentication-proxies.html" target="_blank" title="">https://blogs.jpcert.or.jp/en/2015/07/poisonivy-adapts-to-communicate-through-authentication-proxies.html</a></p>
<p><a name="3"></a>[3] JPCERT/CC Eyes: Attack Activities by Quasar Family 
　 <a href="https://blogs.jpcert.or.jp/en/2020/12/quasar-family.html" target="_blank" title="">https://blogs.jpcert.or.jp/en/2020/12/quasar-family.html</a></p>
<p><a name="4"></a>[4] Symantec Enterprise Blogs: LockFile: Ransomware Uses PetitPotam Exploit to Compromise Windows Domain Controllers 
　 <a href="https://symantec-enterprise-blogs.security.com/blogs/threat-intelligence/lockfile-ransomware-new-petitpotam-windows" target="_blank" title="">https://symantec-enterprise-blogs.security.com/blogs/threat-intelligence/lockfile-ransomware-new-petitpotam-windows</a></p>
<ul>
<li class="entry-social-twitter">
</li>
<li class="entry-social-mail">
<a href="mailto:?subject=Analysis%20of%20HUI%20Loader&amp;body=https%3A%2F%2Fblogs.jpcert.or.jp%2Fen%2F2022%2F05%2FHUILoader.html">Email</a>
</li>
</ul>
<p>Author</p>
<figure>
<img alt="朝長 秀誠 (Shusei Tomonaga)" height="90" src="https://movabletype.net/users/shu_tom/ENCORE_400x400.jpg" width="90"/>
</figure>
<p><a href="https://blogs.jpcert.or.jp/en/shu_tom/">朝長 秀誠 (Shusei Tomonaga)</a></p>
<p>
Since December 2012, he has been engaged in malware analysis and forensics investigation, and is especially involved in analyzing incidents of targeted attacks. Prior to joining JPCERT/CC, he was engaged in security monitoring and analysis operations at a foreign-affiliated IT vendor. He presented at CODE BLUE, BsidesLV, BlackHat USA Arsenal, Botconf, PacSec and FIRST Conference. JSAC organizer.
</p>
<p>Was this page helpful?</p>
<p>
Yes
No
</p>
<p>0 people found this content helpful.</p>
<p>If you wish to make comments or ask questions, please use this form.</p>
<p>This form is for comments and inquiries. For any questions regarding specific commercial products, please contact the vendor.</p>
<p>
please change the setting of your browser to set JavaScript valid.
<img alt="" src="https://blogs.jpcert.or.jp/en/common/images/fb_loader.gif" style="max-width:80%;height:auto;width:auto;"/>
Thank you!
</p>
<a href="https://blogs.jpcert.or.jp/en/2022/04/ics-conference2022.html">Back</a>
<a href="https://blogs.jpcert.or.jp/en/">Top</a>
<table cellpadding="0" cellspacing="0" class="gsc-search-box"><tbody><tr><td class="gsc-input"><table cellpadding="0" cellspacing="0" class="gstl_50 gsc-input" id="gs_id50"><tbody><tr><td class="gsib_a" id="gs_tti50"></td><td class="gsib_b"><a class="gsst_a" href="" title="検索ボックスをクリア">×</a></td></tr></tbody></table></td><td class="gsc-search-button"></td><td class="gsc-clear-button"> </td></tr></tbody></table>カスタム検索 <table cellpadding="0" cellspacing="0" class="gsc-above-wrapper-area-container"><tbody><tr><td class="gsc-result-info-container"></td><td class="gsc-orderby-container">表示順:RelevanceRelevanceDate</td></tr></tbody></table>
</div>