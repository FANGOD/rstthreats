<div>
<p>DoubleZero is a newly emerging destructive malware targeting Ukrainian enterprises. The initial access vector is unknown, but eSentire Threat Intelligence assesses with medium confidence that the threat actor(s) was able to gain access to the infected machine(s) and escalate, or use, the existing administrative privileges to manually execute the malware.</p>
<p>As the Russia-Ukraine crisis continues, we assess that destructive malware will continue to be actively deployed to disrupt the operations of Ukrainian infrastructure.</p>
<p>Key Takeaways:</p>
<ul><li>DoubleZero is the fifth wiper malware targeting Ukrainian organizations (previously we have observed WhisperGate, HermeticWiper, IsaacWiper and CaddyWiper samples).</li><li>The malware destroys the components responsible for Windows boot process and overwrites the files will null bytes.</li><li>The compilation timestamp was changed by the threat actor(s) to confuse the researchers and make it harder to evaluate how long ago the malware sample was written.</li><li>To achieve the full-scale disruption, the threat actor(s) would need to escalate their privileges or bypass the user account control (UAC) to fully compromise the system.</li><li>eSentire Threat Intelligence team has observed that the malware fails to run on Windows Servers.</li></ul>
<h2>Case Study</h2>
<p>On March 22, 2022, the Computer Emergency Response Team of Ukraine (CERT-UA) released an advisory warning about the destructive DoubleZero malware found on March 17, 2022. The malicious activity is tracked under UAC-0088 and aimed to disrupt the operations of Ukrainian organizations.</p>
<h2>DoubleZero Analysis</h2>
<p>The ZIP archives are named “Вирус... крайне опасно!!!.zip” which means “Virus…extremely dangerous!!!.zip” and csrss.zip. The archives contain two files:</p>
<ul><li>cpcrs.exe</li><li>csrss.exe</li></ul>
<p>The 32-bit executables are compiled with .NET and both executables have the same impash, or import hash, 2916dda3c80b39a540b60c072a91a915
(the hash that is calculated based on the library/APIs used and their order within the executable file). It means that both files have the same functionality. </p>
<p>The compilation timestamp dates to May 28, 2071, which is not valid.</p>
<h3>Obfuscation</h3>
<p>The .NET malware sample appears to be highly obfuscated (Exhibit 1).</p>
<figure><img class="Image--FullWidth" src="https://s3.ca-central-1.amazonaws.com/esentire-dot-com-assets/assetsV3/Blog/Blog-Images/DoubleZero-Picture1.png" style="max-width:80%;height:auto;width:auto;"/><figcaption>Exhibit 1: Initial obfuscated .NET sample</figcaption></figure>
<p>
</p>
<p>After the first round of de-obfuscation, we discovered that DoubleZero implements AES (block size 128-bit) encryption in EBC mode with PKCS padding, control flow and switch statements for additional code obfuscation as shown in Exhibit 2. </p>
<figure><img class="Image--FullWidth" src="https://s3.ca-central-1.amazonaws.com/esentire-dot-com-assets/assetsV3/Blog/Blog-Images/DoubleZero-Picture2.png" style="max-width:80%;height:auto;width:auto;"/><figcaption>Exhibit 2: Obfuscation algorithm</figcaption></figure>
<h3>Enumeration</h3>
<p>The sample enumerates the HKEY_CURRENT_USER, HKEY_USERS, HKEY_LOCAL_MACHINE registry keys including HKEY_LOCAL_MACHINE\BCD00000000 (the key contains the boot configuration data that is required to boot up the Windows system) and subkeys using GetSubKeyNames, Registry.LocalMachine
and Registry.CurrentUser properties to remove them later. </p>
<p>The malware also enumerates on the paths listed in Exhibit 3 using Regex to match as few characters as possible with (.*?), also known as lazy mode, and “.*” to match any character except for line terminators.</p>
<p>The paths queried:</p>
<ul><li>\\Users\\\\.*?\\\\Local Settings.*</li><li>\\Users\\\\.*?\\\\AppData\\\\Local\\\\Application Data.*</li><li>\\Users\\\\.*?\\\\Start Menu.*</li><li>\\Users\\\\.*?\\\\Application Data.*</li><li>\\ProgramData\\\\Microsoft.*</li><li>\\Users\\\\.*?\\\\AppData\\\\Local\\\\Microsoft.*</li><li>\\Users\\\\.*?\\\\AppData\\\\Roaming\\\\Microsoft.*</li></ul>
<figure><img class="Image--FullWidth" src="https://s3.ca-central-1.amazonaws.com/esentire-dot-com-assets/assetsV3/Blog/Blog-Images/DoubleZero-Picture3.png" style="max-width:80%;height:auto;width:auto;"/><figcaption>Exhibit 3: Enumerating the folders using regex</figcaption></figure>
<p>
</p>
<p>The following folders get concatenated together forming a path (Exhibit 4):</p>
<ul><li>ProgramFiles(x86)\Documents and Settings</li><li>ProgramFiles(x86)\ProgramData\Application Data</li><li>ProgramFiles(x86)\Users\All Users</li><li>ProgramFiles(x86)\Users\Default User</li></ul>
<figure><img class="Image--FullWidth" src="https://s3.ca-central-1.amazonaws.com/esentire-dot-com-assets/assetsV3/Blog/Blog-Images/DoubleZero-Picture4.png" style="max-width:80%;height:auto;width:auto;"/><figcaption>Exhibit 4: Folder concatenation</figcaption></figure>
<p>
</p>
<p>It is notable that the sample also enumerates through drivers (Exhibit 4) and C:\Windows\NTDS path. The NTDS file contains a database that stores Active Directory data, including information groups, group membership and user objects. It also includes the password hashes for all users in the domain. eSentire Threat Intelligence team observed that the malware does not run on the Windows Server. </p>
<p>The malware gets the root drive of the infected device and Operating System information using Environment.SystemDirectory
and Environment.OSVersion properties (Exhibit 5).</p>
<figure><img class="Image--FullWidth" src="https://s3.ca-central-1.amazonaws.com/esentire-dot-com-assets/assetsV3/Blog/Blog-Images/DoubleZero-Picture5.png" style="max-width:80%;height:auto;width:auto;"/><figcaption>Exhibit 5: Enumerating system directory and OS version</figcaption></figure>
<p>
</p>
<p>DoubleZero attempts to get all logical drives on the infected computers (Exhibits 6-7).</p>
<figure><img class="Image--FullWidth" src="https://s3.ca-central-1.amazonaws.com/esentire-dot-com-assets/assetsV3/Blog/Blog-Images/DoubleZero-Picture6.png" style="max-width:80%;height:auto;width:auto;"/><figcaption>Exhibit 6: GetLogicalDrives gets a bitmask representing the currently available disk drives</figcaption></figure>
<p>
</p>
<figure><img class="Image--FullWidth" src="https://s3.ca-central-1.amazonaws.com/esentire-dot-com-assets/assetsV3/Blog/Blog-Images/DoubleZero-Picture7.png" style="max-width:80%;height:auto;width:auto;"/><figcaption>Exhibit 7: Checks if the drive name is valid</figcaption></figure>
<p>
</p>
<p>Three DLLs (Dynamic Link Library) will be used in this sample (Exhibit 8):</p>
<ul><li>ntdll.dll</li><li>kernel32.dll</li><li>user32.dll</li></ul>
<figure><img class="Image--FullWidth" src="https://s3.ca-central-1.amazonaws.com/esentire-dot-com-assets/assetsV3/Blog/Blog-Images/DoubleZero-Picture8.png" style="max-width:80%;height:auto;width:auto;"/><figcaption>Exhibit 8: DLLs used in DoubleZero</figcaption></figure>
<p>
</p>
<p>In Exhibit 9, the variables highlighted in orange are some of the API calls available for use by DoubleZero:</p>
<ul><li>NtOpenFile: this function opens an existing file, directory, device or volume then returns a handle for the file object.</li><li>NtFsControlFile: sends a control code to the specified file system or driver to perform specific action.</li><li>RtlNtStatusToDosError: returns the system error code.</li><li>RtlAdjustPrivilege: disables or enables a privilege from the calling thread or process.</li><li>CloseHandle: closes handles to objects mention in <a href="https://docs.microsoft.com/en-us/windows/win32/api/handleapi/nf-handleapi-closehandle">Microsoft MSDN</a>.</li><li>GetFileSizeEx: gets the size of a file.</li><li>GetLastError: receives the calling thread's last-error code value.</li><li>ExitWindowsEx: logs interactive user off, shuts down the system, or shuts down and restarts the system.</li></ul>
<figure><img class="Image--FullWidth" src="https://s3.ca-central-1.amazonaws.com/esentire-dot-com-assets/assetsV3/Blog/Blog-Images/DoubleZero-Picture9.png" style="max-width:80%;height:auto;width:auto;"/><figcaption>Exhibit 9: API calls via the appropriate DLLs</figcaption></figure>
<p>
</p>
<p>In addition to the API calls, the malware attempts to set the appropriate access control or full access rights to the following files to fill them with zeroes (Exhibit 10):</p>
<ul><li>BOOTMGR (boot manager) including BCD (Boot Configuration Data) file, which are responsible for Windows startup process.</li><li>BOOTSECT.BAK, which is a backup of the BOOTSECT.DOS. that is created by default by old Windows operating systems when any boot modifications take place.</li><li>pagefile.sys, which supports system crash dumps and used to manage virtual memory. </li><li>swapfile.sys, which is used in conjunction with pagefile.sys to free up the memory in RAM.</li></ul>
<figure><img class="Image--FullWidth" src="https://s3.ca-central-1.amazonaws.com/esentire-dot-com-assets/assetsV3/Blog/Blog-Images/DoubleZero-Picture10.png" style="max-width:80%;height:auto;width:auto;"/><figcaption>Exhibit 10: Modifying access control rights</figcaption></figure>
<h3>Data Destruction</h3>
<p>The NtFsControlFile is responsible for zeroing the data out with the IOCTL code FSCTL_SET_ZERO_DATA
(0x980c8) if it was able to open the file with NtOpenFile API (Exhibit 11). The number of bytes to be zeroed out are equal to the size of the file. </p>
<figure><img class="Image--FullWidth" src="https://s3.ca-central-1.amazonaws.com/esentire-dot-com-assets/assetsV3/Blog/Blog-Images/DoubleZero-Picture11.png" style="max-width:80%;height:auto;width:auto;"/><figcaption>Exhibit 11: API responsible for wiping the data</figcaption></figure>
<p>
</p>
<p>After the sample finishes executing, the system will automatically restart, and the user will get a prompt that the BCD
file is missing or corrupted (Exhibit 12). The executables need to be run as an Administrator for it to gain the full access to the system files and registry keys to proceed with deletion/wiping process. If the executables are opened as a user without UAC privilege elevation – the malware only wipes the files under C:\Users and the system shuts down after.</p>
<figure><img class="Image--FullWidth" src="https://s3.ca-central-1.amazonaws.com/esentire-dot-com-assets/assetsV3/Blog/Blog-Images/DoubleZero-Picture12.png" style="max-width:80%;height:auto;width:auto;"/><figcaption>Exhibit 12: Missing \Boot\BCD file (error)</figcaption></figure>
<h2>What eSentire is doing about it</h2>
<p>Our Threat Response Unit (TRU) combines threat intelligence gleaned from research, security incidents, and the external threat landscape to create actionable outcomes for our customers. We are taking a holistic response approach to combat modern destructive malware by deploying countermeasures, such as:</p>
<ul><li>Detections to identify and prevent Double Zero Wiper are in place across eSentire MDR for Endpoint and Log products</li><li>Threat hunts have been performed for indicators associated with DoubleZero malware</li></ul>
<h2>Recommendations from eSentire’s Threat Response Unit (TRU)</h2>
<p>We recommend implementing the following controls to help secure your organization against the DoubleZero malware:</p>
<ul><li>Confirm that all devices are protected with Endpoint Detection and Response (EDR) solutions</li><li>Implement a Cyber Security Awareness Training Program that educates the employees about the threat landscape</li><li>Ensure the role-based access control (RBAC) that restricts system access to authorized users is in place</li><li>Implement a Vulnerability Management Program that helps identify and prioritize high severity vulnerabilities. </li><li>Patch any external-facing applications and devices as well as enforce strong password policies</li></ul>
<p>While the Tactics, Techniques, and Procedures (TTPs) used by adversaries grow in sophistication, they lead to a limited set of choke points at which critical business decisions must be made. Intercepting the various attack paths utilized by the modern threat actor requires actively monitoring the threat landscape, developing, and deploying endpoint detection, and the ability to investigate logs &amp; network data during active intrusions.</p>
<p>eSentire’s Threat Response Unit (TRU) is a world-class team of threat researchers who develop new detections enriched by original threat intelligence and leverage new machine learning models that correlate multi-signal data and automate rapid response to advanced threats.</p>
<p>If you’re not currently engaged with an MDR provider, eSentire MDR can help you reclaim the advantage and put your business ahead of disruption.</p>
<p>Learn what it means to have an elite team of Threat Hunters and Researchers that works for you. <a href="https://www.esentire.com/get-started">Connect</a> with an eSentire Security Specialist.</p>
<h2>Appendix</h2>
<h3>Sources</h3>
<ul><li><a href="https://cert.gov.ua/article/38088">https://cert.gov.ua/article/38088</a></li><li><a href="https://docs.microsoft.com/en-us/dotnet/api/">https://docs.microsoft.com/en-us/dotnet/api/</a></li></ul>
<h3>Indicators of Compromise</h3>
<table class="table-bordered">
<tbody>
<tr>
<td>Name</td>
<td>File Hash (SHA-256)</td>
</tr>
<tr>
<td>Вирус... крайне опасно!!!.zip</td>
<td>d897f07ae6f42de8f35e2b05f5ef5733d7ec599d5e786d3225e66ca605a48f53</td>
</tr>
<tr>
<td>csrss.zip</td>
<td>8dd8b9bd94de1e72f0c400c5f32dcefc114cc0a5bf14b74ba6edc19fd4aeb2a5</td>
</tr>
<tr>
<td>cpcrs.exe (DoubleZero)</td>
<td>3b2e708eaa4744c76a633391cf2c983f4a098b46436525619e5ea44e105355fe</td>
</tr>
<tr>
<td>csrss.exe (DoubleZero)</td>
<td>30b3cbe8817ed75d8221059e4be35d5624bd6b5dc921d4991a7adc4c3eb5de4a</td>
</tr>
</tbody>
</table>
<h3>Yara Rules</h3>
import "pe"
import "math"
rule DoubleZero {
 meta:
 author = "eSentire TI"
 date = "03/24/2022"
 version = "1.0"
 strings:
 $file = "Microsoft.NET" wide fullword nocase // .NET binary
 $api1 = "NtFsControlFile" // send a control code to the file system 
 $api2 = "CreateDecryptor" // create the AES decryptor
 $api3 = "set_UseShellExecute" // use OS shell to start the process
 $api4 = "FsctlSetZeroData" // zero out the data 
 $access_api1 = "RtlAdjustPrivilege" // modify the privileges
 $access_api2 = "AddAccessRule" // add a rule to the list of rules within a FileSystemSecurity object
 condition:
 for any i in (0..pe.number_of_sections - 1): (
 math.entropy(pe.sections[i].raw_data_offset, pe.sections[i].raw_data_size) &gt;=4 
 and pe.sections[i].name == ".text" ) and
 all of ($api*) and all of ($access_api*) and $file and
 (uint16(0) == 0x5A4D or uint32(0) == 0x4464c457f)
 and filesize &lt; 500KB 
}
</div>