<div>
<p>
Adversaries don’t work 9-5 and neither do we. At eSentire, our <a href="https://www.esentire.com/what-we-do/security-operations-center">24/7 SOCs</a> are staffed with Elite Threat Hunters and Cyber Analysts who hunt, investigate, contain and respond to threats within minutes.
</p>
<p>We have discovered some of the most dangerous threats and nation state attacks in our space – including the Kaseya MSP breach and the more_eggs malware.</p>
<p>Our Security Operations Centers are supported with Threat Intelligence, Tactical Threat Response and Advanced Threat Analytics driven by our Threat Response Unit – the TRU team.</p>
<p>In TRU Positives, eSentire’s Threat Response Unit (TRU) provides a summary of a recent threat investigation. We outline how we responded to the confirmed threat and what recommendations we have going forward.</p>
<p>Here’s the latest from our TRU Team…</p>
<h2>What did we find?</h2>
<ul>
<li>UpdateAgent malware impacting a customer in the software industry, specific to Apple’s macOS operating system. </li><li>The malware is used to deliver additional payloads and maintain a persistent foothold on systems.</li><li>According to Microsoft, the malware has gone through several iterations since it first appeared in September 2020.</li><li>In a recent case, analysts identified a suspicious launch agent and traced it to a shell script matching UpdateAgent’s known behavior patterns and traits, including:<ol><li>Use of CloudFront domains for C2 communications and secondary payloads.</li><li>Collection of system information (see below).</li><li>Removal of quarantine bit from payloads to bypass Gatekeeper.</li><li>Establishing persistence by modifying property list files in the user’s /Library/LaunchAgents directory.</li><li>Removal of files from device to cover tracks.</li></ol></li><li>UpdateAgent is known to deliver adware as its second stage payload, but there is potential for more severe payload delivery.</li></ul>
<h2>Summary of UpdateAgent's Initiation Shell Script</h2>
<p>UpdateAgent collects information about the system and submits it to the C2 domain (hxxps://dgu8hufljhqqu[.]cloudfront[.]net/pkg) via HTTP POST request:</p>
<p>The information collected includes the active user, machine ID, operating system, and version.</p>
<figure><img class="MaxWidth" src="https://s3.ca-central-1.amazonaws.com/esentire-dot-com-assets/assetsV3/Blog/Blog-Images/March28_Picture1.png" style="max-width:80%;height:auto;width:auto;"/></figure>
<figure><img class="MaxWidth" src="https://s3.ca-central-1.amazonaws.com/esentire-dot-com-assets/assetsV3/Blog/Blog-Images/March28_Picture2.png" style="max-width:80%;height:auto;width:auto;"/></figure>
<p>Then it, retrieves a DMG file from
hxxps://duh59xv2mx0nn[.]cloudfront[.]net, adds the current user to the ‘sudoers’
file and disables the password prompt:</p>
<figure><img class="MaxWidth" src="https://s3.ca-central-1.amazonaws.com/esentire-dot-com-assets/assetsV3/Blog/Blog-Images/March28_Picture3.png" style="max-width:80%;height:auto;width:auto;"/></figure>
<p>Next, it clears extended attributes on the DMG file to <a href="https://attack.mitre.org/techniques/T1553/001/">bypass Gatekeeper</a>,
which is a security feature in macOS aimed at reducing the likelihood of users
accidentally running malware downloaded from the internet. </p>
<p>Similar to the Mark-of-Web attribute in Windows, macOS
applications (such as browsers) add an extended attribute known as a quarantine
flag to files downloaded from the internet. UpdateAgent clears all extended
attributes (including the quarantine flag) using the <a href="https://ss64.com/osx/xattr.html">xattr</a> command.</p>
<figure><img class="MaxWidth" src="https://s3.ca-central-1.amazonaws.com/esentire-dot-com-assets/assetsV3/Blog/Blog-Images/March28_Picture4.png" style="max-width:80%;height:auto;width:auto;"/></figure>
<p>Then, it uses PlistBuddy in direct mode to add arguments to
a property list file. (com.shenbfgbvgsfssfmrynamdzyetzfnd.plist) under the
user’s /Library/LaunchAgents/ folder for persistence:</p>
<figure><img class="MaxWidth" src="https://s3.ca-central-1.amazonaws.com/esentire-dot-com-assets/assetsV3/Blog/Blog-Images/March28_Picture5.png" style="max-width:80%;height:auto;width:auto;"/></figure>
<p>Lastly, the cleanup actions show as follows:</p>
<figure><img class="MaxWidth" src="https://s3.ca-central-1.amazonaws.com/esentire-dot-com-assets/assetsV3/Blog/Blog-Images/March28_Picture6.png" style="max-width:80%;height:auto;width:auto;"/></figure>
<h2>How did we find it? </h2>
<ul><li>Our <a href="https://www.esentire.com/how-we-do-it/signals/endpoint">MDR for Endpoint</a>
service identified the launch agent persistence technique. </li></ul>
<h2>What did we do? </h2>
<ul><li>Our <a href="https://www.esentire.com/what-we-do/security-operations-center">24/7 SOC</a>
cyber analysts alerted the customer, isolated the host and provided details of the infection to assist with remediation.</li></ul>
<h2>What can you learn from this TRU positive?</h2>
<ul><li>UpdateAgent is initiated by macOS users installing malicious software masquerading as legitimate applications.</li><li>UpdateAgent has seen continuous improvement since it first emerged.</li><li>While adware payloads may seem low-risk, the potential for follow-on malware exists.<ul><li>Additionally, the information collected and sent via UpdateAgent’s heartbeat mechanism could be used to target the system for follow-on attacks.</li></ul></li></ul>
<h2>Recommendations from our Threat Response Unit (TRU) Team:</h2>
<ul><li>Encourage good security hygiene among your users through <a href="https://www.esentire.com/what-we-do/managed-vulnerability-and-risk/technical-testing/security-awareness-training-managed-phishing-training">phishing and security awareness training</a>.<ul><li>Only download and install applications from trusted locations.<ul><li>For additional protection, validate the file hash if the vendor provides the hash information</li></ul></li><li>Ignore unsolicited pop-ups or application download requests. Do not click on the unsolicited pop-up links. </li></ul></li><li>Monitor for modifications to plist files in auto-run locations such as /Library/LaunchAgents/.</li><li>Restrict access/monitor for changes to sudoers file and launch agents folders.</li></ul>
<h2>Ask Yourself</h2>
<ol><li>What level of visibility do you have across your network, endpoint, and overall environment to detect malicious behavior at scale?</li>
<li>What level of managed endpoint support do you have in place?</li>
<li>What level of managed endpoint support do you have in place? </li>
<li>Are you monitoring your endpoints 24/7 and what degree of control do you have to initiate a kill switch when required?</li></ol>
<h2>Indicators of Compromise </h2>
<table class="table-bordered">
<tbody>
<tr>
<td>Indicator</td>
<td>“Note</td>
</tr>
<tr>
<td>28C2FF8C6F78EB61361DECE949108910</td>
<td>Initiation Shell Script</td>
</tr>
<tr>
<td>dgu8hufljhqqu[.]cloudfront[.]net</td>
<td>Command and Control</td>
</tr>
<tr>
<td>duh59xv2mx0nn[.]cloudfront[.]net</td>
<td>Payload Hosting</td>
</tr>
</tbody>
</table>
<p>eSentire’s Threat Response Unit (TRU) is a world-class team of threat researchers who develop new detections enriched by original threat intelligence and leverage new machine learning models that correlate multi-signal data and automate rapid response to advanced threats.
If you are not currently engaged with an MDR provider, eSentire MDR can help you reclaim the advantage and put your business ahead of disruption.</p>
<p>Learn what it means to have an elite team of Threat Hunters and Researchers that works for you. <a href="https://www.esentire.com/get-started" rel="noreferrer" target="_blank">Connect</a> with an eSentire Security Specialist.</p>
</div>