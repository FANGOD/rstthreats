{
    "id": "<report_0x428d3be9>",
    "url": "https://elastic.github.io/security-research/intelligence/2022/05/04.bpfdoor/article",
    "title": "A peek behind the BPFDoor",
    "meta": [],
    "chapters": [
        {
            "id": "<chapter_0xf2bf1812>",
            "title": "A peek behind the BPFDoor",
            "title_level": 1,
            "sentences": [
                {
                    "id": "<sentence_0x7f27644b>",
                    "is_empty": true,
                    "have_tags": true,
                    "tags": {
                        "<img_0x31c91314>": "https://avatars.githubusercontent.com/u/48036388?v=4",
                        "<img_0xe03f8149>": "https://avatars.githubusercontent.com/u/5386353?v=4",
                        "<img_0x743cdee0>": "https://avatars.githubusercontent.com/u/91164188?v=4",
                        "<img_0x3692b197>": "https://avatars.githubusercontent.com/u/18609142?v=4"
                    },
                    "text": "",
                    "html": "<p>\n<img alt=\"@DefSecSentinel\" class=\"avatar\" src=\"https://avatars.githubusercontent.com/u/48036388?v=4\"/>\n<img alt=\"@tabell\" class=\"avatar\" src=\"https://avatars.githubusercontent.com/u/5386353?v=4\"/>\n<img alt=\"@rhysre\" class=\"avatar\" src=\"https://avatars.githubusercontent.com/u/91164188?v=4\"/>\n<img alt=\"@jtnk\" class=\"avatar\" src=\"https://avatars.githubusercontent.com/u/18609142?v=4\"/>\n</p>"
                },
                {
                    "id": "<sentence_0xdf8e84cc>",
                    "is_empty": false,
                    "have_tags": true,
                    "tags": {
                        "<a_0x3df198ef>": "https://github.com/DefSecSentinel",
                        "<a_0xb04c94c0>": "https://github.com/tabell",
                        "<a_0x21ab8a64>": "https://github.com/rhysre",
                        "<a_0x72431925>": "https://github.com/jtnk"
                    },
                    "text": "Colson Wilhoit @DefSecSentinel<crlf>|<crlf><crlf>Alex Bell @tabell<crlf>|<crlf><crlf>Rhys Rustad-Elliott @rhysre<crlf>|<crlf><crlf>Jake King @jtnk<crlf>2022-05-17",
                    "html": "<p>\nColson Wilhoit \u00b7 <a class=\"magiclink magiclink-github magiclink-mention\" href=\"https://github.com/DefSecSentinel\" title=\"GitHub User: DefSecSentinel\">@DefSecSentinel</a>\n | \n \n Alex Bell \u00b7 <a class=\"magiclink magiclink-github magiclink-mention\" href=\"https://github.com/tabell\" title=\"GitHub User: tabell\">@tabell</a>\n | \n \n Rhys Rustad-Elliott \u00b7 <a class=\"magiclink magiclink-github magiclink-mention\" href=\"https://github.com/rhysre\" title=\"GitHub User: rhysre\">@rhysre</a>\n | \n \n Jake King \u00b7 <a class=\"magiclink magiclink-github magiclink-mention\" href=\"https://github.com/jtnk\" title=\"GitHub User: jtnk\">@jtnk</a>\n 2022-05-17\n \n</p>"
                }
            ]
        },
        {
            "id": "<chapter_0x90badd6e>",
            "title": "A peek behind the BPFDoor",
            "title_level": 1,
            "sentences": []
        },
        {
            "id": "<chapter_0xc5ddcb46>",
            "title": "Preamble",
            "title_level": 2,
            "sentences": [
                {
                    "id": "<sentence_0x5eee637d>",
                    "is_empty": false,
                    "have_tags": true,
                    "tags": {
                        "<a_0x3d17dcbb>": "https://doublepulsar.com/bpfdoor-an-active-chinese-global-surveillance-tool-54b078f1a896",
                        "<a_0xeea61a27>": "https://www.pwc.com/gx/en/issues/cybersecurity/cyber-threat-intelligence/cyber-year-in-retrospect/yir-cyber-threats-report-download.pdf"
                    },
                    "text": "BPFDoor is a backdoor payload specifically crafted for Linux. Its purpose is for long-term persistence in order to gain re-entry into a previously or actively compromised target environment. It notably utilizes BPF along with a number of other techniques to achieve this goal, taking great care to be as efficient and stealthy as possible. PWC researchers discovered this very interesting piece of malware in 2021. PWC attributes this back door to a specific group from China, Red Menshen, and detailed a number of interesting components in a high-level threat research post released last week.",
                    "html": "<p><a href=\"https://doublepulsar.com/bpfdoor-an-active-chinese-global-surveillance-tool-54b078f1a896\">BPFDoor</a> is a backdoor payload specifically crafted for Linux. Its purpose is for long-term persistence in order to gain re-entry into a previously or actively compromised target environment. It notably utilizes BPF along with a number of other techniques to achieve this goal, taking great care to be as efficient and stealthy as possible. PWC researchers discovered this very interesting piece of malware in 2021. PWC attributes this back door to a specific group from China, Red Menshen, and detailed a number of interesting components in a high-level threat research post released <a href=\"https://www.pwc.com/gx/en/issues/cybersecurity/cyber-threat-intelligence/cyber-year-in-retrospect/yir-cyber-threats-report-download.pdf\">last week</a>.</p>"
                },
                {
                    "id": "<sentence_0xe5785a2f>",
                    "is_empty": false,
                    "have_tags": false,
                    "tags": {},
                    "text": "PWCs findings indicated that Red Menshen had focused their efforts on targeting specific Telecommunications, Government, Logistics, and Education groups across the Middle East and Asia. This activity has been across a Monday-to-Friday working period, between 01:00 UTC and 10:00 UTC, indicating that the operators of the malware were consistent in their attacks, and operation during a working week.",
                    "html": "<p>PWC\u2019s findings indicated that \u200b\u200bRed Menshen had focused their efforts on targeting specific Telecommunications, Government, Logistics, and Education groups across the Middle East and Asia. This activity has been across a Monday-to-Friday working period, between 01:00 UTC and 10:00 UTC, indicating that the operators of the malware were consistent in their attacks, and operation during a working week.</p>"
                },
                {
                    "id": "<sentence_0x4bf88938>",
                    "is_empty": false,
                    "have_tags": false,
                    "tags": {},
                    "text": "Perhaps most concerningly, the payload itself has been observed across the last 5 years in various phases of development and complexity, indicating that the threat actor responsible for operating the malware has been at it for some time, undetected in many environments.",
                    "html": "<p>Perhaps most concerningly, the payload itself has been observed across the last 5 years in various phases of development and complexity, indicating that the threat actor responsible for operating the malware has been at it for some time, undetected in many environments.</p>"
                },
                {
                    "id": "<sentence_0x5793e684>",
                    "is_empty": false,
                    "have_tags": false,
                    "tags": {},
                    "text": "BPFDoor Tools",
                    "html": "<p class=\"admonition-title\">BPFDoor Tools</p>"
                },
                {
                    "id": "<sentence_0xcb1aefef>",
                    "is_empty": false,
                    "have_tags": false,
                    "tags": {},
                    "text": "The Elastic Security Team has created a few tools that will aid researchers in analyzing the BPFDoor malware.",
                    "html": "<p>The Elastic Security Team has created a few tools that will aid researchers in analyzing the BPFDoor malware.</p>"
                },
                {
                    "id": "<sentence_0x59f18385>",
                    "is_empty": false,
                    "have_tags": false,
                    "tags": {},
                    "text": "The BPFDoor scanner will allow you to scan for hosts infected with the BPFDoor malware and the BPFDoor configuration extractor will allow you to extrapolate the malwares configuration or hardcoded values which can lead to additional observations you can use for further analysis, developing additional signatures or connecting to the backdoor utilizing our client.",
                    "html": "<p>The BPFDoor scanner will allow you to scan for hosts infected with the BPFDoor malware and the BPFDoor configuration extractor will allow you to extrapolate the malware\u2019s configuration or hardcoded values which can lead to additional observations you can use for further analysis, developing additional signatures or connecting to the backdoor utilizing our client.</p>"
                },
                {
                    "id": "<sentence_0x108c7a47>",
                    "is_empty": false,
                    "have_tags": true,
                    "tags": {
                        "<a_0xc6fddb42>": "../../../../../tools/bpfdoor-scanner/",
                        "<a_0x5356de0b>": "../../../../../tools/bpfdoor-config-extractor/"
                    },
                    "text": "BPFDoor scanner<crlf>BPFDoor configuration extractor",
                    "html": "<ul>\n<li><a href=\"../../../../../tools/bpfdoor-scanner/\">BPFDoor scanner</a></li>\n<li><a href=\"../../../../../tools/bpfdoor-config-extractor/\">BPFDoor configuration extractor</a></li>\n</ul>"
                }
            ]
        },
        {
            "id": "<chapter_0x7ab0cc94>",
            "title": "General Analysis",
            "title_level": 2,
            "sentences": [
                {
                    "id": "<sentence_0xb2c4deb7>",
                    "is_empty": false,
                    "have_tags": true,
                    "tags": {
                        "<a_0x3d17dcbb>": "https://doublepulsar.com/bpfdoor-an-active-chinese-global-surveillance-tool-54b078f1a896"
                    },
                    "text": "Red Menshen has leveraged a network of VPS servers to act as a controller network and access these systems via compromised routers based out of Taiwan. The routers act as a VPN network for the adversarial groups via a sequence of specifically crafted packets sent to an infected host. Researchers have indicated that this payload is pervasive and that compromised hosts have been observed across the US, South Korea, Hong Kong, Turkey, India, Vietnam, and Myanmar.",
                    "html": "<p>Red Menshen has leveraged a network of VPS servers to act as a controller network and access these systems via compromised routers based out of Taiwan. The routers act as a VPN network for the adversarial groups via a sequence of specifically crafted packets sent to an infected host. <a href=\"https://doublepulsar.com/bpfdoor-an-active-chinese-global-surveillance-tool-54b078f1a896\">Researchers</a> have indicated that this payload is pervasive and that compromised hosts have been observed across the US, South Korea, Hong Kong, Turkey, India, Vietnam, and Myanmar.</p>"
                },
                {
                    "id": "<sentence_0xa8051e6e>",
                    "is_empty": false,
                    "have_tags": true,
                    "tags": {
                        "<a_0x3d17dcbb>": "https://doublepulsar.com/bpfdoor-an-active-chinese-global-surveillance-tool-54b078f1a896",
                        "<a_0xfacf1964>": "https://www.pangulab.cn/en/post/the_bvp47_a_top-tier_backdoor_of_us_nsa_equation_group/"
                    },
                    "text": "BPF-based malware payloads, while ultimately uncommon, serve a specific purpose on Linux-based hosts where stealthy and performant operations are critical for success. Tools such as BPFDoor are not alone. Recently, Pangu Labs discovered a payload by the name of Bvp47, a sensor that used stealthy BPF-based telemetry to acquire detailed information about the workloads running on infected hosts.",
                    "html": "<p>BPF-based malware payloads, while ultimately uncommon, serve a specific purpose on Linux-based hosts where stealthy and performant operations are critical for success. Tools such as <a href=\"https://doublepulsar.com/bpfdoor-an-active-chinese-global-surveillance-tool-54b078f1a896\">BPFDoor</a> are not alone. Recently, <a href=\"https://www.pangulab.cn/en/post/the_bvp47_a_top-tier_backdoor_of_us_nsa_equation_group/\">Pangu Labs</a> discovered a payload by the name of <a href=\"https://www.pangulab.cn/en/post/the_bvp47_a_top-tier_backdoor_of_us_nsa_equation_group/\">Bvp47</a>, a sensor that used stealthy BPF-based telemetry to acquire detailed information about the workloads running on infected hosts.</p>"
                },
                {
                    "id": "<sentence_0x7fb04fe9>",
                    "is_empty": false,
                    "have_tags": true,
                    "tags": {
                        "<a_0xc88a3dad>": "https://ebpf.io/"
                    },
                    "text": "eBPF (Extended Berkeley Packet Filters), a new evolution of BPF used increasingly today, is gaining popularity amongst system operators given its efficiency and proven, powerful capabilities leveraged often for system performance, network, and security telemetry collection. Adversaries are taking note and it is our assumption that malware targeting cloud systems will increasingly leverage these methods in the future.",
                    "html": "<p><a href=\"https://ebpf.io/\">eBPF</a> (Extended Berkeley Packet Filters), a new evolution of BPF used increasingly today, is gaining popularity amongst system operators given its efficiency and proven, powerful capabilities leveraged often for system performance, network, and security telemetry collection. Adversaries are taking note and it is our assumption that malware targeting cloud systems will increasingly leverage these methods in the future.</p>"
                }
            ]
        },
        {
            "id": "<chapter_0x52783feb>",
            "title": "Attack Lifecycle",
            "title_level": 2,
            "sentences": [
                {
                    "id": "<sentence_0x39eecc08>",
                    "is_empty": false,
                    "have_tags": false,
                    "tags": {},
                    "text": "This inherently passive backdoor payload is built to be a form of persistence a method to regain access if the first or second stage payloads are lost. It is built for and intended to be installed on high-uptime servers or appliances, IoT/SCADA, or cloud systems with access to the Internet. The backdoor usually sits in temporary storage so if a server were to be rebooted or shut down, the backdoor would be lost.",
                    "html": "<p>This inherently passive backdoor payload is built to be a form of persistence \u2013 a method to regain access if the first or second stage payloads are lost. It is built for and intended to be installed on high-uptime servers or appliances, IoT/SCADA, or cloud systems with access to the Internet. The backdoor usually sits in temporary storage so if a server were to be rebooted or shut down, the backdoor would be lost.</p>"
                },
                {
                    "id": "<sentence_0xa3820bec>",
                    "is_empty": false,
                    "have_tags": false,
                    "tags": {},
                    "text": "It should be assumed that if this malware is found on a system the initial-access (1st stage) or post-exploitation (2nd stage) payloads are still most likely present and possibly active elsewhere in the environment. This backdoor excels at stealth, taking every opportunity to blend in and remain undetected.",
                    "html": "<p>It should be assumed that if this malware is found on a system the initial-access (1st stage) or post-exploitation (2nd stage) payloads are still most likely present and possibly active elsewhere in the environment. This backdoor excels at stealth, taking every opportunity to blend in and remain undetected.</p>"
                },
                {
                    "id": "<sentence_0x663e1dfd>",
                    "is_empty": false,
                    "have_tags": false,
                    "tags": {},
                    "text": "In the below steps, we will break BPFDoors actions down according to the vast majority of the samples available.",
                    "html": "<p>In the below steps, we will break BPFDoor\u2019s actions down according to the vast majority of the samples available.</p>"
                },
                {
                    "id": "<sentence_0x7309ba5c>",
                    "is_empty": false,
                    "have_tags": true,
                    "tags": {
                        "<a_0x92548a09>": "https://attack.mitre.org/techniques/T1070/006/",
                        "<a_0x53f7d2c9>": "https://www.kernel.org/doc/html/v5.12/networking/filter.html"
                    },
                    "text": "When executed the binary copies itself into /dev/shm/. A temporary filesystem /dev/shm stands for shared memory and is a temporary file storage facility serving as an efficient means of inter-process communication<crlf>Renames its process to kdmtmpflush, a hardcoded process name<crlf>Initializes itself with the -init flag and forks itself. Forking in Linux means creating a new process by duplicating the calling process<crlf>Deletes itself by removing the original binary invoked. The forked process continues to run<crlf>Alters the forked processes creation and modification time values, also known as timestomping<crlf>Creates a new process environment for itself and removes the old one setting (spoofing) a new process name. It changes the way it appears on the system akin to wearing a mask. The process is still kdmtmpflush but if you were to run a ps you would see whatever value it set<crlf>Creates a process ID (PID) file in /var/run. PID files are text files containing the process of the associated program meant for preventing multiple starts, marking residency, and used by the program to stop itself. This file resides in /var/run, another temporary file storage facility<crlf>Creates a raw network socket. On Linux, a socket is an endpoint for network communication that allows you to specify in detail every section of a packet allowing a user to implement their own transport layer protocol above the internet (IP) level<crlf>Sets BPF filters on the raw socket. BPF allows a user-space program to attach a filter onto any socket and allow or disallow certain types of data to come through the socket<crlf>Observes incoming packets<crlf>If a packet is observed that matches the BPF filters and contains the required data it is passed to the backdoor for processing<crlf>It forks the current process again<crlf>Changes the forked processes working directory to /<crlf>Changes (spoofs) the name of the forked process to a hardcoded value<crlf>Based on the password or existence of a password sent in the magic packet the backdoor provides a reverse shell, establishes a bind shell, or sends back a ping",
                    "html": "<ol>\n<li>When executed the binary copies itself into <code>/dev/shm/</code>. A temporary filesystem <code>/dev/shm</code> stands for shared memory and is a temporary file storage facility serving as an efficient means of inter-process communication</li>\n<li>Renames its process to <code>kdmtmpflush</code>, a hardcoded process name</li>\n<li>Initializes itself with the <code>-init</code> flag and forks itself. Forking in Linux means creating a new process by duplicating the calling process</li>\n<li>Deletes itself by removing the original binary invoked. The forked process continues to run</li>\n<li>Alters the forked processes\u2019 creation and modification time values, also known as <a href=\"https://attack.mitre.org/techniques/T1070/006/\">timestomping</a></li>\n<li>Creates a new process environment for itself and removes the old one setting (spoofing) a new process name. It changes the way it appears on the system akin to wearing a mask. The process is still <code>kdmtmpflush</code> but if you were to run a ps you would see whatever value it set</li>\n<li>Creates a process ID (PID) file in <code>/var/run</code>. PID files are text files containing the process of the associated program meant for preventing multiple starts, marking residency, and used by the program to stop itself. This file resides in <code>/var/run</code>, another temporary file storage facility</li>\n<li>Creates a raw network socket. On Linux, a socket is an endpoint for network communication that allows you to specify in detail every section of a packet allowing a user to implement their own transport layer protocol above the internet (IP) level</li>\n<li>Sets BPF filters on the raw socket. <a href=\"https://www.kernel.org/doc/html/v5.12/networking/filter.html\">BPF</a> allows a user-space program to attach a filter onto any socket and allow or disallow certain types of data to come through the socket</li>\n<li>Observes incoming packets</li>\n<li>If a packet is observed that matches the BPF filters and contains the required data it is passed to the backdoor for processing</li>\n<li>It forks the current process again</li>\n<li>Changes the forked processes working directory to <code>/</code></li>\n<li>Changes (spoofs) the name of the forked process to a hardcoded value</li>\n<li>Based on the password or existence of a password sent in the \u201cmagic packet\u201d the backdoor provides a reverse shell, establishes a bind shell, or sends back a ping</li>\n</ol>"
                },
                {
                    "id": "<sentence_0xf3437d54>",
                    "is_empty": false,
                    "have_tags": false,
                    "tags": {},
                    "text": "Atypical BPFDoor sample",
                    "html": "<p class=\"admonition-title\">Atypical BPFDoor sample</p>"
                },
                {
                    "id": "<sentence_0xf045e09b>",
                    "is_empty": false,
                    "have_tags": true,
                    "tags": {
                        "<a_0x9df0ff9d>": "https://www.virustotal.com/gui/file/07ecb1f2d9ffbd20a46cd36cd06b022db3cc8e45b1ecab62cd11f9ca7a26ab6d/detection"
                    },
                    "text": "Of note there is one sample we have come across that does not seem to exhibit steps 1 - 4. It doesnt alter its initial name to a hardcoded value and simply executes from its placed location, otherwise, it models the same behavior.",
                    "html": "<p>Of note there is one <a href=\"https://www.virustotal.com/gui/file/07ecb1f2d9ffbd20a46cd36cd06b022db3cc8e45b1ecab62cd11f9ca7a26ab6d/detection\">sample</a> we have come across that does not seem to exhibit steps 1 - 4. It doesn\u2019t alter its initial name to a hardcoded value and simply executes from its placed location, otherwise, it models the same behavior.</p>"
                },
                {
                    "id": "<sentence_0x3b804478>",
                    "is_empty": false,
                    "have_tags": false,
                    "tags": {},
                    "text": "Below you can see visual representations of the BPFDoor process tree, utilizing Elastics Analyzer View. The first image displays the tree prior to active use of the backdoor (i.e reverse shell, bind shell, or pingback) and the second image after a reverse shell has connected and performed post-exploitation activities.",
                    "html": "<p>Below you can see visual representations of the BPFDoor process tree, utilizing Elastic\u2019s Analyzer View. The first image displays the tree prior to active use of the backdoor (i.e reverse shell, bind shell, or pingback) and the second image after a reverse shell has connected and performed post-exploitation activities. </p>"
                },
                {
                    "id": "<sentence_0x76a0ec23>",
                    "is_empty": false,
                    "have_tags": true,
                    "tags": {
                        "<img_0x39290e90>": "../media/image12.png"
                    },
                    "text": "Elastic Analyzer View of the BPFDoor initial invocation process tree",
                    "html": "<figure>\n<p><img alt=\"Elastic Analyzer View of the BPFDoor initial invocation process tree\" src=\"../media/image12.png\" title=\"Elastic Analyzer View of the BPFDoor initial invocation process tree\"/></p>\n<figcaption>Elastic Analyzer View of the BPFDoor initial invocation process tree</figcaption>\n</figure>"
                },
                {
                    "id": "<sentence_0xea7608f>",
                    "is_empty": false,
                    "have_tags": true,
                    "tags": {
                        "<img_0x162cc23f>": "../media/image1.png"
                    },
                    "text": "Elastic Analyzer View of BPFDoor following a reverse shell connection and post exploitation actions",
                    "html": "<figure>\n<p><img alt=\"Elastic Analyzer View of BPFDoor following a reverse shell connection and post exploitation actions\" src=\"../media/image1.png\" title=\"Elastic Analyzer View of BPFDoor following a reverse shell connection and post exploitation actions\"/></p>\n<figcaption>Elastic Analyzer View of BPFDoor following a reverse shell connection and post exploitation actions</figcaption>\n</figure>"
                }
            ]
        },
        {
            "id": "<chapter_0xe0f62a01>",
            "title": "Defense Evasion Insights",
            "title_level": 2,
            "sentences": [
                {
                    "id": "<sentence_0xac1af578>",
                    "is_empty": false,
                    "have_tags": true,
                    "tags": {
                        "<code_0xcef8fa21>": "ps ajxf"
                    },
                    "text": "BPFDoor is interesting given the anti-forensics, and obfuscation tactics used. Astute readers will observe slight differences in the PID tree visible when running a ps ajxf on an infected host when compared to executed data within the Analyzer View inside of Elastic. This is due to the process name spoofing mentioned in step 6 (above) of the attack lifecycle above. The image below is taken from a system running BPFDoor with an active reverse shell connection established:",
                    "html": "<p>BPFDoor is interesting given the anti-forensics, and obfuscation tactics used. Astute readers will observe slight differences in the PID tree visible when running a <code>ps ajxf</code> on an infected host when compared to executed data within the Analyzer View inside of Elastic. This is due to the process name spoofing mentioned in step 6 (above) of the attack lifecycle above. The image below is taken from a system running BPFDoor with an active reverse shell connection established:</p>"
                },
                {
                    "id": "<sentence_0x16b8c317>",
                    "is_empty": false,
                    "have_tags": true,
                    "tags": {
                        "<img_0xb6844a14>": "../media/image4.png"
                    },
                    "text": "An observed running process created by the BPFDoor reverse shell",
                    "html": "<figure>\n<p><img alt=\"An observed running process created by the BPFDoor reverse shell\" src=\"../media/image4.png\" title=\"An observed running process created by the BPFDoor reverse shell\"/></p>\n<figcaption>An observed running process created by the BPFDoor reverse shell</figcaption>\n</figure>"
                },
                {
                    "id": "<sentence_0xaf008ab7>",
                    "is_empty": false,
                    "have_tags": true,
                    "tags": {
                        "<code_0xfa0b631>": "kdmtmpflush",
                        "<code_0x62918143>": "sh"
                    },
                    "text": "The difference lies in the fact that kdmtmpflush and sh are run prior to spoofing, and are captured at runtime by Elastic Endpoint. This is an accurate representation of the processes active on the host, further confirming the importance of appropriate observation software for Linux hosts - you cant always trust what you see on the local system:",
                    "html": "<p>The difference lies in the fact that <code>kdmtmpflush</code> and <code>sh</code> are run prior to spoofing, and are captured at runtime by Elastic Endpoint. This is an accurate representation of the processes active on the host, further confirming the importance of appropriate observation software for Linux hosts - you can\u2019t always trust what you see on the local system:</p>"
                },
                {
                    "id": "<sentence_0x4f29d4ca>",
                    "is_empty": false,
                    "have_tags": true,
                    "tags": {
                        "<img_0x475b0ea1>": "../media/image7.png"
                    },
                    "text": "Elastic Analyzer View of BPFDoor demonstrating real process capture.",
                    "html": "<figure>\n<p><img alt=\"Elastic Analyzer View of BPFDoor demonstrating real process capture.\" src=\"../media/image7.png\" title=\"Elastic Analyzer View of BPFDoor demonstrating real process capture.\"/></p>\n<figcaption>Elastic Analyzer View of BPFDoor demonstrating real process capture.</figcaption>\n</figure>"
                },
                {
                    "id": "<sentence_0xd63e777>",
                    "is_empty": false,
                    "have_tags": false,
                    "tags": {},
                    "text": "BPFDoor also holds in its repertoire the ability to subvert the traditional Linux socket client - server architecture in order to hide its malicious traffic. The methods which it utilizes to achieve this are both unusual and intriguing.",
                    "html": "<p>BPFDoor also holds in its repertoire the ability to subvert the traditional Linux socket client - server architecture in order to hide its malicious traffic. The methods which it utilizes to achieve this are both unusual and intriguing.</p>"
                },
                {
                    "id": "<sentence_0x59aabbb>",
                    "is_empty": false,
                    "have_tags": false,
                    "tags": {},
                    "text": "The sockets interface is almost synonmous with TCP/IP communication. This simple interface has endured for over 40 years - predating both Linux and Windows implementations.",
                    "html": "<p>The sockets interface is almost synonmous with TCP/IP communication. This simple interface has endured for over 40 years - predating both Linux and Windows implementations.</p>"
                },
                {
                    "id": "<sentence_0x28bf01e6>",
                    "is_empty": false,
                    "have_tags": true,
                    "tags": {
                        "<img_0x9ce2538c>": "../media/image3.png"
                    },
                    "text": "Example of how TCP/IP and socket interfaces function",
                    "html": "<figure>\n<p><img alt=\"Example of how TCP/IP and socket interfaces function\" src=\"../media/image3.png\" title=\"Example of how TCP/IP and socket interfaces function\"/></p>\n<figcaption>Example of how TCP/IP and socket interfaces function</figcaption>\n</figure>"
                },
                {
                    "id": "<sentence_0x32d07f6>",
                    "is_empty": false,
                    "have_tags": false,
                    "tags": {},
                    "text": "BPFDoor uses a raw socket (as opposed to cooked ones that handle IP/TCP/UDP headers transparently) to observe every packet arriving at the machine, ethernet frame headers and all. While this might sound like a stealthy way to intercept traffic, its actually not on any machine with a significant amount of network traffic the CPU usage will be consistently high.",
                    "html": "<p>BPFDoor uses a raw socket (as opposed to \u2018cooked\u2019 ones that handle IP/TCP/UDP headers transparently) to observe every packet arriving at the machine, ethernet frame headers and all. While this might sound like a stealthy way to intercept traffic, it\u2019s actually not \u2013 on any machine with a significant amount of network traffic the CPU usage will be consistently high.</p>"
                },
                {
                    "id": "<sentence_0xe8efb00d>",
                    "is_empty": false,
                    "have_tags": false,
                    "tags": {},
                    "text": "Thats where BPF comes in - an extremely efficient, kernel-level packet filter is the perfect tool to allow the implant to ignore 99% of network traffic and only become activated when a special pattern is encountered. This implant looks for a so-called magic packet in every TCP, UDP and ICMP packet received on the system.",
                    "html": "<p>That\u2019s where BPF comes in - an extremely efficient, kernel-level packet filter is the perfect tool to allow the implant to ignore 99% of network traffic and only become activated when a special pattern is encountered. This implant looks for a so-called magic packet in every TCP, UDP and ICMP packet received on the system.</p>"
                },
                {
                    "id": "<sentence_0x1bebb82d>",
                    "is_empty": false,
                    "have_tags": false,
                    "tags": {},
                    "text": "Once activated, a typical reverse shell - which this back door also supports - creates an outbound connection to a listener set up by the attacker. This has the advantage of bypassing firewalls watching inbound traffic only. This method is well-understood by defenders, however. The sneakiest way to get a shell connected would be to reuse an existing packet flow, redirected to a separate process.",
                    "html": "<p>Once activated, a typical reverse shell - which this back door also supports - creates an outbound connection to a listener set up by the attacker. This has the advantage of bypassing firewalls watching inbound traffic only. This method is well-understood by defenders, however. The sneakiest way to get a shell connected would be to reuse an existing packet flow, redirected to a separate process.</p>"
                },
                {
                    "id": "<sentence_0x71701335>",
                    "is_empty": false,
                    "have_tags": false,
                    "tags": {},
                    "text": "In this attack, the initial TCP handshake is done between the attacker and a completely legitimate process for example nginx or sshd. These handshake packets happen to be also delivered to the backdoor (like every packet on the system) but are filtered out by BPF. Once the connection is established, however, BPFDoor sends a magic packet to the legitimate service. The implant receives it and makes a note of the originating IP and port the attacker is using, and it opens a new listening socket on an inconspicuous port (42391 - 43391).",
                    "html": "<p>In this attack, the initial TCP handshake is done between the attacker and a completely legitimate process \u2013 for example nginx or sshd. These handshake packets happen to be also delivered to the backdoor (like every packet on the system) but are filtered out by BPF. Once the connection is established, however, BPFDoor sends a magic packet to the legitimate service. The implant receives it and makes a note of the originating IP and port the attacker is using, and it opens a new listening socket on an inconspicuous port (42391 - 43391).</p>"
                },
                {
                    "id": "<sentence_0x68fcdb61>",
                    "is_empty": false,
                    "have_tags": false,
                    "tags": {},
                    "text": "The implant then reconfigures the firewall to temporarily redirect all traffic from the attackers IP/port combination to the new listening socket. The attacker initiates a second TCP handshake on the same legitimate port as before, only now iptables forwards those packets to the listening socket owned by the implant. . This establishes the communication channel between attacker and implant that will be used for command and control. The implant then covers its tracks by removing the iptables firewall rules that redirected the traffic.",
                    "html": "<p>The implant then reconfigures the firewall to temporarily redirect all traffic from the attacker\u2019s IP/port combination to the new listening socket. The attacker initiates a second TCP handshake on the same legitimate port as before, only now iptables forwards those packets to the listening socket owned by the implant. . This establishes the communication channel between attacker and implant that will be used for command and control. The implant then covers its tracks by removing the iptables firewall rules that redirected the traffic.</p>"
                },
                {
                    "id": "<sentence_0xb305bdfc>",
                    "is_empty": false,
                    "have_tags": false,
                    "tags": {},
                    "text": "Despite the firewall rule being removed, traffic on the legitimate port will continue to be forwarded to the implant due to how Linux statefully tracks connections. No visible traffic will be addressed to the implant port (although it will be delivered there).",
                    "html": "<p>Despite the firewall rule being removed, traffic on the legitimate port will continue to be forwarded to the implant due to how Linux statefully tracks connections. No visible traffic will be addressed to the implant port (although it will be delivered there).</p>"
                },
                {
                    "id": "<sentence_0x6864b953>",
                    "is_empty": false,
                    "have_tags": true,
                    "tags": {
                        "<img_0x53b21a6b>": "../media/image14.png"
                    },
                    "text": "A diagram representing the aforementioned network flows",
                    "html": "<figure>\n<p><img alt=\"A diagram representing the aforementioned network flows\" src=\"../media/image14.png\" title=\"A diagram representing the aforementioned network flows\"/></p>\n<figcaption>A diagram representing the aforementioned network flows</figcaption>\n</figure>"
                }
            ]
        },
        {
            "id": "<chapter_0x42edaee7>",
            "title": "BPF Filters",
            "title_level": 2,
            "sentences": [
                {
                    "id": "<sentence_0x2737ea2>",
                    "is_empty": false,
                    "have_tags": true,
                    "tags": {
                        "<a_0x53f7d2c9>": "https://www.kernel.org/doc/html/v5.12/networking/filter.html"
                    },
                    "text": "As stated in step 9 (above), BPF or Berkeley Packet Filters is a technology from the early 90s that allows a user-space program to attach a network filter onto any socket and allow or disallow certain types of data to come through the socket. These filters are made up of bytecode that runs on an abstract virtual machine in the Linux kernel. The BPF virtual machine has functionality to inspect all parts of incoming packets and make an allow/drop decision based on what it sees. . You can see in the image example below what this looks like within the BPFDoor source code:",
                    "html": "<p>As stated in step 9 (above), <a href=\"https://www.kernel.org/doc/html/v5.12/networking/filter.html\">BPF</a> or Berkeley Packet Filters is a technology from the early \u201990s that allows a user-space program to attach a network filter onto any socket and allow or disallow certain types of data to come through the socket. These filters are made up of bytecode that runs on an abstract virtual machine in the Linux kernel. The BPF virtual machine has functionality to inspect all parts of incoming packets and make an allow/drop decision based on what it sees. . You can see in the image example below what this looks like within the BPFDoor source code:</p>"
                },
                {
                    "id": "<sentence_0xff78b614>",
                    "is_empty": false,
                    "have_tags": true,
                    "tags": {
                        "<img_0x905998da>": "../media/image6.png"
                    },
                    "text": "BPFDoor source code BPF Filters",
                    "html": "<figure>\n<p><img alt=\"BPFDoor source code BPF Filters\" src=\"../media/image6.png\" title=\"BPFDoor source code BPF Filters\"/></p>\n<figcaption>BPFDoor source code BPF Filters</figcaption>\n</figure>"
                },
                {
                    "id": "<sentence_0xce0962d4>",
                    "is_empty": false,
                    "have_tags": false,
                    "tags": {},
                    "text": "We took this BPF code, converted it, and wrote it up as pseudo code in an effort to aid our research and craft packets able to successfully get through these filters in order to activate the backdoor.",
                    "html": "<p>We took this BPF code, converted it, and wrote it up as pseudo code in an effort to aid our research and craft packets able to successfully get through these filters in order to activate the backdoor.</p>"
                },
                {
                    "id": "<sentence_0x3af9efbb>",
                    "is_empty": false,
                    "have_tags": true,
                    "tags": {
                        "<img_0x7c2f89d3>": "../media/image5.png"
                    },
                    "text": "BPFDoor source code BPF Filter Pseudocode",
                    "html": "<figure>\n<p><img alt=\"BPFDoor source code BPF Filter Pseudocode\" src=\"../media/image5.png\" title=\"BPFDoor source code BPF Filter Pseudocode\"/></p>\n<figcaption>BPFDoor source code BPF Filter Pseudocode</figcaption>\n</figure>"
                },
                {
                    "id": "<sentence_0xb097c4c8>",
                    "is_empty": false,
                    "have_tags": false,
                    "tags": {},
                    "text": "The above capabilities allow BPFDoor to attach a filter onto any socket and allow or disallow certain types of data to come through the socket - used carefully by the adversary to invoke a series of different functions within the payload.",
                    "html": "<p>The above capabilities allow BPFDoor to attach a filter onto any socket and allow or disallow certain types of data to come through the socket - used carefully by the adversary to invoke a series of different functions within the payload.</p>"
                }
            ]
        },
        {
            "id": "<chapter_0xb5e02e51>",
            "title": "Historical Analysis",
            "title_level": 2,
            "sentences": [
                {
                    "id": "<sentence_0x6a087149>",
                    "is_empty": false,
                    "have_tags": true,
                    "tags": {
                        "<a_0x9b0d89d5>": "https://www.virustotal.com/gui/file/599ae527f10ddb4625687748b7d3734ee51673b664f2e5d0346e64f85e185683/detection"
                    },
                    "text": "We wanted to see over time, between BPFDoor payloads, what, if anything, the threat actors modified. A number of samples were detonated and analyzed ranging from the uploaded source code to a sample uploaded last month. We found that the behavior over time did not change a great deal. It maintained the same relative attack lifecycle with a few variations with the hardcoded values such as passwords, process names, and files - this is not uncommon when compared to other malware samples that look to evade detection or leverage payloads across a variety of victims.",
                    "html": "<p>We wanted to see over time, between BPFDoor payloads, what, if anything, the threat actors modified. A number of samples were detonated and analyzed ranging from the uploaded source code to a <a href=\"https://www.virustotal.com/gui/file/599ae527f10ddb4625687748b7d3734ee51673b664f2e5d0346e64f85e185683/detection\">sample</a> uploaded last month. We found that the behavior over time did not change a great deal. It maintained the same relative attack lifecycle with a few variations with the hardcoded values such as passwords, process names, and files - this is not uncommon when compared to other malware samples that look to evade detection or leverage payloads across a variety of victims.</p>"
                },
                {
                    "id": "<sentence_0xd8f61efe>",
                    "is_empty": false,
                    "have_tags": true,
                    "tags": {
                        "<a_0x3b07c77c>": "https://www.virustotal.com/gui/file/8b9db0bc9152628bdacc32dab01590211bee9f27d58e0f66f6a1e26aea7552a6/detection",
                        "<a_0x826191e1>": "https://pastebin.com/raw/kmmJuuQP"
                    },
                    "text": "We posture that the threat group would change passwords and update process or file names in an effort to improve operational security and remain hidden. It also makes sense that the general functionality of the backdoor would not change in any great way. As the saying goes If its not broken, dont fix it. Our malware analysis and reverse engineering team compared the source code (uploaded to VirusTotal and found on Pastebin) to a recently uploaded sample highlighting some of the notable changes within the main function of the malware in the images below.",
                    "html": "<p>We posture that the threat group would change passwords and update process or file names in an effort to improve operational security and remain hidden. It also makes sense that the general functionality of the backdoor would not change in any great way. As the saying goes \u201cIf it\u2019s not broken, don\u2019t fix it\u201d. Our malware analysis and reverse engineering team compared the source code (uploaded to <a href=\"https://www.virustotal.com/gui/file/8b9db0bc9152628bdacc32dab01590211bee9f27d58e0f66f6a1e26aea7552a6/detection\">VirusTotal</a> and found on <a href=\"https://pastebin.com/raw/kmmJuuQP\">Pastebin</a>) to a recently uploaded sample highlighting some of the notable changes within the main function of the malware in the images below.</p>"
                },
                {
                    "id": "<sentence_0x7366c61>",
                    "is_empty": false,
                    "have_tags": true,
                    "tags": {
                        "<img_0x9913e137>": "../media/image10.png"
                    },
                    "text": "A side by side comparison of the main functions for the Pastebin source code and a sample uploaded to VT last month focusing on the hardcoded string values for the passwords, process names and file name",
                    "html": "<figure>\n<p><img alt=\"A side by side comparison of the main functions for the Pastebin source code and a sample uploaded to VT last month focusing on the hardcoded string values for the passwords, process names and file name\" src=\"../media/image10.png\" title=\"A side by side comparison of the main functions for the Pastebin source code and a sample uploaded to VT last month focusing on the hardcoded string values for the passwords, process names and file name\"/></p>\n<figcaption>A side by side comparison of the main functions for the Pastebin source code and a sample uploaded to VT last month focusing on the hardcoded string values for the passwords, process names and file name</figcaption>\n</figure>"
                },
                {
                    "id": "<sentence_0x3fa02d9f>",
                    "is_empty": false,
                    "have_tags": true,
                    "tags": {
                        "<a_0x9df0ff9d>": "https://www.virustotal.com/gui/file/07ecb1f2d9ffbd20a46cd36cd06b022db3cc8e45b1ecab62cd11f9ca7a26ab6d/detection"
                    },
                    "text": "As we mentioned earlier, one recent sample we have come across that does not seem to exhibit some of the tactics of prior payloads has been observed - It doesnt alter its initial name to a hardcoded value and simply executes from its placed location, otherwise, it models relatively the same behavior.",
                    "html": "<p>As we mentioned earlier, one recent <a href=\"https://www.virustotal.com/gui/file/07ecb1f2d9ffbd20a46cd36cd06b022db3cc8e45b1ecab62cd11f9ca7a26ab6d/detection\">sample</a> we have come across that does not seem to exhibit some of the tactics of prior payloads has been observed - It doesn\u2019t alter its initial name to a hardcoded value and simply executes from its placed location, otherwise, it models relatively the same behavior.</p>"
                }
            ]
        },
        {
            "id": "<chapter_0xeb23b3c7>",
            "title": "Linux Malware Sophistication",
            "title_level": 2,
            "sentences": [
                {
                    "id": "<sentence_0xa98ef120>",
                    "is_empty": false,
                    "have_tags": false,
                    "tags": {},
                    "text": "A trend we have had the privilege of observing at Elastic, is the threat landscape of Linux targeted attacks - these being focused often on cloud workloads, or systems that typically have less observational technology configured in many of the environments we see. The trend of complex, well-designed payloads is something that is often simply overlooked, and specifically in the case of BPFDoor, remained hidden for years.",
                    "html": "<p>A trend we have had the privilege of observing at Elastic, is the threat landscape of Linux targeted attacks - these being focused often on cloud workloads, or systems that typically have less observational technology configured in many of the environments we see. The trend of complex, well-designed payloads is something that is often simply overlooked, and specifically in the case of BPFDoor, remained hidden for years.</p>"
                },
                {
                    "id": "<sentence_0xc3122577>",
                    "is_empty": false,
                    "have_tags": false,
                    "tags": {},
                    "text": "It is important to consider these workloads a critical component of your security posture: A lack of visibility within cloud workloads will eventually lead to large gaps in security controls - adversarial groups are further growing to understand these trends, and act accordingly. Best practices state that endpoint defenses should be consistent across the fleet of systems under management, and conform to a least privilege architecture.",
                    "html": "<p>It is important to consider these workloads a critical component of your security posture: A lack of visibility within cloud workloads will eventually lead to large gaps in security controls - adversarial groups are further growing to understand these trends, and act accordingly. Best practices state that endpoint defenses should be consistent across the fleet of systems under management, and conform to a least privilege architecture.</p>"
                }
            ]
        },
        {
            "id": "<chapter_0xbd414cfe>",
            "title": "Detection of BPFDoor",
            "title_level": 2,
            "sentences": [
                {
                    "id": "<sentence_0xcdf03745>",
                    "is_empty": false,
                    "have_tags": false,
                    "tags": {},
                    "text": "After researching this malware it became apparent as to why the backdoor remained in use and hidden for so long. If you arent intimately familiar with Linux process abnormalities or werent looking for it you would generally not detect it. Even though it takes advantage of Linux capabilities in a stealthy manner to evade detection, there are still opportunities for both behavioral and signature-based detections.",
                    "html": "<p>After researching this malware it became apparent as to why the backdoor remained in use and hidden for so long. If you aren\u2019t intimately familiar with Linux process abnormalities or weren\u2019t looking for it you would generally not detect it. Even though it takes advantage of Linux capabilities in a stealthy manner to evade detection, there are still opportunities for both behavioral and signature-based detections.</p>"
                },
                {
                    "id": "<sentence_0xc5c78dfb>",
                    "is_empty": false,
                    "have_tags": true,
                    "tags": {
                        "<code_0x3fd0f8fb>": "/dev/shm"
                    },
                    "text": "The first area of opportunity we witnessed while testing was the behavior we observed during the initial execution of the malware, specifically its working directory, in a shared memory location /dev/shm. This is a native temporary filesystem location in Linux that uses RAM for storage, and a binary executing from it let alone generating network connections is fairly uncommon in practice.",
                    "html": "<p>The first area of opportunity we witnessed while testing was the behavior we observed during the initial execution of the malware, specifically its working directory, in a shared memory location <code>/dev/shm</code>. This is a native temporary filesystem location in Linux that uses RAM for storage, and a binary executing from it let alone generating network connections is fairly uncommon in practice.</p>"
                },
                {
                    "id": "<sentence_0x6be1137b>",
                    "is_empty": false,
                    "have_tags": true,
                    "tags": {
                        "<code_0xd8fa8883>": "/dev/shm"
                    },
                    "text": "During execution, BPFDoor removes existing files from /dev/shm and copies itself there prior to initialization. A detection for this would be any execution of a binary from this directory as root (you have to be root to write to and read from this directory).",
                    "html": "<p>During execution, BPFDoor removes existing files from <code>/dev/shm</code> and copies itself there prior to initialization. A detection for this would be any execution of a binary from this directory as root (you have to be root to write to and read from this directory).</p>"
                },
                {
                    "id": "<sentence_0x6ced504b>",
                    "is_empty": false,
                    "have_tags": true,
                    "tags": {
                        "<a_0xb2da4b>": "https://github.com/elastic/detection-rules/blob/main/rules/linux/execution_process_started_in_shared_memory_directory.toml"
                    },
                    "text": "This was verified by detonating the binary in a VM while our Elastic Agent was installed and observing the sequence of events. You can see an image of this detection on the Kibana Security Alerts page below. This rule is publicly available as an Elastic SIEM detection rule - Binary Executed from Shared Memory Directory:",
                    "html": "<p>This was verified by detonating the binary in a VM while our Elastic Agent was installed and observing the sequence of events. You can see an image of this detection on the Kibana Security Alerts page below. This rule is publicly available as an Elastic SIEM detection rule - <a href=\"https://github.com/elastic/detection-rules/blob/main/rules/linux/execution_process_started_in_shared_memory_directory.toml\">Binary Executed from Shared Memory Directory</a>:</p>"
                },
                {
                    "id": "<sentence_0xfe62c336>",
                    "is_empty": false,
                    "have_tags": true,
                    "tags": {
                        "<img_0xa9d84d26>": "../media/image8.png"
                    },
                    "text": "Elastic Alert in Kibana - Binary Executed from Shared Memory Directory",
                    "html": "<figure>\n<p><img alt=\"Elastic Alert in Kibana - Binary Executed from Shared Memory Directory\" src=\"../media/image8.png\" title=\"Elastic Alert in Kibana - Binary Executed from Shared Memory Directory\"/></p>\n<figcaption>Elastic Alert in Kibana - Binary Executed from Shared Memory Directory</figcaption>\n</figure>"
                },
                {
                    "id": "<sentence_0x2b73881b>",
                    "is_empty": false,
                    "have_tags": true,
                    "tags": {
                        "<a_0xdeb53362>": "https://docs.elastic.co/en/integrations/osquery_manager",
                        "<code_0xdad431f0>": "/var/run",
                        "<code_0x173282a9>": "/var/run",
                        "<code_0xa0e9d95f>": "0",
                        "<code_0x40b17105>": "10"
                    },
                    "text": "The second opportunity we noticed, for detection, was a specific PID file being created in /var/run. We noticed the dropped PID file was completely empty while doing a quick query via the Osquery integration to the /var/run directory. While this is not inherently malicious, it is unusual for the file size of a PID to be 0 or above 10 bytes and thus we created an additional rule centered around detecting this unusual behavior.",
                    "html": "<p>The second opportunity we noticed, for detection, was a specific PID file being created in <code>/var/run</code>. We noticed the dropped PID file was completely empty while doing a quick query via the <a href=\"https://docs.elastic.co/en/integrations/osquery_manager\">Osquery integration</a> to the <code>/var/run</code> directory. While this is not inherently malicious, it is unusual for the file size of a PID to be <code>0</code> or above <code>10</code> bytes and thus we created an additional rule centered around detecting this unusual behavior.</p>"
                },
                {
                    "id": "<sentence_0x724887ad>",
                    "is_empty": false,
                    "have_tags": true,
                    "tags": {
                        "<a_0xdcaf61a>": "https://github.com/elastic/detection-rules/blob/main/rules/linux/execution_abnormal_process_id_file_created.toml",
                        "<code_0xd780ac74>": "/var/run"
                    },
                    "text": "Our Abnormal Process ID or Lock File Created rule identifies the creation of a PID file in the main directory of /var/run with no subdirectory, ignoring common PID files to be expected:",
                    "html": "<p>Our <a href=\"https://github.com/elastic/detection-rules/blob/main/rules/linux/execution_abnormal_process_id_file_created.toml\">Abnormal Process ID or Lock File Created</a> rule identifies the creation of a PID file in the main directory of <code>/var/run</code> with no subdirectory, ignoring common PID files to be expected:</p>"
                },
                {
                    "id": "<sentence_0xee48bdbc>",
                    "is_empty": false,
                    "have_tags": true,
                    "tags": {
                        "<img_0x3200d248>": "../media/image11.png"
                    },
                    "text": "Elastic Alert in Kibana - Abnormal Process ID or Lock File Created",
                    "html": "<figure>\n<p><img alt=\"Elastic Alert in Kibana - Abnormal Process ID or Lock File Created\" src=\"../media/image11.png\" title=\"Elastic Alert in Kibana - Abnormal Process ID or Lock File Created\"/></p>\n<figcaption>Elastic Alert in Kibana - Abnormal Process ID or Lock File Created</figcaption>\n</figure>"
                },
                {
                    "id": "<sentence_0x487b5193>",
                    "is_empty": false,
                    "have_tags": false,
                    "tags": {},
                    "text": "The third area we wanted to look at was the network connections tied to two of the three capabilities (reverse shell and bind shell) the backdoor possesses. We wanted to see if there were any suspicious network connections tied to process or user abnormalities we could sequence together based off of the way BPFDoor handles establishing a reverse or bind shell.",
                    "html": "<p>The third area we wanted to look at was the network connections tied to two of the three capabilities (reverse shell and bind shell) the backdoor possesses. We wanted to see if there were any suspicious network connections tied to process or user abnormalities we could sequence together based off of the way BPFDoor handles establishing a reverse or bind shell.</p>"
                },
                {
                    "id": "<sentence_0xdafa808f>",
                    "is_empty": false,
                    "have_tags": false,
                    "tags": {},
                    "text": "The reverse shell was the first capability focused on. Taking a deep look at the process tree in and around the reverse shell establishment allowed us to key in on what would be considered a strange or even abnormal sequence of events leading to and involving an outbound network connection.",
                    "html": "<p>The reverse shell was the first capability focused on. Taking a deep look at the process tree in and around the reverse shell establishment allowed us to key in on what would be considered a strange or even abnormal sequence of events leading to and involving an outbound network connection.</p>"
                },
                {
                    "id": "<sentence_0xacb10ec3>",
                    "is_empty": false,
                    "have_tags": false,
                    "tags": {},
                    "text": "We developed a hunt rule sequence that identifies an outbound network connection attempt followed by a session id change as the root user by the same process entity. The reason we developed these network focused hunt rules is due to possible performance issues caused if running these continually.",
                    "html": "<p>We developed a hunt rule sequence that identifies an outbound network connection attempt followed by a session id change as the root user by the same process entity. The reason we developed these network focused hunt rules is due to possible performance issues caused if running these continually. </p>"
                },
                {
                    "id": "<sentence_0x6f6c28d4>",
                    "is_empty": false,
                    "have_tags": false,
                    "tags": {},
                    "text": "The bind shell was the last capability we honed in on. Identifying an abnormal sequence of events surrounding the bind shell connection was difficult due to the way it forks then accepts the connection and kills the accepting process post established connection. Therefore we had to focus on the sequence of events within the process entity id directly involving the network connection and subsequent killing of the accepting process.",
                    "html": "<p>The bind shell was the last capability we honed in on. Identifying an abnormal sequence of events surrounding the bind shell connection was difficult due to the way it forks then accepts the connection and kills the accepting process post established connection. Therefore we had to focus on the sequence of events within the process entity id directly involving the network connection and subsequent killing of the accepting process.</p>"
                },
                {
                    "id": "<sentence_0x6d744728>",
                    "is_empty": false,
                    "have_tags": false,
                    "tags": {},
                    "text": "After developing the 2 detection rules along with the 2 hunt rules listed below and in addition to the 6 YARA signatures deployed we were able to detect BPFDoor in a myriad of different ways and within different stages of its life cycle. As stated earlier though, if you detect this malware in your environment it should be the least of your concerns given the threat actor will most likely have already successfully compromised your network via other means.",
                    "html": "<p>After developing the 2 detection rules along with the 2 hunt rules listed below and in addition to the 6 YARA signatures deployed we were able to detect BPFDoor in a myriad of different ways and within different stages of its life cycle. As stated earlier though, if you detect this malware in your environment it should be the least of your concerns given the threat actor will most likely have already successfully compromised your network via other means.</p>"
                },
                {
                    "id": "<sentence_0xde0522fd>",
                    "is_empty": false,
                    "have_tags": true,
                    "tags": {
                        "<img_0x504865c5>": "../media/image2.png"
                    },
                    "text": "Elastic Detection Summary of complete BPFDoor attack lifecycle",
                    "html": "<figure>\n<p><img alt=\"Elastic Detection Summary of complete BPFDoor attack lifecycle\" src=\"../media/image2.png\" title=\"Elastic Detection Summary of complete BPFDoor attack lifecycle\"/></p>\n<figcaption>Elastic Detection Summary of complete BPFDoor attack lifecycle</figcaption>\n</figure>"
                }
            ]
        },
        {
            "id": "<chapter_0xefb4a3ca>",
            "title": "Existing Detection Rules",
            "title_level": 3,
            "sentences": [
                {
                    "id": "<sentence_0x148bd4fc>",
                    "is_empty": false,
                    "have_tags": false,
                    "tags": {},
                    "text": "The following Elastic Detection Rules will identify BPFDoor activity:",
                    "html": "<p>The following Elastic Detection Rules will identify BPFDoor activity:</p>"
                },
                {
                    "id": "<sentence_0x6efea912>",
                    "is_empty": false,
                    "have_tags": true,
                    "tags": {
                        "<a_0xdcaf61a>": "https://github.com/elastic/detection-rules/blob/main/rules/linux/execution_abnormal_process_id_file_created.toml",
                        "<a_0xb2da4b>": "https://github.com/elastic/detection-rules/blob/main/rules/linux/execution_process_started_in_shared_memory_directory.toml"
                    },
                    "text": "Abnormal Process ID or Lock File Created<crlf>Binary Executed from Shared Memory Directory",
                    "html": "<ul>\n<li><a href=\"https://github.com/elastic/detection-rules/blob/main/rules/linux/execution_abnormal_process_id_file_created.toml\">Abnormal Process ID or Lock File Created</a></li>\n<li><a href=\"https://github.com/elastic/detection-rules/blob/main/rules/linux/execution_process_started_in_shared_memory_directory.toml\">Binary Executed from Shared Memory Directory</a></li>\n</ul>"
                }
            ]
        },
        {
            "id": "<chapter_0x9e8cc168>",
            "title": "Hunting Queries",
            "title_level": 3,
            "sentences": [
                {
                    "id": "<sentence_0xcb5f3fcb>",
                    "is_empty": false,
                    "have_tags": false,
                    "tags": {},
                    "text": "This EQL rule can be used to successfully identify BPFDoor reverse shell connections having been established within your environment:",
                    "html": "<p>This EQL rule can be used to successfully identify BPFDoor reverse shell connections having been established within your environment:</p>"
                },
                {
                    "id": "<sentence_0xbb4b6107>",
                    "is_empty": false,
                    "have_tags": false,
                    "tags": {},
                    "text": "EQL BPFDoor reverse shell hunt query",
                    "html": "\nEQL BPFDoor reverse shell hunt query"
                },
                {
                    "id": "<sentence_0x22e835ed>",
                    "is_empty": true,
                    "have_tags": true,
                    "tags": {
                        "<code_0x2a1aa455>": "sequence by process.entity_id with maxspan=1m\n[network where event.type == \"start\" and event.action == \"connection_attempted\" and user.id == \"0\" and not process.executable : (\"/bin/ssh\", \"/sbin/ssh\", \"/usr/lib/systemd/systemd\")]\n[process where event.action == \"session_id_change\" and user.id == \"0\"]\n"
                    },
                    "text": "",
                    "html": "<code><a href=\"#__codelineno-0-1\" id=\"__codelineno-0-1\" name=\"__codelineno-0-1\"></a>sequence by process.entity_id with maxspan=1m\n<a href=\"#__codelineno-0-2\" id=\"__codelineno-0-2\" name=\"__codelineno-0-2\"></a>[network where event.type == \"start\" and event.action == \"connection_attempted\" and user.id == \"0\" and not process.executable : (\"/bin/ssh\", \"/sbin/ssh\", \"/usr/lib/systemd/systemd\")]\n<a href=\"#__codelineno-0-3\" id=\"__codelineno-0-3\" name=\"__codelineno-0-3\"></a>[process where event.action == \"session_id_change\" and user.id == \"0\"]\n</code>"
                },
                {
                    "id": "<sentence_0xc001b6c0>",
                    "is_empty": false,
                    "have_tags": true,
                    "tags": {
                        "<img_0xb7536452>": "../media/image15.png"
                    },
                    "text": "Elastic Alert in Kibana - Suspicious Network Connection Attempt by Root",
                    "html": "<figure>\n<p><img alt=\"Elastic Alert in Kibana - Suspicious Network Connection Attempt by Root\" src=\"../media/image15.png\" title=\"Elastic Alert in Kibana - Suspicious Network Connection Attempt by Root\"/></p>\n<figcaption>Elastic Alert in Kibana - Suspicious Network Connection Attempt by Root</figcaption>\n</figure>"
                },
                {
                    "id": "<sentence_0x24070f7d>",
                    "is_empty": false,
                    "have_tags": false,
                    "tags": {},
                    "text": "The hunt rule we created here identifies a sequence of events beginning with a session id change, followed by a network connection accepted, in correlation with ptmx file creation and a deletion of the process responsible for accepting the network connection. This EQL rule can be used to successfully identify BPFDoor bind shell connections within your environment:",
                    "html": "<p>The hunt rule we created here identifies a sequence of events beginning with a session id change, followed by a network connection accepted, in correlation with ptmx file creation and a deletion of the process responsible for accepting the network connection. This EQL rule can be used to successfully identify BPFDoor bind shell connections within your environment:</p>"
                },
                {
                    "id": "<sentence_0x9777eaf4>",
                    "is_empty": false,
                    "have_tags": false,
                    "tags": {},
                    "text": "EQL BPFDoor bind shell hunt query",
                    "html": "\nEQL BPFDoor bind shell hunt query"
                },
                {
                    "id": "<sentence_0x5bac645f>",
                    "is_empty": true,
                    "have_tags": true,
                    "tags": {
                        "<code_0x520fc48d>": "sequence by process.entity_id with maxspan=1m\n[process where event.type == \"change\" and event.action == \"session_id_change\" and user.id == 0 and not process.executable : (\"/bin/ssh\", \"/sbin/ssh\", \"/usr/lib/systemd/systemd\")]\n[network where event.type == \"start\" and event.action == \"connection_accepted\" and user.id == 0]\n[file where event.action == \"creation\" and user.id == 0 and file.path == \"/dev/ptmx\"]\n[process where event.action == \"end\" and user.id == 0 and not process.executable : (\"/bin/ssh\", \"/sbin/ssh\", \"/usr/lib/systemd/systemd\")]\n"
                    },
                    "text": "",
                    "html": "<code><a href=\"#__codelineno-1-1\" id=\"__codelineno-1-1\" name=\"__codelineno-1-1\"></a>sequence by process.entity_id with maxspan=1m\n<a href=\"#__codelineno-1-2\" id=\"__codelineno-1-2\" name=\"__codelineno-1-2\"></a>[process where event.type == \"change\" and event.action == \"session_id_change\" and user.id == 0 and not process.executable : (\"/bin/ssh\", \"/sbin/ssh\", \"/usr/lib/systemd/systemd\")]\n<a href=\"#__codelineno-1-3\" id=\"__codelineno-1-3\" name=\"__codelineno-1-3\"></a>[network where event.type == \"start\" and event.action == \"connection_accepted\" and user.id == 0]\n<a href=\"#__codelineno-1-4\" id=\"__codelineno-1-4\" name=\"__codelineno-1-4\"></a>[file where event.action == \"creation\" and user.id == 0 and file.path == \"/dev/ptmx\"]\n<a href=\"#__codelineno-1-5\" id=\"__codelineno-1-5\" name=\"__codelineno-1-5\"></a>[process where event.action == \"end\" and user.id == 0 and not process.executable : (\"/bin/ssh\", \"/sbin/ssh\", \"/usr/lib/systemd/systemd\")]\n</code>"
                },
                {
                    "id": "<sentence_0x92082841>",
                    "is_empty": false,
                    "have_tags": true,
                    "tags": {
                        "<img_0x76245be>": "../media/image9.png"
                    },
                    "text": "Elastic Alert in Kibana - Suspicious Network Connection Accept by Root",
                    "html": "<figure>\n<p><img alt=\"Elastic Alert in Kibana - Suspicious Network Connection Accept by Root\" src=\"../media/image9.png\" title=\"Elastic Alert in Kibana - Suspicious Network Connection Accept by Root\"/></p>\n<figcaption>Elastic Alert in Kibana - Suspicious Network Connection Accept by Root</figcaption>\n</figure>"
                }
            ]
        },
        {
            "id": "<chapter_0x6a61efc9>",
            "title": "YARA Rules",
            "title_level": 3,
            "sentences": [
                {
                    "id": "<sentence_0x2fa4d8bf>",
                    "is_empty": false,
                    "have_tags": false,
                    "tags": {},
                    "text": "In addition to behavioral detection rules in the Elastic Endpoint, we are releasing a set of BPFDoor Yara signatures for the community.",
                    "html": "<p>In addition to behavioral detection rules in the Elastic Endpoint, we are releasing a set of BPFDoor Yara signatures for the community.</p>"
                },
                {
                    "id": "<sentence_0x42febcdd>",
                    "is_empty": false,
                    "have_tags": false,
                    "tags": {},
                    "text": "BPFDoor YARA rule",
                    "html": "\nBPFDoor YARA rule"
                },
                {
                    "id": "<sentence_0x98e5f343>",
                    "is_empty": true,
                    "have_tags": true,
                    "tags": {
                        "<code_0xc4f22949>": "rule Linux_Trojan_BPFDoor_1 {\n\n meta:\n Author = \"Elastic Security\"\n creation_date = \"2022-05-10\"\n last_modified = \"2022-05-10\"\n os = \"Linux\"\n arch = \"x86\"\n category_type = \"Trojan\"\n family = \"BPFDoor\"\n threat_name = \"Linux.Trojan.BPFDoor\"\n description = \"Detects BPFDoor malware.\"\n reference_sample = \"144526d30ae747982079d5d340d1ff116a7963aba2e3ed589e7ebc297ba0c1b3\"\n strings:\n $a1 = \"hald-addon-acpi: listening on acpi kernel interface /proc/acpi/event\" ascii fullword\n $a2 = \"/sbin/iptables -t nat -D PREROUTING -p tcp -s %s --dport %d -j REDIRECT --to-ports %d\" ascii fullword\n $a3 = \"avahi-daemon: chroot helper\" ascii fullword\n $a4 = \"/sbin/mingetty /dev/tty6\" ascii fullword\n $a5 = \"ttcompat\" ascii fullword\n condition:\n all of them\n}\n\nrule Linux_Trojan_BPFDoor_2 {\n meta:\n Author = \"Elastic Security\"\n creation_date = \"2022-05-10\"\n last_modified = \"2022-05-10\"\n os = \"Linux\"\n arch = \"x86\"\n category_type = \"Trojan\"\n family = \"BPFDoor\"\n threat_name = \"Linux.Trojan.BPFDoor\"\n description = \"Detects BPFDoor malware.\"\n reference_sample = \"3a1b174f0c19c28f71e1babde01982c56d38d3672ea14d47c35ae3062e49b155\"\n strings:\n $a1 = \"hald-addon-acpi: listening on acpi kernel interface /proc/acpi/event\" ascii fullword\n $a2 = \"/sbin/mingetty /dev/tty7\" ascii fullword\n $a3 = \"pickup -l -t fifo -u\" ascii fullword\n $a4 = \"kdmtmpflush\" ascii fullword\n $a5 = \"avahi-daemon: chroot helper\" ascii fullword\n $a6 = \"/sbin/auditd -n\" ascii fullword\n condition:\n all of them\n}\n\nrule Linux_Trojan_BPFDoor_3 {\n meta:\n Author = \"Elastic Security\"\n creation_date = \"2022-05-10\"\n last_modified = \"2022-05-10\"\n os = \"Linux\"\n arch = \"x86\"\n category_type = \"Trojan\"\n family = \"BPFDoor\"\n threat_name = \"Linux.Trojan.BPFDoor\"\n description = \"Detects BPFDoor malware.\"\n reference_sample = \"591198c234416c6ccbcea6967963ca2ca0f17050be7eed1602198308d9127c78\"\n strings:\n $a1 = \"[-] Spawn shell failed.\" ascii fullword\n $a2 = \"[+] Packet Successfuly Sending %d Size.\" ascii fullword\n $a3 = \"[+] Monitor packet send.\" ascii fullword\n $a4 = \"[+] Using port %d\"\n $a5 = \"decrypt_ctx\" ascii fullword\n $a6 = \"getshell\" ascii fullword\n $a7 = \"getpassw\" ascii fullword\n $a8 = \"export %s=%s\" ascii fullword\n condition:\n all of them\n}\n\nrule Linux_Trojan_BPFDoor_4 {\n meta:\n Author = \"Elastic Security\"\n creation_date = \"2022-05-10\"\n last_modified = \"2022-05-10\"\n os = \"Linux\"\n arch = \"x86\"\n category_type = \"Trojan\"\n family = \"BPFDoor\"\n threat_name = \"Linux.Trojan.BPFDoor\"\n description = \"Detects BPFDoor malware.\"\n reference_sample = \"591198c234416c6ccbcea6967963ca2ca0f17050be7eed1602198308d9127c78\"\n strings:\n $a1 = { 45 D8 0F B6 10 0F B6 45 FF 48 03 45 F0 0F B6 00 8D 04 02 00 }\n condition:\n all of them\n}\n\nrule Linux_Trojan_BPFDoor_5 {\n meta:\n Author = \"Elastic Security\"\n creation_date = \"2022-05-10\"\n last_modified = \"2022-05-10\"\n os = \"Linux\"\n arch = \"x86\"\n category_type = \"Trojan\"\n family = \"BPFDoor\"\n threat_name = \"Linux.Trojan.BPFDoor\"\n description = \"Detects BPFDoor malware.\"\n reference_sample = \"76bf736b25d5c9aaf6a84edd4e615796fffc338a893b49c120c0b4941ce37925\"\n strings:\n $a1 = \"getshell\" ascii fullword\n $a2 = \"/sbin/agetty --noclear tty1 linux\" ascii fullword\n $a3 = \"packet_loop\" ascii fullword\n $a4 = \"godpid\" ascii fullword\n $a5 = \"ttcompat\" ascii fullword\n $a6 = \"decrypt_ctx\" ascii fullword\n $a7 = \"rc4_init\" ascii fullword\n $b1 = { D0 48 89 45 F8 48 8B 45 F8 0F B6 40 0C C0 E8 04 0F B6 C0 C1 }\n condition:\n all of ($a*) or 1 of ($b*)\n}\n\nrule Linux_Trojan_BPFDoor_6 {\n meta:\n Author = \"Elastic Security\"\n creation_date = \"2022-05-10\"\n last_modified = \"2022-05-10\"\n os = \"Linux\"\n arch = \"x86\"\n category_type = \"Trojan\"\n family = \"BPFDoor\"\n threat_name = \"Linux.Trojan.BPFDoor\"\n description = \"Detects BPFDoor malware.\"\n reference_sample = \"dc8346bf443b7b453f062740d8ae8d8d7ce879672810f4296158f90359dcae3a\"\n strings:\n $a1 = \"getpassw\" ascii fullword\n $a2 = \"(udp[8:2]=0x7255) or (icmp[8:2]=0x7255) or (tcp[((tcp[12]&0xf0)>>2):2]=0x5293)\" ascii fullword\n $a3 = \"/var/run/haldrund.pid\" ascii fullword\n $a4 = \"Couldn't install filter %s: %s\" ascii fullword\n $a5 = \"godpid\" ascii fullword\n condition:\n all of them\n}\n"
                    },
                    "text": "",
                    "html": "<code><a href=\"#__codelineno-2-1\" id=\"__codelineno-2-1\" name=\"__codelineno-2-1\"></a>rule Linux_Trojan_BPFDoor_1 {\n<a href=\"#__codelineno-2-2\" id=\"__codelineno-2-2\" name=\"__codelineno-2-2\"></a>\n<a href=\"#__codelineno-2-3\" id=\"__codelineno-2-3\" name=\"__codelineno-2-3\"></a> meta:\n<a href=\"#__codelineno-2-4\" id=\"__codelineno-2-4\" name=\"__codelineno-2-4\"></a> Author = \"Elastic Security\"\n<a href=\"#__codelineno-2-5\" id=\"__codelineno-2-5\" name=\"__codelineno-2-5\"></a> creation_date = \"2022-05-10\"\n<a href=\"#__codelineno-2-6\" id=\"__codelineno-2-6\" name=\"__codelineno-2-6\"></a> last_modified = \"2022-05-10\"\n<a href=\"#__codelineno-2-7\" id=\"__codelineno-2-7\" name=\"__codelineno-2-7\"></a> os = \"Linux\"\n<a href=\"#__codelineno-2-8\" id=\"__codelineno-2-8\" name=\"__codelineno-2-8\"></a> arch = \"x86\"\n<a href=\"#__codelineno-2-9\" id=\"__codelineno-2-9\" name=\"__codelineno-2-9\"></a> category_type = \"Trojan\"\n<a href=\"#__codelineno-2-10\" id=\"__codelineno-2-10\" name=\"__codelineno-2-10\"></a> family = \"BPFDoor\"\n<a href=\"#__codelineno-2-11\" id=\"__codelineno-2-11\" name=\"__codelineno-2-11\"></a> threat_name = \"Linux.Trojan.BPFDoor\"\n<a href=\"#__codelineno-2-12\" id=\"__codelineno-2-12\" name=\"__codelineno-2-12\"></a> description = \"Detects BPFDoor malware.\"\n<a href=\"#__codelineno-2-13\" id=\"__codelineno-2-13\" name=\"__codelineno-2-13\"></a> reference_sample = \"144526d30ae747982079d5d340d1ff116a7963aba2e3ed589e7ebc297ba0c1b3\"\n<a href=\"#__codelineno-2-14\" id=\"__codelineno-2-14\" name=\"__codelineno-2-14\"></a> strings:\n<a href=\"#__codelineno-2-15\" id=\"__codelineno-2-15\" name=\"__codelineno-2-15\"></a> $a1 = \"hald-addon-acpi: listening on acpi kernel interface /proc/acpi/event\" ascii fullword\n<a href=\"#__codelineno-2-16\" id=\"__codelineno-2-16\" name=\"__codelineno-2-16\"></a> $a2 = \"/sbin/iptables -t nat -D PREROUTING -p tcp -s %s --dport %d -j REDIRECT --to-ports %d\" ascii fullword\n<a href=\"#__codelineno-2-17\" id=\"__codelineno-2-17\" name=\"__codelineno-2-17\"></a> $a3 = \"avahi-daemon: chroot helper\" ascii fullword\n<a href=\"#__codelineno-2-18\" id=\"__codelineno-2-18\" name=\"__codelineno-2-18\"></a> $a4 = \"/sbin/mingetty /dev/tty6\" ascii fullword\n<a href=\"#__codelineno-2-19\" id=\"__codelineno-2-19\" name=\"__codelineno-2-19\"></a> $a5 = \"ttcompat\" ascii fullword\n<a href=\"#__codelineno-2-20\" id=\"__codelineno-2-20\" name=\"__codelineno-2-20\"></a> condition:\n<a href=\"#__codelineno-2-21\" id=\"__codelineno-2-21\" name=\"__codelineno-2-21\"></a> all of them\n<a href=\"#__codelineno-2-22\" id=\"__codelineno-2-22\" name=\"__codelineno-2-22\"></a>}\n<a href=\"#__codelineno-2-23\" id=\"__codelineno-2-23\" name=\"__codelineno-2-23\"></a>\n<a href=\"#__codelineno-2-24\" id=\"__codelineno-2-24\" name=\"__codelineno-2-24\"></a>rule Linux_Trojan_BPFDoor_2 {\n<a href=\"#__codelineno-2-25\" id=\"__codelineno-2-25\" name=\"__codelineno-2-25\"></a> meta:\n<a href=\"#__codelineno-2-26\" id=\"__codelineno-2-26\" name=\"__codelineno-2-26\"></a> Author = \"Elastic Security\"\n<a href=\"#__codelineno-2-27\" id=\"__codelineno-2-27\" name=\"__codelineno-2-27\"></a> creation_date = \"2022-05-10\"\n<a href=\"#__codelineno-2-28\" id=\"__codelineno-2-28\" name=\"__codelineno-2-28\"></a> last_modified = \"2022-05-10\"\n<a href=\"#__codelineno-2-29\" id=\"__codelineno-2-29\" name=\"__codelineno-2-29\"></a> os = \"Linux\"\n<a href=\"#__codelineno-2-30\" id=\"__codelineno-2-30\" name=\"__codelineno-2-30\"></a> arch = \"x86\"\n<a href=\"#__codelineno-2-31\" id=\"__codelineno-2-31\" name=\"__codelineno-2-31\"></a> category_type = \"Trojan\"\n<a href=\"#__codelineno-2-32\" id=\"__codelineno-2-32\" name=\"__codelineno-2-32\"></a> family = \"BPFDoor\"\n<a href=\"#__codelineno-2-33\" id=\"__codelineno-2-33\" name=\"__codelineno-2-33\"></a> threat_name = \"Linux.Trojan.BPFDoor\"\n<a href=\"#__codelineno-2-34\" id=\"__codelineno-2-34\" name=\"__codelineno-2-34\"></a> description = \"Detects BPFDoor malware.\"\n<a href=\"#__codelineno-2-35\" id=\"__codelineno-2-35\" name=\"__codelineno-2-35\"></a> reference_sample = \"3a1b174f0c19c28f71e1babde01982c56d38d3672ea14d47c35ae3062e49b155\"\n<a href=\"#__codelineno-2-36\" id=\"__codelineno-2-36\" name=\"__codelineno-2-36\"></a> strings:\n<a href=\"#__codelineno-2-37\" id=\"__codelineno-2-37\" name=\"__codelineno-2-37\"></a> $a1 = \"hald-addon-acpi: listening on acpi kernel interface /proc/acpi/event\" ascii fullword\n<a href=\"#__codelineno-2-38\" id=\"__codelineno-2-38\" name=\"__codelineno-2-38\"></a> $a2 = \"/sbin/mingetty /dev/tty7\" ascii fullword\n<a href=\"#__codelineno-2-39\" id=\"__codelineno-2-39\" name=\"__codelineno-2-39\"></a> $a3 = \"pickup -l -t fifo -u\" ascii fullword\n<a href=\"#__codelineno-2-40\" id=\"__codelineno-2-40\" name=\"__codelineno-2-40\"></a> $a4 = \"kdmtmpflush\" ascii fullword\n<a href=\"#__codelineno-2-41\" id=\"__codelineno-2-41\" name=\"__codelineno-2-41\"></a> $a5 = \"avahi-daemon: chroot helper\" ascii fullword\n<a href=\"#__codelineno-2-42\" id=\"__codelineno-2-42\" name=\"__codelineno-2-42\"></a> $a6 = \"/sbin/auditd -n\" ascii fullword\n<a href=\"#__codelineno-2-43\" id=\"__codelineno-2-43\" name=\"__codelineno-2-43\"></a> condition:\n<a href=\"#__codelineno-2-44\" id=\"__codelineno-2-44\" name=\"__codelineno-2-44\"></a> all of them\n<a href=\"#__codelineno-2-45\" id=\"__codelineno-2-45\" name=\"__codelineno-2-45\"></a>}\n<a href=\"#__codelineno-2-46\" id=\"__codelineno-2-46\" name=\"__codelineno-2-46\"></a>\n<a href=\"#__codelineno-2-47\" id=\"__codelineno-2-47\" name=\"__codelineno-2-47\"></a>rule Linux_Trojan_BPFDoor_3 {\n<a href=\"#__codelineno-2-48\" id=\"__codelineno-2-48\" name=\"__codelineno-2-48\"></a> meta:\n<a href=\"#__codelineno-2-49\" id=\"__codelineno-2-49\" name=\"__codelineno-2-49\"></a> Author = \"Elastic Security\"\n<a href=\"#__codelineno-2-50\" id=\"__codelineno-2-50\" name=\"__codelineno-2-50\"></a> creation_date = \"2022-05-10\"\n<a href=\"#__codelineno-2-51\" id=\"__codelineno-2-51\" name=\"__codelineno-2-51\"></a> last_modified = \"2022-05-10\"\n<a href=\"#__codelineno-2-52\" id=\"__codelineno-2-52\" name=\"__codelineno-2-52\"></a> os = \"Linux\"\n<a href=\"#__codelineno-2-53\" id=\"__codelineno-2-53\" name=\"__codelineno-2-53\"></a> arch = \"x86\"\n<a href=\"#__codelineno-2-54\" id=\"__codelineno-2-54\" name=\"__codelineno-2-54\"></a> category_type = \"Trojan\"\n<a href=\"#__codelineno-2-55\" id=\"__codelineno-2-55\" name=\"__codelineno-2-55\"></a> family = \"BPFDoor\"\n<a href=\"#__codelineno-2-56\" id=\"__codelineno-2-56\" name=\"__codelineno-2-56\"></a> threat_name = \"Linux.Trojan.BPFDoor\"\n<a href=\"#__codelineno-2-57\" id=\"__codelineno-2-57\" name=\"__codelineno-2-57\"></a> description = \"Detects BPFDoor malware.\"\n<a href=\"#__codelineno-2-58\" id=\"__codelineno-2-58\" name=\"__codelineno-2-58\"></a> reference_sample = \"591198c234416c6ccbcea6967963ca2ca0f17050be7eed1602198308d9127c78\"\n<a href=\"#__codelineno-2-59\" id=\"__codelineno-2-59\" name=\"__codelineno-2-59\"></a> strings:\n<a href=\"#__codelineno-2-60\" id=\"__codelineno-2-60\" name=\"__codelineno-2-60\"></a> $a1 = \"[-] Spawn shell failed.\" ascii fullword\n<a href=\"#__codelineno-2-61\" id=\"__codelineno-2-61\" name=\"__codelineno-2-61\"></a> $a2 = \"[+] Packet Successfuly Sending %d Size.\" ascii fullword\n<a href=\"#__codelineno-2-62\" id=\"__codelineno-2-62\" name=\"__codelineno-2-62\"></a> $a3 = \"[+] Monitor packet send.\" ascii fullword\n<a href=\"#__codelineno-2-63\" id=\"__codelineno-2-63\" name=\"__codelineno-2-63\"></a> $a4 = \"[+] Using port %d\"\n<a href=\"#__codelineno-2-64\" id=\"__codelineno-2-64\" name=\"__codelineno-2-64\"></a> $a5 = \"decrypt_ctx\" ascii fullword\n<a href=\"#__codelineno-2-65\" id=\"__codelineno-2-65\" name=\"__codelineno-2-65\"></a> $a6 = \"getshell\" ascii fullword\n<a href=\"#__codelineno-2-66\" id=\"__codelineno-2-66\" name=\"__codelineno-2-66\"></a> $a7 = \"getpassw\" ascii fullword\n<a href=\"#__codelineno-2-67\" id=\"__codelineno-2-67\" name=\"__codelineno-2-67\"></a> $a8 = \"export %s=%s\" ascii fullword\n<a href=\"#__codelineno-2-68\" id=\"__codelineno-2-68\" name=\"__codelineno-2-68\"></a> condition:\n<a href=\"#__codelineno-2-69\" id=\"__codelineno-2-69\" name=\"__codelineno-2-69\"></a> all of them\n<a href=\"#__codelineno-2-70\" id=\"__codelineno-2-70\" name=\"__codelineno-2-70\"></a>}\n<a href=\"#__codelineno-2-71\" id=\"__codelineno-2-71\" name=\"__codelineno-2-71\"></a>\n<a href=\"#__codelineno-2-72\" id=\"__codelineno-2-72\" name=\"__codelineno-2-72\"></a>rule Linux_Trojan_BPFDoor_4 {\n<a href=\"#__codelineno-2-73\" id=\"__codelineno-2-73\" name=\"__codelineno-2-73\"></a> meta:\n<a href=\"#__codelineno-2-74\" id=\"__codelineno-2-74\" name=\"__codelineno-2-74\"></a> Author = \"Elastic Security\"\n<a href=\"#__codelineno-2-75\" id=\"__codelineno-2-75\" name=\"__codelineno-2-75\"></a> creation_date = \"2022-05-10\"\n<a href=\"#__codelineno-2-76\" id=\"__codelineno-2-76\" name=\"__codelineno-2-76\"></a> last_modified = \"2022-05-10\"\n<a href=\"#__codelineno-2-77\" id=\"__codelineno-2-77\" name=\"__codelineno-2-77\"></a> os = \"Linux\"\n<a href=\"#__codelineno-2-78\" id=\"__codelineno-2-78\" name=\"__codelineno-2-78\"></a> arch = \"x86\"\n<a href=\"#__codelineno-2-79\" id=\"__codelineno-2-79\" name=\"__codelineno-2-79\"></a> category_type = \"Trojan\"\n<a href=\"#__codelineno-2-80\" id=\"__codelineno-2-80\" name=\"__codelineno-2-80\"></a> family = \"BPFDoor\"\n<a href=\"#__codelineno-2-81\" id=\"__codelineno-2-81\" name=\"__codelineno-2-81\"></a> threat_name = \"Linux.Trojan.BPFDoor\"\n<a href=\"#__codelineno-2-82\" id=\"__codelineno-2-82\" name=\"__codelineno-2-82\"></a> description = \"Detects BPFDoor malware.\"\n<a href=\"#__codelineno-2-83\" id=\"__codelineno-2-83\" name=\"__codelineno-2-83\"></a> reference_sample = \"591198c234416c6ccbcea6967963ca2ca0f17050be7eed1602198308d9127c78\"\n<a href=\"#__codelineno-2-84\" id=\"__codelineno-2-84\" name=\"__codelineno-2-84\"></a> strings:\n<a href=\"#__codelineno-2-85\" id=\"__codelineno-2-85\" name=\"__codelineno-2-85\"></a> $a1 = { 45 D8 0F B6 10 0F B6 45 FF 48 03 45 F0 0F B6 00 8D 04 02 00 }\n<a href=\"#__codelineno-2-86\" id=\"__codelineno-2-86\" name=\"__codelineno-2-86\"></a> condition:\n<a href=\"#__codelineno-2-87\" id=\"__codelineno-2-87\" name=\"__codelineno-2-87\"></a> all of them\n<a href=\"#__codelineno-2-88\" id=\"__codelineno-2-88\" name=\"__codelineno-2-88\"></a>}\n<a href=\"#__codelineno-2-89\" id=\"__codelineno-2-89\" name=\"__codelineno-2-89\"></a>\n<a href=\"#__codelineno-2-90\" id=\"__codelineno-2-90\" name=\"__codelineno-2-90\"></a>rule Linux_Trojan_BPFDoor_5 {\n<a href=\"#__codelineno-2-91\" id=\"__codelineno-2-91\" name=\"__codelineno-2-91\"></a> meta:\n<a href=\"#__codelineno-2-92\" id=\"__codelineno-2-92\" name=\"__codelineno-2-92\"></a> Author = \"Elastic Security\"\n<a href=\"#__codelineno-2-93\" id=\"__codelineno-2-93\" name=\"__codelineno-2-93\"></a> creation_date = \"2022-05-10\"\n<a href=\"#__codelineno-2-94\" id=\"__codelineno-2-94\" name=\"__codelineno-2-94\"></a> last_modified = \"2022-05-10\"\n<a href=\"#__codelineno-2-95\" id=\"__codelineno-2-95\" name=\"__codelineno-2-95\"></a> os = \"Linux\"\n<a href=\"#__codelineno-2-96\" id=\"__codelineno-2-96\" name=\"__codelineno-2-96\"></a> arch = \"x86\"\n<a href=\"#__codelineno-2-97\" id=\"__codelineno-2-97\" name=\"__codelineno-2-97\"></a> category_type = \"Trojan\"\n<a href=\"#__codelineno-2-98\" id=\"__codelineno-2-98\" name=\"__codelineno-2-98\"></a> family = \"BPFDoor\"\n<a href=\"#__codelineno-2-99\" id=\"__codelineno-2-99\" name=\"__codelineno-2-99\"></a> threat_name = \"Linux.Trojan.BPFDoor\"\n<a href=\"#__codelineno-2-100\" id=\"__codelineno-2-100\" name=\"__codelineno-2-100\"></a> description = \"Detects BPFDoor malware.\"\n<a href=\"#__codelineno-2-101\" id=\"__codelineno-2-101\" name=\"__codelineno-2-101\"></a> reference_sample = \"76bf736b25d5c9aaf6a84edd4e615796fffc338a893b49c120c0b4941ce37925\"\n<a href=\"#__codelineno-2-102\" id=\"__codelineno-2-102\" name=\"__codelineno-2-102\"></a> strings:\n<a href=\"#__codelineno-2-103\" id=\"__codelineno-2-103\" name=\"__codelineno-2-103\"></a> $a1 = \"getshell\" ascii fullword\n<a href=\"#__codelineno-2-104\" id=\"__codelineno-2-104\" name=\"__codelineno-2-104\"></a> $a2 = \"/sbin/agetty --noclear tty1 linux\" ascii fullword\n<a href=\"#__codelineno-2-105\" id=\"__codelineno-2-105\" name=\"__codelineno-2-105\"></a> $a3 = \"packet_loop\" ascii fullword\n<a href=\"#__codelineno-2-106\" id=\"__codelineno-2-106\" name=\"__codelineno-2-106\"></a> $a4 = \"godpid\" ascii fullword\n<a href=\"#__codelineno-2-107\" id=\"__codelineno-2-107\" name=\"__codelineno-2-107\"></a> $a5 = \"ttcompat\" ascii fullword\n<a href=\"#__codelineno-2-108\" id=\"__codelineno-2-108\" name=\"__codelineno-2-108\"></a> $a6 = \"decrypt_ctx\" ascii fullword\n<a href=\"#__codelineno-2-109\" id=\"__codelineno-2-109\" name=\"__codelineno-2-109\"></a> $a7 = \"rc4_init\" ascii fullword\n<a href=\"#__codelineno-2-110\" id=\"__codelineno-2-110\" name=\"__codelineno-2-110\"></a> $b1 = { D0 48 89 45 F8 48 8B 45 F8 0F B6 40 0C C0 E8 04 0F B6 C0 C1 }\n<a href=\"#__codelineno-2-111\" id=\"__codelineno-2-111\" name=\"__codelineno-2-111\"></a> condition:\n<a href=\"#__codelineno-2-112\" id=\"__codelineno-2-112\" name=\"__codelineno-2-112\"></a> all of ($a*) or 1 of ($b*)\n<a href=\"#__codelineno-2-113\" id=\"__codelineno-2-113\" name=\"__codelineno-2-113\"></a>}\n<a href=\"#__codelineno-2-114\" id=\"__codelineno-2-114\" name=\"__codelineno-2-114\"></a>\n<a href=\"#__codelineno-2-115\" id=\"__codelineno-2-115\" name=\"__codelineno-2-115\"></a>rule Linux_Trojan_BPFDoor_6 {\n<a href=\"#__codelineno-2-116\" id=\"__codelineno-2-116\" name=\"__codelineno-2-116\"></a> meta:\n<a href=\"#__codelineno-2-117\" id=\"__codelineno-2-117\" name=\"__codelineno-2-117\"></a> Author = \"Elastic Security\"\n<a href=\"#__codelineno-2-118\" id=\"__codelineno-2-118\" name=\"__codelineno-2-118\"></a> creation_date = \"2022-05-10\"\n<a href=\"#__codelineno-2-119\" id=\"__codelineno-2-119\" name=\"__codelineno-2-119\"></a> last_modified = \"2022-05-10\"\n<a href=\"#__codelineno-2-120\" id=\"__codelineno-2-120\" name=\"__codelineno-2-120\"></a> os = \"Linux\"\n<a href=\"#__codelineno-2-121\" id=\"__codelineno-2-121\" name=\"__codelineno-2-121\"></a> arch = \"x86\"\n<a href=\"#__codelineno-2-122\" id=\"__codelineno-2-122\" name=\"__codelineno-2-122\"></a> category_type = \"Trojan\"\n<a href=\"#__codelineno-2-123\" id=\"__codelineno-2-123\" name=\"__codelineno-2-123\"></a> family = \"BPFDoor\"\n<a href=\"#__codelineno-2-124\" id=\"__codelineno-2-124\" name=\"__codelineno-2-124\"></a> threat_name = \"Linux.Trojan.BPFDoor\"\n<a href=\"#__codelineno-2-125\" id=\"__codelineno-2-125\" name=\"__codelineno-2-125\"></a> description = \"Detects BPFDoor malware.\"\n<a href=\"#__codelineno-2-126\" id=\"__codelineno-2-126\" name=\"__codelineno-2-126\"></a> reference_sample = \"dc8346bf443b7b453f062740d8ae8d8d7ce879672810f4296158f90359dcae3a\"\n<a href=\"#__codelineno-2-127\" id=\"__codelineno-2-127\" name=\"__codelineno-2-127\"></a> strings:\n<a href=\"#__codelineno-2-128\" id=\"__codelineno-2-128\" name=\"__codelineno-2-128\"></a> $a1 = \"getpassw\" ascii fullword\n<a href=\"#__codelineno-2-129\" id=\"__codelineno-2-129\" name=\"__codelineno-2-129\"></a> $a2 = \"(udp[8:2]=0x7255) or (icmp[8:2]=0x7255) or (tcp[((tcp[12]&amp;0xf0)&gt;&gt;2):2]=0x5293)\" ascii fullword\n<a href=\"#__codelineno-2-130\" id=\"__codelineno-2-130\" name=\"__codelineno-2-130\"></a> $a3 = \"/var/run/haldrund.pid\" ascii fullword\n<a href=\"#__codelineno-2-131\" id=\"__codelineno-2-131\" name=\"__codelineno-2-131\"></a> $a4 = \"Couldn't install filter %s: %s\" ascii fullword\n<a href=\"#__codelineno-2-132\" id=\"__codelineno-2-132\" name=\"__codelineno-2-132\"></a> $a5 = \"godpid\" ascii fullword\n<a href=\"#__codelineno-2-133\" id=\"__codelineno-2-133\" name=\"__codelineno-2-133\"></a> condition:\n<a href=\"#__codelineno-2-134\" id=\"__codelineno-2-134\" name=\"__codelineno-2-134\"></a> all of them\n<a href=\"#__codelineno-2-135\" id=\"__codelineno-2-135\" name=\"__codelineno-2-135\"></a>}\n</code>"
                }
            ]
        },
        {
            "id": "<chapter_0x7a5b022f>",
            "title": "Interacting with BPFDoor",
            "title_level": 2,
            "sentences": [
                {
                    "id": "<sentence_0x2a8599f>",
                    "is_empty": false,
                    "have_tags": false,
                    "tags": {},
                    "text": "The Elastic Security Team has released several tools that can aid in further research regarding BPFDoor to include a network scanner used to identify infected hosts, a BPFDoor malware configuration extractor, and a BPFDoor client binary that can be used to actively interact with a sample.",
                    "html": "<p>The Elastic Security Team has released several tools that can aid in further research regarding BPFDoor to include a network scanner used to identify infected hosts, a BPFDoor malware configuration extractor, and a BPFDoor client binary that can be used to actively interact with a sample.</p>"
                }
            ]
        },
        {
            "id": "<chapter_0x1ad90c07>",
            "title": "BPFDoor Scanner",
            "title_level": 3,
            "sentences": [
                {
                    "id": "<sentence_0x762b5096>",
                    "is_empty": false,
                    "have_tags": true,
                    "tags": {
                        "<a_0xc6fddb42>": "../../../../../tools/bpfdoor-scanner/"
                    },
                    "text": "The Elastic Security Team has released a Python script that can identify if you have BPFDoor infected hosts.",
                    "html": "<p>The Elastic Security Team <a href=\"../../../../../tools/bpfdoor-scanner/\">has released</a> a Python script that can identify if you have BPFDoor infected hosts.</p>"
                },
                {
                    "id": "<sentence_0xb9d6bfab>",
                    "is_empty": false,
                    "have_tags": true,
                    "tags": {
                        "<code_0x18c7a99a>": "68/UDP",
                        "<code_0xe30d89f1>": "53/UDP"
                    },
                    "text": "The scanner sends a packet to a defined IP address using the default target port (68/UDP)and default interface. It listens to return traffic on port 53/UDP.",
                    "html": "<p>The scanner sends a packet to a defined IP address using the default target port (<code>68/UDP</code>)and default interface. It listens to return traffic on port <code>53/UDP</code>.</p>"
                },
                {
                    "id": "<sentence_0xe78c9494>",
                    "is_empty": false,
                    "have_tags": true,
                    "tags": {
                        "<img_0xb6f2ec58>": "../media/image17.png"
                    },
                    "text": "BPFDoor scanner tool",
                    "html": "<figure>\n<p><img alt=\"BPFDoor scanner tool\" src=\"../media/image17.png\" title=\"BPFDoor scanner tool\"/></p>\n<figcaption>BPFDoor scanner tool</figcaption>\n</figure>"
                }
            ]
        },
        {
            "id": "<chapter_0xc0be1e84>",
            "title": "BPFDoor Configuration Extractor",
            "title_level": 3,
            "sentences": [
                {
                    "id": "<sentence_0xc8c659f8>",
                    "is_empty": false,
                    "have_tags": false,
                    "tags": {},
                    "text": "This tool will allow you to extract configurations from any BPFDoor malware you may have collected. This will allow you to develop additional signatures and further analysis of the malware as well as your environment.",
                    "html": "<p>This tool will allow you to extract configurations from any BPFDoor malware you may have collected. This will allow you to develop additional signatures and further analysis of the malware as well as your environment.</p>"
                },
                {
                    "id": "<sentence_0x2b9eeb89>",
                    "is_empty": false,
                    "have_tags": true,
                    "tags": {
                        "<a_0x5356de0b>": "../../../../../tools/bpfdoor-config-extractor/"
                    },
                    "text": "The BPFDoor configuration extractor can be downloaded here.",
                    "html": "<p>The BPFDoor configuration extractor can be downloaded <a href=\"../../../../../tools/bpfdoor-config-extractor/\">here</a>.</p>"
                },
                {
                    "id": "<sentence_0x831e5aa>",
                    "is_empty": false,
                    "have_tags": true,
                    "tags": {
                        "<img_0xf9caff6d>": "../media/image16.png"
                    },
                    "text": "BPFDoor configuration extractor",
                    "html": "<figure>\n<p><img alt=\"BPFDoor configuration extractor\" src=\"../media/image16.png\" title=\"BPFDoor configuration extractor\"/></p>\n<figcaption>BPFDoor configuration extractor</figcaption>\n</figure>"
                }
            ]
        },
        {
            "id": "<chapter_0x70c73628>",
            "title": "BPFDoor Client POC",
            "title_level": 3,
            "sentences": [
                {
                    "id": "<sentence_0xe525940d>",
                    "is_empty": false,
                    "have_tags": false,
                    "tags": {},
                    "text": "Quickly after beginning our research into this malware we realized we would also need to actively interact with BPFDoor in order to observe the full extent of the capabilities that it possesses and monitor what these capabilities would look like from a host and SIEM level.",
                    "html": "<p>Quickly after beginning our research into this malware we realized we would also need to actively interact with BPFDoor in order to observe the full extent of the capabilities that it possesses and monitor what these capabilities would look like from a host and SIEM level.</p>"
                },
                {
                    "id": "<sentence_0xe3c5b4cb>",
                    "is_empty": false,
                    "have_tags": true,
                    "tags": {
                        "<a_0x71037ddb>": "https://scapy.net/"
                    },
                    "text": "In order to do this, we had to break down the BPF filters in the BPFDoor source code so we could craft packets for the different protocols. To do this, we used Scapy, a packet manipulation program, to ensure we could pass the filters for the purpose of activating the backdoor. Once we ensured we could pass the filters, Rhys Rustad-Elliott, an engineer at Elastic built a BPFDoor client that accepts a password, IP address, and port allowing you to connect to a BPFDoor sample and interact if you possess the samples hardcoded passwords.",
                    "html": "<p>In order to do this, we had to break down the BPF filters in the BPFDoor source code so we could craft packets for the different protocols. To do this, we used <a href=\"https://scapy.net/\">Scapy</a>, a packet manipulation program, to ensure we could pass the filters for the purpose of activating the backdoor. Once we ensured we could pass the filters, Rhys Rustad-Elliott, an engineer at Elastic built a BPFDoor client that accepts a password, IP address, and port allowing you to connect to a BPFDoor sample and interact if you possess the sample\u2019s hardcoded passwords.</p>"
                },
                {
                    "id": "<sentence_0xd0557776>",
                    "is_empty": false,
                    "have_tags": false,
                    "tags": {},
                    "text": "Depending on the password or lack of password provided, BPFDoor will behave exactly the same way it would in the wild. You can invoke a reverse shell, establish a bind shell, or connect to it with no supplied password to receive a ping-back confirming its installation.",
                    "html": "<p>Depending on the password or lack of password provided, BPFDoor will behave exactly the same way it would in the wild. You can invoke a reverse shell, establish a bind shell, or connect to it with no supplied password to receive a ping-back confirming its installation.</p>"
                },
                {
                    "id": "<sentence_0x81b40c1b>",
                    "is_empty": false,
                    "have_tags": true,
                    "tags": {
                        "<img_0x43917176>": "../media/image13.png"
                    },
                    "text": "A preview of the BPFDoor Client developed by Elastic Security to assist in research",
                    "html": "<figure>\n<p><img alt=\"A preview of the BPFDoor Client developed by Elastic Security to assist in research\" src=\"../media/image13.png\" title=\"A preview of the BPFDoor Client developed by Elastic Security to assist in research\"/></p>\n<figcaption>A preview of the BPFDoor Client developed by Elastic Security to assist in research</figcaption>\n</figure>"
                },
                {
                    "id": "<sentence_0x1f1ea2d0>",
                    "is_empty": false,
                    "have_tags": false,
                    "tags": {},
                    "text": "Researchers looking to use BPFDoor can for access to the BPFDoor client POC. Please note that these tools will be shared at our discretion with those in the trusted security community looking to improve the detection of this vulnerability.",
                    "html": "<p>Researchers looking to use BPFDoor can <a href=\"mailto:threat-notification@elastic.co\">reach out to Elastic Security</a> for access to the BPFDoor client POC. Please note that these tools will be shared at our discretion with those in the trusted security community looking to improve the detection of this vulnerability.</p>"
                }
            ]
        },
        {
            "id": "<chapter_0xcd05a5de>",
            "title": "Impact",
            "title_level": 2,
            "sentences": [
                {
                    "id": "<sentence_0xc23b0555>",
                    "is_empty": false,
                    "have_tags": false,
                    "tags": {},
                    "text": "The following MITRE ATT&CK Tactic, Techniques, and Sub-techniques have been observed with the BPFDoor malware.",
                    "html": "<p>The following MITRE ATT&amp;CK Tactic, Techniques, and Sub-techniques have been observed with the BPFDoor malware.</p>"
                }
            ]
        },
        {
            "id": "<chapter_0x86071790>",
            "title": "Tactics",
            "title_level": 3,
            "sentences": [
                {
                    "id": "<sentence_0x6af8d3fc>",
                    "is_empty": false,
                    "have_tags": false,
                    "tags": {},
                    "text": "Tactics represent the why of an ATT&CK technique or sub-technique. It is the adversarys tactical goal: the reason for performing an action.",
                    "html": "<p>Tactics represent the \u201cwhy\u201d of an ATT&amp;CK technique or sub-technique. It is the adversary\u2019s tactical goal: the reason for performing an action.</p>"
                },
                {
                    "id": "<sentence_0xb66c7dd6>",
                    "is_empty": false,
                    "have_tags": true,
                    "tags": {
                        "<a_0x70129790>": "https://attack.mitre.org/tactics/TA0002/"
                    },
                    "text": "Execution",
                    "html": "<ul>\n<li><a href=\"https://attack.mitre.org/tactics/TA0002/\">Execution</a></li>\n</ul>"
                }
            ]
        },
        {
            "id": "<chapter_0x7f203d24>",
            "title": "Techniques (sub-techniques)",
            "title_level": 3,
            "sentences": [
                {
                    "id": "<sentence_0xd3bd5b6d>",
                    "is_empty": false,
                    "have_tags": false,
                    "tags": {},
                    "text": "Techniques (and sub-techniques) represent how an adversary achieves a tactical goal by performing an action.",
                    "html": "<p>Techniques (and sub-techniques) represent \u2018how\u2019 an adversary achieves a tactical goal by performing an action.</p>"
                },
                {
                    "id": "<sentence_0x18d2a088>",
                    "is_empty": false,
                    "have_tags": true,
                    "tags": {
                        "<a_0xa8704bda>": "https://attack.mitre.org/techniques/T1106/",
                        "<a_0x9a56fa47>": "https://attack.mitre.org/techniques/T1133/",
                        "<a_0x7ff57705>": "https://attack.mitre.org/techniques/T1564/",
                        "<a_0x48c9f760>": "https://attack.mitre.org/techniques/T1070/",
                        "<a_0x52af822c>": "https://attack.mitre.org/techniques/T1095/",
                        "<a_0x66e1a982>": "https://attack.mitre.org/techniques/T1059/004",
                        "<a_0xcc665492>": "https://attack.mitre.org/techniques/T1548/001/"
                    },
                    "text": "Native API<crlf>External Remote Services<crlf>Hide Artifacts<crlf>Indicator Removal on Host<crlf>Non-Application Layer Protocol<crlf>Command and Scripting Interpreter: Unix Shell<crlf>Abuse Elevation Control Mechanism: Setuid and Setgid",
                    "html": "<ul>\n<li><a href=\"https://attack.mitre.org/techniques/T1106/\">Native API</a></li>\n<li><a href=\"https://attack.mitre.org/techniques/T1133/\">External Remote Services</a></li>\n<li><a href=\"https://attack.mitre.org/techniques/T1564/\">Hide Artifacts</a></li>\n<li><a href=\"https://attack.mitre.org/techniques/T1070/\">Indicator Removal on Host</a></li>\n<li><a href=\"https://attack.mitre.org/techniques/T1095/\">Non-Application Layer Protocol</a></li>\n<li><a href=\"https://attack.mitre.org/techniques/T1059/004\">Command and Scripting Interpreter: Unix Shell</a></li>\n<li><a href=\"https://attack.mitre.org/techniques/T1548/001/\">Abuse Elevation Control Mechanism: Setuid and Setgid</a></li>\n</ul>"
                }
            ]
        },
        {
            "id": "<chapter_0xd31db2fd>",
            "title": "Source Pseudocode",
            "title_level": 2,
            "sentences": [
                {
                    "id": "<sentence_0x26ba3365>",
                    "is_empty": false,
                    "have_tags": true,
                    "tags": {
                        "<a_0x993fef28>": "../media/bpfdoor_pseudocode.pdf"
                    },
                    "text": "To clearly articulate the details of this malware, weve created two diagrams that outline the specific pseudocode for BPFDoor based on the source code uploaded to VT and found on Pastebin. While this contains a lot of detail, it is simple to understand if researchers choose to further this research.",
                    "html": "<p>To clearly articulate the details of this malware, we\u2019ve created <a href=\"../media/bpfdoor_pseudocode.pdf\">two diagrams</a> that outline the specific pseudocode for BPFDoor based on the source code uploaded to VT and found on Pastebin. While this contains a lot of detail, it is simple to understand if researchers choose to further this research.</p>"
                }
            ]
        },
        {
            "id": "<chapter_0xa22a636c>",
            "title": "Summary",
            "title_level": 2,
            "sentences": [
                {
                    "id": "<sentence_0x8737091e>",
                    "is_empty": false,
                    "have_tags": false,
                    "tags": {},
                    "text": "While threat groups continue to increase in maturity, we expect this kind of mature, well designed and hidden threat will continue to be found within Linux environments. These kinds of findings reiterate the importance of comprehensive security controls across the entirety of a fleet, rather than simply focusing on user endpoints.",
                    "html": "<p>While threat groups continue to increase in maturity, we expect this kind of mature, well designed and hidden threat will continue to be found within Linux environments. These kinds of findings reiterate the importance of comprehensive security controls across the entirety of a fleet, rather than simply focusing on user endpoints.</p>"
                },
                {
                    "id": "<sentence_0xd300d6a>",
                    "is_empty": false,
                    "have_tags": false,
                    "tags": {},
                    "text": "BPFDoor demonstrates a perfect example of how important monitoring workloads within Linux environments can be. Payloads such as this are near-on impossible to observe and detect without sufficient controls, and should be considered a moving trend within the general adversarial landscape.",
                    "html": "<p>BPFDoor demonstrates a perfect example of how important monitoring workloads within Linux environments can be. Payloads such as this are near-on impossible to observe and detect without sufficient controls, and should be considered a moving trend within the general adversarial landscape.</p>"
                }
            ]
        },
        {
            "id": "<chapter_0xef37855e>",
            "title": "Observables",
            "title_level": 2,
            "sentences": [
                {
                    "id": "<sentence_0x7c1757b>",
                    "is_empty": true,
                    "have_tags": true,
                    "tags": {
                        "<table_0x5c29fa8d>": {
                            "Observable": {
                                "0": "/dev/shm/kdmtmpflush",
                                "1": "/var/run/haldrund.pid",
                                "2": "/var/run/kdevrund.pid",
                                "3": "/var/run/xinetd.lock",
                                "4": "74ef6cc38f5a1a80148752b63c117e6846984debd2af806c65887195a8eccc56",
                                "5": "07ecb1f2d9ffbd20a46cd36cd06b022db3cc8e45b1ecab62cd11f9ca7a26ab6d",
                                "6": "76bf736b25d5c9aaf6a84edd4e615796fffc338a893b49c120c0b4941ce37925",
                                "7": "93f4262fce8c6b4f8e239c35a0679fbbbb722141b95a5f2af53a2bcafe4edd1c",
                                "8": "96e906128095dead57fdc9ce8688bb889166b67c9a1b8fdb93d7cff7f3836bb9",
                                "9": "599ae527f10ddb4625687748b7d3734ee51673b664f2e5d0346e64f85e185683",
                                "10": "2e0aa3da45a0360d051359e1a038beff8551b957698f21756cfc6ed5539e4bdb",
                                "11": "f47de978da1dbfc5e0f195745e3368d3ceef034e964817c66ba01396a1953d72",
                                "12": "fd1b20ee5bd429046d3c04e9c675c41e9095bea70e0329bd32d7edd17ebaf68a",
                                "13": "5faab159397964e630c4156f8852bcc6ee46df1cdd8be2a8d3f3d8e5980f3bb3",
                                "14": "f8a5e735d6e79eb587954a371515a82a15883cf2eda9d7ddb8938b86e714ea27",
                                "15": "5b2a079690efb5f4e0944353dd883303ffd6bab4aad1f0c88b49a76ddcb28ee9",
                                "16": "97a546c7d08ad34dfab74c9c8a96986c54768c592a8dae521ddcf612a84fb8cc",
                                "17": "c80bd1c4a796b4d3944a097e96f384c85687daeedcdcf05cc885c8c9b279b09c",
                                "18": "4c5cf8f977fc7c368a8e095700a44be36c8332462c0b1e41bff03238b2bf2a2d"
                            },
                            "Type": {
                                "0": "process name",
                                "1": "file name",
                                "2": "file name",
                                "3": "file name",
                                "4": "SHA-256",
                                "5": "SHA-256",
                                "6": "SHA-256",
                                "7": "SHA-256",
                                "8": "SHA-256",
                                "9": "SHA-256",
                                "10": "SHA-256",
                                "11": "SHA-256",
                                "12": "SHA-256",
                                "13": "SHA-256",
                                "14": "SHA-256",
                                "15": "SHA-256",
                                "16": "SHA-256",
                                "17": "SHA-256",
                                "18": "SHA-256"
                            },
                            "Reference": {
                                "0": "BPFDoor process name",
                                "1": "BPFDoor file name",
                                "2": "BPFDoor file name",
                                "3": "BPFDoor file name",
                                "4": "BPFDoor malware",
                                "5": "BPFDoor malware",
                                "6": "BPFDoor malware",
                                "7": "BPFDoor malware",
                                "8": "BPFDoor malware",
                                "9": "BPFDoor malware",
                                "10": "BPFDoor malware",
                                "11": "BPFDoor malware",
                                "12": "BPFDoor malware",
                                "13": "BPFDoor malware",
                                "14": "BPFDoor malware",
                                "15": "BPFDoor malware",
                                "16": "BPFDoor malware",
                                "17": "BPFDoor malware",
                                "18": "BPFDoor malware"
                            },
                            "Note": {
                                "0": "Observed process name of BPFDoor",
                                "1": "Observed BPFDoor PID file",
                                "2": "Observed BPFDoor PID file",
                                "3": "Observed BPFDoor lock file",
                                "4": "",
                                "5": "",
                                "6": "",
                                "7": "",
                                "8": "",
                                "9": "",
                                "10": "",
                                "11": "",
                                "12": "",
                                "13": "",
                                "14": "",
                                "15": "",
                                "16": "",
                                "17": "",
                                "18": ""
                            }
                        }
                    },
                    "text": "",
                    "html": "<table>\n<thead>\n<tr>\n<th>Observable</th>\n<th>Type</th>\n<th>Reference</th>\n<th>Note</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>/dev/shm/kdmtmpflush</code></td>\n<td>process name</td>\n<td>BPFDoor process name</td>\n<td>Observed process name of BPFDoor</td>\n</tr>\n<tr>\n<td><code>/var/run/haldrund.pid</code></td>\n<td>file name</td>\n<td>BPFDoor file name</td>\n<td>Observed BPFDoor PID file</td>\n</tr>\n<tr>\n<td><code>/var/run/kdevrund.pid</code></td>\n<td>file name</td>\n<td>BPFDoor file name</td>\n<td>Observed BPFDoor PID file</td>\n</tr>\n<tr>\n<td><code>/var/run/xinetd.lock</code></td>\n<td>file name</td>\n<td>BPFDoor file name</td>\n<td>Observed BPFDoor lock file</td>\n</tr>\n<tr>\n<td><code>74ef6cc38f5a1a80148752b63c117e6846984debd2af806c65887195a8eccc56</code></td>\n<td>SHA-256</td>\n<td>BPFDoor malware</td>\n<td></td>\n</tr>\n<tr>\n<td><code>07ecb1f2d9ffbd20a46cd36cd06b022db3cc8e45b1ecab62cd11f9ca7a26ab6d</code></td>\n<td>SHA-256</td>\n<td>BPFDoor malware</td>\n<td></td>\n</tr>\n<tr>\n<td><code>76bf736b25d5c9aaf6a84edd4e615796fffc338a893b49c120c0b4941ce37925</code></td>\n<td>SHA-256</td>\n<td>BPFDoor malware</td>\n<td></td>\n</tr>\n<tr>\n<td><code>93f4262fce8c6b4f8e239c35a0679fbbbb722141b95a5f2af53a2bcafe4edd1c</code></td>\n<td>SHA-256</td>\n<td>BPFDoor malware</td>\n<td></td>\n</tr>\n<tr>\n<td><code>96e906128095dead57fdc9ce8688bb889166b67c9a1b8fdb93d7cff7f3836bb9</code></td>\n<td>SHA-256</td>\n<td>BPFDoor malware</td>\n<td></td>\n</tr>\n<tr>\n<td><code>599ae527f10ddb4625687748b7d3734ee51673b664f2e5d0346e64f85e185683</code></td>\n<td>SHA-256</td>\n<td>BPFDoor malware</td>\n<td></td>\n</tr>\n<tr>\n<td><code>2e0aa3da45a0360d051359e1a038beff8551b957698f21756cfc6ed5539e4bdb</code></td>\n<td>SHA-256</td>\n<td>BPFDoor malware</td>\n<td></td>\n</tr>\n<tr>\n<td><code>f47de978da1dbfc5e0f195745e3368d3ceef034e964817c66ba01396a1953d72</code></td>\n<td>SHA-256</td>\n<td>BPFDoor malware</td>\n<td></td>\n</tr>\n<tr>\n<td><code>fd1b20ee5bd429046d3c04e9c675c41e9095bea70e0329bd32d7edd17ebaf68a</code></td>\n<td>SHA-256</td>\n<td>BPFDoor malware</td>\n<td></td>\n</tr>\n<tr>\n<td><code>5faab159397964e630c4156f8852bcc6ee46df1cdd8be2a8d3f3d8e5980f3bb3</code></td>\n<td>SHA-256</td>\n<td>BPFDoor malware</td>\n<td></td>\n</tr>\n<tr>\n<td><code>f8a5e735d6e79eb587954a371515a82a15883cf2eda9d7ddb8938b86e714ea27</code></td>\n<td>SHA-256</td>\n<td>BPFDoor malware</td>\n<td></td>\n</tr>\n<tr>\n<td><code>5b2a079690efb5f4e0944353dd883303ffd6bab4aad1f0c88b49a76ddcb28ee9</code></td>\n<td>SHA-256</td>\n<td>BPFDoor malware</td>\n<td></td>\n</tr>\n<tr>\n<td><code>97a546c7d08ad34dfab74c9c8a96986c54768c592a8dae521ddcf612a84fb8cc</code></td>\n<td>SHA-256</td>\n<td>BPFDoor malware</td>\n<td></td>\n</tr>\n<tr>\n<td><code>c80bd1c4a796b4d3944a097e96f384c85687daeedcdcf05cc885c8c9b279b09c</code></td>\n<td>SHA-256</td>\n<td>BPFDoor malware</td>\n<td></td>\n</tr>\n<tr>\n<td><code>4c5cf8f977fc7c368a8e095700a44be36c8332462c0b1e41bff03238b2bf2a2d</code></td>\n<td>SHA-256</td>\n<td>BPFDoor malware</td>\n<td></td>\n</tr>\n</tbody>\n</table>"
                }
            ]
        },
        {
            "id": "<chapter_0xb1b8984b>",
            "title": "References",
            "title_level": 2,
            "sentences": [
                {
                    "id": "<sentence_0x4a874e6f>",
                    "is_empty": false,
                    "have_tags": false,
                    "tags": {},
                    "text": "https://doublepulsar.com/bpfdoor-an-active-chinese-global-surveillance-tool-54b078f1a896<crlf>https://www.pwc.com/gx/en/issues/cybersecurity/cyber-threat-intelligence/cyber-year-in-retrospect/yir-cyber-threats-report-download.pdf<crlf>https://www.pangulab.cn/en/post/the_bvp47_a_top-tier_backdoor_of_us_nsa_equation_group<crlf>https://www.pangulab.cn/en/post/the_bvp47_a_top-tier_backdoor_of_us_nsa_equation_group",
                    "html": "<ul>\n<li>https://doublepulsar.com/bpfdoor-an-active-chinese-global-surveillance-tool-54b078f1a896</li>\n<li>https://www.pwc.com/gx/en/issues/cybersecurity/cyber-threat-intelligence/cyber-year-in-retrospect/yir-cyber-threats-report-download.pdf</li>\n<li>https://www.pangulab.cn/en/post/the_bvp47_a_top-tier_backdoor_of_us_nsa_equation_group</li>\n<li>https://www.pangulab.cn/en/post/the_bvp47_a_top-tier_backdoor_of_us_nsa_equation_group</li>\n</ul>"
                },
                {
                    "id": "<sentence_0x2af54249>",
                    "is_empty": false,
                    "have_tags": false,
                    "tags": {},
                    "text": "Last update:<crlf>May 19, 2022<crlf>Created:<crlf>May 18, 2022",
                    "html": "\n \n Last update:\n May 19, 2022\n Created:\n May 18, 2022\n"
                }
            ]
        }
    ]
}