{
    "id": "<report_0xdec25511>",
    "url": "https://www.microsoft.com/security/blog/2022/04/26/microsoft-finds-new-elevation-of-privilege-linux-vulnerability-nimbuspwn",
    "title": "Microsoft finds new elevation of privilege Linux vulnerability, Nimbuspwn",
    "meta": [
        {
            "id": "<chapter_0x8d48f678>",
            "title": "Microsoft finds new elevation of privilege Linux vulnerability, Nimbuspwn",
            "title_level": 1,
            "sentences": [
                {
                    "id": "<sentence_0x9b0d9018>",
                    "is_empty": false,
                    "have_tags": false,
                    "tags": {},
                    "text": "Microsoft 365 Defender Research Team",
                    "html": "<ul class=\"authors\">\n<li class=\"author-item\">\nMicrosoft 365 Defender Research Team\n</li>\n</ul>"
                }
            ]
        }
    ],
    "chapters": [
        {
            "id": "<chapter_0x52e3a969>",
            "title": "Microsoft finds new elevation of privilege Linux vulnerability, Nimbuspwn",
            "title_level": 1,
            "sentences": [
                {
                    "id": "<sentence_0x9b601a7d>",
                    "is_empty": false,
                    "have_tags": false,
                    "tags": {},
                    "text": "Microsoft has discovered several vulnerabilities, collectively referred to as Nimbuspwn, that could allow an attacker to elevate privileges to root on many Linux desktop endpoints. The vulnerabilities can be chained together to gain root privileges on Linux systems, allowing attackers to deploy payloads, like a root backdoor, and perform other malicious actions via arbitrary root code execution. Moreover, the Nimbuspwn vulnerabilities could potentially be leveraged as a vector for root access by more sophisticated threats, such as malware or ransomware, to achieve greater impact on vulnerable devices.",
                    "html": "<p>Microsoft has discovered several vulnerabilities, collectively referred to as Nimbuspwn, that could allow an attacker to elevate privileges to root on many Linux desktop endpoints. The vulnerabilities can be chained together to gain root privileges on Linux systems, allowing attackers to deploy payloads, like a root backdoor, and perform other malicious actions via arbitrary root code execution. Moreover, the Nimbuspwn vulnerabilities could potentially be leveraged as a vector for root access by more sophisticated threats, such as malware or ransomware, to achieve greater impact on vulnerable devices.</p>"
                },
                {
                    "id": "<sentence_0x4e2ece63>",
                    "is_empty": false,
                    "have_tags": true,
                    "tags": {
                        "<a_0x569f1064>": "https://www.microsoft.com/msrc/cvd?rtc=1",
                        "<a_0xde006105>": "https://www.microsoft.com/msrc/msvr",
                        "<a_0x4e177bc9>": "https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2022-29799",
                        "<a_0xc981150a>": "https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2022-29800"
                    },
                    "text": "We discovered the vulnerabilities by listening to messages on the System Bus while performing code reviews and dynamic analysis on services that run as root, noticing an odd pattern in a systemd unit called networkd-dispatcher. Reviewing the code flow for networkd-dispatcher revealed multiple security concerns, including directory traversal, symlink race, and time-of-check-time-of-use race condition issues, which could be leveraged to elevate privileges and deploy malware or carry out other malicious activities. We shared these vulnerabilities with the relevant maintainers through Coordinated Vulnerability Disclosure (CVD) via Microsoft Security Vulnerability Research (MSVR). Fixes for these vulnerabilities, now identified as CVE-2022-29799 and CVE-2022-29800, have been successfully deployed by the maintainer of the networkd-dispatcher, Clayton Craft. We wish to thank Clayton for his professionalism and collaboration in resolving those issues. Users of networkd-dispatcher are encouraged to update their instances.",
                    "html": "<p>We discovered the vulnerabilities by listening to messages on the System Bus while performing code reviews and dynamic analysis on services that run as root, noticing an odd pattern in a systemd unit called networkd-dispatcher. Reviewing the code flow for networkd-dispatcher revealed multiple security concerns, including directory traversal, symlink race, and time-of-check-time-of-use race condition issues, which could be leveraged to elevate privileges and deploy malware or carry out other malicious activities. We shared these vulnerabilities with the relevant maintainers through <a href=\"https://www.microsoft.com/msrc/cvd?rtc=1\">Coordinated Vulnerability Disclosure</a> (CVD) via <a href=\"https://www.microsoft.com/msrc/msvr\">Microsoft Security Vulnerability Research</a> (MSVR). Fixes for these vulnerabilities, now identified as <a href=\"https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2022-29799\">CVE-2022-29799</a> and <a href=\"https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2022-29800\">CVE-2022-29800</a>, have been successfully deployed by the maintainer of the networkd-dispatcher, Clayton Craft. We wish to thank Clayton for his professionalism and collaboration in resolving those issues. Users of networkd-dispatcher are encouraged to update their instances.</p>"
                },
                {
                    "id": "<sentence_0x26663789>",
                    "is_empty": false,
                    "have_tags": true,
                    "tags": {
                        "<a_0x14871a4d>": "https://docs.microsoft.com/microsoft-365/security/defender-endpoint/microsoft-defender-endpoint-linux?view=o365-worldwide"
                    },
                    "text": "As organizational environments continue to rely on a diverse range of devices and systems, they require comprehensive solutions that provide cross-platform protection and a holistic view of their security posture to mitigate threats, such as Nimbuspwn. The growing number of vulnerabilities on Linux environments emphasize the need for strong monitoring of the platforms operating system and its components. Microsoft Defender for Endpoint enables organizations to gain this necessary visibility and detect such threats on Linux devices, allowing organizations to detect, manage, respond, and remediate vulnerabilities and threats across different platforms, including Windows, Linux, Mac, iOS, and Android.",
                    "html": "<p>As organizational environments continue to rely on a diverse range of devices and systems, they require comprehensive solutions that provide cross-platform protection and a holistic view of their security posture to mitigate threats, such as Nimbuspwn. The growing number of vulnerabilities on Linux environments emphasize the need for strong monitoring of the platform\u2019s operating system and its components. Microsoft Defender for Endpoint enables organizations to gain this necessary visibility and detect such threats on <a href=\"https://docs.microsoft.com/microsoft-365/security/defender-endpoint/microsoft-defender-endpoint-linux?view=o365-worldwide\">Linux devices</a>, allowing organizations to detect, manage, respond, and remediate vulnerabilities and threats across different platforms, including Windows, Linux, Mac, iOS, and Android.</p>"
                },
                {
                    "id": "<sentence_0xade5d96d>",
                    "is_empty": false,
                    "have_tags": false,
                    "tags": {},
                    "text": "In this blog post, we will share some information about the affected components and examine the vulnerabilities we uncovered. Detailing how our cross-domain visibility helps us uncover new and unknown threats to continually improve security, we are also sharing details from our research with the larger security community to underscore the importance of securing platforms and devices.",
                    "html": "<p>In this blog post, we will share some information about the affected components and examine the vulnerabilities we uncovered. Detailing how our cross-domain visibility helps us uncover new and unknown threats to continually improve security, we are also sharing details from our research with the larger security community to underscore the importance of securing platforms and devices.</p>"
                }
            ]
        },
        {
            "id": "<chapter_0xffbb72ef>",
            "title": "Background D-Bus",
            "title_level": 2,
            "sentences": [
                {
                    "id": "<sentence_0x5f00fcde>",
                    "is_empty": false,
                    "have_tags": true,
                    "tags": {
                        "<a_0xdf796788>": "https://en.wikipedia.org/wiki/D-Bus",
                        "<a_0x68c87521>": "https://www.freedesktop.org/"
                    },
                    "text": "D-Bus (short for Desktop-Bus) is an inter-process communication channel (IPC) mechanism developed by the freedesktop.org project. D-Bus is a software-bus and allows processes on the same endpoint to communicate by transmitting messages and responding to them. D-Bus supports two main ways of communicating:",
                    "html": "<p><a href=\"https://en.wikipedia.org/wiki/D-Bus\">D-Bus</a> (short for \u201cDesktop-Bus\u201d) is an inter-process communication channel (IPC) mechanism developed by the <a href=\"https://www.freedesktop.org/\">freedesktop.org</a> project. D-Bus is a software-bus and allows processes on the same endpoint to communicate by transmitting messages and responding to them. D-Bus supports two main ways of communicating:</p>"
                },
                {
                    "id": "<sentence_0x85d14670>",
                    "is_empty": false,
                    "have_tags": false,
                    "tags": {},
                    "text": "Methods used for request-response communications.<crlf>Signals used for publish/subscribe communications.",
                    "html": "<ol type=\"a\"><li>Methods \u2013 used for request-response communications.</li><li>Signals \u2013 used for publish/subscribe communications.</li></ol>"
                },
                {
                    "id": "<sentence_0x15e59643>",
                    "is_empty": false,
                    "have_tags": false,
                    "tags": {},
                    "text": "An example of D-Bus usage would be receiving a video chat by a popular video conferencing apponce a video is established, the video conferencing app could send a D-bus signal publishing that a call has started. Apps listening to that message could respond appropriatelyfor example, mute their audio.",
                    "html": "<p>An example of D-Bus usage would be receiving a video chat by a popular video conferencing app\u2013once a video is established, the video conferencing app could send a D-bus signal publishing that a call has started. Apps listening to that message could respond appropriately\u2013for example, mute their audio.</p>"
                },
                {
                    "id": "<sentence_0x522848e0>",
                    "is_empty": false,
                    "have_tags": true,
                    "tags": {
                        "<a_0xc9a86532>": "https://unit42.paloaltonetworks.com/usbcreator-d-bus-privilege-escalation-in-ubuntu-desktop/",
                        "<a_0xac4667dd>": "https://bugzilla.redhat.com/show_bug.cgi?id=1892437"
                    },
                    "text": "There are many D-Bus components shipped by default on popular Linux desktop environments. Since those components run at different privileges and respond to messages, D-Bus components are an attractive target for attackers. Indeed, there have been interesting vulnerabilities in the past related to buggy D-Bus services, including USBCreator Elevation of Privilege, Blueman Elevation of Privilege by command injection, and other similar scenarios.",
                    "html": "<p>There are many D-Bus components shipped by default on popular Linux desktop environments. Since those components run at different privileges and respond to messages, D-Bus components are an attractive target for attackers. Indeed, there have been interesting vulnerabilities in the past related to buggy D-Bus services, including <a href=\"https://unit42.paloaltonetworks.com/usbcreator-d-bus-privilege-escalation-in-ubuntu-desktop/\">USBCreator Elevation of Privilege</a>, <a href=\"https://bugzilla.redhat.com/show_bug.cgi?id=1892437\">Blueman Elevation of Privilege by command injection</a>, and other similar scenarios.</p>"
                },
                {
                    "id": "<sentence_0x869b30af>",
                    "is_empty": false,
                    "have_tags": false,
                    "tags": {},
                    "text": "D-Bus exposes a global System Bus and a per-session Session Bus. From an attackers perspective, the System Bus is more attractive since it will commonly have services that run as root listening to it.",
                    "html": "<p>D-Bus exposes a global System Bus and a per-session Session Bus. From an attacker\u2019s perspective, the System Bus is more attractive since it will commonly have services that run as root listening to it.</p>"
                }
            ]
        },
        {
            "id": "<chapter_0xa6e4fbd4>",
            "title": "D-Bus name ownership",
            "title_level": 3,
            "sentences": [
                {
                    "id": "<sentence_0x757d3a56>",
                    "is_empty": false,
                    "have_tags": true,
                    "tags": {
                        "<a_0x547adee6>": "https://dbus.freedesktop.org/doc/dbus-daemon.1.html"
                    },
                    "text": "When connecting to the D-Bus, components are assigned with a unique identifier, which mitigates against attacks abusing PID-recycling. The unique identifier starts with a colon and has numbers in it separated by dots, such as :1.337. Components can use the D-Bus API to own identifiable names such as org.freedesktop.Avahi or com.ubuntu.SystemService. For D-Bus to allow such ownership, the requesting process context must be allowed under the D-Bus configuration files. Those configuration files are well documented and maintained under /usr/local/share/dbus-1/system.conf and /usr/local/share/dbus-1/session.conf (on some systems under /usr/local/dbus-1 directly). Specifically, the default system.conf does not allow ownership unless specified otherwise in other included configuration files (commonly under /etc/dbus-1/system.d).",
                    "html": "<p>When connecting to the D-Bus, components are assigned with a unique identifier, which mitigates against attacks abusing PID-recycling. The unique identifier starts with a colon and has numbers in it separated by dots, such as \u201c:1.337\u201d. Components can use the D-Bus API to own identifiable names such as \u201corg.freedesktop.Avahi\u201d or \u201ccom.ubuntu.SystemService\u201d. For D-Bus to allow such ownership, the requesting process context must be allowed under the D-Bus configuration files. Those configuration files are <a href=\"https://dbus.freedesktop.org/doc/dbus-daemon.1.html\">well documented</a> and maintained under /usr/local/share/dbus-1/system.conf and /usr/local/share/dbus-1/session.conf (on some systems under /usr/local/dbus-1 directly). Specifically, the default system.conf does not allow ownership unless specified otherwise in other included configuration files (commonly under /etc/dbus-1/system.d).</p>"
                },
                {
                    "id": "<sentence_0xf18a210f>",
                    "is_empty": false,
                    "have_tags": true,
                    "tags": {
                        "<img_0x74f0eeac>": "https://www.microsoft.com/security/blog/uploads/securityprod/2022/04/Figure-1-Different-ownership-policies-for-the-System-Bus-and-the-Session-Bus.png"
                    },
                    "text": "Figure 1: Different ownership policies for the System Bus and the Session Bus",
                    "html": "<figure class=\"wp-block-image size-full\"><img alt=\"Figure 1 displays different ownership policies for the System Bus and the Session Bus; \" class=\"wp-image-112704\" height=\"148\" src=\"https://www.microsoft.com/security/blog/uploads/securityprod/2022/04/Figure-1-Different-ownership-policies-for-the-System-Bus-and-the-Session-Bus.png\" width=\"800\"/><figcaption>Figure 1: Different ownership policies for the System Bus and the Session Bus</figcaption></figure>"
                },
                {
                    "id": "<sentence_0x534f9a67>",
                    "is_empty": false,
                    "have_tags": false,
                    "tags": {},
                    "text": "Additionally, if the name requested already existsthe request will not be granted until the owning process releases the name.",
                    "html": "<p>Additionally, if the name requested already exists\u2013the request will not be granted until the owning process releases the name.</p>"
                }
            ]
        },
        {
            "id": "<chapter_0x5259dfde>",
            "title": "Vulnerability hunting",
            "title_level": 2,
            "sentences": [
                {
                    "id": "<sentence_0x922e68c6>",
                    "is_empty": false,
                    "have_tags": false,
                    "tags": {},
                    "text": "Our team has started enumerating services that run as root and listen to messages on the System Bus, performing both code reviews and dynamic analysis. We have reported two information leak issues as a result:",
                    "html": "<p>Our team has started enumerating services that run as root and listen to messages on the System Bus, performing both code reviews and dynamic analysis. We have reported two information leak issues as a result:</p>"
                },
                {
                    "id": "<sentence_0x8b1a992d>",
                    "is_empty": false,
                    "have_tags": true,
                    "tags": {
                        "<a_0x2980a4ec>": "https://github.com/blueman-project/blueman/security/advisories/GHSA-3r9p-m5c8-8mw8",
                        "<a_0x336aa78f>": "https://access.redhat.com/security/cve/cve-2022-0987"
                    },
                    "text": "Directory Info Disclosure in Blueman<crlf>Directory Info Disclosure in PackageKit (CVE-2022-0987)",
                    "html": "<ol type=\"1\"><li><a href=\"https://github.com/blueman-project/blueman/security/advisories/GHSA-3r9p-m5c8-8mw8\">Directory Info Disclosure in Blueman</a></li><li><a href=\"https://access.redhat.com/security/cve/cve-2022-0987\">Directory Info Disclosure in PackageKit (CVE-2022-0987)</a></li></ol>"
                },
                {
                    "id": "<sentence_0x4f030f9f>",
                    "is_empty": false,
                    "have_tags": true,
                    "tags": {
                        "<a_0x3fc676e1>": "https://en.wikipedia.org/wiki/Systemd"
                    },
                    "text": "While these are interesting, their severity is low an attacker can list files under directories that require high permissions to list files under. Then we started noticing interesting patterns in a systemd unit called networkd-dispatcher. The goal of networkd-dispatcher is to dispatch network status changes and optionally perform different scripts based on the new status. Interestingly, it runs on boot as root:",
                    "html": "<p>While these are interesting, their severity is low \u2013 an attacker can list files under directories that require high permissions to list files under. Then we started noticing interesting patterns in a <a href=\"https://en.wikipedia.org/wiki/Systemd\">systemd unit</a> called networkd-dispatcher. The goal of networkd-dispatcher is to dispatch network status changes and optionally perform different scripts based on the new status. Interestingly, it runs on boot as root:</p>"
                },
                {
                    "id": "<sentence_0xd5d6e97a>",
                    "is_empty": false,
                    "have_tags": true,
                    "tags": {
                        "<img_0x741198cb>": "https://www.microsoft.com/security/blog/uploads/securityprod/2022/04/Figure-2-networkd-dispatcher-running-as-root.png"
                    },
                    "text": "Figure 2: networkd-dispatcher running as root",
                    "html": "<figure class=\"wp-block-image size-full\"><img alt=\"Figure 2 displays networkd-dispatcher running as root.\" class=\"wp-image-112707\" height=\"44\" src=\"https://www.microsoft.com/security/blog/uploads/securityprod/2022/04/Figure-2-networkd-dispatcher-running-as-root.png\" width=\"800\"/><figcaption>Figure 2: networkd-dispatcher running as root</figcaption></figure>"
                }
            ]
        },
        {
            "id": "<chapter_0xc5f58ce>",
            "title": "Code flow for networkd-dispatcher",
            "title_level": 3,
            "sentences": [
                {
                    "id": "<sentence_0x4105f26d>",
                    "is_empty": false,
                    "have_tags": true,
                    "tags": {
                        "<a_0xcaceafb9>": "https://gitlab.com/craftyguy/networkd-dispatcher"
                    },
                    "text": "Upon examination of the networkd-dispatcher source code, we noticed an interesting flow:",
                    "html": "<p>Upon examination of the networkd-dispatcher <a href=\"https://gitlab.com/craftyguy/networkd-dispatcher\">source code</a>, we noticed an interesting flow:</p>"
                },
                {
                    "id": "<sentence_0x98fc704d>",
                    "is_empty": false,
                    "have_tags": true,
                    "tags": {
                        "<a_0xfd85efcb>": "https://docs.python.org/3/library/subprocess.html#subprocess.Popen"
                    },
                    "text": "The register function registers a new signal receiver for the service org.freedesktop.network1 on the System Bus, for the signal name PropertiesChanged.<crlf>The _receive_signal signal handler will perform some basic checks on the object type being sent, concludes the changed network interface based on the object path being sent, and then concludes its new statesOperationalState and AdministrativeStateeach fetched from the data. For any of those statesif they arent emptythe handle_state method will get invoked.<crlf>The handle_state method simply invokes _handle_one_state for each of those two states.<crlf>_handle_one_state validates the state isnt empty and checks if its different than the previous state. If it is, it will update the new state and invoke the _run_hooks_for_state method, which is responsible of discovering and running the scripts for the new state.<crlf>_run_hooks_for_state implements the following logic:Discovers the script list by invoking the get_script_list method (which gets the new state as a string). This method simply calls scripts_in_path which is intended to return all the files under /etc/networkd-dispatcher/<state>.d that are owned by the root user and the root group, and are executable. Sorts the script list. Runs each script with subprocess.Popen while supplying custom environment variables.",
                    "html": "<ol type=\"1\"><li>The register function registers a new signal receiver for the service \u201corg.freedesktop.network1\u201d on the System Bus, for the signal name \u201dPropertiesChanged\u201d.</li><li>The \u201d_receive_signal\u201c signal handler will perform some basic checks on the object type being sent, concludes the changed network interface based on the object path being sent, and then concludes its new states\u2013\u201cOperationalState\u201d and \u201cAdministrativeState\u201d\u2013each fetched from the data. For any of those states\u2013if they aren\u2019t empty\u2013the \u201chandle_state\u201d method will get invoked.</li><li>The \u201chandle_state\u201d method simply invokes \u201c_handle_one_state\u201c for each of those two states.</li><li>\u201c_handle_one_state\u201d validates the state isn\u2019t empty and checks if it\u2019s different than the previous state. If it is, it will update the new state and invoke the \u201c_run_hooks_for_state\u201d method, which is responsible of discovering and running the scripts for the new state.</li><li>\u201c_run_hooks_for_state\u201d implements the following logic:<ul><li>Discovers the script list by invoking the \u201cget_script_list\u201d method (which gets the new state as a string). This method simply calls \u201cscripts_in_path\u201d which is intended to return all the files under \u201c/etc/networkd-dispatcher/&lt;state&gt;.d\u201d that are owned by the root user and the root group, and are executable.</li><li>Sorts the script list.</li><li>Runs each script with <a href=\"https://docs.python.org/3/library/subprocess.html#subprocess.Popen\">subprocess.Popen</a> while supplying custom environment variables.</li></ul></li></ol>"
                },
                {
                    "id": "<sentence_0x7ceecbeb>",
                    "is_empty": false,
                    "have_tags": true,
                    "tags": {
                        "<img_0x255f2c56>": "https://www.microsoft.com/security/blog/uploads/securityprod/2022/04/Figure-3-_run_hooks_for_state-source-code-some-parts-omitted-for-brevity.png"
                    },
                    "text": "Figure 3: _run_hooks_for_state source code some parts omitted for brevity",
                    "html": "<figure class=\"wp-block-image size-full\"><img alt=\"Figure 3 displays a snippet of the _run_hooks_for_state source code.\" class=\"wp-image-112710\" height=\"427\" src=\"https://www.microsoft.com/security/blog/uploads/securityprod/2022/04/Figure-3-_run_hooks_for_state-source-code-some-parts-omitted-for-brevity.png\" width=\"800\"/><figcaption>Figure 3: _run_hooks_for_state source code \u2013 some parts omitted for brevity</figcaption></figure>"
                },
                {
                    "id": "<sentence_0xa71824c3>",
                    "is_empty": false,
                    "have_tags": false,
                    "tags": {},
                    "text": "Step 5 has multiple security issues:",
                    "html": "<p>Step 5 has multiple security issues:</p>"
                },
                {
                    "id": "<sentence_0xe12a8bae>",
                    "is_empty": false,
                    "have_tags": true,
                    "tags": {
                        "<a_0xb6442226>": "https://en.wikipedia.org/wiki/Directory_traversal_attack",
                        "<a_0x4e177bc9>": "https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2022-29799",
                        "<a_0x572c0c49>": "https://en.wikipedia.org/wiki/Symlink_race",
                        "<a_0x7b78e642>": "https://en.wikipedia.org/wiki/Time-of-check_to_time-of-use",
                        "<a_0xc981150a>": "https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2022-29800"
                    },
                    "text": "Directory traversal (CVE-2022-29799): none of the functions in the flow sanitize the OperationalState or the AdministrativeState. Since the states are used to build the script path, it is possible that a state would contain directory traversal patterns (e.g. ../../) to escape from the /etc/networkd-dispatcher base directory.<crlf>Symlink race: both the script discovery and subprocess.Popen follow symbolic links.<crlf>Time-of-check-time-of-use (TOCTOU) race condition (CVE-2022-29800): there is a certain time between the scripts being discovered and them being run. An attacker can abuse this vulnerability to replace scripts that networkd-dispatcher believes to be owned by root to ones that are not.",
                    "html": "<ol type=\"1\"><li><a href=\"https://en.wikipedia.org/wiki/Directory_traversal_attack\">Directory traversal </a>(<a href=\"https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2022-29799\">CVE-2022-29799</a>): none of the functions in the flow sanitize the OperationalState or the AdministrativeState. Since the states are used to build the script path, it is possible that a state would contain directory traversal patterns (e.g. \u201c../../\u201d) to escape from the \u201c/etc/networkd-dispatcher\u201d base directory.</li><li><a href=\"https://en.wikipedia.org/wiki/Symlink_race\">Symlink race</a>: both the script discovery and subprocess.Popen follow symbolic links.</li><li>Time-of-check-time-of-use (<a href=\"https://en.wikipedia.org/wiki/Time-of-check_to_time-of-use\">TOCTOU</a>) race condition (<a href=\"https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2022-29800\">CVE-2022-29800</a>): there is a certain time between the scripts being discovered and them being run. An attacker can abuse this vulnerability to replace scripts that networkd-dispatcher believes to be owned by root to ones that are not.</li></ol>"
                },
                {
                    "id": "<sentence_0x8daa4843>",
                    "is_empty": false,
                    "have_tags": true,
                    "tags": {
                        "<img_0x8f76bc71>": "https://www.microsoft.com/security/blog/uploads/securityprod/2022/04/6267e7bcdaac2-6267e7bcdaac3Figure-4-Building-the-script-list-in-the-scripts_in_path-method-including-the-vulnerable-code-with-subdir-poisoned..png.png"
                    },
                    "text": "Figure 4: Building the script list in the scripts_in_path method, including the vulnerable code with subdir poisoned.",
                    "html": "<figure class=\"wp-block-image size-full\"><img alt='Figure 4 displays building the script list in the \"scripts_in_path\" method, including the vulnerable code with \"subdir\" poisoned, which is highlighted with a red box over the text reading \"os.path.join(one path, subdir, filename)\".' class=\"wp-image-112713\" height=\"386\" src=\"https://www.microsoft.com/security/blog/uploads/securityprod/2022/04/6267e7bcdaac2-6267e7bcdaac3Figure-4-Building-the-script-list-in-the-scripts_in_path-method-including-the-vulnerable-code-with-subdir-poisoned..png.png\" width=\"800\"/><figcaption>Figure 4: Building the script list in the \u201cscripts_in_path\u201d method, including the vulnerable code with \u201csubdir\u201d poisoned.</figcaption></figure>"
                }
            ]
        },
        {
            "id": "<chapter_0x52f9c76f>",
            "title": "Exploitation",
            "title_level": 2,
            "sentences": [
                {
                    "id": "<sentence_0xabcd5ec6>",
                    "is_empty": false,
                    "have_tags": false,
                    "tags": {},
                    "text": "Let us assume an adversary has a malicious D-Bus component that can send an arbitrary signal. An attacker can therefore do the following:",
                    "html": "<p>Let us assume an adversary has a malicious D-Bus component that can send an arbitrary signal. An attacker can therefore do the following:</p>"
                },
                {
                    "id": "<sentence_0x27afbb3e>",
                    "is_empty": false,
                    "have_tags": false,
                    "tags": {},
                    "text": "Prepare a directory /tmp/nimbuspwn and plant a symlink /tmp/nimbuspwn/poc.d to point to /sbin. The /sbin directory was chosen specifically because it has many executables owned by root that do not block if run without additional arguments. This will abuse the symlink race issue we mentioned earlier.<crlf>For every executable filename under /sbin owned by root, plant the same filename under /tmp/nimbuspwn. For example, if /sbin/vgs is executable and owned by root, plant an executable file /tmp/nimbuspwn/vgs with the desired payload. This will help the attacker win the race condition imposed by the TOCTOU vulnerability.<crlf>Send a signal with the OperationalState ../../../tmp/nimbuspwn/poc. This abuses the directory traversal vulnerability and escapes the script directory.<crlf>The networkd-dispatcher signal handler kicks in and builds the script list from the directory /etc/networkd-dispatcher/../../../tmp/nimbuspwn/poc.d, which is really the symlink (/tmp/nimbuspwn/poc.d), which points to /sbin. Therefore, it creates a list composed of many executables owned by root.<crlf>Quickly change the symlink /tmp/nimbuspwn/poc.d to point to /tmp/nimbuspwn. This abuses the TOCTOU race condition vulnerabilitythe script path changes without networkd-dispatcher being aware.<crlf>The dispatcher starts running files that were initially under /sbin but in truth under the /tmp/nimbuspwn directory. Since the dispatcher believes those files are owned by root, it executes them blindly with subprocess.Popen as root. Therefore, our attacker has successfully exploited the vulnerability.",
                    "html": "<ol type=\"1\"><li>Prepare a directory \u201d/tmp/nimbuspwn\u201d and plant a symlink \u201d/tmp/nimbuspwn/poc.d\u201c to point to \u201c/sbin\u201d. The \u201c/sbin\u201d directory was chosen specifically because it has many executables owned by root that do not block if run without additional arguments. This will abuse the symlink race issue we mentioned earlier.</li><li>For every executable filename under \u201c/sbin\u201d owned by root, plant the same filename under \u201c/tmp/nimbuspwn\u201d. For example, if \u201c/sbin/vgs\u201d is executable and owned by root, plant an executable file \u201c/tmp/nimbuspwn/vgs\u201d with the desired payload. This will help the attacker win the race condition imposed by the TOCTOU vulnerability.</li><li>Send a signal with the OperationalState \u201c../../../tmp/nimbuspwn/poc\u201d. This abuses the directory traversal vulnerability and escapes the script directory.</li><li>The networkd-dispatcher signal handler kicks in and builds the script list from the directory \u201c/etc/networkd-dispatcher/../../../tmp/nimbuspwn/poc.d\u201d, which is really the symlink (\u201c/tmp/nimbuspwn/poc.d\u201d), which points to \u201c/sbin\u201d. Therefore, it creates a list composed of many executables owned by root.</li><li>Quickly change the symlink \u201c/tmp/nimbuspwn/poc.d\u201d to point to \u201c/tmp/nimbuspwn\u201d. This abuses the TOCTOU race condition vulnerability\u2013the script path changes without networkd-dispatcher being aware.</li><li>The dispatcher starts running files that were initially under \u201c/sbin\u201d but in truth under the \u201c/tmp/nimbuspwn\u201d directory. Since the dispatcher \u201cbelieves\u201d those files are owned by root, it executes them blindly with subprocess.Popen as root. Therefore, our attacker has successfully exploited the vulnerability.</li></ol>"
                },
                {
                    "id": "<sentence_0x4f20fcdf>",
                    "is_empty": false,
                    "have_tags": false,
                    "tags": {},
                    "text": "Note that to win the TOCTOU race condition with high probability, we plant many files that can potentially run. Our experiments show three attempts were enough to win the TOCTOU race condition.",
                    "html": "<p>Note that to win the TOCTOU race condition with high probability, we plant many files that can potentially run. Our experiments show three attempts were enough to win the TOCTOU race condition.</p>"
                },
                {
                    "id": "<sentence_0x6ea52ca>",
                    "is_empty": false,
                    "have_tags": true,
                    "tags": {
                        "<img_0x47b6a6ce>": "https://www.microsoft.com/security/blog/uploads/securityprod/2022/04/Figure-5-Flow-chart-of-the-attack-in-three-stages.png"
                    },
                    "text": "Figure 5: Flow-chart of the attack in three stages",
                    "html": "<figure class=\"wp-block-image size-full\"><img alt=\"Figure 5 displays a flow-chart of the attack in 3 stages. The first 3 steps are depicted in the top image, displaying the attacker's initial steps. The 4th step is depicted in the middle image, displaying how networkd-dispatcher processes the attacker's modifications. Steps 5 and 6 are depicted in the final image, displaying how the attacker abuses the TOCTOU race condition flaw so that the dispatcher ultimately permits the Nimbuspwn exploit. \" class=\"wp-image-112716\" height=\"996\" src=\"https://www.microsoft.com/security/blog/uploads/securityprod/2022/04/Figure-5-Flow-chart-of-the-attack-in-three-stages.png\" width=\"800\"/><figcaption>Figure 5: Flow-chart of the attack in three stages</figcaption></figure>"
                },
                {
                    "id": "<sentence_0xadbea0b>",
                    "is_empty": false,
                    "have_tags": false,
                    "tags": {},
                    "text": "Since we do not wish to run the exploit every time we want to run as root, the payload that we ended up implementing leaves a root backdoor as such:",
                    "html": "<p>Since we do not wish to run the exploit every time we want to run as root, the payload that we ended up implementing leaves a root backdoor as such:</p>"
                },
                {
                    "id": "<sentence_0x5964994e>",
                    "is_empty": false,
                    "have_tags": true,
                    "tags": {
                        "<a_0xcc665492>": "https://attack.mitre.org/techniques/T1548/001/"
                    },
                    "text": "Copies /bin/sh to /tmp/sh.<crlf>Turns the new /tmp/sh it into a Set-UID (SUID) binary.<crlf>Run /tmp/sh -p. The -p flag is necessary since modern shells drop privileges by design.",
                    "html": "<ol type=\"1\"><li>Copies /bin/sh to /tmp/sh.</li><li>Turns the new /tmp/sh it into a <a href=\"https://attack.mitre.org/techniques/T1548/001/\">Set-UID (SUID) binary</a>.</li><li>Run /tmp/sh -p. The \u201c-p\u201d flag is necessary since modern shells drop privileges by design.</li></ol>"
                }
            ]
        },
        {
            "id": "<chapter_0x33812a67>",
            "title": "Owning the bus name",
            "title_level": 3,
            "sentences": [
                {
                    "id": "<sentence_0xc151e5e0>",
                    "is_empty": false,
                    "have_tags": false,
                    "tags": {},
                    "text": "The astute reader will notice that the entire exploit elevates privileges assuming our exploit code can own the org.freedesktop.network1 bus name. While this sounds non-trivial, we have found several environments where this happens. Specifically:",
                    "html": "<p>The astute reader will notice that the entire exploit elevates privileges assuming our exploit code can own the \u201corg.freedesktop.network1\u201d bus name. While this sounds non-trivial, we have found several environments where this happens. Specifically:</p>"
                },
                {
                    "id": "<sentence_0xb02b3686>",
                    "is_empty": false,
                    "have_tags": true,
                    "tags": {
                        "<a_0x78202a3b>": "https://docs.microsoft.com/microsoft-365/security/defender-endpoint/advanced-hunting-overview?view=o365-worldwide",
                        "<a_0x3c780427>": "https://www.gnupg.org/documentation/manuals/gnupg/gpgv.html",
                        "<a_0x43a55ea7>": "https://linux.die.net/man/8/apt-get",
                        "<a_0x1ba928ba>": "https://www.erlang.org/doc/man/epmd.html"
                    },
                    "text": "On many environments (e.g. Linux Mint) the service systemd-networkd that normally owns the org.freedesktop.network1 bus name does not start at boot by default.<crlf>Using advanced hunting in Microsoft Defender for Endpoint we were able to spot several processes running as the systemd-network user (which is permitted to own the bus name we require) running arbitrary code from world-writable locations. These include several gpgv plugins (launched when apt-get installs or upgrades) as well as the Erlang Port Mapper Daemon (epmd) which allows running arbitrary code under some scenarios.",
                    "html": "<ol type=\"1\"><li>On many environments (e.g. Linux Mint) the service systemd-networkd that normally owns the \u201corg.freedesktop.network1\u201d bus name does not start at boot by default.</li><li>Using <a href=\"https://docs.microsoft.com/microsoft-365/security/defender-endpoint/advanced-hunting-overview?view=o365-worldwide\">advanced hunting in Microsoft Defender for Endpoint</a> we were able to spot several processes running as the systemd-network user (which is permitted to own the bus name we require) running arbitrary code from world-writable locations. These include several <a href=\"https://www.gnupg.org/documentation/manuals/gnupg/gpgv.html\">gpgv</a> plugins (launched when <a href=\"https://linux.die.net/man/8/apt-get\">apt-get</a> installs or upgrades) as well as the Erlang Port Mapper Daemon (<a href=\"https://www.erlang.org/doc/man/epmd.html\">epmd</a>) which allows running arbitrary code under some scenarios.</li></ol>"
                },
                {
                    "id": "<sentence_0x313c78e5>",
                    "is_empty": false,
                    "have_tags": false,
                    "tags": {},
                    "text": "The query we used can also be run by Microsoft Defender for Endpoint customers:",
                    "html": "<p>The query we used can also be run by Microsoft Defender for Endpoint customers:</p>"
                },
                {
                    "id": "<sentence_0xe7c82b8>",
                    "is_empty": false,
                    "have_tags": false,
                    "tags": {},
                    "text": "DeviceProcessEvents<crlf>| where Timestamp > ago(5d)<crlf>and AccountName == \"systemd-network\"<crlf>and isnotempty(InitiatingProcessAccountName)<crlf>and isnotempty(FileName)<crlf>| project DeviceId, FileName, FolderPath, ProcessCommandLine",
                    "html": "\nDeviceProcessEvents\n| where Timestamp > ago(5d)\n and AccountName == \"systemd-network\"\n and isnotempty(InitiatingProcessAccountName)\n and isnotempty(FileName)\n| project DeviceId, FileName, FolderPath, ProcessCommandLine\n"
                },
                {
                    "id": "<sentence_0xd3977cbc>",
                    "is_empty": false,
                    "have_tags": false,
                    "tags": {},
                    "text": "We were therefore able to exploit these scenarios and implement our own exploit:",
                    "html": "<p>We were therefore able to exploit these scenarios and implement our own exploit:</p>"
                },
                {
                    "id": "<sentence_0x59c70e7b>",
                    "is_empty": false,
                    "have_tags": true,
                    "tags": {
                        "<img_0x2e51c408>": "https://www.microsoft.com/security/blog/uploads/securityprod/2022/04/Figure-6-Our-exploit-implemented-and-winning-the-TOCTOU-race.png"
                    },
                    "text": "Figure 6: Our exploit implemented and winning the TOCTOU race",
                    "html": "<figure class=\"wp-block-image size-full\"><img alt=\"Figure 6 displays our successfully implemented exploit after winning the TOCTOU race condition. The title reads &quot;Nimbuspwn: networkd-dispatcher Linux EoP by Jonathan Bar Or ('JBO')&quot;. The processes are then displayed, reading top to bottom: &quot;Attempting to own dbus name org.freedesktop.network1&quot;, &quot;Validating name patterns&quot;, &quot;Planting base directory&quot;, &quot;Planting symlink&quot;, &quot;Planting payload&quot;, it then takes four attempts to &quot;win the (TOCTOU) race&quot; condition before stating &quot;Great, we now have a root backdoor. Hurray! Enjoy your root privileges&quot;. \" class=\"wp-image-112719\" height=\"598\" src=\"https://www.microsoft.com/security/blog/uploads/securityprod/2022/04/Figure-6-Our-exploit-implemented-and-winning-the-TOCTOU-race.png\" width=\"800\"/><figcaption>Figure 6: Our exploit implemented and winning the TOCTOU race</figcaption></figure>"
                },
                {
                    "id": "<sentence_0x4357cf82>",
                    "is_empty": false,
                    "have_tags": true,
                    "tags": {
                        "<a_0xcc665492>": "https://attack.mitre.org/techniques/T1548/001/"
                    },
                    "text": "While capable of running any arbitrary script as root, our exploit copies /bin/sh to the /tmp directory, sets /tmp/sh as a Set-UID (SUID) executable, and then invokes /tmp/sh -p. Note that the -p flag is necessary to force the shell to not drop privileges.",
                    "html": "<p>While capable of running any arbitrary script as root, our exploit copies /bin/sh to the /tmp directory, sets /tmp/sh as a <a href=\"https://attack.mitre.org/techniques/T1548/001/\">Set-UID (SUID) executable</a>, and then invokes \u201c/tmp/sh -p\u201d. Note that the \u201c-p\u201d flag is necessary to force the shell to not drop privileges.</p>"
                }
            ]
        },
        {
            "id": "<chapter_0xabc91fff>",
            "title": "Hardening device security and detection strategy",
            "title_level": 2,
            "sentences": [
                {
                    "id": "<sentence_0x8a98928b>",
                    "is_empty": false,
                    "have_tags": false,
                    "tags": {},
                    "text": "Despite the evolving threat landscape regularly delivering new threats, techniques, and attack capabilities, adversaries continue to focus on identifying and taking advantage of unpatched vulnerabilities and misconfigurations as a vector to access systems, networks, and sensitive information for malicious purposes. This constant bombardment of attacks spanning a wide range of platforms, devices, and other domains emphasizes the need for a comprehensive and proactive vulnerability management approach that can further identify and mitigate even previously unknown exploits and issues.",
                    "html": "<p>Despite the evolving threat landscape regularly delivering new threats, techniques, and attack capabilities, adversaries continue to focus on identifying and taking advantage of unpatched vulnerabilities and misconfigurations as a vector to access systems, networks, and sensitive information for malicious purposes. This constant bombardment of attacks spanning a wide range of platforms, devices, and other domains emphasizes the need for a comprehensive and proactive vulnerability management approach that can further identify and mitigate even previously unknown exploits and issues.</p>"
                },
                {
                    "id": "<sentence_0xd72d1f50>",
                    "is_empty": false,
                    "have_tags": true,
                    "tags": {
                        "<a_0x799efb40>": "https://docs.microsoft.com/microsoft-365/security/defender-endpoint/next-gen-threat-and-vuln-mgt?view=o365-worldwide",
                        "<a_0x317d0352>": "https://www.microsoft.com/security/business/threat-protection/endpoint-defender?rtc=1"
                    },
                    "text": "Microsofts threat and vulnerability management capabilities help organizations monitor their overall security posture, providing real-time insights into risk with continuous vulnerability discovery, contextualized intelligent prioritization, and seamless one-click flaw remediation. Leveraging our research into the Nimbuspwn vulnerabilities to improve solutions, our threat and vulnerability management already covers CVE-2022-29799 and CVE-2022-29800 and indicates such vulnerable devices in the threat and vulnerability module in Microsoft Defender for Endpoint.",
                    "html": "<p>Microsoft\u2019s <a href=\"https://docs.microsoft.com/microsoft-365/security/defender-endpoint/next-gen-threat-and-vuln-mgt?view=o365-worldwide\">threat and vulnerability management</a> capabilities help organizations monitor their overall security posture, providing real-time insights into risk with continuous vulnerability discovery, contextualized intelligent prioritization, and seamless one-click flaw remediation. Leveraging our research into the Nimbuspwn vulnerabilities to improve solutions, our threat and vulnerability management already covers CVE-2022-29799 and CVE-2022-29800 and indicates such vulnerable devices in the threat and vulnerability module in <a href=\"https://www.microsoft.com/security/business/threat-protection/endpoint-defender?rtc=1\">Microsoft Defender for Endpoint</a>.</p>"
                },
                {
                    "id": "<sentence_0x3759c2c4>",
                    "is_empty": false,
                    "have_tags": true,
                    "tags": {
                        "<a_0x1e09c6e6>": "https://docs.microsoft.com/microsoft-365/security/defender-endpoint/overview-endpoint-detection-response?view=o365-worldwide"
                    },
                    "text": "To address the specific vulnerabilities at play, Microsoft Defender for Endpoints endpoint detection and response (EDR) capabilities detect the directory traversal attack required to leverage Nimbuspwn. Additionally, the Microsoft Defender for Endpoint detection team has a generic detection for suspicious Set-UID process invocations, which detected our exploit without prior knowledge.",
                    "html": "<p>To address the specific vulnerabilities at play, Microsoft Defender for Endpoint\u2019s <a href=\"https://docs.microsoft.com/microsoft-365/security/defender-endpoint/overview-endpoint-detection-response?view=o365-worldwide\">endpoint detection and response (EDR)</a> capabilities detect the directory traversal attack required to leverage Nimbuspwn. Additionally, the Microsoft Defender for Endpoint detection team has a generic detection for suspicious Set-UID process invocations, which detected our exploit without prior knowledge.</p>"
                },
                {
                    "id": "<sentence_0xc9fb73b>",
                    "is_empty": false,
                    "have_tags": true,
                    "tags": {
                        "<img_0xf37559a3>": "https://www.microsoft.com/security/blog/uploads/securityprod/2022/04/Figure-7-Microsoft-Defender-for-Endpoint-detecting-a-suspicious-SUID-process-used-in-our-exploit.png"
                    },
                    "text": "Figure 7: Microsoft Defender for Endpoint detecting a suspicious SUID process used in our exploit",
                    "html": "<figure class=\"wp-block-image size-full\"><img alt=\"Figure 7 displays Microsoft Defender for Endpoint detecting a suspicious SUID process used in our exploit - including the alert story and details of the detected activity. \" class=\"wp-image-112722\" height=\"426\" src=\"https://www.microsoft.com/security/blog/uploads/securityprod/2022/04/Figure-7-Microsoft-Defender-for-Endpoint-detecting-a-suspicious-SUID-process-used-in-our-exploit.png\" width=\"800\"/><figcaption>Figure 7: Microsoft Defender for Endpoint detecting a suspicious SUID process used in our exploit</figcaption></figure>"
                },
                {
                    "id": "<sentence_0xd9ffc723>",
                    "is_empty": false,
                    "have_tags": false,
                    "tags": {},
                    "text": "Defending against the evolving threat landscape requires the ability to protect and secure users computing experiences, be it a Windows or non-Windows device. Microsoft continuously enriches our protection technologies through robust research that protects users and organizations across all the major platforms every single day. This case displayed how the ability to coordinate such research via expert, cross-industry collaboration is vital to effectively mitigate issues, regardless of the vulnerable device or platform in use. By sharing our research and other forms of threat intelligence, we can continue to collaborate with the larger security community and strive to build better protection for all.",
                    "html": "<p>Defending against the evolving threat landscape requires the ability to protect and secure users\u2019 computing experiences, be it a Windows or non-Windows device. Microsoft continuously enriches our protection technologies through robust research that protects users and organizations across all the major platforms every single day. This case displayed how the ability to coordinate such research via expert, cross-industry collaboration is vital to effectively mitigate issues, regardless of the vulnerable device or platform in use. By sharing our research and other forms of threat intelligence, we can continue to collaborate with the larger security community and strive to build better protection for all.</p>"
                },
                {
                    "id": "<sentence_0x222477a1>",
                    "is_empty": false,
                    "have_tags": false,
                    "tags": {},
                    "text": "Jonathan Bar Or",
                    "html": "<p>Jonathan Bar Or</p>"
                },
                {
                    "id": "<sentence_0x2c7261a7>",
                    "is_empty": false,
                    "have_tags": false,
                    "tags": {},
                    "text": "Microsoft 365 Defender Research Team",
                    "html": "<p>Microsoft 365 Defender Research Team</p>"
                }
            ]
        }
    ]
}