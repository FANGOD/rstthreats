<div>
<img alt="BAZARLOADER: Analysing The Main Loader" src="https://www.0ffset.net/wp-content/uploads/2022/05/main_bazar43.png" style="max-width:80%;height:auto;width:auto;"/>
<ul class="entry-meta">
<li>
<a href="https://www.0ffset.net/author/chuong-dong/">
												Chuong Dong											</a>
</li>
<li>
											27th May 2022										</li>
<li>
 
											No Comments										</li>
</ul>
<p>This post is a follow up on the last one on BAZARLOADER. If you’re interested in how to unpack the initial stages of this malware, you can check it out <a href="https://www.0ffset.net/reverse-engineering/bazarloader-iso-file-infection/" rel="noreferrer noopener" target="_blank">here</a>. </p>
<p>In this post, we’ll cover the final stage of this loader, which has the capability to download and executes remote payloads such as Cobalt Strike and Conti ransomware. To follow along, you can grab the sample as well as the PCAP files for it on <a href="https://www.malware-traffic-analysis.net/2022/02/07/index.html" rel="noreferrer noopener" target="_blank">Malware-Traffic-Analysis.net</a>.</p>
<h1>Step 1: Checking System Languages</h1>
<p>Similar to a lot of malware, BAZARLOADER manually checks the system’s languages to avoid executing on machines in Russia and nearby countries.</p>
<p>It calls GetSystemDefaultLangID to retrieve the system’s default language and GetKeyboardLayoutList to iterate through the system’s keyboard layouts.</p>
<figure class="aligncenter size-large"><img alt="" class="wp-image-5833" height="566" src="https://www.0ffset.net/wp-content/uploads/2022/05/main_bazar01-1024x566.png" style="max-width:800px;height:auto;width:auto;" width="1024"/></figure>
<p>For each of these languages, the malware checks if it’s valid using a bitmask. </p>
<p>If the language identifier is greater than 0x43 or less than 0x18, it’s treated as valid and BAZARLOADER proceeds with its execution. </p>
<p>If it’s in the range between 0x18 and 0x43, the difference between the language identifier and 0x18 is used as the index of the bit to be checked in the bitmask.</p>
<p>The bitmask that BAZARLOADER uses is 0xD8080190C03, which is 11011000000010000000000110010000110000000011 in binary. The first bit in the bitmask is checked if the language ID is 0x18. The second bit is checked if the language ID is 0x19, and so on…</p>
<figure class="aligncenter size-full"><img alt="" class="wp-image-5835" height="227" src="https://www.0ffset.net/wp-content/uploads/2022/05/main_bazar02.png" style="max-width:800px;height:auto;width:auto;" width="707"/></figure>
<p>Below is the list of all languages from the bitmask that the malware avoids.</p>
<code>Romanian, Russian, Ukrainian, Belarusian, Tajik, Armenian, Azerbaijani, Georgian, Kazakh, Kyrgyz, Turkmen, Uzbek</code>
<h1>Step 2: Run-Once Mutex</h1>
<p>To check for multiple running instances of itself, BAZARLOADER first extracts the subauthority of a SID from its process. It does this by calling GetTokenInformation to retrieve the process’s token integrity level and calling GetSidSubAuthorityCount and GetSidSubAuthority to access the subauthority of a SID.</p>
<figure class="aligncenter size-large"><img alt="" class="wp-image-5839" height="313" src="https://www.0ffset.net/wp-content/uploads/2022/05/main_bazar03-1024x313.png" style="max-width:800px;height:auto;width:auto;" width="1024"/></figure>
<p>If the SID’s subauthority is SECURITY_MANDATORY_SYSTEM_RID or SECURITY_MANDATORY_PROTECTED_PROCESS_RID, BAZARLOADER checks if the mutex “{b837ef4f-10ee-4821-ac76-2331eb32a23f}” is currently owned by any other process by calling CreateMutexA. </p>
<p>If it is, the malware terminates itself. However, there is a small bug with the condition to check if the mutex object exists, which assumes it fails to open the mutex when it actually succeeds.</p>
<figure class="aligncenter size-full"><img alt="" class="wp-image-5841" height="561" src="https://www.0ffset.net/wp-content/uploads/2022/05/main_bazar04.png" style="max-width:800px;height:auto;width:auto;" width="1000"/></figure>
<p>After this, the malware resolves the string “{0caa6ebb-cf78-4b01-9b0b-51032c9120ce}” and tries to create a mutex with that name.</p>
<figure class="aligncenter size-full"><img alt="" class="wp-image-5842" height="377" src="https://www.0ffset.net/wp-content/uploads/2022/05/main_bazar05.png" style="max-width:800px;height:auto;width:auto;" width="961"/></figure>
<figure class="aligncenter size-large"><img alt="" class="wp-image-5844" height="85" src="https://www.0ffset.net/wp-content/uploads/2022/05/main_bazar06-1024x85.png" style="max-width:800px;height:auto;width:auto;" width="1024"/></figure>
<p>If this mutex object already exists, the malware also terminates itself.</p>
<p>If the SID’s subauthority is not SECURITY_MANDATORY_SYSTEM_RID or SECURITY_MANDATORY_PROTECTED_PROCESS_RID, BAZARLOADER still uses these two mutex names but adds the string “Global\” in front of them. This checks for the mutexes in the global namespace instead of the per-session namespace, which allows the malware to check if it has instances running in other users’ sessions.</p>
<h1>Step 4: Generating Random Internet Traffic</h1>
<p>To generate Internet activities to hide its communication with C2 servers, BAZARLOADER first calls InternetOpenA to initialize the use of WinINet functions with the following string as the HTTP user agent.</p>
<code>Mozilla/5.0 (Windows NT 10.0; WOW64; Trident/7.0; rv:11.0) like Gecko</code>
<figure class="aligncenter size-large"><img alt="" class="wp-image-5848" height="418" src="https://www.0ffset.net/wp-content/uploads/2022/05/main_bazar07-1024x418.png" style="max-width:800px;height:auto;width:auto;" width="1024"/></figure>
<p>The malware then spawns a thread to periodically connect to random URLs and generate noises to hide the main C2 traffic by utilizing the following structure.</p>
<code>struct random_internet_thread_struct
{
 HINTERNET internet_sess_handle;
 HANDLE thread_handle;
 random_internet_thread_struct *self;
 LPCRITICAL_SECTION critical_section;
 __int64 padding[4];
 int creation_flag;
};
</code>
<p>First, BAZARLOADER calls InitializeCriticalSection to initialize the structure’s critical section object, which is later used to protect accesses to the creation_flag field.</p>
<figure class="aligncenter size-large"><img alt="" class="wp-image-5850" height="304" src="https://www.0ffset.net/wp-content/uploads/2022/05/main_bazar07a-1024x304.png" style="max-width:800px;height:auto;width:auto;" width="1024"/></figure>
<p>Next, it sets the self field to point to the structure, the creation_flag field to TRUE, and calls CreateThread to spawn a thread to perform these random Internet operations. If it fails to create a thread, the creation_flag field is set to FALSE.</p>
<figure class="aligncenter size-full"><img alt="" class="wp-image-5851" height="507" src="https://www.0ffset.net/wp-content/uploads/2022/05/main_bazar08.png" style="max-width:800px;height:auto;width:auto;" width="1023"/></figure>
<p>The thread first tries to obtain ownership of the critical section object and check if the creation flag is enabled. If it is, the malware resolves the following URLs as stack strings.</p>
<code>https://google.com/api/get
https://yahoo.com/api/get
https://amazon.com/api/get
https://bing.com/api/get</code>
<figure class="aligncenter size-large"><img alt="" class="wp-image-5852" height="494" src="https://www.0ffset.net/wp-content/uploads/2022/05/main_bazar09-1024x494.png" style="max-width:800px;height:auto;width:auto;" width="1024"/></figure>
<p>Next, the thread enters an infinite loop to start generating the traffic noises. For random number generation, BAZARLOADER uses different functions that call the Windows API BCryptGenRandom to generate a set number of random bytes. </p>
<p>It randomly chooses one of the 4 URLs listed above, randomly generates the URL path segments for that, and combines the two to build the full URL.</p>
<figure class="aligncenter size-full"><img alt="" class="wp-image-5855" height="528" src="https://www.0ffset.net/wp-content/uploads/2022/05/main_bazar10.png" style="max-width:800px;height:auto;width:auto;" width="1025"/></figure>
<p>To generate the path segments, the function takes in the minimum and maximum numbers of path segments to generate and the minimum and maximum length for each path segment.</p>
<p>It generates a count for the path segments randomly in the given range. For each of the segments, the malware randomly generates a string with a random length in the given range that contains numbers and uppercase/lowercase letters.</p>
<figure class="aligncenter size-large"><img alt="" class="wp-image-5856" height="516" src="https://www.0ffset.net/wp-content/uploads/2022/05/main_bazar11-1024x516.png" style="max-width:800px;height:auto;width:auto;" width="1024"/></figure>
<p>Finally, the malware calls InternetOpenURLA to establish a connection with the generated URL. It calls HTTPQueryInfoA with the HTTP_QUERY_CONTENT_LENGTH flag to retrieve the content’s length, allocates a buffer with that size, and calls InternetReadFile to read data from that URL.</p>
<figure class="aligncenter size-large"><img alt="" class="wp-image-5857" height="551" src="https://www.0ffset.net/wp-content/uploads/2022/05/main_bazar12-1024x551.png" style="max-width:800px;height:auto;width:auto;" width="1024"/></figure>
<p>This is done repeatedly until C2 communication and payload injection are finished, which generates a lot of noise to mask the main traffic coming to and from C2 servers.</p>
<h1>Step 4: Cryptographic Structure Population</h1>
<p>BAZARLOADER mainly uses the following structure for communication with C2 servers. The fields of the structure will be explained as we go along analyzing the code.</p>
<code>struct __declspec(align(8)) BazarLoader_struct
{
 C2_connection_struct C2_connection_struct;
 HINTERNET C2_request_handle;
 HINTERNET C2_temp_request_handle;
 crypto_struct crypto_struct;
 SYSTEMTIME curr_system_time;
 char *datetime_string;
 _QWORD datetime_string_hash;
 unsigned int *datetime_string_hash_len;
 opennic_server_struct opennic_DNS_server_struct;
 string_struct_list C2_addr_list;
};</code>
<p>First, it populates the crypto_struct field in the main structure. This structure contains cryptographic handles that are later used to decrypt executables being sent from C2 servers.</p>
<p>The structure can be reconstructed as below.</p>
<code>struct crypto_struct
{
 BCRYPT_ALG_HANDLE RSA_algo_handle;
 BCRYPT_ALG_HANDLE SHA384_algo_handle;
 BCRYPT_KEY_HANDLE RSA_public_key_handle;
 BCRYPT_KEY_HANDLE RSA_private_key_handle;
 DWORD RSA_public_block_length;
 DWORD RSA_private_block_length;
};</code>
<p>The malware resolves the strings “RSA” and “SHA384” and calls BCryptOpenAlgorithmProvider to retrieve handles for these two algorithms. The handles are stored in the corresponding fields in the crypto_struct structure.</p>
<figure class="aligncenter size-full"><img alt="" class="wp-image-5861" height="611" src="https://www.0ffset.net/wp-content/uploads/2022/05/main_bazar13.png" style="max-width:800px;height:auto;width:auto;" width="944"/></figure>
<p>Next, it resolves its hard-coded RSA public and private key blobs in memory to import their corresponding key handles.</p>
<figure class="aligncenter size-full"><img alt="" class="wp-image-5862" height="485" src="https://www.0ffset.net/wp-content/uploads/2022/05/main_bazar14.png" style="max-width:800px;height:auto;width:auto;" width="911"/></figure>
<p>For each blob, the malware resolves one of the strings “RSAFULLPRIVATEBLOB” or “RSAPUBLICBLOB” and uses it to specify the blob’s type when calling BCryptImportKeyPair to import the corresponding key handle.</p>
<figure class="aligncenter size-full"><img alt="" class="wp-image-5863" height="572" src="https://www.0ffset.net/wp-content/uploads/2022/05/main_bazar15.png" style="max-width:800px;height:auto;width:auto;" width="655"/></figure>
<p>Finally, it calls BCryptGetProperty to retrieve the length of the RSA public and private cipher blocks. With this structure fully populated, BAZARLOADER can now perform RSA encryption/decryption as well as SHA384 hashing.</p>
<h1>Step 5: C2 Connection Through Raw IP Addresses</h1>
<p>Prior to communicating with C2 servers, BAZARLOADER first resolves a list of raw IP addresses and writes them into the C2_addr_list field in the main structure.</p>
<p>This field is a structure representing a list of string structures, both of which can be reconstructed as below.</p>
<code>struct string_struct
{
 char *buffer;
 char *length;
 char *max_length;
};
struct string_struct_list
{
 string_struct *list_ptr;
 __int64 count;
 __int64 max_count;
};</code>
<figure class="aligncenter size-full"><img alt="" class="wp-image-5866" height="425" src="https://www.0ffset.net/wp-content/uploads/2022/05/main_bazar17.png" style="max-width:800px;height:auto;width:auto;" width="924"/></figure>
<p>Below is the list of all IP addresses for the C2 servers used in this sample.</p>
<code>https://5[.]182[.]207[.]28:443
https://80[.]71[.]158[.]42:443
https://198[.]252[.]108[.]16:443
https://84[.]32[.]188[.]136:443</code>
<p>For each of these addresses, the malware attempts to communicate with the corresponding server and download the next stage executable.</p>
<p>To establish a connection, it populates the following structure.</p>
<code>struct C2_connection_struct
{
 URL_COMPONENTSA C2_URL_components;
 HINTERNET connection_handle;
 __int64 connection_last_error;
};</code>
<p>The malware calls InternetCrackUrlA to retrieve the C2’s URL components and InternetConnectA to connect to the server.</p>
<figure class="aligncenter size-full"><img alt="" class="wp-image-5874" height="591" src="https://www.0ffset.net/wp-content/uploads/2022/05/main_bazar18.png" style="max-width:800px;height:auto;width:auto;" width="934"/></figure>
<p>This connection structure’s fields are then copied into the main structure’s C2_connection_struct. Here, I’m not entirely sure why they don’t just populate the main structure directly instead.</p>
<figure class="aligncenter size-large"><img alt="" class="wp-image-5875" height="415" src="https://www.0ffset.net/wp-content/uploads/2022/05/main_bazar19-1024x415.png" style="max-width:800px;height:auto;width:auto;" width="1024"/></figure>
<p>Similarly, BAZARLOADER populates the structure below to create an HTTP request to C2. The request’s object name and HTTP verb are resolved to be “/data/service” and “GET”.</p>
<code>struct C2_request_struct
{
 HINTERNET request_handle;
 __int64 request_error;
};</code>
<figure class="aligncenter size-full"><img alt="" class="wp-image-5878" height="444" src="https://www.0ffset.net/wp-content/uploads/2022/05/main_bazar20.png" style="max-width:800px;height:auto;width:auto;" width="998"/></figure>
<p>The request’s HTTP version is resolved to be “HTTP/1.1”, and BAZARLOADER calls HttpOpenRequestA to create this request for the C2 server using the connection handle retrieved above.</p>
<p>It also calls InternetSetOptionA to set the timeout for receiving a response and sending the request to 300 seconds and the timeout for connecting to C2s to 120 seconds.</p>
<figure class="aligncenter size-large"><img alt="" class="wp-image-5879" height="595" src="https://www.0ffset.net/wp-content/uploads/2022/05/main_bazar21-1024x595.png" style="max-width:800px;height:auto;width:auto;" width="1024"/></figure>
<p>BAZARLOADER then generates the HTTP header to be appended to the request. It does this by calling GetSystemTime to populate the curr_system_time and the datetime_string field of the main structure with the current date and time.</p>
<p>It also generates the SHA384 hash of the datetime string to populate the structure’s datetime_string_hash and datetime_string_hash_len fields.</p>
<figure class="aligncenter size-full"><img alt="" class="wp-image-5880" height="513" src="https://www.0ffset.net/wp-content/uploads/2022/05/main_bazar22.png" style="max-width:800px;height:auto;width:auto;" width="725"/></figure>
<p>Next, BAZARLOADER signs the generated hash with its RSA private by calling BCryptSignHash and uses this hash signature to randomly generate the HTTP header.</p>
<p>Below is the form of the random HTTP header.</p>
BAZARLOADER’s HTTP Header
<p>Date: Tue, 17 May 2022 20:18:27 GMT</p>
<p>Cookie: CGIC=YKK%2BIFrld%2FC5FqKj%2Fq1F9a06T0WgC4cOvCqqo3cfsyww1EwAb2TNFWqy8wBcDtObrgkjKtmIBSnsD%2Bmn2eR6MzQeUvHqOBJqA%2FqYS3KEkUQoKUgpOfuW%2BTtuz2OjhVeOJ1oMWnellOIJ4IuNBO5aVtzV8AI3CD4H8Z9tgjhG7i6cXrsAh5EUwKjHqbeEBszHmUhSsCNx0vypRWWd6MkM1HBeENiww7W8GjhoXvX8AwZ5VDTRSX3QSr9jpUuWYXHmJDhOtdG%2FW9UAWEHYkv6IpRsGPKWtAdR%2FzHNzWmZRC3HsMP4LyIOXCs5O8lvUZH2Bv2gtZ1SGZOD0Kd7Oi4nFwA%3D%3D;HSID=gbN30kmxz%2BKKygRK6DJjGJ%2FzGQcMDOSmyQoYi9p2ITFNy6zMnfCERvugTwb5O%2FZyAJ5lGvveYZlNK3N%2BRoNPqCThC%2Fwr2OQbPA3aFJeXZerPSF7bWmhHVGGunlw8HqV3dcjs67tLT7irrJLctXzonzWE%2B6Ukd9kdFTNWW5j7s2JEEAcW9Dp6x6WIdRemz6HC3BifjKQ%2BmwvryFaI%2BsLRi9T042hwKQqV7ikOLOsHOOCqlCKs0vcpFS5vUXzdGwSWdONWLHMEkuApe5B%2BUC7bULbJvnoqnT1jFFEE3vm5gSU%2BGKIbVqBCseLx42av7mxWCmJfB1mpDH3K6tJof0YKpQ%3D%3D;DV=arPk%2BRhtodeAHMzW%2FqoqfkfCFpUR1CYM5oW%2FK7onqCf46Xqk2OR0LjLK%2BQL7jCS5yrcZA2r2hYulBxnpVa%2B8tO%2BJImuPOM9B8JkIbEAMHp%2BvNq8vcSj78wA%2FoW0Wgx8Sw9lSMno4CgPoNgF1mrkm9m9cd7U6wQS7WGKR6Wufxuvjlyt6zf5xtU2gq9WtsxOglu%2BXOYApwXiTIEO853sEnzlVNopwMbYkBm5Mu2LSEycyBm4A9nWKVCr9r0xisHCGzde3sBO4hY7WyykPK6vsU3Ds36FVNH3Kv7jx1Kf6tCVe9ukypCd8j%2FXJWAgPwv%2BsWcyA6ky9skKq1GDuoMJQ5A%3D%3D;ANID=modcr%2B3xO4FT10Fb3jE3afiK3eFqJCs1ylPBjge%2F6lgEM3Li5i5UZ%2BviQCBS1cuiaiQ%2F9Cj62z%2BapXfRMVWSFEeZTv9rkmPKmp5FZHUq5VLHNyhrBtjScNXwDZVakrx9ZYt1uzzh2X93c6Z6YQsyNWlkfdmlZS1FCGOf0aaVZfIRiUW%2FXX6zNVph%2FBpYTicXqZ1qaiPAWb5FNF%2BfJylCjmVDOFCZHJ4E6M0Pph%2BvvgjuCO9bRHWjI2Ouz%2B8ETyMBoQOkSDGzzInMeapRKmXYNDhdcEogwNmRkJqoRJjBhHzvbIYgCXGNJFWVnxywcZSaHfQwGonWClY3vT3PSlEnHg%3D%3D;</p>
<p>X-Tag: f1DOF2QJkbCTJAUqiSLclK%2BsRkiAFHGmQusq2an%2FAud1WpfWVK%2F6gpLmtEQ38e65ILH8bHOzUd51lMpkh2xmHI5WpDJHgCtz5Q%2F%2BCL5usiShe35weofsQr9dQk%2BLsCl%2FulJlRg4cToY4ffie2MvfrtF4FCCZpbMy66UZUNqShGcbuIlRELkGKCTimwpB2wi4J6r%2FaIWAzINIP413ERqcQJ42Q1eQvvMkrEsWZDGEi4PHVtESHkcKKRVlZ9s3%2BPaQgq6TOR9YJxQOJaQ4NgaNuJAyHJnzkvtlQHNAy%2B%2FuLVa%2FpCuXxLvnw6dCIpmMwNHdzA09SL4T%2Bc5I3S6%2BFcu3mA%3D%3D</p>
<p>Vary: x564msS%2Bd%2BIrc97apj6SftcyuZTeoDUdyeLRN7n%2BkEJYVoJYAeuxpHT1XhTQ%2FywsKB7tZuNCJpid2qbr5DtOphE9Yvu2MfVTPH7nuK3yrk2nl93yuTpwiB%2F2kcFx57oLxtgqXkDlPENI3p31zdp%2B7quVz9C3ZKwA0Pi8%2FjH%2Fj%2BMKFZHpAWxlAWtxWe0xvwPKj3aroG6ujoEB9Fw%2Fq3IvIBsjoCXwIWPCSX7PCIk97ccsOyzqE6jGkgvVhfw%2BcvPL78g7gfvfx6eSDoOQj5M6xcH0aTPEld8rckxqFQmB9Gy%2B%2BNZ0YACTuCn7Aw9ziB9OmeKAy%2B5I%2F1J2ij7aSH3YgA%3D%3D</p>
<p>Var: wG852ANm2aHtGTrbsFHawff1eBZc9MnnPFOLEWeX3o7Ulc0fSj1qhaw%2BFlqpKs6ABhhs4opIe%2Bs%2BKqhT5G3jw9xRH%2FxeEYysL5AYbHsguuOivvXTofbFPPOLM%2ByoYIbq9Navi9C0VsaghxYUgsZ3wt4aHJAWXqvYacWoAowqCaZ7pg3FY0iKgLG403wZRS25%2BOrJL6gdo98qXYntX%2B4ZlPAUa49MiLJVQvI1xFCKLo5WbCb3b3aHQ2hpwvcYoh5P6F2su6Br3YL5DxtmpjdQY9IwLubcax%2BSZ4uZrDhX6MfnqQRa8vwA61OYhQUJM7OMeqPZ9lo%2BqkzrlPux1XxOyw%3D%3D</p>
<figure class="aligncenter size-full"><img alt="" class="wp-image-5884" height="611" src="https://www.0ffset.net/wp-content/uploads/2022/05/main_bazar23.png" style="max-width:800px;height:auto;width:auto;" width="975"/></figure>
<p>With the generated HTTP header and the request handle, BAZARLOADER calls HttpSendRequestA to send the request to the C2 server and calls HttpQueryInfoA to retrieve the status code.</p>
<p>If the status code is not HTTP_STATUS_OK, the malware moves on to another C2 address.</p>
<figure class="aligncenter size-full"><img alt="" class="wp-image-5886" height="489" src="https://www.0ffset.net/wp-content/uploads/2022/05/main_bazar24.png" style="max-width:800px;height:auto;width:auto;" width="833"/></figure>
<p>If the status code is HTTP_STATUS_OK, BAZARLOADER calls InternetQueryDataAvailable to determine the size of data to read, allocates the memory buffer according to the size, and calls InternetReadFile to read the next-stage payload until everything is written into memory.</p>
<figure class="aligncenter size-full"><img alt="" class="wp-image-5887" height="633" src="https://www.0ffset.net/wp-content/uploads/2022/05/main_bazar25.png" style="max-width:800px;height:auto;width:auto;" width="941"/></figure>
<p>Finally, the malware decrypts the payload with its RSA public key by calling BCryptDecrypt and checks to make sure the payload’s size is greater than 64 bytes and that it contains an MZ header.</p>
<figure class="aligncenter size-full"><img alt="" class="wp-image-5888" height="531" src="https://www.0ffset.net/wp-content/uploads/2022/05/main_bazar26.png" style="max-width:800px;height:auto;width:auto;" width="936"/></figure>
<h1>Step 6: C2 Connection Through Custom URLs</h1>
<p>If BAZARLOADER fails to download the next stage executable from the IP addresses listed above, it attempts to resolve custom C2 domains using <a href="https://www.opennic.org/" rel="noreferrer noopener" target="_blank">OpenNIC</a>, a user-owned DNS community service.</p>
<p>To begin querying OpenNIC’s API, the malware first resolves the URL “api.opennicproject.org” and calls InternetConnectA to establish a connection to the site.</p>
<figure class="aligncenter size-large"><img alt="" class="wp-image-5890" height="421" src="https://www.0ffset.net/wp-content/uploads/2022/05/main_bazar27-1024x421.png" style="max-width:800px;height:auto;width:auto;" width="1024"/></figure>
<p>Next, it calls HttpOpenRequestA to create a GET request handle with the object name “/geoip/?bare&amp;ipv=4&amp;wl=all&amp;res=8” and send the request using HttpSendRequestA.</p>
<p>By examining <a href="https://wiki.opennic.org/api/geoip" rel="noreferrer noopener" target="_blank">OpenNIC’s APIs</a>, we can break down this object name to see what BAZARLOADER is requesting. The “bare” parameter requests to only list the DNS server IP address, the “ipv” parameter requests to only list IPv4 servers, the “wl” parameter requests to only list whitelisted servers, and the “res” parameter requests to list 8 servers only.</p>
<p>To test this, we can simply paste the path below to a browser of our choosing.</p>
<code>api.opennicproject.org/geoip/?bare&amp;ipv=4&amp;wl=all&amp;res=8</code>
<figure class="aligncenter size-full"><img alt="" class="wp-image-5893" height="593" src="https://www.0ffset.net/wp-content/uploads/2022/05/main_bazar28-1.png" style="max-width:800px;height:auto;width:auto;" width="856"/></figure>
<p>The malware then enters a loop to call InternetQueryDataAvailable and InternetReadFile to read the 8 OpenNIC’s DNS servers into memory. </p>
<figure class="aligncenter size-full"><img alt="" class="wp-image-5895" height="636" src="https://www.0ffset.net/wp-content/uploads/2022/05/main_bazar29-2.png" style="max-width:800px;height:auto;width:auto;" width="839"/></figure>
<p>For each DNS server IP address, BAZARLOADER parses it from string to int and populates the opennic_server_struct field in the main structure. Below is the structure used to store OpenNIC IP addresses.</p>
<code>struct opennic_server_struct
{
 _QWORD init_server_count;
 HINTERNET opennic_internet_handle;
 DWORD opennic_server_IP_list[7];
 _BYTE gap2C[28];
 _QWORD server_count;
};</code>
<figure class="aligncenter size-full"><img alt="" class="wp-image-5896" height="606" src="https://www.0ffset.net/wp-content/uploads/2022/05/main_bazar30.png" style="max-width:800px;height:auto;width:auto;" width="990"/></figure>
<p>Finally, the malware decodes the following custom C2 domains, attempts to resolve them using the DNS servers, and downloads the next-stage executable.</p>
<code>reddew28c[.]bazar
bluehail[.]bazar
whitestorm9p[.]bazar</code>
<p>For each of these custom domains, BAZARLOADER calls DnsQuery_A to query a DNS Resource Record from OpenNIC’s servers to resolve the C2 server’s IP address.</p>
<figure class="aligncenter size-full"><img alt="" class="wp-image-5898" height="617" src="https://www.0ffset.net/wp-content/uploads/2022/05/main_bazar31.png" style="max-width:800px;height:auto;width:auto;" width="863"/></figure>
<p>After checking if the IP address is valid, the malware tries connecting to it and requests to download the next stage executable similar to what we have seen in the previous step.</p>
<figure class="aligncenter size-full"><img alt="" class="wp-image-5899" height="513" src="https://www.0ffset.net/wp-content/uploads/2022/05/main_bazar32.png" style="max-width:800px;height:auto;width:auto;" width="883"/></figure>
<h1>Step 5: Injection Through Process Hollowing</h1>
<p>After successfully downloading the next stage executable, BAZARLOADER begins the injection functionality to launch it from another process.</p>
<p>For this functionality, BAZARLOADER populates the following structure.</p>
<code>struct injection_struct
{
 HANDLE browser_proc_handle;
 PVOID full_exec_command;
 PVOID thread_curr_directory;
 PVOID browser_environment_struct;
 STARTUPINFOA thread_startup_info;
 LPPROC_THREAD_ATTRIBUTE_LIST proc_thread_attr_list;
};</code>
<p>First, it checks if its process is elevated with admin privileges. It calls GetCurrentProcess and OpenProcessToken to retrieve its own process token handle and GetTokenInformation to get the token’s elevation information.</p>
<figure class="aligncenter size-full"><img alt="" class="wp-image-5903" height="597" src="https://www.0ffset.net/wp-content/uploads/2022/05/main_bazar33.png" style="max-width:800px;height:auto;width:auto;" width="866"/></figure>
<p>If the process is not elevated, it resolves the following processes’ names and tries to populate the injection structure’s fields.</p>
<code>chrome.exe
firefox.exe
msedge.exe</code>
<figure class="aligncenter size-large"><img alt="" class="wp-image-5904" height="460" src="https://www.0ffset.net/wp-content/uploads/2022/05/main_bazar34-1024x460.png" style="max-width:800px;height:auto;width:auto;" width="1024"/></figure>
<p>For each process name, the malware enumerates the process’s snapshot to retrieve its ID and calls OpenProcess to get its handle.</p>
<p>To populate the full_exec_command and thread_curr_directory fields which contain the process’s command line and full path, BAZARLOADER first extracts the process parameters from the Process Environment Block (PEB).</p>
<p>To access the PEB, the malware calls NtQueryInformationProcess to retrieve the PEB’s adress and calls ReadProcessMemory to read the PEB into memory.</p>
<figure class="aligncenter size-full"><img alt="" class="wp-image-5906" height="530" src="https://www.0ffset.net/wp-content/uploads/2022/05/main_bazar35.png" style="max-width:800px;height:auto;width:auto;" width="737"/></figure>
<p>Next, it calls ReadProcessMemory to read the process parameters from the process’s memory.</p>
<figure class="aligncenter size-full"><img alt="" class="wp-image-5907" height="426" src="https://www.0ffset.net/wp-content/uploads/2022/05/main_bazar36.png" style="max-width:800px;height:auto;width:auto;" width="808"/></figure>
<p>With the process parameter RTL_USER_PROCESS_PARAMETERS structure, BAZARLOADER reads the process’s command line and full path to populate the injection structure.</p>
<figure class="aligncenter size-large"><img alt="" class="wp-image-5908" height="226" src="https://www.0ffset.net/wp-content/uploads/2022/05/main_bazar37-1024x226.png" style="max-width:800px;height:auto;width:auto;" width="1024"/></figure>
<p>Similarly, it also uses the process parameter to access the browser’s environment block and writes it to the injection structure.</p>
<figure class="aligncenter size-full"><img alt="" class="wp-image-5909" height="593" src="https://www.0ffset.net/wp-content/uploads/2022/05/main_bazar38.png" style="max-width:800px;height:auto;width:auto;" width="827"/></figure>
<figure class="aligncenter size-large"><img alt="" class="wp-image-5911" height="477" src="https://www.0ffset.net/wp-content/uploads/2022/05/main_bazar39-1024x477.png" style="max-width:800px;height:auto;width:auto;" width="1024"/></figure>
<p>If BAZARLOADER has admin privilege, instead of a browser’s process, it tries to populate the injection structure with a svchost.exe process from the following command line.</p>
<code>\\system32\\svchost.exe -k unistackSvcGroup</code>
<p>Next, using the injection struct, the malware calls CreateProcessA to create the target process in the suspended state to perform process hollowing.</p>
<figure class="aligncenter size-full"><img alt="" class="wp-image-5913" height="447" src="https://www.0ffset.net/wp-content/uploads/2022/05/main_bazar40.png" style="max-width:800px;height:auto;width:auto;" width="897"/></figure>
<figure class="aligncenter size-large"><img alt="" class="wp-image-5914" height="491" src="https://www.0ffset.net/wp-content/uploads/2022/05/main_bazar41-1024x491.png" style="max-width:800px;height:auto;width:auto;" width="1024"/></figure>
<p>We won’t dive too deep into this process hollowing implementation, since it’s almost the exact same implementation as seen <a href="https://github.com/m0n0ph1/Process-Hollowing" rel="noreferrer noopener" target="_blank">here</a>.</p>
<p>We can quickly spot that process hollowing is taking place through the Windows APIs being called. NtUnmapViewOfSection is called to unmap and carve out the parent’s memory. VirtualAllocEx and WriteProcessMemory are then called to allocate virtual memory in the parent’s process and write the malicious payload into it.</p>
<figure class="aligncenter size-large"><img alt="" class="wp-image-5917" height="503" src="https://www.0ffset.net/wp-content/uploads/2022/05/main_bazar42-1024x503.png" style="max-width:800px;height:auto;width:auto;" width="1024"/></figure>
<p>We can also see that the malware iterates through the parent’s section header to find the “.reloc” section and performs relocation on the injected image in memory.</p>
<figure class="aligncenter size-large"><img alt="" class="wp-image-5918" height="462" src="https://www.0ffset.net/wp-content/uploads/2022/05/main_bazar43-1024x462.png" style="max-width:800px;height:auto;width:auto;" width="1024"/></figure>
<p>Finally, BAZARLOADER calls SetThreadContext to set the new entry point for the parent process and calls ResumeThread to resume the parent’s process again, which will execute the injected executable.</p>
<figure class="aligncenter size-full"><img alt="" class="wp-image-5922" height="363" src="https://www.0ffset.net/wp-content/uploads/2022/05/main_bazar44-1.png" style="max-width:800px;height:auto;width:auto;" width="946"/></figure>
<p>And with that, we have analyzed how BAZARLOADER downloads a remote executable and executes it using process hollowing! If you have any questions regarding the analysis, feel free to reach out to me via <a href="https://twitter.com/cPeterr" rel="noreferrer noopener" target="_blank">Twitter</a>.</p>
</div>