<div>
<a class="a2a_button_facebook" href="https://blog.lumen.com/#facebook" rel="nofollow noopener" target="_blank" title="Facebook">Facebook</a><a class="a2a_button_twitter" href="https://blog.lumen.com/#twitter" rel="nofollow noopener" target="_blank" title="Twitter">Twitter</a><a class="a2a_button_linkedin" href="https://blog.lumen.com/#linkedin" rel="nofollow noopener" target="_blank" title="LinkedIn">LinkedIn</a><a class="a2a_button_pinterest" href="https://blog.lumen.com/#pinterest" rel="nofollow noopener" target="_blank" title="Pinterest">Pinterest</a><a class="a2a_button_email" href="https://blog.lumen.com/#email" rel="nofollow noopener" target="_blank" title="Email">Email</a><a class="a2a_dd addtoany_share_save addtoany_share" href="https://www.addtoany.com/share#url=https%3A%2F%2Fblog.lumen.com%2Fwindows-subsystem-for-linux-wsl-threats%2F&amp;title=Windows%20Subsystem%20for%20Linux%20(WSL)%3A%20Threats%20Still%20Lurk%20Below%20the%20(Sub)Surface">Share</a><h2>Executive Summary</h2>
<p>Last fall, Black Lotus Labs discovered in the wild what had until then only been theorized: Linux binaries were being used as loaders in Windows Subsystem for Linux (WSL). Since our <a href="https://blog.lumen.com/no-longer-just-theory-black-lotus-labs-uncovers-linux-executables-deployed-as-stealth-windows-loaders/" rel="noopener" target="_blank">initial report</a>, Black Lotus Labs continues to monitor the WSL attack surface for new developments. In the last few months, we have identified several different samples that indicate the capability is evolving. Custom developed and open-source tools (OSTs) have added functionality ranging from shellcode injection to keylogging and password stealing that could be used by actors to evade detection while gaining access into endpoints and computer networks. Given the demonstrated interest and the fact that even the samples with valid command and control (C2) infrastructure are evading general detection by AV providers, it is clear this newly proven type of attack remains one to be watched. In particular, because the types of users running WSL tend to have greater network privileges, organizations that utilize WSL as part of their day-to-day operations should take note to better bolster defenses.</p>
<h2>Introduction</h2>
<p>Since September 2021, as part of our proactive threat hunting process, Black Lotus Labs has been monitoring malware repositories for compiled ELF binaries that utilize either Windows API calls or file paths embedded in the executable. Because they were obtained through these repositories, the initial access vectors into the machines or networks are not yet known. As WSL requires domain administrative access to install, it is likely the targeted environments already had WSL loaded prior to the attacks.</p>
<p>Of the roughly 100 samples we’ve inspected over the last six months, we grouped a subset of the most noteworthy into two categories: the first group is comprised of custom developed tools and the second group consists of tools either taken completely from open-source frameworks or very lightly modified versions of open-source tools. By sharing how these samples work, how they persist and how they leverage C2 channels, we hope to keep the industry updated on the evolution of this attack vector and to aid in network-based detection, where possible. Some of the samples contained non-routable, or private IP addresses: we included them to showcase the techniques that are being developed for broader awareness.</p>
<h2>Custom Modules</h2>
<p>Several samples we analyzed were custom-built modules exhibiting a range of functionality that included keylogging, shellcode injection, a stager and even a cross-platform agent that worked in both Windows and Linux. The increase in custom modules suggests the WSL attack surface is a growing area of interest. While many of the samples did not yet appear to be fully functional due to the use of internal or non-routable IPs, they demonstrate attack methods that are actively being tested and refined.</p>
<h3>“Keyjeek” Keylogger Utilizing Gmail</h3>
<p>One of the payloads we analyzed was a keylogger written in Python that the developer named “Keyjeeklogger.” This sample wrote the recorded keyboard and mouse events to a text file named “LogFile.txt.” It then used hard-coded credentials for the email account nomotikag33n@gmail[.]com and a predefined password to transfer the LogFile.txt file to the actor. One function it displayed was the ability to edit a registry key (HKCU\Software\Microsoft\Windows\CurrentVersion\Run), a common method used by threat actors to persist on an infected machine past reboot. This sample appeared to be the most developed of those in the custom modules and is likely active in the wild given its routable C2 mechanism. This sample had a detection rate of only 1/60 on VirusTotal when it was found.</p>
<h3>Shellcode Injector</h3>
<p>One of the samples we analyzed included a shellcode injector. This malware created a new thread to download shellcode from a remote resource such as a domain or IP address, and then execute the shellcode. While the sample we analyzed was only comprised of a stager with a non-routable IP address, it could easily be augmented to download a more sophisticated in-memory agent such as Cobalt Strike or a custom framework. The method of injecting the payload directly into memory can be elusive and complicate host-based detection since the agent is not written to disk.</p>
<p><img alt="Figure1" class="aligncenter wp-image-13541 size-full" height="586" src="https://blog.lumen.com/wp-content/uploads/2022/03/xFigure1_shellcode-injector.jpg.pagespeed.ic.HkZEn88bpA.webp" style="max-width:800px;height:auto;width:auto;" width="936"/>Figure 1: Shellcode injector sample screenshot</p>
<h3>Stub.py Stager</h3>
<p>Among the samples we analyzed was a more traditional stager the actor named “stub.py.” This sample launched a Python script using the bash terminal and reached out for a remote resource. If it was unable to retrieve the next payload, it went to sleep for one second and then tried again. To further evade detection, the next agent was downloaded as a Python file, rather than an executable. Once downloaded onto the infected host Python file decrypted the data using a hard-coded key, and the script changed the file extension from Python to an executable. It then copied the payload to the \Microsoft\Windows\Start Menu\Programs\Startup folder, granting persistence by initiating the executable whenever the machine was powered on. Lastly, it executed the payload via the command shell. This sample contained a non-routable IP address suggesting it is still in development.</p>
<h3>Windows and Linux Cross-Platform “Lee” Agent</h3>
<p>One malware sample that stood out from the rest contained logic to run on either Linux or WSL machines. This sample appeared to be the closest to a fully functional agent, with the ability to remotely upload and download files, as well as run arbitrary commands. However, as it did not contain a routable C2 mechanism, it appeared to still be in the development phase. Notably, it was the only sample Black Lotus Labs analyzed that was written in Python 2, whereas all the other samples were compiled in Python 3. Additionally, the Lee agent contained a PDB path from the developer’s machine: /home/dirty/Desktop/lee/master/agent/d/agent.py.</p>
<p>This agent contained predefined logic to perform the following functions:</p>
<p><img alt="Table1" class="aligncenter wp-image-13553 size-full" height="208" src="https://blog.lumen.com/wp-content/uploads/2022/03/xTable1_Lee-agent_REV.png.pagespeed.ic.bWBCHJJ811.webp" style="max-width:800px;height:auto;width:auto;" width="698"/></p>
<p>The Lee agent also had the ability to persist on Linux and Windows machines. In Linux machines it edited the AutoStart directory path: ~/.config/autostart/gedit.desktop.</p>
<p>In a Windows machine, it modified the run key in the Windows registry to add a task named “lee”:
reg add HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Run /f /v lee /t REG_SZ /d “%s”.</p>
<h2>Open-Source Tools and Modules</h2>
<p>While we were evaluating samples, we found several agents that were largely based on OSTs found on websites like GitHub. OSTs offer tooling that minimizes the need for actors to develop their own, which can increase the cost. One interesting observation was that all of the OST-based samples also relied upon third-party services such as Discord and Telegram. We suspect that by using third-party network services and operating in a nebulous subsystem space, threat actors may be trying to evade some standard detection mechanisms.</p>
<h3>DiscordRAT</h3>
<p>One of the samples leveraged a project called <a href="https://github.com/Sp00p64/DiscordRAT" rel="noopener" target="_blank">DiscordRAT</a>, a remote administration tool (RAT) that is controlled over Discord and contains more than 20 post-exploitation modules. This sample exhibited a range of functions that appear to have been copied straight from the tool, such as:</p>
<ul>
<li>Check if running as admin</li>
<li>Execute arbitrary commands</li>
<li>Upload/download files</li>
<li>Take screenshots and access webcam</li>
<li>Start/stop a keylogger</li>
<li>Copy the contents of the clipboard</li>
<li>Kill the current session with the RAT</li>
</ul>
<p>This was one of the two fully functional RATs that we observed using WSL and signals that at least some actors are now capable of leveraging OSTs to execute a WSL-based attack. The detection rate of this sample on VirusTotal was 3/61.</p>
<h3>Discord Token Grabber</h3>
<p>Some of files that Black Lotus Labs detected performed more limited functions. The Discord token grabber module was designed to harvest authentication tokens saved to disk from various web browsers, including: Discord, Google Chrome, Opera, Brave and Yandex. The functionality and file paths correlate to the <a href="https://github.com/wodxgod/Discord-Token-Grabber/blob/master/token-grabber.py" rel="noopener" target="_blank">Discord Token Grabber</a> GitHub project. Once the authentication token was obtained, it sent the information from the infected Windows device to an actor-controlled Discord account with a hard-coded Linux-based User-Agent string. This module had the highest detection rate of 9/62 when it was found on VirusTotal.</p>
<p><img alt="Figure2" class="aligncenter size-full wp-image-13543" height="642" src="https://blog.lumen.com/wp-content/uploads/2022/03/Figure2_token-grabber.jpg" style="max-width:800px;height:auto;width:auto;" width="936"/>Figure 2: Token grabber sample screenshot</p>
<h3>Keylogger</h3>
<p>We observed one module that communicated via Discord and functioned as a <a href="https://github.com/3ct0s/discord-keylogger/blob/main/keylogger.py" rel="noopener" target="_blank">keylogger</a>. This sample was different than the Keyjeek logger covered previously, as it would just send the data from the infected machine to the C2 via the URL: https[:]//discord[.]com/api/webhooks/928513925610352650/iC7G5SFTzUmf4qQYyzXIhTSuA0bBrsME6cWwBnxvV-qa3inFESh3F4iF6Nkq05crHn5J. With this method, the data was not written to disk, making it harder to detect from a host-based prospective. Like the other Discord modules, it had a detection rate of 9/62 when first discovered.</p>
<h3>Telegram-Based Bot</h3>
<p>Discord was not the only third-party service we observed being utilized for C2s. One RAT communicated via the Telegram API, which we suspect was used to better blend in with the target environment. This appeared to be a lightly modified version of <a href="https://github.com/Bainky/Telegram-RAT" rel="noopener" target="_blank">Telegram-RAT</a>. As with the other RATs, this GitHub project included the ability to run commands, upload/download files and retrieve stored credentials, among other functions. We extracted the “Rat.py” file which acts as the configuration file by identifying the Telegram token, designating the ChatID for C2, determining the task name and designating the location to place the trojan itself. The contents of that file can be found below:</p>
<p>—
# Token/ID
TelegramToken = ‘2064338791:AAHUdTkYnC38Igw7Rrf9PWRRcZGS03-Bx0g’
TelegramChatID = ‘1987910945’</p>
<p>#Haha
# Run the script as administrator
AdminRightsRequired = False</p>
<p># Disable Task Manager at first start
DisableTaskManager = False
# Disable Registry Editor at first start
DisableRegistryTools = False\3
#HEEHEHEHEHRGREF
# Process protection from termination and deletion
ProcessBSODProtectionEnabled = True</p>
<p>#efrgGgrg
# Add to startup at first start
AutorunEnabled = True
# Installation directory
InstallPath = ‘C:\\ProgramData\\’
# Task name in Task Scheduler
AutorunName = ‘OneDrive Update’
# The name of the process in the Task Manager
ProcessName = ‘System.exe’
#fdgdfgeghhthth</p>
<p># Display a message at first start
DisplayMessageBox = True
# Your Message (will be displayed at start)
Message = ‘Done’
#lololololo
#danksDFdsf
# Directory for saving trojan temporary files
Directory = ‘C:\\Windows\\Temp\\Temp_data\\’
—</p>
<h3>Password Dumper Module</h3>
<p>One other sample that piqued our interest was named “dump-passwords.py.” We assess that at least part of the code was based upon a <a href="https://www.thepythoncode.com/article/extract-chrome-passwords-python" rel="noopener" target="_blank">Proof-of-Concept (PoC) to retrieve stored passwords</a>. While this particular sample did not contain a mechanism for external communications, it allowed the threat actor to harvest stored credentials on the infected machine – in this case from the Chrome login database. These stored credentials could be used later to retrieve information or help the actor move laterally if the victim reused passwords. One benefit to this approach over the Discord token grabber is that this module had a detection rate of zero.</p>
<p><img alt="Figure3" class="aligncenter size-full wp-image-13544" height="644" src="https://blog.lumen.com/wp-content/uploads/2022/03/Figure3_password-dumper.jpg" style="max-width:800px;height:auto;width:auto;" width="936"/>Figure 3: Password dumper sample screenshot</p>
<h2>Conclusion</h2>
<p>Threat actors are continuing to take advantage of the blurring boundaries between operating systems by developing this new class of WSL-based attack. If your corporate environment uses WSL, we recommend that you enable <a href="https://docs.microsoft.com/en-us/sysinternals/downloads/sysmon#usage" rel="noopener" target="_blank">system monitoring (Sysmon)</a> tools to help audit commands run via the WSL terminal. To learn more about how to monitor a Windows system with WSL installed for indicators of malicious activity, read this <a href="https://www.sans.org/white-papers/39330/" rel="noopener" target="_blank">SANS whitepaper</a>.</p>
<p>Black Lotus Labs will continue to follow the WSL attack surface to detect similar campaigns. As new and potent samples become available, we will continue to alert the information security community to these developments. We encourage other organizations to alert on this and similar activity in their environments.</p>
<p>For additional IOCs such as file hashes associated with these campaigns, please visit our <a href="https://github.com/blacklotuslabs/IOCs/blob/main/WSL_IoCs_March2022.txt" rel="noopener" target="_blank">GitHub page</a>.</p>
<p>If you would like to collaborate on similar research, please contact us on Twitter <a href="https://twitter.com/BlackLotusLabs" rel="noopener" target="_blank">@BlackLotusLabs</a>.</p>
<p>This analysis was performed by Danny Adamitis and Steve Rudd.</p>
<p>This information is provided “as is” without any warranty or condition of any kind, either express or implied. Use of this information is at the end user’s own risk.</p>
<h3>Related posts:</h3><ol>
<li><a href="https://blog.lumen.com/emotet-redux/" rel="bookmark" title="Emotet Redux">Emotet Redux </a></li>
<li><a href="https://blog.lumen.com/ismdoor-malware-continues-to-make-use-of-dns-tunneling/" rel="bookmark" title="Ismdoor Malware Continues to Make use of DNS Tunneling">Ismdoor Malware Continues to Make use of DNS Tunneling </a></li>
<li><a href="https://blog.lumen.com/a-look-inside-the-trickbot-botnet/" rel="bookmark" title="A Look Inside The TrickBot Botnet">A Look Inside The TrickBot Botnet </a></li>
<li><a href="https://blog.lumen.com/the-reemergence-of-ransom-based-distributed-denial-of-service-rddos-attacks/" rel="bookmark" title="The Reemergence of Ransom-based Distributed Denial of Service (RDDoS) Attacks">The Reemergence of Ransom-based Distributed Denial of Service (RDDoS) Attacks </a></li>
</ol>
0
Shares
<ul>
<li><a class="tooltip facebook_share" href="https://www.facebook.com/sharer/sharer.php?u=https://blog.lumen.com/windows-subsystem-for-linux-wsl-threats/" target="_blank" title="Share On Facebook">Share On Facebook</a></li>
<li><a class="tooltip twitter_share" href="https://twitter.com/intent/tweet?original_referer=https://blog.lumen.com/windows-subsystem-for-linux-wsl-threats/&amp;text=Windows%20Subsystem%20for%20Linux%20(WSL):%20Threats%20Still%20Lurk%20Below%20the%20(Sub)Surface&amp;url=https://blog.lumen.com/windows-subsystem-for-linux-wsl-threats/" target="_blank" title="Share On Twitter">Tweet It</a></li>
<li><a class="tooltip pinterest_share" href="http://www.pinterest.com/pin/create/button/?url=https%3A%2F%2Fblog.lumen.com%2Fwindows-subsystem-for-linux-wsl-threats%2F&amp;media=https%3A%2F%2Fblog.lumen.com%2Fwp-content%2Fuploads%2F2022%2F03%2FWSL.jpg" target="_blank" title="Share On Pinterest"></a></li>
<li><a class="tooltip google_share" href="https://plus.google.com/share?url=https://blog.lumen.com/windows-subsystem-for-linux-wsl-threats/" target="_blank" title="Share On Google+"></a></li>
<li><a class="tooltip email_share" href="mailto:?Subject=Windows+Subsystem+for+Linux+%28WSL%29%3A+Threats+Still+Lurk+Below+the+%28Sub%29Surface&amp;Body=https%3A%2F%2Fblog.lumen.com%2Fwindows-subsystem-for-linux-wsl-threats%2F" title="Share by Email"></a></li>
</ul>
<br class="clear"/>
</div>