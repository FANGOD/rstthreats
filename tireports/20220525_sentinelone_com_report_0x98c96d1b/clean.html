<div>
<a href="https://www.sentinelone.com/labs/category/security-intelligence/">Security &amp; Intelligence</a>
<h1 class="entry-title">Use of Obfuscated Beacons in ‘pymafka’ Supply Chain Attack Signals a New Trend in macOS Attack TTPs</h1>
<a class="" href="https://www.sentinelone.com/blog/author/macoswriter/">
Phil Stokes </a>
/
<a href="https://www.sentinelone.com/blog/2022/05/" rel="bookmark">
May 25, 2022
</a>
<h2>Overview</h2>
<p>Researchers from Sonatype last week <a href="https://blog.sonatype.com/new-pymafka-malicious-package-drops-cobalt-strike-on-macos-windows-linux" rel="noopener noreferrer" target="_blank">reported</a> on a supply chain attack via a malicious Python package ‘pymafka’ that was uploaded to the popular PyPI registry. The package attempted to infect users by means of typosquatting: hoping that victims looking for the legitimate ‘pykafka’ package might mistype the query and download the malware instead.</p>
<p>While typosquatting may seem like a rather hit-and-miss way to infect targets, it hasn’t stopped threat actors from trying their luck, and it’s the second such attack we’ve seen in recent weeks using this method. Last week, SentinelLabs reported on <a href="https://www.sentinelone.com/labs/cratedepression-rust-supply-chain-attack-infects-cloud-ci-pipelines-with-go-malware/" rel="noopener noreferrer" target="_blank">CrateDepression</a>, a typosquatting attack against the Rust repository that targeted macOS and Linux users.</p>
<p>Both attacks also made use of red-teaming tools to drop a payload on macOS devices that ‘beacons’ out to an operator. In the case of ‘pymafka’, the attackers further made use of a very specific packing and obfuscation method to disguise the true nature of the Mach-O payload, so specific in fact that we’ve only seen that method used in the wild once before, as part of the <a href="https://www.sentinelone.com/blog/top-10-macos-malware-discoveries-in-2021-a-guide-to-prevention-detection/" rel="noopener noreferrer" target="_blank">OSX.Zuru</a> campaign.</p>
<p>While the use of packing, obfuscation and beacons are all techniques common enough in the world of Windows attacks, they have rarely been seen used against macOS targets until now. In this post, we review how these TTPs were seen in pymafka and other attacks, and offer defenders indicators to help detect their use on macOS endpoints.</p>
<h2>The Pymafka Typosquatting Attack</h2>
<p>Since the details of this were well-covered <a href="https://blog.sonatype.com/new-pymafka-malicious-package-drops-cobalt-strike-on-macos-windows-linux" rel="noopener noreferrer" target="_blank">here</a>, we will only briefly review the first-stage of the attack for the purposes of context. The pymakfa package was so named in the hope that users would confuse it with pykafka, a Kafka client for Python that is widely used in enterprises. Kafka itself is described as “an open-source distributed event streaming platform used by thousands of companies”, including “80% of all Fortune 100 companies”, a description which gives a fairly clear indication of the attackers’ interests.</p>
<p>The pymafka package contains a Python script that surveils the host and determines its operating system.</p>
<figure class="wp-caption aligncenter" id="attachment_67424"><img alt="" class="size-full wp-image-67424" height="626" src="https://899029.smushcdn.com/2131410/wp-content/uploads/2022/05/pymafka-setup-py.jpg?lossy=0&amp;strip=1&amp;webp=0" style="max-width:800px;height:auto;width:auto;" width="1840"/><figcaption class="wp-caption-text" id="caption-attachment-67424">The setup.py script runs different logic for different platforms, including macOS</figcaption></figure>
<p>If the device is running macOS, it reaches out to a C2 and downloads a Mach-O binary called ‘MacOs’, which is then written to the <code>/var/tmp</code> (aka <code>/private/var/tmp</code>) directory with the filename “zad”.</p>
<p>Threat hunters should note that <code>/var/tmp</code> is not the same as the standard <code>/tmp</code> directory (aka <code>/private/tmp</code>), nor is it the same as the Darwin User <code>$TMPDIR</code> directory, both of which are more typical destinations for malware payloads. This little-used location may not be scanned or monitored by some security tools.</p>
<p>It might also be worth noting that ‘MacOs’ is itself a typo. The only form of this word used by Apple is cased as either ‘MacOS’ (the name of a directory inside every application bundle which contains the program executable) and ‘macOS’ (the official name of the operating system, replacing ‘OS X’). There is no Apple binary on the system that takes this word as a name. However, ‘MacOs’ is only used as the name of the file as it is stored remotely and may be useful in case-sensitive hunts across URL data, but as we noted above, the executable is written to the local file system as “zad”.</p>
<h2>Packed and Obfuscated Payload</h2>
<p>The payload is packed with UPX, a common enough technique used to evade certain kinds of static scanning tools. Aside from pymafka, UPX was recently used in the <a href="https://www.sentinelone.com/blog/from-the-front-lines-unsigned-macos-orat-malware-gambles-for-the-win/" rel="noopener noreferrer" target="_blank">Mac variant of oRat</a>, in OSX.Zuru, and in a variant of <a href="https://www.sentinelone.com/blog/sneaky-spies-and-backdoor-rats-sysjoker-and-dazzlespy-malware-target-macos/" rel="noopener noreferrer" target="_blank">DazzleSpy</a>, but more interesting than the packing is the obfuscation found in the decompressed binary.</p>
<p>The obfuscation has strong overlaps with a payload from the OSX.Zuru campaign. In that campaign, Chinese-linked threat actors distributed a series of sophisticated trojanized apps, including iTerm, Navicat, SecureCRT and Microsoft Remote Desktop via sponsored links in the Baidu search engine. The selection of trojanized apps suggested the threat actor was targeting users of backend tools used for SSH and other remote connections and business database management. </p>
<p>The trojanized apps dropped a UPX-packed Mach-O at <code>/private/tmp/GoogleUpdate</code> that used the same obfuscation techniques we observe in the pymafka payload. In both cases, researchers suggested the payload functions as a Cobalt Strike beacon, reaching out to check-in with a remote operator for further tasking.</p>
<p>The unpacked binary from OSX.Zuru and the unpacked binary from pymafka are quite different in size, the former weighing in at 5.7Mb versus the latter’s 3.6Mb, yet analysis of the sections suggests they have been run through a common obfuscation mechanism. In particular, the <code>__cstring</code> and <code>__const</code> sections are not only the same size but have the exact same hash values in both binaries.</p>
<figure class="wp-caption aligncenter" id="attachment_67423"><img alt="" class="size-full wp-image-67423" height="373" src="https://899029.smushcdn.com/2131410/wp-content/uploads/2022/05/pymafka-sections.jpg?lossy=0&amp;strip=1&amp;webp=0" style="max-width:800px;height:auto;width:auto;" width="1219"/><figcaption class="wp-caption-text" id="caption-attachment-67423">The highlighted data are common to both Zuru and pymafka payloads</figcaption></figure>
<p>The two executables also display very similar entropy across all Sections.</p>
<figure class="wp-caption aligncenter" id="attachment_67422"><img alt="" class="size-full wp-image-67422" height="385" src="https://899029.smushcdn.com/2131410/wp-content/uploads/2022/05/pymafka-entropy.jpg?lossy=0&amp;strip=1&amp;webp=0" style="max-width:800px;height:auto;width:auto;" width="968"/><figcaption class="wp-caption-text" id="caption-attachment-67422">The entropy profile of OSX.Zuru payload (left) and pymafka payload (right)</figcaption></figure>
<p>At this point, we are not suggesting that the campaigns are linked; it is possible that different actors may be coalescing around a set of similar TTPs and using a common tool or technique for obfuscating Cobalt Strike payloads.</p>
<h2>Abusing Red Teaming Tools For macOS Compromises</h2>
<p>More widely, our report on last week’s <a href="https://www.sentinelone.com/labs/cratedepression-rust-supply-chain-attack-infects-cloud-ci-pipelines-with-go-malware/" rel="noopener noreferrer" target="_blank">CrateDepression</a> supply chain attack described how threat actors used a Poseidon Mythic payload as the second-stage of their infection chain. Mythic, like Cobalt Strike, is a legitimate tool that was designed to simulate real-world attacks for use by red teams. Unlike Cobalt Strike, Mythic is open source software that can be used “as-is” or forked and adapted at will.</p>
<p>Both frameworks have become so adept at simulating real-world attacks that real-world attackers have adopted these frameworks as go-to tools. While this has been true for some time regarding Cobalt Strike and attacks on enterprises running Windows and Windows servers, this is a relatively new development in campaigns targeting macOS. But as the old movie quote has it, “if you build it, they will come”.</p>
<h2>Detecting pymafka and Similar Attacks</h2>
<p>For security teams, this means ensuring that you have good coverage against the common red-teaming tools and frameworks that are out there and which are easily available to attackers. Test that your security software can detect attacks using similar TTPs.</p>
<p>Threat hunters looking for this particular obfuscation technique might consider hunting for binaries with a <code>__TEXT.__cstring</code> section having the MD5 hash value of <code>c5a055de400ba07ce806eabb456adf0a</code> and binaries having similar entropy profiles as shown above.</p>
<p>The SentinelOne Singularlity platform detects and prevents attacks such as pymafka and OSX.Zuru, both in packed and unpacked form.</p>
<h2>Conclusion</h2>
<p>At this point in time, we can say very little about the threat actors behind the pymafka campaign, other than that the choice of package to typosquat and the use of typosquatting itself suggest a heavy interest in compromising multiple enterprises regardless of their industry vertical. While it’s not entirely unknown for highly-targeted attacks to hide behind mass intrusion techniques to obscure the real target, the simpler explanation is that this is likely a campaign with common “crimeware objectives” – stealing data, selling access, dropping ransomware and so on.</p>
<p>What is interesting from our point of view is that what we may be seeing now is the beginning of a ‘mirroring’ of TTPs commonly used against other enterprise platforms coming to macOS devices and Mac users. For organizations that still think of Macs as inherently safer than their Windows counterparts, this should be pause for thought and cause for concern. Adjust your risk assessments accordingly.</p>
<h2>Indicators of Compromise</h2>
<table>
<tbody>
<tr>
<td>Files</td>
<td>SHA1</td>
</tr>
<tr>
<td>pymafka-1.0.tar.gz</td>
<td>c41e5b1cad6c38c7aed504630a961e8c14bf4ba4</td>
</tr>
<tr>
<td>setup.py</td>
<td>7de81331ab2638956d93b0874a0ac5c741394135</td>
</tr>
<tr>
<td>MacOs (UPX packed)</td>
<td>d4059aeab42669b0824757ed85c019cd5036ffc4</td>
</tr>
<tr>
<td>zad (unpacked)</td>
<td>8df6339297d14b7a4d9cab1dfe1e5e3e8f9c6262</td>
</tr>
</tbody>
</table>
<p>Paths
/var/tmp/zad</p>
<p>Network Indicators
141.164.58.147
39.107.154.7</p>
</div>