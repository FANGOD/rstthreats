<div>
<a href="https://www.sentinelone.com/labs/category/adversary/">Adversary</a>
<h1 class="entry-title">Moshen Dragon’s Triad-and-Error Approach | Abusing Security Software to Sideload PlugX and ShadowPad</h1>
<a class="" href="https://www.sentinelone.com/blog/author/joeyc/">
Joey Chen </a>
/
<a href="https://www.sentinelone.com/blog/2022/05/" rel="bookmark">
May 2, 2022
</a>
<p>By Joey Chen and Amitai Ben Shushan Ehrlich</p>
<h2>Executive Summary</h2>
<ul>
<li>SentinelLabs researchers are tracking the activity of a Chinese-aligned cyberespionage threat actor operating in Central-Asia, dubbed ‘Moshen Dragon’.</li>
<li>As the threat actor faced difficulties loading their malware against the SentinelOne agent, we observed an unusual approach of trial-and-error abuse of traditional antivirus products to attempt to sideload malicious DLLs.</li>
<li>Moshen Dragon deployed five different malware triads in an attempt to use DLL search order hijacking to sideload ShadowPad and PlugX variants.</li>
<li>Moshen Dragon deploys a variety of additional tools, including an LSA notification package and a passive backdoor known as GUNTERS.</li>
</ul>
<h2>Overview</h2>
<p>SentinelLabs recently uncovered a cluster of activity targeting the telecommunication sector in Central Asia, utilizing tools and TTPs commonly associated with Chinese APT actors. The threat actor systematically utilized software distributed by security vendors to sideload <a href="https://www.sentinelone.com/labs/shadowpad-a-masterpiece-of-privately-sold-malware-in-chinese-espionage/">ShadowPad and PlugX</a> variants. Some of the activity partially overlaps with threat groups tracked by other vendors as <a href="https://www.recordedfuture.com/redfoxtrot-china-pla-targets-bordering-asian-countries/">RedFoxtrot</a> and <a href="https://malpedia.caad.fkie.fraunhofer.de/actor/nomad_panda">Nomad Panda</a>. We track this cluster of activity as ‘Moshen Dragon’.</p>
<p>Usually, good detection has an inverse relationship with visibility of a threat actor’s TTPs. When part of an infection chain gets detected, it usually means that we don’t get to see what the threat actor intended to deploy or ultimately do. In an unexpected twist, our detection capabilities uncovered an unusual TTP as Moshen Dragon attempted to repeatedly bypass that detection.</p>
<p>Every time the intended payload was blocked, we were able to witness the actor’s reliance on a wide variety of legitimate software leveraged to sideload ShadowPad and PlugX variants. Many of these hijacked programs belong to security vendors, including Symantec, TrendMicro, BitDefender, McAfee and Kaspersky.</p>
<p>Rather than criticize any of these products for their abuse by an insistent threat actor, we remind readers that this attack vector reflects an age-old design flaw in the Windows Operating System that allows DLL search order hijacking. Tracking of additional Moshen Dragon loading mechanisms and hijacked software surfaced more payloads uploaded to VirusTotal, some of which were recently published under the name ‘<a href="https://www.trellix.com/en-us/about/newsroom/stories/threat-labs/plugx-a-talisman-to-behold.html">Talisman</a>’.</p>
<p>In addition to ShadowPad and the PlugX Talisman variant, the Moshen Dragon deployed a variety of other tools, including an LSA notification package to harvest credentials and a passive loader dubbed GUNTERS by <a href="https://decoded.avast.io/threatintel/avast-finds-backdoor-on-us-government-commission-network/">Avast</a>. Despite all of this visibility, we are still unable to determine their main infection vector. Their concerted efforts include the use of known hacking tools, red team scripts, and on-keyboard attempts at lateral movement and data exfiltration.</p>
<p>We will focus on the actor’s insistent abuse of different AV products to load malicious payloads in an attempt to ‘bruteforce’ infection chains that would go undetected by traditional SOC and MDR solutions.</p>
<h2>Hijacking Security Products</h2>
<p>Moshen Dragon actors systematically abused security software to perform DLL search order <a href="https://attack.mitre.org/techniques/T1574/001/">hijacking</a>. The hijacked DLL is in turn used to decrypt and load the final payload, stored in a third file residing in the same folder. This combination is recognized as a sideloading triad, a technique commonly associated with <a href="https://securelist.com/the-leap-of-a-cycldek-related-threat-actor/101243/">Lucky Mouse</a>.</p>
<p>The way the payloads were deployed, as well as other actions within target networks, suggest the threat actor uses IMPACKET for lateral movement. Upon execution, some of the payloads will achieve persistence by either creating a scheduled task or a service.</p>
<figure class="wp-caption aligncenter" id="attachment_66085"><img alt="" class="size-full wp-image-66085" height="1121" src="https://899029.smushcdn.com/2131410/wp-content/uploads/2022/05/Moshen_Dragon_impacket.jpg?lossy=0&amp;strip=1&amp;webp=0" style="max-width:800px;height:auto;width:auto;" width="1999"/><figcaption class="wp-caption-text" id="caption-attachment-66085">Execution flow of hijacked software as carried out by Moshen Dragon</figcaption></figure>
<p>As major portions of the Moshen Dragon activity were identified and blocked, the threat actor consistently deployed new malware, using five different security products to sideload PlugX and ShadowPad variants.</p>
<p>A summary of the hijacked software is presented in the table below:</p>
<table>
<tbody>
<tr>
<td>Product</td>
<td>Path</td>
</tr>
<tr>
<td>Symantec SNAC</td>
<td>C:\Windows\AppPatch, C:\ProgramData\SymantecSNAC, C:\ProgramData\Symantec\SNAC, C:\Windows\Temp</td>
</tr>
<tr>
<td>TrendMicro Platinum Watch Dog</td>
<td>C:\Windows\	AppPatch</td>
</tr>
<tr>
<td>BitDefender SSL Proxy Tool</td>
<td>C:\ProgramData\Microsoft\Windows, C:\ProgramData\Microsoft\Windows\LfSvc, C:\ProgramData\Microsoft\Windows\WinMSIPC, C:\ProgramData\Microsoft\Windows\ClipSVC, C:\ProgramData\Microsoft\Wlansvc, C:\ProgramData\Microsoft\Windows\Ringtones</td>
</tr>
<tr>
<td>McAfee Agent</td>
<td>C:\ProgramData\McAfee, C:\ProgramData\Microsoft\WwanSvc, C:\ProgramData\Microsoft\WinMSIPC</td>
</tr>
<tr>
<td>Kaspersky Anti-Virus Launcher</td>
<td>C:\ProgramData\Microsoft\XboxLive, C:\programdata\GoogleUpdate</td>
</tr>
</tbody>
</table>
<h2>Lateral Movement Using Impacket</h2>
<p><a href="https://github.com/SecureAuthCorp/impacket">Impacket</a> is a collection of Python classes for working with network protocols, commonly utilized by threat actors for lateral movement. One of the favorite tools in the Impacket arsenal is <code>wmiexec</code>, which enables remote code execution via WMI. An effective way to identify <code>wmiexec</code> execution is searching for the unique command line pattern it creates. Moshen Dragon activities are rife with this pattern.</p>
<figure class="wp-caption aligncenter" id="attachment_66084"><img alt="" class="size-full wp-image-66084" height="629" src="https://899029.smushcdn.com/2131410/wp-content/uploads/2022/05/Moshen_Dragon_execution-chain.jpg?lossy=0&amp;strip=1&amp;webp=0" style="max-width:800px;height:auto;width:auto;" width="866"/><figcaption class="wp-caption-text" id="caption-attachment-66084">Lateral Movement utilizing Impacket as identified by the SentinelOne Agent</figcaption></figure>
<h2>LSA Notification Package – SecureFilter</h2>
<p>When on domain controllers, Moshen Dragon dropped a password filter and loaded it into the lsass process via LSA Notification packages. Impacket is used in the following manner:</p>
cmd.exe /Q /c REG ADD "HKLM\SYSTEM\CurrentControlSet\Control\Lsa" /v "Notification Packages" /t REG_MULTI_SZ /d "rassfm\0scecli\0SecureFilter" /f 1&gt; \\127.0.0.1\ADMIN$\__[REDACTED] 2&gt;&amp;1
<p>The DLL deployed is dropped in the path <code>C:\Windows\System32\SecureFilter.dll</code> in order to enable loading using the <a href="https://pentestlab.blog/2020/02/10/credential-access-password-filter-dll/">Notification Package</a> feature. The DLL seems to rely on an open source project named <a href="https://github.com/GoSecure/DLLPasswordFilterImplant">DLLPasswordFilterImplant</a>, effectively writing changed user passwords to the file <code>C:\Windows\Temp\Filter.log</code>.</p>
<figure class="wp-caption aligncenter" id="attachment_66087"><img alt="" class="size-full wp-image-66087" height="266" src="https://899029.smushcdn.com/2131410/wp-content/uploads/2022/05/Moshen_Dragon_SecureFilter.jpg?lossy=0&amp;strip=1&amp;webp=0" style="max-width:800px;height:auto;width:auto;" width="948"/><figcaption class="wp-caption-text" id="caption-attachment-66087">Snippet from SecureFilter.dll</figcaption></figure>
<h2>GUNTERS – A Passive Loader</h2>
<p>During our analysis of Moshen Dragon’s activities, we came across a passive loader previously discussed by Avast as ‘GUNTERS’. This backdoor appears to be highly targeted as it performs checks to verify that it is executed on the right machine.</p>
<p>Before execution, the malware calculates the hash of the machine hostname and compares it to a hardcoded value, suggesting that the threat actor generates a different DLL for each target machine.</p>
<p>The loader utilized <code>WinDivert</code> to intercept incoming traffic, searching for a magic string to initiate a decrypting process utilizing a custom protocol. Following the decryption process, the malware attempts to load a PE file with an exported function named <code>SetNtApiFunctions</code>, which it calls to launch the payload.</p>
<figure class="wp-caption aligncenter" id="attachment_66086"><img alt="" class="size-full wp-image-66086" height="562" src="https://899029.smushcdn.com/2131410/wp-content/uploads/2022/05/Moshen_Dragon_NTGetPwdPacket.jpg?lossy=0&amp;strip=1&amp;webp=0" width="510"/><figcaption class="wp-caption-text" id="caption-attachment-66086">Exported functions of an internal GUNTERS resource utilized in the loading process</figcaption></figure>
<p>A thorough analysis of the custom protocol and loading mechanism is available <a href="https://decoded.avast.io/threatintel/avast-finds-backdoor-on-us-government-commission-network/">here</a>.</p>
<h2>Additional Payloads</h2>
<p>SentinelLabs came across additional related artifacts overlapping with this threat cluster. It’s possible that some of those were utilized by Moshen Dragon or a related actor.</p>
<table>
<tbody>
<tr>
<td>File name </td>
<td>SHA1</td>
<td>C&amp;C</td>
</tr>
<tr>
<td>SNAC.log</td>
<td>e9e8c2e720f5179ff1c0ac30ce017224ac0b2f1b</td>
<td>freewula.strangled.net szuunet.strangled.net</td>
</tr>
<tr>
<td>SNAC.log</td>
<td>b6c6c292cbd35298a5f055448177bcfd5d0b23bf</td>
<td>final.staticd.dynamic-dns.net</td>
</tr>
<tr>
<td>SNAC.log</td>
<td>2294ecbbb065c517bd0e01f3f01aabd0a0402f5a</td>
<td>dhsg123.jkub.com</td>
</tr>
<tr>
<td>bdch.tmp</td>
<td>b85880ba6d38164dde4e77a15ab5e65cde7e357a</td>
<td>greenhugeman.dns04.com</td>
</tr>
</tbody>
</table>
<p>After analyzing these payloads, we found them to be additional PlugX and ShadowPad variants. <code>SNAC.log</code> payloads have been identified by other researchers as Talisman, which is known to be another variant of <a href="https://vms.drweb.com/virus/?i=21512304">PlugX</a>. In addition, the <code>bdch.tmp</code> payload was produced by shellcode with a structure similar to ShadowPad malware but without the initial code obfuscation and decryption logic typically seen in ShadowPad.</p>
<h2>Conclusion</h2>
<p>PlugX and Shadowpad have a well-established history of use among Chinese-speaking threat actors primarily for espionage activity. Those tools have flexible, modular functionality and are compiled via shellcode to easily bypass traditional endpoint protection products.</p>
<p>Here we focused on Moshen Dragon TTPs observed during an unusual engagement that forced the threat actor to conduct multiple phases of trial-and-error to attempt to deploy their malware. Once the attackers have established a foothold in an organization, they proceed with lateral movement by leveraging Impacket within the network, placing a passive backdoor into the victim environment, harvesting as many credentials as possible to insure unlimited access, and focusing on data exfiltration.</p>
<p>SentinelLabs continue to monitor Moshen Dragon activity as it unfolds.</p>
<h2>Indicators of Compromise</h2>
<p>Hijacked DLLs</p>
<ul>
<li>ef3e558ecb313a74eeafca3f99b7d4e038e11516</li>
<li>3c6a51961aa328ba507796153234309a5e83bee3</li>
<li>fae572ad1beab78e293f756fd53cf71963fdb1bd</li>
<li>308ed56dc1fbc98b574f937d4b005190c878416f</li>
<li>55e89f458b5f5642300dd7c50b444232e37c3fa7</li>
</ul>
<p>Payloads</p>
<ul>
<li>e9e8c2e720f5179ff1c0ac30ce017224ac0b2f1b</li>
<li>b6c6c292cbd35298a5f055448177bcfd5d0b23bf</li>
<li>2294ecbbb065c517bd0e01f3f01aabd0a0402f5a</li>
<li>b85880ba6d38164dde4e77a15ab5e65cde7e357a</li>
</ul>
<p>Password Filter</p>
<ul>
<li>c4f1177f68676b770934b142f9c3e2c4eff7f164</li>
</ul>
<p>GUNTERS</p>
<ul>
<li>bb68816f324f2ac4f0d4756b66af67d01c8b6e4e</li>
<li>4025e14a7f8928753ba06ad155944624069497dc</li>
<li>f5b8ab4a7d9c723c2b3b842b49f66da2e1697ce0</li>
</ul>
<p>Infrastructure</p>
<ul>
<li>freewula.strangled[.]net</li>
<li>szuunet.strangled[.]net</li>
<li>final.staticd.dynamic-dns[.]net</li>
<li>dhsg123.jkub[.]com</li>
<li>greenhugeman.dns04[.]com</li>
<li>gfsg.chickenkiller[.]com</li>
<li>pic.farisrezky[.]com</li>
</ul>
</div>