<div>
Posted on <a href="https://asec.ahnlab.com/en/34549/" rel="bookmark" title="1:00 pm">May 20, 2022</a>
<h1 class="title">Why Remediation Alone Is Not Enough When Infected by Malware</h1>
<p>In January 2022, a prominent Korean company in the manufacturing industry had many of its internal systems infected by the Darkside ransomware.</p>
<p>As the ransomware was found to be distributed using the AD group policy, AhnLab attempted to conduct a DC server forensic analysis. However, as the virtual environment operating system of the DC server operating in the virtual environment was damaged, the server could not be secured. Among the systems that were restored by the previous backup after the infection, the two WebLogic servers were found to be infected by WebShell during a similar period. AhnLab conducted the forensic analysis on the servers to check if WebShell was responsible for the Darkside infection. </p>
<p>The analysis result of WAS1 and WAS2 servers restored with previous snapshots showed that WebShell and Darkside were not related. However, there were Miner infections starting from April 2019, and there was a history of various malware infections and breach traces until February 2022 (the time of the analysis).</p>
<p>The company that uses the AhnLab product was aware of the infections, yet it seems the company did not identify how the infection happened in the first place. Apparently, the only action they took was remediating the system, without identifying how the infection started.</p>
<p>While the malware infecting the system may not inflict serious damage, leaked control and information of the internal systems may be traded between attackers and utilized in attacks that may cause serious issues in the future. As such, when the malware is detected, simply remedying the system and deleting the malware is not enough. To prevent further breaches and attacks of similar types, a detailed analysis of the infected system to identify the cause of the malware infections and breaches is needed, as well as resolving the identified issues.</p>
<p>Breach Details</p>
<p>The traces of the breach discovered on the targeted company’s WAS1 and WAS2 servers are as follows:</p>
<p>WAS1 was infected with CoinMiner in 2019. It was later infected with various malware types such as Cobalt Strike, WebShell, and info-leaking malware. It appears that the breach had been progressing for the recent 2-3 years by the various attackers. WAS2 had a malware strain likely created by a North Korean hacker, meaning it was probably being targeted by an APT attack. There were also various breach traces discovered on April 22, 2021, but the targeted company stated that it received a penetration testing service on that day.</p>
<figure class="aligncenter"><img alt="" class="jetpack-lazy-image" src="https://lh3.googleusercontent.com/OpCiEF7eMyhZxUefv1RDMgI3I7jLqeBXWi0ozSoeMXi4wGqlBmXSO8oRG1r7X6g57SgqFUf4VOH0XJh1fqy9fR_gZTiesyLGU991z8yUkHyhwoS9JHbvVZrPaO7pln9k_8t4PeD0am1OxPq9Sg" style="max-width:80%;height:auto;width:auto;"/><img alt="" src="https://lh3.googleusercontent.com/OpCiEF7eMyhZxUefv1RDMgI3I7jLqeBXWi0ozSoeMXi4wGqlBmXSO8oRG1r7X6g57SgqFUf4VOH0XJh1fqy9fR_gZTiesyLGU991z8yUkHyhwoS9JHbvVZrPaO7pln9k_8t4PeD0am1OxPq9Sg" style="max-width:80%;height:auto;width:auto;"/></figure>
<h2 class="has-medium-font-size">Initial Approach</h2>
<p>WAS1 was infected with CoinMiner on April 30, 2019. The malware was downloaded from 146.196.83.217. According to the <a href="https://s.tencent.com/research/report/1229">Tencent Security blog</a>, the IP address is related to a miner named RunMiner. It was found to be distributed by using the WebLog Deserialization vulnerability CVE-2017-10271.</p>
<p>The initial breach trace of WAS2 happened on April 29, 2020. There was a trace of the attacker attempting to infiltrate WebShell. The WebLogic version of WAS1 and WAS2 was 12.1.3, which is a version existing in the CVE-2017-10271 vulnerability mentioned above. It is likely that the initial breach happened due to the WebLogic vulnerability of the two servers. </p>
<p>Obtaining Account</p>
<p>On October 22, 2020, a hacking tool included with the dictionary attack feature and Isass.dmp file (a dump file for the lsass.exe process) were found as a compressed file (1.rar) in the shared folder of the WAS1 system. It seems the attacker stole the password by the dictionary attack method and process dump for lsass.exe.</p>
<p>Through the Isass.dmp file secured by the attacker, one can obtain various information such as drmftp, plain password of the Administrator account, and NTLM hash as shown below. </p>
<figure class="aligncenter"><img alt="" class="wp-image-34241 jetpack-lazy-image" height="860" src="https://i0.wp.com/asec.ahnlab.com/wp-content/uploads/2022/05/image-22.png?resize=658%2C722&amp;ssl=1" style="max-width:800px;height:auto;width:auto;" width="784"/><img alt="" class="wp-image-34241" height="860" src="https://i0.wp.com/asec.ahnlab.com/wp-content/uploads/2022/05/image-22.png?resize=658%2C722&amp;ssl=1" style="max-width:800px;height:auto;width:auto;" width="784"/><figcaption>Figure 2. Account information (ID, plain password, and NTLM Hash) extracted from Isass.dmp stolen by the attacker </figcaption></figure>
<p></p>
<p>The targeted company’s administrator account was in a vulnerable state:</p>
<ul><li>The password for the Administrator account did not change once since it was created.</li><li>The account used a password that could be easily guessed.</li><li>As the Administrator account’s password for both WAS1 and WAS2 was the same, it is likely that most of the other servers used the same password for their administrator accounts.</li></ul>
<p>Reverse RDP Access</p>
<p>After obtaining the account with the administrator privilege, the attacker sometimes had direct control of the system within the organization by accessing it with the Reverse RDP method using Lcx.exe.</p>
<p>Lcx.exe is an open-source tunneling tool that can be used to connect the external attacker with the internal system. The RDP communication process of Lcx.exe is as follows:</p>
<figure class="aligncenter"><img alt="" class="jetpack-lazy-image" src="https://lh6.googleusercontent.com/iYZQgJT6XU_cxdghkr5mylLCu4Pu362rQIc4aArkm7t_4s-P7wZaOuyemEbuX_lkwA2k26_Qnl28s0s86lIZy02Yz9edDFAG1MryCv7r_SYIkTYnnJLG7_F5QWpl70RaLYzjn1KhgJQOz2aK8g" style="max-width:80%;height:auto;width:auto;"/><img alt="" src="https://lh6.googleusercontent.com/iYZQgJT6XU_cxdghkr5mylLCu4Pu362rQIc4aArkm7t_4s-P7wZaOuyemEbuX_lkwA2k26_Qnl28s0s86lIZy02Yz9edDFAG1MryCv7r_SYIkTYnnJLG7_F5QWpl70RaLYzjn1KhgJQOz2aK8g" style="max-width:80%;height:auto;width:auto;"/><figcaption>Figure 3. RDP communication process using Lcx.exe</figcaption></figure>
<p></p>
<p>The history of Lcx.exe being created and executed in WAS1 was confirmed, as well as the access IP of 127.0.0.1 recorded in the event log (Event ID: 4624). The accounts used for verifying tunneling were local Administrator and test, both of them being administrator accounts. The test account was created right before the event, most likely done by the attacker. Unfortunately, AhnLab could not check the IP that the external attacker used for remote access. </p>
<figure class="aligncenter"><img alt="" class="jetpack-lazy-image" src="https://lh5.googleusercontent.com/CFd2Qzi4U75SHbiHIW07HVpVgUz0koyW-Y2xVRatPdGm_X4NtlWWZx0yYGFSV7hJedcSsPczXq-DpOKJkb-Bx51LfObqF8SvJ-J_1YjKyJC2Jujo6XM57qNFuRcHXoCx6P-lD-K69QrkmcfsbQ" style="max-width:80%;height:auto;width:auto;"/><img alt="" src="https://lh5.googleusercontent.com/CFd2Qzi4U75SHbiHIW07HVpVgUz0koyW-Y2xVRatPdGm_X4NtlWWZx0yYGFSV7hJedcSsPczXq-DpOKJkb-Bx51LfObqF8SvJ-J_1YjKyJC2Jujo6XM57qNFuRcHXoCx6P-lD-K69QrkmcfsbQ" style="max-width:80%;height:auto;width:auto;"/><figcaption>Figure 4. Tunneling RDP access event log – Event ID: 4624</figcaption></figure>
<p></p>
<p>Tools Used for Attack</p>
<p>The infected system had a scanning tool, proxy and port forwarding tool, WebShell, backdoor malware, etc.</p>
<p>The attacker used various tools for different purposes: collecting information for infiltration, port forwarding for establishing an external connection, installing backdoor for persistence, etc. The tools discovered in the system are shown below.</p>
<figure class="aligncenter"><img alt="" class="wp-image-34232 jetpack-lazy-image" height="792" src="https://i0.wp.com/asec.ahnlab.com/wp-content/uploads/2022/05/image-21.png?resize=716%2C792&amp;ssl=1" style="max-width:800px;height:auto;width:auto;" width="716"/><img alt="" class="wp-image-34232" height="792" src="https://i0.wp.com/asec.ahnlab.com/wp-content/uploads/2022/05/image-21.png?resize=716%2C792&amp;ssl=1" style="max-width:800px;height:auto;width:auto;" width="716"/><figcaption>Table 1. Tools Used for Attack</figcaption></figure>
<p></p>
<p>To bypass anti-malware products, the attacker used open-source programs that are relatively difficult to detect as attack tools. AhnLab detects and blocks malware and attack tools discovered in the infected system using the aliases below.</p>
<p>[File Detection]</p>
<ul><li>Unwanted/Win32.NSSM </li><li>Unwanted/Win32.BitCoinMiner </li><li>Unwanted/Win32.BitCoinMiner </li><li>Dropper/Win.Agent </li><li>Dropper/Win32.Agent </li><li>Dropper/Win.Agent </li><li>HackTool/Win.Fscan </li><li>HackTool/Win.Fscan </li><li>HackTool/Win.Fscan </li><li>HackTool/Win.NbtScan</li><li>Malware/Gen.Reputation </li><li>HackTool/Win.AliveScan</li><li>Exploit/Win.Scanner</li><li>HackTool/Win.LCX </li><li>HackTool/Win.Stowaway </li><li>HackTool/Win.NPS </li><li>HackTool/Win.Frp </li><li>HackTool/Win.Frp </li><li>Malware/Win64.Generic </li><li>Patched/Win.Loader</li><li>HackTool/Win.ExploitScanner</li></ul>
<p>[File MD5]</p>
<ul><li>1136efb1a46d1f2d508162387f30dc4d</li><li>ae00198dfa0ef3a7e5fea8dd06a8d8b8</li><li>f2f94708cef791d9664d2e4fa20ff520</li><li>0dabd600cea6dcf3c049a667b67b4482</li><li>99b0638f134a0d607edb8dbab01d3f95</li><li>763f2cae2072647d61d11047c8aaaf09</li><li>e636a07bb8d8fbfb1cab5557fdc217aa</li><li>0f7baf15408a49895439aa273ee7f867</li><li>7650484a85247bc922de760a6a335a76</li><li>62eada472d6d2d7606ba322c8b7f9153</li><li>f01a9a2d1e31332ed36c1a4d2839f412</li><li>f4a992b87d70c622eef107a09d712e9e</li><li>d221d51f4599ae051709b5cf5c45af10</li><li>fb6bf74c6c1f2482e914816d6e97ce09</li><li>4b8fbfc68b9969549f050c0e8366a10d</li><li>716979a28125fa65903e77dc5b399383</li><li>88a5ebccf60464764d0fe015d71bf330</li><li>d862186f24e644b02aa97d98695c73d8</li><li>114f26e7b46d0f4c4a202353c41ce366</li><li>0b877ea03db28b275dd535f16dd78239</li><li>fe12b5008334ad718008307e1a0750f7</li></ul>
<p>[IP/URL]</p>
<ul><li>198.13.53.81</li><li>180.235.137.14</li><li>185.239.226.133</li><li>159.233.41.219</li></ul>
<p>Subscribe to AhnLab’s next-generation threat intelligence platform ‘AhnLab TIP’ to check related IOC and detailed analysis information.</p>
<p>
Categories:<a href="https://asec.ahnlab.com/en/category/others-en/" rel="category tag">Others</a> </p>
<p>Tagged as:<a href="https://asec.ahnlab.com/tag/cobaltstrike/" rel="tag">CobaltStrike</a>, <a href="https://asec.ahnlab.com/en/tag/coinminer-en/" rel="tag">CoinMiner</a>, <a href="https://asec.ahnlab.com/tag/cve-2017-10271/" rel="tag">CVE-2017-10271</a>, <a href="https://asec.ahnlab.com/tag/darksideransomware/" rel="tag">DarksideRansomware</a>, <a href="https://asec.ahnlab.com/tag/reverserdp/" rel="tag">ReverseRDP</a>, <a href="https://asec.ahnlab.com/tag/weblogic/" rel="tag">WebLogic</a></p>
</div>