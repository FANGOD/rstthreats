<div>
<img alt="" class="hidden-social-img" src="https://labs.k7computing.com/wp-content/uploads/2022/05/Shells-Spring-2.png" style="max-width:80%;height:auto;width:auto;"/>
<a class="uncategorized" href="https://labs.k7computing.com/index.php/category/remote-code-execution-attacks/">Remote Code Execution Attacks</a><a class="uncategorized" href="https://labs.k7computing.com/index.php/category/vulnerability/">Vulnerability</a>
<h1 class="entry-title">Shells blooming in Spring</h1>
By Mohith Kalyan and Anurag ShandilyaMay 5, 2022
 
<p></p><p>Yet another vulnerability has been reported in the Java platform, this time in the popular Java Spring framework, just a few months after Log4shell, which was in the Java Logging Framework. </p>
<p>Two potential RCE vulnerabilities that are exploited in the wild are :</p>
<ol>
<li>CVE-2022-22965 (a.k.a Springshell), found in the Spring Core framework</li>
<li>CVE-2022-22963, found in Spring Cloud</li>
</ol>
<p>CVE-2022-22965 is an unauthorised Remote Code Execution (RCE) vulnerability found in the Java Spring Framework. The Spring team has released a patch for both vulnerabilities.</p>
<p>The SpringShell vulnerability allows attackers to target applications running with Java Spring Framework. This vulnerability is triggered when parameters that are passed to the Spring application via HTTP GET/POST request contain a class in them which results in those classes getting loaded allowing arbitrary write on the server.</p>
<p>Let’s discuss and dive deep into the analysis of CVE-2022–22965 vulnerability and its impact on organisations.</p>
<p>Note: The mere presence of the Spring framework doesn’t make the application vulnerable. So, it’s not easy to track all the vulnerable products that are affected by this vulnerability. But, here are some that are obvious.</p>
<p>Vulnerable Products</p>
<ul>
<li>Apache tomcat &lt;10.0.20</li>
<li>Apache tomcat &lt;9.0.62</li>
<li>Apache tomcat &lt;8.5.78</li>
<li>VMware</li>
</ul>
<p>To exploit CVE-2022-22965 (Springshell), the victim’s environment must have</p>
<ul>
<li>Spring Framework versions 5.3.0 to 5.3.17 or 5.2.0 to 5.2.19, and older versions</li>
<li>Apache Tomcat as the Servlet container</li>
<li>JDK 9 or higher</li>
<li>Packaged as a traditional WAR (Web application archive, in contrast to JAR)</li>
<li>spring-webmvc or spring-webflux dependency</li>
</ul>
<p>Note : Embedded Tomcat versions are not vulnerable to this flaw.</p>
<p>And to exploit CVE-2022-22963, the victim’s environment must have</p>
<ul>
<li>Spring cloud function &lt;=3.1.6 or</li>
<li>Spring cloud function &lt;=3.2.2</li>
</ul>
<p>The impact of CVE-2022-22965 would be huge compared to CVE-2022-22963, as SpringShell vulnerability affects the Java core framework (spring) and every organisation/application that uses this vulnerable module is susceptible to this vulnerability. On the other hand, the CVE-2022-22963’s scope is limited, as the cloud function module is used primarily in cloud projects and the majority of the spring cloud platforms have patched this vulnerability.</p>
<h3>Analysis</h3>
<p>This vulnerability lets a local class load in the HTTP parameter, thus leveraging the internal class directly and leading to an RCE. In other words, Injecting malicious values into unsafe properties of Java class via HTTP parameters. The vulnerability leverages DataBinder class and is exploitable by populating an object from request parameters (binding HTTP parameters in this case). You can find data binding rules by spring framework <a href="https://spring.io/blog/2022/04/13/spring-framework-data-binding-rules-vulnerability-cve-2022-22968">here</a>.</p>
<p>Here is a sample request for an explanation </p>
<p>curl ‘http://someip:8030/helloworld/greeting?class.module.classLoader.resources.context.parent.pipeline.first.pattern=shell’</p>
<p>This is a part request of the exploitation. As you can see in the request, the class object is directly being accessed via HTTP requests. The classLoader is being accessed via class.module.classloader parameter.</p>
<p>To achieve Remote Code Execution, we pass as parameters, a location and a template to the unfiltered Java class via a few properties, and that causes the object to create a new file for storing logs in our specified format. </p>
<p>Having seen the above example, here’s what happens under the hood to achieve RCE : </p>
<p>A malicious JSP web shell is being created here in our example, and for that, the below-mentioned class properties will be set accordingly as a result of parameter binding.</p>
<p>class.module.classLoader.resources.context.parent.pipeline.first.pattern = &lt;PATTERN_REDACTED&gt;”</p>
<p>This is the actual payload. The pattern property is usually set for a logging pattern. But, we injected our malicious payload into that by keeping the pattern as is.</p>
<p>class.module.classLoader.resources.context.parent.pipeline.first.suffix = “.jsp”</p>
<p>We have set the suffix parameter to .jsp, this is usually .txt or .log as log files are in text format in general.</p>
<p>class.module.classLoader.resources.context.parent.pipeline.first.directory = “webapps/ROOT”</p>
<p>The directory of the web shell is set by this parameter. Usually this will be the location where logs will be stored.</p>
<p>class.module.classLoader.resources.context.parent.pipeline.first.prefix = “shell”</p>
<p>Name of the log file we want to create, here we are creating a web shell with the name “shell”</p>
<p>class.module.classLoader.resources.context.parent.pipeline.first.fileDateFormat = “”</p>
<p>The log file usually starts with a date and time for obvious reasons, and this parameter is used to set that format. This parameter is not used in the exploit. </p>
<p>You can find the exploitation and setting of these exposed class properties on the wire as seen in Figure 1.</p>
<figure class="wp-caption aligncenter" id="attachment_23899"><img alt="" class="wp-image-23899 size-full" height="447" src="https://labs.k7computing.com/wp-content/uploads/2022/05/Figure-1.png" style="max-width:800px;height:auto;width:auto;" width="1128"/><figcaption class="wp-caption-text" id="caption-attachment-23899">Figure 1: Wireshark capture of the exploitation request sent</figcaption></figure>
<p>The log file is created with the name shell.jsp and the location webapps/root as we mentioned in the parameter. We smuggled in some Java code via pattern property to execute it on the system within the typical log format. If we dissect the payload, we can see the input stream to take in the input command and pass the command to the exec function as shown below. </p>
<p>“Runtime.getRuntime().exec(request.getParameter(“cmd”))”</p>
<p>and throws the output on standard output. </p>
<p>To access the created webshell, we request /shell.jsp and use the ‘cmd’ parameter to pass-along the commands that we want. An example is shown in a subsequent image. </p>
<p>Mirai botnet </p>
<p>Some recent events brought to light the real-world exploitation of the Springshell vulnerability. It was observed to be exploited and Mirai malware was deployed on infected servers as post-exploitation.</p>
<p>Debugging</p>
<p>We deployed the PoC available <a href="https://github.com/lunasec-io/Spring4Shell-POC" rel="noopener" target="_blank">here</a> to analyse and debug the vulnerability. We deployed the WAR in Apache Tomcat 9.0.58 in Kali Linux and used IntelliJ to debug Tomcat.</p>
<p>AccessLogValve is an extended Class that is used for generating Web Server access logs. As per <a href="https://tomcat.apache.org/tomcat-7.0-doc/api/org/apache/catalina/valves/AccessLogValve.html" rel="noopener" target="_blank">this</a> information available online, it refers to the currentLogFile, Prefix, Suffix and Pattern fields to write logs.</p>
<p>Figure 2 shows the fields set under normal traffic flow and Figure 3 shows fields under exploitation. </p>
<figure class="wp-caption aligncenter" id="attachment_23901"><img alt="" class="wp-image-23901 size-full" height="663" src="https://labs.k7computing.com/wp-content/uploads/2022/05/Figure-2.png" style="max-width:800px;height:auto;width:auto;" width="896"/><figcaption class="wp-caption-text" id="caption-attachment-23901">Figure 2: Normal field values</figcaption></figure>
<figure class="wp-caption aligncenter" id="attachment_23902"><img alt="" class="wp-image-23902 size-full" height="536" src="https://labs.k7computing.com/wp-content/uploads/2022/05/Figure-3.png" style="max-width:800px;height:auto;width:auto;" width="796"/><figcaption class="wp-caption-text" id="caption-attachment-23902">Figure 3: Field values during exploitation</figcaption></figure>
<p>In the figure above, as a result of the CVE-2022-22695, a specific pattern will be written to the shell.JSP log file. Part of this pattern is shown in Figure 4-A which is a web shell, which can be accessed via browser as can be seen in Figure 4-B. </p>
<figure class="wp-caption aligncenter" id="attachment_23903"><img alt="" class="wp-image-23903 size-full" height="221" src="https://labs.k7computing.com/wp-content/uploads/2022/05/Figure-4.png" style="max-width:800px;height:auto;width:auto;" width="957"/><figcaption class="wp-caption-text" id="caption-attachment-23903">Figure 4: A – Shell uploaded to the Web Server; B – Shell accessed using browser</figcaption></figure>
<p>The root cause(Diff)</p>
<p>The following is a patch diff for springshell vulnerability. The exact patch we are looking at is under CachedIntrospectionResults.java which is restricting property paths under “Class” and properties of types ‘ClassLoader’. By not allowing the binding, and only allowing name variants of class properties, the vulnerability is patched. </p>
<p>“we realized that the disallowedFields configuration setting on WebDataBinder is not intuitive and is not clearly documented.”</p>
<p>“the patterns for disallowedFields in a DataBinder were case sensitive which means a field was not effectively protected” — <a href="https://spring.io/blog/2022/04/13/spring-framework-data-binding-rules-vulnerability-cve-2022-22968" rel="noopener" target="_blank">Spring team </a></p>
<figure class="wp-caption aligncenter" id="attachment_23905"><img alt="" class="wp-image-23905 size-full" height="161" src="https://labs.k7computing.com/wp-content/uploads/2022/05/FIG5-1.png" width="512"/><figcaption class="wp-caption-text" id="caption-attachment-23905">Figure 5: Patch diff of spring shell vulnerability</figcaption></figure>
<p>Mitigation</p>
<ol>
<li>Update your Spring framework to 5.3.18 and 5.2.20 or later</li>
<li>If you are in a restricted environment, it is recommend to implement the following workarounds
<ol>
<li>Downgrading to Java 8</li>
<li>Upgrading to Tomcat 10.0.20, 9.0.62 or 8.5.78</li>
</ol>
</li>
</ol>
<p>Further readings</p>
<ol>
<li><a href="https://spring.io/blog/2022/03/31/spring-framework-rce-early-announcement" rel="noopener" target="_blank">https://spring.io/blog/2022/03/31/spring-framework-rce-early-announcement</a></li>
<li><a href="https://tomcat.apache.org/tomcat-7.0-doc/api/org/apache/catalina/valves/AccessLogValve.html" rel="noopener" target="_blank">https://tomcat.apache.org/tomcat-7.0-doc/api/org/apache/catalina/valves/AccessLogValve.html</a></li>
<li><a href="https://www.virustotal.com/gui/file/5fb0c8f3daef02b9d2ab285d0bf348cf1cb7c36708b0034ad0dee4998a16b9e9/detection" rel="noopener" target="_blank">https://www.virustotal.com/gui/file/5fb0c8f3daef02b9d2ab285d0bf348cf1cb7c36708b0034ad0dee4998a16b9e9/detection</a></li>
<li><a href="https://github.com/reznok/Spring4Shell-POC" rel="noopener" target="_blank">https://github.com/reznok/Spring4Shell-POC</a></li>
<li><a href="https://github.com/dinosn/CVE-2022-22963" rel="noopener" target="_blank">https://github.com/dinosn/CVE-2022-22963</a></li>
<li><a href="https://spring.io/blog/2022/04/13/spring-framework-data-binding-rules-vulnerability-cve-2022-22968" rel="noopener" target="_blank">https://spring.io/blog/2022/04/13/spring-framework-data-binding-rules-vulnerability-cve-2022-22968</a></li>
</ol>
<p>Indicators of Compromise (IoCs)</p>
<p>5fb0c8f3daef02b9d2ab285d0bf348cf1cb7c36708b0034ad0dee4998a16b9e9 – Second stage post exploitation file</p>
<p></p>
<h3 class="comment-reply-title">Like what you're reading? Subscribe to our top stories.</h3>
<p>If you want to subscribe to our monthly newsletter, please submit the form below.</p> Email* : 
<ul class="controls">
<li class="previous-post mouse-leaving">
<h3>Previous Post« <a href="https://labs.k7computing.com/index.php/diving-into-the-emotet-maldoc-boutade/" rel="prev">Diving into the Emotet Maldoc Boutade</a>
</h3>
</li>
<li class="next-post mouse-leaving">
<h3>Next Post
</h3>
</li>
</ul>
<h3 class="related-title">More Posts</h3>
</div>