<div>
<a class="notizia-secondary-color-bg notizia-main-color-text notizia-br-8" href="https://blog.sekoia.io/category/blogpost-en/" title="Blogpost">Blogpost</a>
<h1 class="notizia-headline">MSDT abused to achieve RCE on Microsoft Office</h1>
<a href="https://blog.sekoia.io/tag/cti/">CTI</a>
<a href="https://blog.sekoia.io/tag/detection/">Detection</a>
<a href="https://blog.sekoia.io/tag/vulnerability/">Vulnerability</a>
<a href="https://blog.sekoia.io/tag/zero-day/">Zero-Day</a>
<a href="https://blog.sekoia.io/author/tdr/">
<img alt="" class="avatar avatar-52 photo" height="52" src="https://secure.gravatar.com/avatar/6ba435e7a31ece8abfbe7465925530c6?s=52&amp;d=mm&amp;r=g" width="52"/> </a>
<a class="notizia-author-link notizia-headline-text-color" href="https://blog.sekoia.io/author/tdr/">Threat &amp; Detection Research Team</a>
June 1 2022
7
0
Read it later
Remove
8 minutes reading
<p>On May 27th a malicious Microsoft Office document was discovered by the NAO SEC security team and other threat hunters as MalwareByte researchers on VirusTotal. This DOCX document (MD5:52945af1def85b171870b31fa4782e52) has been crafted to load a specific remote HTML file by using the MSHTML engine. 
Once opened, the HTML file is using Javascript to replace its own URL by an URL containing the ms-msdt Protocol Scheme, pushing Microsoft Office to launch the Microsoft Support Diagnostic Tool utility (msdt.exe) with specific arguments, leading to the Remote Code Execution of an arbitrary Powershell payload. MSDT is a tool used to troubleshoot and collect diagnostic data for analysis by support professionals to resolve a problem.
It’s not the first time that the Microsoft Support Diagnostic Tool is abused in order to obtain arbitrary code execution on Windows. In the past, it has been abused to execute specific remote executables via XSS vulnerabilities on Electron apps or as a Living of the Land (LOL) Windows binary.
However, the past exploitation required at least a “one-click” user interaction or a second XML file present on the computer to be achieved. In that specific case, no interaction is required by the user and MSDT directly executes the Powershell Script embedded in the IT_BrowseForFile parameter. As identified by John Hammond from the <a href="https://blog.sekoia.io/cybersecurity-skills-shortage-4-advices-to-better-deal-with-it/" rel="noreferrer noopener" target="_blank">cybersecurity</a> firm Huntress, the content of theIT_BrowseForFile parameter needs to fill these conditions to be executed: </p>
<ul><li>At a minimum, two directory traversals (../) are required in the IT_BrowseForFile argument</li><li>Code wrapped within $() is executed via PowerShell, but spaces would break it</li><li>“.exe” must be the last trailing string present at the end of the IT_BrowseForFile argument</li></ul>
<p>At this time, we don’t know why Microsoft Support Diagnostic Tool allows arbitrary PowerShell execution inside the IT_BrowseForFile parameter. However, it is likely that researchers will find other “vulnerable” Microsoft utilities allowing such PowerShell execution in their parameters arguments in the coming weeks.
It is important to note that this vulnerability (CVE-2022-30190, also dubbed Follina by some security researchers) can be exploited even without opening the file by crafting a specific Rich Text Format (RTF) document and making the user preview it in the Windows Explorer Preview Pane. Several researchers pointed out that even if the docx exploitation chain seems to not work anymore, the RTF one is still vulnerable.</p>
<h2 id="h-a-vulnerability-with-chinese-roots">A vulnerability with chinese roots</h2>
<p>The discovered document is not the first DOCX seen ITW exploiting this vulnerability. SEKOIA found that several intrusion sets were aware of it prior to its discovery by NAO SEC and the first wave of exploitation seems to have been done by Chinese APT intrusion sets. In the documents, the inclusion of the External resource in the initial exploit is finished by an exclamation mark likely to force the execution by the MSHTML engine without warning.</p>
<p><img src="https://mcusercontent.com/682e219a4745200e0c4f0edd0/images/1d2c2a78-85e5-666d-079f-ea977e513445.png" style="max-width:80%;height:auto;width:auto;"/>
Figure 1. Malicious reference to an external HTML file</p>
<p>By looking at the files containing this specific string on VirusTotal at the end of the Target Attribute URL, we have been able to find five other documents, exploiting this vulnerability since the beginning of March 2022. Here is the list of the documents, their description and the URL where the malicious HTML payload was hosted: </p>
<ul><li>05-2022-0438.doc (MD5:52945af1def85b171870b31fa4782e52), created on the 2022-05-25, is a blank document, possibly a repuposing of the intitial exploit. This document loads an HTML file hosted on the attackers-owned domain www.xmlformats[.]com. It is worth to note that, SEKOIA have been able to retreive another domain used by the same attacker and dubbed miniformats[.]com.</li></ul>
<ul><li>Exposing_Nitesh_Pariyar_Liar!!!.doc (MD5:d313002804198b5af1e0b537799be348), created on the 2022-03-25, is a document which seems to target an individual working for the Nepalese NCELL company which is the first private mobile service provider operating in Nepal and the second largest telecommunications company, after Nepal Telecom. This document loads a an HTML file hosted on the likely compromised Exchange server at the following URL: hxxps://exchange.oufca[.]com.au/aspnet_client/poc.html</li></ul>
<ul><li>Exposing_Sonish_Liar!!!.doc (MD5:529c8f3d6d02ba996357aba535f688fc), created on the 2022-04-06 – is a similar document but exposing another nepalese individual. This document request another HTML file hosted on the same server: hxxps://exchange.oufca[.]com.au/owa/auth/15.1.2375/themes/p3azx.html</li></ul>
<ul><li>приглашение на интервью.doc (MD5:f531a7c270d43656e34d578c8e71bc39), created on the 2022-04-12 – is a document which seems to target specific individuals by asking for of an Interview on the Sputnik Russian radio broadcast related to Ukraine. This document loads an HTML file hosted on an VPS server the following URL: hxxps://www.sputnikradio[.]net/radio/news/3134.html</li></ul>
<ul><li>РЭТ-ЮМ-3044 от 12.04.2022.doc (MD5:6bcee92ab337c9130f27143cc7be5a55), created on the 2022-04-07, seems to target the CEO of the Concern Radio-Electronic Technologies. According to wikipedia CRET is producing fifth-generation Rostec R-168-5UN-2 encrypted Military-Transceiver which is used by the Russian forces in Ukraine. The document loads another HTML file hosted on thesputnikradio[.]net server at the following URL:
hxxps://www.sputnikradio[.]net/radio/news/1134.html</li></ul>
<ul><li>CSAFP’S_GUIDANCE_RE_NATIONAL_AND_LOCAL_ELECTION_2022_NLE.docx (MD5: 8ee8fe6f0226e346e224cd72c728157c), created on the 2022-03-09, is the first document seen ITW which exploits the vulnerability. This document impersonates the Philippines armed forces in a letter destined to several armed forces divisions. It loads the HTML file hosted on a VPS at the following URL: http://141.98.215[.]99/color.html</li></ul>
<a class="wp-block-button__link has-white-color has-text-color" href="http://sekoia.io/en/contact/" rel="noreferrer noopener" target="_blank">Discover our CTI and XDR products</a>
<p>It is interesting to note that there is no infrastructure connection between these documents. Therefore, it seems that the same exploit has been used or repurposed by different threat actors before its discovery by the security researchers.</p>
<p>Unfortunately for us, only one URL was active at the time of this writing. This small opportunity allowed us to grab a cabinet file executed on the victim’s workstation after the exploitation. This cabinet file (test.cab – MD5:75b614b50ff24d567d1b136340507b82) contains a binary is a compiled PyInstaller which contains a file named “loader.py”. </p>
<p>This loader – which seems to have Chinese origins according to the comments left by the developer – downloads an encoded shellcode from the server 160.20.145[.]111. Then, it performs useless RSA encryption and decryption operations on it and executes it in a new thread. The retrieved shellcode is a Cobalt Strike beacon which communicates with 103.51.140[.]188 by using jQuery malleable profile.</p>
<p>Both of the retrieved IP addresses are already known as malicious in SEKOIA.IO Intelligence Center. 160.20.145[.]111 to be a PlugX C2 and 103.51.140[.]188 to be a CobaltStrike C2. As of today, no attribution to a specific Chinese intrusion set or activity cluster can be done with these technical indicators. </p>
<h2>Vulnerability detection</h2>
<p>The detection of the CVE-2022-30190 exploitation can be done through analysis of process execution. msdt.exe executed with the IT_BrowseForFile argument containing $( is a sign of the vulnerability exploitation attempt.</p>
<h2>Workarounds</h2>
<p>As the current version of Office is still vulnerable with RTF documents, and Microsoft did not publish any patch yet, we advise to apply remediations. Different remediations, deployable by GPO, seems to be possible in the wait of the Official patch from Microsoft:</p>
<ul><li>Remove the ms-msdt URI schema registry key in registry HKEY_CLASSES_ROOT</li><li>Disable “Troubleshooting wizards” in registry HKEY_LOCAL_MACHINE: SOFTWARE\Policies\Microsoft\Windows\ScriptedDiagnostics</li></ul>
<p>Mars, a red-hot information stealer</p>
<a class="wp-block-button__link" href="https://blog.sekoia.io/mars-a-red-hot-information-stealer/" rel="noreferrer noopener" target="_blank">Read the article</a>
<h2>IOCs</h2>
<p>Malicious documents hashs
8ee8fe6f0226e346e224cd72c728157c
6bcee92ab337c9130f27143cc7be5a55
f531a7c270d43656e34d578c8e71bc39
529c8f3d6d02ba996357aba535f688fc
d313002804198b5af1e0b537799be348
52945af1def85b171870b31fa4782e52</p>
<p>
Loaders hashs
414ac723fe6fdbd5cb1e703b0c225b50
8e4d8cbbc7374574f40c31f02f225053
75b614b50ff24d567d1b136340507b82</p>
<p>
VPS servers
103.51.140[.]188
160.20.145[.]111
141.98.215[.]99
sputnikradio[.]net
xmlformats[.]com
miniformats[.]com
onedrivo[.]com</p>
<p>YARA rules
</p>
<code>rule exploit_CVE202230190_html_file_hunting {
 meta:
 id ="70b5ddc4-443d-4bc7-b047-29ed2247f364"
 version = "1.0"
 description = "Detects the HTML file used for to exploit"
 cve = "CVE-2022-30190"
 source = "SEKOIA"
 ceation_date = "2022-05-30"
 modification_date = "2022-05-30"
 classification = "TLP:GREEN"
 strings:
 $script = "= 4000 and $script and
 $ms_msdt in (@href..@href+20)
}</code>
<code>rule exploit_CVE202230190_Documentxmlrels_hunting {
 meta:
 id = "b3d06d37-fa80-4515-9aaf-1168c515bd8f"
 version = "1.0"
 description = "Detects document.xml.rels used by the DOCXs"
 warning = "Hunting rule, can produce FPs"
 cve = "CVE-2022-30190"
 source = "SEKOIA"
 creation_date = "2022-05-31"
 modification_date = "2022-05-31"
 classification = "TLP:GREEN"
 strings:
 $s = { 21 22 20 54 61 72 67 65
 74 4D 6F 64 65 3D 22 45
 78 74 65 72 6E 61 6C 22
 2F 3E }
 condition:
 uint32be(0) == 0x3C3F786D and #s == 1
}</code>
<p>
SIGMA rule</p>
<code>version: 2.0
uuid: e3fe6d7d-7609-4641-9c52-62ccf578d35a
rule: Msdt File Browse Process Execution
description: &gt;-
Detects when the Compatability Troubleshooter is abused.
detection:
 selection:
 process.name: 'msdt.exe'
 process.command_line|contains|all:
 - 'IT_BrowseForFile'
 - '$('
 condition: selection
alert_category: intrusions
alert_type: system-compromise
alert_severity: 80
attack:
 - T1203
data_sources:
 - Process command-line parameters
 - Process monitoring
 - Windows event logs</code>
<h2>
TTPs (ATT&amp;CK)</h2>
<ul><li>Exploitation for Client Execution (T1203)</li><li>Command and Scripting Interpreter: PowerShell (T1059.001)</li><li>Phishing (T1566)</li></ul>
<h2 class="has-text-align-center has-white-color has-text-color">Chat with our team!</h2>
<p>Would you like to know more about our solutions? Do you want to discover our XDR and CTI products? Do you have a cybersecurity project in your organization? Make an appointment and meet us!</p>
<a class="wp-block-button__link has-white-background-color has-text-color has-background" href="https://www.sekoia.io/en/contact/" rel="noreferrer noopener" target="_blank">Contact us</a>
<h2>References</h2>
<ul><li><a href="https://twitter.com/nao_sec/status/1530196847679401984?s=20&amp;t=AmJicjJLyI4l5RrHpnyZ9g" rel="noreferrer noopener" target="_blank">[Twitter] NaoSec Tweet related to the malicious document</a></li><li><a href="https://msrc-blog.microsoft.com/2022/05/30/guidance-for-cve-2022-30190-microsoft-support-diagnostic-tool-vulnerability/" rel="noreferrer noopener" target="_blank">[Microsoft] Microsoft advisory</a></li><li><a href="https://benjamin-altpeter.de/shell-openexternal-dangers/" rel="noreferrer noopener" target="_blank">[Benjamin-altpeter] MSDT abuse via XSS on Electron Apps</a></li><li><a href="https://lolbas-project.github.io/lolbas/Binaries/Msdt/" rel="noreferrer noopener" target="_blank">[LOLBAS] MSDT abuse to execute arbitrary code</a></li><li><a href="https://twitter.com/HaifeiLi/status/1531329940980805633" rel="noreferrer noopener" target="_blank">[Twitter] RTF execution chain still vulnerable</a></li></ul>
<a class="notizia-sharing-icon-container" href="https://www.facebook.com/sharer/sharer.php?u=https://blog.sekoia.io/msdt-abused-to-achieve-rce-on-microsoft-office/" target="_blank" title="Share this post on Facebook">
</a>
<a class="notizia-sharing-icon-container" href="https://twitter.com/share?text=MSDT%20abused%20to%20achieve%20RCE%20on%20Microsoft%20Office&amp;url=https://blog.sekoia.io/msdt-abused-to-achieve-rce-on-microsoft-office/" target="_blank" title="Share this post on Twitter">
</a>
<a class="notizia-sharing-icon-container" href="mailto:?subject=MSDT%20abused%20to%20achieve%20RCE%20on%20Microsoft%20Office&amp;body=MSDT%20abused%20to%20achieve%20RCE%20on%20Microsoft%20Office%0D%0AOn%20May%2027th%20a%20malicious%20Microsoft%20Office%20document%20was%20discovered%20by%20the%20NAO%20SEC%20security%20team%20and%20other%20threat%20hunters%20as%20MalwareByte%20researchers%20on%20VirusTotal.%20This%20DOCX%20document%20%28MD5%3A52945af1def85b171870b31fa4782e52%29%26nbsp%3B%20has%20been%20crafted%20to%20load%20a%20specific%20remote%20HTML%20file%20by%20using%20the%20MSHTML%20engine.%26nbsp%3B%20Once%20opened%2C%20the%20HTML%20file%20is%20using%20Javascript%20to%20replace%20its%20%5B%26hellip%3B%5D%0D%0A%0D%0ARead%20more%20at%3A%20https%3A%2F%2Fblog.sekoia.io%2Fmsdt-abused-to-achieve-rce-on-microsoft-office%2F" target="_blank" title="Send this post via email">
</a>
Share
<p>
Share this post:
<a class="notizia-sharing-icon-container" href="https://www.facebook.com/sharer/sharer.php?u=https://blog.sekoia.io/msdt-abused-to-achieve-rce-on-microsoft-office/" target="_blank" title="Share this post on Facebook">
</a>
<a class="notizia-sharing-icon-container" href="https://twitter.com/share?text=MSDT%20abused%20to%20achieve%20RCE%20on%20Microsoft%20Office&amp;url=https://blog.sekoia.io/msdt-abused-to-achieve-rce-on-microsoft-office/" target="_blank" title="Share this post on Twitter">
</a>
<a class="notizia-sharing-icon-container notizia-whatsapp" href="whatsapp://send?text=MSDT%20abused%20to%20achieve%20RCE%20on%20Microsoft%20Office%20-%20https://blog.sekoia.io/msdt-abused-to-achieve-rce-on-microsoft-office/" title="Share this post on WhatsApp">
</a>
<a class="notizia-sharing-icon-container notizia-telegram" href="tg://msg_url?url=https://blog.sekoia.io/msdt-abused-to-achieve-rce-on-microsoft-office/&amp;text=MSDT%20abused%20to%20achieve%20RCE%20on%20Microsoft%20Office" title="Share this post on Telegram">
</a>
<a class="notizia-sharing-icon-container" href="mailto:?subject=MSDT%20abused%20to%20achieve%20RCE%20on%20Microsoft%20Office&amp;body=MSDT%20abused%20to%20achieve%20RCE%20on%20Microsoft%20Office%0D%0AOn%20May%2027th%20a%20malicious%20Microsoft%20Office%20document%20was%20discovered%20by%20the%20NAO%20SEC%20security%20team%20and%20other%20threat%20hunters%20as%20MalwareByte%20researchers%20on%20VirusTotal.%20This%20DOCX%20document%20%28MD5%3A52945af1def85b171870b31fa4782e52%29%26nbsp%3B%20has%20been%20crafted%20to%20load%20a%20specific%20remote%20HTML%20file%20by%20using%20the%20MSHTML%20engine.%26nbsp%3B%20Once%20opened%2C%20the%20HTML%20file%20is%20using%20Javascript%20to%20replace%20its%20%5B%26hellip%3B%5D%0D%0A%0D%0ARead%20more%20at%3A%20https%3A%2F%2Fblog.sekoia.io%2Fmsdt-abused-to-achieve-rce-on-microsoft-office%2F" target="_blank" title="Send this post via email">
</a>
</p>
</div>