{"id": "sentence_0x2fa24f9f", "report_id": "report_0xdb31cca7", "report_date": "2022-05-20T00:00:00Z", "report_title": "Weaponization of Excel Add-Ins Part 2: Dridex Infection Chain Case Studies", "report_url": "https://unit42.paloaltonetworks.com/excel-add-ins-dridex-infection-chain", "chapter_id": "chapter_0x67a34f4b", "chapter_title": "Weaponization of Excel Add-Ins Part 2: Dridex Infection Chain Case Studies", "text": "1,315 people reacted 0 8 min. read"}
{"id": "sentence_0xf2488ba4", "report_id": "report_0xdb31cca7", "report_date": "2022-05-20T00:00:00Z", "report_title": "Weaponization of Excel Add-Ins Part 2: Dridex Infection Chain Case Studies", "report_url": "https://unit42.paloaltonetworks.com/excel-add-ins-dridex-infection-chain", "chapter_id": "chapter_0x67a34f4b", "chapter_title": "Weaponization of Excel Add-Ins Part 2: Dridex Infection Chain Case Studies", "text": "By Saqib Khanzada"}
{"id": "sentence_0x699fb344", "report_id": "report_0xdb31cca7", "report_date": "2022-05-20T00:00:00Z", "report_title": "Weaponization of Excel Add-Ins Part 2: Dridex Infection Chain Case Studies", "report_url": "https://unit42.paloaltonetworks.com/excel-add-ins-dridex-infection-chain", "chapter_id": "chapter_0x67a34f4b", "chapter_title": "Weaponization of Excel Add-Ins Part 2: Dridex Infection Chain Case Studies", "text": "May 19, 2022 at 12:00 PM"}
{"id": "sentence_0xa2cfb224", "report_id": "report_0xdb31cca7", "report_date": "2022-05-20T00:00:00Z", "report_title": "Weaponization of Excel Add-Ins Part 2: Dridex Infection Chain Case Studies", "report_url": "https://unit42.paloaltonetworks.com/excel-add-ins-dridex-infection-chain", "chapter_id": "chapter_0x67a34f4b", "chapter_title": "Weaponization of Excel Add-Ins Part 2: Dridex Infection Chain Case Studies", "text": "Category: Malware"}
{"id": "sentence_0x8cfc27e", "report_id": "report_0xdb31cca7", "report_date": "2022-05-20T00:00:00Z", "report_title": "Weaponization of Excel Add-Ins Part 2: Dridex Infection Chain Case Studies", "report_url": "https://unit42.paloaltonetworks.com/excel-add-ins-dridex-infection-chain", "chapter_id": "chapter_0x67a34f4b", "chapter_title": "Weaponization of Excel Add-Ins Part 2: Dridex Infection Chain Case Studies", "text": "Tags: AgentTesla, Dridex, Macros, Microsoft Excel, next-generation firewall, WildFire"}
{"id": "sentence_0xeb3db4a7", "report_id": "report_0xdb31cca7", "report_date": "2022-05-20T00:00:00Z", "report_title": "Weaponization of Excel Add-Ins Part 2: Dridex Infection Chain Case Studies", "report_url": "https://unit42.paloaltonetworks.com/excel-add-ins-dridex-infection-chain", "chapter_id": "chapter_0x970b84aa", "chapter_title": "Executive Summary", "text": "In Part 1 of this two-part blog series, we discussed briefly how XLL files are exploited to deploy Agent Tesla. During December 2021, we continued to observe Dridex and Agent Tesla exploiting XLL in different ways for initial payload delivery. A more in-depth look at the Dridex infection chain follows."}
{"id": "sentence_0xe28e3774", "report_id": "report_0xdb31cca7", "report_date": "2022-05-20T00:00:00Z", "report_title": "Weaponization of Excel Add-Ins Part 2: Dridex Infection Chain Case Studies", "report_url": "https://unit42.paloaltonetworks.com/excel-add-ins-dridex-infection-chain", "chapter_id": "chapter_0x970b84aa", "chapter_title": "Executive Summary", "text": "Threat actors behind Dridex have been using various delivery mechanisms over the years. In early 2017, we observed plain VBScript and JavaScript were being used. In later years, we observed many variations, including Microsoft Office files (DOC, XLS) compressed in zip. In 2020, we found the malware using Discord and other legitimate services to download the final payload. More recently, during December 2021, we received various Dridex samples, which were exploiting XLL and XLM 4.0 in combination with Discord and OneDrive to download the final payload."}
{"id": "sentence_0x8208e713", "report_id": "report_0xdb31cca7", "report_date": "2022-05-20T00:00:00Z", "report_title": "Weaponization of Excel Add-Ins Part 2: Dridex Infection Chain Case Studies", "report_url": "https://unit42.paloaltonetworks.com/excel-add-ins-dridex-infection-chain", "chapter_id": "chapter_0x970b84aa", "chapter_title": "Executive Summary", "text": "In our previous blog focused on XLL files and Agent Tesla, we saw the abuse of the legitimate Excel-DNA framework. In this blog post, we will look into other infection chains. We will discuss different stages of the XLL and Excel 4 (XLM) droppers that deliver Dridex samples. We will also briefly look at the Dridex Loader."}
{"id": "sentence_0xf843cc3a", "report_id": "report_0xdb31cca7", "report_date": "2022-05-20T00:00:00Z", "report_title": "Weaponization of Excel Add-Ins Part 2: Dridex Infection Chain Case Studies", "report_url": "https://unit42.paloaltonetworks.com/excel-add-ins-dridex-infection-chain", "chapter_id": "chapter_0x970b84aa", "chapter_title": "Executive Summary", "text": "Palo Alto Networks customers receive protections against the attacks discussed here through Cortex XDR or the WildFire cloud-delivered security subscription for the Next-Generation Firewall."}
{"id": "sentence_0xda9bcf44", "report_id": "report_0xdb31cca7", "report_date": "2022-05-20T00:00:00Z", "report_title": "Weaponization of Excel Add-Ins Part 2: Dridex Infection Chain Case Studies", "report_url": "https://unit42.paloaltonetworks.com/excel-add-ins-dridex-infection-chain", "chapter_id": "chapter_0x933ea0cc", "chapter_title": "XLM Dropper", "text": "While XLM 4.0 is not new, there has been a lot of evolution in how malware has abused it since early 2020 Threat actors have gone from using simple, non-obfuscated macro formulas to creating complex hidden variants which finally utilize native services such as rundll32 to run a payload."}
{"id": "sentence_0xda9e616", "report_id": "report_0xdb31cca7", "report_date": "2022-05-20T00:00:00Z", "report_title": "Weaponization of Excel Add-Ins Part 2: Dridex Infection Chain Case Studies", "report_url": "https://unit42.paloaltonetworks.com/excel-add-ins-dridex-infection-chain", "chapter_id": "chapter_0x933ea0cc", "chapter_title": "XLM Dropper", "text": "As the malicious usage of XLM 4.0 macros is quite new, vendors are striving hard to provide coverage in such cases."}
{"id": "sentence_0x6ff7b239", "report_id": "report_0xdb31cca7", "report_date": "2022-05-20T00:00:00Z", "report_title": "Weaponization of Excel Add-Ins Part 2: Dridex Infection Chain Case Studies", "report_url": "https://unit42.paloaltonetworks.com/excel-add-ins-dridex-infection-chain", "chapter_id": "chapter_0x933ea0cc", "chapter_title": "XLM Dropper", "text": "The XLM document in this case comprises two spreadsheets one contains formulae and the other simply contains some random data. See Figures 1-2 below."}
{"id": "sentence_0xe097719e", "report_id": "report_0xdb31cca7", "report_date": "2022-05-20T00:00:00Z", "report_title": "Weaponization of Excel Add-Ins Part 2: Dridex Infection Chain Case Studies", "report_url": "https://unit42.paloaltonetworks.com/excel-add-ins-dridex-infection-chain", "chapter_id": "chapter_0x933ea0cc", "chapter_title": "XLM Dropper", "text": "Figure 1. The red 1 in the right side of the screenshot shows the macro 4.0 responsible for dumping an HTML application file (HTA). The red 2 at the top shows the output of highlighted formulae."}
{"id": "sentence_0x56552d7f", "report_id": "report_0xdb31cca7", "report_date": "2022-05-20T00:00:00Z", "report_title": "Weaponization of Excel Add-Ins Part 2: Dridex Infection Chain Case Studies", "report_url": "https://unit42.paloaltonetworks.com/excel-add-ins-dridex-infection-chain", "chapter_id": "chapter_0x933ea0cc", "chapter_title": "XLM Dropper", "text": "Figure 2. The red box indicated by the number 1 shows an HTA script stored in ASCII values."}
{"id": "sentence_0xc51edb7c", "report_id": "report_0xdb31cca7", "report_date": "2022-05-20T00:00:00Z", "report_title": "Weaponization of Excel Add-Ins Part 2: Dridex Infection Chain Case Studies", "report_url": "https://unit42.paloaltonetworks.com/excel-add-ins-dridex-infection-chain", "chapter_id": "chapter_0x933ea0cc", "chapter_title": "XLM Dropper", "text": "It can be seen that one of the formulae in the spreadsheet shown in Figure 1 tries to run with Mshta, so we can assume it is not really an RTF. Upon further analysis, we found that indeed it is an HTA. XLM 4.0 code in Sheet1 is responsible for reading ASCII values from Sheet2 (Figure 2) and generating the HTA file that downloads Dridex from Discord."}
{"id": "sentence_0x49129303", "report_id": "report_0xdb31cca7", "report_date": "2022-05-20T00:00:00Z", "report_title": "Weaponization of Excel Add-Ins Part 2: Dridex Infection Chain Case Studies", "report_url": "https://unit42.paloaltonetworks.com/excel-add-ins-dridex-infection-chain", "chapter_id": "chapter_0x933ea0cc", "chapter_title": "XLM Dropper", "text": "Figure 3. VBScript to download Dridex from Discord."}
{"id": "sentence_0x5f06a425", "report_id": "report_0xdb31cca7", "report_date": "2022-05-20T00:00:00Z", "report_title": "Weaponization of Excel Add-Ins Part 2: Dridex Infection Chain Case Studies", "report_url": "https://unit42.paloaltonetworks.com/excel-add-ins-dridex-infection-chain", "chapter_id": "chapter_0x933ea0cc", "chapter_title": "XLM Dropper", "text": "Figure 4. Encoded Discord URL in HTA file."}
{"id": "sentence_0x498ab423", "report_id": "report_0xdb31cca7", "report_date": "2022-05-20T00:00:00Z", "report_title": "Weaponization of Excel Add-Ins Part 2: Dridex Infection Chain Case Studies", "report_url": "https://unit42.paloaltonetworks.com/excel-add-ins-dridex-infection-chain", "chapter_id": "chapter_0x933ea0cc", "chapter_title": "XLM Dropper", "text": "It is difficult to say anything about the XLS itself until it finally downloads a malicious payload. Furthermore, the HTA is being dropped as RTF. This might confuse some security products because they could analyze the HTA as an RTF file and might lose detection. Additionally, the usage of Discord URLs makes the samples more evasive. (Though the examples given here involve Discord URLs, we have also observed similar usage of OneDrive URLs. See the GitHub link in the Indicators of Compromise section for specific examples of OneDrive URLs.)"}
{"id": "sentence_0x640abce7", "report_id": "report_0xdb31cca7", "report_date": "2022-05-20T00:00:00Z", "report_title": "Weaponization of Excel Add-Ins Part 2: Dridex Infection Chain Case Studies", "report_url": "https://unit42.paloaltonetworks.com/excel-add-ins-dridex-infection-chain", "chapter_id": "chapter_0x9a56dab4", "chapter_title": "XLL Dropper", "text": "In comparison to the malicious XLL files that we discussed in Part 1 of this blog series, this dropper is rather simple. An XLL file is just a DLL, but it must be executed using Excel. The proper detonation is important for detection."}
{"id": "sentence_0x7430fafe", "report_id": "report_0xdb31cca7", "report_date": "2022-05-20T00:00:00Z", "report_title": "Weaponization of Excel Add-Ins Part 2: Dridex Infection Chain Case Studies", "report_url": "https://unit42.paloaltonetworks.com/excel-add-ins-dridex-infection-chain", "chapter_id": "chapter_0x9a56dab4", "chapter_title": "XLL Dropper", "text": "Figure 5. Discord URLs found in XLL."}
{"id": "sentence_0x8eb34164", "report_id": "report_0xdb31cca7", "report_date": "2022-05-20T00:00:00Z", "report_title": "Weaponization of Excel Add-Ins Part 2: Dridex Infection Chain Case Studies", "report_url": "https://unit42.paloaltonetworks.com/excel-add-ins-dridex-infection-chain", "chapter_id": "chapter_0x9a56dab4", "chapter_title": "XLL Dropper", "text": "Figure 6. XLL running Dridex Loader."}
{"id": "sentence_0x4536152e", "report_id": "report_0xdb31cca7", "report_date": "2022-05-20T00:00:00Z", "report_title": "Weaponization of Excel Add-Ins Part 2: Dridex Infection Chain Case Studies", "report_url": "https://unit42.paloaltonetworks.com/excel-add-ins-dridex-infection-chain", "chapter_id": "chapter_0xa860b80e", "chapter_title": "Active Directory Check", "text": "We think that both the XLL and VBScript downloaders are associated with the same actor because, as we can see, both perform a check to see whether the LOGONSERVER and USERDOMAIN environment variables are set. This would mean a system is on Active Directory."}
{"id": "sentence_0x60ef3272", "report_id": "report_0xdb31cca7", "report_date": "2022-05-20T00:00:00Z", "report_title": "Weaponization of Excel Add-Ins Part 2: Dridex Infection Chain Case Studies", "report_url": "https://unit42.paloaltonetworks.com/excel-add-ins-dridex-infection-chain", "chapter_id": "chapter_0xa860b80e", "chapter_title": "Active Directory Check", "text": "Figure 7. HTA dropper checking for the environment variables LOGONSERVER and USERDOMAIN."}
{"id": "sentence_0x80c61c18", "report_id": "report_0xdb31cca7", "report_date": "2022-05-20T00:00:00Z", "report_title": "Weaponization of Excel Add-Ins Part 2: Dridex Infection Chain Case Studies", "report_url": "https://unit42.paloaltonetworks.com/excel-add-ins-dridex-infection-chain", "chapter_id": "chapter_0xa860b80e", "chapter_title": "Active Directory Check", "text": "Figure 8. XLL dropper checking for the environment variables LOGONSERVER and USERDOMAIN."}
{"id": "sentence_0x637ab585", "report_id": "report_0xdb31cca7", "report_date": "2022-05-20T00:00:00Z", "report_title": "Weaponization of Excel Add-Ins Part 2: Dridex Infection Chain Case Studies", "report_url": "https://unit42.paloaltonetworks.com/excel-add-ins-dridex-infection-chain", "chapter_id": "chapter_0xfd4c6189", "chapter_title": "Discord URLs", "text": "We extracted around 1,400 URLs (see section at the end of this post) from XLM and XLL files, however, at the time of analysis, only a few of them were still up and were found downloading only Dridex. An interesting thing to note is that DLL files are being downloaded as MKV. We saw that at the start of the infection chain that HTA was being dropped as RTF."}
{"id": "sentence_0xcc97106f", "report_id": "report_0xdb31cca7", "report_date": "2022-05-20T00:00:00Z", "report_title": "Weaponization of Excel Add-Ins Part 2: Dridex Infection Chain Case Studies", "report_url": "https://unit42.paloaltonetworks.com/excel-add-ins-dridex-infection-chain", "chapter_id": "chapter_0xb1396687", "chapter_title": "Brief Loader Analysis", "text": "As can be seen in Figure 6, the downloaded payload is being run with the command"}
{"id": "sentence_0xab3197a7", "report_id": "report_0xdb31cca7", "report_date": "2022-05-20T00:00:00Z", "report_title": "Weaponization of Excel Add-Ins Part 2: Dridex Infection Chain Case Studies", "report_url": "https://unit42.paloaltonetworks.com/excel-add-ins-dridex-infection-chain", "chapter_id": "chapter_0xb1396687", "chapter_title": "Brief Loader Analysis", "text": "rundll32.exe * DirSyncScheduleDialog. However, as we opened the file for further analysis, the method DirSyncScheduleDialog is not found in the export directory. It is interesting to note that that function name belongs to a legitimate Windows DLL."}
{"id": "sentence_0xe2fda63d", "report_id": "report_0xdb31cca7", "report_date": "2022-05-20T00:00:00Z", "report_title": "Weaponization of Excel Add-Ins Part 2: Dridex Infection Chain Case Studies", "report_url": "https://unit42.paloaltonetworks.com/excel-add-ins-dridex-infection-chain", "chapter_id": "chapter_0xb1396687", "chapter_title": "Brief Loader Analysis", "text": "Figure 9. The missing method(left) is shown, compared to the legitimate Windows loghours.dll with exported function DirSyncScheduleDialog (right)."}
{"id": "sentence_0x1195cf10", "report_id": "report_0xdb31cca7", "report_date": "2022-05-20T00:00:00Z", "report_title": "Weaponization of Excel Add-Ins Part 2: Dridex Infection Chain Case Studies", "report_url": "https://unit42.paloaltonetworks.com/excel-add-ins-dridex-infection-chain", "chapter_id": "chapter_0xc4a1a284", "chapter_title": "Unpacking Stages", "text": "Decrypt and Load second-stage DLL from rdata section. Second DLL further unpacks the final Dridex Loader. Jumps to DirSyncScheduleDialog."}
{"id": "sentence_0x3d4d9efe", "report_id": "report_0xdb31cca7", "report_date": "2022-05-20T00:00:00Z", "report_title": "Weaponization of Excel Add-Ins Part 2: Dridex Infection Chain Case Studies", "report_url": "https://unit42.paloaltonetworks.com/excel-add-ins-dridex-infection-chain", "chapter_id": "chapter_0x4266c992", "chapter_title": "First Stage", "text": "The first stage is fairly simple in terms of functionality; its only job is to decrypt a small DLL from the rdata section and move it to allocated memory and run it."}
{"id": "sentence_0x1fde5995", "report_id": "report_0xdb31cca7", "report_date": "2022-05-20T00:00:00Z", "report_title": "Weaponization of Excel Add-Ins Part 2: Dridex Infection Chain Case Studies", "report_url": "https://unit42.paloaltonetworks.com/excel-add-ins-dridex-infection-chain", "chapter_id": "chapter_0x4266c992", "chapter_title": "First Stage", "text": "However, there are a few anti-analysis tricks."}
{"id": "sentence_0xbe26e1bc", "report_id": "report_0xdb31cca7", "report_date": "2022-05-20T00:00:00Z", "report_title": "Weaponization of Excel Add-Ins Part 2: Dridex Infection Chain Case Studies", "report_url": "https://unit42.paloaltonetworks.com/excel-add-ins-dridex-infection-chain", "chapter_id": "chapter_0x4266c992", "chapter_title": "First Stage", "text": "Usage of junk code. A Large Loop with INT3 instructions. Usage of undocumented functions such as ldrgetprocedureaddress and LdrLoadDll to avoid common hooks."}
{"id": "sentence_0x2cb37b03", "report_id": "report_0xdb31cca7", "report_date": "2022-05-20T00:00:00Z", "report_title": "Weaponization of Excel Add-Ins Part 2: Dridex Infection Chain Case Studies", "report_url": "https://unit42.paloaltonetworks.com/excel-add-ins-dridex-infection-chain", "chapter_id": "chapter_0x4266c992", "chapter_title": "First Stage", "text": "While junk code might hinder manual analysis, large loops containing INT3 breakpoints might delay the execution in some cases."}
{"id": "sentence_0x49a86a9a", "report_id": "report_0xdb31cca7", "report_date": "2022-05-20T00:00:00Z", "report_title": "Weaponization of Excel Add-Ins Part 2: Dridex Infection Chain Case Studies", "report_url": "https://unit42.paloaltonetworks.com/excel-add-ins-dridex-infection-chain", "chapter_id": "chapter_0x4266c992", "chapter_title": "First Stage", "text": "The first stage has a handful of functions. We renamed them to reflect trivial loader behavior."}
{"id": "sentence_0x4691d8cb", "report_id": "report_0xdb31cca7", "report_date": "2022-05-20T00:00:00Z", "report_title": "Weaponization of Excel Add-Ins Part 2: Dridex Infection Chain Case Studies", "report_url": "https://unit42.paloaltonetworks.com/excel-add-ins-dridex-infection-chain", "chapter_id": "chapter_0x4266c992", "chapter_title": "First Stage", "text": "Figure 10. Renamed functions (left); jump to allocated memory (center); anti-VM function, CC bytes replaced with NOP (right)."}
{"id": "sentence_0xe87fe567", "report_id": "report_0xdb31cca7", "report_date": "2022-05-20T00:00:00Z", "report_title": "Weaponization of Excel Add-Ins Part 2: Dridex Infection Chain Case Studies", "report_url": "https://unit42.paloaltonetworks.com/excel-add-ins-dridex-infection-chain", "chapter_id": "chapter_0xabac5502", "chapter_title": "Second Stage", "text": "Once the first stage passes control to the in-memory DLL (Figure 8), it further unpacks the final payload and transfers control to it. The second stage is also trivial. However, the stage does include a few interesting anti-analysis tricks to note."}
{"id": "sentence_0x48a3b819", "report_id": "report_0xdb31cca7", "report_date": "2022-05-20T00:00:00Z", "report_title": "Weaponization of Excel Add-Ins Part 2: Dridex Infection Chain Case Studies", "report_url": "https://unit42.paloaltonetworks.com/excel-add-ins-dridex-infection-chain", "chapter_id": "chapter_0xabac5502", "chapter_title": "Second Stage", "text": "Calls Disablethreadlibrarycalls to increase invisibility of final DLL. Checks LdrLoadDll for hooks."}
{"id": "sentence_0xe96fa99f", "report_id": "report_0xdb31cca7", "report_date": "2022-05-20T00:00:00Z", "report_title": "Weaponization of Excel Add-Ins Part 2: Dridex Infection Chain Case Studies", "report_url": "https://unit42.paloaltonetworks.com/excel-add-ins-dridex-infection-chain", "chapter_id": "chapter_0xabac5502", "chapter_title": "Second Stage", "text": "Figure 11. Renamed functions (left), check for LdrLoadDll hook (center), disableThreadLibraryCalls in imports (right)."}
{"id": "sentence_0x59d0dc92", "report_id": "report_0xdb31cca7", "report_date": "2022-05-20T00:00:00Z", "report_title": "Weaponization of Excel Add-Ins Part 2: Dridex Infection Chain Case Studies", "report_url": "https://unit42.paloaltonetworks.com/excel-add-ins-dridex-infection-chain", "chapter_id": "chapter_0x97a238c4", "chapter_title": "Final Dridex Loader", "text": "Finally, we are able to see a call to DirSyncScheduleDialog. It is interesting to note that Dridex Loader is not performing DLL side loading. However, the final payload is loaded as loghours.dll, a legitimate windows DLL."}
{"id": "sentence_0xe78b9266", "report_id": "report_0xdb31cca7", "report_date": "2022-05-20T00:00:00Z", "report_title": "Weaponization of Excel Add-Ins Part 2: Dridex Infection Chain Case Studies", "report_url": "https://unit42.paloaltonetworks.com/excel-add-ins-dridex-infection-chain", "chapter_id": "chapter_0x97a238c4", "chapter_title": "Final Dridex Loader", "text": "Figure 12. A side-by-side comparison of the Export table from the Dridex Loader (left) and the legitimate loghours.dll (right)."}
{"id": "sentence_0x7a8e8306", "report_id": "report_0xdb31cca7", "report_date": "2022-05-20T00:00:00Z", "report_title": "Weaponization of Excel Add-Ins Part 2: Dridex Infection Chain Case Studies", "report_url": "https://unit42.paloaltonetworks.com/excel-add-ins-dridex-infection-chain", "chapter_id": "chapter_0x97a238c4", "chapter_title": "Final Dridex Loader", "text": "Figure 13. Dridex Loader EP; anti-VM loop can be noticed in start."}
{"id": "sentence_0xe75c1578", "report_id": "report_0xdb31cca7", "report_date": "2022-05-20T00:00:00Z", "report_title": "Weaponization of Excel Add-Ins Part 2: Dridex Infection Chain Case Studies", "report_url": "https://unit42.paloaltonetworks.com/excel-add-ins-dridex-infection-chain", "chapter_id": "chapter_0xc24b10e1", "chapter_title": "Micro VM", "text": "Dridex implements a micro VM, which adds an exception handler using AddVectoredExceptionHandler to emulate the call eax instruction."}
{"id": "sentence_0xd3256802", "report_id": "report_0xdb31cca7", "report_date": "2022-05-20T00:00:00Z", "report_title": "Weaponization of Excel Add-Ins Part 2: Dridex Infection Chain Case Studies", "report_url": "https://unit42.paloaltonetworks.com/excel-add-ins-dridex-infection-chain", "chapter_id": "chapter_0xc24b10e1", "chapter_title": "Micro VM", "text": "Figure 14. Call to get_proc_address_by_hash function and CC CC bytes (call eax)."}
{"id": "sentence_0x393445be", "report_id": "report_0xdb31cca7", "report_date": "2022-05-20T00:00:00Z", "report_title": "Weaponization of Excel Add-Ins Part 2: Dridex Infection Chain Case Studies", "report_url": "https://unit42.paloaltonetworks.com/excel-add-ins-dridex-infection-chain", "chapter_id": "chapter_0xc24b10e1", "chapter_title": "Micro VM", "text": "Figure 15. Exception handler emulating call eax."}
{"id": "sentence_0xeda9d89", "report_id": "report_0xdb31cca7", "report_date": "2022-05-20T00:00:00Z", "report_title": "Weaponization of Excel Add-Ins Part 2: Dridex Infection Chain Case Studies", "report_url": "https://unit42.paloaltonetworks.com/excel-add-ins-dridex-infection-chain", "chapter_id": "chapter_0xc24b10e1", "chapter_title": "Micro VM", "text": "As can be seen in Figure 15, in the case of EXCEPTION_BREAKPOINT, the call eax instruction is being emulated. For the sandbox, this should not be a problem; however, it can hinder manual analysis. As can be seen, the exception handler only emulates one instruction. Patching these two INT3 instructions with call eax should not be a big deal. A simple IDA script to patch all CC CC instructions with FF D0 should do the trick."}
{"id": "sentence_0x9b5dbd23", "report_id": "report_0xdb31cca7", "report_date": "2022-05-20T00:00:00Z", "report_title": "Weaponization of Excel Add-Ins Part 2: Dridex Infection Chain Case Studies", "report_url": "https://unit42.paloaltonetworks.com/excel-add-ins-dridex-infection-chain", "chapter_id": "chapter_0xc24b10e1", "chapter_title": "Micro VM", "text": "Figure 16. Patched INT3 instruction with call eax."}
{"id": "sentence_0xa6ffe9d2", "report_id": "report_0xdb31cca7", "report_date": "2022-05-20T00:00:00Z", "report_title": "Weaponization of Excel Add-Ins Part 2: Dridex Infection Chain Case Studies", "report_url": "https://unit42.paloaltonetworks.com/excel-add-ins-dridex-infection-chain", "chapter_id": "chapter_0x9a81d4fe", "chapter_title": "API Hashing", "text": "API Hashing is trivial, however, we observed a few obfuscations and variations in this Dridex Loader."}
{"id": "sentence_0xb71ab086", "report_id": "report_0xdb31cca7", "report_date": "2022-05-20T00:00:00Z", "report_title": "Weaponization of Excel Add-Ins Part 2: Dridex Infection Chain Case Studies", "report_url": "https://unit42.paloaltonetworks.com/excel-add-ins-dridex-infection-chain", "chapter_id": "chapter_0x9a81d4fe", "chapter_title": "API Hashing", "text": "Multiple hashing functions. Masqueraded Prolog for hashing function."}
{"id": "sentence_0xc951b235", "report_id": "report_0xdb31cca7", "report_date": "2022-05-20T00:00:00Z", "report_title": "Weaponization of Excel Add-Ins Part 2: Dridex Infection Chain Case Studies", "report_url": "https://unit42.paloaltonetworks.com/excel-add-ins-dridex-infection-chain", "chapter_id": "chapter_0x9a81d4fe", "chapter_title": "API Hashing", "text": "We observed that, in order to hinder analysis further, this Dridex Loader is using multiple hashing functions. We observed at least two hashing functions and one masqueraded Prolog function, as can be seen below."}
{"id": "sentence_0x3a8742f7", "report_id": "report_0xdb31cca7", "report_date": "2022-05-20T00:00:00Z", "report_title": "Weaponization of Excel Add-Ins Part 2: Dridex Infection Chain Case Studies", "report_url": "https://unit42.paloaltonetworks.com/excel-add-ins-dridex-infection-chain", "chapter_id": "chapter_0x9a81d4fe", "chapter_title": "API Hashing", "text": "Figure 17. API hashing function sub_744102D4"}
{"id": "sentence_0xd28dce69", "report_id": "report_0xdb31cca7", "report_date": "2022-05-20T00:00:00Z", "report_title": "Weaponization of Excel Add-Ins Part 2: Dridex Infection Chain Case Studies", "report_url": "https://unit42.paloaltonetworks.com/excel-add-ins-dridex-infection-chain", "chapter_id": "chapter_0x9a81d4fe", "chapter_title": "API Hashing", "text": "Figure 18. Masqueraded Prolog function."}
{"id": "sentence_0xbefe8613", "report_id": "report_0xdb31cca7", "report_date": "2022-05-20T00:00:00Z", "report_title": "Weaponization of Excel Add-Ins Part 2: Dridex Infection Chain Case Studies", "report_url": "https://unit42.paloaltonetworks.com/excel-add-ins-dridex-infection-chain", "chapter_id": "chapter_0x9a81d4fe", "chapter_title": "API Hashing", "text": "It can be seen that the Prolog of the get_proc_address_1 function is not normal. The registers eax and edx are being used to pass module hash and API hash to the get_proc_address_1_mas function. It is possible to call get_proc_address_1 to set eax and edx. Alternatively, they can be set before calling get_proc_address_1_mas. If a researcher is writing an automation for resolving APIs such as using AppCall it is important to watch out for this trick."}
{"id": "sentence_0xe3a4e4a", "report_id": "report_0xdb31cca7", "report_date": "2022-05-20T00:00:00Z", "report_title": "Weaponization of Excel Add-Ins Part 2: Dridex Infection Chain Case Studies", "report_url": "https://unit42.paloaltonetworks.com/excel-add-ins-dridex-infection-chain", "chapter_id": "chapter_0x9a81d4fe", "chapter_title": "API Hashing", "text": "We used the IDA AppCall feature to extract all APIs used in the loader. Based on extracted APIs, this Dridex Loader is not different from the Dridex Loader that was observed in early 2021."}
{"id": "sentence_0x43c2b76b", "report_id": "report_0xdb31cca7", "report_date": "2022-05-20T00:00:00Z", "report_title": "Weaponization of Excel Add-Ins Part 2: Dridex Infection Chain Case Studies", "report_url": "https://unit42.paloaltonetworks.com/excel-add-ins-dridex-infection-chain", "chapter_id": "chapter_0x9a81d4fe", "chapter_title": "API Hashing", "text": "Key functions of the Dridex Loader:"}
{"id": "sentence_0x24d9f3a8", "report_id": "report_0xdb31cca7", "report_date": "2022-05-20T00:00:00Z", "report_title": "Weaponization of Excel Add-Ins Part 2: Dridex Infection Chain Case Studies", "report_url": "https://unit42.paloaltonetworks.com/excel-add-ins-dridex-infection-chain", "chapter_id": "chapter_0x9a81d4fe", "chapter_title": "API Hashing", "text": "Check process privileges. AdjustToken privileges. GetSystemInfo Uses the Atomic Bombing injection technique to load core payload downloaded from command and control server."}
{"id": "sentence_0x67b33505", "report_id": "report_0xdb31cca7", "report_date": "2022-05-20T00:00:00Z", "report_title": "Weaponization of Excel Add-Ins Part 2: Dridex Infection Chain Case Studies", "report_url": "https://unit42.paloaltonetworks.com/excel-add-ins-dridex-infection-chain", "chapter_id": "chapter_0x9a81d4fe", "chapter_title": "API Hashing", "text": "The Dridex Loader has been extensively analyzed. Here, we focused mainly on small tricks used across the infection chain to avoid detection and slow down analysis."}
{"id": "sentence_0x67410645", "report_id": "report_0xdb31cca7", "report_date": "2022-05-20T00:00:00Z", "report_title": "Weaponization of Excel Add-Ins Part 2: Dridex Infection Chain Case Studies", "report_url": "https://unit42.paloaltonetworks.com/excel-add-ins-dridex-infection-chain", "chapter_id": "chapter_0x3ac244d6", "chapter_title": "Conclusion", "text": "We observed a continued evolution of the infection chain. We saw how malware authors can evade detection engines using legitimate services such as Discord and OneDrive. We analyzed how malware authors continue to add more stages in the infection chain."}
{"id": "sentence_0x31b464d8", "report_id": "report_0xdb31cca7", "report_date": "2022-05-20T00:00:00Z", "report_title": "Weaponization of Excel Add-Ins Part 2: Dridex Infection Chain Case Studies", "report_url": "https://unit42.paloaltonetworks.com/excel-add-ins-dridex-infection-chain", "chapter_id": "chapter_0x3ac244d6", "chapter_title": "Conclusion", "text": "Lastly, we briefly looked into the Dridex payload. Although the final payload was similar to the previous Dridex version in terms of behaviour, we noticed an additional unpacking stage and a couple of new changes in the API hashing function. These simple yet powerful tricks that can be challenging for malware analysts, helping the malware avoid detection and slow down analysis."}
{"id": "sentence_0x6b789918", "report_id": "report_0xdb31cca7", "report_date": "2022-05-20T00:00:00Z", "report_title": "Weaponization of Excel Add-Ins Part 2: Dridex Infection Chain Case Studies", "report_url": "https://unit42.paloaltonetworks.com/excel-add-ins-dridex-infection-chain", "chapter_id": "chapter_0x3ac244d6", "chapter_title": "Conclusion", "text": "Palo Alto Networks customers receive protections against the attacks discussed here through Cortex XDR or the WildFire cloud-delivered security subscription for the Next-Generation Firewall."}
{"id": "sentence_0x471e63c5", "report_id": "report_0xdb31cca7", "report_date": "2022-05-20T00:00:00Z", "report_title": "Weaponization of Excel Add-Ins Part 2: Dridex Infection Chain Case Studies", "report_url": "https://unit42.paloaltonetworks.com/excel-add-ins-dridex-infection-chain", "chapter_id": "chapter_0x3ac244d6", "chapter_title": "Conclusion", "text": "If you think you may have been compromised or have an urgent matter, get in touch with the Unit 42 Incident Response team or call:"}
{"id": "sentence_0x9ad7e210", "report_id": "report_0xdb31cca7", "report_date": "2022-05-20T00:00:00Z", "report_title": "Weaponization of Excel Add-Ins Part 2: Dridex Infection Chain Case Studies", "report_url": "https://unit42.paloaltonetworks.com/excel-add-ins-dridex-infection-chain", "chapter_id": "chapter_0x3ac244d6", "chapter_title": "Conclusion", "text": "North America Toll-Free: 866.486.4842 (866.4.UNIT42) EMEA: +31.20.299.3130 APAC: +65.6983.8730 Japan: +81.50.1790.0200"}
{"id": "sentence_0xb9277fe8", "report_id": "report_0xdb31cca7", "report_date": "2022-05-20T00:00:00Z", "report_title": "Weaponization of Excel Add-Ins Part 2: Dridex Infection Chain Case Studies", "report_url": "https://unit42.paloaltonetworks.com/excel-add-ins-dridex-infection-chain", "chapter_id": "chapter_0xf15a71e7", "chapter_title": "Indicators of Compromise", "text": "Indicators of compromise related to the malware discussed here can be found on GitHub."}
{"id": "sentence_0x55814aa7", "report_id": "report_0xdb31cca7", "report_date": "2022-05-20T00:00:00Z", "report_title": "Weaponization of Excel Add-Ins Part 2: Dridex Infection Chain Case Studies", "report_url": "https://unit42.paloaltonetworks.com/excel-add-ins-dridex-infection-chain", "chapter_id": "chapter_0xd6bd1cdc", "chapter_title": "Get updates from Palo Alto Networks!", "text": "Sign up to receive the latest news, cyber threat intelligence and research from us"}
{"id": "sentence_0x6394da8f", "report_id": "report_0xdb31cca7", "report_date": "2022-05-20T00:00:00Z", "report_title": "Weaponization of Excel Add-Ins Part 2: Dridex Infection Chain Case Studies", "report_url": "https://unit42.paloaltonetworks.com/excel-add-ins-dridex-infection-chain", "chapter_id": "chapter_0xd6bd1cdc", "chapter_title": "Get updates from Palo Alto Networks!", "text": "Please enter your email address!"}
{"id": "sentence_0x1a2dd5e4", "report_id": "report_0xdb31cca7", "report_date": "2022-05-20T00:00:00Z", "report_title": "Weaponization of Excel Add-Ins Part 2: Dridex Infection Chain Case Studies", "report_url": "https://unit42.paloaltonetworks.com/excel-add-ins-dridex-infection-chain", "chapter_id": "chapter_0xd6bd1cdc", "chapter_title": "Get updates from Palo Alto Networks!", "text": "Please mark, I'm not a robot!"}
{"id": "sentence_0xac2a02", "report_id": "report_0xdb31cca7", "report_date": "2022-05-20T00:00:00Z", "report_title": "Weaponization of Excel Add-Ins Part 2: Dridex Infection Chain Case Studies", "report_url": "https://unit42.paloaltonetworks.com/excel-add-ins-dridex-infection-chain", "chapter_id": "chapter_0xd6bd1cdc", "chapter_title": "Get updates from Palo Alto Networks!", "text": "By submitting this form, you agree to our Terms of Use and acknowledge our Privacy Statement."}
