<div>
<h1 class="article__header__title mb-sm-30 mb-40">Weaponization of Excel Add-Ins Part 2: Dridex Infection Chain Case Studies</h1>
<ul class="article__entry-meta d-flex flex-wrap align-items-center text-black">
<li class="mr-10 mb-10 px-20 rounded-pill d-flex bg-gray-200">
1,315
 people reacted</li>
<li class="d-sm-none col-12 p-0">
</li><li class="mr-10 mb-10 px-20 rounded-pill bg-gray-200">0</li>
<li class="mb-10 px-20 rounded-pill bg-gray-200"> 8 min. read</li>
</ul>
<a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Funit42.paloaltonetworks.com%2Fexcel-add-ins-dridex-infection-chain%2F" target="_blank"></a>
<a href="https://twitter.com/home?status=https%3A%2F%2Funit42.paloaltonetworks.com%2Fexcel-add-ins-dridex-infection-chain%2F+-+Weaponization+of+Excel+Add-Ins+Part+2%3A+Dridex+Infection+Chain+Case+Studies" target="_blank"></a>
<a href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3A%2F%2Funit42.paloaltonetworks.com%2Fexcel-add-ins-dridex-infection-chain%2F&amp;title=Weaponization+of+Excel+Add-Ins+Part+2%3A+Dridex+Infection+Chain+Case+Studies&amp;summary=&amp;source=" target="_blank"></a>
<a href="https://unit42.paloaltonetworks.com//www.reddit.com/submit?url=https://unit42.paloaltonetworks.com/excel-add-ins-dridex-infection-chain/" target="_blank"></a>
<p>
 By <a class="author url fn" href="https://unit42.paloaltonetworks.com/author/saqib-khanzada/" rel="author" title="Posts by Saqib Khanzada">Saqib Khanzada</a> </p>
<p>May 19, 2022 at 12:00 PM</p>
<p>Category: <a href="https://unit42.paloaltonetworks.com/category/malware-2/" rel="category tag">Malware</a></p>
<p>Tags: <a href="https://unit42.paloaltonetworks.com/tag/agenttesla/" rel="tag">AgentTesla</a>, <a href="https://unit42.paloaltonetworks.com/tag/dridex/" rel="tag">Dridex</a>, <a href="https://unit42.paloaltonetworks.com/tag/macros/" rel="tag">Macros</a>, <a href="https://unit42.paloaltonetworks.com/tag/microsoft-excel/" rel="tag">Microsoft Excel</a>, <a href="https://unit42.paloaltonetworks.com/tag/next-generation-firewall/" rel="tag">next-generation firewall</a>, <a href="https://unit42.paloaltonetworks.com/tag/wildfire/" rel="tag">WildFire</a></p>
<h2><a id="post-123093-_pfiygz2c3pbs"></a>Executive Summary</h2>
<p>In <a href="https://unit42.paloaltonetworks.com/excel-add-ins-malicious-xll-files-agent-tesla/">Part 1</a> of this two-part blog series, we discussed briefly how XLL files are exploited to deploy Agent Tesla. During December 2021, we continued to observe Dridex and Agent Tesla exploiting XLL in different ways for initial payload delivery. A more in-depth look at the Dridex infection chain follows.</p>
<p>Threat actors behind Dridex have been using various delivery mechanisms over the years. In early 2017, we observed plain VBScript and JavaScript were being used. In later years, we observed many variations, including Microsoft Office files (DOC, XLS) compressed in zip. In 2020, we found the malware using Discord and other legitimate services to download the final payload. More recently, during December 2021, we received various Dridex samples, which were exploiting XLL and XLM 4.0 in combination with Discord and OneDrive to download the final payload.</p>
<p>In our previous blog focused on <a href="https://unit42.paloaltonetworks.com/excel-add-ins-malicious-xll-files-agent-tesla/">XLL files and Agent Tesla</a>, we saw the abuse of the legitimate Excel-DNA framework. In this blog post, we will look into other infection chains. We will discuss different stages of the XLL and Excel 4 (XLM) droppers that deliver Dridex samples. We will also briefly look at the Dridex Loader.</p>
<figure class="mb-30 text-center">
<img alt="A conceptual image representing targeted attacks, including the XLL Files and Dridex infection chain discussed here." class="attachment-single size-single" height="300" src="https://unit42.paloaltonetworks.com/wp-content/uploads/2022/05/Unit42-blog-2by1-characters-r4d1-2020_Targeted-Attacks-v1.png" width="600"/> </figure><p>Palo Alto Networks customers receive protections against the attacks discussed here through <a href="https://www.paloaltonetworks.com/cortex/cortex-xdr">Cortex XDR</a> or the <a href="https://www.paloaltonetworks.com/products/secure-the-network/wildfire">WildFire</a> cloud-delivered security subscription for the <a href="https://www.paloaltonetworks.com/network-security/next-generation-firewall">Next-Generation Firewall</a>.</p>
<table>
<tbody>
<tr>
<td>Types of Attacks Covered</td>
<td><a href="https://unit42.paloaltonetworks.com/category/malware-2/">Malware</a>, <a href="https://unit42.paloaltonetworks.com/tag/dridex/">Dridex</a></td>
</tr>
<tr>
<td>Related Unit 42 Topics</td>
<td><a href="https://unit42.paloaltonetworks.com/tag/agenttesla/">Agent Tesla</a>, <a href="https://unit42.paloaltonetworks.com/tag/macros/">Macros</a></td>
</tr>
</tbody>
</table>
<h2><a id="post-123093-_sewraqo9vlxk"></a>Table of Contents</h2>
<p><a href="#XLM-Dropper">XLM Dropper</a>
<a href="#XLL-Dropper">XLL Dropper</a>
<a href="#Active-Directory-Check">Active Directory Check</a>
<a href="#Discord-URLs">Discord URLs</a>
<a href="#Brief-Loader-Analysis">Brief Loader Analysis</a>
<a href="#Unpacking-Stages">Unpacking Stages</a>
<a href="#First-Stage">First Stage</a>
<a href="#Second-Stage">Second Stage</a>
<a href="#Final-Dridex-Loader">Final Dridex Loader</a>
<a href="#Micro-VM">Micro VM</a>
<a href="#API-Hashing">API Hashing</a>
<a href="#Conclusion">Conclusion</a>
<a href="#Indicators-of-Compromise">Indicators of Compromise</a></p>
<h2><a id="XLM-Dropper"></a>XLM Dropper</h2>
<p>While XLM 4.0 is not new, there has been a lot of evolution in how malware has abused it since early 2020 Threat actors have gone from using simple, non-obfuscated macro formulas to creating complex hidden variants which finally utilize native services such as rundll32 to run a payload.</p>
<p>As the malicious usage of XLM 4.0 macros is quite new, vendors are striving hard to provide coverage in such cases.</p>
<p>The XLM document in this case comprises two spreadsheets – one contains formulae and the other simply contains some random data. See Figures 1-2 below.</p>
<figure class="wp-caption aligncenter" id="attachment_123096"><img alt="The XLM document comprises two spreadsheet. The one shown here contains formulae. The red 1 indicates the macro 4.0 responsible for dumping an HTML application file. The red 2 at the top of the screenshot shows the output of the highlighted formulae. " class="wp-image-123096" height="525" src="https://unit42.paloaltonetworks.com/wp-content/uploads/2022/05/word-image-37.png" style="max-width:800px;height:auto;width:auto;" width="900"/><figcaption class="wp-caption-text" id="caption-attachment-123096">Figure 1. The red “1” in the right side of the screenshot shows the macro 4.0 responsible for dumping an HTML application file (HTA). The red “2” at the top shows the output of highlighted formulae.</figcaption></figure>
<figure class="wp-caption aligncenter" id="attachment_123098"><img alt="The red box indicated by the number 1 shows an HTA script stored in ASCII values. " class="wp-image-123098" height="482" src="https://unit42.paloaltonetworks.com/wp-content/uploads/2022/05/word-image-38.png" style="max-width:800px;height:auto;width:auto;" width="900"/><figcaption class="wp-caption-text" id="caption-attachment-123098">Figure 2. The red box indicated by the number 1 shows an HTA script stored in ASCII values.</figcaption></figure>
<p>It can be seen that one of the formulae in the spreadsheet shown in Figure 1 tries to run with Mshta, so we can assume it is not really an RTF. Upon further analysis, we found that indeed it is an HTA. XLM 4.0 code in Sheet1 is responsible for reading ASCII values from Sheet2 (Figure 2) and generating the HTA file that downloads Dridex from Discord.</p>
<figure class="wp-caption aligncenter" id="attachment_123100"><img alt="VBScript to download Dridex from Discord." class="wp-image-123100" height="298" src="https://unit42.paloaltonetworks.com/wp-content/uploads/2022/05/word-image-39.png" style="max-width:800px;height:auto;width:auto;" width="900"/><figcaption class="wp-caption-text" id="caption-attachment-123100">Figure 3. VBScript to download Dridex from Discord.</figcaption></figure>
<figure class="wp-caption aligncenter" id="attachment_123102"><img alt="Encoded Discord URL in HTA file." class="wp-image-123102" height="99" src="https://unit42.paloaltonetworks.com/wp-content/uploads/2022/05/word-image-40.png" style="max-width:800px;height:auto;width:auto;" width="900"/><figcaption class="wp-caption-text" id="caption-attachment-123102">Figure 4. Encoded Discord URL in HTA file.</figcaption></figure>
<p>It is difficult to say anything about the XLS itself until it finally downloads a malicious payload. Furthermore, the HTA is being dropped as RTF. This might confuse some security products because they could analyze the HTA as an RTF file and might lose detection. Additionally, the usage of Discord URLs makes the samples more evasive. (Though the examples given here involve Discord URLs, we have also observed similar usage of OneDrive URLs. See the GitHub link in the Indicators of Compromise section for specific examples of OneDrive URLs.)</p>
<h2><a id="XLL-Dropper"></a>XLL Dropper</h2>
<p>In comparison to the malicious XLL files that we discussed in <a href="https://unit42.paloaltonetworks.com/excel-add-ins-malicious-xll-files-agent-tesla/">Part 1</a> of this blog series, this dropper is rather simple. An XLL file is just a DLL, but it must be executed using Excel. The proper detonation is important for detection.</p>
<figure class="wp-caption aligncenter" id="attachment_123104"><img alt="We extracted around 1,400 URLs from XLM adn XLL files, though at the time of analysis, only a few were still up. " class="wp-image-123104" height="629" src="https://unit42.paloaltonetworks.com/wp-content/uploads/2022/05/word-image-41.png" style="max-width:800px;height:auto;width:auto;" width="900"/><figcaption class="wp-caption-text" id="caption-attachment-123104">Figure 5. Discord URLs found in XLL.</figcaption></figure>
<figure class="wp-caption aligncenter" id="attachment_123106"><img alt="The screenshot shows, among other things, the commands that run the downloaded payload. " class="wp-image-123106" height="395" src="https://unit42.paloaltonetworks.com/wp-content/uploads/2022/05/word-image-42.png" style="max-width:800px;height:auto;width:auto;" width="867"/><figcaption class="wp-caption-text" id="caption-attachment-123106">Figure 6. XLL running Dridex Loader.</figcaption></figure>
<h2><a id="Active-Directory-Check"></a>Active Directory Check</h2>
<p>We think that both the XLL and VBScript downloaders are associated with the same actor because, as we can see, both perform a check to see whether the LOGONSERVER and USERDOMAIN environment variables are set. This would mean a system is on Active Directory.</p>
<figure class="wp-caption aligncenter" id="attachment_123108"><img alt="HTA dropper checking for the environment variables LOGONSERVER and USERDOMAIN. " class="wp-image-123108" height="181" src="https://unit42.paloaltonetworks.com/wp-content/uploads/2022/05/word-image-43.png" style="max-width:800px;height:auto;width:auto;" width="900"/><figcaption class="wp-caption-text" id="caption-attachment-123108">Figure 7. HTA dropper checking for the environment variables LOGONSERVER and USERDOMAIN.</figcaption></figure>
<figure class="wp-caption aligncenter" id="attachment_123110"><img alt="XLL dropper checking for the environment variables LOGONSERVER and USERDOMAIN. " class="wp-image-123110" height="410" src="https://unit42.paloaltonetworks.com/wp-content/uploads/2022/05/word-image-44.png" style="max-width:800px;height:auto;width:auto;" width="900"/><figcaption class="wp-caption-text" id="caption-attachment-123110">Figure 8. XLL dropper checking for the environment variables LOGONSERVER and USERDOMAIN.</figcaption></figure>
<h2><a id="Discord-URLs"></a>Discord URLs</h2>
<p>We extracted around 1,400 URLs (see <a href="#Indicators-of-Compromise">Indicators of Compromise</a> section at the end of this post) from XLM and XLL files, however, at the time of analysis, only a few of them were still up and were found downloading only Dridex. An interesting thing to note is that DLL files are being downloaded as MKV. We saw that at the start of the infection chain that HTA was being dropped as RTF.</p>
<h2><a id="Brief-Loader-Analysis"></a>Brief Loader Analysis</h2>
<p>As can be seen in Figure 6, the downloaded payload is being run with the command</p>
<p>rundll32.exe * DirSyncScheduleDialog. However, as we opened the file for further analysis, the method DirSyncScheduleDialog is not found in the export directory. It is interesting to note that that function name belongs to a legitimate Windows DLL.</p>
<figure class="wp-caption aligncenter" id="attachment_123112"><img alt="The left side of the screenshot shots the missing method, DirSyncScheduleDialog. The right side shows the legitimate Windows loghours.dll with exported function DirSyncScheduleDialog. " class="wp-image-123112" height="353" src="https://unit42.paloaltonetworks.com/wp-content/uploads/2022/05/word-image-45.png" style="max-width:800px;height:auto;width:auto;" width="900"/><figcaption class="wp-caption-text" id="caption-attachment-123112">Figure 9. The missing method(left) is shown, compared to the legitimate Windows loghours.dll with exported function DirSyncScheduleDialog (right).</figcaption></figure>
<h3><a id="Unpacking-Stages"></a>Unpacking Stages</h3>
<ol>
<li>Decrypt and Load second-stage DLL from rdata section.</li>
<li>Second DLL further unpacks the final Dridex Loader.</li>
<li>Jumps to DirSyncScheduleDialog.</li>
</ol>
<h3><a id="First-Stage"></a>First Stage</h3>
<p>The first stage is fairly simple in terms of functionality; its only job is to decrypt a small DLL from the rdata section and move it to allocated memory and run it.</p>
<p>However, there are a few anti-analysis tricks.</p>
<ol>
<li>Usage of junk code.</li>
<li>A Large Loop with INT3 instructions.</li>
<li>Usage of undocumented functions such as ldrgetprocedureaddress and LdrLoadDll to avoid common hooks.</li>
</ol>
<p>While junk code might hinder manual analysis, large loops containing INT3 breakpoints might delay the execution in some cases.</p>
<p>The first stage has a handful of functions. We renamed them to reflect trivial loader behavior.</p>
<figure class="wp-caption aligncenter" id="attachment_123114"><img alt="enamed functions (left); jump to allocated memory (center); anti-VM function, CC bytes replaced with NOP (right)." class="wp-image-123114" height="338" src="https://unit42.paloaltonetworks.com/wp-content/uploads/2022/05/word-image-46.png" style="max-width:800px;height:auto;width:auto;" width="900"/><figcaption class="wp-caption-text" id="caption-attachment-123114">Figure 10. Renamed functions (left); jump to allocated memory (center); anti-VM function, CC bytes replaced with NOP (right).</figcaption></figure>
<h3><a id="Second-Stage"></a>Second Stage</h3>
<p>Once the first stage passes control to the in-memory DLL (Figure 8), it further unpacks the final payload and transfers control to it. The second stage is also trivial. However, the stage does include a few interesting anti-analysis tricks to note.</p>
<ol>
<li>Calls Disablethreadlibrarycalls to increase invisibility of final DLL.</li>
<li>Checks LdrLoadDll for hooks.</li>
</ol>
<figure class="wp-caption aligncenter" id="attachment_123116"><img alt="Renamed functions (left), check for LdrLoadDll hook (center), disableThreadLibraryCalls in imports (right)." class="wp-image-123116" height="367" src="https://unit42.paloaltonetworks.com/wp-content/uploads/2022/05/word-image-47.png" style="max-width:800px;height:auto;width:auto;" width="900"/><figcaption class="wp-caption-text" id="caption-attachment-123116">Figure 11. Renamed functions (left), check for LdrLoadDll hook (center), disableThreadLibraryCalls in imports (right).</figcaption></figure>
<h3><a id="Final-Dridex-Loader"></a>Final Dridex Loader</h3>
<p>Finally, we are able to see a call to DirSyncScheduleDialog. It is interesting to note that Dridex Loader is not performing DLL side loading. However, the final payload is loaded as loghours.dll, a legitimate windows DLL.</p>
<figure class="wp-caption aligncenter" id="attachment_123118"><img alt="The export table from the Dridex Loader is shown on the left, and the one from the legitimate loghours.dll is shown on the right. A red box highlights the particular line to compare side by side, showing DirSyncScheduleDialog." class="wp-image-123118" height="383" src="https://unit42.paloaltonetworks.com/wp-content/uploads/2022/05/word-image-48.png" style="max-width:800px;height:auto;width:auto;" width="900"/><figcaption class="wp-caption-text" id="caption-attachment-123118">Figure 12. A side-by-side comparison of the Export table from the Dridex Loader (left) and the legitimate loghours.dll (right).</figcaption></figure>
<figure class="wp-caption aligncenter" id="attachment_123120"><img alt="Dridex Loader EP; anti-VM loop can be noticed in start." class="wp-image-123120" height="489" src="https://unit42.paloaltonetworks.com/wp-content/uploads/2022/05/word-image-49.png" style="max-width:800px;height:auto;width:auto;" width="900"/><figcaption class="wp-caption-text" id="caption-attachment-123120">Figure 13. Dridex Loader EP; anti-VM loop can be noticed in start.</figcaption></figure>
<h3><a id="Micro-VM"></a>Micro VM</h3>
<p>Dridex implements a micro VM, which adds an exception handler using AddVectoredExceptionHandler to emulate the call eax instruction.</p>
<figure class="wp-caption aligncenter" id="attachment_123122"><img alt="Call to get_proc_address_by_hash function and CC CC bytes (call eax)." class="wp-image-123122" height="596" src="https://unit42.paloaltonetworks.com/wp-content/uploads/2022/05/word-image-50.png" style="max-width:800px;height:auto;width:auto;" width="900"/><figcaption class="wp-caption-text" id="caption-attachment-123122">Figure 14. Call to get_proc_address_by_hash function and CC CC bytes (call eax).</figcaption></figure>
<figure class="wp-caption aligncenter" id="attachment_123124"><img alt='As can be seen here, in the case of EXCEPTION_BREAKPOINT, the "call eax" instruction is being emulated. ' class="wp-image-123124" height="575" src="https://unit42.paloaltonetworks.com/wp-content/uploads/2022/05/word-image-51.png" style="max-width:800px;height:auto;width:auto;" width="900"/><figcaption class="wp-caption-text" id="caption-attachment-123124">Figure 15. Exception handler emulating call eax.</figcaption></figure>
<p>As can be seen in Figure 15, in the case of EXCEPTION_BREAKPOINT, the call eax instruction is being emulated. For the sandbox, this should not be a problem; however, it can hinder manual analysis. As can be seen, the exception handler only emulates one instruction. Patching these two INT3 instructions with call eax should not be a big deal. A simple IDA script to patch all CC CC instructions with FF D0 should do the trick.</p>
<figure class="wp-caption aligncenter" id="attachment_123126"><img alt="An IDA script to patch all CC CC instructions with FF D0 can patch the two INT3 instructions, as shown. " class="wp-image-123126" height="470" src="https://unit42.paloaltonetworks.com/wp-content/uploads/2022/05/word-image-52.png" style="max-width:800px;height:auto;width:auto;" width="900"/><figcaption class="wp-caption-text" id="caption-attachment-123126">Figure 16. Patched INT3 instruction with “call eax”.</figcaption></figure>
<h3><a id="API-Hashing"></a>API Hashing</h3>
<p>API Hashing is trivial, however, we observed a few obfuscations and variations in this Dridex Loader.</p>
<ol>
<li>Multiple hashing functions.</li>
<li>Masqueraded Prolog for hashing function.</li>
</ol>
<p>We observed that, in order to hinder analysis further, this Dridex Loader is using multiple hashing functions. We observed at least two hashing functions and one masqueraded Prolog function, as can be seen below.</p>
<figure class="wp-caption aligncenter" id="attachment_123128"><img alt="API hashing function sub_744102D4" class="wp-image-123128" height="797" src="https://unit42.paloaltonetworks.com/wp-content/uploads/2022/05/word-image-53.png" style="max-width:800px;height:auto;width:auto;" width="896"/><figcaption class="wp-caption-text" id="caption-attachment-123128">Figure 17. API hashing function sub_744102D4</figcaption></figure>
<figure class="wp-caption aligncenter" id="attachment_123130"><img alt="Masqueraded Prolog function used by Dridex Loader to hinder analysis. " class="wp-image-123130" height="425" src="https://unit42.paloaltonetworks.com/wp-content/uploads/2022/05/word-image-54.png" width="628"/><figcaption class="wp-caption-text" id="caption-attachment-123130">Figure 18. Masqueraded Prolog function.</figcaption></figure>
<p>It can be seen that the Prolog of the get_proc_address_1 function is not normal. The registers eax and edx are being used to pass module hash and API hash to the get_proc_address_1_mas function. It is possible to call get_proc_address_1 to set eax and edx. Alternatively, they can be set before calling get_proc_address_1_mas. If a researcher is writing an automation for resolving APIs – such as using AppCall – it is important to watch out for this trick.</p>
<p>We used the IDA AppCall feature to extract all APIs used in the loader. Based on extracted APIs, this Dridex Loader is not different from the Dridex Loader that was observed in early 2021.</p>
<p>Key functions of the Dridex Loader:</p>
<ol>
<li>Check process privileges.</li>
<li>AdjustToken privileges.</li>
<li>GetSystemInfo</li>
<li>Uses the “Atomic Bombing” injection technique to load core payload downloaded from command and control server.</li>
</ol>
<p>The Dridex Loader has been extensively analyzed. Here, we focused mainly on small tricks used across the infection chain to avoid detection and slow down analysis.</p>
<h2><a id="Conclusion"></a>Conclusion</h2>
<p>We observed a continued evolution of the infection chain. We saw how malware authors can evade detection engines using legitimate services such as Discord and OneDrive. We analyzed how malware authors continue to add more stages in the infection chain.</p>
<p>Lastly, we briefly looked into the Dridex payload. Although the final payload was similar to the previous Dridex version in terms of behaviour, we noticed an additional unpacking stage and a couple of new changes in the API hashing function. These simple yet powerful tricks that can be challenging for malware analysts, helping the malware avoid detection and slow down analysis.</p>
<p>Palo Alto Networks customers receive protections against the attacks discussed here through <a href="https://www.paloaltonetworks.com/cortex/cortex-xdr">Cortex XDR</a> or the <a href="https://www.paloaltonetworks.com/products/secure-the-network/wildfire">WildFire</a> cloud-delivered security subscription for the <a href="https://www.paloaltonetworks.com/network-security/next-generation-firewall">Next-Generation Firewall</a>.</p>
<p>If you think you may have been compromised or have an urgent matter, get in touch with the<a href="http://start.paloaltonetworks.com/contact-unit42.html"> Unit 42 Incident Response team</a> or call:</p>
<ul>
<li>North America Toll-Free: 866.486.4842 (866.4.UNIT42)</li>
<li>EMEA: +31.20.299.3130</li>
<li>APAC: +65.6983.8730</li>
<li>Japan: +81.50.1790.0200</li>
</ul>
<h3><a id="Indicators-of-Compromise"></a>Indicators of Compromise</h3>
<p>Indicators of compromise related to the malware discussed here can be found on <a href="https://github.com/pan-unit42/iocs/blob/master/Dridex%20Infection%20Chain%20Case%20Studies">GitHub</a>.</p>
<h4 class="h3 mb-10 text-black">Get updates from <br class="d-sm-none"/> Palo Alto<br class="d-sm-none"/> Networks!</h4>
<p>Sign up to receive the latest news, cyber threat intelligence and research from us</p>
<p>Please enter your email address!</p>
<p>Please mark, I'm not a robot!</p>
<p>By submitting this form, you agree to our <a href="https://www.paloaltonetworks.com/legal-notices/terms-of-use">Terms of Use</a> and acknowledge our <a href="https://www.paloaltonetworks.com/legal-notices/privacy">Privacy Statement</a>.</p>
</div>