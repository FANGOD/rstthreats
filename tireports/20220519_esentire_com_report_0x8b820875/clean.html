<div>
<p>Mars Stealer is an information-stealing malware that first appeared on hacking forums in June 2021, a year after its predecessor Oski Stealer was discontinued in June 2020. Mars Stealer can target or ‘support’ over 50 crypto wallets and extensions, is multi-functional, and avoids detection. In addition, it’s low price on the malware market has generated significant attention from threat actor(s) who are looking to add the effective malware into their arsenal.</p>
<p>eSentire's Threat Response Unit (TRU) team previously <a href="https://www.esentire.com/blog/fake-chrome-setup-leads-to-netsupportmanager-rat-and-mars-stealer">published a TRU Positive</a> that focused on the cyber threat investigation summary of a singular incident and recommendations regarding Mars Stealer malware. However, this blogpost delves deeper into the technical details that were gathered during the research and analysis of the <a href="https://www.esentire.com/blog/fake-chrome-setup-leads-to-netsupportmanager-rat-and-mars-stealer">Mars Stealer TRU Positive</a>.</p>
<h2>Key Takeaways:</h2>
<ul><li>Mars Stealer is the latest version of Oski Stealer, which was discontinued in June 2020.</li><li>NetSupport RAT (Remote Access Tool), or client32.exe, was embedded in a ChromeSetup.exe file and used by an attacker to gain access to a victim’s workstation for further deployment of tools needed to plant Mars Stealer.</li><li>An executable with the original filename 3uAirPlayer was used to deploy obfuscated AutoIt scripts with Mars Stealer embedded inside and a renamed version of AutoIt to evade detections.</li><li>The persistence mechanism was created to make sure the attacker(s) maintain access to NetSupportManager as a backdoor.</li><li>Mars Stealer can self-delete itself after successfully exfiltrating the victim’s data, leaving no trace behind.</li></ul>
<h2>Case Study</h2>
<p>The first mention of Mars Stealer appeared on Russian-speaking forums in June 2021 and at the time, it was being sold for $140 a month (Exhibit 1).</p>
<figure><img src="https://s3.ca-central-1.amazonaws.com/esentire-dot-com-assets/assetsV3/Blog/Blog-Images/MarsStealer_Picture1.png" style="max-width:80%;height:auto;width:auto;"/><figcaption>Exhibit 1: Advertisement on Mars Stealer</figcaption></figure>
<p>
</p>
<p>Mars Stealer allegedly ‘supports’, or is capable of, harvesting data from common browsers, crypto wallets, and two-factor authentication (2FA) and crypto extensions. Since the release of Mars Stealer, eSentire’s Threat Response Unit (TRU) team has observed a number of cracked versions being distributed by a reverse engineer who goes under the username ‘LLCPPC’. The latest version is Mars Stealer v8 (Exhibit 2).</p>
<figure><img src="https://s3.ca-central-1.amazonaws.com/esentire-dot-com-assets/assetsV3/Blog/Blog-Images/MarsStealer_Picture2.png" style="max-width:80%;height:auto;width:auto;"/><figcaption>Exhibit 2: Mars Stealer v8 advertisement</figcaption></figure>
<p>
</p>
<p>Mars Stealer has been delivered as a <a href="https://blog.morphisec.com/threat-research-mars-stealer">drive-by download</a> via cloned websites for known software, such as Open Office. The malware is also <a href="https://cyberint.com/blog/research/mars-stealer/">distributed</a>
as patching software and keygens on gaming forums. In the incident observed by eSentire, the stealer was delivered via the NetSupportManager RAT. </p>
<h2>Technical Analysis of Mars Stealer Infection</h2>
<h3>Initial Access</h3>
<p>The initial access vector occurred when the victim visited a malicious website hosting an ISO image named ChromeSetup.iso (hxxps[:]//googleglstatupdt[.]com/LEND/ChromeSetup[.]iso).</p>
<p>The ISO image contained ChromeSetup.exe, which had an embedded NetSupportManager RAT and a Chrome Updater in a cabinet (CAB) archive-file format (Exhibits 3-4).</p>
<figure><img src="https://s3.ca-central-1.amazonaws.com/esentire-dot-com-assets/assetsV3/Blog/Blog-Images/MarsStealer_Picture3.png" style="max-width:80%;height:auto;width:auto;"/><figcaption>Exhibit 3: Cabinet section under RCData</figcaption></figure>
<p>
</p>
<figure><img src="https://s3.ca-central-1.amazonaws.com/esentire-dot-com-assets/assetsV3/Blog/Blog-Images/MarsStealer_Picture4.png" style="max-width:80%;height:auto;width:auto;"/><figcaption>Exhibit 4: Contents of the extracted CAB file</figcaption></figure>
<p>
</p>
<p>The NetSupportManager RAT was obfuscated by the attacker as ‘21m_18_033.exe’. The RAT was installed in tandem when the victim opened ChromeSetup.exe. Persistence was achieved by the RAT via a Startup LNK file through the following path: </p>
<ul><li>c:\users\*\appdata\roaming\microsoft\windows\start menu\programs\startup\autorunings.ini.lnk</li></ul>
<p>The LNK runs the RAT under C:\Users\*\AppData\Roaming\WinSupports\client32.exe after each reboot attempt.</p>
<p>It is worth noting that attacks involving RATs do not usually start with the full infection chain once the user executes the initial payload. The attacker would need additional time to access the RAT and load additional payloads. In the incident we analyzed, the attacker’s movement in the network can be observed in Exhibit 5.</p>
<figure><img src="https://s3.ca-central-1.amazonaws.com/esentire-dot-com-assets/assetsV3/Blog/Blog-Images/MarsStealer_Picture5.png" style="max-width:80%;height:auto;width:auto;"/><figcaption>Exhibit 5: Infection chain</figcaption></figure>
<p>
</p>
<p>aNpRAHx.exe (original name: 3uAirPlayer.exe) was used to plant the following AutoIt scripts on the victim’s workstation under the path C:\Users\*\AppData\Local\Temp\IXP001.TMP: </p>
<ul><li>una.wmd</li><li>fervore.wmd</li><li>vai.wmd</li></ul>
<p>The scripts were embedded within the CAB file of the executable (Exhibits 6-7)</p>
<figure><img src="https://s3.ca-central-1.amazonaws.com/esentire-dot-com-assets/assetsV3/Blog/Blog-Images/MarsStealer_Picture6.png" style="max-width:80%;height:auto;width:auto;"/><figcaption>Exhibit 6: Cabinet section under RCData (aNpRAHx.exe)</figcaption></figure>
<p>
</p>
<figure><img src="https://s3.ca-central-1.amazonaws.com/esentire-dot-com-assets/assetsV3/Blog/Blog-Images/MarsStealer_Picture7.png" style="max-width:80%;height:auto;width:auto;"/><figcaption>Exhibit 7: Contents of the CAB file</figcaption></figure>
<p>
</p>
<p>The AutoIt scripts were highly obfuscated. Within the aNpRAHx.exe resources, there was a POSTRUNPROGRAM section that contained the following command:</p>
<ul><li>Esitanza.exe.pif: the renamed AutoIt program</li><li>una.wmd: the script responsible for dropping Esitanza.exe</li><li>vai.wmd: the core script that contains Mars Stealer, its dependencies, and the copy of a NTDLL.DLL file</li></ul>
<figure><img src="https://s3.ca-central-1.amazonaws.com/esentire-dot-com-assets/assetsV3/Blog/Blog-Images/MarsStealer_Picture8.png" style="max-width:80%;height:auto;width:auto;"/><figcaption>Exhibit 8: Obfuscated Fervore.wmd script</figcaption></figure>
<p>
</p>
<p>The post command execution was also responsible for running the following commands on the host:</p>
<ul><li>find /I /N "bullguardcore.exe"</li><li>find /I /N "psuaservice.exe”</li><li>findstr /V /R "^UzERaIroWGYHeuAyIPBJMSUyDIptkdLqzqzZHgBHJNQEeOwczSBTavTwnmhKnZWGVYgwNAnxhUZYefrOGNKzOSHWiaAoqRoKRlJtmqISxiFnvUZpcnrKgDSedaU$" Una.wmd </li><li>tasklist /FI "imagename eq BullGuardCore.exe”</li><li>tasklist /FI "imagename eq PSUAService.exe" </li></ul>
<p>As indicated above, vai.wmd is the script responsible for loading additional dependencies as well as Mars Stealer. The value $ARZURr holds the obfuscated Mars Stealer version (Exhibit 9). The RC4 key was derived from the following pattern:</p>
<ul><li>Binary(MRPvnDnroX("58}59}59}63}61}63}60}60}58}59}62}63}57}57}58}64}56}63}57}63}57}63}57}61}60}57}60",7)))))</li></ul>
<p>The pattern subtracts 7 from each character that is eventually converted to ASCII format. The RC4 key to decrypt the Mars Stealer is “344868553478223918282826525”. </p>
<figure><img src="https://s3.ca-central-1.amazonaws.com/esentire-dot-com-assets/assetsV3/Blog/Blog-Images/MarsStealer_Picture9.png" style="max-width:80%;height:auto;width:auto;"/><figcaption>Exhibit 9: The hex values of the obfuscated Mars Stealer</figcaption></figure>
<p>
</p>
<p>After decrypting the binary (Exhibit 10), there appeared to be another layer of obfuscation added to the file that was decrypted during runtime.</p>
<figure><img src="https://s3.ca-central-1.amazonaws.com/esentire-dot-com-assets/assetsV3/Blog/Blog-Images/MarsStealer_Picture10.png" style="max-width:80%;height:auto;width:auto;"/><figcaption>Exhibit 10: Decrypting the binary using CyberChef</figcaption></figure>
<p>
</p>
<p>Without having to fully deobfuscate the AutoIt script, we converted the script into an executable and proceeded with debugging (Exhibit 11). We were able to extract the deobfuscated Mars Stealer executable by leveraging the debugger. It should be noted that Mars Stealer is loading its own copy of NTDLL.DLL and renames it (Exhibit 12). NTDLL.DLL is responsible for injecting Mars Stealer into explorer.exe module during the runtime (Exhibit 13-14). A similar technique was observed in Oasis Stealer and thoroughly <a href="https://blog.malwarebytes.com/threat-analysis/2018/08/process-doppelganging-meets-process-hollowing_osiris/">described</a>
by a Malware Analyst, hasherezade. </p>
<p>Endpoint Detection and Response (EDR) uses <a href="https://www.ired.team/offensive-security/defense-evasion/bypassing-cylance-and-other-avs-edrs-by-unhooking-windows-apis">API hooking</a> to monitor suspicious processes in real time. It is a common practice for EDR solutions to hook the functions exported from NTDLL.DLL. The library does not rely on other DLL (Dynamic Link Library) dependencies. In addition, it is also responsible for exporting <a href="https://en.wikipedia.org/wiki/Native_API">Native APIs</a> that are often abused by malware developers. Moreover, in order to bypass the detection by EDR tools, attacker(s) will independently load a copy of NTDLL.DLL (Exhibit 15).</p>
<figure><img src="https://s3.ca-central-1.amazonaws.com/esentire-dot-com-assets/assetsV3/Blog/Blog-Images/MarsStealer_Picture11.png" style="max-width:80%;height:auto;width:auto;"/><figcaption>Exhibit 11: Credential stealing evidence from the debugger</figcaption></figure>
<p>
</p>
<figure><img src="https://s3.ca-central-1.amazonaws.com/esentire-dot-com-assets/assetsV3/Blog/Blog-Images/MarsStealer_Picture12.png" style="max-width:80%;height:auto;width:auto;"/><figcaption>Exhibit 12: Renamed copy of NTDLL.DLL (partially deobfuscated AutoIt script)</figcaption></figure>
<p>
</p>
<figure><img src="https://s3.ca-central-1.amazonaws.com/esentire-dot-com-assets/assetsV3/Blog/Blog-Images/MarsStealer_Picture13.png" style="max-width:80%;height:auto;width:auto;"/><figcaption>Exhibit 13: Mars Stealer is being injected into explorer.exe (1)</figcaption></figure>
<p>
</p>
<figure><img src="https://s3.ca-central-1.amazonaws.com/esentire-dot-com-assets/assetsV3/Blog/Blog-Images/MarsStealer_Picture14.png" style="max-width:80%;height:auto;width:auto;"/><figcaption>Exhibit 14: Mars Stealer is being injected into explorer.exe (2)</figcaption></figure>
<p>
</p>
<figure><img src="https://s3.ca-central-1.amazonaws.com/esentire-dot-com-assets/assetsV3/Blog/Blog-Images/MarsStealer_Picture15.png" style="max-width:80%;height:auto;width:auto;"/><figcaption>Exhibit 15: Custom loaded NTDLL.DLL</figcaption></figure>
<p>
</p>
<p>It is also worth noting that another executable was dropped via the remote session on the victim’s machine – consoleappmrss.exe. The executable contained an embedded file named Installer_ovl.exe, which was written in C#. </p>
<p>The executable connected to the shortened URL (tiny[.]one), a Discord CDN to retrieve another file named DebugViewPortable_4_90_Release_3_English_online_Auejpzlt.bmp (Exhibit 16).</p>
<figure><img src="https://s3.ca-central-1.amazonaws.com/esentire-dot-com-assets/assetsV3/Blog/Blog-Images/MarsStealer_Picture16.png" style="max-width:80%;height:auto;width:auto;"/><figcaption>Exhibit 16: The file reaches out to Discord CDN to download additional payloads</figcaption></figure>
<p>
</p>
<p>At the time of the analysis, the link to the BMP file was not accessible. We believe that the attacker(s) tried to retrieve additional payloads, but the attempt was unsuccessful.</p>
<h3>Mars Stealer and C2 Panel Analysis</h3>
<p>The deobfuscated Mars Stealer was written in ASM/C and approximately 162KB in size. The compilation date was March 29, 2022, which suggests that the attacker(s) modified the stealer right before shipping it onto the victim’s machine.</p>
<p>The stealer includes anti-debugging and anti-sandbox features:</p>
<ul><li>For anti-debugging purposes, it manually checks the <a href="https://docs.microsoft.com/en-us/windows/win32/api/winternl/ns-winternl-peb">PEB (Process Environment Block)</a> for BeingDebugged flag. </li><li>For anti-sandboxing, the stealer sleeps for 16000 milliseconds (about 16 seconds) and calls <a href="https://docs.microsoft.com/en-us/windows/win32/api/sysinfoapi/nf-sysinfoapi-gettickcount">GetTickCount</a>
API (Exhibit 17) to retrieve the number of milliseconds that have passed since the system was started and the number of milliseconds of the current running time. <ul><li>Both values get subtracted and are compared to 12000 milliseconds (about 12 seconds). </li><li>If the value is less than 12000, it means that the Sleep function was skipped by the debugger or sandbox, and the sample exits (Exhibit 18). </li></ul></li></ul>
<p>The sample also performs anti-emulation checks for Windows Defender Antivirus on values HAL9TH and JohnDoe (Exhibit 19). </p>
<figure><img src="https://s3.ca-central-1.amazonaws.com/esentire-dot-com-assets/assetsV3/Blog/Blog-Images/MarsStealer_Picture17.png" style="max-width:80%;height:auto;width:auto;"/><figcaption>Exhibit 17: Using GetTickCount() for anti-debugging purposes</figcaption></figure>
<p>
</p>
<figure><img src="https://s3.ca-central-1.amazonaws.com/esentire-dot-com-assets/assetsV3/Blog/Blog-Images/MarsStealer_Picture18.png" style="max-width:80%;height:auto;width:auto;"/><figcaption>Exhibit 18: If the sample is being debugged, the running process terminates</figcaption></figure>
<p>
</p>
<figure><img src="https://s3.ca-central-1.amazonaws.com/esentire-dot-com-assets/assetsV3/Blog/Blog-Images/MarsStealer_Picture19.png" style="max-width:80%;height:auto;width:auto;"/><figcaption>Exhibit 19: Windows Defender Antivirus anti-emulation checks</figcaption></figure>
<p>
</p>
<p>Mars Stealer will exit if the following languages are detected (Exhibit 20):</p>
<ul><li>Uzbekistan</li><li>Azerbaijan</li><li>Kazakhstan </li><li>Russia</li><li>Belarus</li></ul>
<figure><img src="https://s3.ca-central-1.amazonaws.com/esentire-dot-com-assets/assetsV3/Blog/Blog-Images/MarsStealer_Picture20.png" style="max-width:80%;height:auto;width:auto;"/><figcaption>Exhibit 20: Language check using GetUserDefaultUILanguage function</figcaption></figure>
<p>
</p>
<p>The language checks are also performed within the Mars Stealer panel (Exhibit 21).</p>
<figure><img src="https://s3.ca-central-1.amazonaws.com/esentire-dot-com-assets/assetsV3/Blog/Blog-Images/MarsStealer_Picture21.png" style="max-width:80%;height:auto;width:auto;"/><figcaption>Exhibit 21: Language check in PHP component</figcaption></figure>
<p>
</p>
<p>The strings in .RDATA section are XOR’ed (XOR or "exclusive or" is a logical operator that yields true if exactly one (not both) of two conditions is true) with different keys as shown in Exhibit 22. The first batch of decrypted strings are mostly API calls (Exhibit 23).
</p>
<figure><img src="https://s3.ca-central-1.amazonaws.com/esentire-dot-com-assets/assetsV3/Blog/Blog-Images/MarsStealer_Picture22.png" style="max-width:80%;height:auto;width:auto;"/><figcaption>Exhibit 22: XOR-encoding routine</figcaption></figure>
<p>
</p>
<figure><img src="https://s3.ca-central-1.amazonaws.com/esentire-dot-com-assets/assetsV3/Blog/Blog-Images/MarsStealer_Picture23.png" style="max-width:80%;height:auto;width:auto;"/><figcaption>Exhibit 23: Decrypted strings (1)</figcaption></figure>
<p>
</p>
<p>From another batch of decrypted strings, we can observe the following (Exhibit 24):</p>
<ol><li>C2 channel</li><li>Mutex value</li><li>C2 channel (same as #1)</li><li>DLL dependencies required for the stealer to function properly</li><li>The stealer fingerprints the following information on the infected machine and outputs it to system.txt file:<ul><li>Tag (the tag of the Stealer build)</li><li>Country</li><li>IP</li><li>Working Path</li><li>Local Time</li><li>Time Zone</li><li>Display Language</li><li>Keyboard Languages</li><li>Laptop/Desktop</li><li>Processor</li><li>Installed RAM</li><li>OS (Operating Systems)</li><li>Video card</li><li>Display Resolution</li><li>PC name</li><li>Username</li><li>Installed Software</li></ul></li></ol>
<figure><img src="https://s3.ca-central-1.amazonaws.com/esentire-dot-com-assets/assetsV3/Blog/Blog-Images/MarsStealer_Picture24.png" style="max-width:80%;height:auto;width:auto;"/><figcaption>Exhibit 24: Decrypted strings (2)</figcaption></figure>
<p>
</p>
<p>Mars Stealer avoids reinfection by looking up a Mutex value 67820366929896267194. If the host returns the code ERROR_ALREADY_EXISTS (183), the stealer quits running (Exhibit 25).</p>
<figure><img src="https://s3.ca-central-1.amazonaws.com/esentire-dot-com-assets/assetsV3/Blog/Blog-Images/MarsStealer_Picture25.png" style="max-width:80%;height:auto;width:auto;"/><figcaption>Exhibit 25: Checks if Mutex value already exists</figcaption></figure>
<p>
</p>
<p>Mars Stealer has grabber and loader capabilities. The grabber functionality allows the attacker(s) to specify what files to collect, from which paths and the maximum file size. The following constant paths allow Mars Stealer to grab a victim’s data (Exhibit 26):</p>
<ul><li>%DESKTOP% </li><li>%APPDATA% - path to Roaming folder (C:\Users\*user*\AppData\Roaming)</li><li>%LOCALAPPDATA% - path to Local folder (C:\Users\*user*\AppData\Local)</li><li>%USERPROFILE% - path to User’s folder (C:\Users\*user*\)</li></ul>
<figure><img src="https://s3.ca-central-1.amazonaws.com/esentire-dot-com-assets/assetsV3/Blog/Blog-Images/MarsStealer_Picture26.png" style="max-width:80%;height:auto;width:auto;"/><figcaption>Exhibit 26: Grab panel</figcaption></figure>
<p>
</p>
<p>The loader allows the attacker(s) to upload additional payloads to the infected host including the modified/upgraded version of Mars Stealer. The loader functionality has the same constant paths mentioned above. The attacker(s) can enable the “Cold Wallet” option in the Loader panel, but it only works if the infected machine stores files related to crypto wallets and plugins (Exhibit 27).</p>
<figure><img src="https://s3.ca-central-1.amazonaws.com/esentire-dot-com-assets/assetsV3/Blog/Blog-Images/MarsStealer_Picture27.png" style="max-width:80%;height:auto;width:auto;"/><figcaption>Exhibit 27: Loader panel</figcaption></figure>
<p>
</p>
<p>As a part of the configuration, the attacker(s) can set up a Telegram Bot, which is used to receive the logs from infected machines. The settings panel also allows the attacker(s) to enable the following folders/files to collect: </p>
<ul><li>Downloads </li><li>History </li><li>Autofill (passwords, payment methods, addresses, etc.)</li><li>Screenshot </li><li>Discord </li></ul>
<p>The attacker(s) can also choose the “Build self-delete” option to remove the stealer on the infected machine. The self-delete command is executed via command line (Exhibit 28):</p>
<ul><li>/c timeout /t 5 &amp; del /f /q "%s" &amp; exit</li></ul>
<figure><img src="https://s3.ca-central-1.amazonaws.com/esentire-dot-com-assets/assetsV3/Blog/Blog-Images/MarsStealer_Picture28.png" style="max-width:80%;height:auto;width:auto;"/><figcaption>Exhibit 28: Self-deletion function</figcaption></figure>
<p>
</p>
<p>It is worth mentioning that the attacker(s) can replace their cryptocurrency and 2FA authenticator extensions in the browser with the ones collected on the victim’s machine and eventually obtain access to it. Here is the list of cryptocurrency extensions the stealer collects:</p>
<table class="table-bordered">
<tbody>
<tr>
<td>Crypto wallet</td>
<td>Extension</td>
</tr>
<tr>
<td>TronLink</td>
<td>ibnejdfjmmkpcnlpebklmnkoeoihofec</td>
</tr>
<tr>
<td>MetaMask
Binance Chain Wallet</td>
<td>nkbihfbeogaeaoehlefnkodbefgpgknn
fhbohimaelbohpjbbldcngcnapndodjp</td>
</tr>
<tr>
<td>Yoroi</td>
<td>ffnbelfdoeiohenkjibnmadjiehjhajb</td>
</tr>
<tr>
<td>Nifty Wallet</td>
<td>jbdaocneiiinmjbjlgalhcelgbejmnid</td>
</tr>
<tr>
<td>Math Wallet</td>
<td>afbcbjpbpfadlkmhmclhkeeodmamcflc</td>
</tr>
<tr>
<td>Coinbase Wallet</td>
<td>hnfanknocfeofbddgcijnmhnfnkdnaad</td>
</tr>
<tr>
<td>Guarda</td>
<td>hpglfhgfnhbgpjdenjgmdgoeiappafln</td>
</tr>
<tr>
<td>EQUAL Wallet</td>
<td>blnieiiffboillknjnepogjhkgnoapac</td>
</tr>
<tr>
<td>Jaxx Liberty</td>
<td>cjelfplplebdjjenllpjcblmjkfcffne</td>
</tr>
<tr>
<td>BitApp Wallet</td>
<td>fihkakfobkmkjojpchpfgcmhfjnmnfpi</td>
</tr>
<tr>
<td>iWallet</td>
<td>kncchdigobghenbbaddojjnnaogfppfj</td>
</tr>
<tr>
<td>Wombat</td>
<td>amkmjjmmflddogmhpjloimipbofnfjih</td>
</tr>
<tr>
<td>MEW CX</td>
<td>nlbmnnijcnlegkjjpcfjclmcfggfefdm</td>
</tr>
<tr>
<td>GuildWallet</td>
<td>nanjmdknhkinifnkgdcggcfnhdaammmj</td>
</tr>
<tr>
<td>Saturn Wallet</td>
<td>nkddgncdjgjfcddamfgcmfnlhccnimig</td>
</tr>
<tr>
<td>Ronin Wallet</td>
<td>fnjhmkhhmkbjkkabndcnnogagogbneec</td>
</tr>
<tr>
<td>NeoLine</td>
<td>cphhlgmgameodnhkjdmkpanlelnlohao</td>
</tr>
<tr>
<td>Clover Wallet</td>
<td>nhnkbkgjikgcigadomkphalanndcapjk</td>
</tr>
<tr>
<td>Liquality Wallet</td>
<td>kpfopkelmapcoipemfendmdcghnegimn</td>
</tr>
<tr>
<td>Terra Station</td>
<td>aiifbnbfobpmeekipheeijimdpnlpgpp</td>
</tr>
<tr>
<td>Keplr</td>
<td>dmkamcknogkgcdfhhbddcghachkejeap</td>
</tr>
<tr>
<td>Sollet</td>
<td>fhmfendgdocmcbmfikdcogofphimnkno</td>
</tr>
<tr>
<td>Sollet</td>
<td>fhmfendgdocmcbmfikdcogofphimnkno</td>
</tr>
<tr>
<td>Auro Wallet</td>
<td>cnmamaachppnkjgnildpdmkaakejnhae</td>
</tr>
<tr>
<td>Polymesh Wallet</td>
<td>jojhfeoedkpkglbfimdfabpdfjaoolaf</td>
</tr>
<tr>
<td>ICONex</td>
<td>flpiciilemghbmfalicajoolhkkenfel</td>
</tr>
<tr>
<td>Nabox Wallet</td>
<td>nknhiehlklippafakaeklbeglecifhad</td>
</tr>
<tr>
<td>KHC</td>
<td>hcflpincpppdclinealmandijcmnkbgn</td>
</tr>
<tr>
<td>Temple</td>
<td>ookjlbkiijinhpmnjffcofjonbfbgaoc</td>
</tr>
<tr>
<td>TezBox</td>
<td>mnfifefkajgofkcjkemidiaecocnkjeh</td>
</tr>
<tr>
<td>Cyano Wallet</td>
<td>dkdedlpgdmmkkfjabffeganieamfklkm</td>
</tr>
<tr>
<td>Byone</td>
<td>nlgbhdfgdhgbiamfdfmbikcdghidoadd</td>
</tr>
<tr>
<td>OneKey</td>
<td>infeboajgfhgbjpjbeppbkgnabfdkdaf</td>
</tr>
<tr>
<td>LeafWallet</td>
<td>cihmoadaighcejopammfbmddcmdekcje</td>
</tr>
<tr>
<td>DAppPlay</td>
<td>lodccjjbdhfakaekdiahmedfbieldgik</td>
</tr>
<tr>
<td>BitClip</td>
<td>ijmpgkjfkbfhoebgogflfebnmejmfbml</td>
</tr>
<tr>
<td>Steem Keychain</td>
<td>lkcjlnjfpbikmcmbachjpdbijejflpcm</td>
</tr>
<tr>
<td>Nash Extension</td>
<td>onofpnbbkehpmmoabgpcpmigafmmnjhl</td>
</tr>
<tr>
<td>Hycon Lite Client</td>
<td>bcopgchhojmggmffilplmbdicgaihlkp</td>
</tr>
<tr>
<td>ZilPay</td>
<td>klnaejjgbibmhlephnhpmaofohgkpgkd</td>
</tr>
<tr>
<td>Coin98 Wallet</td>
<td>aeachknmefphepccionboohckonoeemg</td>
</tr>
</tbody>
</table>
<p>Below is the list of 2FA Authenticator extensions:</p>
<table class="table-bordered">
<tbody>
<tr>
<td>2FA Authenticator</td>
<td>Extension</td>
</tr>
<tr>
<td>Authenticator</td>
<td>bhghoamapcdpbohphigoooaddinpkbai</td>
</tr>
<tr>
<td>Authy</td>
<td>gaedmjdfmmahhbjefcbgaolhhanlaolb</td>
</tr>
<tr>
<td>EOS Authenticator</td>
<td>oeljdldpnmdbchonielidgobddffflal</td>
</tr>
<tr>
<td>GAuth Authenticator</td>
<td>ilgcnhelpchnceeipipijaljkblbcobl?hl=ru</td>
</tr>
<tr>
<td>Trezor Password Manager</td>
<td>imloifkgjagghnncjkhggdhalmcnfklk?hl=ru</td>
</tr>
</tbody>
</table>
<p>Moreover, the stealer gathers the credentials and sensitive data from numerous browsers and crypto wallets (Exhibit 29). </p>
<figure><img src="https://s3.ca-central-1.amazonaws.com/esentire-dot-com-assets/assetsV3/Blog/Blog-Images/MarsStealer_Picture29.png" style="max-width:80%;height:auto;width:auto;"/><figcaption>Exhibit 29: The function responsible for gathering crypto wallet data</figcaption></figure>
<p>
</p>
<p>Supported browsers:</p>
<p>Internet Explorer, Microsoft Edge, Google Chrome, Chromium, Microsoft Edge (Chromium version), Kometa, Amigo, Torch, Orbitum, Comodo Dragon, Nichrome, Maxthon5, Maxthon6, Sputnik Browser, Epic Privacy Browser, Vivaldi, CocCoc, Uran Browser, QIP Surf, Cent Browser, Elements Browser, TorBro Browser, CryptoTab Browser, Brave Browser, Opera Stable, Opera GX, Opera Neon, Firefox, SlimBrowser, PaleMoon, Waterfox, Cyberfox, BlackHawk, IceCat, KMeleon, Thunderbird</p>
<p>Supported crypto wallets:</p>
<p>Dogecoin, Zcash, DashCore, LiteCoin, Ethereum, Electrum, Electrum LTC, Exodus, Electron Cash, MultiDoge, JAXX, Atomic, Binance, Coinomi</p>
<h3>C2 Communication</h3>
<p>The infected machine occasionally sends the POST requests to <a href="http://162.33.178">http://162.33.178</a>[.]122/fakeurl.htm, which is a NetSupportManager server (Exhibit 30).</p>
<figure><img src="https://s3.ca-central-1.amazonaws.com/esentire-dot-com-assets/assetsV3/Blog/Blog-Images/MarsStealer_Picture30.png" style="max-width:80%;height:auto;width:auto;"/><figcaption>Exhibit 30: POST requests of NetSupport Manager traffic</figcaption></figure>
<p>The victim then reaches out to the Mars Stealer C2 server (/request) to grab additional DLL dependencies (Exhibit 31):</p>
<ul><li>softokn3.dll (Mozilla Firefox Library)</li><li>sqlite3.dll (used for SQLite database)</li><li>vcruntime140.dll (Microsoft Visual Studio runtime library)</li><li>freebl3.dll (Mozilla NSS freebl Library)</li><li>mozglue.dll (Mozilla Firefox Library)</li><li>msvcp140.dll (Microsoft Visual Studio runtime library)</li><li>nss3.dll (Network Security Services Mozilla Firefox Library)</li></ul>
<figure><img src="https://s3.ca-central-1.amazonaws.com/esentire-dot-com-assets/assetsV3/Blog/Blog-Images/MarsStealer_Picture31.png" style="max-width:80%;height:auto;width:auto;"/><figcaption>Exhibit 31: The infected machine is reaching out to C2 Server to retrieve DLL components</figcaption></figure>
<p>
</p>
<p>The infected machine then sends out the collected data including RDP credentials and certificates in a ZIP archive to Mars Stealer C2 (Exhibit 32). </p>
<figure><img src="https://s3.ca-central-1.amazonaws.com/esentire-dot-com-assets/assetsV3/Blog/Blog-Images/MarsStealer_Picture32.png" style="max-width:80%;height:auto;width:auto;"/><figcaption>Exhibit 32: Exfiltrated data sent out to C2</figcaption></figure>
<p>
</p>
<p>The following is an example of the exfiltrated data and the contents of the previously mentioned system.txt file (Exhibit 33). </p>
<figure><img src="https://s3.ca-central-1.amazonaws.com/esentire-dot-com-assets/assetsV3/Blog/Blog-Images/MarsStealer_Picture33.png" style="max-width:80%;height:auto;width:auto;"/><figcaption>Exhibit 33: The contents of the exfiltrated ZIP archive including system.txt</figcaption></figure>
<p>
</p>
<p>During the analysis of Mars Stealer, we observed a number of similarities with <a href="https://www.cyberark.com/resources/threat-research-blog/meet-oski-stealer-an-in-depth-analysis-of-the-popular-credential-stealer">Oski Stealer</a> including anti-emulation and self-removal capabilities, language checks, loader, and grabber features of the stealer. The obfuscation mechanism is also identical to the previous versions of Mars Stealer: RC4 decryption key and Base64 strings. The Oski Stealer author removed the Telegram Support channel and stopped responding to requests on Oski Stealer at the end of June 2020. </p>
<p>eSentire’s TRU team accesses with high confidence that Mars Stealer is a successor of Oski Stealer, although it is worth noting that unlike Oski Stealer, Mars Stealer does not support Outlook data and credential exfiltration. </p>
<h2>How eSentire is Responding</h2>
<p>Our Threat Response Unit (TRU) team combines threat intelligence obtained from research and cybersecurity incidents to create practical outcomes for our customers. We are taking a full-scale response approach to combat modern cybersecurity threats by deploying countermeasures, such as:</p>
<ul><li>Implementing cyber threat detections to identify malicious command execution, usage of renamed tools and ensure that eSentire has visibility and detections are in place across eSentire <a href="https://www.esentire.com/how-we-do-it/signals/endpoint">MDR for Endpoint</a>
and <a href="https://www.esentire.com/how-we-do-it/signals/network">MDR for Network</a>. </li><li>Performing global cyber threat hunts for indicators associated with Mars Stealer.</li></ul>
<p>Our detection content is supported by investigation runbooks, ensuring our SOC (Security Operations Center) analysts respond rapidly to any intrusion attempts related to a known malware Tactics, Techniques, and Procedures. In addition, TRU closely monitors the threat landscape and constantly addresses capability gaps and conducts retroactive threat hunts to assess customer impact.</p>
<h2>Recommendations from eSentire’s Threat Response Unit (TRU) </h2>
<p>We recommend implementing the following controls to help secure your organization against SolarMarker malware:</p>
<ul><li>Implement a <a href="https://www.esentire.com/what-we-do/managed-vulnerability-and-risk/technical-testing/security-awareness-training-managed-phishing-training">Phishing and Security Awareness Training (PSAT)</a> program that educates and informs employees on emerging threats in the threat landscape.</li><li>Confirm that all devices are protected with <a href="https://www.esentire.com/how-we-do-it/signals/endpoint">Endpoint Detection and Response (EDR)</a> solutions.</li><li>Prevent web browsers from automatically saving and storing passwords. It is recommended to use password managers instead.</li><li>Enable multi-factor authentication whenever it is applicable. </li></ul>
<p>While the TTPs used by adversaries grow in sophistication, they lead to a certain level of difficulties at which critical business decisions must be made. Preventing the various cyberattack paths utilized by the modern threat actor requires actively monitoring the threat landscape, developing, and deploying endpoint detection, and the ability to investigate logs &amp; network data during active intrusions. </p>
<p>eSentire’s TRU team is a world-class team of threat researchers who develop new detections enriched by original threat intelligence and leverage new machine learning models that correlate multi-signal data and automate rapid response to advanced cyber threats. </p>
<p>If you are not currently engaged with an MDR provider, <a href="https://www.esentire.com/what-we-do/esentire-managed-detection-and-response">eSentire MDR</a> can help you reclaim the advantage and put your business ahead of disruption. </p>
<p>Learn what it means to have an elite team of Threat Hunters and Researchers that works for you. <a href="https://www.esentire.com/get-started">Connect</a> with an eSentire Security Specialist.</p>
<h2>Appendix</h2>
<ul><li><a href="https://www.esentire.com/blog/fake-chrome-setup-leads-to-netsupportmanager-rat-and-mars-stealer">https://www.esentire.com/blog/fake-chrome-setup-leads-to-netsupportmanager-rat-and-mars-stealer</a></li><li><a href="https://blog.morphisec.com/threat-research-mars-stealer">https://blog.morphisec.com/threat-research-mars-stealer</a></li><li><a href="https://cyberint.com/blog/research/mars-stealer/">https://cyberint.com/blog/research/mars-stealer/</a></li><li><a href="https://www.cyberark.com/resources/threat-research-blog/meet-oski-stealer-an-in-depth-analysis-of-the-popular-credential-stealer">https://www.cyberark.com/resources/threat-research-blog/meet-oski-stealer-an-in-depth-analysis-of-the-popular-credential-stealer</a></li><li><a href="https://docs.microsoft.com/en-us/windows/win32/api">https://docs.microsoft.com/en-us/windows/win32/api</a></li><li><a href="https://www.ired.team/offensive-security/defense-evasion/bypassing-cylance-and-other-avs-edrs-by-unhooking-windows-apis">https://www.ired.team/offensive-security/defense-evasion/bypassing-cylance-and-other-avs-edrs-by-unhooking-windows-apis</a></li><li><a href="https://blog.malwarebytes.com/threat-analysis/2018/08/process-doppelganging-meets-process-hollowing_osiris/">https://blog.malwarebytes.com/threat-analysis/2018/08/process-doppelganging-meets-process-hollowing_osiris/</a></li></ul>
<h3>Indicators of Compromise</h3>
<table class="table-bordered">
<tbody>
<tr>
<td>Name</td>
<td>Indicators</td>
</tr>
<tr>
<td>googleglstatupdt[.]com</td>
<td>Hosting ChromeSetup ISO</td>
</tr>
<tr>
<td>zrianevakn1[.]com</td>
<td>NetSupportManager RAT C2</td>
</tr>
<tr>
<td>162[.]33.178.122</td>
<td>NetSupportManager RAT C2</td>
</tr>
<tr>
<td>115d1ae8b95551108b3a902e48b3f163</td>
<td>ChromeSetup.iso</td>
</tr>
<tr>
<td>b15e0db8f65d7df27c07afe2981ff5a755666dce</td>
<td>ChromeSetup.exe</td>
</tr>
<tr>
<td>37c24b4b6ada4250bc7c60951c5977c0</td>
<td>NetSupportManager RAT</td>
</tr>
<tr>
<td>5[.]45.84.214</td>
<td>Mars Stealer C2 (Offline)</td>
</tr>
<tr>
<td>e57756b675ae2aa07c9ec7fa52f9de33935cbc0f</td>
<td>Mars Stealer</td>
</tr>
<tr>
<td>e3c91b6246b2b9b82cebf3700c0a7093bacaa09b</td>
<td>Esitanza.exe.pif (renamed AutoIt)</td>
</tr>
<tr>
<td>e3c91b6246b2b9b82cebf3700c0a7093bacaa09b</td>
<td>ANpRAHx.exe (disguised as 3uAirPlayer, drops Mars Stealer and obfuscated AutoIt scripts)</td>
</tr>
<tr>
<td>5c4e3e5fda232c31b3d2a2842c5ea23523b1de1a</td>
<td>Installer_ovl.exe</td>
</tr>
<tr>
<td>2a2b00d0555647a6d5128b7ec87daf03a0ad568f</td>
<td>consoleappmrss.exe</td>
</tr>
<tr>
<td>3c80b89e7d4fb08aa455ddf902a3ea236d3b582a</td>
<td>Fervore.wmd (obfuscated AutoIt script)</td>
</tr>
<tr>
<td>26136c59afe28fc6bf1b3aeba8946ac2c3ce61df</td>
<td>Vai.wmd (obfuscated AutoIt script, contains Mars Stealer)</td>
</tr>
<tr>
<td>e6f18804c94f2bca5a0f6154b1c56186d4642e6b</td>
<td>Una.wmd (obfuscated AutoIt script)</td>
</tr>
</tbody>
</table>
<h3>Yara Rules</h3>
import "pe"
rule MarsStealer {
 meta:
 description = "Identifies Mars Stealer malware"
 author = "eSentire TI"
 date = "04/20/2022"
 hash = "e57756b675ae2aa07c9ec7fa52f9de33935cbc0f"
 strings:
 $string1 = "C:\\ProgramData\\nss3.dll"
 $string2 = "passwords.txt" 
 $string3 = "screenshot.jpg" 
 $string4 = "*wallet*.dat" 
 $string5 = "Grabber\\%s.zip"
 condition:
 all of ($string*) and
 (uint16(0) == 0x5A4D or uint32(0) == 0x4464c457f) 
}
<h3>Skip To:</h3>
<ul>
<li>Key Takeaways:</li>
<li>Case Study</li>
<li>Technical Analysis of Mars Stealer Infection</li>
<li>How eSentire is Responding</li>
<li>Recommendations from eSentire’s Threat Response Unit (TRU) </li>
<li>Appendix</li>
</ul>
</div>