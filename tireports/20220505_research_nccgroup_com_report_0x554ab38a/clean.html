<div>
<h1 class="entry-title">North Korea’s Lazarus: their initial access trade-craft using social media and social engineering</h1>
<a href="https://research.nccgroup.com/author/nccgifc/" rel="author" title="Posts by RIFT: Research and Intelligence Fusion Team">RIFT: Research and Intelligence Fusion Team</a>
<a href="https://research.nccgroup.com/category/threat-intelligence/" rel="category tag">Threat Intelligence</a> 
May 5, 2022May 5, 2022 
5 Minutes 
<p>Authored by: Michael Matthews and Nikolaos Pantazopoulos </p>
<h1>tl;dr</h1>
<p>This blog post documents some of the actions taken during the initial access phase for an attack attributed to Lazarus, along with analysis of the malware that was utilised during this phase.</p>
<p>The methods used in order to gain access to a victim network are widely reported however, nuances in post-exploitation provide a wealth of information on attack paths and threat hunting material that relate closely to TTP’s of the Lazarus group. </p>
<p>In summary, we identified the following findings:</p>
<ul><li>Lazarus used LinkedIn profiles to impersonate employees of other legitimate companies</li><li>Lazarus communicated with target employees through communication channels such as WhatsApp.</li><li>Lazarus entices victims to download job adverts (zip files) containing malicious documents that lead to the execution of malware</li><li>The identified malicious downloader appears to be a variant of LCPDOT</li><li>Scheduled tasks are utilised as a form of persistence (<code>rundll32</code> execution from a scheduled task)</li></ul>
<h1>Initial Access</h1>
<p>In line with what is publicly documented<a href="#_ftn1" id="_ftnref1">[1]</a>, the initial entry revolves heavily around social engineering, with recent efforts involving the impersonation of Lockheed Martin employees with LinkedIn profiles to persuade victims into following up with job opportunities that result in a malicious document being delivered.</p>
<p>In this instance, the domain hosting the document was <code>global-job[.]org</code>, likely attempting to impersonate <code>globaljobs[.]org</code>, a US based government/defence recruitment website. In order to subvert security controls in the recent changes made by Microsoft for Office macros, the website hosted a ZIP file which contained the malicious document.</p>
<p>The document had several characteristics comparable to other Lazarus samples however, due to unknown circumstances, the “shapes” containing the payloads were unavailable and could not be analysed.</p>
<p>Following the execution of the macro document, <code>rundll32.exe</code> is called to execute the DLL <code>C:\programdata\packages.mdb</code>, which then led to the initial command-and-control server call out. Unfortunately, the binary itself was no longer available for analysis however, it is believed that this component led to the LCPDot malware being placed on the victim’s host.</p>
<h1>LCPDot</h1>
<p>We were able to recover a malicious downloader that was executed as a scheduled task. The identified sample appears to be a variant of LCPDot, and it is attributed to the threat actor ‘Larazus’.</p>
<p>The file in question attempted to blend into the environment, leveraging the <code>ProgramData</code> directory once again <code>C:\ProgramData\Oracle\Java\JavaPackage.dll</code>. However, the file had characteristics that stand out whilst threat hunting:</p>
<ul><li>Large file size (60mb+) – likely to bypass anti-virus scanning</li><li>Time stomping – timestamps copied from <code>CMD.exe</code></li><li>DLL owned by a user in the <code>ProgramData</code> directory (Not SYSTEM or Administrator)</li></ul>
<p>To execute LCPDot, a scheduled task was created named “Windows Java Vpn Interface”, attempting to blend into the system with the Java theme. The scheduled task executed the binary but also allowed the threat actor to persist.</p>
<p>The scheduled task was set to run daily with the following parameter passed for execution, running:</p>
<code> &lt;Exec&gt;
 &lt;Command&gt;c:\windows\system32\rundll32.exe&lt;/Command&gt;
 &lt;Arguments&gt;C:\ProgramData\Oracle\Java\JavaPackage.dll,VpnUserInterface&lt;/Arguments&gt;
 &lt;/Exec&gt;
</code>
<h2>LCPDot Binary Analysis</h2>
<p>The downloader’s malicious core starts in a separate thread and the execution flow is determined based on Windows messages IDs (sent by the Windows API function <code>SendMessage</code>).</p>
<p>In the following sections we describe the most important features that we identified during our analysis.</p>
<h2>Initialisation Phase</h2>
<p>The initialisation phase takes place in a new thread and the following tasks are performed:</p>
<ul><li>Initialisation of class <code>MoscowTownList</code>. This class has the functionality to read/write the configuration.</li><li>Creation of configuration file on disk. The configuration file is stored under the filename <code>VirtualStore.cab</code> in <code>%APPDATA%\Local</code> folder. The configuration includes various metadata along with the command-and-control servers URLs. The structure that it uses is:</li></ul>
<code>struct Configuration
{
 DWORD Unknown; //Unknown, set to 0 by default. If higher than 20 then it 
 // can cause a 2-hour delay during the network 
 // communication process.
 SYSTEMTIME Variant_SystemTime; // Configuration timestamp created by 
 // SystemTimeToVariantTime.
 SYSTEMTIME Host_SystemTime; // Configuration timestamp. Updated during
 // network communication process.
 DWORD Logical_drives_find_flag; // Set to 0 by default
 DWORD Active_sessions_flag; // Set to 0 by default
 DWORD Boot_Time; // Milliseconds since boot time
 char *C2_Data;// Command-and-Control servers’ domains
};
</code>
<p>The configuration is encrypted by hashing (SHA-1) a random byte array (16 bytes) and then uses the hash output to derive (CryptDeriveKey) a RC4 key (16 bytes). Lastly it writes to the configuration file the random byte array followed by the encrypted configuration data.</p>
<ul><li>Enumeration of logical drives and active logon sessions. The enumeration happens only if specified in the configuration. By default, this option is off. Furthermore, even if enabled, it does not appear to have any effect (e.g. sending them to the command-and-control server).</li></ul>
<p>Once this phase is completed, the downloader starts the network communication with its command-and-control servers.</p>
<h2>Network Communication</h2>
<p>At this stage, the downloader registers the compromised host to the command-and-control server and then requests the payload to execute. In summary, the following steps are taken:</p>
<ul><li>Initialises the classes <code>Taxiroad</code> and <code>WashingtonRoad</code>.</li><li>Creates a byte array (16 bytes), which is then encoded (base64), and a session ID. Both are sent to the server. The encoded byte array is used later to decrypt the received payload and is added to the body content of the request:
<code>redirect=Yes&amp;idx=%d&amp;num=%s</code>, where <code>idx</code> holds the compromised host’s boot time value and <code>num</code> has the (BASE64) encoded byte array.
In addition, the session ID is encoded (BASE64) and added to the following string:
<code>SESSIONID-%d-202110</code>, where <code>202110</code> is the network command ID.
The above string is encoded again (BASE64) and then added to the <code>SESSIONID</code> header of the POST request.</li></ul>
<p>After registering the compromised host, the server replies with one of the following messages:</p>
<ul><li>Validation Success – Bot registered without any issues.</li><li>Validation Error – An error occurred.</li></ul>
<p>Once the registration process has been completed, the downloader sends a GET request to download the second-stage payload. The received payload is decrypted by hashing (SHA-1) the previously created byte array and then use the resulting hash to derive (<code>CryptDeriveKey</code>) a RC4 key.</p>
<p>Lastly, the decrypted payload is loaded directly into memory and executed in a new thread.</p>
<p>In summary, we identified the following commands (Table 1).</p>
<figure class="wp-block-table"><table><tbody><tr><td>Command ID</td><td>Description</td></tr><tr><td>202110</td><td>Register compromised host to the command-and-control server</td></tr><tr><td>202111</td><td>Request payload from the command-and-control server</td></tr></tbody></table><figcaption>Table 1 – Identified network commands</figcaption></figure>
<h2>Unused Commands and Functions</h2>
<p>One interesting observation is the presence of functions and network commands, which the downloader does not seem to use. Therefore, we concluded that the following network commands are not used by the downloader (at least in this variant) but we do believe that the operators may use them on the server-side (e.g. in the PHP scripts that the downloader sends data) or the loaded payload does use them (Note: Commands 789020, 789021 and 789022 are by default disabled):</p>
<ul><li>202112 – Sends encrypted data in a POST request. Data context is unknown.</li><li>202114 – Sends a POST request with body content ‘Cookie=Enable’.</li><li>789020 – Same functionality as command ID 202111.</li><li>789021 – Same functionality as command ID 202112.</li><li>789022 – Sends a POST request with body content ‘Cookie=Enable’.</li></ul>
<h1>Indicators of Compromise</h1>
<h2>Domains</h2>
<ul><li>ats[.]apvit[.]com – Legitimate Compromised website</li><li>bugs-hpsm[.]mobitechnologies[.]com – Legitimate Compromised website</li><li>global-job[.]org</li><li>thefrostery[.]co[.]uk – Legitimate Compromised website</li><li>shoppingbagsdirect[.]com – – Legitimate Compromised website</li></ul>
<h2>IP Address</h2>
<ul><li>13[.]88[.]245[.]250</li></ul>
<h2>Hashes</h2>
<h3>Javapackage.dll</h3>
<p>MD5: AFBCB626B770B1F87FF9B5721D2F3235</p>
<p>SHA1: D25A4F20C0B9D982D63FC0135798384C17226B55</p>
<p>SHA256: FD02E0F5FCF97022AC266A3E54888080F66760D731903FC32DF2E17E6E1E4C64</p>
<h3>Virtualstore.cab</h3>
<p>MD5: 49C2821A940846BDACB8A3457BE4663C</p>
<p>SHA1: 0A6F762A47557E369DB8655A0D14AB088926E05B</p>
<p>SHA256: F4E314E8007104974681D92267673AC22721F756D8E1925142D9C26DC8A0FFB4</p>
<h2>MITRE ATT&amp;CK</h2>
<figure class="wp-block-table"><table><tbody><tr><td>Technique</td><td>ID</td></tr><tr><td>Phishing: Spearphishing via Service</td><td>T1566.003</td></tr><tr><td>Scheduled Task/Job: Scheduled Task</td><td>T1053.005</td></tr><tr><td>User Execution: Malicious File</td><td>T1204.002</td></tr><tr><td>Application Layer Protocol</td><td>T1071.001</td></tr></tbody></table><figcaption>MITRE ATT&amp;CK</figcaption></figure>
<h2>References</h2>
<p><a href="#_ftnref1" id="_ftn1">[1]</a> <a href="https://www.microsoft.com/security/blog/2021/01/28/zinc-attacks-against-security-researchers/">https://www.microsoft.com/security/blog/2021/01/28/zinc-attacks-against-security-researchers/</a></p>
<h3 class="sd-title">Share this:</h3><ul><li class="share-twitter"><a class="share-twitter sd-button share-icon" href="https://research.nccgroup.com/2022/05/05/north-koreas-lazarus-and-their-initial-access-trade-craft-using-social-media-and-social-engineering/?share=twitter&amp;nb=1" rel="nofollow noopener noreferrer" target="_blank" title="Click to share on Twitter">Twitter</a></li><li class="share-reddit"><a class="share-reddit sd-button share-icon" href="https://research.nccgroup.com/2022/05/05/north-koreas-lazarus-and-their-initial-access-trade-craft-using-social-media-and-social-engineering/?share=reddit&amp;nb=1" rel="nofollow noopener noreferrer" target="_blank" title="Click to share on Reddit">Reddit</a></li><li class="share-linkedin"><a class="share-linkedin sd-button share-icon" href="https://research.nccgroup.com/2022/05/05/north-koreas-lazarus-and-their-initial-access-trade-craft-using-social-media-and-social-engineering/?share=linkedin&amp;nb=1" rel="nofollow noopener noreferrer" target="_blank" title="Click to share on LinkedIn">LinkedIn</a></li><li class="share-facebook"><a class="share-facebook sd-button share-icon" href="https://research.nccgroup.com/2022/05/05/north-koreas-lazarus-and-their-initial-access-trade-craft-using-social-media-and-social-engineering/?share=facebook&amp;nb=1" rel="nofollow noopener noreferrer" target="_blank" title="Click to share on Facebook">Facebook</a></li><li class="share-end"></li></ul><h3 class="sd-title">Like this:</h3>Like Loading...<a class="sd-link-color"></a>
<img alt="" class="avatar avatar-80 photo jetpack-lazy-image grav-hashed grav-hijack" height="80" id="grav-8875243b6c0f6a934366d0278ee52700-0" src="https://secure.gravatar.com/avatar/8875243b6c0f6a934366d0278ee52700?s=80&amp;d=identicon&amp;r=g" width="80"/><img alt="" class="avatar avatar-80 photo" height="80" src="https://secure.gravatar.com/avatar/8875243b6c0f6a934366d0278ee52700?s=80&amp;d=identicon&amp;r=g" width="80"/>
<h2 class="author-title">
				Published by RIFT: Research and Intelligence Fusion Team </h2>
<p>
			RIFT leverages our strategic analysis, data science, and threat hunting capabilities to create actionable threat intelligence, ranging from IoCs and detection capabilities to strategic reports on tomorrow’s threat landscape. Cyber security is an arms race where both attackers and defenders continually update and improve their tools and ways of working. To ensure that our managed services remain effective against the latest threats, NCC Group operates a Global Fusion Center with Fox-IT at its core. This multidisciplinary team converts our leading cyber threat intelligence into powerful detection strategies.			<a class="author-link" href="https://research.nccgroup.com/author/nccgifc/" rel="author">
				View all posts by RIFT: Research and Intelligence Fusion Team			</a>
</p>
Published
May 5, 2022May 5, 2022 
</div>