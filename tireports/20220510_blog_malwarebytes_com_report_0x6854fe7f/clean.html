<div>
<p><img alt="APT34 targets Jordan Government using new Saitama backdoor" src="https://blog.malwarebytes.com/wp-content/uploads/2019/06/shutterstock_1253457796-900x506.jpg" style="max-width:80%;height:auto;width:auto;"/></p>
<p><a href="https://blog.malwarebytes.com/category/threat-intelligence/" rel="category tag">Threat Intelligence</a></p>
<h1 class="entry-title p-name">
					APT34 targets Jordan Government using new Saitama backdoor				</h1>
<p>Posted: May 10, 2022 by <a href="https://blog.malwarebytes.com/author/threatintelligence/" rel="author" title="Posts by Threat Intelligence Team">Threat Intelligence Team</a>
</p>
On April 26th, we identified a suspicious email that targeted a government official from Jordan’s foreign ministry. The email contained a malicious Excel document that drops a new backdoor named Saitama. Following our investigation, we were able to attribute this attack to the known Iranian Actor APT34. Also known as OilRig/COBALT GYPSY/IRN2/HELIX KITTEN, APT34 is...
<p>On April 26th, we identified a suspicious email that targeted a government official from Jordan’s foreign ministry. The email contained a malicious Excel document that drops a new backdoor named Saitama. Following our investigation, we were able to attribute this attack to the known Iranian Actor APT34. </p>
<p>Also known as OilRig/COBALT GYPSY/IRN2/HELIX KITTEN, APT34 is an Iranian threat group that has targeted Middle Eastern countries and victims worldwide since at least 2014. The group is known to focus on the financial, governmental, energy, chemical, and telecommunication sectors.</p>
<p>In this blog post, we describe the attack flow and share details about the Saitama backdoor.</p>
<h2>Malicious email file</h2>
<p>The malicious email was sent to the victim via a Microsoft Outlook account with the subject “Confirmation Receive Document” with an Excel file called “Confirmation Receive Document.xls”. The sender pretends to be a person from the Government of Jordan by using its coat of arms as a signature. </p>
<figure class="aligncenter size-full"><a href="https://blog.malwarebytes.com/wp-content/uploads/2022/05/eml.png" title=""><img alt="" class="wp-image-56463" height="932" src="https://blog.malwarebytes.com/wp-content/uploads/2022/05/eml.png" style="max-width:800px;height:auto;width:auto;" width="1850"/></a><figcaption>Figure 1: Malicious email</figcaption></figure>
<h2>Excel document</h2>
<p>The Excel attachment contains a macro that performs malicious activities. The document has an image that tries to convince the victim to enable a macro. </p>
<figure class="aligncenter size-full"><a href="https://blog.malwarebytes.com/wp-content/uploads/2022/05/doc-bef.png" title=""><img alt="" class="wp-image-56464" height="938" src="https://blog.malwarebytes.com/wp-content/uploads/2022/05/doc-bef.png" style="max-width:800px;height:auto;width:auto;" width="1852"/></a><figcaption>Figure 2: Excel doc</figcaption></figure>
<p>After enabling the macro, the image is replaced with the Jordan government’s the coat of the arms:</p>
<figure class="aligncenter size-full"><a href="https://blog.malwarebytes.com/wp-content/uploads/2022/05/doc-aft.png" title=""><img alt="" class="wp-image-56465" height="944" src="https://blog.malwarebytes.com/wp-content/uploads/2022/05/doc-aft.png" style="max-width:800px;height:auto;width:auto;" width="1848"/></a><figcaption>Figure 3: Excel doc after enabling the macro </figcaption></figure>
<p>The macro has been executed on WorkBook_Open(). Here are the main functionalities of this macro:</p>
<figure class="aligncenter size-full"><a href="https://blog.malwarebytes.com/wp-content/uploads/2022/05/open1.png" title=""><img alt="" class="wp-image-56469" height="1222" src="https://blog.malwarebytes.com/wp-content/uploads/2022/05/open1.png" style="max-width:800px;height:auto;width:auto;" width="1398"/></a><figcaption>Figure 4: Macro</figcaption></figure>
<ul><li>Hides the current sheet and shows the new sheet that contains the coat of arms image.</li><li>Calls the “eNotif’ function which is used to send a notification of each steps of macro execution to its server using the DNS protocol. To send a notification it builds the server domain for that step that contains the following parts: “qw” + identification of the step (in this step “zbabz”) + random number + domain name (joexpediagroup.com) = qwzbabz7055.joexpediagroup.com. Then it uses the following WMI query to get the IP address of the request: Select * From Win32_PingStatus Where Address = ‘” &amp; p_sHostName &amp; “‘” which performs the DNS communication the the created subdomain. </li><li>Creates a TaskService object and Gets the task folder that contains the list of the current tasks</li><li>Calls ENotif function </li><li>Checks if there is a mouse connected to PC and if that is the case performs the following steps<ul><li>Creates %APPDATA%/MicrosoftUpdate directory</li><li>Creates “Update.exe”, “Update.exe.config” and “Microsoft.Exchange.WenServices.dll”</li><li>Reads the content of the UserForm1.label1, UserForm2.label1 and UserForm3.label1 that are in base64 format, decodes them and finally writes them into the created files in the previous step</li><li>Calls a ENotif function for each writes function</li></ul></li><li>Checks the existence of the Update.exe file and if for some reason it has not been written to disk, it writes it using a technique that loads a DotNet assembly directly using mscorlib and Assembly.Load by manually accessing the VTable of the IUnknown. This technique was taken from Github (<a href="https://gist.github.com/monoxgas/1b36031c5593ebfed3229f4424f77090">link</a>). Even though, this technique was not used in this macro since the file was already written, the function name (“Test”) suggests that the threat actor is trying to implement this technique in future attacks. </li><li>Finally, it calls the ENotif function. </li></ul>
<figure class="aligncenter size-full"><a href="https://blog.malwarebytes.com/wp-content/uploads/2022/05/testfunc.png" title=""><img alt="" class="wp-image-56470" height="666" src="https://blog.malwarebytes.com/wp-content/uploads/2022/05/testfunc.png" style="max-width:800px;height:auto;width:auto;" width="742"/></a><figcaption>Figure 5: Load .Net assembly</figcaption></figure>
<ul><li>Defines a xml schema for a scheduled task and registers it using the RegisterTask function. The name of the scheduled task is MicrosoftUpdate and is used to make update.exe persistent. </li></ul>
<figure class="aligncenter size-full"><a href="https://blog.malwarebytes.com/wp-content/uploads/2022/05/task.png" title=""><img alt="" class="wp-image-56471" height="816" src="https://blog.malwarebytes.com/wp-content/uploads/2022/05/task.png" style="max-width:800px;height:auto;width:auto;" width="892"/></a><figcaption>Figure 6: Task Schema</figcaption></figure>
<h2>Saitama Backdoor – A finite state machine</h2>
<p>The dropped payload is a small backdoor that is written in .Net. It has the following interesting pdb path: E:\Saitama\Saitama.Agent\obj\Release\Saitama.Agent.pdb. </p>
<p>Saitama backdoor abuses the DNS protocol for its command and control communications. This is stealthier than other communication methods, such as HTTP. Also, the actor cleverly uses techniques such as compression and long random sleep times. They employed these tricks to disguise malicious traffic in between legitimate traffic. </p>
<p>Another element that we found interesting about this backdoor is the way that it is implemented. The whole flow of the program is defined explicitly as a <a href="https://en.wikipedia.org/wiki/Finite-state_machine" rel="noreferrer noopener" target="_blank">finite-state machine</a>, as shown in the Figure 7. In short, the machine will change its state depending on the command sent to every state. Graphically, the program flow can be seen as this:</p>
<figure class="aligncenter size-full"><a href="https://blog.malwarebytes.com/wp-content/uploads/2022/05/image-12.png" title=""><img alt="" class="wp-image-56533" height="1063" src="https://blog.malwarebytes.com/wp-content/uploads/2022/05/image-12.png" style="max-width:800px;height:auto;width:auto;" width="1520"/></a><figcaption>Figure 7: Graphical view of the state machine</figcaption></figure>
<p>The finite-machine state can be:</p>
<h3>BEGIN</h3>
<p>It is the initial state of the machine. It just accepts the start command that puts the machine into the ALIVE state.</p>
<h3>ALIVE</h3>
<p>This state fetches the C&amp;C server, expecting to receive a command from the attackers. These servers are generated by using the PRNG algorithm that involves transformations like the Mersenne Twister. These transformations will generate subdomains of the hard coded domains in the Config class (Figure 8). </p>
<figure class="aligncenter size-full"><a href="https://blog.malwarebytes.com/wp-content/uploads/2022/05/config.png" title=""><img alt="" class="wp-image-56472" height="392" src="https://blog.malwarebytes.com/wp-content/uploads/2022/05/config.png" style="max-width:800px;height:auto;width:auto;" width="962"/></a><figcaption>Figure 8: Main domains are hardcoded</figcaption></figure>
<p>Figure 9 shows an example of the generated subdomain:</p>
<figure class="aligncenter size-full"><a href="https://blog.malwarebytes.com/wp-content/uploads/2022/05/image-9.png" title=""><img alt="" class="wp-image-56510" height="156" src="https://blog.malwarebytes.com/wp-content/uploads/2022/05/image-9.png" style="max-width:800px;height:auto;width:auto;" width="1012"/></a><figcaption>Figure 9: Connection attempt to a C&amp;C server</figcaption></figure>
<p>This state has two possible next stages. If the performed DNS request fails, the next stage is SLEEP. Otherwise, the next stage is RECEIVE.</p>
<h3>SLEEP and SECOND SLEEP</h3>
<p>These states put the backdoor in sleep mode. The amount of time that the program will sleep is determined by the previous stage. It is clear that one of the main motivations of the actor is to be as stealthy as possible. For example, unsuccessful DNS requests puts the backdoor in sleep mode for a time between 6 and 8 hours! There are different sleep times depending on the situations (values are expressed in milliseconds):</p>
<figure class="aligncenter size-full"><a href="https://blog.malwarebytes.com/wp-content/uploads/2022/05/image-10.png" title=""><img alt="" class="wp-image-56511" height="357" src="https://blog.malwarebytes.com/wp-content/uploads/2022/05/image-10.png" style="max-width:800px;height:auto;width:auto;" width="748"/></a><figcaption>Figure 10: A different sleep time for every situation</figcaption></figure>
<p>There is also a “Second Sleep” state that puts the program on sleep mode a different amount of time.</p>
<h3>RECEIVE</h3>
<p>This state is used to receiving commands from the C&amp;C servers. Commands are sent using the IP address field that is returned by the DNS requests. Further details about the communication protocol are provided later in this report. In a nutshell, every DNS request is capable of receiving 4 bytes. The backdoor will concatenate responses, building buffers in that way. These buffers will contain the commands that the backdoor will execute.</p>
<h3>DO (DoTask)</h3>
<p>That state will execute commands received from the server. The backdoor has capabilities like executing remote pre-established commands, custom commands or dropping files. The communication supports compression, also. The following figure shows the list of possible commands that can be executed by the backdoor. </p>
<figure class="wp-block-table is-style-stripes"><table><thead><tr><th>ID </th><th>Type </th><th>Command</th></tr></thead><tbody><tr><td>1</td><td>PS</td><td>Get-NetIPAddress -AddressFamily IPv4 | Select-Object IPAddress</td></tr><tr><td>2</td><td>PS</td><td>Get-NetNeighbor -AddressFamily IPv4 | Select-Object “IPADDress”</td></tr><tr><td>3</td><td>CMD </td><td>whoami</td></tr><tr><td>4</td><td>PS</td><td>[System.Environment]::OSVersion.VersionString</td></tr><tr><td>5</td><td>CMD</td><td>net user</td></tr><tr><td>6</td><td>—</td><td>———[NOT USED]———</td></tr><tr><td>7</td><td>PS</td><td>Get-ChildItem -Path “C:\Program Files” | Select-Object Name</td></tr><tr><td>8</td><td>PS</td><td>Get-ChildItem -Path ‘C:\Program Files (x86)’ | Select-Object Name</td></tr><tr><td>9</td><td>PS</td><td>Get-ChildItem -Path ‘C:’ | Select-Object Name</td></tr><tr><td>10</td><td>CMD</td><td>hostname</td></tr><tr><td>11</td><td>PS</td><td>Get-NetTCPConnection | Where-Object {$_.State -eq “Established”} | Select-Object “LocalAddress”, “LocalPort”, “RemoteAddress”, “RemotePort”</td></tr><tr><td>12</td><td>PS</td><td>$(ping -n 1 10.65.4.50 | findstr /i ttl) -eq $null;$(ping -n 1 10.65.4.51 | findstr /i ttl) -eq $null;$(ping -n 1 10.65.65.65 | findstr /i ttl) -eq $null;$(ping -n 1 10.65.53.53 | findstr /i ttl) -eq $null;$(ping -n 1 10.65.21.200 | findstr /i ttl) -eq $null</td></tr><tr><td>13</td><td>PS</td><td>nslookup ise-posture.mofagov.gover.local | findstr /i Address;nslookup webmail.gov.jo | findstr /i Address</td></tr><tr><td>14</td><td>PS</td><td>$(ping -n 1 10.10.21.201 | findstr /i ttl) -eq $null;$(ping -n 1 10.10.19.201 | findstr /i ttl) -eq $null;$(ping -n 1 10.10.19.202 | findstr /i ttl) -eq $null;$(ping -n 1 10.10.24.200 | findstr /i ttl) -eq $null</td></tr><tr><td>15</td><td>PS</td><td>$(ping -n 1 10.10.10.4 | findstr /i ttl) -eq $null;$(ping -n 1 10.10.50.10 | findstr /i ttl) -eq $null;$(ping -n 1 10.10.22.50 | findstr /i ttl) -eq $null;$(ping -n 1 10.10.45.19 | findstr /i ttl) -eq $null</td></tr><tr><td>16</td><td>PS</td><td>$(ping -n 1 10.65.51.11 | findstr /i ttl) -eq $null;$(ping -n 1 10.65.6.1 | findstr /i ttl) -eq $null;$(ping -n 1 10.65.52.200 | findstr /i ttl) -eq $null;$(ping -n 1 10.65.6.3 | findstr /i ttl) -eq $null</td></tr><tr><td>17</td><td>PS</td><td>$(ping -n 1 10.65.45.18 | findstr /i ttl) -eq $null;$(ping -n 1 10.65.28.41 | findstr /i ttl) -eq $null;$(ping -n 1 10.65.36.13 | findstr /i ttl) -eq $null;$(ping -n 1 10.65.51.10 | findstr /i ttl) -eq $null</td></tr><tr><td>18</td><td>PS</td><td>$(ping -n 1 10.10.22.42 | findstr /i ttl) -eq $null;$(ping -n 1 10.10.23.200 | findstr /i ttl) -eq $null;$(ping -n 1 10.10.45.19 | findstr /i ttl) -eq $null;$(ping -n 1 10.10.19.50 | findstr /i ttl) -eq $null</td></tr><tr><td>19</td><td>PS</td><td>$(ping -n 1 10.65.45.3 | findstr /i ttl) -eq $null;$(ping -n 1 10.65.4.52 | findstr /i ttl) -eq $null;$(ping -n 1 10.65.31.155 | findstr /i ttl) -eq $null;$(ping -n 1 ise-posture.mofagov.gover.local | findstr /i ttl) -eq $null</td></tr><tr><td>20</td><td>PS</td><td>Get-NetIPConfiguration | Foreach IPv4DefaultGateway | Select-Object NextHop</td></tr><tr><td>21</td><td>PS</td><td>Get-DnsClientServerAddress -AddressFamily IPv4 | Select-Object SERVERAddresses</td></tr><tr><td>22</td><td>CMD</td><td>systeminfo | findstr /i \”Domain\”</td></tr></tbody></table><figcaption>Figure 11: List of predefined commands</figcaption></figure>
<p>It is pretty shocking to see that even when attackers have the possibility of sending any command, they choose to add that predefined list in the backdoor in Base64 format. As we can see, some of them are common reconnaissance snippets, but some of them are not that common. In fact, some of the commands contain internal IPs and also internal domain names (like ise-posture.mofagov.gover.local). That shows that this malware was clearly targeted and also indicates that the actor has some previous knowledge about the internal infrastructure of the victim.</p>
<h3>SEND – SEND AND RECEIVE</h3>
<p>The Send state is used to send the results generated by commands to the actor’s server. In this case, the name of the subdomain will contain the data. As domain names are used to exfiltrate unknown amounts of data, attackers had to split this data in different buffers. Every buffer is then sent through a different DNS request. As it can be seen in the Figure 12, all the required information in order to reconstruct original data is sent to the attackers. The size of the buffer is only sent in the first packet. </p>
<figure class="aligncenter size-full"><a href="https://blog.malwarebytes.com/wp-content/uploads/2022/05/image-13.png" title=""><img alt="" class="wp-image-56536" height="292" src="https://blog.malwarebytes.com/wp-content/uploads/2022/05/image-13.png" style="max-width:800px;height:auto;width:auto;" width="1065"/></a><figcaption>Figure 12: Send data to server</figcaption></figure>
<h2>Attribution</h2>
<p>There are several indicators that suggest that this campaign has been operated by APT34. </p>
<ul><li>Maldoc similarity: The madoc used in this campaign shared some similarities with maldocs used in previous campaigns of this actor. More specifically similar to what was mentioned in CheckPoint’s <a href="https://research.checkpoint.com/2021/irans-apt34-returns-with-an-updated-arsenal/">report</a> this maldoc registers a scheduled task that would launch the executable every X minutes, also it uses the same anti sandboxing technique (checking if there is a mouse connected to the PC or not). Finally, we see a similar pattern to beacon back to the attacker server and inform the attacker about the current stage of execution.</li><li>Victims similarity: The group is known to target the government of Jordan and this is the case in this campaign. </li><li>Payload similarity: DNS is the most common method used by<a href="https://attack.mitre.org/groups/G0049/"> APT34 for its C&amp;C communications</a>. The group is also known to use uncommon encodings such as Base32 and Base36 in its previous campaigns. The Saitama backdoor uses a similar Base32 encoding for sending data to the servers that is used by <a href="https://blog.talosintelligence.com/2018/11/dnspionage-campaign-targets-middle-east.html">DNSpionage</a>. Also, to build subdomains it uses Base32 encoding that is similar to what was reported by <a href="https://www.mandiant.com/resources/targeted-attacks">Mandiant</a>. 
</li></ul>
<p>Malwarebytes customers are protected from this attack via our Anti-Exploit layer.</p>
<figure class="aligncenter size-full"><a href="https://blog.malwarebytes.com/wp-content/uploads/2022/05/block-2.png" title=""><img alt="" class="wp-image-56544" height="940" src="https://blog.malwarebytes.com/wp-content/uploads/2022/05/block-2.png" style="max-width:800px;height:auto;width:auto;" width="1850"/></a></figure>
<h2>IOCs</h2>
<p>Maldoc:
Confirmation Receive Document.xls
26884f872f4fae13da21fa2a24c24e963ee1eb66da47e270246d6d9dc7204c2b 
Saitama backdoor:
update.exe
e0872958b8d3824089e5e1cfab03d9d98d22b9bcb294463818d721380075a52d
C2s:
uber-asia.com
asiaworldremit.com 
joexpediagroup.com</p>
<p>SHARE THIS ARTICLE</p>
<a class="socicon-facebook" href="http://www.facebook.com/sharer.php?u=https%3A%2F%2Fblog.malwarebytes.com%2F%3Fp%3D56462&amp;t=APT34+targets+Jordan+Government+using+new+Saitama+backdoor" id="social-share-facebook" target="_blank"></a>
<a class="socicon-twitter" href="https://twitter.com/intent/tweet?text=APT34+targets+Jordan+Government+using+new+Saitama+backdoor+https%3A%2F%2Fblog.malwarebytes.com%2F%3Fp%3D56462&amp;via=Malwarebytes" id="social-share-twitter" target="_blank"></a>
<a class="socicon-linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3A%2F%2Fblog.malwarebytes.com%2F%3Fp%3D56462&amp;title=APT34+targets+Jordan+Government+using+new+Saitama+backdoor&amp;summary=&amp;source=" id="social-share-linkedin" target="_blank"></a>
<p>ABOUT THE AUTHOR</p>
<img alt="" class="avatar avatar-96 photo grav-hashed grav-hijack" height="96" id="grav-147cd7280d6ece931e4488a3a10809d9-0" src="https://secure.gravatar.com/avatar/147cd7280d6ece931e4488a3a10809d9?s=96&amp;d=identicon&amp;r=g" width="96"/>
<p>
<a href="https://blog.malwarebytes.com/author/threatintelligence/" rel="author" title="Posts by Threat Intelligence Team">Threat Intelligence Team</a>
</p>
<p></p>
</div>