{"id": "sentence_0x967229f5", "report_id": "report_0x3dfa49e7", "report_date": "2022-05-16T00:00:00Z", "report_title": "Emotet takes the 64-bit Route", "report_url": "https://labs.k7computing.com/index.php/emotet-takes-the-64-bit-route", "chapter_id": "chapter_0xcd0be642", "chapter_title": "Emotet takes the 64-bit Route", "text": "By Rajesh RMay 16, 2022"}
{"id": "sentence_0xfd8f3db6", "report_id": "report_0x3dfa49e7", "report_date": "2022-05-16T00:00:00Z", "report_title": "Emotet takes the 64-bit Route", "report_url": "https://labs.k7computing.com/index.php/emotet-takes-the-64-bit-route", "chapter_id": "chapter_0xcd0be642", "chapter_title": "Emotet takes the 64-bit Route", "text": "Emotet is a downloader malware which has been used in many spam campaigns. A couple of weeks back my colleague uncovered the delivery mechanism and the initial components of the Emotet kill chain in this blog. We noticed that Emotet has been actively evolving its delivery mechanism to avoid detection. In 2019, right before the take down, it changed its payload from EXE to DLL. Right after that, botnets like Qbot and IcedID followed this pattern. In the week prior to writing this blog, we observed Emotet making a sudden shift to 64-bit payloads. However, there is no change in its overall kill chain."}
{"id": "sentence_0xac72f6d7", "report_id": "report_0x3dfa49e7", "report_date": "2022-05-16T00:00:00Z", "report_title": "Emotet takes the 64-bit Route", "report_url": "https://labs.k7computing.com/index.php/emotet-takes-the-64-bit-route", "chapter_id": "chapter_0xcd0be642", "chapter_title": "Emotet takes the 64-bit Route", "text": "Figure 1: Emotet workflow"}
{"id": "sentence_0x5da6f87d", "report_id": "report_0x3dfa49e7", "report_date": "2022-05-16T00:00:00Z", "report_title": "Emotet takes the 64-bit Route", "report_url": "https://labs.k7computing.com/index.php/emotet-takes-the-64-bit-route", "chapter_id": "chapter_0xcd0be642", "chapter_title": "Emotet takes the 64-bit Route", "text": "Figure 2: Emotet payload unpack flow"}
{"id": "sentence_0xea794f0", "report_id": "report_0x3dfa49e7", "report_date": "2022-05-16T00:00:00Z", "report_title": "Emotet takes the 64-bit Route", "report_url": "https://labs.k7computing.com/index.php/emotet-takes-the-64-bit-route", "chapter_id": "chapter_0xa4e52da1", "chapter_title": "Emotet takes the 64-bit Route", "text": "Downloaders"}
{"id": "sentence_0xc8577940", "report_id": "report_0x3dfa49e7", "report_date": "2022-05-16T00:00:00Z", "report_title": "Emotet takes the 64-bit Route", "report_url": "https://labs.k7computing.com/index.php/emotet-takes-the-64-bit-route", "chapter_id": "chapter_0xa4e52da1", "chapter_title": "Emotet takes the 64-bit Route", "text": "Spam"}
{"id": "sentence_0x248bb9bd", "report_id": "report_0x3dfa49e7", "report_date": "2022-05-16T00:00:00Z", "report_title": "Emotet takes the 64-bit Route", "report_url": "https://labs.k7computing.com/index.php/emotet-takes-the-64-bit-route", "chapter_id": "chapter_0x1fc92d28", "chapter_title": "First level payload (Custom packed)", "text": "The first level payload was a 64-bit DLL executed by the spam document having the Emotet payload using regsvr32.exe. First level payload was a custom packed DLL with a lot of random export functions with junk code. The malicious component was found only in WinMain and DllRegisterServer functions."}
{"id": "sentence_0x9b2f9769", "report_id": "report_0x3dfa49e7", "report_date": "2022-05-16T00:00:00Z", "report_title": "Emotet takes the 64-bit Route", "report_url": "https://labs.k7computing.com/index.php/emotet-takes-the-64-bit-route", "chapter_id": "chapter_0x1fc92d28", "chapter_title": "First level payload (Custom packed)", "text": "Figure 3: 64bit Custom packed DLL export functions"}
{"id": "sentence_0x1dd22fba", "report_id": "report_0x3dfa49e7", "report_date": "2022-05-16T00:00:00Z", "report_title": "Emotet takes the 64-bit Route", "report_url": "https://labs.k7computing.com/index.php/emotet-takes-the-64-bit-route", "chapter_id": "chapter_0x1fc92d28", "chapter_title": "First level payload (Custom packed)", "text": "The main function contains a lot of byte variables containing encrypted shell code which then allocates heap memory with PAGE_EXECTUABLE_READWRITE permission and proceeds to decrypt and execute the shell code."}
{"id": "sentence_0x29dc5ac1", "report_id": "report_0x3dfa49e7", "report_date": "2022-05-16T00:00:00Z", "report_title": "Emotet takes the 64-bit Route", "report_url": "https://labs.k7computing.com/index.php/emotet-takes-the-64-bit-route", "chapter_id": "chapter_0x1fc92d28", "chapter_title": "First level payload (Custom packed)", "text": "Figure 4: Shell code decryption by custom packed DLL"}
{"id": "sentence_0xe59a3fc4", "report_id": "report_0x3dfa49e7", "report_date": "2022-05-16T00:00:00Z", "report_title": "Emotet takes the 64-bit Route", "report_url": "https://labs.k7computing.com/index.php/emotet-takes-the-64-bit-route", "chapter_id": "chapter_0xf40ea2b5", "chapter_title": "Second level payload (Shell code)", "text": "The shell codes purpose is to load the DLL and API used in the next level of the payload, which decrypts the Emotets core payload."}
{"id": "sentence_0x35568bb1", "report_id": "report_0x3dfa49e7", "report_date": "2022-05-16T00:00:00Z", "report_title": "Emotet takes the 64-bit Route", "report_url": "https://labs.k7computing.com/index.php/emotet-takes-the-64-bit-route", "chapter_id": "chapter_0xf40ea2b5", "chapter_title": "Second level payload (Shell code)", "text": "Figure 5: Shell code load encrypted data from resource section"}
{"id": "sentence_0xdf53cfbd", "report_id": "report_0x3dfa49e7", "report_date": "2022-05-16T00:00:00Z", "report_title": "Emotet takes the 64-bit Route", "report_url": "https://labs.k7computing.com/index.php/emotet-takes-the-64-bit-route", "chapter_id": "chapter_0xf40ea2b5", "chapter_title": "Second level payload (Shell code)", "text": "The shell codes function was to decrypt and execute the 64-bit DLL payload which has Emotets main functionality. In order to avoid detection, the shell code copies the decrypted DLL file content to a heap memory without the DOS header. It then sets permission to regions of the copied file based on PE sections characteristics in the section header having the partial copied file using VirtualProtect API."}
{"id": "sentence_0x83626ba5", "report_id": "report_0x3dfa49e7", "report_date": "2022-05-16T00:00:00Z", "report_title": "Emotet takes the 64-bit Route", "report_url": "https://labs.k7computing.com/index.php/emotet-takes-the-64-bit-route", "chapter_id": "chapter_0xf40ea2b5", "chapter_title": "Second level payload (Shell code)", "text": "Figure 6: Decrypt third level payload which is Emotets main DLL"}
{"id": "sentence_0x677e443", "report_id": "report_0x3dfa49e7", "report_date": "2022-05-16T00:00:00Z", "report_title": "Emotet takes the 64-bit Route", "report_url": "https://labs.k7computing.com/index.php/emotet-takes-the-64-bit-route", "chapter_id": "chapter_0xf40ea2b5", "chapter_title": "Second level payload (Shell code)", "text": "Figure 7: Copy decrypted PE file without DOS header to another heap memory"}
{"id": "sentence_0x882b5968", "report_id": "report_0x3dfa49e7", "report_date": "2022-05-16T00:00:00Z", "report_title": "Emotet takes the 64-bit Route", "report_url": "https://labs.k7computing.com/index.php/emotet-takes-the-64-bit-route", "chapter_id": "chapter_0xf40ea2b5", "chapter_title": "Second level payload (Shell code)", "text": "Figure 8: Partially Copied PE file"}
{"id": "sentence_0xef6184da", "report_id": "report_0x3dfa49e7", "report_date": "2022-05-16T00:00:00Z", "report_title": "Emotet takes the 64-bit Route", "report_url": "https://labs.k7computing.com/index.php/emotet-takes-the-64-bit-route", "chapter_id": "chapter_0xf40ea2b5", "chapter_title": "Second level payload (Shell code)", "text": "Then the shell code executes the main function of the third level DLL (partially copied DLL) which only checks the parameter and returns to the shell code. With this the main function and shell code execution is completed. After this regsvr32.exe executes the DllRegisterServer of first level Emotet export function which in turn executes the third level DllRegisterServer."}
{"id": "sentence_0x6469a21b", "report_id": "report_0x3dfa49e7", "report_date": "2022-05-16T00:00:00Z", "report_title": "Emotet takes the 64-bit Route", "report_url": "https://labs.k7computing.com/index.php/emotet-takes-the-64-bit-route", "chapter_id": "chapter_0xf40ea2b5", "chapter_title": "Second level payload (Shell code)", "text": "Figure 9: Execution of third level payload from first level DLL"}
{"id": "sentence_0x6af599a2", "report_id": "report_0x3dfa49e7", "report_date": "2022-05-16T00:00:00Z", "report_title": "Emotet takes the 64-bit Route", "report_url": "https://labs.k7computing.com/index.php/emotet-takes-the-64-bit-route", "chapter_id": "chapter_0xf40ea2b5", "chapter_title": "Second level payload (Shell code)", "text": "Emotet uses the control flow flattening technique to execute functions. All the function flow works based on setting random values in variables. After every function value is changed it checks the value and finds the next function to execute. Flow diagram of the control flow flattening is as shown below"}
{"id": "sentence_0x70cd863a", "report_id": "report_0x3dfa49e7", "report_date": "2022-05-16T00:00:00Z", "report_title": "Emotet takes the 64-bit Route", "report_url": "https://labs.k7computing.com/index.php/emotet-takes-the-64-bit-route", "chapter_id": "chapter_0xf40ea2b5", "chapter_title": "Second level payload (Shell code)", "text": "Figure 10: Control flow flattening flow graph"}
{"id": "sentence_0xd97fa3a5", "report_id": "report_0x3dfa49e7", "report_date": "2022-05-16T00:00:00Z", "report_title": "Emotet takes the 64-bit Route", "report_url": "https://labs.k7computing.com/index.php/emotet-takes-the-64-bit-route", "chapter_id": "chapter_0xf40ea2b5", "chapter_title": "Second level payload (Shell code)", "text": "Emotet also uses different functions for each API call. Every time it searches the API from PEB memory, It changes the windows DLL export name into a hash value to find the required API."}
{"id": "sentence_0xc7969d1d", "report_id": "report_0x3dfa49e7", "report_date": "2022-05-16T00:00:00Z", "report_title": "Emotet takes the 64-bit Route", "report_url": "https://labs.k7computing.com/index.php/emotet-takes-the-64-bit-route", "chapter_id": "chapter_0xf40ea2b5", "chapter_title": "Second level payload (Shell code)", "text": "Figure 11: Get API address from loaded memory"}
{"id": "sentence_0x6d07899d", "report_id": "report_0x3dfa49e7", "report_date": "2022-05-16T00:00:00Z", "report_title": "Emotet takes the 64-bit Route", "report_url": "https://labs.k7computing.com/index.php/emotet-takes-the-64-bit-route", "chapter_id": "chapter_0xf40ea2b5", "chapter_title": "Second level payload (Shell code)", "text": "Every string used in the Emotet for API argument is decrypted at the time it is needed and removed from memory after it is used. Below is the screenshot of string %s %s, used in string concatenation, being decrypted."}
{"id": "sentence_0x7bcd6dc9", "report_id": "report_0x3dfa49e7", "report_date": "2022-05-16T00:00:00Z", "report_title": "Emotet takes the 64-bit Route", "report_url": "https://labs.k7computing.com/index.php/emotet-takes-the-64-bit-route", "chapter_id": "chapter_0xf40ea2b5", "chapter_title": "Second level payload (Shell code)", "text": "Figure 12: String decryption loop"}
{"id": "sentence_0x505a0f20", "report_id": "report_0x3dfa49e7", "report_date": "2022-05-16T00:00:00Z", "report_title": "Emotet takes the 64-bit Route", "report_url": "https://labs.k7computing.com/index.php/emotet-takes-the-64-bit-route", "chapter_id": "chapter_0xf40ea2b5", "chapter_title": "Second level payload (Shell code)", "text": "Emotet then copies itself to the ProgramData folder on its first run. It does so by comparing GetSystemTimeAsFileTime and GetFileInformationByHandleEx(_FILE_BASIC_INFO) with a constant value. Based on the result, the Emotet binary is self-copied in the folder ProgramData and deletes the Zone.Identifier component of the copied file or executes the Emotets main functionality. GetFileInformationByHandleEx(_FILE_BASIC_INFO) is used to retrieve file creation time from the zone identifier. Now the copied file will be less than the saved constant value."}
{"id": "sentence_0x34b37369", "report_id": "report_0x3dfa49e7", "report_date": "2022-05-16T00:00:00Z", "report_title": "Emotet takes the 64-bit Route", "report_url": "https://labs.k7computing.com/index.php/emotet-takes-the-64-bit-route", "chapter_id": "chapter_0xf40ea2b5", "chapter_title": "Second level payload (Shell code)", "text": "Figure 13: Delete zone identifier of copied file"}
{"id": "sentence_0x8c5df76a", "report_id": "report_0x3dfa49e7", "report_date": "2022-05-16T00:00:00Z", "report_title": "Emotet takes the 64-bit Route", "report_url": "https://labs.k7computing.com/index.php/emotet-takes-the-64-bit-route", "chapter_id": "chapter_0xf40ea2b5", "chapter_title": "Second level payload (Shell code)", "text": "It then collects following information from the victims system"}
{"id": "sentence_0x28187b98", "report_id": "report_0x3dfa49e7", "report_date": "2022-05-16T00:00:00Z", "report_title": "Emotet takes the 64-bit Route", "report_url": "https://labs.k7computing.com/index.php/emotet-takes-the-64-bit-route", "chapter_id": "chapter_0xf40ea2b5", "chapter_title": "Second level payload (Shell code)", "text": "Computer name Volume information of OS directory RtlGetVersion System native information Malware execution path with file name"}
{"id": "sentence_0xef504f7c", "report_id": "report_0x3dfa49e7", "report_date": "2022-05-16T00:00:00Z", "report_title": "Emotet takes the 64-bit Route", "report_url": "https://labs.k7computing.com/index.php/emotet-takes-the-64-bit-route", "chapter_id": "chapter_0xf40ea2b5", "chapter_title": "Second level payload (Shell code)", "text": "All the collected information is encrypted using the Elliptic Curve Cryptography Algorithm. Following API flow is used to encrypt the data. Finally, they convert the encrypted data to base64."}
{"id": "sentence_0xedc2742a", "report_id": "report_0x3dfa49e7", "report_date": "2022-05-16T00:00:00Z", "report_title": "Emotet takes the 64-bit Route", "report_url": "https://labs.k7computing.com/index.php/emotet-takes-the-64-bit-route", "chapter_id": "chapter_0xf40ea2b5", "chapter_title": "Second level payload (Shell code)", "text": "BCryptOpenAlgorithmProvider BcryptDeriveKey BcryptGetproperty BCryptImportKey BcryptGetproperty BCryptCreateHash BCryptHashData BCryptEncrypt CryptBinaryToStringW"}
{"id": "sentence_0xb1fb0f84", "report_id": "report_0x3dfa49e7", "report_date": "2022-05-16T00:00:00Z", "report_title": "Emotet takes the 64-bit Route", "report_url": "https://labs.k7computing.com/index.php/emotet-takes-the-64-bit-route", "chapter_id": "chapter_0xf40ea2b5", "chapter_title": "Second level payload (Shell code)", "text": "Figure 14: Encrypt user information"}
{"id": "sentence_0xf79ac28", "report_id": "report_0x3dfa49e7", "report_date": "2022-05-16T00:00:00Z", "report_title": "Emotet takes the 64-bit Route", "report_url": "https://labs.k7computing.com/index.php/emotet-takes-the-64-bit-route", "chapter_id": "chapter_0xeab948f4", "chapter_title": "C2 communication", "text": "This third level payload decrypts a self-contained list of IP addresses which is used for C2 communication."}
{"id": "sentence_0x182a8e0c", "report_id": "report_0x3dfa49e7", "report_date": "2022-05-16T00:00:00Z", "report_title": "Emotet takes the 64-bit Route", "report_url": "https://labs.k7computing.com/index.php/emotet-takes-the-64-bit-route", "chapter_id": "chapter_0xeab948f4", "chapter_title": "C2 communication", "text": "The converted base64 data is sent to the C&C."}
{"id": "sentence_0xf50c3e5f", "report_id": "report_0x3dfa49e7", "report_date": "2022-05-16T00:00:00Z", "report_title": "Emotet takes the 64-bit Route", "report_url": "https://labs.k7computing.com/index.php/emotet-takes-the-64-bit-route", "chapter_id": "chapter_0xeab948f4", "chapter_title": "C2 communication", "text": "Following APIs are used for C&C communication"}
{"id": "sentence_0x86f5b9b1", "report_id": "report_0x3dfa49e7", "report_date": "2022-05-16T00:00:00Z", "report_title": "Emotet takes the 64-bit Route", "report_url": "https://labs.k7computing.com/index.php/emotet-takes-the-64-bit-route", "chapter_id": "chapter_0xeab948f4", "chapter_title": "C2 communication", "text": "HttpOpenRequestW InternetOpenW InternetConnectW InternetQueryOptionW InternetSetOptionW InternetSendRequestW"}
{"id": "sentence_0x561eac44", "report_id": "report_0x3dfa49e7", "report_date": "2022-05-16T00:00:00Z", "report_title": "Emotet takes the 64-bit Route", "report_url": "https://labs.k7computing.com/index.php/emotet-takes-the-64-bit-route", "chapter_id": "chapter_0xeab948f4", "chapter_title": "C2 communication", "text": "Figure 15: Send user data to C&C"}
{"id": "sentence_0x10afd074", "report_id": "report_0x3dfa49e7", "report_date": "2022-05-16T00:00:00Z", "report_title": "Emotet takes the 64-bit Route", "report_url": "https://labs.k7computing.com/index.php/emotet-takes-the-64-bit-route", "chapter_id": "chapter_0xeab948f4", "chapter_title": "C2 communication", "text": "After this stage, emotet is known to use Cobalt Strike beacons to deploy ransomware payloads."}
{"id": "sentence_0xe2ea37ad", "report_id": "report_0x3dfa49e7", "report_date": "2022-05-16T00:00:00Z", "report_title": "Emotet takes the 64-bit Route", "report_url": "https://labs.k7computing.com/index.php/emotet-takes-the-64-bit-route", "chapter_id": "chapter_0xeab948f4", "chapter_title": "C2 communication", "text": "In K7labs we keep on monitoring Emotet and its changes, we detect it in every layer like core malware behavior to custom packer."}
{"id": "sentence_0x6f17cdeb", "report_id": "report_0x3dfa49e7", "report_date": "2022-05-16T00:00:00Z", "report_title": "Emotet takes the 64-bit Route", "report_url": "https://labs.k7computing.com/index.php/emotet-takes-the-64-bit-route", "chapter_id": "chapter_0xd97eb250", "chapter_title": "Indicators of Compromise (IOCs)", "text": "SHA256: 7ba37f9a23ec25972d767bbc32a1eb5b3840455bac9b93fddc5d81fd3d21b261"}
{"id": "sentence_0xaa22ba67", "report_id": "report_0x3dfa49e7", "report_date": "2022-05-16T00:00:00Z", "report_title": "Emotet takes the 64-bit Route", "report_url": "https://labs.k7computing.com/index.php/emotet-takes-the-64-bit-route", "chapter_id": "chapter_0xae97f1a7", "chapter_title": "Like what you're reading? Subscribe to our top stories.", "text": "If you want to subscribe to our monthly newsletter, please submit the form below."}
{"id": "sentence_0xac689cac", "report_id": "report_0x3dfa49e7", "report_date": "2022-05-16T00:00:00Z", "report_title": "Emotet takes the 64-bit Route", "report_url": "https://labs.k7computing.com/index.php/emotet-takes-the-64-bit-route", "chapter_id": "chapter_0xae97f1a7", "chapter_title": "Like what you're reading? Subscribe to our top stories.", "text": "Email* :"}
{"id": "sentence_0x81825d19", "report_id": "report_0x3dfa49e7", "report_date": "2022-05-16T00:00:00Z", "report_title": "Emotet takes the 64-bit Route", "report_url": "https://labs.k7computing.com/index.php/emotet-takes-the-64-bit-route", "chapter_id": "chapter_0xae97f1a7", "chapter_title": "Like what you're reading? Subscribe to our top stories.", "text": "Previous Post Play Store App Serves Teabot Via GitHub Next Post"}
