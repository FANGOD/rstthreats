<div>
<img alt="" class="hidden-social-img" src="https://labs.k7computing.com/wp-content/uploads/2022/05/Emotet.png" style="max-width:80%;height:auto;width:auto;"/>
<a class="uncategorized" href="https://labs.k7computing.com/index.php/category/downloaders/">Downloaders</a><a class="uncategorized" href="https://labs.k7computing.com/index.php/category/spam/">Spam</a>
<h1 class="entry-title">Emotet takes the 64-bit Route</h1>
By Rajesh RMay 16, 2022
 
<p></p><p>Emotet is a downloader malware which has been used in many spam campaigns. A couple of weeks back my colleague uncovered the delivery mechanism and the initial components of the Emotet kill chain in this <a href="https://labs.k7computing.com/index.php/diving-into-the-emotet-maldoc-boutade/" rel="noopener" target="_blank">blog</a>. We noticed that Emotet has been actively evolving its delivery mechanism to avoid detection. In 2019, right before the take down, it changed its payload from EXE to DLL. Right after that, botnets like Qbot and IcedID followed this pattern. In the week prior to writing this blog, we observed Emotet making a sudden shift to 64-bit payloads. However, there is no change in its overall kill chain. </p>
<figure class="wp-caption aligncenter" id="attachment_24003"><img alt="" class="wp-image-24003 size-full" height="166" src="https://labs.k7computing.com/wp-content/uploads/2022/05/Figure1-2.png" width="572"/><figcaption class="wp-caption-text" id="caption-attachment-24003">Figure 1: Emotet workflow</figcaption></figure>
<figure class="wp-caption aligncenter" id="attachment_24004"><img alt="" class="wp-image-24004 size-full" height="177" src="https://labs.k7computing.com/wp-content/uploads/2022/05/figure2-2.png" width="469"/><figcaption class="wp-caption-text" id="caption-attachment-24004">Figure 2: Emotet payload unpack flow</figcaption></figure>
<h3>First level payload (Custom packed)</h3>
<p>The first level payload was a 64-bit DLL executed by the spam document having the Emotet payload using regsvr32.exe. First level payload was a custom packed DLL with a lot of random export functions with junk code. The malicious component was found only in WinMain and DllRegisterServer functions. </p>
<figure class="wp-caption aligncenter" id="attachment_24005"><img alt="" class="wp-image-24005 size-full" height="504" src="https://labs.k7computing.com/wp-content/uploads/2022/05/figure3-2.png" width="488"/><figcaption class="wp-caption-text" id="caption-attachment-24005">Figure 3: 64bit Custom packed DLL export functions</figcaption></figure>
<p>The main function contains a lot of byte variables containing encrypted shell code which then allocates heap memory with “PAGE_EXECTUABLE_READWRITE” permission and proceeds to decrypt and execute the shell code.</p>
<figure class="wp-caption aligncenter" id="attachment_24006"><img alt="" class="wp-image-24006 size-full" height="544" src="https://labs.k7computing.com/wp-content/uploads/2022/05/figure4-2.png" width="404"/><figcaption class="wp-caption-text" id="caption-attachment-24006">Figure 4: Shell code decryption by custom packed DLL</figcaption></figure>
<h3>Second level payload (Shell code) </h3>
<p>The shell code’s purpose is to load the DLL and API used in the next level of the payload, which decrypts the Emotet’s core payload.</p>
<p> </p>
<figure class="wp-caption aligncenter" id="attachment_24007"><img alt="" class="wp-image-24007 size-full" height="442" src="https://labs.k7computing.com/wp-content/uploads/2022/05/figure5-2.png" width="611"/><figcaption class="wp-caption-text" id="caption-attachment-24007">Figure 5: Shell code load encrypted data from resource section</figcaption></figure>
<p>The shell code’s function was to decrypt and execute the 64-bit DLL payload which has Emotet’s main functionality. In order to avoid detection, the shell code copies the decrypted DLL file content to a heap memory without the DOS header. It then sets permission to regions of the copied file based on PE sections characteristics in the section header having the partial copied file using VirtualProtect API.</p>
<figure class="wp-caption aligncenter" id="attachment_24008"><img alt="" class="wp-image-24008 size-full" height="530" src="https://labs.k7computing.com/wp-content/uploads/2022/05/figure6-3.png" style="max-width:800px;height:auto;width:auto;" width="703"/><figcaption class="wp-caption-text" id="caption-attachment-24008">Figure 6: Decrypt third level payload which is Emotet’s main DLL</figcaption></figure>
<figure class="wp-caption aligncenter" id="attachment_24009"><img alt="" class="wp-image-24009 size-full" height="418" src="https://labs.k7computing.com/wp-content/uploads/2022/05/figure7-2.png" style="max-width:800px;height:auto;width:auto;" width="696"/><figcaption class="wp-caption-text" id="caption-attachment-24009">Figure 7: Copy decrypted PE file without DOS header to another heap memory</figcaption></figure>
<figure class="wp-caption aligncenter" id="attachment_24010"><img alt="" class="wp-image-24010 size-full" height="637" src="https://labs.k7computing.com/wp-content/uploads/2022/05/figure8-2.png" style="max-width:800px;height:auto;width:auto;" width="785"/><figcaption class="wp-caption-text" id="caption-attachment-24010">Figure 8: Partially Copied PE file</figcaption></figure>
<p>Then the shell code executes the main function of the third level DLL (partially copied DLL) which only checks the parameter and returns to the shell code. With this the main function and shell code execution is completed. After this regsvr32.exe executes the “DllRegisterServer” of first level Emotet export function which in turn executes the third level “DllRegisterServer”. </p>
<figure class="wp-caption aligncenter" id="attachment_24011"><img alt="" class="wp-image-24011 size-full" height="342" src="https://labs.k7computing.com/wp-content/uploads/2022/05/figure9-2.png" width="498"/><figcaption class="wp-caption-text" id="caption-attachment-24011">Figure 9: Execution of third level payload from first level DLL</figcaption></figure>
<p>Emotet uses the control flow flattening technique to execute functions. All the function flow works based on setting random values in variables. After every function value is changed it checks the value and finds the next function to execute. Flow diagram of the control flow flattening is as shown below</p>
<figure class="wp-caption aligncenter" id="attachment_24012"><img alt="" class="wp-image-24012 size-full" height="543" src="https://labs.k7computing.com/wp-content/uploads/2022/05/figure10-2.png" width="578"/><figcaption class="wp-caption-text" id="caption-attachment-24012">Figure 10: Control flow flattening flow graph</figcaption></figure>
<p>Emotet also uses different functions for each API call. Every time it searches the API from PEB memory, It changes the windows DLL export name into a hash value to find the required API.</p>
<figure class="wp-caption aligncenter" id="attachment_24013"><img alt="" class="wp-image-24013 size-full" height="547" src="https://labs.k7computing.com/wp-content/uploads/2022/05/figure11-1.png" style="max-width:800px;height:auto;width:auto;" width="779"/><figcaption class="wp-caption-text" id="caption-attachment-24013">Figure 11: Get API address from loaded memory</figcaption></figure>
<p>Every string used in the Emotet for API argument is decrypted at the time it is needed and removed from memory after it is used. Below is the screenshot of string “%s %s”, used in string concatenation, being decrypted.</p>
<figure class="wp-caption aligncenter" id="attachment_24014"><img alt="" class="wp-image-24014 size-full" height="403" src="https://labs.k7computing.com/wp-content/uploads/2022/05/figure12-1.png" width="555"/><figcaption class="wp-caption-text" id="caption-attachment-24014">Figure 12: String decryption loop</figcaption></figure>
<p>Emotet then copies itself to the ProgramData folder on its first run. It does so by comparing GetSystemTimeAsFileTime and GetFileInformationByHandleEx(_FILE_BASIC_INFO) with a constant value. Based on the result, the Emotet binary is self-copied in the folder ProgramData and deletes the “Zone.Identifier” component of the copied file or executes the Emotet’s main functionality. GetFileInformationByHandleEx(_FILE_BASIC_INFO) is used to retrieve file creation time from the zone identifier. Now the copied file will be less than the saved constant value.</p>
<figure class="wp-caption aligncenter" id="attachment_24015"><img alt="" class="wp-image-24015 size-full" height="124" src="https://labs.k7computing.com/wp-content/uploads/2022/05/figure13-1.png" style="max-width:800px;height:auto;width:auto;" width="782"/><figcaption class="wp-caption-text" id="caption-attachment-24015">Figure 13: Delete zone identifier of copied file</figcaption></figure>
<p>It then collects following information from the victim’s system </p>
<ul>
<li>Computer name</li>
<li>Volume information of OS directory</li>
<li>RtlGetVersion </li>
<li>System native information</li>
<li>Malware execution path with file name </li>
</ul>
<p>All the collected information is encrypted using the Elliptic Curve Cryptography Algorithm. Following API flow is used to encrypt the data. Finally, they convert the encrypted data to base64. </p>
<ul>
<li>BCryptOpenAlgorithmProvider</li>
<li>BcryptDeriveKey</li>
<li>BcryptGetproperty</li>
<li>BCryptImportKey</li>
<li>BcryptGetproperty</li>
<li>BCryptCreateHash </li>
<li>BCryptHashData</li>
<li>BCryptEncrypt</li>
<li>CryptBinaryToStringW</li>
</ul>
<figure class="wp-caption aligncenter" id="attachment_24016"><img alt="" class="wp-image-24016 size-full" height="512" src="https://labs.k7computing.com/wp-content/uploads/2022/05/figure14.png" style="max-width:800px;height:auto;width:auto;" width="697"/><figcaption class="wp-caption-text" id="caption-attachment-24016">Figure 14: Encrypt user information</figcaption></figure>
<h3>C2 communication </h3>
<p>This third level payload decrypts a self-contained list of IP addresses which is used for C2 communication.</p>
<p>The converted base64 data is sent to the C&amp;C.</p>
<p>Following APIs are used for C&amp;C communication</p>
<ul>
<li>HttpOpenRequestW</li>
<li>InternetOpenW</li>
<li>InternetConnectW</li>
<li>InternetQueryOptionW</li>
<li>InternetSetOptionW</li>
<li>InternetSendRequestW</li>
</ul>
<figure class="wp-caption aligncenter" id="attachment_24017"><img alt="" class="wp-image-24017 size-full" height="546" src="https://labs.k7computing.com/wp-content/uploads/2022/05/figure15.png" style="max-width:800px;height:auto;width:auto;" width="793"/><figcaption class="wp-caption-text" id="caption-attachment-24017">Figure 15: Send user data to C&amp;C</figcaption></figure>
<p>After this stage, emotet is known to use Cobalt Strike beacons to deploy ransomware payloads.</p>
<p>In K7labs we keep on monitoring Emotet and its changes, we detect it in every layer like core malware behavior to custom packer.</p>
<p> </p>
<h2>Indicators of Compromise (IOCs)</h2>
<p>SHA256: 7ba37f9a23ec25972d767bbc32a1eb5b3840455bac9b93fddc5d81fd3d21b261</p>
<p> </p>
<p></p>
<h3 class="comment-reply-title">Like what you're reading? Subscribe to our top stories.</h3>
<p>If you want to subscribe to our monthly newsletter, please submit the form below.</p> Email* : 
<ul class="controls">
<li class="previous-post mouse-leaving">
<h3>Previous Post« <a href="https://labs.k7computing.com/index.php/play-store-app-serves-teabot-via-github/" rel="prev">Play Store App Serves Teabot Via GitHub</a>
</h3>
</li>
<li class="next-post mouse-leaving">
<h3>Next Post
</h3>
</li>
</ul>
<h3 class="related-title">More Posts</h3>
</div>