<div>
<h1>Hunting a Global Telecommunications Threat: DecisiveArchitect and Its Custom Implant JustForFun</h1>
<p>May 25, 2022</p> <a href="https://www.crowdstrike.com/blog/author/jamie-harries/" rel="author" title="Posts by Jamie Harries">Jamie Harries</a> <a href="https://www.crowdstrike.com/blog/category/from-the-front-lines/" title="From The Front Lines">From The Front Lines</a>
<img alt="" class="attachment-post-thumbnail size-post-thumbnail wp-post-image" height="698" src="https://www.crowdstrike.com/wp-content/uploads/2022/05/0522_10_Hunting-Global-Telecomms-Threat_DecisiveArchitect_JustForFun_Blog_1060x698.jpeg" style="max-width:800px;height:auto;width:auto;" width="1060"/>
<p>The security landscape is constantly developing to provide easier ways to establish endpoint visibility across networks through the use of <a href="https://www.crowdstrike.com/cybersecurity-101/endpoint-security/endpoint-detection-and-response-edr/">endpoint detection and response (EDR)</a> utilities. However, certain challenges still remain, particularly as a result of many organizations’ need for systems running legacy or proprietary operating systems, such as Solaris. If such systems are not adequately protected using other security controls or unless they can only be accessed by systems with appropriate endpoint-based detection/prevention capabilities, this can cause a gap in visibility for an organization that an adversary could abuse.</p>
<p>On multiple occasions dating back to 2019, the CrowdStrike Services Incident Response team, CrowdStrike Intelligence team and Falcon OverWatch™ team have encountered an adversary targeting global entities, in particular telecommunications companies, to obtain targeted personal user information — for example, call detail records (CDRs) or information relating to specific phone numbers. </p>
<p>Similar to the activity cluster reported as <a href="https://www.crowdstrike.com/blog/an-analysis-of-lightbasin-telecommunications-attacks/">LightBasin</a>, this adversary primarily focuses on Linux and Solaris systems using a custom-built implant tracked by CrowdStrike Intelligence as JustForFun (also publicly known as BPFDoor). While this adversary does interact with Windows systems, mostly during the early stages of an intrusion, CrowdStrike has not yet identified any custom implants geared toward Windows systems. Instead, the adversary relies on publicly available tools, such as ldapdomaindump, or the post-exploitation framework Impacket, to target Windows systems from previously compromised Linux systems.</p>
<p>CrowdStrike Intelligence is currently tracking these intrusions under the DecisiveArchitect activity cluster (also publicly known as Red Menshen; however, this activity is not currently attributed by CrowdStrike to a specific country-nexus. While CrowdStrike has primarily observed the adversary targeting telecommunications companies, other isolated incidents targeting organizations such as logistics entities have also been observed.</p>
<p>DecisiveArchitect exhibits a high degree of operational security as part of their tactics to make it more difficult for defenders to identify and investigate their activity through the use of various defense evasion techniques. While other publicly available research highlights how the implant operates, this blog focuses on methods to hunt for this implant, or implants that may operate in a similar manner, while also highlighting techniques of interest across Solaris systems.</p>
<h2>Spoofed Command Lines</h2>
<p>DecisiveArchitect utilizes a custom implant tracked by CrowdStrike as JustForFun, which is typically persisted using SysVinit scripts. When executed, the implant overwrites the process command line within the process environment by randomly selecting a new command line from one of ten hard-coded options, listed in Figure 1.</p>
<code>/sbin/udevd -d
/sbin/mingetty /dev/tty6
/usr/sbin/console-kit-daemon --no-daemon
hald-addon-acpi: listening on acpi kernel interface /proc/acpi/event
dbus-daemon --system
hald-runner
pickup -l -t fifo -u
avahi-daemon: chroot helper
/sbin/auditd -n
/usr/lib/systemd/systemd-journald</code>
<p>Figure 1. Hard-coded options for command-line spoofing in JustForFun</p>
<p>When DecisiveArchitect interacts with the implants to establish an interactive shell on a system, the <code>bash </code>process spawned by the implant process displays the following command line instead. This makes it appear as if the Postfix queue manager is executing as a way to hide itself from analysts and system administrators:</p>
<p><code>qmgr -l -t fifo -u</code></p>
<p>On Solaris systems, though the executable itself exhibits no mechanism for similar command-line spoofing, DecisiveArchitect achieves similar functionality through the use of <code>LD_PRELOAD</code>, such as the following example identified within a SysVinit script:</p>
<p><code>LD_PRELOAD=/lib/librbtinfo.so.1 /usr/lib/vtdaemon -c 16</code></p>
<p>When executed, the process only shows the command line <code>/usr/lib/vtdaemon -c 16</code>, where the actual JustForFun implant is the file <code>/lib/librbtinfo.so.1</code>.</p>
<p>As recently as April 2022, CrowdStrike observed further variations with regard to DecisiveArchitect’s tactics, techniques and procedures (TTPs), with the actor using the <code>LD_PRELOAD</code> environment variable across Linux systems as well, loading the JustForFun implant, <code>/lib64/libcaac.so.1</code>, within the legitimate process <code>/sbin/agetty</code>. This highlights a deviation from the standard list of spoofed command lines in Figure 1, likely as part of a further effort to remain undetected and emphasizing the importance of behavioral-based hunting and detection methods.</p>
<p>The spoofed command line appears in commands such as <code>ps</code> that may be used to investigate suspicious activity on the host. The spoofed command line makes it less likely that the process will be treated as suspicious.</p>
<h2>Solaris Privilege Escalation Vulnerability Exploitation</h2>
<p>DecisiveArchitect targets Solaris systems via publicly available exploit code for CVE-2019-3010, a vulnerability in <code>xscreensaver</code>. Binaries used to exploit this vulnerability have usually been observed within a few minutes of the JustForFun implant deployment. CVE-2019-3010 is a logic bug that utilizes the <code>LD_PRELOAD </code>technique to facilitate local privilege escalation to the root user on Solaris 11 systems. Proof-of-concept (POC) code is publicly available and was not modified by DecisiveArchitect.1 Table 1 lists two files observed across Solaris systems related to this privilege escalation activity.</p>
<table class="orange" width="624">
<tbody>
<tr class="top-row bg-orange">
<td>File Path</td>
<td>Purpose</td>
</tr>
<tr>
<td>/tmp/getuid.so</td>
<td>CVE-2019-3010 exploit binary</td>
</tr>
<tr>
<td>/usr/lib/secure/getuid.so</td>
<td>CVE-2019-3010 exploit binary or log file</td>
</tr>
</tbody>
</table>
<p>Table 1. Solaris exploitation file details</p>
<h2>Persistence</h2>
<p>The way in which DecisiveArchitect achieves persistence across Linux systems involves the usage of SysVinit scripts (i.e., rc.d/init.d scripts). Instead of simply creating a new script that references the JustForFun implants, DecisiveArchitect uses a more operational security-conscious approach by modifying existing SysVinit scripts to reference a small script file, which then finally references the JustForFun implant. The following highlights an example, including the lines added to the legitimate SysVinit script <code>/etc/rc.d/init.d/pcscd</code> and the script <code>/etc/sysconfig/pcscd</code> referencing the JustForFun implant, <code>/etc/sysconfig/pcscd.conf</code>:</p>
<p><code>/etc/rc.d/init.d/pcscd:</code></p>
<ul>
<li>Line 41: <code>if [ -f /etc/sysconfig/pcscd ] ; then</code></li>
<li>Line 42: <code>/etc/sysconfig/pcscd</code></li>
</ul>
<p><code>/etc/sysconfig/pcscd:</code></p>
<code># Source config
if [ -f /etc/sysconfig/pcscd.conf ] ; then
 /etc/sysconfig/pcscd.conf
fi</code>
<p>With this method of nested persistence, if an analyst simply reviews a set of SysVinit scripts by themselves, identifying the malicious line associated with the JustForFun implant would likely prove difficult without subsequently reviewing all of the files referenced within the scripts. Additionally, as part of DecisiveArchitect’s continued commitment to operational security, the adversary modifies different legitimate SysVinit scripts across systems, and uses different file names/paths for the implant and associated persistence-related scripts, making it difficult to search across other systems for indicators identified through analysis of a single system.</p>
<h2>Detection and Hunting</h2>
<p>One of the best ways to detect or hunt for this activity is to utilize EDR technology across supported Linux systems, with machine learning capabilities to detect and prevent the malicious implants, and with hunting capabilities to identify anomalous usage of common Linux system administration utilities or processes running with spoofed command lines (such as the <code>bash</code> process running with the command line showing the Postfix queue manager command line instead). Figures 2 and 3 highlight the CrowdStrike Falcon® platform’s machine learning capabilities and Falcon OverWatch detections associated with the JustForFun implant and JustForFun command-line tool.</p>
<p>Please note: The examples in the following scenario have CrowdStrike Falcon configured with DETECTIONS ONLY and PREVENTIONS off. A properly configured Falcon instance, as noted previously, would prevent the activity presented here.</p>
<a href="https://www.crowdstrike.com/wp-content/uploads/2022/05/Picture1-14.png" rel="noopener" target="_blank"><img alt="" class="wp-image-122000 size-full" height="1102" src="https://www.crowdstrike.com/wp-content/uploads/2022/05/Picture1-14.png" style="max-width:800px;height:auto;width:auto;" width="4381"/></a><p>Figure 2. JustForFun implant detection (Click to enlarge)</p>
<a href="https://www.crowdstrike.com/wp-content/uploads/2022/05/Picture1-17.png" rel="noopener" target="_blank"><img alt="" class="wp-image-122003 size-full" height="1141" src="https://www.crowdstrike.com/wp-content/uploads/2022/05/Picture1-17.png" style="max-width:800px;height:auto;width:auto;" width="2195"/></a><p>Figure 3. JustForFun command-line tool detections (Click to enlarge)</p>
<p>But, even if an organization has a significant number of legacy or proprietary systems, already has the adversary burrowed into their network, or simply does not have EDR software deployed across Linux systems, all is not lost.</p>
<h2>Hunting for Traffic Signaling Implants</h2>
<p>Given the fact the JustForFun implant opens a raw socket in order to wait for the magic packet, the built-in Linux utility <code>lsof</code> can be used to identify running processes with a raw socket open:</p>
<p><code>lsof -RPnl | grep SOCK_RAW | grep IP</code></p>
<p>Even though this command alone cannot solely determine whether the implant is present — as there are legitimate reasons for processes to have raw sockets open — analysts can highlight processes of interest for further investigation. Of particular importance is that DecisiveArchitect’s use of spoofed command lines means that the <code>lsof </code>command will report the spoofed command line, as opposed to the actual malicious file, which may make it difficult to determine whether the process is malicious or not through this alone. However, by running the <code>lsof </code>command against the process ID without any of the <code>grep</code> filtering, an analyst can list any open files associated with that process, which should reveal the binary. An example of a true positive can be seen below, with the start of the line (i.e., the command line) displaying the start of one of the spoofed command lines listed in Figure 1. It should be noted that DecisiveArchitect can quite easily change these spoofed command lines, so analysts should be conscious of other processes beyond those listed:</p>
<p><code>dbus-daem 1215 0 root 3u pack 11912 0t0 IP type=SOCK_RAW</code></p>
<p>While the <code>lsof</code> command is not part of a default Solaris installation, similar commands exist for obtaining additional details from processes:</p>
<code>for _PIDno in /proc/*; do line=$(pfiles "${_PIDno}"); echo $_PIDno $line | grep bpf; done
for _PIDno in /proc/*; do line=$(pmap "${_PIDno}"); echo $_PIDno $line | grep libpcap; done
for _PIDno in /proc/*; do line=$(pldd "${_PIDno}"); echo $_PIDno $line | grep libpcap; done</code>
<p>The three commands above loop through every process, with the first command looking for a string indicative of a process running with a packet filter, and the other two searching for processes with the <code>libpcap</code> library loaded. As with the <code>lsof</code> command, this alone cannot solely determine whether the implant is present, so an analyst would need to further investigate the specific process to confirm the presence of the implant. DecisiveArchitect’s capability to spoof command lines across Solaris systems also needs to be taken into account when investigating these processes.</p>
<p>When investigating any of these entries, one of the key questions to ask is whether the process in question has any reason to have a raw socket open, to be using a packet filter or to be utilizing the <code>libpcap</code> library. One of the most common false positives relates to systems running processes such as <code>tcpdump</code> or other packet capture utilities.</p>
<p>While these hunting techniques provide a relatively simple method for identifying DecisiveArchitect activity based on activity observed across multiple intrusions, CrowdStrike expects that DecisiveArchitect will continue development of their implant across both Linux and Solaris platforms, while also improving their techniques regarding operational security of their intrusions to further hinder the ability of a defender to identify or investigate their activity, which might include identifying ways to combat these hunting techniques.</p>
<h2>Conclusion</h2>
<p>DecisiveArchitect’s operations present a clear and present threat to telecommunications companies, as well as other organizations such as logistics entities. This blog highlights important details about DecisiveArchitect’s implant, their abilities to operate on Solaris systems, and ways to hunt down the adversary’s implants to help organizations identify whether they have fallen victim to this campaign.</p>
<h3>Endnotes</h3>
<ol>
<li>https[:]//github[.]com/0xdea/exploits/blob/master/solaris/raptor_xscreensaver</li>
</ol>
<h2>Indicators of Compromise (IOCs)</h2>
<table class="orange">
<tbody>
<tr class="top-row bg-orange">
<td>Indicator</td>
<td>Platform</td>
<td>Purpose</td>
</tr>
<tr>
<td><code>/run/lock/kdumpflush
/run/lock/kdumpcab
/var/lock/kdumpcab
/var/lock/kdumpcache
/dev/shm/kdmtmpflush
/dev/shm/kdevtmpfls
/dev/shm/ff</code></td>
<td>Linux</td>
<td>JustForFun implant pathnames (temporary – running process)</td>
</tr>
<tr>
<td><code>/etc/avahi/avahi.conf
/etc/cups/cups
/etc/cups/cups.conf
/etc/gofer/gofor.conf
/etc/gss/gss.conf
/etc/jvm/jvm.conf
/etc/ntp/ntpd
/etc/opt/opt.conf
/etc/pm/pm.conf
/etc/pulp/agent.conf
/etc/ssl/ssl.conf
/etc/sysconfig/kdumplog
/etc/sysconfig/nfs.conf
/etc/sysconfig/pcscd.conf
/etc/xdg/xdg.conf
/usr/java/jdk1.8.0_181-amd64/.java/init.d/jexecd
/usr/local/mysql/bin/myisambug
/lib64/libcaac.so.1</code></td>
<td>Linux</td>
<td>JustForFun implant pathnames (persistent – on disk)</td>
</tr>
<tr>
<td><code>/lib/librbtinfo.so.1
/usr/lib/autofs/mountd
/opt/VRTSvcs/bin/IP/online_Agent</code></td>
<td>Solaris</td>
<td>JustForFun implant pathnames</td>
</tr>
<tr>
<td><code>/run/lock/lvv
/run/lock/lvm/lv
/var/run/lvm/vm
/dev/shm/sem</code></td>
<td>Linux</td>
<td>JustForFun CLI utility pathnames</td>
</tr>
<tr>
<td><code>/tmp/getuid.so
/usr/lib/secure/getuid.so</code></td>
<td>Solaris</td>
<td>CVE-2019-3010 exploitation-related files (not unique to DecisiveArchitect)</td>
</tr>
<tr>
<td><code>/usr/local/bin/GetADUsers.py
/usr/local/bin/GetNPUsers.py
/usr/local/bin/GetUserSPNs.py
/usr/local/bin/atexec.py
/usr/local/bin/dcomexec.py
/usr/local/bin/dpapi.py
/usr/local/bin/esentutl.py
/usr/local/bin/getArch.py
/usr/local/bin/getPac.py
/usr/local/bin/getST.py
/usr/local/bin/getTGT.py
/usr/local/bin/goldenPac.py
/usr/local/bin/ifmap.py
/usr/local/bin/karmaSMB.py
/usr/local/bin/lookupsid.py
/usr/local/bin/mimikatz.py
/usr/local/bin/mqtt_check.py
/usr/local/bin/mssqlclient.py
/usr/local/bin/mssqlinstance.py
/usr/local/bin/netview.py
/usr/local/bin/nmapAnswerMachine.py
/usr/local/bin/ntfs-read.py
/usr/local/bin/ntlmrelayx.py
/usr/local/bin/opdump.py
/usr/local/bin/ping.py
/usr/local/bin/ping6.py
/usr/local/bin/psexec.py
/usr/local/bin/raiseChild.py
/usr/local/bin/rdp_check.py
/usr/local/bin/reg.py
/usr/local/bin/registry-read.py
/usr/local/bin/rpcdump.py
/usr/local/bin/sambaPipe.py
/usr/local/bin/samrdump.py
/usr/local/bin/secretsdump.py
/usr/local/bin/services.py
/usr/local/bin/smbclient.py
/usr/local/bin/smbexec.py
/usr/local/bin/smbrelayx.py
/usr/local/bin/smbserver.py
/usr/local/bin/sniff.py
/usr/local/bin/sniffer.py
/usr/local/bin/split.py
/usr/local/bin/ticketer.py
/usr/local/bin/wmiexec.py
/usr/local/bin/wmipersist.py
/usr/local/bin/wmiquery.py</code></td>
<td>Linux</td>
<td>Impacket post-exploitation framework scripts (not unique to DecisiveArchitect)</td>
</tr>
<tr>
<td><code>/usr/local/bin/ldapdomaindump
/usr/local/bin/ldd2bloodhound</code></td>
<td>Linux</td>
<td>ldapdomaindump binaries used for Active Directory reconnaissance (not unique to DecisiveArchitect)</td>
</tr>
<tr>
<td><code>c:\users\use.bat
c:\users\one.ps1</code></td>
<td>Windows</td>
<td>Unknown scripts</td>
</tr>
</tbody>
</table>
<h4>Additional Resources</h4>
<ul>
<li>Read about another threat that targets the telecommunications sector in this blog: <a href="https://www.crowdstrike.com/blog/an-analysis-of-lightbasin-telecommunications-attacks/">LightBasin: A Roaming Threat to Telecommunications Companies</a>.</li>
<li>Download the <a href="https://www.crowdstrike.com/resources/reports/global-threat-report/">CrowdStrike 2022 Global Threat Report</a> for insights into adversaries tracked by CrowdStrike Intelligence in 2020.</li>
<li><a href="https://go.crowdstrike.com/try-falcon-prevent.html">Get a full-featured free trial of CrowdStrike Falcon Prevent™ </a>and learn how true next-gen AV performs against today’s most sophisticated threats.</li>
</ul>
<ul class="list-share-buttons">
<li class="share-button">
<a class="tweet-btn" href="https://twitter.com/share?text=Hunting+a+Global+Telecommunications+Threat%3A+DecisiveArchitect+and+Its+Custom+Implant+JustForFun&amp;url=https://www.crowdstrike.com/blog/how-to-hunt-for-decisivearchitect-and-justforfun-implant/" rel="noopener noreferrer" target="_blank">
Tweet
</a>
</li>
<li class="share-button">
<a class="li-btn" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://www.crowdstrike.com/blog/how-to-hunt-for-decisivearchitect-and-justforfun-implant/&amp;title=Hunting+a+Global+Telecommunications+Threat%3A+DecisiveArchitect+and+Its+Custom+Implant+JustForFun" rel="noopener noreferrer" target="_blank">
Share
</a>
</li>
</ul>
<a href="https://go.crowdstrike.com/try-falcon-prevent.html">
<img class="post_cta" src="https://www.crowdstrike.com/wp-content/themes/main-theme/dist/images/blog/breaches-stop-here-post-cta.jpeg" style="max-width:80%;height:auto;width:auto;"/>
</a>
<h5>Related Content</h5>
</div>