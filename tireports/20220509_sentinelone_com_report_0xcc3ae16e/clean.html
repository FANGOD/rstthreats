<div>
<table id="amazon-polly-audio-table">
<tbody><tr>
<td id="amazon-polly-audio-tab">
</td>
</tr>
</tbody></table><p>By Dinesh Devadoss and Phil Stokes</p>
<p>Researchers looking into a new APT group targeting gambling sites with a variety of cross-platform malware <a href="https://www.trendmicro.com/en_us/research/22/d/new-apt-group-earth-berberoka-targets-gambling-websites-with-old.html" rel="noopener noreferrer" target="_blank">recently</a> identified a version of oRAT malware targeting macOS users and written in Go. While neither RATs nor Go malware are uncommon on any platform, including the Mac, the development of such a tool by a previously unknown APT is an interesting turn, signifying the increasing need for threat actors to address the rising occurrence of Macs among their intended targets and victims. In this post, we dig deeper into the technical details of this novel RAT to understand better how it works and how security teams can detect it in their environments.</p>
<p><img alt="" class="alignnone wp-image-66514 size-full" height="628" src="https://899029.smushcdn.com/2131410/wp-content/uploads/2022/05/Unsigned-macOS-oRAT-Malware-Gambles-For-The-Win-5.jpg?lossy=0&amp;strip=1&amp;webp=0" style="max-width:800px;height:auto;width:auto;" width="1200"/></p>
<h2 id="heading-0">oRAT Distribution</h2>
<p>The oRAT malware is distributed via a Disk Image masquerading as a collection of Bitget Apps. The disk image contains a <a href="https://mothersruin.com/software/SuspiciousPackage/" rel="noopener noreferrer" target="_blank">package</a> with the name Bitget Apps.pkg and the distribution identifier <code>com.adobe.pkg.Bitget</code>.</p>
<p><img alt="" class="aligncenter size-full wp-image-66502" height="1028" src="https://899029.smushcdn.com/2131410/wp-content/uploads/2022/05/orat_dmg.jpg?lossy=0&amp;strip=1&amp;webp=0" style="max-width:800px;height:auto;width:auto;" width="1778"/></p>
<p>The disk image and installer package are notable for two reasons: neither has a valid developer signature, and the latter doesn’t actually install any files and only contains a preinstall script.</p>
<p><img alt="" class="aligncenter size-full wp-image-66498" height="830" src="https://899029.smushcdn.com/2131410/wp-content/uploads/2022/05/orat-suspicious-package.jpg?lossy=0&amp;strip=1&amp;webp=0" style="max-width:800px;height:auto;width:auto;" width="1818"/></p>
<p>The preinstall script is a succinct bash shell script whose purpose is to deliver a payload to the <code>/tmp</code> directory, give the payload executable permissions, and then launch it.</p>
<p><img alt="" class="aligncenter size-full wp-image-66504" height="1178" src="https://899029.smushcdn.com/2131410/wp-content/uploads/2022/05/orat_preinstall-script.jpg?lossy=0&amp;strip=1&amp;webp=0" style="max-width:800px;height:auto;width:auto;" width="1818"/></p>
<p>Precisely what kind of lure the threat actors use to convince targets to download and launch the dropper is unknown at this time, but given that the target would need to override default security warnings from <a href="https://www.sentinelone.com/blog/the-complete-guide-to-understanding-apple-mac-security-for-enterprise-read-the-free-ebook/" rel="noopener noreferrer" target="_blank">Gatekeeper</a>, it is likely either that the users are sourcing the malware from an environment where this is typical (e.g., a 3rd-party software distribution site that regularly delivers unsigned software) or users have been pre-groomed to <a href="https://www.sentinelone.com/blog/scripting-macs-with-malice-how-shlayer-and-other-malware-installers-infect-macos/" rel="noopener noreferrer" target="_blank">bypass Gatekeeper</a> during a social engineering engagement of some kind.</p>
<p>In either case, the fact that there’s no deliverable from the user’s perspective is a risky gamble on the part of the threat actors. After running the installer and finding that it did not provide whatever they were expecting, users are likely to become suspicious. This might suggest the campaign was broadly targeted and that the threat actors were playing a numbers game, happy to sweep up opportunistic infections as they occurred.</p>
<h2 id="heading-1">The oRAT Payload</h2>
<p>Things get more interesting when we examine the <code>darwinx64</code> payload dropped in the <code>/tmp</code> folder. The binary doesn’t define any Symbols, and outputting the list of Sections tells us that the file has been packed with UPX.</p>
<p><img alt="" class="aligncenter size-full wp-image-66505" height="606" src="https://899029.smushcdn.com/2131410/wp-content/uploads/2022/05/orat_sections.jpg?lossy=0&amp;strip=1&amp;webp=0" style="max-width:800px;height:auto;width:auto;" width="1644"/></p>
<p>Packed files like this are opaque to static analysis, but fortunately standard UPX is very easy to unpack thanks to the <a href="https://upx.github.io/" rel="noopener noreferrer" target="_blank">UPX utility</a> itself. <a href="https://www.sentinelone.com/blog/how-to-reverse-macos-malware-part-two/" rel="noopener noreferrer" target="_blank">Dumping the strings</a> tells us that it was packed with UPX 3.96, the most recently released version available.</p>
<p>The packed binary is around 3MB in size, but after unpacking we are presented with a massive ~10MB file. Such large file sizes are typical of cross-platform malware, particularly when binaries are compiled in Go, since they contain the entire run-time for the language along with a number of supporting libraries.</p>
<p>Fortunately, from a reverse engineering perspective, we can easily ignore most of the standard code that is common to all Go bins and focus on what is unique to the sample at hand. For IDA Pro users, <a href="https://www.sentinelone.com/labs/alphagolang-a-step-by-step-go-malware-reversing-methodology-for-ida-pro/" rel="noopener noreferrer" target="_blank">see here</a>; for <a href="https://www.sentinelone.com/labs/6-pro-tricks-for-rapid-macos-malware-triage-with-radare2/" rel="noopener noreferrer" target="_blank">r2 users</a>, we can start by printing out a list of the functions flagged with <code>sym._main</code>.</p>
<p><img alt="" class="aligncenter size-full wp-image-66496" height="552" src="https://899029.smushcdn.com/2131410/wp-content/uploads/2022/05/orat-go-functions.jpg?lossy=0&amp;strip=1&amp;webp=0" style="max-width:800px;height:auto;width:auto;" width="1572"/></p>
<p>In Go binaries, the program code entrypoint is at main.main, and we can work our way through there to see what other functions, packages and modules are called. Below, we see that the main.main function calls out to another custom package, <code>orat_utils</code>.</p>
<p><img alt="" class="aligncenter size-full wp-image-66497" height="1085" src="https://899029.smushcdn.com/2131410/wp-content/uploads/2022/05/orat-main-function.jpg?lossy=0&amp;strip=1&amp;webp=0" style="max-width:800px;height:auto;width:auto;" width="1999"/></p>
<p>The <code>orat_utils</code> package contains several interesting functions and gives us an entry into understanding how the RAT works.</p>
<p><img alt="" class="aligncenter size-full wp-image-66503" height="856" src="https://899029.smushcdn.com/2131410/wp-content/uploads/2022/05/orat_functions.jpg?lossy=0&amp;strip=1&amp;webp=0" style="max-width:800px;height:auto;width:auto;" width="1940"/></p>
<p>Of particular interest is the <code>LoadConfig</code> function. This is used to parse a blob of data appended to the binary which turns out to be an encrypted malware configuration. The encrypted data at the end of the unpacked binary occupies 166 bytes and consists of the data, an AES key, and two bytes representing the entire blob size.</p>
<p><img alt="" class="aligncenter size-full wp-image-66495" height="700" src="https://899029.smushcdn.com/2131410/wp-content/uploads/2022/05/orat-encrypted-confit.jpg?lossy=0&amp;strip=1&amp;webp=0" style="max-width:800px;height:auto;width:auto;" width="1526"/></p>
<p>Once decrypted, the blob turns out to contain configuration data for the malware C2.</p>
<p><img alt="" class="aligncenter size-full wp-image-66500" height="508" src="https://899029.smushcdn.com/2131410/wp-content/uploads/2022/05/orat_decrypted-blob.jpg?lossy=0&amp;strip=1&amp;webp=0" style="max-width:800px;height:auto;width:auto;" width="1422"/></p>
<p>After the malware decodes the config, it calls into <code>sym._orat_cmd_agent.app</code> and begins a number of loops through <code>sys._orat_protocal.Dial</code>. Depending on the config, it will call one of <code>orat_protocol.DialTCP</code>, <code>orat_protocol.DialSTCP</code> or <code>orat_protocol.DialSUDP</code> to establish a connection. The TCP protocols leverage <a href="https://github.com/xtaci/smux" rel="noopener noreferrer" target="_blank">smux</a> while the SUDP protocol leverages <a href="https://github.com/lucas-clemente/quic-go" rel="noopener noreferrer" target="_blank">QUIC</a>. The malware loops with a sleep cycle of 5 seconds as it waits for a response.</p>
<p>The <code><code>sym._orat_cmd_agent.app</code></code> contains the primary RAT functionality of the malware and defines the following functions.</p>
orat/cmd/agent/app.(*App).DownloadFile
orat/cmd/agent/app.(*App).Info
orat/cmd/agent/app.(*App).Join
orat/cmd/agent/app.(*App).KillSelf
orat/cmd/agent/app.(*App).NewNetConn
orat/cmd/agent/app.(*App).NewProxyConn
orat/cmd/agent/app.(*App).NewShellConn
orat/cmd/agent/app.(*App).Ping
orat/cmd/agent/app.(*App).PortScan
orat/cmd/agent/app.(*App).registerRouters
orat/cmd/agent/app.(*App).run
orat/cmd/agent/app.(*App).Screenshot
orat/cmd/agent/app.(*App).Serve
orat/cmd/agent/app.(*App).Unzip
orat/cmd/agent/app.(*App).UploadFile
orat/cmd/agent/app.(*App).Zip
<h2 id="heading-2">Detecting oRAT in the Enterprise</h2>
<p>The SentinelOne agent detects the oRAT payload as malicious when it is written to disk, protecting SentinelOne customers from this threat.</p>
<p><img alt="" class="aligncenter size-full wp-image-66501" height="1414" src="https://899029.smushcdn.com/2131410/wp-content/uploads/2022/05/orat_detection-console.jpg?lossy=0&amp;strip=1&amp;webp=0" style="max-width:800px;height:auto;width:auto;" width="1999"/></p>
<p>The SentinelOne agent also detects the malware on execution.</p>
<p><img alt="" class="aligncenter size-full wp-image-66499" height="1043" src="https://899029.smushcdn.com/2131410/wp-content/uploads/2022/05/orat_agent-detection.jpg?lossy=0&amp;strip=1&amp;webp=0" style="max-width:800px;height:auto;width:auto;" width="1999"/></p>
<p>For those not protected by the SentinelOne platform, security teams are advised to hunt for artifacts as listed in the Indicators of Compromise section at the end of this post.</p>
<h2 id="heading-3">Conclusion</h2>
<p>The oRAT malware targets macOS users using a combination of custom-written code and public Golang repos. The developers are clearly familiar with using sophisticated features of Go for networking and communications, but due to the simplistic way the malware dropper was packaged, unsigned and with no observable install to distract the victim, it would seem they are less experienced with the challenges of infecting Mac users. Unfortunately, other threat actors have provided plenty of examples from which this new player can learn, and security teams should expect to see any future campaigns from this actor using more sophisticated droppers.</p>
<h2 id="heading-4">Indicators of Compromise</h2>
<table>
<tbody>
<tr>
<td>Filename</td>
<td>SHA1</td>
</tr>
<tr>
<td>bitget-0.0.7 (1).dmg</td>
<td>3f08dfafbf04a062e6231344f18a60d95e8bd010</td>
</tr>
<tr>
<td>Bitget Apps.pkg</td>
<td>9779aac8867c4c5ff5ce7b40180d939572a4ff55</td>
</tr>
<tr>
<td>preinstall</td>
<td>911895ed27ee290bea47bca3e208f1b302e98648</td>
</tr>
<tr>
<td><code>darwinx64</code> (packed)</td>
<td>26ccf50a6c120cd7ad6b0d810aca509948c8cd78</td>
</tr>
<tr>
<td><code>darwinx64</code> (unpacked)</td>
<td>9b4717505d8d165b0b12c6e2b9cc4f58ee8095a6</td>
</tr>
</tbody>
</table>
<table>
<tbody>
<tr>
<td>Paths</td>
</tr>
<tr>
<td>/tmp/<code>darwinx64</code></td>
</tr>
</tbody>
</table>
</div>