<div>
<p>Research of this malware family began when I found a malicious task starting powershell code directly from a registry key within our user base. I wasn’t expecting the surprise I’d arrived at when I began tracking its origins. Living in a smaller country, Czech Republic, it is a rare sight to see someone exclusively targeting the local <code>Czech/Slovak</code> audience. The threat actor seems to have been creating malware <code>since 2015</code> and appears to be from Slovakia. The bad actor’s repertoire contains a few <code>RATs</code>, some packers for <code>cryptominers</code> and, almost obligatorily, <code>ransomware</code>, and I have named the malware family <code>Certishell</code>. This person’s malware is spread with illegal copies of songs and movies and with alleged cracks and keygens of games and common tools (<code>GTA SA</code>, <code>Mafia</code>, <code>Avast</code>, <code>Microsoft Office</code>) that were hosted on one of the most popular Czech and Slovak file-sharing services <code>uloz.to</code>.</p>
<figure class="wp-block-image size-full"><a href="https://decoded.avast.io/wp-content/uploads/sites/2/2022/04/image28-1.png"><img alt="" class="wp-image-5786" height="144" src="https://decoded.avast.io/wp-content/uploads/sites/2/2022/04/image28-1.png" style="max-width:800px;height:auto;width:auto;" width="850"/></a></figure>
<p>The Ceritshell family can be split into three different parts. </p>
<ol><li>RAT with a C&amp;C server <code>sivpici.php5[.]sk</code> (Czech/Slovak slang for “you are fucked up”), which has AutoIT, C++ and Go versions.</li><li>Miner downloaded from hacked websites and started with the script <code>que.vbs</code> from the task. </li><li>Miner or ransomware downloaded from hacked websites and launched from a powershell command hidden in registry keys. The command from the registry key is started with the task from the picture above.</li></ol>
<figure class="wp-block-image"><a href="https://lh3.googleusercontent.com/aB_qPy2t8PqAscjylTnmq5PSY9kv1YVYO6rIiUJ_2EwIm_Fmik2awBHAtl3YP5T0loR0_IiUcQYwQcBUzIPGVkw1WInw5ZxxCP2bjcS-hHJYVTxoImDWOuOz1g0-ftYVgb2aHhol"><img alt="" src="https://lh3.googleusercontent.com/aB_qPy2t8PqAscjylTnmq5PSY9kv1YVYO6rIiUJ_2EwIm_Fmik2awBHAtl3YP5T0loR0_IiUcQYwQcBUzIPGVkw1WInw5ZxxCP2bjcS-hHJYVTxoImDWOuOz1g0-ftYVgb2aHhol" style="max-width:80%;height:auto;width:auto;"/></a></figure>
<p>The map above shows the risk ratio of users around who were at risk of encountering one of the malware families</p>
<h1>Sivpici.php5.sk (2015-2018)</h1>
<figure class="wp-block-image"><a href="https://lh5.googleusercontent.com/CRwY37cMjeaGSdrd1_1gqhwfkCrOT2ZL_Zf2W48qEOV1chaXXGs5lXpfbyyKTVEM1HYwurn3MpAZl9-881Fa8DvDMSFm8mbpfQvfclDaYTJSMOM6oExl7L2eiMnSJpR0QJ59u3UP"><img alt="" src="https://lh5.googleusercontent.com/CRwY37cMjeaGSdrd1_1gqhwfkCrOT2ZL_Zf2W48qEOV1chaXXGs5lXpfbyyKTVEM1HYwurn3MpAZl9-881Fa8DvDMSFm8mbpfQvfclDaYTJSMOM6oExl7L2eiMnSJpR0QJ59u3UP" style="max-width:80%;height:auto;width:auto;"/></a></figure>
<p>The oldest part of the family is a simple RAT with <code>sivpici.php5[.]sk</code> as the C&amp;C server. It places all the needed files in the folder <code>.win</code> inside of the user folder. </p>
<p>The malware installer comes disguised as one of the following:</p>
<ul><li>Cracked software, such as <code>FixmyPC</code>,</li><li>Fraud apps, like <code>SteamCDKeys</code> that share Steam keys,</li><li>Music CD unpackers with names like <code>Extractor.exe</code> or <code>Heslo.exe</code> (Heslo means password in Czech/Slovak) that come with a password protected archive with music files.</li></ul>
<p>The malicious executable downloads an executable named UnRAR.exe and a malicious archive that contains a simple RAT written in C++, AutoIT or Go.</p>
<h3>Installer</h3>
<p>Every executable installing this malware family contains a script similar to the one in the following picture optionally with <code>curl.exe</code>. This script usually shows the password to archive or start another application. The malicious part downloads a legitimate RAR extractor <code>UnRAR.exe</code> and a malicious archive that can be password protected and unpacks it into the <code>%UserProfile%\.win\</code> folder. In the end it registers one of the unpacked files as a service, starts it and allows one of the binaries in the firewall.</p>
<figure class="wp-block-image"><a href="https://lh4.googleusercontent.com/s1Ut0jpVhfsAVHQPzqerHz3ii9b55jccEVB4czcL1ontvMuU5Pc_gn4VgQaIUaOtNkjqS0bsA0DfL7nrQrwEuCCQ0cxJjktj_Q7WfHF_5_hmhDKiAa8SVaXX0pW4SIcmhs_Vnt0g"><img alt="" src="https://lh4.googleusercontent.com/s1Ut0jpVhfsAVHQPzqerHz3ii9b55jccEVB4czcL1ontvMuU5Pc_gn4VgQaIUaOtNkjqS0bsA0DfL7nrQrwEuCCQ0cxJjktj_Q7WfHF_5_hmhDKiAa8SVaXX0pW4SIcmhs_Vnt0g" style="max-width:80%;height:auto;width:auto;"/></a></figure>
<p>I found six different methods used to pack the script into executable binary:</p>
<ol><li>Bat2exe</li><li>Quick Batch File Compiler</li><li>Compiled AutoIT version
<img height="193" src="https://lh4.googleusercontent.com/OhBSu2sbGTyjs-SkDzOOyYM5R-zUf41BQDnNfv89Jl_lwjVjImflG8HkVeWM6Z-wfEsqLSGabt8Y8COVAyzM35lArY1PWELjNENu69W4Qb80h3YpWuaEM4J1cl-WHOsyhCQ40vXF" width="624"/></li><li>Compiled AutoIT version with obfuscated script
<img height="241" src="https://lh5.googleusercontent.com/qB1T5Itn8MpOtPsnGXkvDoUlQBmcP8KVcO-js2t1JRmM0pcVxJGkh6-5S9eE3NcGvqw1-ljSczII8uLkXgW7CzAtpekE4zhNkSSiHq4_9y7cVYijKnW5SVzZZxEHWpB5TVxjmw4v" width="624"/></li><li>Compiled AutoIT version with obfuscated script and packed with PELock</li><li>Compiled AutoIT version with obfuscated script packed with VMProtect</li></ol>
<h3>RAT</h3>
<p>There are three main variants of this RAT. All of them use the same C&amp;C <code>sivpici.php5[.]sk</code> and similar communication protocol. The most advanced is a compiled AutoIT script. This script comes in 10 different main versions. The second one is written in C++ and we found only one main version and the last one is written in Go also with one main version. </p>
<p>The first time it is run, it generates a random alphanumeric string that works as an identificator for the C&amp;C. This identificator is saved into file gen.gen for next start. The communication uses the HTTP protocol. Infected machines send the following back the C&amp;C: </p>
<ul><li><code>pc </code>= ComputerName,</li><li><code>os </code>= content of <code>SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\ProductName</code>,</li><li><code>uniq</code> = generated identifier, saved in <code>\.win\gen.gen</code></li></ul>
<p>with the <code>GET</code> method to <code>start.php</code>.</p>
<p>After a random period of time, the malware starts asking for commands using the <code>GET</code> method with the parameter <code>uniq</code>. The response is a number that has fixed meanings throughout all the versions. Commands “1” – “7” are implemented as follows:</p>
<ol><li>The RAT downloads a URL from <code>/urlg.php</code> using <code>uniq</code>, from this URL it downloads a file, <code>packed.rar</code>, then the RAT starts <code>run.bat</code> from the installation phase to UnRaR the package to the <code>\.win\Lambda</code> folder and restart the RAT. This allows the RAT to update itself and also download any other file necessary.</li><li>Create a screenshot and send it with the <code>POST</code> method to the <code>up.php</code>.</li><li>Send all file names from all drives to <code>up.php</code>.</li><li>DDoS attack to a chosen IP through <code>UDP</code>/<code>HTTP</code>/<code>PING</code>.</li><li>Get a list of all installed apps from
 <code>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall</code> 
saves it to <code>/.win/installed.txt</code> and send them to <code>up.php</code>.</li><li>Get a list of all running processes, save it to <code>/.win/processes.txt</code> and send them to <code>up.php</code>.</li><li>Collect log from keylogger, save it to <code>\.win\log.txt</code> and send it to <code>up.php</code>.</li></ol>
<p>The RAT in the form of compiled AutoIT script has the name <code>Winhost.exe</code>. </p>
<figure class="wp-block-image"><a href="https://lh6.googleusercontent.com/-ALoi9PFa2oxIgc45ayNQAXLZLE1LoxXM0lN3UTYgHcZqQJbCHUGNKXA6vriIyvME_h82mXp6cLV_0rGNyxq-RvnoMEJcu_DAqTZJANpDsrLGAqbPY2ADuX3cKTpr7Pk9uzFZVpX"><img alt="" src="https://lh6.googleusercontent.com/-ALoi9PFa2oxIgc45ayNQAXLZLE1LoxXM0lN3UTYgHcZqQJbCHUGNKXA6vriIyvME_h82mXp6cLV_0rGNyxq-RvnoMEJcu_DAqTZJANpDsrLGAqbPY2ADuX3cKTpr7Pk9uzFZVpX" style="max-width:80%;height:auto;width:auto;"/></a></figure>
<p>There is a comparison of different versions (versioning by the author of the RAT) in the following table.</p>
<figure class="wp-block-table"><table><tbody><tr><td>Version</td><td>Commands</td><td>Notes</td></tr><tr><td>debugging</td><td>1</td><td>Command 2 opens a message box with text 222222</td></tr><tr><td>4</td><td>1 – 3</td><td>Registration of PC happens only once on <code>reg.php</code> and on connection it sends only the <code>uniq</code> and the version of the RAT to <code>updaver.php</code></td></tr><tr><td>6</td><td>1 – 4</td><td>Opens <code>/ad.php</code> in a hidden Internet Explorer window once when the user is not interacting with the PC for at least 5 seconds and closes it after 30 seconds.</td></tr><tr><td>7</td><td>1 – 5</td><td></td></tr><tr><td>8</td><td>1 – 7</td><td>Keylogger starts with the start of the RAT.</td></tr><tr><td>9</td><td>1 – 7</td><td>Keylogger has colored output.</td></tr><tr><td>10</td><td>1 – 7</td><td>Keylogger is separate executable ( <code>~\.win\1.exe</code>)</td></tr></tbody></table><figcaption>Comparission of different version of AutoIT RAT</figcaption></figure>
<p>The keylogger in versions eight and nine is copied from the official AutoIT documentation (with a few small changes) <a href="https://www.autoitscript.com/autoit3/docs/libfunctions/_WinAPI_SetWindowsHookEx.htm" rel="noreferrer noopener" target="_blank">https://www.autoitscript.com/autoit3/docs/libfunctions/_WinAPI_SetWindowsHookEx.htm</a></p>
<figure class="wp-block-image"><a href="https://lh6.googleusercontent.com/sIXLhRqmcPOHyG1GuKsqH8T0TmTVQoXwPLPKW75noid-yW5hrVGZf8L5M2kCa-zzX3hxbuHzufnfseO_ef4MMwMMDK9V-_syrTF8il6D1K6uupoXUVbrQwXAPaTJhWhkXDI9iYaC"><img alt="" src="https://lh6.googleusercontent.com/sIXLhRqmcPOHyG1GuKsqH8T0TmTVQoXwPLPKW75noid-yW5hrVGZf8L5M2kCa-zzX3hxbuHzufnfseO_ef4MMwMMDK9V-_syrTF8il6D1K6uupoXUVbrQwXAPaTJhWhkXDI9iYaC" style="max-width:80%;height:auto;width:auto;"/></a><figcaption>Version 9 adds coloring of keys, mouse movements and clipboard in the keylogger.</figcaption></figure>
<p>The C++ RAT is named <code>dwms.exe</code>. It uses LibCURL to communicate with the C&amp;C. The communication protocol is the same. The <code>uniq </code>identifier is saved in the <code>fr.fr</code> file instead of <code>gen.gen</code> for the AutoIT version, it also starts communication by accessing <code>connect.php</code> instead of <code>start.php</code>.</p>
<p>I’ve managed to find a debugging version that only has the first command implemented and returns only “Command 2” and “Command 3” to the standard output for the second and third command. After every command it answers the C&amp;C by sending <code>uniq</code> and <code>verzia</code> (“version” in English) with GET method to <code>online.php</code>.</p>
<p>The “production” version is labeled as version A. The code is divided into two functions: </p>
<ul><li><code>LLLoad</code> downloads the URL address of the C&amp;C server from the pastebin and tests it by downloading <code>/exists.txt</code>.</li><li><code>RRRun</code> that contains the first two commands as described above. It also uses <code>/connect/</code> path for <code>register.php</code>,<code> load.php</code>, <code>online.php</code> and <code>verzia.php</code>.</li></ul>
<p>To download newer versions it uses curl called from the command line.</p>
<figure class="wp-block-image"><a href="https://lh3.googleusercontent.com/A6rJSeduAXH42MD8qIlnBUwPAlN978pYO6nHHvFmkRlIk8_refyk9kUzPb1TEVtl256OGsaP3ZESB6oexR_yk69UYOAzNYyaJsqtd9QIG7RyauapgX30t5qlbYYF6kiNGRTEZzI_"><img alt="" src="https://lh3.googleusercontent.com/A6rJSeduAXH42MD8qIlnBUwPAlN978pYO6nHHvFmkRlIk8_refyk9kUzPb1TEVtl256OGsaP3ZESB6oexR_yk69UYOAzNYyaJsqtd9QIG7RyauapgX30t5qlbYYF6kiNGRTEZzI_" style="max-width:80%;height:auto;width:auto;"/></a></figure>
<p>Another difference is that screenshots taken are sent via FTP to a different domain:
<code>freetips.php5[.]sk/public_html/SHOT.bmp</code> 
with the username <code>sivpici</code> and password <code>A1B2C3D4</code>. </p>
<p>The RAT written in Go only has the first command implemented, but it downloads <code>/cnct/ad.txt</code> and it opens URLs contained on victims computer, thus we speculate it could also work as adware. </p>
<h1>IECache, bitly, pastebin (2016-2018)</h1>
<p>The installation of this coinminer is similar to the RAT in the previous section. Installations use the same folder and the scripts have the same name. It usually comes as an unpacker of illegal copies of music and movies downloaded from <code>uloz.to</code>. It uses powershell to download and execute scripts from a bit.ly shortened address. The final stage is coinminer <code>IECache.exe</code>, which is usually XMRig.</p>
<figure class="wp-block-image"><a href="https://lh4.googleusercontent.com/ZJ_9BoIzO-GK87tsCY2SroltE0eeI5p_m1yL2EfDQrjGQO-4mB_klo3WuuG3Nf0SO36bU8elOZzUi0aLMLa6fP9AMxzhSRhS7eqUa38tapihlKuVkONFO6PVdPuXjsu3UAjixa3U"><img alt="" src="https://lh4.googleusercontent.com/ZJ_9BoIzO-GK87tsCY2SroltE0eeI5p_m1yL2EfDQrjGQO-4mB_klo3WuuG3Nf0SO36bU8elOZzUi0aLMLa6fP9AMxzhSRhS7eqUa38tapihlKuVkONFO6PVdPuXjsu3UAjixa3U" style="max-width:80%;height:auto;width:auto;"/></a></figure>
<h3>Heslo.txt.exe, Crack.exe…</h3>
<p>There is a huge variety of programs that download bit.ly-shortened Czech and Slovak sites and execute them. These programs include: GTA SA crack, Mafia, Microsoft Office, Sims, Lego Star Wars, and unpackers for music and movies. These programs usually print a message to the victim and run a malicious script in a hidden window.</p>
<p>The unpackers use UnRAR to unpack the archive and show the victim the password of that archive. </p>
<figure class="wp-block-image size-full"><a href="https://decoded.avast.io/wp-content/uploads/sites/2/2022/04/image-13.png"><img alt="" class="wp-image-5787" height="264" src="https://decoded.avast.io/wp-content/uploads/sites/2/2022/04/image-13.png" style="max-width:800px;height:auto;width:auto;" width="850"/></a><figcaption>Unpacker of a music album written in Python and packed with Pyinstaller. It tries to use UnRAR.exe to unpack the music, if unsuccessful, it shows password “1234”.</figcaption></figure>
<p>The cracks on the other hand just show an error message.</p>
<figure class="wp-block-image"><a href="https://lh3.googleusercontent.com/RbHLw3M9ka7x9jQo3FCaojLGYtMdMYIlyHb1rZ1blBi94-IVGMg8q4FTI-r-UrcR_XEnvvFeCB9WqVUzAu4dr2my5vlCgzrqjChql9ipkdeoK85UiEtKmNKIsOQ2cSZb3ZSsoeuR"><img alt="" src="https://lh3.googleusercontent.com/RbHLw3M9ka7x9jQo3FCaojLGYtMdMYIlyHb1rZ1blBi94-IVGMg8q4FTI-r-UrcR_XEnvvFeCB9WqVUzAu4dr2my5vlCgzrqjChql9ipkdeoK85UiEtKmNKIsOQ2cSZb3ZSsoeuR" style="max-width:80%;height:auto;width:auto;"/></a><figcaption>Result of Patcher for Counter-Strike Global Offensive. After downloading and installing the malware from Sourceforge it shows an error from the picture above.</figcaption></figure>
<p>All the installation files execute the following command with some bitly shortened site:</p>
<figure class="wp-block-image size-full"><a href="https://decoded.avast.io/wp-content/uploads/sites/2/2022/04/image29.png"><img alt="" class="wp-image-5785" height="96" src="https://decoded.avast.io/wp-content/uploads/sites/2/2022/04/image29.png" style="max-width:800px;height:auto;width:auto;" width="850"/></a></figure>
<p>There are VBA scripts calling it, basic programs possibly written in C, .Net, AutoIT scripts, Golang programs, Rust programs, Redlang programs, different packers of python and batches, some of them use UPX, MPRESS, VMprotect and PELock. </p>
<figure class="wp-block-image"><a href="https://lh4.googleusercontent.com/aLAM1w7Ed_gDFCvj33-q_fCtuBUF61uHl_uoX7aHc-lXxFimjzGr-5cRgaS--Uu4Vi1jdqtgqfrTQ4Y-Qlq3eh-5eaqE69slJegNym0sqvzTYI_AS06Fpe5waYm0ypcpBJxslIg-"><img alt="" src="https://lh4.googleusercontent.com/aLAM1w7Ed_gDFCvj33-q_fCtuBUF61uHl_uoX7aHc-lXxFimjzGr-5cRgaS--Uu4Vi1jdqtgqfrTQ4Y-Qlq3eh-5eaqE69slJegNym0sqvzTYI_AS06Fpe5waYm0ypcpBJxslIg-" style="max-width:80%;height:auto;width:auto;"/></a><figcaption>Red language</figcaption></figure>
<figure class="wp-block-image"><a href="https://lh6.googleusercontent.com/FtNCmfBXivPIhjSkCObWvM9ZT-TUfE7hbfJzEd3m2tRsJB_9noAO-PY-EQxpScvbpg_-QfP6w8b6WteRwv0lJtM9CfgslGEfjOyBp2EP-3kvqS38UuxFbp16XN21WeqASHXf0vvO"><img alt="" src="https://lh6.googleusercontent.com/FtNCmfBXivPIhjSkCObWvM9ZT-TUfE7hbfJzEd3m2tRsJB_9noAO-PY-EQxpScvbpg_-QfP6w8b6WteRwv0lJtM9CfgslGEfjOyBp2EP-3kvqS38UuxFbp16XN21WeqASHXf0vvO" style="max-width:80%;height:auto;width:auto;"/></a><figcaption>AutoIT</figcaption></figure>
<figure class="wp-block-image"><a href="https://lh6.googleusercontent.com/7_id7Yyd2CEDrHc3yGr1tmHbvfwlLQrIVbCcvhGjupIY-VNP92ha7hPr_2S2N2Y-VAkLCTZ18T4HsB34pnK40ozzcX_emxJNDXbX-pO0mPKYwGZjEA90BVpIuubvviL_Hk9A3iYb"><img alt="" src="https://lh6.googleusercontent.com/7_id7Yyd2CEDrHc3yGr1tmHbvfwlLQrIVbCcvhGjupIY-VNP92ha7hPr_2S2N2Y-VAkLCTZ18T4HsB34pnK40ozzcX_emxJNDXbX-pO0mPKYwGZjEA90BVpIuubvviL_Hk9A3iYb" style="max-width:80%;height:auto;width:auto;"/></a><figcaption>Pyinstaller</figcaption></figure>
<figure class="wp-block-image"><a href="https://lh3.googleusercontent.com/alXbctK2cVWohM9Rwf5_H06fA3QM2DH1WjgtfDuMXBJgOs8jaGb4NjGGcLfnEwVNzoDmuEfHQrh8msRrAXH4r3Iq9k1RW4uA6ycFPJZxX6RA_PLp4nJHFxPGfcOVmKYEkPStZsSN"><img alt="" src="https://lh3.googleusercontent.com/alXbctK2cVWohM9Rwf5_H06fA3QM2DH1WjgtfDuMXBJgOs8jaGb4NjGGcLfnEwVNzoDmuEfHQrh8msRrAXH4r3Iq9k1RW4uA6ycFPJZxX6RA_PLp4nJHFxPGfcOVmKYEkPStZsSN" style="max-width:80%;height:auto;width:auto;"/></a><figcaption>Bat obfuscator</figcaption></figure>
<figure class="wp-block-image"><a href="https://lh5.googleusercontent.com/ldPo_ohRxs7o1MKI7M9EeP71zyCFhDtqPkKRK8elHROaTZTmOh-rT8mN9tqEV3KVOZaTeKSBKZC8bzFPyE67r2hmMHu4MaPYrnA1sbDMGPrreFqpbRvI54HipfAPYfXFmIVD5QYp"><img alt="" src="https://lh5.googleusercontent.com/ldPo_ohRxs7o1MKI7M9EeP71zyCFhDtqPkKRK8elHROaTZTmOh-rT8mN9tqEV3KVOZaTeKSBKZC8bzFPyE67r2hmMHu4MaPYrnA1sbDMGPrreFqpbRvI54HipfAPYfXFmIVD5QYp" style="max-width:80%;height:auto;width:auto;"/></a><figcaption>Rust</figcaption></figure>
<h3>Downloaded script</h3>
<p>There are at least two new scripts created by the script from the site hidden behind the <code>bit.ly</code> shortened URL, <code>que.vbs</code> and <code>run.bat</code>.</p>
<p>The script also creates one of two services named <code>Winmgr</code> and <code>Winservice</code> that start <code>que.vbs</code>. Que.vbs only starts <code>run.bat</code> which downloads <code>whats.txt</code> contains a script downloading and starting coinminer <code>IECache.exe</code>.</p>
<p>que.vbs hash: <code>6f2efc19263a3f4b4f8ea8d9fd643260dce5bef599940dae02b4689862bbb362</code>
run.bat hash: <code>1ad309c8ee17718fb5aacf2587bd51bddb393c0240ee63faf7f890b7093db222</code></p>
<figure class="wp-block-image size-full is-resized"><a href="https://decoded.avast.io/wp-content/uploads/sites/2/2022/04/image22.png"><img alt="" class="wp-image-5775" height="519" src="https://decoded.avast.io/wp-content/uploads/sites/2/2022/04/image22.png" style="max-width:800px;height:auto;width:auto;" width="766"/></a><figcaption>Content of <code>run.bat</code></figcaption></figure>
<p>In this case the pastebin contains two lines (the second line is splitted for better readability)</p>
<figure class="wp-block-image size-full"><a href="https://decoded.avast.io/wp-content/uploads/sites/2/2022/04/image5.png"><img alt="" class="wp-image-5774" height="144" src="https://decoded.avast.io/wp-content/uploads/sites/2/2022/04/image5.png" style="max-width:800px;height:auto;width:auto;" width="850"/></a><figcaption>content of pastebin</figcaption></figure>
<h3>The miner</h3>
<p>The miner is saved as <code>IECache.exe</code> or <code>ctfmon.exe</code>.</p>
<p>The first miner (from June, 2018) is just XMRig that includes all command line options inside the binary. </p>
<figure class="wp-block-image"><a href="https://lh6.googleusercontent.com/bzr6EQtiiRy7pUXLz3hLrJTyDXdzHZxoWpKu0mFKl__VAMscAEviYkJM_MUuohv7pJHhMjG773fgVqTkSZrxT2KnP0Po95yjAPHrL11O6YvLM5se0Nsu31iYdBbw84pYJZ8Rg-lQ"><img alt="" src="https://lh6.googleusercontent.com/bzr6EQtiiRy7pUXLz3hLrJTyDXdzHZxoWpKu0mFKl__VAMscAEviYkJM_MUuohv7pJHhMjG773fgVqTkSZrxT2KnP0Po95yjAPHrL11O6YvLM5se0Nsu31iYdBbw84pYJZ8Rg-lQ" style="max-width:80%;height:auto;width:auto;"/></a></figure>
<p>Most of the miners of this type I found are packed with <code>VMProtect </code>or <code>Themida/Winlicense</code>.</p>
<p>The more interesting one (from Jun-Jul 2018) is a compiled AutoIT script packed with <code>VMProtect</code>. Here again, we see that author speaks Slovak:</p>
<figure class="wp-block-image"><a href="https://lh4.googleusercontent.com/73tJ_cWkqSlnjlwoYZ0QLpXbjZQbfeOxsx9hYZ_eGKGAQsJC50iM8gM7Ga4tEIz0F99b9R2jxfVmkAV_9BdIhB6WzyeKbMM8StCoBznGFCVpcV4HX0HoSs4u1y_KoTLsH5dG6rPd"><img alt="" src="https://lh4.googleusercontent.com/73tJ_cWkqSlnjlwoYZ0QLpXbjZQbfeOxsx9hYZ_eGKGAQsJC50iM8gM7Ga4tEIz0F99b9R2jxfVmkAV_9BdIhB6WzyeKbMM8StCoBznGFCVpcV4HX0HoSs4u1y_KoTLsH5dG6rPd" style="max-width:80%;height:auto;width:auto;"/></a></figure>
<p>This script contains the XMRig as (in some cases LZMA compressed) Base64 encoded string inside a variable. The miner is decoded and started in memory.</p>
<figure class="wp-block-image size-full"><a href="https://decoded.avast.io/wp-content/uploads/sites/2/2022/04/certishell22.png"><img alt="" class="wp-image-5772" height="281" src="https://decoded.avast.io/wp-content/uploads/sites/2/2022/04/certishell22.png" style="max-width:800px;height:auto;width:auto;" width="850"/></a><figcaption><code>ODBASUJ64A</code> is “decode base64” and <code>ODLZMUJA</code> is “LZMA decompress”. </figcaption></figure>
<p>In some versions, the script checks user activity and it starts different miners with different options to maximize profit with lower risk of being caught.</p>
<figure class="wp-block-image size-full"><a href="https://decoded.avast.io/wp-content/uploads/sites/2/2022/04/certishell20.png"><img alt="" class="wp-image-5771" height="408" src="https://decoded.avast.io/wp-content/uploads/sites/2/2022/04/certishell20.png" style="max-width:800px;height:auto;width:auto;" width="850"/></a><figcaption>_PUSTITAM is executes an binary in memory</figcaption></figure>
<p>Newer samples (Since August, 2018) use <a href="https://github.com/monoxgas/sRDI" rel="noreferrer noopener" target="_blank">sRDI</a> or XOR encryption in memory and injection to a suspended process to hide from antivirus software.</p>
<h3>Interesting files</h3>
<h4>Sourceforge and Github</h4>
<p>Some of the samples used Sourceforge and Github to download malicious content, instead of small, possibly hacked websites.</p>
<figure class="wp-block-image"><a href="https://lh5.googleusercontent.com/Qwg6BsM2q5dhhdEIOAIo8A7npPE2s5pbZL1rhQ8PBw_QozkRG-SHJdiBq1vJ14CEl-8YC3Nx-JYp9a8VHCJCL12McKgqaRps_NLWa4-p3Y2vkTTL8zh1sMO3dGs4jhcC2Nb40pUD"><img alt="" src="https://lh5.googleusercontent.com/Qwg6BsM2q5dhhdEIOAIo8A7npPE2s5pbZL1rhQ8PBw_QozkRG-SHJdiBq1vJ14CEl-8YC3Nx-JYp9a8VHCJCL12McKgqaRps_NLWa4-p3Y2vkTTL8zh1sMO3dGs4jhcC2Nb40pUD" style="max-width:80%;height:auto;width:auto;"/></a></figure>
<p>It downloaded content from a repository WEB of user W33v3ly on Github and from user Dieworld on Sourceforge. On Github, the attacker once made a mistake and pushed <code>Systemcall.exe</code> and <code>TestDLL.bin</code> to the wrong repository.</p>
<p>Systemcall.exe hash: <code>e9d96c6de650ada54b3788187132f525094ff7266b87c98d3dd1398c2d5c41a</code>
TestDLL.bin hash: <code>1d2eda5525725f919cb4ef4412272f059abf4b6f25de5dc3b0fca4ce6ef5dd8e</code></p>
<figure class="wp-block-image"><a href="https://lh6.googleusercontent.com/RYd13wHAiVEudRHk7i76sXVxEVrhGwp4kcK6pQieXBp-FcNnZZn3QVfFp_QdKRKuh4eRCPyMMalbhjj3V7qm16Y8HWT0RwlYLVbOARXgVeSmIb_zram96nYNHMDIZwxOPGNcVrnm"><img alt="" src="https://lh6.googleusercontent.com/RYd13wHAiVEudRHk7i76sXVxEVrhGwp4kcK6pQieXBp-FcNnZZn3QVfFp_QdKRKuh4eRCPyMMalbhjj3V7qm16Y8HWT0RwlYLVbOARXgVeSmIb_zram96nYNHMDIZwxOPGNcVrnm" style="max-width:80%;height:auto;width:auto;"/></a></figure>
<p>The <code>Systemcall.exe</code> is a PE file without “MZ” in the beginning and <code>Test.dll</code> contains some random bytes before the PE file. The dll contains XMRig encrypted with TEA and the <code>Systemcall.exe</code> uses sRDI to load and run the Test.dll. </p>
<figure class="wp-block-image"><a href="https://lh6.googleusercontent.com/4Mt5nk1sjzAhQqQWDN9jLD7fk32toCRce795sAfBS9kWEL162x_wbxTuud--c2NMOlOVP_1PyY6XaDIFZh6qoSiGwi2JPEpUdALS-ePQ1ZFmVJHZwTTEEfGTwc7aX8l1bvXa3wY7"><img alt="" src="https://lh6.googleusercontent.com/4Mt5nk1sjzAhQqQWDN9jLD7fk32toCRce795sAfBS9kWEL162x_wbxTuud--c2NMOlOVP_1PyY6XaDIFZh6qoSiGwi2JPEpUdALS-ePQ1ZFmVJHZwTTEEfGTwc7aX8l1bvXa3wY7" style="max-width:80%;height:auto;width:auto;"/></a></figure>
<h4>Steam Giver</h4>
<p>This small application written in .Net shows some hacked Steam accounts.</p>
<figure class="wp-block-image size-full"><a href="https://decoded.avast.io/wp-content/uploads/sites/2/2022/04/image12.png"><img alt="" class="wp-image-5782" height="346" src="https://decoded.avast.io/wp-content/uploads/sites/2/2022/04/image12.png" width="387"/></a></figure>
<figure class="wp-block-image size-full"><a href="https://decoded.avast.io/wp-content/uploads/sites/2/2022/04/image6.png"><img alt="" class="wp-image-5784" height="178" src="https://decoded.avast.io/wp-content/uploads/sites/2/2022/04/image6.png" width="309"/></a></figure>
<figure class="wp-block-image size-full"><a href="https://decoded.avast.io/wp-content/uploads/sites/2/2022/04/image24.png"><img alt="" class="wp-image-5783" height="177" src="https://decoded.avast.io/wp-content/uploads/sites/2/2022/04/image24.png" width="319"/></a></figure>
<p>The malicious part downloads and installs the following scripts and downloads UnRAR and <code>begin.rar</code></p>
<figure class="wp-block-image"><a href="https://lh6.googleusercontent.com/JXbMRRNmIIGePOCC2MnIIMcU_yE5n0KJladMkZiysG9QMjowzdiINWt2bJrpzyR15hWdokvlZmSPCoyqmzCH3E0t3H0lggdX2Vgxv8vTMwxo2FN0oDF6VTU_4O0nSOWhqoE0AOd6"><img alt="" src="https://lh6.googleusercontent.com/JXbMRRNmIIGePOCC2MnIIMcU_yE5n0KJladMkZiysG9QMjowzdiINWt2bJrpzyR15hWdokvlZmSPCoyqmzCH3E0t3H0lggdX2Vgxv8vTMwxo2FN0oDF6VTU_4O0nSOWhqoE0AOd6" style="max-width:80%;height:auto;width:auto;"/></a></figure>
<p><code>Install.vbs</code> creates a task named WinD2 that starts <code>inv.vbs</code> upon every PC startup. <code>Inv.vbs</code> starts <code>runner.bat</code>, which starts <code>%temp%/Microsoft/NisSrve.exe</code> that is unpacked from <code>begin.rar</code> with <code>UnRAR.exe</code>.</p>
<h4>Free bet tips</h4>
<p>Betters are also targeted. We found a malicious file with the following readme file: </p>
<figure class="wp-block-image"><a href="https://lh3.googleusercontent.com/gIhTCPrKR_5Tx1CyZfXLMuISH8w9EjFzyAYjdt-2kYT8p51ZG8mQxtr5qUIr3ItrZwnMEqV4fgzVY_OWGZX7RVQ92JRuYUFemgsgsE2QnKOWd5tFxLOvG8LXh_hNV4O1rl6dVt7J"><img alt="" src="https://lh3.googleusercontent.com/gIhTCPrKR_5Tx1CyZfXLMuISH8w9EjFzyAYjdt-2kYT8p51ZG8mQxtr5qUIr3ItrZwnMEqV4fgzVY_OWGZX7RVQ92JRuYUFemgsgsE2QnKOWd5tFxLOvG8LXh_hNV4O1rl6dVt7J" style="max-width:80%;height:auto;width:auto;"/></a></figure>
<p>The binary included only starts a cmd with the script as an argument.</p>
<figure class="wp-block-image"><a href="https://lh5.googleusercontent.com/51GQ7NNJ3tjYwfFkmIMFAzuzcgI3Bo3B-2UrBP7DJflLLLkHtv4DdIIQEVGuL-aQZ2YBAOSdEiFSNSDEY5GQxrJmKMBA9XsnDXKa_1D3TXA3BMbiJ56IXORSGglM_4wPGyw54JYT"><img alt="" src="https://lh5.googleusercontent.com/51GQ7NNJ3tjYwfFkmIMFAzuzcgI3Bo3B-2UrBP7DJflLLLkHtv4DdIIQEVGuL-aQZ2YBAOSdEiFSNSDEY5GQxrJmKMBA9XsnDXKa_1D3TXA3BMbiJ56IXORSGglM_4wPGyw54JYT" style="max-width:80%;height:auto;width:auto;"/></a></figure>
<figure class="wp-block-image"><a href="https://lh3.googleusercontent.com/DSW6kknJrekw9111qVF50wkMQBVAsQUUqlCM3aFmKYad8dcA0kDKbeDH2m2LtA_dy4ddSBCs-Zkw0i41yAc3vHU4k7YcSONZxZS2S8gIPFFrGTJhSXjVC6Dmpqj6V26MEfaHCGpX"><img alt="" src="https://lh3.googleusercontent.com/DSW6kknJrekw9111qVF50wkMQBVAsQUUqlCM3aFmKYad8dcA0kDKbeDH2m2LtA_dy4ddSBCs-Zkw0i41yAc3vHU4k7YcSONZxZS2S8gIPFFrGTJhSXjVC6Dmpqj6V26MEfaHCGpX" style="max-width:80%;height:auto;width:auto;"/></a></figure>
<h1>All from registry keys since 2018</h1>
<p>After 2018, I observed an updated version of the malware family. There is no need for any script file if you can have a command as a scheduled task and save enough data into registry keys. </p>
<p>The infection vector is the same as in the previous case. The victim downloads and runs an executable that downloads a powershell script from a hacked website whose URL is shortened with bit.ly. This time the script is different, it creates the following task: </p>
<figure class="wp-block-image size-full"><a href="https://decoded.avast.io/wp-content/uploads/sites/2/2022/04/image28.png"><img alt="" class="wp-image-5779" height="144" src="https://decoded.avast.io/wp-content/uploads/sites/2/2022/04/image28.png" style="max-width:800px;height:auto;width:auto;" width="850"/></a></figure>
<p>This task reads the value of the registry key <code>Shell</code> placed in <code>HKLM\Software\a</code> and executes its content. The script also creates the Registry key. </p>
<p>Let’s focus on the value of the registry key <code>Shell</code>. In the following picture you will find the value I found on an infected machine.</p>
<figure class="wp-block-image"><a href="https://lh6.googleusercontent.com/RJL_xE0ShxurxLLpjuzMq8UMKWozQgBW-PakTSpzgx6Hc24fNtlA6NZpNhyOJFc6Ez8ewv3DB22hCed_EbYnRFkWSktEnwUL_0Le_Kh94ymSe9EDsWnIAsxaG3eWHqvnDHF7FbUw"><img alt="" src="https://lh6.googleusercontent.com/RJL_xE0ShxurxLLpjuzMq8UMKWozQgBW-PakTSpzgx6Hc24fNtlA6NZpNhyOJFc6Ez8ewv3DB22hCed_EbYnRFkWSktEnwUL_0Le_Kh94ymSe9EDsWnIAsxaG3eWHqvnDHF7FbUw" style="max-width:80%;height:auto;width:auto;"/></a></figure>
<p>After decoding and decompression we get an obfuscated script:</p>
<figure class="wp-block-image size-full"><a href="https://decoded.avast.io/wp-content/uploads/sites/2/2022/04/image21.png"><img alt="" class="wp-image-5780" height="1008" src="https://decoded.avast.io/wp-content/uploads/sites/2/2022/04/image21.png" style="max-width:800px;height:auto;width:auto;" width="850"/></a></figure>
<p>Under two layers of string formatting and replacing we get another compressed base64 encoded script:</p>
<figure class="wp-block-image size-full"><a href="https://decoded.avast.io/wp-content/uploads/sites/2/2022/04/image26.png"><img alt="" class="wp-image-5781" height="504" src="https://decoded.avast.io/wp-content/uploads/sites/2/2022/04/image26.png" style="max-width:800px;height:auto;width:auto;" width="850"/></a></figure>
<p>Inside the base64 string is malicious code that tests the connection and executes code directly from the internet.</p>
<figure class="wp-block-image"><a href="https://lh3.googleusercontent.com/j9OVRS1tYq-BGforTGpqTKBHgh-0-jUghYipbEqbwGYCapf2rWhIb4SGfKXTD-W1O131NKG4X0lrqjLp-jo-iVVEA84FHSNJJNddFeujYzxqG3uq0LfGEVydkkamPZ13U9K-aUhK"><img alt="" src="https://lh3.googleusercontent.com/j9OVRS1tYq-BGforTGpqTKBHgh-0-jUghYipbEqbwGYCapf2rWhIb4SGfKXTD-W1O131NKG4X0lrqjLp-jo-iVVEA84FHSNJJNddFeujYzxqG3uq0LfGEVydkkamPZ13U9K-aUhK" style="max-width:80%;height:auto;width:auto;"/></a></figure>
<p>In total, I found about 40 different values of the <code>Shell</code> key in the wild that contain similar code with different URLs and they are obfuscated in the same way or less.</p>
<p>Some of the pastebins were alive. For example, one of them contains the following scripts that sends information about graphic cards to the C&amp;C server, which can decide what to install on an infected computer. I have not found any C&amp;C server alive.</p>
<figure class="wp-block-image"><a href="https://lh3.googleusercontent.com/hzu7Mjb3yhXeI9lEzkW1VmgT1lixPYwXeF5TQh0aSqkH8gGV-dZAszL7_eYbUUh2fa-Q6k9aoM_ZurHgvP9eUIaROQlLsQFKC1LP-Ya09xhoIIkg1Art4EZw55WbQ5tCGsxR-Ks-"><img alt="" src="https://lh3.googleusercontent.com/hzu7Mjb3yhXeI9lEzkW1VmgT1lixPYwXeF5TQh0aSqkH8gGV-dZAszL7_eYbUUh2fa-Q6k9aoM_ZurHgvP9eUIaROQlLsQFKC1LP-Ya09xhoIIkg1Art4EZw55WbQ5tCGsxR-Ks-" style="max-width:80%;height:auto;width:auto;"/></a></figure>
<h2>Ransomware</h2>
<p>Another final stage that runs from the registry keys is ransomware Athos.exe. At first it checks some tactics from <a href="https://blog.sevagas.com/IMG/pdf/BypassAVDynamics.pdf" rel="noreferrer noopener" target="_blank">https://blog.sevagas.com/IMG/pdf/BypassAVDynamics.pdf</a> to check if it runs in the sandbox. On the sixth start it injects ransomware into another process that gets the id and encryption key from the web page <code>googleprovider[.]ru</code>. Then it encrypts all the files with AES-CFB and shows the following message saved on imgur (<code>https://i.imgur[.]com/cKkSBSI.jpg</code>). </p>
<figure class="wp-block-image"><a href="https://lh6.googleusercontent.com/epdIKBOJRW7Q5yTk0aBzNrmcXAeB8PV9vsgkTZvE3ZRP8cxivtgBzgk-FZxRAoPAWH_BjKpCjID2W9I_fwgxF7J377k7r71VJpqZ8s7LvxA7dTQ6Q0Qpacl_uZbKTQpQQfnskari"><img alt="" src="https://lh6.googleusercontent.com/epdIKBOJRW7Q5yTk0aBzNrmcXAeB8PV9vsgkTZvE3ZRP8cxivtgBzgk-FZxRAoPAWH_BjKpCjID2W9I_fwgxF7J377k7r71VJpqZ8s7LvxA7dTQ6Q0Qpacl_uZbKTQpQQfnskari" style="max-width:80%;height:auto;width:auto;"/></a><figcaption>Translation: Your files are encrypted. If you want them back, you need your ID that you can find in Athos_ID.txt on the desktop. Keep your ID secure, if you lose it, your files can’t be recovered!!! You can recover your files with the help of the website www.g…</figcaption></figure>
<p>We also found AutoIT ransomware King Ouroboros translated to Slovak. The malware was edited to use Windows users’ GUID as encryption key and to download additional content from a different server than the original King Ouroboros.</p>
<p>ransomware hash: <code>90d99c4fe7f81533fb02cf0f1ff296cc1b2d88ea5c4c8567142bb455f435ee5b</code></p>
<h1>Conclusion</h1>
<p>Most of the methods described in this article are not new, in some cases I was able to find their source. The most interesting method is hiding the powershell script to the registry keys. </p>
<p>As I found out, the author is a Slovak speaker, this corresponds with the fact that the infected files were published only on Uloz.to, therefore the victims are only from the Czech Republic and Slovakia. </p>
<p>The variation of the final payload is huge. I found three different RATs, a few different packers of coinminers and ransomware that were created by the author and many more that were “available” on the internet. The initial installer, which function was to call only one command, was also created with a huge variety of tools, some of them quite obscure.</p>
<p>To protect against this type of threat, it is enough to download software only from trustworthy sources and use security software, like <a href="https://www.avast.com/index" rel="noreferrer noopener" target="_blank">Avast Antivirus</a>, which will act as a safety net in case you should come across a threat.</p>
<h1>Indicators of Compromise (IoC)</h1>
<ul><li>Repository: <a href="https://github.com/avast/ioc/tree/master/Certishell" rel="noreferrer noopener" target="_blank">https://github.com/avast/ioc/tree/master/Certishell</a></li><li>List of SHA-256: <a href="https://github.com/avast/ioc/blob/master/Certishell/samples.sha256" rel="noreferrer noopener" target="_blank">https://github.com/avast/ioc/blob/master/Certishell/samples.sha256</a></li><li>URI: <a href="https://github.com/avast/ioc/blob/master/Certishell/network.txt" rel="noreferrer noopener" target="_blank">https://github.com/avast/ioc/blob/master/Certishell/network.txt</a></li></ul>
</div>