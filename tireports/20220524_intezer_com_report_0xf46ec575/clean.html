<div>
<p>Emails were created as a method to pass messages between users, and now they are used by individuals and organizations all around the globe, by both big and small companies across all industries. But emails also have a dark side – phishing emails that are used by threat actors to gain access to victims’ systems. </p>
<p>Traditionally phishing emails are associated with credential harvesting attacks, but that’s not the only goal of these attacks. As defined by <a class="blog-text-link" href="https://attack.mitre.org/techniques/T1566/">MITRE ATT&amp;CK framework</a>, adversaries also send phishing emails containing malicious links or attachments to deploy malware (such as backdoors and ransomware) and further exploit the system.</p>
<p>These days, we know better than to open and respond to sketchy emails that make wild promises. Consequently, threat actors adapt their techniques and messages to increase the chances of successfully luring the victims. Through 2021, phishing attacks remained one of their top attack methods – <a class="blog-text-link" href="https://www.cybertalk.org/2022/03/30/top-15-phishing-attack-statistics-and-they-might-scare-you/#:~:text=in%202021%2C%2083%25%20of%20organizations%20reported%20experiencing%20phishing%20attacks">83% of organizations</a> reported experiencing phishing attacks. </p>
<p><a class="blog-text-link" href="#h-investigating-phishing-email-campaigns-real-life-examples">Know the basics about phishing emails? Jump down to learn about automating tasks in your phishing email investigation pipeline.</a></p>
<p>Since emails are widely used as a means of communication between the company and the outside world, security teams have to deal with large amounts of files, filtering and inspecting them to prevent phishing emails from reaching the end user’s mailbox. In addition, threat actors implement different techniques to evade detection. </p>
<p>In this blog, we will cover the techniques used by threat actors to make phishing emails look legitimate and deliver malware to the victim’s endpoint. We will show practical tools in which you can identify malicious emails and what are the next steps of the investigation you need to take following the discovery of malicious emails in your organization. </p>
<h2 id="h-how-email-files-are-used-by-threat-actors">How Email Files Are Used by Threat Actors?</h2>
<p>Threat actors use emails to get initial access to the victim, from there they can launch an attack and steal sensitive information, install backdoors, set persistence and cause further damage. Attackers mainly use <a class="blog-text-link" href="https://attack.mitre.org/techniques/T1566/001/">attachments</a> or <a class="blog-text-link" href="https://attack.mitre.org/techniques/T1566/002/">links</a>, to deploy and execute their malicious intentions.</p>
<p>Emails can be sent with attachments that can be of any type: documents, executables, images, video, scripts, etc. Usually, threat actors create phishing emails with a message that lures the victim into opening the attached files. Once the file is opened the first stage of the attack is executed. </p>
<p>Another way of delivering threats to the victim’s endpoint is by using links in the message, either displayed in plain sight or hidden behind text or images. The end goal of the attackers is to trick users into opening the links, so they can steal sensitive information or deploy the first stage of the attack to the endpoint.</p>
<h2 id="h-how-to-inspect-phishing-email-files">How to Inspect Phishing Email Files</h2>
<p>Emails consist of a header and body, inspecting them can provide helpful information for an investigation and indicate whether the emails are malicious. The message of the email can raise suspicion – for a trained eye, the attachments and the sender domain can also be a trigger to investigate the email. As SOC analysts and investigators, it is important to recognize the signs and methods of malicious emails because the threat can be delivered in several ways, and some of them are sneaky. </p>
<h3 id="h-inspecting-attachments">Inspecting Attachments </h3>
<p>As described above, emails support a wide variety of attachments, and these files can contain malicious code (especially executables or scripts). Commonly the email provider will alert upon opening emails that contain executables. But that’s not always the case for documents like pdfs and Office files which are often used and shared between organizations and individuals. These non-binary files are also commonly used by threat actors to deliver malicious payloads, and using different techniques, execute the first stage of the attack.</p>
<p>Threat actors use <a class="blog-text-link" href="https://attack.mitre.org/techniques/T1036/007/">double extensions</a> to masquerade the true file type to trick users into opening files that might seem safe (such as images or text) while it is actually an executable file. By default, Windows hides file extensions, so example.txt.exe would appear as example.txt</p>
<p>The second extension is the real extension of the file and defines which tool will be used to open the file. Another technique used to hide the real file extension is <a class="blog-text-link" href="https://attack.mitre.org/techniques/T1036/002/">Right-to-Left Override (RLTO)</a> – Windows supports languages that are written from right to left using a Unicode character that causes the text that follows it to be displayed in reverse. Threat actors use this method to blend the real file extension with the file name. </p>
<figure class="wp-block-image"><img alt="hidden extension on phishing email attachment" src="https://lh3.googleusercontent.com/qmcB-jd8QWAp0CXcl9Bo31PftIDQPqgrkUYYjM9dZe1mIgilPaJpY9IDfcL4_PdHwPcuR5VdgoWo1L_2DnZUV0cW8QoYpB41rUwgIKNhRDUjX6poIRuugMeE7niDX3czbL-9tvRurqjFkHpWGw" style="max-width:80%;height:auto;width:auto;"/><figcaption>Double extension in Windows when (by default) file name extension is hidden. </figcaption></figure>
<p>Tools for inspecting attachments:</p>
<p>Before inspecting the attached files you will need to extract them (if the email service provider didn’t do that for you), there are several free tools you can use:</p>
<ul><li><a class="blog-text-link" href="http://www.nirsoft.net/utils/outlook_attachment.html">OutlookAttachView</a> – NirSoft software to collect all of the attachments in your Outlook mailbox, you can download certain files and investigate them.</li><li><a class="blog-text-link" href="https://github.com/TeamMsgExtractor/msg-extractor">Msg-extractor</a> – Open-source tool to extract attachments from Outlook.</li><li><a class="blog-text-link" href="https://github.com/diogo-alves/eml-extractor">Eml-extractor</a> – Open-source CLI tool to extract attachments from eml messages.</li><li><a class="blog-text-link" href="https://www.marks-lab.com/">UUDWIN</a> – Software that extracts attachments from eml and msg emails. </li></ul>
<h4 id="h-most-commonly-used-attachment-file-types-in-malicious-emails">Most Commonly Used Attachment File Types In Malicious Emails</h4>
<p>As mentioned, emails can have different types of attachments, so usually threat actors use specific file types that can be relatively easily exploited to deliver threats. Based on <a class="blog-text-link" href="https://www.sonicwall.com/medialibrary/en/white-paper/mid-year-2021-cyber-threat-report.pdf">SonicWall’s 2021 cyber threat report</a>, the following types of attachments are commonly used by both legitimate and malicious emails, therefore emails that contain these types of attachments should be carefully inspected.</p>
<ul><li>Microsoft Office files – Utilize the macros or embedded OLE objects to deliver threats such as <a class="blog-text-link" href="https://analyze.intezer.com/families/db6abbcc-d292-4991-bc90-207c077f5e53">Emotet</a> or <a class="blog-text-link" href="https://analyze.intezer.com/families/b70bfda8-0db1-4559-bc12-2525e7ac9e3b">Trickbot</a>. To properly analyze these files you need to understand the format and the techniques threat actors implement to hide malware – check out our previous blog about <a class="blog-text-link" href="https://www.intezer.com/blog/malware-analysis/analyze-malicious-microsoft-office-files/">how to analyze malicious office files</a>.</li><li>PDFs – By nature these files can have links, JavaScript code, and any file type can be embedded into a PDF file. All of these features are used by threat actors to hide and deliver threats. On top of that, there are hundreds of PDF readers and many known vulnerabilities that can be exploited by specially crafted PDF files and allow threat actors to execute code on an endpoint. There are tools and methods to inspect PDF files and identify malicious files, check out this post about <a class="blog-text-link" href="https://www.intezer.com/blog/incident-response/analyze-malicious-pdf-files/">how to analyze PDF files</a>.</li><li>ZIP and RAR archive files – These are compressed file formats, a malicious executable can be compressed and attached to an email using one of the archive types. But a well-configured email gateway should be able to alert and possibly prevent the email from arriving at its final destination. But that’s not always the case for password-protected archive files, which usually are not blocked, as its contents are not able to be inspected due to encryption. Another technique threat actors use to evade detection is sending one archive that contains a decoy file and another archive that contains the actual malware. This technique was used by the group behind <a class="blog-text-link" href="https://www.bleepingcomputer.com/news/security/specially-crafted-zip-files-used-to-bypass-secure-email-gateways/">NanoCore RAT</a>.</li><li>ISO and IMG disk image – These files are commonly used by attackers to evade detection from email-based Antivirus scanners. The use of ISO files allows the threat actor to <a class="blog-text-link" href="https://attack.mitre.org/techniques/T1553/005/">bypass the Mark-of-the-Web controls</a>, resulting in execution of the malware without warning to the user. In addition, starting from Windows 8.1, double clicking the file will automatically mount the ISO file and install the software (malware in the case of malicious files). Threat actors use this format to evade detection while fairly easily installing malware. </li></ul>
<p>Inspecting attachments can be time consuming and hard and in some cases you may come to the conclusion that the file is trusted. To reduce the time you spend on analysis of files, you can automatically pipe them into <a class="blog-text-link" href="https://analyze.intezer.com/">Intezer</a> that uses a proprietary code reuse database that extracts valuable information about the file: whether the file is malicious, and does it share code, behavior, IOC or strings with other samples in the database. This way you will not have to waste time on trusted files or known malicious files.</p>
<h2 id="h-investigating-phishing-email-campaigns-real-life-examples">Investigating Phishing Email Campaigns – Real Life Examples</h2>
<p>Our research team discovered a <a class="blog-text-link" href="https://www.intezer.com/blog/research/global-phishing-campaign-targets-energy-sector-and-its-suppliers/">phishing campaign</a> that used spoofed or typosquatted emails to make them look like part of a normal business-to-business (B2B) correspondence, targeting large international companies in the energy, oil &amp; gas, and electronics industries. The attachments were primarily an IMG, ISO or CAB file. We submitted the attachments to Intezer and discovered that they belong to known information stealer malware such as Agent Tesla, Loki, Snake Keylogger, and Formbook.</p>
<figure class="wp-block-image"><img alt="automated phishing email analysis in Intezer" src="https://lh6.googleusercontent.com/va0JSIiGMFAHjbmr_Xce4fMnTC6Z4n7Y9VDWFDfxZGmiHzJ7cR03YgipBwxYPRzTsUG60gs4IB8g9irccfuI52uKrFPJjJOZ_rbYjjADv9Eo6gvmClAA6SE2m7A5f4UMyGGzDWYmZVqy-ZGN_A" style="max-width:80%;height:auto;width:auto;"/><figcaption>Genetic analysis of the ISO sample containing Snake Keylogger.</figcaption></figure>
<p>If the investigation of the file concludes that the file is malicious, it means that the email that deliverd it is also malicious and should be further investigated. </p>
<h3 id="h-inspecting-links-manually-or-automatically">Inspecting Links, Manually or Automatically</h3>
<p>Most of the malicious emails use links and trick victims into visiting <a class="blog-text-link" href="https://www.intezer.com/blog/malware-analysis/url-analysis-phishing-part-1/">malicious URLs</a> from which malware will be downloaded or victim’s sensitive information will be stolen. Links can be in plain sight and appear as legitimate links to known sites such Amazon or Facebook, where in fact the domain is fake or a typosquatter. In other cases, the links are hidden behind text or images such as buttons or coupons, making it harder to notice the malicious URL. </p>
<p>You’ll need to collect any URLs from the emails and inspect them using a URL scanner, to know if the URL was seen in previous attacks. If it is a known malicious address then the email is certainly malicious as well. But if the results are not conclusive or you wish to dig deeper, it is worth to further investigate the domain and see if it was linked to any known campaigns or threat actors.</p>
<p>One of the tools you can use for inspecting URLs is <a class="blog-text-link" href="https://www.intezer.com/blog/product-updates/automatically-scan-urls-and-analyze-malware/">Intezer’s URL scanner</a>. Intezer can connect to abuse inboxes or email security systems to automatically collect and classify file attachments or URLs, allowing you to accelerate response. When you submit the extracted URL, then the scanner will produce a report that includes a screenshot of the website, the verdict of the URL (is it malicious or not), information about the domain and indicators such as if the address is blacklisted, was it used in phishing campaigns, etc.</p>
<figure class="wp-block-image"><img alt="Intezer analysis of URL from phishing email" src="https://lh3.googleusercontent.com/J0m0FFkkgyN98iHzIIo8i5PBrvgFU5ROdjp9Qs04X-VMbJ3mn0ueQORnVnNDTUe0mm5oKozfkF9MgnnUHE8833hxEIbp0OogbfW0yTeb9-p-6VWyHVAX77JNCoO6HTrQHJdnXcBrt-GWijrKGQ" style="max-width:80%;height:auto;width:auto;"/><figcaption>URL scan <a class="blog-text-link" href="https://analyze.intezer.com/url/f63ba0c3-8355-4cc8-8c54-b4d4b3622ecf">report</a> in Intezer.</figcaption></figure>
<h3 id="h-inspecting-the-sender-address">Inspecting the Sender Address</h3>
<p>Assuming that you have blocked a known spam address and you monitor specific keywords that indicate that an email is malicious, phishing emails still can find their way into your inbox. To identify a malicious email you need to closely inspect and understand who is the original sender of the email and whether it’s a legitimate entity or an attacker. </p>
<p>First, examine the email in the inbox, where there are several indicators that can give away malicious emails in this stage:</p>
<ol><li>You didn’t expect to receive this email – in many cases phishing emails do not relate to previous connection or correspondence. If you haven’t had any contact with the sender or their organization, flag the email as suspicious. </li><li>Misspelled domain or poorly written emails are a strong indication of suspicious emails and you must proceed with caution when handling these emails. </li><li>Take into consideration that big organizations and service providers will not send emails from free domains such as gmail[.]com or outlook[.]com. Usually these organizations have their own private domain in the format of XXX@&lt;domain_organisation&gt;.com </li></ol>
<p>A common method used by attackers to lure victims into opening emails is by using spoofed email addresses (to make the email look like it came from a known and trusted entity) – there are sites that let you send emails from a given domain or use a certain name that will appear in the sender field. But using the information in the email’s header makes it possible to detect this method.</p>
<p>So, if you decide to dig deeper into the email, you need to view the full email body and header. Usually you can get it by opening the additional option menu of the email service provider.</p>
<h4 id="h-email-file-header">Email File Header</h4>
<p>The header contains important fields that can help in identifying malicious emails:</p>
<ul><li>From: Who sent the message, however this field can be modified as mentioned above. The anomalies we mentioned about the sender apply here as well. </li><li>To: Recipient’s name and email address. This field can help in determining the real target of an email, in case we determine that the email is malicious the recipient can determine if the attack targets specific victims. </li><li>Received: The most reliable field that provides information about the origin of the email. An email that is being sent from one user to another passes through one or more servers until it reaches its destination, similar to post offices. Each agent adds a layer of information that contains a timestamp and information about the server from which the email was received from, that’s the reason that some emails contain several Received fields. Therefore, you should inspect the header from the bottom to the top. </li><li>Return-Path: Address to return the mail. </li><li>DKIM signature: Checks the DKIM DNS record of the sender to confirm the authenticity of the sender using public key cryptography. </li><li>SPF: Defines which mail servers are authorized to send emails for a certain domain based on DNS record, the goal is to prevent attackers from sending emails using your domain from any server. <ul><li>Received-SPF field – email sent from permitted servers will show up as “Pass” but it can still be a non legitimate email if the account has been compromised. If the value of the field is either “Fail” or “Softfail”, it indicates that the email may be spoofed or the domains didn’t update their SPF records. Here is an example of an email that pretends to be sent by Haesung Tech, but the address is spoofed and the doesn’t pass the SPF check:</li></ul></li></ul>
<figure class="wp-block-image"><img alt="" src="https://lh3.googleusercontent.com/a4JPyiRSkMHNwbLWC40HApI7cw6lx_WIBC0hZihZenyPuo5a-RIsj0ZmtBQ_fbmFM5FtAeb2xhV4OMw6YlpwAVPwBIHUL-OcOoyFLVaLH5v13dXj65hZAwr83ujBv6MBHx_49YSENYdG8pUe8g" style="max-width:80%;height:auto;width:auto;"/><figcaption>Sender Policy Framework (SPF) record of a spoofed address.</figcaption></figure>
<p>Domain-based Message Authentication, Reporting and Conformance (DMARC) is another email authentication protocol that uses the information provided by either DKIM or SPF (or both). DMARC is implemented to protect the domain from unauthorized use in phishing and spoofing attacks. And DMARC enforces predefined policy to handle unwanted emails. DMARC, DKIM and SPF are used to prevent phishing and unauthorized use of domains. When you inspect emails make sure to validate the values in these fields. </p>
<p>Other fields in the header that you should know about:</p>
<ul><li>MIME-version – Multipurpose Internet Mail Extensions (MIME) extends the standard email format, it provides support for non-ASCII character sets, audio, video and applications. Messages that use MIME must contain the version field. </li><li>Message-ID – unique identifier used in emails.</li><li>X-header – custom email headers that can be added to the other standard headers. Email providers add specific headers for authentication, information about spam, etc. Microsoft Outlook uses X-MS-Exchange header and Google uses X-Google-DKIM. For example:<ul><li>X-Originating-IP- the ip address of the sender</li><li>X-Spam-Status &amp; X-Spam-Level- Spam record set by the mail service. </li></ul></li></ul>
<h3 id="h-real-life-examples">Real Life Examples</h3>
<p>Intezer’s research team discovered a <a class="blog-text-link" href="https://www.intezer.com/blog/malware-analysis/targeted-phishing-attack-against-ukrainian-government-expands-to-georgia/">phishing campaign</a> that targeted government entities in Georgia. The attack flow starts with a phishing email containing a malicious shortened URL, as can be seen in the screenshot below. The URL redirects to a Command and control (C2) where a ZIP file or malicious document is hosted. The ZIP file contains a malicious file and in some emails also a harmless PDF file. The malicious attachment varies between RTF, DOC, PDF, JS, LNK or EXE. The main goal of the attachment is to drop the packed payloads from the C2. The packed executable loads an AutoIt payload into memory, once executed the malware steals files with predefined extensions. </p>
<p>The campaign demonstrates the challenge of inspecting emails, the variety of file types that are compressed into the ZIP file, can make the analysis more challenging and time consuming – you will need the skills and the tools to analyze each file type. There is a solution – automate your email pipeline. Automatically extract the attachments and submit them to platforms such as Intezer, this way instead of spending time on files that are trusted or known threats you can focus on other aspects of the suspicious email. </p>
<figure class="wp-block-image is-resized"><img alt="" height="310" src="https://lh6.googleusercontent.com/LmfnOM1rnucGJx1rP10GkF7ht19ZXFqZr5VKvL4V-xiL2BqYr5h-Fj0_63gJgjux3kRPHBA9iw0q9Y7JhTHjPTCNEFdliy47bOmTvwPF0Z1aD9XRYFv1H0wHiOdCMHsPp482ewdsvgvqPtis5A" style="max-width:800px;height:auto;width:auto;" width="840"/><figcaption>Phishing email targeting government entities in Georgia.</figcaption></figure>
<p>Phishing email sent to the Ukrainian government. Translation from Ukrainian – Subject: “Payments to ATO Veterans.” Content: “It must be filled in and sent back.”</p>
<p>Another campaign that was recently discovered by our research team is a <a class="blog-text-link" href="https://www.intezer.com/blog/research/conversation-hijacking-campaign-delivering-icedid/">new IcedID campaign</a> that was delivered using a phishing email that uses conversation hijacking –threat actors use previously stolen email messages and use them in future attacks. This technique makes the emails look more legitimate and convincing. This campaign takes the hijacking a step further; the threat actors are now using the email address of the victim that they stole the original email from to make the phishing email even more convincing. </p>
<figure class="aligncenter"><img alt="" src="https://lh3.googleusercontent.com/iUwNQfmbcZJPQmi1vHsHcQU6EWwoC7zgmtln1q1Asrr52NRmrtzIYnWug3As2mspTVOC7MwSNtHwTvgRCx3FtLU9QTL1riO369NmHob8I6hZBSIREo5RRLVdFZXy85-EL4GG5i9P_CLf5VkLSg" style="max-width:80%;height:auto;width:auto;"/></figure>
<h2 id="h-conclusion">Conclusion</h2>
<p>Inspecting email files can be hard because emails are frequently used, meaning there are lots of files to cover. Also because emails can contain URLs to malicious sites or different types of attachments, all of which require different sorts of skills and methods to thoroughly inspect all of the artifacts.</p>
<p>To make this task easier and less demanding you should consider automating your email pipeline. The goal is to put time and effort only into truly malicious files. By extracting all of the attachments and piping them into Intezer you will get a comprehensive report about each file, which will allow you to proceed to the next step. If the file is malicious, start an incident response process. Otherwise, continue to the next task in your queue until the next email.</p>
<p>Want to learn more about automating your email pipeline? <a class="blog-text-link" href="https://www.intezer.com/book-a-demo-analyze/">Let’s book a time to talk.</a></p>
<img class="user-photo" src="https://149520725.v2.pressablecdn.com/wp-content/uploads/2020/07/Screenshot_20200720-202117__01-60x60.png" style="max-width:80%;height:auto;width:auto;"/> Nicole Fishbein<a class="twitter-link blog-text-link" href="https://twitter.com/NicoleFishi19" target="_blank"></a><p>Nicole is a malware analyst and reverse engineer. Prior to Intezer she was an embedded researcher in the Israel Defense Forces (IDF) Intelligence Corps.</p> <a class="blog-text-link" href="https://www.intezer.com/tag/attachments/" rel="tag">attachments</a> <a class="blog-text-link" href="https://www.intezer.com/tag/incident-response/" rel="tag">Incident Response</a> <a class="blog-text-link" href="https://www.intezer.com/tag/phishing-emails/" rel="tag">phishing emails</a> <a class="blog-text-link" href="https://www.intezer.com/tag/phishing-investigation-pipeline/" rel="tag">phishing investigation pipeline</a>
</div>