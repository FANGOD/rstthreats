{"id": "sentence_0x3a74e92a", "report_id": "report_0x390f5814", "report_date": "2022-05-26T00:00:00Z", "report_title": "Detecting and preventing privilege escalation attacks leveraging Kerberos relaying (KrbRelayUp)", "report_url": "https://www.microsoft.com/security/blog/2022/05/25/detecting-and-preventing-privilege-escalation-attacks-leveraging-kerberos-relaying-krbrelayup", "chapter_id": "chapter_0x860dfee9", "chapter_title": "Detecting and preventing privilege escalation attacks leveraging Kerberos relaying (KrbRelayUp)", "text": "Microsoft 365 Defender Research Team"}
{"id": "sentence_0xb3b3835a", "report_id": "report_0x390f5814", "report_date": "2022-05-26T00:00:00Z", "report_title": "Detecting and preventing privilege escalation attacks leveraging Kerberos relaying (KrbRelayUp)", "report_url": "https://www.microsoft.com/security/blog/2022/05/25/detecting-and-preventing-privilege-escalation-attacks-leveraging-kerberos-relaying-krbrelayup", "chapter_id": "chapter_0x860dfee9", "chapter_title": "Detecting and preventing privilege escalation attacks leveraging Kerberos relaying (KrbRelayUp)", "text": "Understanding the attack: What is resource-based constrained delegation?"}
{"id": "sentence_0x9e6df01b", "report_id": "report_0x390f5814", "report_date": "2022-05-26T00:00:00Z", "report_title": "Detecting and preventing privilege escalation attacks leveraging Kerberos relaying (KrbRelayUp)", "report_url": "https://www.microsoft.com/security/blog/2022/05/25/detecting-and-preventing-privilege-escalation-attacks-leveraging-kerberos-relaying-krbrelayup", "chapter_id": "chapter_0x860dfee9", "chapter_title": "Detecting and preventing privilege escalation attacks leveraging Kerberos relaying (KrbRelayUp)", "text": "Authentication protocol basics"}
{"id": "sentence_0xb86ec921", "report_id": "report_0x390f5814", "report_date": "2022-05-26T00:00:00Z", "report_title": "Detecting and preventing privilege escalation attacks leveraging Kerberos relaying (KrbRelayUp)", "report_url": "https://www.microsoft.com/security/blog/2022/05/25/detecting-and-preventing-privilege-escalation-attacks-leveraging-kerberos-relaying-krbrelayup", "chapter_id": "chapter_0x860dfee9", "chapter_title": "Detecting and preventing privilege escalation attacks leveraging Kerberos relaying (KrbRelayUp)", "text": "Delegation"}
{"id": "sentence_0x2bb07678", "report_id": "report_0x390f5814", "report_date": "2022-05-26T00:00:00Z", "report_title": "Detecting and preventing privilege escalation attacks leveraging Kerberos relaying (KrbRelayUp)", "report_url": "https://www.microsoft.com/security/blog/2022/05/25/detecting-and-preventing-privilege-escalation-attacks-leveraging-kerberos-relaying-krbrelayup", "chapter_id": "chapter_0x860dfee9", "chapter_title": "Detecting and preventing privilege escalation attacks leveraging Kerberos relaying (KrbRelayUp)", "text": "Resource-based constrained delegation"}
{"id": "sentence_0x5c5ea39", "report_id": "report_0x390f5814", "report_date": "2022-05-26T00:00:00Z", "report_title": "Detecting and preventing privilege escalation attacks leveraging Kerberos relaying (KrbRelayUp)", "report_url": "https://www.microsoft.com/security/blog/2022/05/25/detecting-and-preventing-privilege-escalation-attacks-leveraging-kerberos-relaying-krbrelayup", "chapter_id": "chapter_0x860dfee9", "chapter_title": "Detecting and preventing privilege escalation attacks leveraging Kerberos relaying (KrbRelayUp)", "text": "Unsigned LDAP and relay attacks"}
{"id": "sentence_0xa973f100", "report_id": "report_0x390f5814", "report_date": "2022-05-26T00:00:00Z", "report_title": "Detecting and preventing privilege escalation attacks leveraging Kerberos relaying (KrbRelayUp)", "report_url": "https://www.microsoft.com/security/blog/2022/05/25/detecting-and-preventing-privilege-escalation-attacks-leveraging-kerberos-relaying-krbrelayup", "chapter_id": "chapter_0x860dfee9", "chapter_title": "Detecting and preventing privilege escalation attacks leveraging Kerberos relaying (KrbRelayUp)", "text": "Ms-DS-MachineAccountQuota"}
{"id": "sentence_0xea690fc6", "report_id": "report_0x390f5814", "report_date": "2022-05-26T00:00:00Z", "report_title": "Detecting and preventing privilege escalation attacks leveraging Kerberos relaying (KrbRelayUp)", "report_url": "https://www.microsoft.com/security/blog/2022/05/25/detecting-and-preventing-privilege-escalation-attacks-leveraging-kerberos-relaying-krbrelayup", "chapter_id": "chapter_0x860dfee9", "chapter_title": "Detecting and preventing privilege escalation attacks leveraging Kerberos relaying (KrbRelayUp)", "text": "KrbRelayUp attack flow"}
{"id": "sentence_0x60cbdd07", "report_id": "report_0x390f5814", "report_date": "2022-05-26T00:00:00Z", "report_title": "Detecting and preventing privilege escalation attacks leveraging Kerberos relaying (KrbRelayUp)", "report_url": "https://www.microsoft.com/security/blog/2022/05/25/detecting-and-preventing-privilege-escalation-attacks-leveraging-kerberos-relaying-krbrelayup", "chapter_id": "chapter_0x860dfee9", "chapter_title": "Detecting and preventing privilege escalation attacks leveraging Kerberos relaying (KrbRelayUp)", "text": "Step 1: Acquisition of a suitable resource"}
{"id": "sentence_0xdad56fdb", "report_id": "report_0x390f5814", "report_date": "2022-05-26T00:00:00Z", "report_title": "Detecting and preventing privilege escalation attacks leveraging Kerberos relaying (KrbRelayUp)", "report_url": "https://www.microsoft.com/security/blog/2022/05/25/detecting-and-preventing-privilege-escalation-attacks-leveraging-kerberos-relaying-krbrelayup", "chapter_id": "chapter_0x860dfee9", "chapter_title": "Detecting and preventing privilege escalation attacks leveraging Kerberos relaying (KrbRelayUp)", "text": "Step 2: Modification of the msDS-AllowedToActOnBehalfOfOtherIdentity attribute"}
{"id": "sentence_0x6c7187a5", "report_id": "report_0x390f5814", "report_date": "2022-05-26T00:00:00Z", "report_title": "Detecting and preventing privilege escalation attacks leveraging Kerberos relaying (KrbRelayUp)", "report_url": "https://www.microsoft.com/security/blog/2022/05/25/detecting-and-preventing-privilege-escalation-attacks-leveraging-kerberos-relaying-krbrelayup", "chapter_id": "chapter_0x860dfee9", "chapter_title": "Detecting and preventing privilege escalation attacks leveraging Kerberos relaying (KrbRelayUp)", "text": "Step 3: Privileged ticket acquisition"}
{"id": "sentence_0x5afde0fb", "report_id": "report_0x390f5814", "report_date": "2022-05-26T00:00:00Z", "report_title": "Detecting and preventing privilege escalation attacks leveraging Kerberos relaying (KrbRelayUp)", "report_url": "https://www.microsoft.com/security/blog/2022/05/25/detecting-and-preventing-privilege-escalation-attacks-leveraging-kerberos-relaying-krbrelayup", "chapter_id": "chapter_0x860dfee9", "chapter_title": "Detecting and preventing privilege escalation attacks leveraging Kerberos relaying (KrbRelayUp)", "text": "Step 4: Privileged ticket leverage"}
{"id": "sentence_0xc4d5eafe", "report_id": "report_0x390f5814", "report_date": "2022-05-26T00:00:00Z", "report_title": "Detecting and preventing privilege escalation attacks leveraging Kerberos relaying (KrbRelayUp)", "report_url": "https://www.microsoft.com/security/blog/2022/05/25/detecting-and-preventing-privilege-escalation-attacks-leveraging-kerberos-relaying-krbrelayup", "chapter_id": "chapter_0x860dfee9", "chapter_title": "Detecting and preventing privilege escalation attacks leveraging Kerberos relaying (KrbRelayUp)", "text": "Protecting against KrbRelayUp attacks through coordinated threat defense"}
{"id": "sentence_0xf036338", "report_id": "report_0x390f5814", "report_date": "2022-05-26T00:00:00Z", "report_title": "Detecting and preventing privilege escalation attacks leveraging Kerberos relaying (KrbRelayUp)", "report_url": "https://www.microsoft.com/security/blog/2022/05/25/detecting-and-preventing-privilege-escalation-attacks-leveraging-kerberos-relaying-krbrelayup", "chapter_id": "chapter_0x860dfee9", "chapter_title": "Detecting and preventing privilege escalation attacks leveraging Kerberos relaying (KrbRelayUp)", "text": "Detection details"}
{"id": "sentence_0xbcd8a398", "report_id": "report_0x390f5814", "report_date": "2022-05-26T00:00:00Z", "report_title": "Detecting and preventing privilege escalation attacks leveraging Kerberos relaying (KrbRelayUp)", "report_url": "https://www.microsoft.com/security/blog/2022/05/25/detecting-and-preventing-privilege-escalation-attacks-leveraging-kerberos-relaying-krbrelayup", "chapter_id": "chapter_0x860dfee9", "chapter_title": "Detecting and preventing privilege escalation attacks leveraging Kerberos relaying (KrbRelayUp)", "text": "Resources"}
{"id": "sentence_0x491d4f86", "report_id": "report_0x390f5814", "report_date": "2022-05-26T00:00:00Z", "report_title": "Detecting and preventing privilege escalation attacks leveraging Kerberos relaying (KrbRelayUp)", "report_url": "https://www.microsoft.com/security/blog/2022/05/25/detecting-and-preventing-privilege-escalation-attacks-leveraging-kerberos-relaying-krbrelayup", "chapter_id": "chapter_0x6e5d046c", "chapter_title": "Detecting and preventing privilege escalation attacks leveraging Kerberos relaying (KrbRelayUp)", "text": "On April 24, 2022, a privilege escalation hacking tool, KrbRelayUp, was publicly disclosed on GitHub by security researcher Mor Davidovich. KrbRelayUp is a wrapper that can streamline the use of some features in Rubeus, KrbRelay, SCMUACBypass, PowerMad/SharpMad, Whisker, and ADCSPwn tools in attacks."}
{"id": "sentence_0x3284e0a1", "report_id": "report_0x390f5814", "report_date": "2022-05-26T00:00:00Z", "report_title": "Detecting and preventing privilege escalation attacks leveraging Kerberos relaying (KrbRelayUp)", "report_url": "https://www.microsoft.com/security/blog/2022/05/25/detecting-and-preventing-privilege-escalation-attacks-leveraging-kerberos-relaying-krbrelayup", "chapter_id": "chapter_0x6e5d046c", "chapter_title": "Detecting and preventing privilege escalation attacks leveraging Kerberos relaying (KrbRelayUp)", "text": "Although this attack wont function for Azure Active Directory (Azure AD) joined devices, hybrid joined devices with on-premises domain controllers remain vulnerable. Microsoft Defender for Identity detects activity from the early stages of the attack chain by monitoring anomalous behavior as seen by the domain controller. In addition, signals from Defender for Identity also feed into Microsoft 365 Defender, providing organizations with a comprehensive solution that detects and blocks suspicious network activities, malicious files, and other related components of this attack. Microsoft Defender Antivirus detects this attack tool as the malware family HackTool:MSIL/KrbUpRly."}
{"id": "sentence_0x4b2267ed", "report_id": "report_0x390f5814", "report_date": "2022-05-26T00:00:00Z", "report_title": "Detecting and preventing privilege escalation attacks leveraging Kerberos relaying (KrbRelayUp)", "report_url": "https://www.microsoft.com/security/blog/2022/05/25/detecting-and-preventing-privilege-escalation-attacks-leveraging-kerberos-relaying-krbrelayup", "chapter_id": "chapter_0x6e5d046c", "chapter_title": "Detecting and preventing privilege escalation attacks leveraging Kerberos relaying (KrbRelayUp)", "text": "Microsoft encourages customers to update Domain Controller: LDAP server signing requirements to Require signing as detailed in this advisory and enable Extended Protection for Authentication (EPA) as detailed in this blog."}
{"id": "sentence_0x893827ba", "report_id": "report_0x390f5814", "report_date": "2022-05-26T00:00:00Z", "report_title": "Detecting and preventing privilege escalation attacks leveraging Kerberos relaying (KrbRelayUp)", "report_url": "https://www.microsoft.com/security/blog/2022/05/25/detecting-and-preventing-privilege-escalation-attacks-leveraging-kerberos-relaying-krbrelayup", "chapter_id": "chapter_0x6e5d046c", "chapter_title": "Detecting and preventing privilege escalation attacks leveraging Kerberos relaying (KrbRelayUp)", "text": "Originally, KrbRelayUp supported only one method thats based on taking advantage of resource-based constrained delegation (RBCD); it later added several additional attack methods. In this blog, we discuss RBCD to provide further insights into how the initial KrbRelayUp attack method works. We also detail the stages that make up the said attack. Finally, we provide recommendations and guidelines that can help organizations strengthen their device configurations and defend their networks from attacks that use this tool."}
{"id": "sentence_0xb2eca6df", "report_id": "report_0x390f5814", "report_date": "2022-05-26T00:00:00Z", "report_title": "Detecting and preventing privilege escalation attacks leveraging Kerberos relaying (KrbRelayUp)", "report_url": "https://www.microsoft.com/security/blog/2022/05/25/detecting-and-preventing-privilege-escalation-attacks-leveraging-kerberos-relaying-krbrelayup", "chapter_id": "chapter_0x29042714", "chapter_title": "Understanding the attack: What is resource-based constrained delegation?", "text": "Resource-based constrained delegation (RBCD) represents the key to this attack method, enabling the tool to impersonate an administrator and eventually run a code as the SYSTEM account of a compromised device."}
{"id": "sentence_0x53eefb5c", "report_id": "report_0x390f5814", "report_date": "2022-05-26T00:00:00Z", "report_title": "Detecting and preventing privilege escalation attacks leveraging Kerberos relaying (KrbRelayUp)", "report_url": "https://www.microsoft.com/security/blog/2022/05/25/detecting-and-preventing-privilege-escalation-attacks-leveraging-kerberos-relaying-krbrelayup", "chapter_id": "chapter_0x1626f43c", "chapter_title": "Authentication protocol basics", "text": "An authentication protocol verifies the legitimacy of a resource or identity. When a user signs into a website, that website uses a methodology to confirm the authenticity of the resource requesting access. In simpler terms, the authentication process involves signing in with a passwordmade possible by the user knowing the password anticipated by the website. The Kerberos protocol serves as the main authentication framework for this process in on-premises Active Directory."}
{"id": "sentence_0x1baf3749", "report_id": "report_0x390f5814", "report_date": "2022-05-26T00:00:00Z", "report_title": "Detecting and preventing privilege escalation attacks leveraging Kerberos relaying (KrbRelayUp)", "report_url": "https://www.microsoft.com/security/blog/2022/05/25/detecting-and-preventing-privilege-escalation-attacks-leveraging-kerberos-relaying-krbrelayup", "chapter_id": "chapter_0x2daa733d", "chapter_title": "Delegation", "text": "Sometimes, however, a resource needs to request access to another resource on behalf of a different identity. A common example of this is mail delegation, wherein executives often give delegation rights to their executive assistants to send and receive emails on their behalf without providing the assistant with the executives password. The executive assistant isnt authenticating as the executive; the executive has just allowed the assistants account to pretend that they are."}
{"id": "sentence_0xbd4ca78f", "report_id": "report_0x390f5814", "report_date": "2022-05-26T00:00:00Z", "report_title": "Detecting and preventing privilege escalation attacks leveraging Kerberos relaying (KrbRelayUp)", "report_url": "https://www.microsoft.com/security/blog/2022/05/25/detecting-and-preventing-privilege-escalation-attacks-leveraging-kerberos-relaying-krbrelayup", "chapter_id": "chapter_0x42c1e872", "chapter_title": "Resource-based constrained delegation", "text": "Initially, only users with the SeEnableDelegation role could configure delegation, typically domain admins. These domain admins can manage resources and dictate which identities can act on behalf of a different resource. They achieve this by updating the msDS-AllowedToDelegateTo property of a user account or device. This property contains a list of all the unique identifiers (service principal names, or SPNs) to which this object can delegate or act on behalf of."}
{"id": "sentence_0xf5fbb02", "report_id": "report_0x390f5814", "report_date": "2022-05-26T00:00:00Z", "report_title": "Detecting and preventing privilege escalation attacks leveraging Kerberos relaying (KrbRelayUp)", "report_url": "https://www.microsoft.com/security/blog/2022/05/25/detecting-and-preventing-privilege-escalation-attacks-leveraging-kerberos-relaying-krbrelayup", "chapter_id": "chapter_0x42c1e872", "chapter_title": "Resource-based constrained delegation", "text": "However, as organizations expanded, administrators struggled to manage all the delegation requirements, raising the need for a new type of delegation: resource-based. For instance, in an organization with several file servers that all trust a web server for delegation, an admin would have to change the msDS-AllowedToDelegateTo priority in all of the different file servers to introduce a second web server. With resource-based delegation, the list of trusted computers is held on the receiving end. Thus, in our example, only the newly created server would require a change of settings."}
{"id": "sentence_0x9addffc6", "report_id": "report_0x390f5814", "report_date": "2022-05-26T00:00:00Z", "report_title": "Detecting and preventing privilege escalation attacks leveraging Kerberos relaying (KrbRelayUp)", "report_url": "https://www.microsoft.com/security/blog/2022/05/25/detecting-and-preventing-privilege-escalation-attacks-leveraging-kerberos-relaying-krbrelayup", "chapter_id": "chapter_0x4d2fc182", "chapter_title": "Unsigned LDAP and relay attacks", "text": "For the RBCD method of the KrbRelayUp tool to work, the LDAP protocol must not use signing to communicate between LDAP clients and domain controllers. While this setting is still the default on Windows, as of 2019 Microsoft recommends configuring LDAP to use LDAP channel binding and signing."}
{"id": "sentence_0x50e9b854", "report_id": "report_0x390f5814", "report_date": "2022-05-26T00:00:00Z", "report_title": "Detecting and preventing privilege escalation attacks leveraging Kerberos relaying (KrbRelayUp)", "report_url": "https://www.microsoft.com/security/blog/2022/05/25/detecting-and-preventing-privilege-escalation-attacks-leveraging-kerberos-relaying-krbrelayup", "chapter_id": "chapter_0x4d2fc182", "chapter_title": "Unsigned LDAP and relay attacks", "text": "LDAP is one of the main protocols that directory services tools, such as Active Directory, use to query and access directory information. By default, LDAP is vulnerable to credential relaying attacks. For example, in a credential relaying attack, a web server requesting a password to sign in would have its request relayed by an attacker to an authorized client. The attacker then relays the client reply containing the correct password back to the server, thus signing in. Once the attacker is signed in, they have the same permissions as the user whose credentials were relayed."}
{"id": "sentence_0xdd50c69b", "report_id": "report_0x390f5814", "report_date": "2022-05-26T00:00:00Z", "report_title": "Detecting and preventing privilege escalation attacks leveraging Kerberos relaying (KrbRelayUp)", "report_url": "https://www.microsoft.com/security/blog/2022/05/25/detecting-and-preventing-privilege-escalation-attacks-leveraging-kerberos-relaying-krbrelayup", "chapter_id": "chapter_0x4d2fc182", "chapter_title": "Unsigned LDAP and relay attacks", "text": "If LDAP signing is required, each request to the server needs to be cryptographically signed. In this case, the attacker would still be able to relay the sign-in request and reply, but all further requests from the attacker would be disregarded because each request must be signed, and the attacker doesnt have the proper keys to do the signing."}
{"id": "sentence_0xdae079b7", "report_id": "report_0x390f5814", "report_date": "2022-05-26T00:00:00Z", "report_title": "Detecting and preventing privilege escalation attacks leveraging Kerberos relaying (KrbRelayUp)", "report_url": "https://www.microsoft.com/security/blog/2022/05/25/detecting-and-preventing-privilege-escalation-attacks-leveraging-kerberos-relaying-krbrelayup", "chapter_id": "chapter_0xa5fb08e", "chapter_title": "Ms-DS-MachineAccountQuota", "text": "The final key concept behind the RBCD method of KrbRelayUp tool is the ms-DS-MachineAccountQuota attribute, which all User Active Directory objects have. This attribute is set to 10 by default, which means that any user in Active Directory can create up to 10 computer accounts associated with them. The legitimate usage of this attribute is to allow users to have multiple devices on a network that belong to them that they can then manage. However, if a compromised user doesnt have 10 actual devices associated with their account, an attacker can create an account for a non-existing device that will be an object in Active Directory. This fake computer account isnt associated with a real device but can perform Active Directory authentication requests as if it were."}
{"id": "sentence_0xbda1b3b8", "report_id": "report_0x390f5814", "report_date": "2022-05-26T00:00:00Z", "report_title": "Detecting and preventing privilege escalation attacks leveraging Kerberos relaying (KrbRelayUp)", "report_url": "https://www.microsoft.com/security/blog/2022/05/25/detecting-and-preventing-privilege-escalation-attacks-leveraging-kerberos-relaying-krbrelayup", "chapter_id": "chapter_0xa5fb08e", "chapter_title": "Ms-DS-MachineAccountQuota", "text": "Initially, the ability to obtain such an account was a prerequisite for this attack method, but since the release of the tool, other security researchers found ways to get around this requirement."}
{"id": "sentence_0x15ab11db", "report_id": "report_0x390f5814", "report_date": "2022-05-26T00:00:00Z", "report_title": "Detecting and preventing privilege escalation attacks leveraging Kerberos relaying (KrbRelayUp)", "report_url": "https://www.microsoft.com/security/blog/2022/05/25/detecting-and-preventing-privilege-escalation-attacks-leveraging-kerberos-relaying-krbrelayup", "chapter_id": "chapter_0xc358491e", "chapter_title": "KrbRelayUp attack flow", "text": "To launch an attack using the RBCD method of KrbRelayUp, an attacker performs four main steps:"}
{"id": "sentence_0xdc077e83", "report_id": "report_0x390f5814", "report_date": "2022-05-26T00:00:00Z", "report_title": "Detecting and preventing privilege escalation attacks leveraging Kerberos relaying (KrbRelayUp)", "report_url": "https://www.microsoft.com/security/blog/2022/05/25/detecting-and-preventing-privilege-escalation-attacks-leveraging-kerberos-relaying-krbrelayup", "chapter_id": "chapter_0xb187d618", "chapter_title": "Step 1: Acquisition of a suitable resource", "text": "The attacker first obtains a resource suitable to be the source of an RBCD. There are several ways to obtain such a resource; the most straightforward way is to create a new computer account as discussed above."}
{"id": "sentence_0xc0cf1681", "report_id": "report_0x390f5814", "report_date": "2022-05-26T00:00:00Z", "report_title": "Detecting and preventing privilege escalation attacks leveraging Kerberos relaying (KrbRelayUp)", "report_url": "https://www.microsoft.com/security/blog/2022/05/25/detecting-and-preventing-privilege-escalation-attacks-leveraging-kerberos-relaying-krbrelayup", "chapter_id": "chapter_0xeb41efd3", "chapter_title": "Step 2: Modification of the msDS-AllowedToActOnBehalfOfOtherIdentity attribute", "text": "Next, the attacker adds their resource to the current devices list of trusted resources. To do this, the attacker starts an LDAP session and relays the credentials of the current device to the LDAP server."}
{"id": "sentence_0x161e639b", "report_id": "report_0x390f5814", "report_date": "2022-05-26T00:00:00Z", "report_title": "Detecting and preventing privilege escalation attacks leveraging Kerberos relaying (KrbRelayUp)", "report_url": "https://www.microsoft.com/security/blog/2022/05/25/detecting-and-preventing-privilege-escalation-attacks-leveraging-kerberos-relaying-krbrelayup", "chapter_id": "chapter_0xeb41efd3", "chapter_title": "Step 2: Modification of the msDS-AllowedToActOnBehalfOfOtherIdentity attribute", "text": "The new KrbRelayUp tool implements this step with these two smaller consecutive actions:"}
{"id": "sentence_0xafc98887", "report_id": "report_0x390f5814", "report_date": "2022-05-26T00:00:00Z", "report_title": "Detecting and preventing privilege escalation attacks leveraging Kerberos relaying (KrbRelayUp)", "report_url": "https://www.microsoft.com/security/blog/2022/05/25/detecting-and-preventing-privilege-escalation-attacks-leveraging-kerberos-relaying-krbrelayup", "chapter_id": "chapter_0xeb41efd3", "chapter_title": "Step 2: Modification of the msDS-AllowedToActOnBehalfOfOtherIdentity attribute", "text": "Authenticates to the LDAP service by triggering and performing a Kerberos relay attack Edits the msDS-AllowedToActOnBehalfOfOtherIdentity attribute to add the attackers resource to the list of entities permitted to delegate the target device."}
{"id": "sentence_0x5fa1e600", "report_id": "report_0x390f5814", "report_date": "2022-05-26T00:00:00Z", "report_title": "Detecting and preventing privilege escalation attacks leveraging Kerberos relaying (KrbRelayUp)", "report_url": "https://www.microsoft.com/security/blog/2022/05/25/detecting-and-preventing-privilege-escalation-attacks-leveraging-kerberos-relaying-krbrelayup", "chapter_id": "chapter_0x2ff010ec", "chapter_title": "Step 3: Privileged ticket acquisition", "text": "Here, the attacker leverages their control over their resource gained through the first step with the trust for their resource gained through the second step. As such, the local device trusts the attackers resource to request a ticket addressed to the host SPN as the domain administrator. The request is made by first pretending to be the attackers resource and consists of three requests:"}
{"id": "sentence_0xbaa47fe1", "report_id": "report_0x390f5814", "report_date": "2022-05-26T00:00:00Z", "report_title": "Detecting and preventing privilege escalation attacks leveraging Kerberos relaying (KrbRelayUp)", "report_url": "https://www.microsoft.com/security/blog/2022/05/25/detecting-and-preventing-privilege-escalation-attacks-leveraging-kerberos-relaying-krbrelayup", "chapter_id": "chapter_0x2ff010ec", "chapter_title": "Step 3: Privileged ticket acquisition", "text": "AS-Req A request to generate a Ticket Granting Ticket (TGT) for the attackers impersonated resource. S4U2self A request to generate a Ticket Granting Service (TGS) ticket from an administrator to the resource. S4U2proxy A request to generate a TGS ticket for the host SPN as an administrator delegating their access via the impersonated resource."}
{"id": "sentence_0x49e6d069", "report_id": "report_0x390f5814", "report_date": "2022-05-26T00:00:00Z", "report_title": "Detecting and preventing privilege escalation attacks leveraging Kerberos relaying (KrbRelayUp)", "report_url": "https://www.microsoft.com/security/blog/2022/05/25/detecting-and-preventing-privilege-escalation-attacks-leveraging-kerberos-relaying-krbrelayup", "chapter_id": "chapter_0x2ff010ec", "chapter_title": "Step 3: Privileged ticket acquisition", "text": "After this step, the attacker has a valid ticket for the local device that allows the administrator to be impersonated."}
{"id": "sentence_0x510a1680", "report_id": "report_0x390f5814", "report_date": "2022-05-26T00:00:00Z", "report_title": "Detecting and preventing privilege escalation attacks leveraging Kerberos relaying (KrbRelayUp)", "report_url": "https://www.microsoft.com/security/blog/2022/05/25/detecting-and-preventing-privilege-escalation-attacks-leveraging-kerberos-relaying-krbrelayup", "chapter_id": "chapter_0xe3974f29", "chapter_title": "Step 4: Privileged ticket leverage", "text": "The last step leverages the attackers newly acquired ticket to run code on the device. In the attack, as its published online, the Service Control Manager (SCM) is asked to create a new service with SYSTEM permissions."}
{"id": "sentence_0x2d97dba6", "report_id": "report_0x390f5814", "report_date": "2022-05-26T00:00:00Z", "report_title": "Detecting and preventing privilege escalation attacks leveraging Kerberos relaying (KrbRelayUp)", "report_url": "https://www.microsoft.com/security/blog/2022/05/25/detecting-and-preventing-privilege-escalation-attacks-leveraging-kerberos-relaying-krbrelayup", "chapter_id": "chapter_0x43f21c10", "chapter_title": "Protecting against KrbRelayUp attacks through coordinated threat defense", "text": "Its important to note that KrbRelayUp cannot be used in attacks against organizations that are only using Azure AD. However, in hybrid identity environments where organizations synchronize their domain controllers with Azure AD, if an attacker compromises an Azure virtual machine using a synchronized account, theyll receive SYSTEM privileges on the virtual machine."}
{"id": "sentence_0x372ce16a", "report_id": "report_0x390f5814", "report_date": "2022-05-26T00:00:00Z", "report_title": "Detecting and preventing privilege escalation attacks leveraging Kerberos relaying (KrbRelayUp)", "report_url": "https://www.microsoft.com/security/blog/2022/05/25/detecting-and-preventing-privilege-escalation-attacks-leveraging-kerberos-relaying-krbrelayup", "chapter_id": "chapter_0x43f21c10", "chapter_title": "Protecting against KrbRelayUp attacks through coordinated threat defense", "text": "To reduce the impact of this threat, organizations should apply the mitigations below. Microsoft 365 Defender customers can check the recommendations card for the deployment status of monitored mitigations."}
{"id": "sentence_0x44438b03", "report_id": "report_0x390f5814", "report_date": "2022-05-26T00:00:00Z", "report_title": "Detecting and preventing privilege escalation attacks leveraging Kerberos relaying (KrbRelayUp)", "report_url": "https://www.microsoft.com/security/blog/2022/05/25/detecting-and-preventing-privilege-escalation-attacks-leveraging-kerberos-relaying-krbrelayup", "chapter_id": "chapter_0x43f21c10", "chapter_title": "Protecting against KrbRelayUp attacks through coordinated threat defense", "text": "Microsoft has provided guidance for enabling LDAP channel binding and LDAP signing. Microsoft recommends that administrators configure LDAP signing and LDAP channel binding as recommended in the said advisory and described in detail in 2020 LDAP channel binding and LDAP signing requirements for Windows (KB4520412). Organizations should also consider setting the ms-DS-MachineAccountQuota attribute to 0 to make it more difficult for an attacker to leverage the attribute for attacks. Setting the attribute to 0 stops non-admin users from adding new devices to the domain, blocking the most effective method to carry out the attacks first step and forcing attackers to choose more complex methods to acquire a suitable resource."}
{"id": "sentence_0xa5c6e2f8", "report_id": "report_0x390f5814", "report_date": "2022-05-26T00:00:00Z", "report_title": "Detecting and preventing privilege escalation attacks leveraging Kerberos relaying (KrbRelayUp)", "report_url": "https://www.microsoft.com/security/blog/2022/05/25/detecting-and-preventing-privilege-escalation-attacks-leveraging-kerberos-relaying-krbrelayup", "chapter_id": "chapter_0x2158cf41", "chapter_title": "Detection details", "text": "Organizations should also deploy a comprehensive security solution like Microsoft 365 Defender to detect and block this threat across the stages of the attack chain. Microsoft 365 Defender has multiple layers of dynamic protection technologies, including machine learning-based protection, and correlates threat data from email, endpoints, identities, and cloud apps to provide in-depth and coordinated threat defense. All of these are backed by threat experts who continuously monitor the threat landscape for new attacker tools and techniques."}
{"id": "sentence_0xc15ae946", "report_id": "report_0x390f5814", "report_date": "2022-05-26T00:00:00Z", "report_title": "Detecting and preventing privilege escalation attacks leveraging Kerberos relaying (KrbRelayUp)", "report_url": "https://www.microsoft.com/security/blog/2022/05/25/detecting-and-preventing-privilege-escalation-attacks-leveraging-kerberos-relaying-krbrelayup", "chapter_id": "chapter_0x2158cf41", "chapter_title": "Detection details", "text": "Microsoft Defender for Identity detects activity from the first three steps of the attack flow by monitoring anomalous behavior as seen by the domain controller. Starting in version 2.180, Defender for Identity has two detections that raise an alert when this attack is attempted:"}
{"id": "sentence_0x476c11be", "report_id": "report_0x390f5814", "report_date": "2022-05-26T00:00:00Z", "report_title": "Detecting and preventing privilege escalation attacks leveraging Kerberos relaying (KrbRelayUp)", "report_url": "https://www.microsoft.com/security/blog/2022/05/25/detecting-and-preventing-privilege-escalation-attacks-leveraging-kerberos-relaying-krbrelayup", "chapter_id": "chapter_0x2158cf41", "chapter_title": "Detection details", "text": "Suspicious Kerberos delegation attempt by a newly created computer. Suspicious edit of the Resource Based Constrained Delegation Attribute by a machine account (KrbRelayUp)."}
{"id": "sentence_0xf6a3505e", "report_id": "report_0x390f5814", "report_date": "2022-05-26T00:00:00Z", "report_title": "Detecting and preventing privilege escalation attacks leveraging Kerberos relaying (KrbRelayUp)", "report_url": "https://www.microsoft.com/security/blog/2022/05/25/detecting-and-preventing-privilege-escalation-attacks-leveraging-kerberos-relaying-krbrelayup", "chapter_id": "chapter_0x2158cf41", "chapter_title": "Detection details", "text": "Figure 1. Suspicious Kerberos delegation attempt by a newly created computer alert in Microsoft Defender for Identity"}
{"id": "sentence_0x4da8a976", "report_id": "report_0x390f5814", "report_date": "2022-05-26T00:00:00Z", "report_title": "Detecting and preventing privilege escalation attacks leveraging Kerberos relaying (KrbRelayUp)", "report_url": "https://www.microsoft.com/security/blog/2022/05/25/detecting-and-preventing-privilege-escalation-attacks-leveraging-kerberos-relaying-krbrelayup", "chapter_id": "chapter_0x2158cf41", "chapter_title": "Detection details", "text": "Microsoft Defender for Endpoint includes new and enhanced network inspection capabilities to correlate network and endpoint signals and emit high-confidence alerts. Defender for Endpoint leverages these network signals and looks for suspicious LDAP and Kerberos requests to Active Directory domain controllers to accurately detect attacks using KrbRelayUp. Defender for Endpoint also detects suspicious Kerberos sign-ins and service creations."}
{"id": "sentence_0x564bab41", "report_id": "report_0x390f5814", "report_date": "2022-05-26T00:00:00Z", "report_title": "Detecting and preventing privilege escalation attacks leveraging Kerberos relaying (KrbRelayUp)", "report_url": "https://www.microsoft.com/security/blog/2022/05/25/detecting-and-preventing-privilege-escalation-attacks-leveraging-kerberos-relaying-krbrelayup", "chapter_id": "chapter_0x2158cf41", "chapter_title": "Detection details", "text": "Figure 2. Possible Kerberos local privilege escalation relay attack alert in Microsoft Defender for Endpoint"}
{"id": "sentence_0xcb8d4eed", "report_id": "report_0x390f5814", "report_date": "2022-05-26T00:00:00Z", "report_title": "Detecting and preventing privilege escalation attacks leveraging Kerberos relaying (KrbRelayUp)", "report_url": "https://www.microsoft.com/security/blog/2022/05/25/detecting-and-preventing-privilege-escalation-attacks-leveraging-kerberos-relaying-krbrelayup", "chapter_id": "chapter_0x2158cf41", "chapter_title": "Detection details", "text": "Microsoft Defender Antivirus detects a threat from the KrbRelayUp tool as the following malware:"}
{"id": "sentence_0x89bf25a4", "report_id": "report_0x390f5814", "report_date": "2022-05-26T00:00:00Z", "report_title": "Detecting and preventing privilege escalation attacks leveraging Kerberos relaying (KrbRelayUp)", "report_url": "https://www.microsoft.com/security/blog/2022/05/25/detecting-and-preventing-privilege-escalation-attacks-leveraging-kerberos-relaying-krbrelayup", "chapter_id": "chapter_0x2158cf41", "chapter_title": "Detection details", "text": "HackTool:MSIL/KrbUpRly.A HackTool:MSIL/KrbUpRly.C HackTool:MSIL/KrbUpRly.D"}
{"id": "sentence_0x9a9b0f9a", "report_id": "report_0x390f5814", "report_date": "2022-05-26T00:00:00Z", "report_title": "Detecting and preventing privilege escalation attacks leveraging Kerberos relaying (KrbRelayUp)", "report_url": "https://www.microsoft.com/security/blog/2022/05/25/detecting-and-preventing-privilege-escalation-attacks-leveraging-kerberos-relaying-krbrelayup", "chapter_id": "chapter_0x2158cf41", "chapter_title": "Detection details", "text": "Microsoft 365 Defender customers may refer to the threat analytics report to determine if this threat is present in their network and to get additional details and recommendations. Threat analytics enables organizations to assess the impact of a threat to their network, review exposure and resilience, and perform mitigation, recovery, or prevention actions to stop or contain active attacks."}
{"id": "sentence_0x24efc438", "report_id": "report_0x390f5814", "report_date": "2022-05-26T00:00:00Z", "report_title": "Detecting and preventing privilege escalation attacks leveraging Kerberos relaying (KrbRelayUp)", "report_url": "https://www.microsoft.com/security/blog/2022/05/25/detecting-and-preventing-privilege-escalation-attacks-leveraging-kerberos-relaying-krbrelayup", "chapter_id": "chapter_0x2158cf41", "chapter_title": "Detection details", "text": "Learn how you can stop attacks through automated, cross-domain security with Microsoft 365 Defender."}
{"id": "sentence_0x3d03bd64", "report_id": "report_0x390f5814", "report_date": "2022-05-26T00:00:00Z", "report_title": "Detecting and preventing privilege escalation attacks leveraging Kerberos relaying (KrbRelayUp)", "report_url": "https://www.microsoft.com/security/blog/2022/05/25/detecting-and-preventing-privilege-escalation-attacks-leveraging-kerberos-relaying-krbrelayup", "chapter_id": "chapter_0x2158cf41", "chapter_title": "Detection details", "text": "Zeev Rabinovich and Ofir Shlomo Microsoft 365 Defender Research Team"}
