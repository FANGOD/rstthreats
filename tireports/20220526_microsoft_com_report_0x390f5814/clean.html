<div>
<p>On April 24, 2022, a privilege escalation hacking tool, <a href="https://github.com/Dec0ne/KrbRelayUp">KrbRelayUp</a>, was publicly disclosed on GitHub by security researcher Mor Davidovich. KrbRelayUp is a wrapper that can streamline the use of some features in Rubeus, KrbRelay, SCMUACBypass, PowerMad/SharpMad, Whisker, and ADCSPwn tools in attacks.</p>
<p>Although this attack won’t function for Azure Active Directory (Azure AD) joined devices, hybrid joined devices with on-premises domain controllers remain vulnerable. <a href="https://www.microsoft.com/security/business/threat-protection/identity-defender">Microsoft Defender for Identity</a> detects activity from the early stages of the attack chain by monitoring anomalous behavior as seen by the domain controller. In addition, signals from Defender for Identity also feed into <a href="https://www.microsoft.com/security/business/threat-protection/microsoft-365-defender">Microsoft 365 Defender</a>, providing organizations with a comprehensive solution that detects and blocks suspicious network activities, malicious files, and other related components of this attack. Microsoft Defender Antivirus detects this attack tool as the malware family <a href="https://www.microsoft.com/en-us/wdsi/threats/threat-search?query=HackTool:MSIL/KrbUpRly">HackTool:MSIL/KrbUpRly</a>.</p>
<p>Microsoft encourages customers to update Domain Controller: LDAP server signing requirements to Require signing as detailed in <a href="https://msrc.microsoft.com/update-guide/vulnerability/ADV190023">this advisory</a> and enable Extended Protection for Authentication (EPA) as detailed in <a href="https://msrc-blog.microsoft.com/2009/12/08/extended-protection-for-authentication/">this blog</a>.</p>
<p>Originally, KrbRelayUp supported only one method that’s based on taking advantage of resource-based constrained delegation (RBCD); it later added several additional attack methods. In this blog, we discuss RBCD to provide further insights into how the initial KrbRelayUp attack method works. We also detail the stages that make up the said attack. Finally, we provide recommendations and guidelines that can help organizations strengthen their device configurations and defend their networks from attacks that use this tool.</p>
<h2>Understanding the attack: What is resource-based constrained delegation?</h2>
<p>Resource-based constrained delegation (RBCD) represents the key to this attack method, enabling the tool to impersonate an administrator and eventually run a code as the SYSTEM account of a compromised device.</p>
<h3>Authentication protocol basics</h3>
<p>An authentication protocol verifies the legitimacy of a resource or identity. When a user signs into a website, that website uses a methodology to confirm the authenticity of the resource requesting access. In simpler terms, the authentication process involves signing in with a password—made possible by the user knowing the password anticipated by the website. The Kerberos protocol serves as the main authentication framework for this process in on-premises Active Directory.</p>
<h3>Delegation</h3>
<p>Sometimes, however, a resource needs to request access to another resource on behalf of a different identity. A common example of this is mail delegation, wherein executives often give delegation rights to their executive assistants to send and receive emails on their behalf without providing the assistant with the executive’s password. The executive assistant isn’t authenticating as the executive; the executive has just allowed the assistant’s account to “pretend” that they are.</p>
<h3>Resource-based constrained delegation</h3>
<p>Initially, only users with the SeEnableDelegation role could configure delegation, typically domain admins. These domain admins can manage resources and dictate which identities can act on behalf of a different resource. They achieve this by updating the msDS-AllowedToDelegateTo property of a user account or device. This property contains a list of all the unique identifiers (service principal names, or SPNs) to which this object can delegate or act on behalf of.</p>
<p>However, as organizations expanded, administrators struggled to manage all the delegation requirements, raising the need for a new type of delegation: resource-based. For instance, in an organization with several file servers that all trust a web server for delegation, an admin would have to change the msDS-AllowedToDelegateTo priority in all of the different file servers to introduce a second web server. With resource-based delegation, the list of trusted computers is held on the receiving end. Thus, in our example, only the newly created server would require a change of settings.</p>
<h2>Unsigned LDAP and relay attacks</h2>
<p>For the RBCD method of the KrbRelayUp tool to work, the LDAP protocol must not use signing to communicate between LDAP clients and domain controllers. While this setting is still the default on Windows, as of 2019 Microsoft recommends <a href="https://msrc.microsoft.com/update-guide/vulnerability/ADV190023">configuring LDAP to use LDAP channel binding and signing</a>.</p>
<p>LDAP is one of the main protocols that directory services tools, such as Active Directory, use to query and access directory information. By default, LDAP is vulnerable to credential relaying attacks. For example, in a credential relaying attack, a web server requesting a password to sign in would have its request relayed by an attacker to an authorized client. The attacker then relays the client reply containing the correct password back to the server, thus signing in. Once the attacker is signed in, they have the same permissions as the user whose credentials were relayed.</p>
<p>If LDAP signing is required, each request to the server needs to be cryptographically signed. In this case, the attacker would still be able to relay the sign-in request and reply, but all further requests from the attacker would be disregarded because each request must be signed, and the attacker doesn’t have the proper keys to do the signing.</p>
<h2>Ms-DS-MachineAccountQuota</h2>
<p>The final key concept behind the RBCD method of KrbRelayUp tool is the <a href="https://docs.microsoft.com/windows/win32/adschema/a-ms-ds-machineaccountquota?msclkid=a8456d5cce8b11ec9d1f0e37d0870e17">ms-DS-MachineAccountQuota</a> attribute, which all User Active Directory objects have. This attribute is set to 10 by default, which means that any user in Active Directory can create up to 10 computer accounts associated with them. The legitimate usage of this attribute is to allow users to have multiple devices on a network that belong to them that they can then manage. However, if a compromised user doesn’t have 10 actual devices associated with their account, an attacker can create an account for a non-existing device that will be an object in Active Directory. This fake computer account isn’t associated with a real device but can perform Active Directory authentication requests as if it were.</p>
<p>Initially, the ability to obtain such an account was a prerequisite for this attack method, but since the release of the tool, other security researchers found ways to get around this requirement.</p>
<h2>KrbRelayUp attack flow</h2>
<p>To launch an attack using the RBCD method of KrbRelayUp, an attacker performs four main steps:</p>
<h3>Step 1: Acquisition of a suitable resource</h3>
<p>The attacker first obtains a resource suitable to be the source of an RBCD. There are several ways to obtain such a resource; the most straightforward way is to create a new computer account as discussed above.</p>
<h3>Step 2: Modification of the msDS-AllowedToActOnBehalfOfOtherIdentity attribute</h3>
<p>Next, the attacker adds their resource to the current device’s list of trusted resources. To do this, the attacker starts an LDAP session and relays the credentials of the current device to the LDAP server.</p>
<p>The new KrbRelayUp tool implements this step with these two smaller consecutive actions:</p>
<ol type="1"><li>Authenticates to the LDAP service by triggering and performing a Kerberos relay attack</li><li>Edits the msDS-AllowedToActOnBehalfOfOtherIdentity attribute to add the attacker’s resource to the list of entities permitted to delegate the target device.</li></ol>
<h3>Step 3: Privileged ticket acquisition</h3>
<p>Here, the attacker leverages their control over their resource gained through the first step with the trust for their resource gained through the second step. As such, the local device trusts the attacker’s resource to request a ticket addressed to the host SPN as the domain administrator. The request is made by first pretending to be the attacker’s resource and consists of three requests:</p>
<ol type="1"><li>AS-Req – A request to generate a Ticket Granting Ticket (TGT) for the attacker’s impersonated resource.</li><li>S4U2self – A request to generate a Ticket Granting Service (TGS) ticket from an administrator to the resource.</li><li>S4U2proxy – A request to generate a TGS ticket for the host SPN as an administrator delegating their access via the impersonated resource.</li></ol>
<p>After this step, the attacker has a valid ticket for the local device that allows the administrator to be impersonated.</p>
<h3>Step 4: Privileged ticket leverage</h3>
<p>The last step leverages the attacker’s newly acquired ticket to run code on the device. In the attack, as it’s published online, the Service Control Manager (SCM) is asked to create a new service with SYSTEM permissions.</p>
<h2>Protecting against KrbRelayUp attacks through coordinated threat defense</h2>
<p>It’s important to note that KrbRelayUp cannot be used in attacks against organizations that are only using Azure AD. However, in hybrid identity environments where organizations synchronize their domain controllers with Azure AD, if an attacker compromises an Azure virtual machine using a synchronized account, they’ll receive SYSTEM privileges on the virtual machine.</p>
<p>To reduce the impact of this threat, organizations should apply the mitigations below. <a href="https://www.microsoft.com/security/business/threat-protection/microsoft-365-defender">Microsoft 365 Defender</a> customers can check the recommendations card for the deployment status of monitored mitigations.</p>
<ul><li><a href="https://msrc.microsoft.com/update-guide/vulnerability/ADV190023">Microsoft has provided guidance for enabling LDAP channel binding and LDAP signing</a>. Microsoft recommends that administrators configure LDAP signing and LDAP channel binding as recommended in the said advisory and described in detail in <a href="https://support.microsoft.com/topic/2020-ldap-channel-binding-and-ldap-signing-requirements-for-windows-kb4520412-ef185fb8-00f7-167d-744c-f299a66fc00a">2020 LDAP channel binding and LDAP signing requirements for Windows (KB4520412)</a>.</li><li>Organizations should also consider setting the <a href="https://docs.microsoft.com/windows/win32/adschema/a-ms-ds-machineaccountquota?msclkid=a8456d5cce8b11ec9d1f0e37d0870e17" rel="noreferrer noopener" target="_blank">ms-DS-MachineAccountQuota</a> attribute to 0 to make it more difficult for an attacker to leverage the attribute for attacks. Setting the attribute to 0 stops non-admin users from adding new devices to the domain, blocking the most effective method to carry out the attack’s first step and forcing attackers to choose more complex methods to acquire a suitable resource.</li></ul>
<h3>Detection details</h3>
<p>Organizations should also deploy a comprehensive security solution like Microsoft 365 Defender to detect and block this threat across the stages of the attack chain. Microsoft 365 Defender has multiple layers of dynamic protection technologies, including machine learning-based protection, and correlates threat data from email, endpoints, identities, and cloud apps to provide in-depth and coordinated threat defense. All of these are backed by threat experts who continuously monitor the threat landscape for new attacker tools and techniques.</p>
<p><a href="https://www.microsoft.com/security/business/threat-protection/identity-defender">Microsoft Defender for Identity</a> detects activity from the first three steps of the attack flow by monitoring anomalous behavior as seen by the domain controller. Starting in version 2.180, Defender for Identity has two detections that raise an alert when this attack is attempted:</p>
<ul><li>Suspicious Kerberos delegation attempt by a newly created computer.</li><li>Suspicious edit of the Resource Based Constrained Delegation Attribute by a machine account (KrbRelayUp).</li></ul>
<figure class="wp-block-image size-large"><img alt='This image displays an alert in Microsoft Defender for Identity. The title states "Suspicious Kerberos delegation attempt by a newly created computer" followed by the subtitle "Administrator on evilcomputer5 used a ticket to delegate access to ATTACKER." Below the titles displays an administrator icon on the left and an attacker icon on the right, with an arrow pointing from the admin to the attacker stating "delegated a ticket with access to". The evidence includes "resource based constrained delegation is configured on the resource with the Administrator as allowed to delegate", "evilcomputer5 was created on May 19 2022 at 8:45 PM", and "this alert is associated with the KrbRelayUp exploitation".' class="wp-image-114936" height="617" src="https://www.microsoft.com/security/blog/uploads/securityprod/2022/05/Fig1-Microsoft-Defender-for-Identity-suspicious-Kerberos-delegation-attempt-1024x617.png" style="max-width:800px;height:auto;width:auto;" width="1024"/><figcaption>Figure 1. ‘Suspicious Kerberos delegation attempt by a newly created computer’ alert in Microsoft Defender for Identity</figcaption></figure>
<p><a href="https://www.microsoft.com/security/business/threat-protection/endpoint-defender">Microsoft Defender for Endpoint</a> includes new and enhanced network inspection capabilities to correlate network and endpoint signals and emit high-confidence alerts. Defender for Endpoint leverages these network signals and looks for suspicious LDAP and Kerberos requests to Active Directory domain controllers to accurately detect attacks using KrbRelayUp. Defender for Endpoint also detects suspicious Kerberos sign-ins and service creations.</p>
<figure class="wp-block-image size-large"><img alt="This image displays an alert in Microsoft Defender for Endpoint titled &quot;Possible Kerberos local privilege escalation relay attack.&quot; The alert story displays a detailed timeline of the various detections, including &quot;Defender detected active 'HackTool:MSIL/KrbUpRly.A!dha' in process 'Test.exe'&quot;. Under the detection includes detailed insight into the alert &quot;Possible Kerberos local privilege escalation relay attack&quot;, such as the alert state, MITRE ATT&amp;CK Techniques, detection information, last activity, and more." class="wp-image-114939" height="525" src="https://www.microsoft.com/security/blog/uploads/securityprod/2022/05/Fig2-Microsoft-Defender-for-Endpoint-Kerberos-local-privilege-escalation-attack-alert-1024x525.png" style="max-width:800px;height:auto;width:auto;" width="1024"/><figcaption>Figure 2. ‘Possible Kerberos local privilege escalation relay attack’ alert in Microsoft Defender for Endpoint</figcaption></figure>
<p><a href="https://docs.microsoft.com/microsoft-365/security/defender-endpoint/microsoft-defender-antivirus-windows?view=o365-worldwide">Microsoft Defender Antivirus</a> detects a threat from the KrbRelayUp tool as the following malware:</p>
<ul><li>HackTool:MSIL/KrbUpRly.A</li><li>HackTool:MSIL/KrbUpRly.C</li><li>HackTool:MSIL/KrbUpRly.D</li></ul>
<p>Microsoft 365 Defender customers may refer to the threat analytics report to determine if this threat is present in their network and to get additional details and recommendations. <a href="https://docs.microsoft.com/microsoft-365/security/defender/threat-analytics?view=o365-worldwide">Threat analytics</a> enables organizations to assess the impact of a threat to their network, review exposure and resilience, and perform mitigation, recovery, or prevention actions to stop or contain active attacks.</p>
<p><a href="https://www.microsoft.com/microsoft-365/security/microsoft-365-defender">Learn how you can stop attacks through automated, cross-domain security with Microsoft 365 Defender.</a></p>
<p></p>
<p>Zeev Rabinovich and Ofir Shlomo
Microsoft 365 Defender Research Team</p>
<p></p>
<h3>Resources</h3>
<ul><li>A practical guide on executing this attack – <a href="https://gist.github.com/tothi/bf6c59d6de5d0c9710f23dae5750c4b9">KrbRelay with RBCD Privilege Escalation HOWTO</a>.</li><li><a href="https://github.com/Dec0ne/KrbRelayUp">GitHub Repo</a> of the KrbRelayUp tool that also includes further references.</li><li><a href="https://github.com/cube0x0/KrbRelay">GitHub Repo</a> of the original Kerberos Relay attack tool by <a href="https://twitter.com/cube0x0">cube0x0</a>.</li><li>Learn more about <a href="https://docs.microsoft.com/defender-for-identity/what-is?msclkid=3e481ed8ce8811ecb3a9ee888221c0f1">Microsoft Defender for Identity</a>, and begin a trial <a href="https://www.microsoft.com/security/business/threat-protection/identity-defender">here</a>.</li><li>Learn about Microsoft Defender for Identity’s new feature, <a href="https://techcommunity.microsoft.com/t5/security-compliance-and-identity/microsoft-defender-for-identity-response-actions/ba-p/3271716">Response Actions</a>.</li><li>Learn more about <a href="https://docs.microsoft.com/windows-server/security/kerberos/kerberos-constrained-delegation-overview" rel="noreferrer noopener" target="_blank">Kerberos Constrained Delegation Overview here</a>.</li></ul>
</div>